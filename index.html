// ============================================
// FORM SUBMIT (low friction) - FIXED
// ============================================
document.getElementById('frm').addEventListener('submit', async e => {
  e.preventDefault();
  
  const r = validate($u().value);
  if (!r.ok) {
    setFb('error', r.msg);
    return;
  }
  
  const username = r.value;
  const btn = $btn();
  btn.disabled = true;
  btn.textContent = 'masuk...';
  
  try {
    const deviceSig = getDeviceSignature();
    
    // Cek apakah username sudah ada di profiles
    const existing = await sbFetch(
      `profiles?username=eq.${encodeURIComponent(username)}&select=id,username&limit=1`
    );
    
    let userId;
    
    if (existing.length === 0) {
      // User baru: buat profile (ID akan di-generate otomatis)
      const newProfile = await sbFetch('profiles', 'POST', {
        username: username,
        vibe_preference: 50,
        total_rants: 0,
        is_ai: false,
        metadata: {
          device_signature: deviceSig,
          created_from: 'index.html',
          created_at: new Date().toISOString()
        }
      });
      
      if (newProfile && newProfile.length > 0) {
        userId = newProfile[0].id;
      } else {
        throw new Error('Gagal membuat profile');
      }
      
      setFb('success', 'ðŸŽ‰ Selamat datang!');
      
    } else {
      // User existing
      userId = existing[0].id;
      
      // Update last seen di metadata
      await sbFetch(`profiles?id=eq.${userId}`, 'PATCH', {
        metadata: {
          last_seen: new Date().toISOString(),
          device_signature: deviceSig
        }
      });
      
      setFb('success', 'âœ… Welcome back, @' + username + '!');
    }
    
    // Simpan session
    localStorage.setItem(SK.u, username);
    localStorage.setItem(SK.uid, userId);
    localStorage.setItem(SK.l, 'true');
    
    // Redirect ke jejak.html
    setTimeout(() => window.location.href = 'jejak.html', 700);
    
  } catch (err) {
    console.error('Submit error:', err);
    setFb('error', err.message || 'Gagal masuk');
    btn.disabled = false;
    btn.textContent = "let's goooo";
  }
});
