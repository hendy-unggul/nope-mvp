<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>jejak ‚Äî vibe check ‚ú® [v2]</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700;900&family=Bebas+Neue&family=Courier+Prime:wght@400;700&family=Rubik:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg: #0a0a0a;
      --surface: #121212;
      --text: #ffffff;
      --muted: #999999;
      --accent: #00ff88;
      --accent-2: #ff3366;
      --accent-3: #ffff00;
      --accent-4: #00d4ff;
      --border: #333;
      --font-main: 'DM Sans', sans-serif;
      --font-display: 'Bebas Neue', sans-serif;
      --font-mono: 'Courier Prime', monospace;
      --font-alt: 'Rubik', sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-main);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: -50%; left: -50%;
      width: 200%; height: 200%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(0,255,136,0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255,51,102,0.03) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(0,212,255,0.02) 0%, transparent 50%);
      animation: slowRotate 60s linear infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes slowRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .sticker {
      position: fixed; font-size: 48px; opacity: 0.15;
      pointer-events: none; animation: float 8s ease-in-out infinite; z-index: 0; filter: blur(0.5px);
    }
    .sticker:nth-child(1) { top: 10%; left: 5%; animation-delay: 0s; }
    .sticker:nth-child(2) { top: 20%; right: 10%; animation-delay: 2s; font-size: 64px; }
    .sticker:nth-child(3) { bottom: 15%; left: 15%; animation-delay: 4s; }
    .sticker:nth-child(4) { bottom: 25%; right: 5%; animation-delay: 6s; font-size: 56px; }
    .sticker:nth-child(5) { top: 60%; left: 8%; animation-delay: 1s; }
    .sticker:nth-child(6) { top: 40%; right: 12%; animation-delay: 3s; font-size: 40px; }
    
    @keyframes float {
      0%, 100% { transform: translate(0,0) rotate(0deg); }
      25% { transform: translate(10px,-15px) rotate(5deg); }
      50% { transform: translate(-10px,-25px) rotate(-5deg); }
      75% { transform: translate(15px,-10px) rotate(3deg); }
    }

    .container { max-width: 480px; width: 100%; position: relative; z-index: 1; }
    .logo-zone { text-align: center; margin-bottom: 16px; position: relative; }

    .logo-big {
      font-family: var(--font-display);
      font-size: 88px; font-weight: 400; line-height: 0.9;
      letter-spacing: -0.02em; color: var(--accent); text-transform: lowercase;
      position: relative; display: inline-block;
      filter: drop-shadow(3px 3px 0px var(--accent-2)) drop-shadow(-2px -2px 0px var(--accent-4));
      transform: rotate(-2deg);
      animation: subtleGlitch 5s ease-in-out infinite;
    }

    @keyframes subtleGlitch {
      0%, 100% { transform: rotate(-2deg); }
      20% { transform: rotate(-2deg) translate(1px,0); }
      40% { transform: rotate(-2deg) translate(0,1px); }
      60% { transform: rotate(-2deg) translate(-1px,0); }
      80% { transform: rotate(-2deg) translate(0,-1px); }
    }

    .doodle-circle {
      position: absolute; top: -10px; right: -15px; width: 120px; height: 120px;
      border: 3px solid var(--accent-3); border-radius: 50%;
      transform: rotate(15deg); opacity: 0.3; animation: wobble 3s ease-in-out infinite;
    }
    @keyframes wobble { 0%, 100% { transform: rotate(15deg) scale(1); } 50% { transform: rotate(12deg) scale(1.05); } }

    .tagline {
      text-align: center; font-family: var(--font-mono); font-size: 13px;
      color: var(--muted); margin-bottom: 24px; padding: 8px 16px;
      background: rgba(255,255,255,0.03); border: 1px dashed var(--border);
      border-radius: 20px; display: inline-block; width: 100%;
      transform: rotate(-1deg);
    }

    .vibe-picker { display: flex; gap: 10px; justify-content: center; margin-bottom: 24px; flex-wrap: wrap; }

    .vibe-btn {
      padding: 10px 20px; background: transparent; border: 2px solid var(--border);
      color: var(--text); border-radius: 30px; font-family: var(--font-alt);
      font-size: 13px; font-weight: 700; text-transform: lowercase; cursor: pointer;
      transition: all 0.3s cubic-bezier(0.68,-0.55,0.27,1.55);
    }
    .vibe-btn:hover { transform: translateY(-3px) rotate(-2deg); border-color: var(--accent); color: var(--accent); }
    .vibe-btn.active { background: var(--accent); color: #000; border-color: var(--accent); transform: scale(1.05) rotate(-2deg); }

    .auth-box {
      background: var(--surface); border: 4px solid var(--accent); border-radius: 24px;
      padding: 40px 32px; position: relative;
      box-shadow: 8px 8px 0px rgba(0,255,136,0.2), 12px 12px 0px rgba(255,51,102,0.1);
      transform: rotate(-1deg); transition: all 0.3s ease;
    }
    .auth-box:hover { transform: rotate(0deg); }

    .corner-sticker { position: absolute; font-size: 32px; z-index: 10; animation: spin 8s linear infinite; }
    .corner-sticker.top-left { top: -15px; left: -15px; }
    .corner-sticker.top-right { top: -15px; right: -15px; animation-direction: reverse; }
    .corner-sticker.bottom-left { bottom: -15px; left: -15px; animation-delay: 2s; }
    .corner-sticker.bottom-right { bottom: -15px; right: -15px; animation-direction: reverse; animation-delay: 2s; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .input-label {
      text-align: center; font-family: var(--font-display); font-size: 24px;
      color: var(--text); margin-bottom: 4px; text-transform: lowercase; letter-spacing: 1px;
    }
    .input-label::after { content: '‚≠ê'; margin-left: 8px; font-size: 16px; animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } }

    .format-hint {
      text-align: center; font-family: var(--font-mono); font-size: 11px;
      color: var(--muted); margin-bottom: 16px; letter-spacing: 0.05em;
    }
    .format-hint b { color: var(--accent); }

    .form-group { margin-bottom: 20px; position: relative; }

    .form-group input {
      width: 100%; background: rgba(255,255,255,0.05); border: 3px solid var(--border);
      border-radius: 16px; padding: 20px; color: var(--text);
      font-family: var(--font-mono); /* mono supaya titik kelihatan jelas */
      font-size: 18px; font-weight: 500; text-align: center; text-transform: lowercase;
      transition: all 0.3s cubic-bezier(0.68,-0.55,0.27,1.55); letter-spacing: 0.08em;
    }
    .form-group input:focus {
      outline: none; border-color: var(--accent); background: rgba(0,255,136,0.1);
      transform: translateY(-4px) rotate(1deg);
      box-shadow: 0 0 0 4px rgba(0,255,136,0.2), 6px 6px 0px rgba(0,255,136,0.3);
    }
    .form-group input::placeholder { color: var(--muted); font-weight: 400; letter-spacing: 0.05em; }
    .form-group input.is-valid   { border-color: var(--accent); }
    .form-group input.is-invalid { border-color: var(--accent-2); }
    .form-group input.is-checking{ border-color: var(--accent-3); }

    /* SINGLE FEEDBACK ELEMENT ‚Äî gantikan error-msg + success-msg */
    .field-feedback {
      margin-top: 10px; padding: 10px 16px; border-radius: 12px;
      font-size: 12px; font-family: var(--font-mono); text-align: center;
      border: 2px solid; display: none; line-height: 1.5;
      animation: slideIn 0.4s cubic-bezier(0.68,-0.55,0.27,1.55);
    }
    .field-feedback.show { display: block; }
    .field-feedback.error    { background: rgba(255,51,102,0.1);  border-color: var(--accent-2); color: var(--accent-2); }
    .field-feedback.success  { background: rgba(0,255,136,0.1);   border-color: var(--accent);   color: var(--accent);   }
    .field-feedback.checking { background: rgba(255,255,0,0.08);  border-color: var(--accent-3); color: var(--accent-3); }
    @keyframes slideIn { from { opacity:0; transform: translateY(-10px); } to { opacity:1; transform:translateY(0); } }

    /* SUGGESTION CHIP ‚Äî klik untuk apply */
    .suggestion-chip {
      display: none; margin-top: 8px; padding: 6px 16px;
      background: rgba(0,212,255,0.1); border: 1px solid var(--accent-4);
      border-radius: 20px; font-family: var(--font-mono); font-size: 12px;
      color: var(--accent-4); cursor: pointer; transition: all 0.2s;
      text-align: center;
    }
    .suggestion-chip.show { display: block; }
    .suggestion-chip:hover { background: rgba(0,212,255,0.2); }

    .btn {
      width: 100%; background: var(--accent); color: #000; border: none;
      border-radius: 16px; padding: 20px; font-family: var(--font-display);
      font-size: 28px; text-transform: lowercase; cursor: pointer; margin-top: 16px;
      position: relative; overflow: hidden; transform: rotate(-1deg);
      transition: all 0.3s cubic-bezier(0.68,-0.55,0.27,1.55);
      box-shadow: 4px 4px 0px rgba(0,0,0,0.3), 6px 6px 0px var(--accent-2);
      letter-spacing: 2px;
    }
    .btn::before { content: 'üöÄ'; position: absolute; left: 20px; font-size: 24px; animation: rocket 2s ease-in-out infinite; }
    @keyframes rocket { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-5px) rotate(15deg); } }
    .btn:hover { transform: translateY(-6px) rotate(1deg) scale(1.02); }
    .btn:active { transform: translateY(-2px) rotate(0deg); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

    .notif-box {
      margin-top: 24px; padding: 20px;
      background: linear-gradient(135deg, rgba(255,255,0,0.05), rgba(0,212,255,0.05));
      border: 2px dashed var(--border); border-radius: 16px; font-size: 13px;
      line-height: 1.6; position: relative; opacity: 0;
      transform: translateY(20px) rotate(-2deg); transition: all 0.6s cubic-bezier(0.68,-0.55,0.27,1.55);
    }
    .notif-box.show { opacity: 1; transform: translateY(0) rotate(0deg); }
    .notif-box::before { content: 'üìå'; position: absolute; top: -12px; left: 20px; font-size: 24px; background: var(--surface); padding: 0 8px; }
    .notif-box h4 { color: var(--accent-3); font-family: var(--font-alt); font-weight: 800; margin-bottom: 12px; font-size: 15px; text-transform: lowercase; }
    .notif-box p { margin-bottom: 8px; font-family: var(--font-mono); color: var(--muted); }
    .notif-box .highlight { color: var(--accent); font-weight: 700; text-decoration: underline; text-decoration-style: wavy; text-decoration-color: var(--accent-2); }

    .soul-footer { margin-top: 28px; padding-top: 24px; border-top: 1px solid var(--border); text-align: center; }
    .soul-brand { font-family: var(--font-mono); font-size: 11px; color: var(--muted); margin-bottom: 8px; opacity: 0.6; }

    .loading-overlay {
      position: fixed; inset: 0; background: var(--bg); z-index: 9999;
      display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 16px;
    }
    .loading-overlay.hidden { display: none; }
    .loading-text { font-family: var(--font-mono); font-size: 14px; color: var(--muted); }
    .loading-spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }

    @media (max-width: 480px) {
      .logo-big { font-size: 64px; }
      .btn { font-size: 24px; padding: 18px; }
      .auth-box { padding: 32px 24px; }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">checking session...</div>
  </div>

  <div class="sticker">‚ú®</div>
  <div class="sticker">üåà</div>
  <div class="sticker">‚ö°</div>
  <div class="sticker">üí´</div>
  <div class="sticker">üî•</div>
  <div class="sticker">üíú</div>

  <div class="container">
    <div class="logo-zone">
      <div class="doodle-circle"></div>
      <div class="logo-big">jejak</div>
    </div>

    <div class="tagline">nyambat ¬∑ aksi ¬∑ solusi</div>

    <div class="vibe-picker">
      <button class="vibe-btn active" onclick="setVibe('cyber')">cyber üíª</button>
      <button class="vibe-btn" onclick="setVibe('neon')">neon ‚ú®</button>
      <button class="vibe-btn" onclick="setVibe('retro')">retro üéÆ</button>
      <button class="vibe-btn" onclick="setVibe('pastel')">soft üå∏</button>
    </div>

    <div class="auth-box">
      <span class="corner-sticker top-left">üåü</span>
      <span class="corner-sticker top-right">üí•</span>
      <span class="corner-sticker bottom-left">‚ú®</span>
      <span class="corner-sticker bottom-right">üéØ</span>

      <form id="login-form">
        <div class="input-label">ur username vibes</div>

        <!-- Format hint yang jelas -->
        <div class="format-hint">format: <b>kata.kata</b> &nbsp;¬∑&nbsp; contoh: <b>over.thinker</b></div>

        <div class="form-group">
          <input
            type="text"
            id="username"
            placeholder="over.thinker"
            autocomplete="off"
            autofocus
            maxlength="30"
            spellcheck="false"
          >
          <!-- Single feedback element -->
          <div class="field-feedback" id="field-feedback"></div>
          <!-- Suggestion chip: klik untuk apply -->
          <div class="suggestion-chip" id="suggestion-chip"></div>
        </div>

        <button type="submit" class="btn" id="login-btn" disabled>let's goooo</button>

        <div class="notif-box" id="notif-box">
          <h4>real talk: stay safe bestie üîí</h4>
          <p>no <span class="highlight">real names</span> fr fr</p>
          <p>no face pics, keep it <span class="highlight">mysterious</span> ‚ú®</p>
          <p>obey the law, <span class="highlight">zero hoax</span> energy üö´</p>
          <p>have fun but stay <span class="highlight">accountable</span> üíØ</p>
        </div>

        <div class="soul-footer">
          <div class="soul-brand">soul by itsALrUdio ‚Ä¢ v2.0</div>
        </div>
      </form>
    </div>
  </div>

  <script>
  // ================================================================
  // CONFIG
  // ================================================================
  const SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';

  // FIX: tabel yang benar adalah 'users'
  const TABLE = 'users';

  const SK = {
    username: 'jejak_username',
    sessionId: 'jejak_session_id', // GANTI dari deviceId ke sessionId
    loggedIn: 'jejak_logged_in',
    vibe:     'jejak_vibe',
  };

  // ================================================================
  // USERNAME VALIDATION
  // Format wajib: kata.kata
  //   ‚úì over.thinker  ‚úì tired.soul  ‚úì aku.anonim  ‚úì self.care99
  //   ‚úó "aku anonim"  ‚úó akunonim    ‚úó .aku        ‚úó aku.        ‚úó 1.abc
  // ================================================================
  const UN_PATTERN = /^[a-z][a-z0-9]*\.[a-z][a-z0-9]*$/;

  function validateUsername(raw) {
    if (!raw || !raw.trim()) {
      return { ok: false, msg: 'username tidak boleh kosong', suggestion: null };
    }
    const val = raw.trim().toLowerCase();

    if (val.length > 30) {
      return { ok: false, msg: 'maksimal 30 karakter', suggestion: null };
    }

    // Jika user ketik pakai spasi ‚Üí sarankan konversi ke titik
    if (val.includes(' ')) {
      const sug = val.trim().replace(/\s+/g, '.').replace(/[^a-z0-9.]/g, '');
      return { ok: false, msg: 'gunakan titik bukan spasi ‚Äî format: kata.kata', suggestion: sug };
    }

    if (!val.includes('.')) {
      return { ok: false, msg: 'harus dua kata dipisah titik ¬∑ contoh: over.thinker', suggestion: null };
    }
    if ((val.match(/\./g) || []).length > 1) {
      return { ok: false, msg: 'hanya boleh satu titik pemisah', suggestion: null };
    }
    if (!UN_PATTERN.test(val)) {
      if (/^\d/.test(val) || /\.\d/.test(val)) {
        return { ok: false, msg: 'tidak boleh diawali angka', suggestion: null };
      }
      return { ok: false, msg: 'hanya huruf kecil a-z, angka, dan satu titik', suggestion: null };
    }
    const [p1, p2] = val.split('.');
    if (p1.length < 2 || p2.length < 2) {
      return { ok: false, msg: 'masing-masing kata minimal 2 huruf', suggestion: null };
    }

    return { ok: true, msg: null, suggestion: null, value: val };
  }

  // ================================================================
  // SUPABASE REST
  // ================================================================
  async function sbFetch(table, method = 'GET', body = null, qs = '') {
    const url = `${SUPABASE_URL}/rest/v1/${table}${qs}`;
    console.log('Fetching:', url);
    
    const res = await fetch(url, {
      method,
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': method === 'POST' ? 'return=representation' : ''
      },
      body: body ? JSON.stringify(body) : undefined
    });
    
    const text = await res.text();
    if (!res.ok) throw new Error(text || `HTTP ${res.status}`);
    return text ? JSON.parse(text) : [];
  }

  // ================================================================
  // SESSION ID (GANTI DEVICE_ID)
  // ================================================================
  function getSessionId() {
    let id = localStorage.getItem(SK.sessionId);
    if (!id) {
      // Generate session ID random
      id = 's_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9);
      localStorage.setItem(SK.sessionId, id);
    }
    return id;
  }

  // ================================================================
  // SESSION
  // ================================================================
  function setSession(username) {
    localStorage.setItem(SK.username, username);
    localStorage.setItem(SK.loggedIn, 'true');
  }
  function clearSession() {
    localStorage.removeItem(SK.username);
    localStorage.removeItem(SK.loggedIn);
  }
  function getSession() {
    return {
      username: localStorage.getItem(SK.username),
      loggedIn: localStorage.getItem(SK.loggedIn) === 'true'
    };
  }

  // ================================================================
  // UI HELPERS
  // ================================================================
  const $input    = () => document.getElementById('username');
  const $feedback = () => document.getElementById('field-feedback');
  const $suggest  = () => document.getElementById('suggestion-chip');
  const $btn      = () => document.getElementById('login-btn');

  function setFeedback(type, msg) {
    // type: 'error' | 'success' | 'checking' | ''
    const el = $feedback();
    if (!type || !msg) { el.className = 'field-feedback'; el.textContent = ''; return; }
    el.className = 'field-feedback show ' + type;
    el.textContent = msg;
    // Border warna input
    $input().className = type === 'success' ? 'is-valid' : type === 'checking' ? 'is-checking' : 'is-invalid';
  }

  function setSuggestion(text) {
    const el = $suggest();
    if (!text) { el.className = 'suggestion-chip'; return; }
    el.className = 'suggestion-chip show';
    el.textContent = 'üëâ maksud kamu: ' + text + '? (klik untuk apply)';
    el.onclick = () => {
      $input().value = text;
      el.className = 'suggestion-chip';
      $input().dispatchEvent(new Event('input'));
    };
  }

  // ================================================================
  // AVAILABILITY CHECK (debounced 600ms)
  // Query ke tabel 'users' dengan kolom 'username'
  // ================================================================
  let _debounce = null;
  let _lastChecked = null;

  async function checkAvailability(username) {
    if (username === _lastChecked) return;
    _lastChecked = username;
    $btn().disabled = true;
    setFeedback('checking', '‚è≥ mengecek ketersediaan...');

    try {
      // FIX: tabel 'users', bukan 'jejak_users'
      const data = await sbFetch(TABLE, 'GET', null,
        `?username=eq.${encodeURIComponent(username)}&select=username&limit=1`
      );

      if (data.length === 0) {
        setFeedback('success', '‚úì ' + username + ' tersedia ‚Äî siap daftar!');
      } else {
        setFeedback('success', '‚úì ' + username + ' ditemukan ‚Äî welcome back!');
      }
      $btn().disabled = false;

    } catch (e) {
      console.error('Check error:', e.message);
      // Jika cek gagal, tetap izinkan submit
      setFeedback('checking', '‚ö†Ô∏è koneksi lambat, coba submit langsung');
      $btn().disabled = false;
    }
  }

  // ================================================================
  // INPUT LISTENER ‚Äî format paksa + validasi realtime
  // ================================================================
  $input().addEventListener('input', (e) => {
    let val = e.target.value;

    // FORMAT PAKSA saat mengetik:
    // 1. Lowercase
    // 2. Spasi ‚Üí titik (auto-convert)
    // 3. Hapus karakter selain a-z, 0-9, titik
    // 4. Titik ganda ‚Üí satu titik
    const formatted = val
      .toLowerCase()
      .replace(/\s+/g, '.')
      .replace(/[^a-z0-9.]/g, '')
      .replace(/\.{2,}/g, '.');

    if (formatted !== val) {
      const pos = e.target.selectionStart;
      e.target.value = formatted;
      try { e.target.setSelectionRange(pos, pos); } catch(_) {}
    }

    val = formatted;

    // Kosong ‚Üí reset
    if (!val) {
      setFeedback('', '');
      setSuggestion(null);
      $btn().disabled = true;
      $input().className = '';
      _lastChecked = null;
      return;
    }

    // Tampilkan notif box
    document.getElementById('notif-box').classList.add('show');

    // Validasi format
    const result = validateUsername(val);
    if (!result.ok) {
      setFeedback('error', result.msg);
      setSuggestion(result.suggestion);
      $btn().disabled = true;
      clearTimeout(_debounce);
      _lastChecked = null;
      return;
    }

    // Format valid ‚Äî cek ketersediaan (debounced)
    setSuggestion(null);
    clearTimeout(_debounce);
    _debounce = setTimeout(() => checkAvailability(result.value), 600);
  });

  // Cegah paste karakter invalid
  $input().addEventListener('paste', (e) => {
    e.preventDefault();
    const pasted = (e.clipboardData || window.clipboardData).getData('text');
    const clean = pasted.trim().toLowerCase()
      .replace(/[\s_\-]+/g, '.')
      .replace(/[^a-z0-9.]/g, '')
      .replace(/\.{2,}/g, '.')
      .slice(0, 30);
    e.target.value = clean;
    e.target.dispatchEvent(new Event('input'));
  });

  // ================================================================
  // VIBE
  // ================================================================
  const VIBES = {
    cyber:  { accent:'#00ff88', accent2:'#ff3366', accent3:'#ffff00', accent4:'#00d4ff' },
    neon:   { accent:'#ff10f0', accent2:'#00ff88', accent3:'#ffff00', accent4:'#00d4ff' },
    retro:  { accent:'#ff6b35', accent2:'#f7b801', accent3:'#6a994e', accent4:'#bc4749' },
    pastel: { accent:'#ffc8dd', accent2:'#bde0fe', accent3:'#a2d2ff', accent4:'#ffafcc' }
  };
  window.setVibe = function(v) {
    const c = VIBES[v]; if (!c) return;
    document.documentElement.style.setProperty('--accent',   c.accent);
    document.documentElement.style.setProperty('--accent-2', c.accent2);
    document.documentElement.style.setProperty('--accent-3', c.accent3);
    document.documentElement.style.setProperty('--accent-4', c.accent4);
    document.querySelectorAll('.vibe-btn').forEach(b =>
      b.classList.toggle('active', b.textContent.includes(v))
    );
    localStorage.setItem(SK.vibe, v);
  };

  // ================================================================
  // FORM SUBMIT
  // ================================================================
  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const raw    = $input().value;
    const result = validateUsername(raw);
    if (!result.ok) { setFeedback('error', result.msg); return; }

    const username = result.value;
    const btn = $btn();
    btn.disabled = true;
    btn.textContent = 'checking vibes...';

    try {
      const sessionId = getSessionId(); // GANTI dari deviceId ke sessionId

      // FIX: tabel 'users', cek berdasarkan username
      const existing = await sbFetch(TABLE, 'GET', null,
        `?username=eq.${encodeURIComponent(username)}&select=username,session_id&limit=1`
      );

      if (existing.length === 0) {
        // ‚îÄ‚îÄ REGISTER BARU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        await sbFetch(TABLE, 'POST', { 
          username, 
          session_id: sessionId,  // GANTI dari device_id ke session_id
          created_at: new Date().toISOString(),
          last_seen: new Date().toISOString()
        });
        setFeedback('success', 'üéâ account created! welcome bestie');

      } else {
        // ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const user = existing[0];

        // Cek apakah session_id cocok
        if (user.session_id && user.session_id !== sessionId) {
          setFeedback('error', '‚ö†Ô∏è username ini terdaftar di device lain');
          btn.disabled = false;
          btn.textContent = "let's goooo";
          return;
        }

        // Update last_seen
        await sbFetch(TABLE, 'PATCH',
          { last_seen: new Date().toISOString() },
          `?username=eq.${encodeURIComponent(username)}`
        );

        setFeedback('success', '‚úÖ welcome back, @' + username + '!');
      }

      setSession(username);
      setTimeout(() => { window.location.href = 'jejak.html'; }, 700);

    } catch (err) {
      console.error('Submit error:', err);
      if (err.message.includes('duplicate key')) {
        setFeedback('error', 'username sudah dipakai di device lain');
      } else {
        setFeedback('error', 'error: ' + err.message);
      }
    } finally {
      btn.disabled = false;
      btn.textContent = "let's goooo";
    }
  });

  // ================================================================
  // AUTO-LOGIN CHECK
  // ================================================================
  async function checkAutoLogin() {
    const session = getSession();

    if (!session.loggedIn || !session.username) {
      document.getElementById('loading-overlay').classList.add('hidden');
      const saved = localStorage.getItem(SK.username);
      if (saved) {
        $input().value = saved;
        $input().dispatchEvent(new Event('input'));
      }
      return;
    }

    try {
      const sessionId = getSessionId();
      // FIX: tabel 'users'
      const data = await sbFetch(TABLE, 'GET', null,
        `?username=eq.${encodeURIComponent(session.username)}&select=username,session_id&limit=1`
      );

      if (data.length > 0 && data[0].session_id === sessionId) {
        window.location.href = 'jejak.html';
        return;
      }

      clearSession();
    } catch (e) {
      console.error('Auto-login error:', e.message);
    }

    document.getElementById('loading-overlay').classList.add('hidden');
    const saved = localStorage.getItem(SK.username);
    if (saved) {
      $input().value = saved;
      $input().dispatchEvent(new Event('input'));
    }
  }

  // ================================================================
  // INIT
  // ================================================================
  window.addEventListener('DOMContentLoaded', () => {
    setVibe(localStorage.getItem(SK.vibe) || 'cyber');
    checkAutoLogin();
  });
  </script>
</body>
</html>
