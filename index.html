<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>jejak — masuk yuk</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a0a;color:#fff;font-family:sans-serif;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
.container{max-width:400px;width:100%}
.box{background:#121212;border:2px solid #00ff88;border-radius:16px;padding:40px 24px}
h1{text-align:center;margin-bottom:24px;color:#00ff88;font-size:48px;letter-spacing:-2px}
input{width:100%;padding:16px;background:#1e1e1e;border:2px solid #333;border-radius:8px;color:#fff;font-size:16px;margin-bottom:16px}
input:focus{outline:none;border-color:#00ff88}
button{width:100%;padding:16px;background:#00ff88;border:none;border-radius:8px;color:#000;font-size:18px;font-weight:bold;cursor:pointer}
button:hover{background:#00cc66}
.feedback{margin-top:16px;padding:12px;border-radius:8px;display:none;text-align:center}
.feedback.show{display:block}
.feedback.error{background:#330000;border:1px solid #ff3366;color:#ff3366}
.feedback.success{background:#003300;border:1px solid #00ff88;color:#00ff88}
.hint{text-align:center;margin-top:16px;color:#888;font-size:14px}
</style>
</head>
<body>
<div class="container">
  <div class="box">
    <h1>jejak</h1>
    <input type="text" id="username" placeholder="kata.kata (contoh: over.thinker)" autocomplete="off">
    <button id="loginBtn">MASUK</button>
    <div class="feedback" id="feedback"></div>
    <div class="hint">cukup 2 kata pakai titik · tanpa email & password</div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';

const usernameInput = document.getElementById('username');
const loginBtn = document.getElementById('loginBtn');
const feedback = document.getElementById('feedback');

function showFeedback(type, msg) {
  feedback.className = 'feedback show ' + type;
  feedback.textContent = msg;
}

function validateUsername(username) {
  if (!username) return { ok: false, msg: 'username tidak boleh kosong' };
  
  const v = username.trim().toLowerCase();
  
  if (v.length < 5) return { ok: false, msg: 'minimal 5 karakter' };
  if (v.length > 30) return { ok: false, msg: 'maksimal 30 karakter' };
  if (!v.includes('.')) return { ok: false, msg: 'harus pakai titik. contoh: over.thinker' };
  if (v.split('.').length !== 2) return { ok: false, msg: 'hanya satu titik. contoh: kata.kata' };
  
  const [p1, p2] = v.split('.');
  if (p1.length < 2 || p2.length < 2) return { ok: false, msg: 'masing-masing minimal 2 huruf' };
  
  // Hanya huruf kecil, angka, dan titik
  if (!/^[a-z0-9]+\.[a-z0-9]+$/.test(v)) {
    return { ok: false, msg: 'hanya huruf kecil dan angka' };
  }
  
  return { ok: true, value: v };
}

loginBtn.addEventListener('click', async () => {
  const raw = usernameInput.value.trim();
  const valid = validateUsername(raw);
  
  if (!valid.ok) {
    showFeedback('error', valid.msg);
    return;
  }
  
  const username = valid.value;
  loginBtn.disabled = true;
  loginBtn.textContent = 'Proses...';
  showFeedback('success', '⏳ Mengecek username...');
  
  try {
    // CEK APAKAH USER SUDAH ADA
    const checkRes = await fetch(
      `${SUPABASE_URL}/rest/v1/profiles?username=eq.${encodeURIComponent(username)}&select=id`,
      {
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      }
    );
    
    if (!checkRes.ok) {
      throw new Error('Gagal koneksi ke database');
    }
    
    const existing = await checkRes.json();
    let userId;
    
    if (existing.length === 0) {
      // USER BARU - REGISTER
      showFeedback('success', '⏳ Mendaftarkan user baru...');
      
      const insertRes = await fetch(`${SUPABASE_URL}/rest/v1/profiles`, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        },
        body: JSON.stringify({
          username: username,
          vibe_preference: 50,
          total_rants: 0,
          is_ai: false,
          metadata: {
            registered_at: new Date().toISOString(),
            device: navigator.userAgent
          }
        })
      });
      
      if (!insertRes.ok) {
        const err = await insertRes.text();
        throw new Error('Gagal register: ' + err);
      }
      
      const newUser = await insertRes.json();
      userId = newUser[0]?.id;
      
    } else {
      // USER LAMA - LOGIN
      userId = existing[0].id;
      
      // Update metadata (opsional)
      await fetch(`${SUPABASE_URL}/rest/v1/profiles?id=eq.${userId}`, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          metadata: {
            last_seen: new Date().toISOString(),
            device: navigator.userAgent
          }
        })
      });
    }
    
    if (!userId) {
      throw new Error('Gagal mendapatkan user ID');
    }
    
    // SIMPAN KE LOCALSTORAGE
    localStorage.setItem('jejak_username', username);
    localStorage.setItem('jejak_user_id', userId);
    localStorage.setItem('jejak_logged_in', 'true');
    
    showFeedback('success', '✅ Berhasil! Mengalihkan...');
    
    // REDIRECT
    setTimeout(() => {
      window.location.href = 'jejak.html';
    }, 1000);
    
  } catch (err) {
    console.error('Login error:', err);
    showFeedback('error', 'Error: ' + err.message);
    loginBtn.disabled = false;
    loginBtn.textContent = 'MASUK';
  }
});

// Enter key
usernameInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') loginBtn.click();
});
</script>
</body>
</html>
