<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>JEJAK ‚Äî masuk dulu bestie</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#080808;--sf:#0f0f0f;--sfe:#141414;--bd:#222;--bd2:#2e2e2e;
  --tx:#f0ece6;--txs:#777;--txm:#444;
  --ap:#ff2d55;--as:#00e5ff;--aq:#bfff00;--gold:#ffd60a;--purple:#bf5af2;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{height:100%}
body{
  background:var(--bg);color:var(--tx);
  font-family:'Syne',-apple-system,sans-serif;
  min-height:100%;display:flex;align-items:center;justify-content:center;
  padding:24px 20px 40px;overflow-x:hidden;position:relative;
}

/* GRAIN TEXTURE */
body::after{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;opacity:.028;
  background:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E") 0 0/200px 200px
}

/* SCANLINES BG */
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,229,255,.012) 2px,rgba(0,229,255,.012) 4px);
}

/* LOADING */
.loading{
  position:fixed;inset:0;background:var(--bg);z-index:9998;
  display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;
}
.loading.hidden{display:none}
.l-spin{
  width:28px;height:28px;
  border:2px solid var(--bd2);border-top-color:var(--as);
  animation:rot 1s linear infinite;
}
@keyframes rot{to{transform:rotate(360deg)}}
.l-txt{font-family:'DM Mono',monospace;font-size:11px;color:var(--txm);letter-spacing:3px;text-transform:uppercase}

/* WRAPPER */
.container{
  max-width:440px;width:100%;
  position:relative;z-index:1;
  display:flex;flex-direction:column;gap:0;
}

/* ACCENT BAR ‚Äî top */
.accent-bar{
  height:3px;
  background:linear-gradient(90deg,var(--ap),var(--as),var(--aq));
  margin-bottom:0;
}

/* HEADER / LOGO ZONE */
.logo-zone{
  background:var(--sf);
  border:2px solid var(--bd2);
  border-top:none;
  padding:32px 28px 24px;
  position:relative;
  box-shadow:6px 6px 0 #000;
}

/* Corner accents */
.logo-zone::before{
  content:'';position:absolute;top:-1px;left:-1px;
  width:20px;height:20px;
  border-top:3px solid var(--as);border-left:3px solid var(--as);
}
.logo-zone::after{
  content:'';position:absolute;bottom:-1px;right:-1px;
  width:20px;height:20px;
  border-bottom:3px solid var(--ap);border-right:3px solid var(--ap);
}
.logo-corner-tr{position:absolute;top:-1px;right:-1px;width:20px;height:20px;border-top:3px solid var(--aq);border-right:3px solid var(--aq)}
.logo-corner-bl{position:absolute;bottom:-1px;left:-1px;width:20px;height:20px;border-bottom:3px solid var(--gold);border-left:3px solid var(--gold)}

.logo-eyebrow{
  font-family:'DM Mono',monospace;font-size:9px;color:var(--txm);
  letter-spacing:4px;text-transform:uppercase;margin-bottom:12px;
  display:flex;align-items:center;gap:8px;
}
.logo-eyebrow::before{content:'';display:inline-block;width:20px;height:2px;background:var(--as)}

.logo-big{
  font-family:'Bebas Neue',sans-serif;
  font-size:72px;line-height:.92;letter-spacing:3px;
  color:var(--tx);display:block;margin-bottom:4px;
}
.logo-big .x{color:var(--ap);display:inline-block;animation:spin-x 4s ease-in-out infinite}
@keyframes spin-x{0%,90%,100%{transform:rotate(0) scale(1)}95%{transform:rotate(180deg) scale(1.2)}}

.logo-tagline{
  font-family:'DM Mono',monospace;font-size:11px;color:var(--txs);
  letter-spacing:2px;text-transform:uppercase;margin-top:10px;
  display:flex;align-items:center;gap:10px;
}
.logo-tagline::after{content:'';flex:1;height:1px;background:var(--bd2)}

.online-pill{
  position:absolute;top:20px;right:24px;
  font-family:'DM Mono',monospace;font-size:9px;color:#000;
  background:var(--aq);padding:4px 10px;border:2px solid #000;
  box-shadow:2px 2px 0 #000;letter-spacing:.5px;text-transform:uppercase;
}

/* DEBUG BANNER */
.debug-banner{
  display:none;padding:10px 16px;
  background:rgba(255,45,85,.08);border:2px solid var(--ap);border-top:none;
  font-family:'DM Mono',monospace;font-size:10px;color:var(--ap);
  text-align:center;line-height:1.6;letter-spacing:.5px;
}
.debug-banner.show{display:block}

/* VIBE PICKER */
.vibe-sect{
  margin-top:12px;
  background:var(--sf);border:2px solid var(--bd2);
  padding:14px 18px;box-shadow:4px 4px 0 #000;
  display:flex;flex-direction:column;gap:10px;
}
.vibe-label{font-family:'DM Mono',monospace;font-size:9px;color:var(--txm);letter-spacing:3px;text-transform:uppercase}
.vibe-row{display:flex;gap:8px;flex-wrap:wrap}
.vibe-btn{
  padding:7px 16px;background:var(--bg);border:2px solid var(--bd2);
  font-family:'DM Mono',monospace;font-size:10px;font-weight:500;
  color:var(--txs);text-transform:uppercase;letter-spacing:.5px;
  white-space:nowrap;cursor:pointer;
  box-shadow:3px 3px 0 #000;transition:all .08s;
}
.vibe-btn:active{transform:translate(2px,2px);box-shadow:1px 1px 0 #000}
.vibe-btn.active{background:var(--ap);border-color:#000;color:#fff;box-shadow:3px 3px 0 rgba(0,0,0,.5)}

/* AUTH BOX */
.auth-box{
  margin-top:12px;
  background:var(--sf);border:2px solid var(--bd2);
  padding:28px 24px;box-shadow:6px 6px 0 #000;position:relative;
}
.auth-box::before{
  content:'';position:absolute;top:-1px;left:-1px;
  width:16px;height:16px;border-top:3px solid var(--as);border-left:3px solid var(--as);
}
.auth-box::after{
  content:'';position:absolute;bottom:-1px;right:-1px;
  width:16px;height:16px;border-bottom:3px solid var(--ap);border-right:3px solid var(--ap);
}
.ab-corner-tr{position:absolute;top:-1px;right:-1px;width:16px;height:16px;border-top:3px solid var(--aq);border-right:3px solid var(--aq)}
.ab-corner-bl{position:absolute;bottom:-1px;left:-1px;width:16px;height:16px;border-bottom:3px solid var(--gold);border-left:3px solid var(--gold)}

/* INPUT SECTION */
.input-hdr{margin-bottom:6px}
.input-title{
  font-family:'Bebas Neue',sans-serif;font-size:24px;
  letter-spacing:2px;color:var(--tx);display:flex;align-items:center;gap:10px;
}
.input-title::after{
  content:'LIVE';font-family:'DM Mono',monospace;font-size:9px;
  background:var(--ap);color:#fff;padding:3px 8px;letter-spacing:1px;
}
.input-hint{
  font-family:'DM Mono',monospace;font-size:10px;color:var(--txs);
  margin-bottom:16px;margin-top:6px;letter-spacing:.5px;
}
.input-hint b{color:var(--as)}

.form-group{margin-bottom:16px;position:relative}
.form-group input{
  width:100%;background:var(--bg);border:2px solid var(--bd2);
  padding:16px 18px;color:var(--tx);
  font-family:'DM Mono',monospace;font-size:16px;font-weight:500;
  text-align:left;text-transform:lowercase;
  outline:none;letter-spacing:.08em;
  transition:border-color .15s,box-shadow .15s;
  box-shadow:3px 3px 0 #000;
}
.form-group input:focus{border-color:var(--ap);box-shadow:3px 3px 0 #000,0 0 0 1px var(--ap)}
.form-group input::placeholder{color:var(--txm);font-weight:400}
.form-group input.is-valid{border-color:var(--aq)}
.form-group input.is-invalid{border-color:var(--ap)}
.form-group input.is-checking{border-color:var(--as)}

.feedback{
  margin-top:8px;padding:10px 14px;
  font-family:'DM Mono',monospace;font-size:11px;letter-spacing:.5px;
  border:2px solid;display:none;line-height:1.5;
}
.feedback.show{display:block}
.feedback.error{background:rgba(255,45,85,.08);border-color:var(--ap);color:var(--ap)}
.feedback.success{background:rgba(191,255,0,.06);border-color:var(--aq);color:var(--aq)}
.feedback.checking{background:rgba(0,229,255,.06);border-color:var(--as);color:var(--as)}

.suggest{
  display:none;margin-top:8px;padding:10px 14px;
  background:rgba(0,229,255,.06);border:2px solid var(--as);
  font-family:'DM Mono',monospace;font-size:11px;color:var(--as);
  cursor:pointer;transition:all .1s;letter-spacing:.5px;
}
.suggest.show{display:block}
.suggest:active{background:rgba(0,229,255,.12)}

/* SUBMIT BUTTON */
.btn{
  width:100%;background:var(--ap);color:#fff;
  border:2px solid #000;padding:18px 24px;
  font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:3px;
  cursor:pointer;margin-top:4px;
  box-shadow:5px 5px 0 #000;
  transition:transform .08s,box-shadow .08s;
  display:flex;align-items:center;justify-content:center;gap:12px;
  position:relative;
}
.btn::before{content:'‚¨°';font-size:18px;opacity:.8}
.btn:hover{transform:translate(-1px,-1px);box-shadow:6px 6px 0 #000}
.btn:active{transform:translate(3px,3px);box-shadow:2px 2px 0 #000}
.btn:disabled{opacity:.3;cursor:not-allowed;transform:none;box-shadow:5px 5px 0 #000}

/* SAFETY NOTIF */
.notif{
  margin-top:12px;background:var(--sfe);
  border:2px solid var(--bd2);border-left:4px solid var(--as);
  padding:16px 18px;
}
.notif-hdr{
  display:flex;align-items:center;gap:8px;margin-bottom:12px;
}
.notif-hdr-icon{
  width:8px;height:8px;background:var(--as);
  transform:rotate(45deg);flex-shrink:0;
}
.notif-hdr-title{
  font-family:'DM Mono',monospace;font-size:10px;
  color:var(--as);letter-spacing:2px;text-transform:uppercase;
}
.notif-list{display:flex;flex-direction:column;gap:8px}
.notif-item{
  display:flex;align-items:flex-start;gap:10px;
  font-family:'DM Mono',monospace;font-size:11px;
  color:var(--txs);line-height:1.6;
}
.notif-item .tag{
  flex-shrink:0;padding:2px 8px;
  font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;
  text-transform:uppercase;border:2px solid;font-weight:500;
}
.notif-item .tag.red{color:var(--ap);border-color:var(--ap)}
.notif-item .tag.cyan{color:var(--as);border-color:var(--as)}
.notif-item .tag.lime{color:var(--aq);border-color:var(--aq)}
.notif-item .tag.gold{color:var(--gold);border-color:var(--gold)}

/* FOOTER */
.footer{
  margin-top:12px;padding:12px 16px;
  border:2px solid var(--bd);
  display:flex;justify-content:space-between;align-items:center;
}
.footer-left{font-family:'DM Mono',monospace;font-size:9px;color:var(--txm);letter-spacing:2px;text-transform:uppercase}
.footer-right{font-family:'DM Mono',monospace;font-size:9px;color:var(--txm);letter-spacing:1px}
.footer-dot{display:inline-block;width:6px;height:6px;background:var(--aq);transform:rotate(45deg);margin-right:6px;animation:blink-sq 2s step-end infinite}
@keyframes blink-sq{0%,100%{opacity:1}50%{opacity:.2}}

@media(max-width:440px){
  .logo-big{font-size:56px}
  .auth-box{padding:20px 18px}
}
</style>
</head>
<body>
<div class="loading" id="loading">
  <div class="l-spin"></div>
  <div class="l-txt">checking session...</div>
</div>

<div class="container">
  <div class="accent-bar"></div>

  <div class="logo-zone">
    <span class="logo-corner-tr"></span>
    <span class="logo-corner-bl"></span>
    <span class="online-pill" id="onlinePill">21 ONLINE</span>
    <div class="logo-eyebrow">vibe radar platform</div>
    <span class="logo-big">JE<span class="x">‚úï</span>AK</span>
    <div class="logo-tagline">nyambat ¬∑ aksi ¬∑ solusi</div>
  </div>

  <!-- DEBUG BANNER: tampil hanya jika session rusak -->
  <div class="debug-banner" id="debug-banner"></div>

  <!-- VIBE PICKER -->
  <div class="vibe-sect">
    <span class="vibe-label">pilih vibe kamu</span>
    <div class="vibe-row">
      <button class="vibe-btn active" data-vibe="cyber">CYBER üíª</button>
      <button class="vibe-btn" data-vibe="neon">NEON ‚ú®</button>
      <button class="vibe-btn" data-vibe="retro">RETRO üéÆ</button>
      <button class="vibe-btn" data-vibe="pastel">SOFT üå∏</button>
    </div>
  </div>

  <!-- AUTH BOX -->
  <div class="auth-box">
    <span class="ab-corner-tr"></span>
    <span class="ab-corner-bl"></span>

    <form id="frm">
      <div class="input-hdr">
        <div class="input-title">USERNAME VIBES</div>
        <div class="input-hint">format: <b>kata.kata</b> &nbsp;‚Äî&nbsp; contoh: <b>over.thinker</b></div>
      </div>

      <div class="form-group">
        <input type="text" id="uname" placeholder="over.thinker"
          autocomplete="off" autofocus maxlength="30" spellcheck="false">
        <div class="feedback" id="fb"></div>
        <div class="suggest" id="sg"></div>
      </div>

      <button type="submit" class="btn" id="btn" disabled>GASKEUN ‚Üí</button>
    </form>

    <!-- SAFETY NOTIF -->
    <div class="notif">
      <div class="notif-hdr">
        <div class="notif-hdr-icon"></div>
        <span class="notif-hdr-title">real talk ‚Äî stay safe bestie üîí</span>
      </div>
      <div class="notif-list">
        <div class="notif-item"><span class="tag red">NO</span><span>real names, foto wajah, data pribadi ‚Äî keep it <b style="color:var(--tx)">mysterious</b> ‚ú®</span></div>
        <div class="notif-item"><span class="tag cyan">ZERO</span><span>hoax, hate speech, content ilegal ‚Äî obey the law fr fr üö´</span></div>
        <div class="notif-item"><span class="tag lime">STAY</span><span>accountable for everything you post ‚Äî no cap, no excuses üíØ</span></div>
        <div class="notif-item"><span class="tag gold">FUN</span><span>have fun but keep it real ‚Äî vibe check passed = bestie energy ü§ù</span></div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    <div class="footer-left"><span class="footer-dot"></span>soul by itsALrUdio</div>
    <div class="footer-right">v2.1 ¬∑ 2025</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ============================================
// SUPABASE CONFIG ‚Äî sama persis dengan jejak.html
// ============================================
var SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';
var db = null;

// ============================================
// LOCALSTORAGE KEYS ‚Äî sinkron dengan jejak.html
// ============================================
var SK = {
  u:   'jejak_username',
  s:   'jejak_session_id',
  l:   'jejak_logged_in',
  v:   'jejak_vibe',
  uid: 'user_id'
};

// ============================================
// VIBE THEMES
// ============================================
var VIBES = {
  cyber:  { ac: '#ff2d55', as: '#00e5ff', aq: '#bfff00', gold: '#ffd60a' },
  neon:   { ac: '#bf5af2', as: '#ff2d55', aq: '#ffd60a', gold: '#00e5ff' },
  retro:  { ac: '#ffd60a', as: '#ff9f0a', aq: '#bfff00', gold: '#ff2d55' },
  pastel: { ac: '#ff2d55', as: '#bf5af2', aq: '#00e5ff', gold: '#bfff00' }
};

// ============================================
// VALIDATION
// ============================================
var UN_PAT = /^[a-z][a-z0-9]*\.[a-z][a-z0-9]*$/;

function $el(id){ return document.getElementById(id) }
function $u(){  return $el('uname') }
function $fb(){ return $el('fb') }
function $sg(){ return $el('sg') }
function $btn(){ return $el('btn') }

function setFb(type, msg){
  var el = $fb(), inp = $u();
  if(!type || !msg){
    el.className = 'feedback'; el.textContent = ''; inp.className = ''; return;
  }
  el.className = 'feedback show ' + type;
  el.textContent = msg;
  inp.className = type === 'success' ? 'is-valid' : type === 'checking' ? 'is-checking' : 'is-invalid';
}

function setSg(text){
  var el = $sg();
  if(!text){ el.className = 'suggest'; return; }
  el.className = 'suggest show';
  el.textContent = '‚Üí maksud kamu: ' + text + '? klik untuk apply';
  el.onclick = function(){
    $u().value = text;
    el.className = 'suggest';
    $u().dispatchEvent(new Event('input'));
  };
}

function validate(raw){
  if(!raw || !raw.trim()) return { ok: false, msg: 'username tidak boleh kosong' };
  var v = raw.trim().toLowerCase();
  if(v.length > 30) return { ok: false, msg: 'maksimal 30 karakter' };
  if(v.includes(' ')){
    var s = v.trim().replace(/\s+/g, '.').replace(/[^a-z0-9.]/g, '');
    return { ok: false, msg: 'gunakan titik bukan spasi ‚Äî format: kata.kata', suggest: s };
  }
  if(!v.includes('.')) return { ok: false, msg: 'harus dua kata dipisah titik ¬∑ contoh: over.thinker' };
  if((v.match(/\./g) || []).length > 1) return { ok: false, msg: 'hanya boleh satu titik pemisah' };
  if(!UN_PAT.test(v)) return { ok: false, msg: 'hanya huruf kecil a-z, angka, dan satu titik' };
  var parts = v.split('.');
  if(parts[0].length < 2 || parts[1].length < 2) return { ok: false, msg: 'masing-masing kata minimal 2 huruf' };
  return { ok: true, value: v };
}

// ============================================
// DEVICE SIGNATURE
// ============================================
function getDeviceSignature(){
  var sig = localStorage.getItem(SK.s);
  if(!sig){
    var rawString = navigator.userAgent + (window.screen.width||'?') + 'x' + (window.screen.height||'?') + Date.now() + Math.random().toString(36).substring(2, 15);
    sig = btoa(unescape(encodeURIComponent(rawString))).substring(0, 32).replace(/[^a-zA-Z0-9]/g, '');
    localStorage.setItem(SK.s, sig);
  }
  return sig;
}

// ============================================
// CLEAR SESSION
// ============================================
function clearSession(reason){
  console.warn('[JEJAK] Clearing session:', reason);
  localStorage.removeItem(SK.u);
  localStorage.removeItem(SK.uid);
  localStorage.removeItem(SK.l);
  if(reason){
    var banner = $el('debug-banner');
    if(banner){ banner.textContent = '‚ö†Ô∏è Session direset: ' + reason + ' ‚Äî silakan login ulang'; banner.classList.add('show'); }
  }
}

// ============================================
// SAVE SESSION
// ============================================
function saveSession(username, userId){
  if(!userId || typeof userId !== 'string' || userId.length < 10) throw new Error('userId tidak valid: ' + userId);
  localStorage.setItem(SK.u, username);
  localStorage.setItem(SK.uid, userId);
  localStorage.setItem(SK.l, 'true');
  console.log('%c[JEJAK] Session saved:', 'color:#bfff00;font-weight:bold', { username, user_id: userId, key_used: SK.uid });
}

// ============================================
// SUPABASE INIT
// ============================================
function initDb(){
  if(window.supabase && window.supabase.createClient){
    db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    console.log('%c[JEJAK] Supabase initialized', 'color:#00e5ff');
    return true;
  }
  console.error('[JEJAK] Supabase SDK not loaded!');
  return false;
}

// ============================================
// CHECK USERNAME AVAILABILITY
// ============================================
var _deb = null, _last = null;

async function checkAvail(username){
  if(username === _last) return;
  _last = username;
  $btn().disabled = true;
  setFb('checking', '‚è≥ mengecek ketersediaan...');
  try{
    var result = await db.from('profiles').select('id, username').eq('username', username).limit(1);
    if(result.error) throw result.error;
    if(!result.data || result.data.length === 0) setFb('success', '‚úì ' + username + ' tersedia ‚Äî siap daftar!');
    else setFb('success', '‚úì ' + username + ' ditemukan ‚Äî welcome back!');
    $btn().disabled = false;
  } catch(e){
    console.warn('[JEJAK] Check avail error:', e);
    setFb('checking', '‚ö†Ô∏è koneksi lambat ‚Äî coba submit langsung');
    $btn().disabled = false;
  }
}

// ============================================
// INPUT HANDLER
// ============================================
$u().addEventListener('input', function(e){
  var v = e.target.value;
  var fmt = v.toLowerCase().replace(/\s+/g, '.').replace(/[^a-z0-9.]/g, '').replace(/\.{2,}/g, '.');
  if(fmt !== v){
    var p = e.target.selectionStart;
    e.target.value = fmt;
    try{ e.target.setSelectionRange(p, p); } catch(_){}
    v = fmt;
  }
  if(!v){ setFb('', ''); setSg(null); $btn().disabled = true; $u().className = ''; _last = null; return; }
  var r = validate(v);
  if(!r.ok){ setFb('error', r.msg); setSg(r.suggest || null); $btn().disabled = true; clearTimeout(_deb); _last = null; return; }
  setSg(null);
  clearTimeout(_deb);
  _deb = setTimeout(function(){ checkAvail(r.value); }, 600);
});

$u().addEventListener('paste', function(e){
  e.preventDefault();
  var p = (e.clipboardData || window.clipboardData).getData('text');
  e.target.value = p.trim().toLowerCase().replace(/[\s_\-]+/g, '.').replace(/[^a-z0-9.]/g, '').replace(/\.{2,}/g, '.').slice(0, 30);
  e.target.dispatchEvent(new Event('input'));
});

// ============================================
// VIBE
// ============================================
function setVibe(v){
  var c = VIBES[v]; if(!c) return;
  var r = document.documentElement.style;
  r.setProperty('--ap', c.ac);
  r.setProperty('--as', c.as);
  r.setProperty('--aq', c.aq);
  r.setProperty('--gold', c.gold);
  document.querySelectorAll('.vibe-btn').forEach(function(b){
    b.classList.toggle('active', b.getAttribute('data-vibe') === v);
  });
  localStorage.setItem(SK.v, v);
}

document.querySelectorAll('.vibe-btn').forEach(function(btn){
  btn.addEventListener('click', function(){ setVibe(this.getAttribute('data-vibe')); });
});

// ============================================
// FORM SUBMIT ‚Äî LOGIKA AUTH UTAMA
// ============================================
$el('frm').addEventListener('submit', async function(e){
  e.preventDefault();
  var r = validate($u().value);
  if(!r.ok){ setFb('error', r.msg); return; }

  var username = r.value;
  var btn = $btn();
  btn.disabled = true;
  btn.textContent = 'MASUK...';

  try{
    if(!db) throw new Error('Database tidak terhubung');

    // STEP 1: Cek apakah username sudah ada
    var existingResult = await db.from('profiles').select('id, username').eq('username', username).limit(1);
    if(existingResult.error) throw existingResult.error;

    var userId = null;
    var isNewUser = !existingResult.data || existingResult.data.length === 0;

    if(isNewUser){
      // STEP 2A: Buat profile baru
      var insertResult = await db.from('profiles').insert({ username }).select('id, username');
      if(insertResult.error){
        if(insertResult.error.code === '23505'){
          // Race condition ‚Äî fetch ulang
          var retryResult = await db.from('profiles').select('id, username').eq('username', username).limit(1);
          if(!retryResult.error && retryResult.data && retryResult.data.length > 0) userId = retryResult.data[0].id;
          else throw insertResult.error;
        } else {
          throw insertResult.error;
        }
      } else {
        if(!insertResult.data || insertResult.data.length === 0 || !insertResult.data[0].id)
          throw new Error('Profile dibuat tapi id tidak ada di response ‚Äî cek RLS policy tabel profiles');
        userId = insertResult.data[0].id;
        setFb('success', 'üéâ Akun dibuat! Welcome, @' + username + '!');
      }
    } else {
      // STEP 2B: Login user yang sudah ada
      userId = existingResult.data[0].id;
      try{
        await db.from('profiles').update({ updated_at: new Date().toISOString() }).eq('id', userId);
      } catch(updateErr){
        console.warn('[JEJAK] Update profile gagal (non-fatal):', updateErr);
      }
      setFb('success', '‚úì Welcome back, @' + username + '!');
    }

    // STEP 3: Simpan session
    saveSession(username, userId);

    // STEP 4: Redirect
    setTimeout(function(){ window.location.href = 'spill.html'; }, 700);

  } catch(err){
    console.error('[JEJAK] Submit error:', err);
    setFb('error', '‚ùå ' + (err.message || JSON.stringify(err)));
    btn.disabled = false;
    btn.innerHTML = '‚¨° GASKEUN ‚Üí';
  }
});

// ============================================
// AUTO LOGIN CHECK
// ============================================
async function checkAutoLogin(){
  var username = localStorage.getItem(SK.u);
  var userId = localStorage.getItem(SK.uid);
  var loggedIn = localStorage.getItem(SK.l) === 'true';

  if(!loggedIn || !username || !userId){
    if(loggedIn || username || userId) clearSession('session tidak lengkap');
    $el('loading').classList.add('hidden'); return;
  }
  if(userId.length < 10){
    clearSession('user_id tidak valid (' + userId + ')');
    $el('loading').classList.add('hidden'); return;
  }

  try{
    if(!db){ $el('loading').classList.add('hidden'); return; }
    var result = await db.from('profiles').select('id, username').eq('id', userId).limit(1);
    if(result.error) throw result.error;
    if(result.data && result.data.length > 0){
      console.log('%c[JEJAK] Auto-login OK:', 'color:#bfff00', username);
      window.location.href = 'spill.html'; return;
    }
    clearSession('user tidak ditemukan di database');
  } catch(e){
    console.warn('[JEJAK] AutoLogin error (non-fatal):', e);
  }
  $el('loading').classList.add('hidden');
}

// ============================================
// ONLINE COUNT (cosmetic)
// ============================================
function updateOnline(){
  var el = $el('onlinePill');
  if(el) el.textContent = (Math.floor(Math.random()*25)+18) + ' ONLINE';
}

// ============================================
// INIT
// ============================================
document.addEventListener('DOMContentLoaded', function(){
  if(!initDb()) setFb('error', '‚ùå Gagal koneksi ke database. Refresh halaman.');
  setVibe(localStorage.getItem(SK.v) || 'cyber');
  checkAutoLogin();
  updateOnline();
  setInterval(updateOnline, 30000);
});
</script>
</body>
</html>
