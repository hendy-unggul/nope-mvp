<!DOCTYPE html>
<html>
<head>
    <title>JEJAK - Upload Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="font-family: system-ui; padding: 20px; max-width: 500px; margin: 0 auto; background: #0A0A0A; color: white;">

<h1 style="color: #FF4D00;">JEJAK - UPLOAD TEST</h1>

<div style="margin: 20px 0; padding: 20px; background: #141414; border: 2px solid #2A2A2A;">
    <h3>Status:</h3>
    <div id="status" style="color: #888; margin: 10px 0;">Menunggu...</div>
    <div id="quota" style="color: #39FF14; font-size: 14px;"></div>
</div>

<div style="margin: 20px 0;">
    <button id="btnUpload" style="background: #FF4D00; color: black; border: none; padding: 15px 30px; font-weight: bold; cursor: pointer;">PILIH FOTO</button>
    <span id="selectedCount" style="margin-left: 10px; color: #888;">0 dipilih</span>
</div>

<div id="preview" style="display: grid; grid-template-columns: repeat(3,1fr); gap: 5px; margin: 20px 0;"></div>

<button id="btnConfirm" disabled style="background: #555; color: white; border: none; padding: 15px 30px; font-weight: bold; cursor: not-allowed; width: 100%;">KONFIRMASI UPLOAD</button>

<div id="result" style="margin: 20px 0; padding: 10px; background: #1E1E1E; border: 2px solid #2A2A2A; min-height: 50px;"></div>

<input type="file" id="fileInput" accept="image/*" multiple style="display: none;">

<script>
// ============================================
// SUPABASE (HANYA SATU KALI DEKLARASI)
// ============================================
const SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';

// BUAT CLIENT
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ============================================
// STATE
// ============================================
const BUCKET = 'artefacts';
const USER_ID = 'user-test-' + Date.now(); // ID unik setiap session
const USERNAME = 'test.user';

let uploads = parseInt(localStorage.getItem('test_uploads') || '0');
let quotaStart = localStorage.getItem('test_quota_start') || Date.now();
let selectedFiles = [];

// ============================================
// DOM ELEMENTS
// ============================================
const statusEl = document.getElementById('status');
const quotaEl = document.getElementById('quota');
const btnUpload = document.getElementById('btnUpload');
const btnConfirm = document.getElementById('btnConfirm');
const fileInput = document.getElementById('fileInput');
const previewEl = document.getElementById('preview');
const selectedCountEl = document.getElementById('selectedCount');
const resultEl = document.getElementById('result');

// ============================================
// FUNCTIONS
// ============================================
function updateQuota() {
    const now = Date.now();
    const windowDays = 3 * 86400000; // 3 hari
    
    if (now - parseInt(quotaStart) > windowDays) {
        uploads = 0;
        quotaStart = now;
        localStorage.setItem('test_uploads', '0');
        localStorage.setItem('test_quota_start', now.toString());
    }
    
    const rem = Math.max(0, windowDays - (now - parseInt(quotaStart)));
    const days = Math.ceil(rem / 86400000);
    const slots = 6 - uploads;
    
    quotaEl.innerHTML = `üìä QUOTA: ${slots} slot tersisa (dari 6 foto per 3 hari)<br>‚è∞ Reset dalam ${days} hari`;
    quotaEl.style.color = slots <= 2 ? '#FF006E' : '#39FF14';
}

function log(msg, isError = false) {
    console.log(msg);
    resultEl.innerHTML += `<div style="color: ${isError ? '#FF3333' : '#888'}; padding: 5px; border-bottom: 1px solid #2A2A2A;">${msg}</div>`;
    resultEl.scrollTop = resultEl.scrollHeight;
}

function clearLog() {
    resultEl.innerHTML = '';
}

// ============================================
// UPLOAD FLOW
// ============================================
btnUpload.onclick = () => {
    if (uploads >= 6) {
        log('‚ùå QUOTA HABIS! Tunggu reset quota', true);
        return;
    }
    fileInput.click();
};

fileInput.onchange = (e) => {
    const files = Array.from(e.target.files);
    if (!files.length) return;
    
    // Batasi 6 foto
    selectedFiles = files.slice(0, 6);
    
    // Update counter
    selectedCountEl.textContent = `${selectedFiles.length} dipilih`;
    
    // Tampilkan preview
    previewEl.innerHTML = '';
    selectedFiles.forEach((file, i) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const div = document.createElement('div');
            div.style.aspectRatio = '1/1';
            div.style.background = '#1E1E1E';
            div.style.border = '2px solid #2A2A2A';
            div.style.overflow = 'hidden';
            div.innerHTML = `<img src="${e.target.result}" style="width:100%; height:100%; object-fit:cover;">`;
            previewEl.appendChild(div);
        };
        reader.readAsDataURL(file);
    });
    
    // Enable confirm button
    btnConfirm.disabled = false;
    btnConfirm.style.background = '#FF4D00';
    btnConfirm.style.cursor = 'pointer';
    
    log(`üì∏ ${selectedFiles.length} file siap diupload`);
};

btnConfirm.onclick = async () => {
    if (!selectedFiles.length) return;
    
    // Disable button
    btnConfirm.disabled = true;
    btnConfirm.textContent = 'UPLOADING...';
    clearLog();
    log('üöÄ MULAI UPLOAD...');
    
    let success = 0;
    let failed = 0;
    
    for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        const fileName = `${USERNAME}/${Date.now()}_${i}.${file.name.split('.').pop() || 'jpg'}`;
        
        log(`üì§ Uploading file ${i+1}/${selectedFiles.length}: ${file.name}`);
        
        try {
            // STEP 1: UPLOAD KE STORAGE
            log(`   ‚Üí Storage: ${BUCKET}/${fileName}`);
            const { error: uploadError } = await supabase.storage
                .from(BUCKET)
                .upload(fileName, file);
            
            if (uploadError) {
                throw new Error(`Storage error: ${uploadError.message}`);
            }
            log(`   ‚úÖ Storage OK`);
            
            // STEP 2: GET PUBLIC URL
            const { data: { publicUrl } } = supabase.storage
                .from(BUCKET)
                .getPublicUrl(fileName);
            log(`   ‚Üí URL: ${publicUrl.substring(0, 50)}...`);
            
            // STEP 3: INSERT KE TABEL artefacts
            log(`   ‚Üí Insert ke database...`);
            const { error: insertError } = await supabase
                .from('artefacts')
                .insert({
                    user_id: USER_ID,
                    username: USERNAME,
                    url: publicUrl,
                    note: 'test upload',
                    has_face: false,
                    faces: []
                });
            
            if (insertError) {
                throw new Error(`Database error: ${insertError.message}`);
            }
            
            log(`   ‚úÖ Database OK`);
            success++;
            
        } catch (err) {
            log(`   ‚ùå GAGAL: ${err.message}`, true);
            failed++;
            console.error(err);
        }
    }
    
    // Update quota
    if (success > 0) {
        uploads += success;
        localStorage.setItem('test_uploads', uploads.toString());
    }
    
    // Update UI
    updateQuota();
    
    log('=================================');
    log(`‚úÖ SUKSES: ${success} foto`);
    log(`‚ùå GAGAL: ${failed} foto`);
    log('=================================');
    
    // Reset form
    if (success === selectedFiles.length) {
        selectedFiles = [];
        previewEl.innerHTML = '';
        selectedCountEl.textContent = '0 dipilih';
    }
    
    btnConfirm.textContent = 'KONFIRMASI UPLOAD';
    btnConfirm.disabled = success === 0;
    btnConfirm.style.background = success === 0 ? '#555' : '#FF4D00';
    btnConfirm.style.cursor = success === 0 ? 'not-allowed' : 'pointer';
    
    // Cek hasil di database
    if (success > 0) {
        setTimeout(async () => {
            log('\nüîç CEK DATA DI DATABASE:');
            const { data, error } = await supabase
                .from('artefacts')
                .select('*')
                .eq('user_id', USER_ID)
                .order('created_at', { ascending: false })
                .limit(5);
            
            if (error) {
                log(`‚ùå Gagal cek database: ${error.message}`, true);
            } else {
                log(`üìä Total data user: ${data.length} foto`);
                data.forEach((d, i) => {
                    log(`   ${i+1}. ${d.note} - ${new Date(d.created_at).toLocaleTimeString()}`);
                });
            }
        }, 1000);
    }
};

// Initial update
updateQuota();
log('‚úÖ READY - Pilih foto untuk mulai upload');
log(`üë§ User ID: ${USER_ID}`);

// Test koneksi
(async () => {
    try {
        const { error } = await supabase.from('artefacts').select('count', { count: 'exact', head: true });
        if (error) {
            log(`‚ùå Koneksi database error: ${error.message}`, true);
        } else {
            log(`‚úÖ Koneksi database OK`);
        }
    } catch (e) {
        log(`‚ùå Koneksi error: ${e.message}`, true);
    }
})();
</script>
</body>
</html>
