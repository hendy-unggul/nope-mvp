<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>JEJAK â€” Spill Your Truth</title>
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.13/dist/face-api.js" crossorigin="anonymous"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Caveat:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ===== CSS SAMA PERSIS DENGAN SEBELUMNYA ===== */
:root{--bg:#0A0A0A;--sf:#141414;--sfe:#1E1E1E;--bd:#2A2A2A;--tx:#FFF;--txs:#888;--txm:#555;--ap:#FF4D00;--as:#00F0FF;--at:#FF006E;--aq:#39FF14;--aw:#FFD700;--ms:#FF9500;--mt:#39FF14;--mc:#00F0FF;--md:#8B5CF6}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--tx);font-family:'Plus Jakarta Sans',system-ui,sans-serif;font-weight:500;font-size:15px;line-height:1.4;min-height:100vh;overflow-x:hidden;padding-bottom:100px}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:.4}
.w{max-width:480px;margin:0 auto;padding:0 16px}
header{padding:24px 0 16px;display:flex;justify-content:space-between;align-items:flex-start}
.logo{font-size:42px;font-weight:800;letter-spacing:-.04em;cursor:pointer;line-height:.9;position:relative}
.logo::before,.logo::after{content:'JEJAK';position:absolute;top:0;left:0;opacity:0;transition:opacity .1s}
.logo::before{color:var(--as);transform:translate(-2px,0)}
.logo::after{color:var(--at);transform:translate(2px,0)}
.logo:hover::before{opacity:.8;animation:g .3s infinite}
@keyframes g{0%,100%{transform:translate(-2px,0)}25%{transform:translate(2px,2px)}50%{transform:translate(-2px,-2px)}75%{transform:translate(2px,0)}}
.tagline{font-family:'Instrument Serif',serif;font-size:13px;color:var(--txs);font-style:italic;margin-top:4px}
.top-right{display:flex;align-items:center;gap:8px}
.huser{font-size:11px;font-weight:700;color:var(--tx);text-transform:lowercase;letter-spacing:.05em;padding:4px 8px;background:var(--sf);border:1px solid var(--bd);max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dot{width:8px;height:8px;background:var(--aq);border-radius:50%;animation:blink 2s infinite;flex-shrink:0}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.dot.off{background:var(--at);animation:none}
.smenu{position:relative}
.mtrig{width:32px;height:32px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;background:transparent;border:none;cursor:pointer;padding:0}
.mtrig span{width:4px;height:4px;background:var(--tx);border-radius:50%;transition:all .2s}
.mtrig:hover span{background:var(--ap)}
.mdd{position:absolute;top:100%;right:0;margin-top:8px;background:var(--sf);border:2px solid var(--bd);min-width:120px;display:none;z-index:100}
.mdd.on{display:block}
.mi{width:100%;padding:8px 16px;background:transparent;border:none;color:var(--tx);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;text-align:left;cursor:pointer;transition:all .2s}
.mi:hover{background:var(--sfe);color:var(--ap)}
.bnav{position:fixed;bottom:0;left:0;right:0;background:var(--sf);border-top:2px solid var(--bd);z-index:1000;padding-bottom:env(safe-area-inset-bottom)}
.bnav-c{max-width:480px;margin:0 auto;display:flex;justify-content:space-around;align-items:center;height:64px}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;height:100%;color:var(--txm);text-decoration:none;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;transition:all .2s;position:relative;cursor:pointer}
.ni::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:0;height:2px;background:var(--ap);transition:width .2s}
.ni:hover{color:var(--txs);background:var(--sfe)}
.ni.act{color:var(--ap)}
.ni.act::before{width:100%}
.nico{font-size:20px;line-height:1}
.hero-s{position:relative;margin:0 -16px 24px}
.hero{position:relative;width:100%;aspect-ratio:1/1;overflow:hidden;border-top:2px solid var(--bd);border-bottom:2px solid var(--bd);background:var(--sf)}
.hero img{width:100%;height:100%;object-fit:cover;transition:transform .6s,filter .3s}
.hero:hover img{transform:scale(1.03)}
.hero::after{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.03) 2px,rgba(0,0,0,.03) 4px);pointer-events:none}
.hnote{position:absolute;bottom:0;left:0;right:0;padding:16px;background:linear-gradient(to top,rgba(0,0,0,.9),transparent);font-family:'Instrument Serif',serif;font-size:24px;font-style:italic;color:var(--tx);line-height:1.2;z-index:20}
.fscrib{position:absolute;background:rgba(0,0,0,.95);pointer-events:none;z-index:15;overflow:hidden}
.fscrib::before{content:'';position:absolute;inset:0;background-image:repeating-linear-gradient(90deg,transparent,transparent 2px,rgba(255,255,255,.1) 2px,rgba(255,255,255,.1) 4px),repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(255,255,255,.05) 2px,rgba(255,255,255,.05) 4px)}
.mlines{position:absolute;inset:0;background-image:repeating-linear-gradient(-45deg,transparent,transparent 3px,rgba(0,0,0,.8) 3px,rgba(0,0,0,.8) 6px)}
.upctrls{position:absolute;top:16px;right:16px;display:flex;flex-direction:column;gap:8px;align-items:flex-end;z-index:20}
.upbtn{width:48px;height:48px;background:var(--ap);border:none;color:var(--bg);font-size:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;box-shadow:4px 4px 0 var(--bg),4px 4px 0 2px var(--ap);position:relative}
.upbtn:hover:not(:disabled){transform:translate(2px,2px);box-shadow:2px 2px 0 var(--bg),2px 2px 0 2px var(--ap)}
.upbtn:disabled{background:var(--txm);box-shadow:none;cursor:not-allowed;opacity:.6}
.upcnt{position:absolute;top:-8px;right:-8px;background:var(--at);color:var(--tx);font-size:10px;font-weight:700;padding:2px 6px;min-width:20px;text-align:center}
.qtimer{position:absolute;top:calc(100% + 8px);right:0;background:var(--sf);border:2px solid var(--bd);padding:8px 16px;font-size:11px;color:var(--txs);white-space:nowrap;opacity:0;visibility:hidden;transition:all .2s;z-index:30}
.qtimer::before{content:'';position:absolute;bottom:100%;right:16px;border:6px solid transparent;border-bottom-color:var(--bd)}
.upctrls:hover .qtimer{opacity:1;visibility:visible}
.qtimer.urg{border-color:var(--at);color:var(--at);animation:pb 2s infinite}
@keyframes pb{0%,100%{border-color:var(--at)}50%{border-color:var(--txm)}}
.isec{margin-bottom:32px}
.ihdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.ilbl{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--txs)}
.ccount{font-size:12px;color:var(--txm);font-variant-numeric:tabular-nums}
.ri{width:100%;background:var(--sf);border:2px solid var(--bd);padding:16px;color:var(--tx);font-family:'Plus Jakarta Sans',sans-serif;font-size:16px;line-height:1.5;resize:none;min-height:120px;transition:all .2s}
.ri:focus{outline:none;border-color:var(--ap);background:var(--sfe)}
.ri::placeholder{color:var(--txm)}
.msec{margin:16px 0}
.mlbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--txs);margin-bottom:8px}
.mgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.mc{position:relative;padding:16px;background:var(--sf);border:2px solid var(--bd);cursor:pointer;transition:all .2s;display:flex;flex-direction:column;gap:4px}
.mc:hover{border-color:var(--txs);transform:translateY(-2px)}
.mc.act{border-color:currentColor;background:var(--sfe)}
.mc.act::before{content:'âœ“';position:absolute;top:8px;right:8px;font-size:12px;font-weight:700}
.me{font-size:28px;line-height:1}
.mn{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:.05em}
.md-desc{font-size:11px;color:var(--txs)}
.mc[data-mood="surviving"]{color:var(--ms)}
.mc[data-mood="thriving"]{color:var(--mt)}
.mc[data-mood="chaotic"]{color:var(--mc)}
.mc[data-mood="doom"]{color:var(--md)}
.iact{display:flex;justify-content:flex-end;margin-top:16px}
.sbtn{padding:14px 32px;font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;background:var(--ap);border:none;color:var(--bg);cursor:pointer;transition:all .2s;box-shadow:4px 4px 0 var(--sfe),4px 4px 0 2px var(--ap)}
.sbtn:hover:not(:disabled){transform:translate(2px,2px);box-shadow:2px 2px 0 var(--sfe),2px 2px 0 2px var(--ap)}
.sbtn:disabled{opacity:.5;cursor:not-allowed;box-shadow:none}
.shdr{display:flex;align-items:center;gap:8px;margin-bottom:16px;padding-bottom:8px;border-bottom:2px solid var(--bd)}
.stit{font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:.15em;color:var(--tx)}
.sline{flex:1;height:2px;background:var(--bd)}
.entry{background:var(--sf);border:2px solid var(--bd);margin-bottom:16px;position:relative;animation:si .4s ease}
@keyframes si{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.entry:hover{border-color:var(--ap)}
.entry.own-rant{border-left:3px solid var(--txm)}
.ehdr{display:flex;justify-content:space-between;align-items:center;padding:8px 16px;border-bottom:1px solid var(--bd);background:var(--sfe)}
.emeta{display:flex;align-items:center;gap:8px}
.etime{font-size:11px;color:var(--txm);font-weight:600;letter-spacing:.05em}
.emood{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;padding:4px 8px;border:1px solid currentColor}
.emood.surviving{color:var(--ms)}
.emood.thriving{color:var(--mt)}
.emood.chaotic{color:var(--mc)}
.emood.doom{color:var(--md)}
.econt{padding:16px;font-size:15px;line-height:1.6;color:var(--tx)}
.tgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:2px;background:var(--bd);border:2px solid var(--bd)}
.ti{aspect-ratio:1;background:var(--sf);position:relative;overflow:hidden;cursor:pointer}
.ti.empty{display:flex;align-items:center;justify-content:center;color:var(--txm);font-size:20px;border:2px dashed var(--bd)}
.ti img{width:100%;height:100%;object-fit:cover;transition:all .3s}
.ti:hover img{transform:scale(1.1)}
.ti::after{content:'';position:absolute;inset:0;background:var(--ap);opacity:0;transition:opacity .2s;mix-blend-mode:multiply}
.ti:hover::after{opacity:.3}
.ti-dum{opacity:.5}
.ti-dum:hover{opacity:.7}
.dbadge{position:absolute;top:4px;left:4px;background:var(--at);color:var(--tx);font-size:9px;font-weight:700;padding:2px 6px;text-transform:uppercase;z-index:20}
.fifo-i{font-size:9px;color:var(--txm);text-transform:uppercase;letter-spacing:.05em;padding:2px 6px;border:1px solid var(--bd)}
.own-badge{font-size:9px;font-weight:700;color:var(--txm);letter-spacing:.08em;padding:2px 6px;border:1px solid var(--bd);text-transform:uppercase}
.es{padding:32px 16px;text-align:center;border:2px dashed var(--bd)}
.ee{font-size:48px;margin-bottom:16px;display:block;animation:fl 3s ease-in-out infinite}
@keyframes fl{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.et{font-family:'Instrument Serif',serif;font-size:20px;font-style:italic;color:var(--txs);margin-bottom:8px}
.est{font-size:13px;color:var(--txm)}
footer{padding:32px 0;text-align:center;border-top:2px solid var(--bd);margin-bottom:80px}
.ftxt{font-size:11px;color:var(--txm);text-transform:uppercase;letter-spacing:.2em}
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--tx);color:var(--bg);padding:8px 16px;font-size:13px;font-weight:600;z-index:10000;opacity:0;transition:all .3s}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.proc{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:10002;display:none;flex-direction:column;align-items:center;justify-content:center;gap:16px}
.proc.on{display:flex}
.pspin{width:48px;height:48px;border:3px solid var(--bd);border-top-color:var(--ap);border-radius:50%;animation:sp 1s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.ptxt{font-size:14px;color:var(--txs);text-align:center}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:10001;padding:16px;overflow-y:auto}
.modal.on{display:block}
.mc2{max-width:480px;margin:0 auto;background:var(--sf);border:2px solid var(--bd);padding:24px}
.mhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:16px;border-bottom:2px solid var(--bd)}
.mtit{font-size:18px;font-weight:800;text-transform:uppercase;letter-spacing:.05em}
.mcls{background:none;border:none;color:var(--tx);font-size:24px;cursor:pointer}
.ggrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.gi{aspect-ratio:1;background:var(--sfe);border:2px solid var(--bd);cursor:pointer;overflow:hidden;position:relative}
.gi img{width:100%;height:100%;object-fit:cover;transition:all .2s}
.gi:hover img{transform:scale(1.05)}
.gi.sel{border-color:var(--ap);box-shadow:0 0 0 2px var(--ap)}
.gi.sel::after{content:'âœ“';position:absolute;top:4px;right:4px;background:var(--ap);color:var(--bg);width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700}
.tmsec{margin:16px 0;padding:16px;background:var(--sfe);border:2px solid var(--bd)}
.tmhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.tmlbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--txs)}
.tmnm{font-size:11px;font-weight:700;color:var(--ap)}
.tmsl{width:100%;height:4px;background:var(--bd);outline:none;-webkit-appearance:none;margin:8px 0}
.tmsl::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;background:var(--ap);cursor:pointer;border:2px solid var(--tx);box-shadow:2px 2px 0 var(--bg)}
.tmlabs{display:flex;justify-content:space-between;font-size:9px;color:var(--txm);font-weight:600;text-transform:uppercase}
.notsec{margin:16px 0;padding:16px;background:var(--sfe);border:2px solid var(--bd)}
.notlbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--txs);margin-bottom:8px;display:flex;justify-content:space-between}
.notcnt{font-size:10px;color:var(--txm)}
.noti{width:100%;background:var(--sf);border:2px solid var(--bd);padding:8px;color:var(--tx);font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;transition:all .2s}
.noti:focus{outline:none;border-color:var(--ap);background:var(--sfe)}
.noti::placeholder{color:var(--txm);font-size:12px}
.gwarn{background:var(--at);color:var(--tx);padding:16px;margin-bottom:16px;font-size:13px;font-weight:700;text-align:center;text-transform:uppercase;letter-spacing:.05em;border:2px solid var(--at);animation:pw 2s infinite}
@keyframes pw{0%,100%{opacity:1}50%{opacity:.8}}
.gwarn::before{content:'ğŸš« '}
.macts{margin-top:16px;display:flex;justify-content:flex-end;gap:8px}
.mbtn{padding:12px 24px;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;border:2px solid var(--bd);background:var(--sf);color:var(--tx);cursor:pointer;transition:all .2s}
.mbtn.pri{background:var(--ap);border-color:var(--ap);color:var(--bg)}
.mbtn:hover{transform:translateY(-2px)}
.fm{filter:grayscale(100%) contrast(1.1)!important}.fsp{filter:sepia(100%) contrast(1.1) saturate(.8)!important}.fl{filter:contrast(1.2) saturate(1.3) brightness(.9)!important}.fv{filter:grayscale(100%) contrast(1.2) brightness(.9)!important}.fn{filter:grayscale(100%) contrast(1.4) brightness(.8)!important}.fc{filter:hue-rotate(180deg) saturate(1.5) contrast(1.1)!important}.fw{filter:sepia(60%) hue-rotate(-30deg) saturate(1.2)!important}.fco{filter:hue-rotate(180deg) saturate(.5) brightness(1.1)!important}.fd{filter:blur(.5px) saturate(1.4) brightness(1.1) contrast(.9)!important}.fcr{filter:contrast(1.3) saturate(1.1)!important}.fmo{filter:brightness(.8) contrast(1.2) saturate(.7)!important}.fg{filter:sepia(40%) hue-rotate(-15deg) saturate(1.3) contrast(1.1)!important}
.entry-dummy{opacity:.6;border-style:dashed!important}
.entry-dummy:hover{border-color:var(--bd)!important;opacity:.75}
.reaction-bar{display:flex;gap:6px;padding:10px 16px;border-top:1px solid var(--bd);background:var(--sfe);align-items:center;flex-wrap:wrap}
.reaction-btn{position:relative;display:flex;align-items:center;gap:4px;padding:5px 10px;background:var(--sf);border:2px solid var(--bd);cursor:pointer;transition:all .15s;border-radius:4px;font-family:inherit}
.reaction-btn:hover:not([disabled]){border-color:var(--txs);transform:translateY(-2px);background:var(--sfe)}
.reaction-btn.act{border-color:var(--ap);background:var(--ap)}
.reaction-btn.act .rcount{color:#000}
.reaction-btn[disabled]{cursor:not-allowed;opacity:.38;pointer-events:none}
.remoji{font-size:17px;line-height:1}
.rcount{font-size:11px;font-weight:700;color:var(--txs);min-width:14px;text-align:center;font-variant-numeric:tabular-nums}
.reaction-btn.act .rcount{color:#000}
.reaction-btn[data-tooltip]:not([disabled]):hover::after{content:attr(data-tooltip);position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:var(--tx);color:var(--bg);padding:5px 10px;font-size:11px;font-weight:600;white-space:nowrap;border-radius:4px;z-index:100;pointer-events:none}
.reaction-btn[data-tooltip]:not([disabled]):hover::before{content:'';position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);border:4px solid transparent;border-top-color:var(--tx);z-index:100;pointer-events:none}
.own-lock{font-size:10px;font-weight:600;color:var(--txm);font-style:italic;margin-left:auto;padding:0 2px}
.conn-mini{margin-top:24px}
.conn-card-compact{background:var(--sf);border:2px solid var(--bd);margin-bottom:8px;position:relative;transition:all .2s;display:flex;align-items:center;padding:12px 16px;gap:12px}
.conn-card-compact:hover{border-color:var(--ap)}
.conn-card-compact.chaotic{border-left:4px solid var(--mc)}
.conn-card-compact.caregiver{border-left:4px solid var(--mt)}
.conn-avatar-mini{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;background:var(--sfe);border:1px solid var(--bd);flex-shrink:0}
.conn-card-compact.chaotic .conn-avatar-mini{border-color:var(--mc);color:var(--mc)}
.conn-card-compact.caregiver .conn-avatar-mini{border-color:var(--mt);color:var(--mt)}
.conn-info{flex:1;min-width:0}
.conn-title-mini{font-size:12px;font-weight:600;line-height:1.4;color:var(--tx);margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.conn-meta{font-size:10px;color:var(--txs);display:flex;align-items:center;gap:6px}
.conn-meta::before{content:'';width:6px;height:6px;background:var(--aq);border-radius:50%;display:inline-block;animation:blink 2s infinite}
.conn-card-compact.chaotic .conn-meta::before{background:var(--mc)}
.conn-card-compact.caregiver .conn-meta::before{background:var(--mt)}
.conn-actions-mini{display:flex;gap:6px;flex-shrink:0}
.conn-btn-mini{padding:6px 12px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;border:1px solid var(--bd);background:var(--sf);color:var(--tx);cursor:pointer;transition:all .2s}
.conn-btn-mini:hover{border-color:var(--txs);background:var(--sfe)}
.conn-btn-mini.pri{background:var(--tx);border-color:var(--tx);color:var(--bg)}
.conn-btn-mini.pri:hover{background:var(--ap);border-color:var(--ap)}
.conn-btn-mini:disabled{opacity:.5;cursor:not-allowed}
</style>
</head>
<body>
<div class="w">
<header>
  <div>
    <div class="logo" onclick="location.reload()">JEJAK</div>
    <div class="tagline">no filter, just truth</div>
  </div>
  <div class="top-right">
    <div class="huser" id="huser">@anon</div>
    <div class="dot off" id="odot" title="Offline"></div>
    <div class="smenu">
      <button class="mtrig" onclick="toggleMenu()"><span></span><span></span><span></span></button>
      <div class="mdd" id="mdd"><button class="mi" onclick="logoutUser()">Logout</button></div>
    </div>
  </div>
</header>

<section class="hero-s">
  <div class="hero" id="hero">
    <img id="himg" src="" alt="artefak" class="fm">
    <div id="hfaces" style="position:absolute;inset:0;pointer-events:none"></div>
    <div class="hnote" id="hnote">"memori tersimpan"</div>
    <div class="upctrls">
      <div class="qtimer" id="qtimer">Window aktif â€¢ Sisa 2 hari</div>
      <button class="upbtn" id="upbtn">+<span class="upcnt" id="ucnt" style="display:none"></span></button>
    </div>
  </div>
</section>

<section class="isec">
  <div class="ihdr"><span class="ilbl">Spill your truth</span><span class="ccount" id="ccount">0/500</span></div>
  <textarea class="ri" id="ri" placeholder="What's eating you alive right now? No cap, no filter..." maxlength="500"></textarea>
  <div class="msec">
    <div class="mlbl">Pilih mood-mu sekarang</div>
    <div class="mgrid">
      <div class="mc act" data-mood="surviving" onclick="selMood('surviving')"><span class="me">ğŸ˜®â€ğŸ’¨</span><span class="mn" style="color:var(--ms)">Surviving</span><span class="md-desc">Hidup tapi barely</span></div>
      <div class="mc" data-mood="thriving" onclick="selMood('thriving')"><span class="me">âœ¨</span><span class="mn" style="color:var(--mt)">Thriving</span><span class="md-desc">On top of my game</span></div>
      <div class="mc" data-mood="chaotic" onclick="selMood('chaotic')"><span class="me">ğŸŒ€</span><span class="mn" style="color:var(--mc)">Chaotic</span><span class="md-desc">Everything is on fire</span></div>
      <div class="mc" data-mood="doom" onclick="selMood('doom')"><span class="me">ğŸ›Œ</span><span class="mn" style="color:var(--md)">Doom</span><span class="md-desc">Just wanna disappear</span></div>
    </div>
  </div>
  <div class="iact"><button class="sbtn" id="sbtn">Jejakkan & Spill</button></div>
</section>

<section>
  <div class="shdr"><span class="stit">Riwayat</span><div class="sline"></div><span style="font-size:10px;color:var(--txm);margin-left:auto">FIFO â€¢ MAX 6 â€¢ AUTO-CENSOR</span></div>
  <div id="econ"></div>
</section>

<section style="margin-bottom:32px">
  <div class="shdr"><span class="stit">Memori</span><div class="sline"></div><span style="font-size:10px;color:var(--txm);margin-left:auto">FIFO â€¢ MAX 6 â€¢ AUTO-CENSOR</span></div>
  <div class="tgrid" id="tgrid"></div>
  <div class="conn-mini">
    <div class="conn-card-compact chaotic" id="card-chaotic">
      <div class="conn-avatar-mini">ğŸŒ€</div>
      <div class="conn-info">
        <div class="conn-title-mini">Seseorang dengan pola "chaotic good" sering muncul di timeline kamu.</div>
        <div class="conn-meta">aktif jam aneh â€¢ react ğŸ˜­ jarang post</div>
      </div>
      <div class="conn-actions-mini">
        <button class="conn-btn-mini" onclick="skipConnection('chaotic')">Abaikan</button>
        <button class="conn-btn-mini pri" onclick="signalConnection('chaotic')">Senggol</button>
      </div>
    </div>
    <div class="conn-card-compact caregiver" id="card-caregiver">
      <div class="conn-avatar-mini">ğŸ«‚</div>
      <div class="conn-info">
        <div class="conn-title-mini">Ada yang sering kasih hug ke curhatanmu, tapi jarang cerita balik.</div>
        <div class="conn-meta">caregiver â€¢ burnout tapi diam</div>
      </div>
      <div class="conn-actions-mini">
        <button class="conn-btn-mini" onclick="skipConnection('caregiver')">Abaikan</button>
        <button class="conn-btn-mini pri" onclick="signalConnection('caregiver')">Senggol</button>
      </div>
    </div>
  </div>
</section>

<footer><p class="ftxt">Nyambat â€¢ Aksi â€¢ Solusi</p></footer>
</div>

<nav class="bnav">
  <div class="bnav-c">
    <a href="jejak.html" class="ni act"><span class="nico">âœ¦</span><span>Jejak</span></a>
    <a href="spill.html" class="ni"><span class="nico">âœ•</span><span>Spill</span></a>
    <a href="cocomeo.html" class="ni"><span class="nico">ã€œ</span><span>Cocomeo</span></a>
    <a href="glitch.html" class="ni"><span class="nico">âš¡</span><span>Glitch</span></a>
  </div>
</nav>

<div class="proc" id="proc">
  <div class="pspin"></div>
  <div class="ptxt">Scanning untuk wajah...<br><small>AI Privacy Shield Active</small></div>
</div>
<div class="modal" id="gmodal">
  <div class="mc2">
    <div class="mhdr"><h3 class="mtit">Review Artefak</h3><button class="mcls" onclick="closeGallery()">Ã—</button></div>
    <div class="gwarn">DILARANG UPLOAD FOTO WAJAH!</div>
    <div style="font-size:11px;color:var(--txs);margin-bottom:16px;text-align:center">Wajah terdeteksi akan otomatis disensor â€¢ Sistem FIFO (6 foto max) â€¢ Tidak dapat dihapus</div>
    <div class="ggrid" id="ggrid"></div>
    <div class="tmsec">
      <div class="tmhdr"><span class="tmlbl">ğŸ¨ Tema Foto</span><span class="tmnm" id="tmnm">MONOCHROME</span></div>
      <input type="range" class="tmsl" id="tmsl" min="0" max="11" value="0" step="1" oninput="updTheme(this.value)">
      <div class="tmlabs"><span>B&W</span><span>Warm</span><span>Cool</span><span>Art</span></div>
    </div>
    <div class="notsec">
      <div class="notlbl"><span>ğŸ“ Notasi (Max 4 kata)</span><span class="notcnt" id="notcnt">0/4</span></div>
      <input type="text" class="noti" id="noti" placeholder="Contoh: senja di kamar" maxlength="30" oninput="valNote(this)">
    </div>
    <div class="macts">
      <button class="mbtn" onclick="closeGallery()">Batal</button>
      <button class="mbtn pri" onclick="confirmUpload()">Konfirmasi (<span id="selcnt">0</span>)</button>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>
<input type="file" id="finput" accept="image/*" multiple style="display:none">

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE REST â€” zero WebSocket
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SB_URL='https://fuovfrdicdhnlymnacpz.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';
const SB_HDR={'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json','Prefer':'return=minimal'};

async function sbInsert(t, d) {
  try {
    const r = await fetch(`${SB_URL}/rest/v1/${t}`, {
      method: 'POST',
      headers: SB_HDR,
      body: JSON.stringify(d)
    });
    if (!r.ok) {
      console.error(`[sbInsert:${t}]`, r.status, await r.text());
      return false;
    }
    return true;
  } catch (e) {
    console.error(`[sbInsert:${t}]`, e);
    return false;
  }
}

async function sbSelect(t, p = '') {
  try {
    const r = await fetch(`${SB_URL}/rest/v1/${t}?${p}`, {
      headers: {
        'apikey': SB_KEY,
        'Authorization': 'Bearer ' + SB_KEY
      }
    });
    if (!r.ok) return null;
    return await r.json();
  } catch (e) {
    console.error(`[sbSelect:${t}]`, e);
    return null;
  }
}

async function sbUpdate(t, m, d) {
  try {
    const r = await fetch(`${SB_URL}/rest/v1/${t}?${m}`, {
      method: 'PATCH',
      headers: SB_HDR,
      body: JSON.stringify(d)
    });
    return r.ok;
  } catch (e) {
    console.error(`[sbUpdate:${t}]`, e);
    return false;
  }
}

async function sbDelete(t, m) {
  try {
    const r = await fetch(`${SB_URL}/rest/v1/${t}?${m}`, {
      method: 'DELETE',
      headers: {
        'apikey': SB_KEY,
        'Authorization': 'Bearer ' + SB_KEY,
        'Prefer': 'return=minimal'
      }
    });
    return r.ok;
  } catch (e) {
    console.error(`[sbDelete:${t}]`, e);
    return false;
  }
}

async function sbUploadFile(bucket, path, blob) {
  try {
    const r = await fetch(`${SB_URL}/storage/v1/object/${bucket}/${path}`, {
      method: 'POST',
      headers: {
        'apikey': SB_KEY,
        'Authorization': 'Bearer ' + SB_KEY,
        'Content-Type': 'image/jpeg'
      },
      body: blob
    });
    if (!r.ok) throw new Error(await r.text());
    return `${SB_URL}/storage/v1/object/public/${bucket}/${path}`;
  } catch (e) {
    console.error('[sbUploadFile]', e);
    return null;
  }
}

async function checkOnline() {
  try {
    const r = await fetch(`${SB_URL}/rest/v1/rants?limit=1`, {
      headers: {
        'apikey': SB_KEY,
        'Authorization': 'Bearer ' + SB_KEY
      }
    });
    return r.ok;
  } catch {
    return false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 30 KARAKTER CHAOS (DIGITAL FRIENDS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHAOS_FRIENDS = {
  emosi: [
    { username: 'beby.manis', vibe: 'manja', emoji: 'ğŸ¥º' },
    { username: 'moon.child', vibe: 'melankolis', emoji: 'ğŸŒ™' },
    { username: 'strawberry.shortcake', vibe: 'manis', emoji: 'ğŸ“' },
    { username: 'luv.letter', vibe: 'romantis', emoji: 'ğŸ’Œ' },
    { username: 'cloud.dreamer', vibe: 'melamun', emoji: 'â˜ï¸' },
    { username: 'pretty.sad', vibe: 'galau', emoji: 'ğŸ˜”' },
    { username: 'teddy.bear', vibe: 'hangat', emoji: 'ğŸ§¸' },
    { username: 'popcorn.galau', vibe: 'humoris', emoji: 'ğŸ¿' },
    { username: 'cinnamon.girl', vibe: 'hangat', emoji: 'ğŸ¥¨' },
    { username: 'pink.sky', vibe: 'cerah', emoji: 'ğŸŒ¸' },
    { username: 'sleepy.head', vibe: 'lelah', emoji: 'ğŸ˜´' },
    { username: 'cherry.blossom', vibe: 'lembut', emoji: 'ğŸŒ¸' },
    { username: 'bubble.tea', vibe: 'cute', emoji: 'ğŸ§‹' },
    { username: 'little.fairy', vibe: 'magical', emoji: 'ğŸ§š' },
    { username: 'baby.girl', vibe: 'manja', emoji: 'ğŸ‘¶' }
  ],
  agak: [
    { username: 'si.badai', vibe: 'sarkas', emoji: 'ğŸŒªï¸' },
    { username: 'mba.ceplas', vibe: 'ceplas-ceplos', emoji: 'ğŸ—£ï¸' },
    { username: 'cici.sensor', vibe: 'nyeleneh', emoji: 'ğŸ”' },
    { username: 'si.imut.jahat', vibe: 'imut jahat', emoji: 'ğŸ˜ˆ' },
    { username: 'cantik.tapi.sad', vibe: 'sarkas', emoji: 'ğŸ’…' },
    { username: 'mba.nyinyir', vibe: 'nyinyir', emoji: 'ğŸ‘€' },
    { username: 'si.pedas', vibe: 'pedas', emoji: 'ğŸŒ¶ï¸' },
    { username: 'mba.galau.akutan', vibe: 'galau', emoji: 'ğŸ˜«' },
    { username: 'si.polos.bahaya', vibe: 'polos', emoji: 'ğŸ˜‡' },
    { username: 'mba.santuy', vibe: 'santai', emoji: 'ğŸ˜' },
    { username: 'si.cerewet', vibe: 'cerewet', emoji: 'ğŸ“¢' },
    { username: 'mba.ngarep', vibe: 'ngarep', emoji: 'ğŸ¤' },
    { username: 'si.ngeselin', vibe: 'ngeselin', emoji: 'ğŸ˜' },
    { username: 'mba.gaul', vibe: 'gaul', emoji: 'ğŸ”¥' },
    { username: 'si.kocak', vibe: 'kocak', emoji: 'ğŸ˜‚' }
  ]
};

// Daftar rant random untuk 30 karakter
const CHAOS_RANTS = {
  surviving: [
    "hari ini aku bertahan cuma karena chat dari kaka @{user}... makasih ya",
    "ngampus sambil nahan nangis, gapapa kan sis?",
    "hidup lagi berat, tapi lihat postingan orang-orang di sini baku hibur, jadi agak lega",
    "aku tahu rasanya capek, kalo kaka perlu temen cerita, aku ada kok",
    "bertahan buat esok hari, meskipun hari ini rasanya mau nyerah"
  ],
  thriving: [
    "akhirnya bisa tidur nyenyak semalaman âœ¨ makasih supportnya kaka!",
    "dapet nilai A, traktir virtual ğŸµ buat semua",
    "hari ini produktif banget! ada yang mau spill kemenangan juga?",
    "thriving mode on! kalo ada yang butuh semangat, come here sis",
    "berhasil banget hari ini, kaka harus coba juga!"
  ],
  chaotic: [
    "hari ini chaos abis! dari bangun tidur udah salah ambil kaki ğŸ˜‚",
    "otak kayak roller coaster, ada yang ngerasain juga?",
    "abis nonton drakor sampe lupa dunia, kaka juga gitu?",
    "chaotic tapi happy, gimana ceritanya kaka?",
    "hari ini random banget, gak bisa dijelasin pake logika"
  ],
  doom: [
    "rasanya pengen jadi batu aja, gak usah mikir apa-apa",
    "doom scrolling dari jam 2 pagi sampe sekarang... sad",
    "kadang hidup tuh capek ya kaka, tanpa alasan yang jelas",
    "aku di sini kalo ada yang butuh tempat curhat, no judgement",
    "hari ini gak kuat, tapi besok pasti dicoba lagi"
  ]
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG & CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CFG = {
  quotaDays: 28,
  uploadWindowDays: 3,
  maxFileSize: 5 * 1024 * 1024,
  maxSelection: 6,
  maxArtefacts: 6,
  maxEntries: 12,
  faceThreshold: 0.6,
  inputSize: 416,
  storageBucket: 'artefacts',
  chaosInterval: 180000
};

const MOODS = {
  surviving: { emoji: 'ğŸ˜®â€ğŸ’¨', label: 'surviving' },
  thriving: { emoji: 'âœ¨', label: 'thriving' },
  chaotic: { emoji: 'ğŸŒ€', label: 'chaotic' },
  doom: { emoji: 'ğŸ›Œ', label: 'doom' }
};

const THEMES = [
  { name: 'MONOCHROME', filter: 'fm' },
  { name: 'NOIR', filter: 'fn' },
  { name: 'SEPIA', filter: 'fsp' },
  { name: 'WARM', filter: 'fw' },
  { name: 'GOLDEN', filter: 'fg' },
  { name: 'LOMO', filter: 'fl' },
  { name: 'DREAM', filter: 'fd' },
  { name: 'COLD', filter: 'fco' },
  { name: 'CYBER', filter: 'fc' },
  { name: 'VIGNETTE', filter: 'fv' },
  { name: 'CRISP', filter: 'fcr' },
  { name: 'MOODY', filter: 'fmo' }
];

const CF = {
  'fm': 'grayscale(100%) contrast(1.1)',
  'fn': 'grayscale(100%) contrast(1.4) brightness(.8)',
  'fsp': 'sepia(100%) contrast(1.1) saturate(.8)',
  'fw': 'sepia(60%) hue-rotate(-30deg) saturate(1.2)',
  'fg': 'sepia(40%) hue-rotate(-15deg) saturate(1.3) contrast(1.1)',
  'fl': 'contrast(1.2) saturate(1.3) brightness(.9)',
  'fd': 'blur(.5px) saturate(1.4) brightness(1.1) contrast(.9)',
  'fco': 'hue-rotate(180deg) saturate(.5) brightness(1.1)',
  'fc': 'hue-rotate(180deg) saturate(1.5) contrast(1.1)',
  'fv': 'grayscale(100%) contrast(1.2) brightness(.9)',
  'fcr': 'contrast(1.3) saturate(1.1)',
  'fmo': 'brightness(.8) contrast(1.2) saturate(.7)'
};

// Reaksi: key harus cocok dengan nilai kolom emoji di tabel public.reactions
const RX = {
  skull: { e: 'ğŸ’€', tip: 'Dead from laughing' },
  cry: { e: 'ğŸ˜­', tip: 'I felt that' },
  fire: { e: 'ğŸ”¥', tip: 'This is lit' },
  upside: { e: 'ğŸ™ƒ', tip: 'Chaotic energy' }
};

const DE = [
  {
    id: '__d1',
    content: "gue udah bantuin dia tiap malem pas dia galau sampe gue lupa ngerjain tugas sendiri. pas gue butuh temen buat ngobrol, dia malah offline terus.",
    mood: 'surviving',
    timestamp: Date.now() - 172800000,
    reactions: { skull: 5, cry: 12, fire: 3, upside: 8 },
    userReacted: null,
    isDummy: true,
    author: '__demo'
  },
  {
    id: '__d2',
    content: "deadline mepet, dosen gak jelas, dompet kering. rasanya pengen ijin cuti sehari buat jadi batu aja.",
    mood: 'doom',
    timestamp: Date.now() - 86400000,
    reactions: { skull: 15, cry: 7, fire: 2, upside: 20 },
    userReacted: null,
    isDummy: true,
    author: '__demo'
  },
  {
    id: '__d3',
    content: "capek.",
    mood: 'surviving',
    timestamp: Date.now() - 43200000,
    reactions: { skull: 25, cry: 30, fire: 5, upside: 18 },
    userReacted: null,
    isDummy: true,
    author: '__demo'
  }
];

const DA = [
  {
    id: '__a1',
    url: 'https://images.unsplash.com/photo-1517842645767-c639042777db?w=400&q=80',
    note: 'jeda',
    faces: [],
    hasFace: false,
    isDummy: true
  },
  {
    id: '__a2',
    url: 'https://images.unsplash.com/photo-1499209974431-9dddcece7f88?w=400&q=80',
    note: 'hijau',
    faces: [],
    hasFace: false,
    isDummy: true
  },
  {
    id: '__a3',
    url: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=400&q=80',
    note: 'gabut',
    faces: [],
    hasFace: false,
    isDummy: true
  },
  {
    id: '__a4',
    url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&q=80',
    note: 'sendiri',
    faces: [],
    hasFace: false,
    isDummy: true
  },
  {
    id: '__a5',
    url: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&q=80',
    note: 'capek',
    faces: [{ box: { x: 75, y: 45, width: 150, height: 200 }, score: 0.92 }],
    hasFace: true,
    isDummy: true
  },
  {
    id: '__a6',
    url: 'https://images.unsplash.com/photo-1516035069371-29a1b244cc32?w=400&q=80',
    note: 'love',
    faces: [],
    hasFace: false,
    isDummy: true
  }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SESS = (() => {
  const u = localStorage.getItem('jejak_username');
  const id = localStorage.getItem('jejak_user_id');
  const li = localStorage.getItem('jejak_logged_in');
  return (!li || !u) ? { username: '@anon', userId: null } : { username: u, userId: id };
})();

const PFX = 'jejak_' + (SESS.userId || SESS.username).replace(/[^a-z0-9]/g, '_') + '_';

const S = {
  user: SESS.username,
  uid: SESS.userId,
  mood: 'surviving',
  entries: [],
  artefacts: [],
  selFiles: new Set(),
  theme: 0,
  note: '',
  faceLoaded: false,
  online: false,
  qStart: localStorage.getItem(PFX + 'quota_start') || null,
  uploads: parseInt(localStorage.getItem(PFX + 'uploads_count') || '0'),
  pendingFiles: [],
  chaosInterval: null
};

const $ = id => document.getElementById(id);

function toast(msg) {
  const t = $('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function esc(t) {
  const d = document.createElement('div');
  d.textContent = t;
  return d.innerHTML;
}

function showProc(v) {
  $('proc').classList[v ? 'add' : 'remove']('on');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAOS GENERATOR - HUMAN PATTERN (LANGSUNG KE SPILL)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHAOS_SCHEDULE = {
  // [jam] = { min: minimal rant, maks: maksimal rant, karakter: [list username] }
  5:  { min: 2, max: 3, karakter: ['sleepy.head', 'moon.child'] },
  6:  { min: 3, max: 4, karakter: ['mba.santuy', 'si.badai', 'sleepy.head'] },
  7:  { min: 3, max: 4, karakter: ['beby.manis', 'strawberry.shortcake', 'mba.ceplas'] },
  8:  { min: 2, max: 3, karakter: ['popcorn.galau', 'si.pedas', 'cinnamon.girl'] },
  9:  { min: 2, max: 3, karakter: ['popcorn.galau', 'si.pedas', 'cloud.dreamer'] },
  10: { min: 4, max: 5, karakter: ['cinnamon.girl', 'bubble.tea', 'little.fairy'] },
  11: { min: 3, max: 4, karakter: ['si.lapar', 'mba.ceplas', 'popcorn.galau'] },
  12: { min: 5, max: 6, karakter: 'all' }, // Peak hour, semua karakter
  13: { min: 2, max: 3, karakter: ['teddy.bear', 'pretty.sad', 'cherry.blossom'] },
  14: { min: 2, max: 3, karakter: ['cloud.dreamer', 'little.fairy', 'sleepy.head'] },
  15: { min: 3, max: 4, karakter: ['si.kocak', 'mba.ngarep', 'si.imut.jahat'] },
  16: { min: 4, max: 5, karakter: ['si.badai', 'mba.nyinyir', 'cantik.tapi.sad'] },
  17: { min: 3, max: 4, karakter: ['cherry.blossom', 'pink.sky', 'mba.santuy'] },
  18: { min: 4, max: 5, karakter: ['cinnamon.girl', 'popcorn.galau', 'bubble.tea'] },
  19: { min: 3, max: 4, karakter: ['si.kocak', 'mba.gaul', 'beby.manis'] },
  20: { min: 4, max: 5, karakter: ['sleepy.head', 'si.pedas', 'si.cerewet'] },
  21: { min: 5, max: 6, karakter: 'all_emosi' }, // Peak galau, semua karakter emosi
  22: { min: 4, max: 5, karakter: ['baby.girl', 'teddy.bear', 'moon.child'] },
  23: { min: 3, max: 4, karakter: ['si.imut.jahat', 'mba.galau.akutan', 'sleepy.head'] },
  0:  { min: 2, max: 3, karakter: ['moon.child', 'sleepy.head', 'si.ngeselin'] },
  1:  { min: 2, max: 3, karakter: ['moon.child', 'si.polos.bahaya'] },
  2:  { min: 1, max: 2, karakter: ['moon.child'] },
  3:  { min: 1, max: 2, karakter: ['moon.child'] },
  4:  { min: 1, max: 2, karakter: ['moon.child', 'sleepy.head'] }
};

function getRandomMood() {
  const moods = ['surviving', 'thriving', 'chaotic', 'doom'];
  const weights = [0.4, 0.3, 0.2, 0.1];
  const rand = Math.random();
  let sum = 0;
  for (let i = 0; i < moods.length; i++) {
    sum += weights[i];
    if (rand < sum) return moods[i];
  }
  return 'surviving';
}

function getCharactersForHour(hour) {
  const schedule = CHAOS_SCHEDULE[hour] || CHAOS_SCHEDULE[12];
  if (schedule.karakter === 'all') {
    return [...CHAOS_FRIENDS.emosi, ...CHAOS_FRIENDS.agak];
  } else if (schedule.karakter === 'all_emosi') {
    return CHAOS_FRIENDS.emosi;
  } else if (schedule.karakter === 'all_agak') {
    return CHAOS_FRIENDS.agak;
  } else {
    const allChars = [...CHAOS_FRIENDS.emosi, ...CHAOS_FRIENDS.agak];
    return allChars.filter(c => schedule.karakter.includes(c.username));
  }
}

function getDailyTarget() {
  const hour = new Date().getHours();
  const schedule = CHAOS_SCHEDULE[hour] || CHAOS_SCHEDULE[12];
  return Math.floor(Math.random() * (schedule.max - schedule.min + 1)) + schedule.min;
}

function startChaosGenerator() {
  if (S.chaosInterval) clearInterval(S.chaosInterval);
  
  let targetForThisHour = getDailyTarget();
  let rantCountThisHour = 0;
  
  console.log(`ğŸŒªï¸ Chaos generator started. Target jam ini: ${targetForThisHour} rant (akan dikirim ke spill)`);
  
  setTimeout(() => {
    generateChaosBatch();
  }, 300000 + Math.random() * 600000);
  
  S.chaosInterval = setInterval(() => {
    if (!S.online) return;
    
    const currentHour = new Date().getHours();
    
    if (currentHour !== lastHour) {
      lastHour = currentHour;
      targetForThisHour = getDailyTarget();
      rantCountThisHour = 0;
      console.log(`ğŸ• Ganti jam ${currentHour}. Target spill: ${targetForThisHour} rant`);
    }
    
    if (rantCountThisHour < targetForThisHour) {
      const batchSize = Math.min(2, targetForThisHour - rantCountThisHour);
      for (let i = 0; i < batchSize; i++) {
        setTimeout(() => generateChaosRantAndSendToSpill(), i * 5000);
      }
      rantCountThisHour += batchSize;
      console.log(`ğŸ“Š Rant spill jam ini: ${rantCountThisHour}/${targetForThisHour}`);
    }
  }, 1800000 + Math.random() * 1800000);
}

let lastHour = new Date().getHours();

async function generateChaosRantAndSendToSpill() {
  const hour = new Date().getHours();
  const characters = getCharactersForHour(hour);
  
  if (!characters || characters.length === 0) return;
  
  const randomChar = characters[Math.floor(Math.random() * characters.length)];
  const mood = getRandomMood();
  const rants = CHAOS_RANTS[mood];
  let rant = rants[Math.floor(Math.random() * rants.length)];
  
  rant = rant.replace('@{user}', randomChar.username);
  
  const id = 'chaos_' + Date.now() + '_' + Math.random().toString(36).substring(2, 7);
  
  // KIRIM KE SPILL VIA SUPABASE
  const rantObj = {
    id: id,
    content: rant,
    mood: mood,
    author: randomChar.username,
    is_ai: true,
    created_at: new Date().toISOString()
  };
  
  try {
    // Simpan ke tabel spill_ai atau kirim ke endpoint khusus
    const response = await fetch('https://jejak.space/api/chaos-to-spill', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(rantObj)
    });
    
    if (response.ok) {
      console.log(`âœ… Rant ${randomChar.username} terkirim ke spill`);
    }
  } catch (e) {
    console.error('âŒ Gagal kirim rant ke spill', e);
  }
  
  if (Math.random() < 0.2) {
    toast(`ğŸŒ€ ${randomChar.username} nge-spill di halaman lain`);
  }
}

function generateChaosBatch() {
  const hour = new Date().getHours();
  const characters = getCharactersForHour(hour);
  
  const batchSize = 2 + Math.floor(Math.random() * 3);
  
  for (let i = 0; i < batchSize; i++) {
    setTimeout(() => {
      generateChaosRantAndSendToSpill();
    }, i * 8000 + Math.random() * 4000);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOCAL STATE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getVisEntries() {
  const r = S.entries; // HANYA ENTRI USER (tidak ada chaos)
  if (!r.length) return DE;
  if (r.length < 3) return [...r, ...DE.slice(0, 3 - r.length)];
  return r.slice(0, CFG.maxEntries);
}

function addEntryFIFO(e) {
  S.entries.unshift(e);
  if (S.entries.length > CFG.maxEntries) {
    S.entries.pop();
    toast('Entry lama terhapus (FIFO)');
  }
  saveEntries();
  renderEntries();
}

function updEntry(id, u) {
  const i = S.entries.findIndex(e => e.id === id);
  if (i !== -1) {
    S.entries[i] = { ...S.entries[i], ...u };
    saveEntries();
    renderEntries();
  }
}

function getVisArtefacts() {
  const r = S.artefacts.filter(a => !a.isDummy);
  if (r.length >= 6) return r.slice(0, 6);
  return [...r, ...DA.slice(0, 6 - r.length)];
}

function addArtefactFIFO(a) {
  const r = S.artefacts.filter(x => !x.isDummy);
  r.unshift(a);
  if (r.length > CFG.maxArtefacts) {
    r.pop();
    toast('Foto lama terhapus (FIFO)');
  }
  S.artefacts = r;
  saveArtefacts();
  renderTray();
  setHero(a.url, a.note, a.faces, 'f' + (a.theme || 'm').toLowerCase());
}

const saveEntries = () => localStorage.setItem(PFX + 'entries', JSON.stringify(S.entries));
const saveArtefacts = () => localStorage.setItem(PFX + 'artefacts', JSON.stringify(S.artefacts));

function loadStorage() {
  try {
    const e = localStorage.getItem(PFX + 'entries');
    if (e) S.entries = JSON.parse(e).map(x => ({
      ...x,
      reactions: x.reactions || { skull: 0, cry: 0, fire: 0, upside: 0 },
      userReacted: x.userReacted || null
    }));
  } catch {
    S.entries = [];
  }
  try {
    const a = localStorage.getItem(PFX + 'artefacts');
    if (a) S.artefacts = JSON.parse(a);
  } catch {
    S.artefacts = [];
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ONLINE INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initOnline() {
  S.online = await checkOnline();
  const d = $('odot');
  if (d) {
    d.classList[S.online ? 'remove' : 'add']('off');
    d.title = S.online ? 'Online' : 'Offline';
  }
  if (S.online) {
    await loadRants();
    await loadArtefacts();
    await flushSyncQueue();
    
    // Mulai chaos generator (rant karakter dikirim ke spill)
    startChaosGenerator();

    setInterval(async () => {
      if (S.online) {
        await loadRants();
      }
    }, 30000);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD RANTS + REACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadRants() {
  try {
    const rants = await sbSelect('rants',
      `author=eq.${encodeURIComponent(S.user)}&order=created_at.desc&limit=${CFG.maxEntries}`);

    if (!rants || !rants.length) return;

    const rantIds = rants.map(r => r.id);
    const reactMap = {};
    rantIds.forEach(id => {
      reactMap[id] = { skull: 0, cry: 0, fire: 0, upside: 0, myEmoji: null };
    });

    for (const rantId of rantIds) {
      const rxRaw = await sbSelect('reactions', `rant_id=eq.${rantId}&select=rant_id,user_id,emoji`);

      if (rxRaw && rxRaw.length) {
        rxRaw.forEach(rx => {
          if (rx.emoji === 'skull') reactMap[rantId].skull++;
          else if (rx.emoji === 'cry') reactMap[rantId].cry++;
          else if (rx.emoji === 'fire') reactMap[rantId].fire++;
          else if (rx.emoji === 'upside') reactMap[rantId].upside++;

          if (rx.user_id === S.user) {
            reactMap[rantId].myEmoji = rx.emoji;
          }
        });
      }
    }

    S.entries = S.entries.map(entry => {
      if (reactMap[entry.id]) {
        return {
          ...entry,
          reactions: {
            skull: reactMap[entry.id].skull,
            cry: reactMap[entry.id].cry,
            fire: reactMap[entry.id].fire,
            upside: reactMap[entry.id].upside
          },
          userReacted: reactMap[entry.id].myEmoji
        };
      }
      return entry;
    });

    const existingIds = new Set(S.entries.map(e => e.id));
    const newEntries = rants
      .filter(r => !existingIds.has(r.id))
      .map(r => ({
        id: r.id,
        content: r.content,
        mood: r.mood,
        timestamp: new Date(r.created_at).getTime(),
        reactions: {
          skull: reactMap[r.id]?.skull || 0,
          cry: reactMap[r.id]?.cry || 0,
          fire: reactMap[r.id]?.fire || 0,
          upside: reactMap[r.id]?.upside || 0
        },
        userReacted: reactMap[r.id]?.myEmoji || null,
        isSpilled: true,
        author: r.author
      }));

    if (newEntries.length) {
      S.entries = [...newEntries, ...S.entries]
        .sort((a, b) => b.timestamp - a.timestamp)
        .slice(0, CFG.maxEntries);
    }

    saveEntries();
    renderEntries();

  } catch (error) {
    console.error('[loadRants error]', error);
  }
}

async function loadArtefacts() {
  const data = await sbSelect('artefacts', `author=eq.${encodeURIComponent(S.user)}&order=created_at.desc&limit=${CFG.maxArtefacts}`);
  if (!data || !data.length) return;
  S.artefacts = data.map(a => ({
    id: a.id,
    url: a.url,
    note: a.note || 'memory',
    faces: a.faces || [],
    hasFace: a.has_face || false,
    timestamp: new Date(a.created_at).getTime()
  }));
  saveArtefacts();
  renderTray();
  if (S.artefacts[0]) setHero(S.artefacts[0].url, S.artefacts[0].note, S.artefacts[0].faces);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUBMIT RANT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitRant(content, mood) {
  const id = crypto.randomUUID();
  const ts = Date.now();
  const entry = {
    id,
    content,
    mood,
    timestamp: ts,
    reactions: { skull: 0, cry: 0, fire: 0, upside: 0 },
    userReacted: null,
    isSpilled: false,
    author: S.user
  };
  addEntryFIFO(entry);

  const doInsert = () => sbInsert('rants', {
    id,
    content,
    mood,
    author: S.user,
    created_at: new Date(ts).toISOString()
  });

  if (S.online) {
    const ok = await doInsert();
    if (ok) {
      updEntry(id, { isSpilled: true });
      toast('âœ“ Tersimpan');
    } else {
      toast('âš  Gagal â€” lokal');
      qSync('rant', entry);
    }
  } else {
    S.online = await checkOnline();
    if (S.online) {
      const ok = await doInsert();
      if (ok) {
        updEntry(id, { isSpilled: true });
        toast('âœ“ Tersimpan');
      } else {
        toast('âš  Gagal â€” lokal');
        qSync('rant', entry);
      }
    } else {
      toast('âš  Offline â€” lokal');
      qSync('rant', entry);
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOGGLE REACTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function toggleReaction(entryId, emoji) {
  const entry = S.entries.find(e => e.id === entryId);
  if (!entry) return;

  if (!entry.isDummy && entry.author === S.user) {
    toast('ğŸ˜¶ Gak bisa react ke rant sendiri');
    return;
  }

  const previousState = {
    reactions: { ...entry.reactions },
    userReacted: entry.userReacted
  };

  const prevEmoji = entry.userReacted;

  if (prevEmoji === emoji) {
    entry.reactions[emoji] = Math.max(0, (entry.reactions[emoji] || 0) - 1);
    entry.userReacted = null;
  } else {
    if (prevEmoji) {
      entry.reactions[prevEmoji] = Math.max(0, (entry.reactions[prevEmoji] || 0) - 1);
    }
    entry.reactions[emoji] = (entry.reactions[emoji] || 0) + 1;
    entry.userReacted = emoji;
  }

  if (!entry.isDummy) {
    saveEntries();
  }
  renderEntries();

  if (S.online && !entry.isDummy) {
    try {
      if (prevEmoji && prevEmoji !== emoji) {
        await sbDelete('reactions',
          `rant_id=eq.${entryId}&user_id=eq.${encodeURIComponent(S.user)}`);
      }

      if (entry.userReacted) {
        const existing = await sbSelect('reactions',
          `rant_id=eq.${entryId}&user_id=eq.${encodeURIComponent(S.user)}&select=id`);

        if (existing && existing.length > 0) {
          const ok = await sbUpdate('reactions', `id=eq.${existing[0].id}`, { emoji });
          if (!ok) throw new Error('Update failed');
        } else {
          const newId = crypto.randomUUID();
          const ok = await sbInsert('reactions', {
            id: newId,
            rant_id: entryId,
            user_id: S.user,
            emoji: emoji,
            created_at: new Date().toISOString()
          });
          if (!ok) throw new Error('Insert failed');
        }
      } else {
        await sbDelete('reactions', `rant_id=eq.${entryId}&user_id=eq.${encodeURIComponent(S.user)}`);
      }

      await loadRants();

    } catch (error) {
      console.error('[rxSync error]', error);

      entry.reactions = previousState.reactions;
      entry.userReacted = previousState.userReacted;
      saveEntries();
      renderEntries();

      toast('âš  Gagal sync reaksi');
    }
  } else if (!entry.isDummy) {
    qSync('reaction', {
      id: crypto.randomUUID(),
      rant_id: entryId,
      user_id: S.user,
      emoji: entry.userReacted,
      timestamp: Date.now()
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYNC QUEUE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function qSync(type, data) {
  const q = JSON.parse(localStorage.getItem(PFX + 'sync_queue') || '[]');

  if (type === 'reaction') {
    const filtered = q.filter(item =>
      !(item.type === 'reaction' && item.data.rant_id === data.rant_id)
    );
    filtered.push({ type, data, timestamp: Date.now() });
    localStorage.setItem(PFX + 'sync_queue', JSON.stringify(filtered));
  } else {
    q.push({ type, data, timestamp: Date.now() });
    localStorage.setItem(PFX + 'sync_queue', JSON.stringify(q));
  }
}

async function flushSyncQueue() {
  const q = JSON.parse(localStorage.getItem(PFX + 'sync_queue') || '[]');
  if (!q.length) return;

  const failed = [];
  let syncedCount = 0;

  for (const item of q) {
    try {
      if (item.type === 'rant') {
        const ok = await sbInsert('rants', {
          id: item.data.id,
          content: item.data.content,
          mood: item.data.mood,
          author: item.data.author || S.user,
          created_at: new Date(item.data.timestamp).toISOString()
        });
        if (ok) {
          updEntry(item.data.id, { isSpilled: true });
          syncedCount++;
        } else {
          failed.push(item);
        }
      } else if (item.type === 'reaction') {
        if (item.data.emoji) {
          const existing = await sbSelect('reactions',
            `rant_id=eq.${item.data.rant_id}&user_id=eq.${encodeURIComponent(item.data.user_id)}&select=id`);

          if (existing && existing.length > 0) {
            await sbUpdate('reactions', `id=eq.${existing[0].id}`, { emoji: item.data.emoji });
          } else {
            await sbInsert('reactions', {
              id: item.data.id,
              rant_id: item.data.rant_id,
              user_id: item.data.user_id,
              emoji: item.data.emoji,
              created_at: new Date(item.data.timestamp).toISOString()
            });
          }
        } else {
          await sbDelete('reactions',
            `rant_id=eq.${item.data.rant_id}&user_id=eq.${encodeURIComponent(item.data.user_id)}`);
        }
        syncedCount++;
      }
    } catch (error) {
      console.error('[flushSyncQueue item error]', error);
      failed.push(item);
    }
  }

  localStorage.setItem(PFX + 'sync_queue', JSON.stringify(failed));

  if (syncedCount > 0) {
    toast(`âœ“ ${syncedCount} item tersinkronisasi`);
    await loadRants();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FACE API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadFaceApi() {
  try {
    const U = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.13/model/';
    await faceapi.nets.tinyFaceDetector.loadFromUri(U);
    await faceapi.nets.faceLandmark68Net.loadFromUri(U);
    S.faceLoaded = true;
  } catch (e) {
    S.faceLoaded = false;
    console.error('Face-API fail', e);
  }
}

async function detectFaces(file) {
  if (!S.faceLoaded) return [];
  showProc(true);
  try {
    const img = await faceapi.bufferToImage(file);
    const d = await faceapi.detectAllFaces(img, new faceapi.TinyFaceDetectorOptions({
      inputSize: CFG.inputSize,
      scoreThreshold: CFG.faceThreshold
    }));
    return d.map(x => ({
      box: { x: x.box.x, y: x.box.y, width: x.box.width, height: x.box.height },
      score: x.score
    }));
  } catch (e) {
    return [];
  } finally {
    showProc(false);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initUpload() {
  const btn = $('upbtn');
  const fi = $('finput');
  if (!btn || !fi) return;
  btn.onclick = () => {
    if (!checkQuota()) {
      toast('â³ Quota habis');
      return;
    }
    fi.click();
  };
  fi.onchange = handleFiles;
}

function checkQuota() {
  if (!S.qStart) {
    S.qStart = Date.now();
    localStorage.setItem(PFX + 'quota_start', S.qStart);
    S.uploads = 0;
    localStorage.setItem(PFX + 'uploads_count', '0');
    return true;
  }
  const e = Date.now() - parseInt(S.qStart);
  const w = CFG.uploadWindowDays * 86400000;
  if (e > w) {
    S.qStart = Date.now();
    S.uploads = 0;
    localStorage.setItem(PFX + 'quota_start', S.qStart);
    localStorage.setItem(PFX + 'uploads_count', '0');
    return true;
  }
  return S.uploads < CFG.maxSelection;
}

function updQuota() {
  const t = $('qtimer');
  const c = $('ucnt');
  if (!t) return;
  if (!S.qStart) {
    t.textContent = 'Window aktif â€¢ Sisa 6 slot';
    t.classList.remove('urg');
    if (c) c.style.display = 'none';
    return;
  }
  const e = Date.now() - parseInt(S.qStart);
  const w = CFG.uploadWindowDays * 86400000;
  const rem = Math.max(0, w - e);
  const days = Math.ceil(rem / 86400000);
  const slots = CFG.maxSelection - S.uploads;
  if (rem <= 0) t.textContent = 'Window reset â€¢ Sisa 6 slot';
  else {
    t.textContent = `Window aktif â€¢ ${days} hari â€¢ ${slots} slot`;
    if (slots <= 2) t.classList.add('urg');
  }
  if (c) {
    c.textContent = S.uploads;
    c.style.display = S.uploads > 0 ? 'block' : 'none';
  }
}

async function handleFiles(e) {
  const files = Array.from(e.target.files);
  if (!files.length) return;
  if (files.reduce((s, f) => s + f.size, 0) > CFG.maxFileSize * 2) {
    toast('âš  File terlalu besar');
    return;
  }
  const pf = [];
  for (const f of files.slice(0, CFG.maxSelection)) {
    const faces = await detectFaces(f);
    pf.push({
      file: f,
      faces,
      hasFace: faces.length > 0,
      preview: URL.createObjectURL(f)
    });
  }
  openGallery(pf);
}

function openGallery(files) {
  S.selFiles = new Set(files.map((_, i) => i));
  S.theme = 0;
  S.note = '';
  const grid = $('ggrid');
  if (!grid) return;
  grid.innerHTML = '';
  files.forEach((item, i) => {
    const d = document.createElement('div');
    d.className = 'gi sel';
    d.innerHTML = `<img src="${item.preview}" class="fm" id="pv${i}">`;
    d.onclick = () => toggleSel(i, d);
    if (item.hasFace) {
      const b = document.createElement('div');
      b.className = 'dbadge';
      b.textContent = 'WAJAH TERDETEKSI';
      d.appendChild(b);
    }
    grid.appendChild(d);
  });

  ['tmsl', 'tmnm', 'noti', 'notcnt'].forEach(id => {
    const el = $(id);
    if (el) {
      if (id === 'tmsl') el.value = 0;
      else if (id === 'tmnm') el.textContent = 'MONOCHROME';
      else if (id === 'noti') el.value = '';
      else el.textContent = '0/4';
    }
  });

  updSelCnt();
  $('gmodal').classList.add('on');
  S.pendingFiles = files;
}

function toggleSel(i, el) {
  S.selFiles[S.selFiles.has(i) ? 'delete' : 'add'](i);
  el.classList.toggle('sel');
  updSelCnt();
}

function updSelCnt() {
  const el = $('selcnt');
  if (el) el.textContent = S.selFiles.size;
}

function updTheme(v) {
  S.theme = +v;
  const t = THEMES[S.theme];
  const nm = $('tmnm');
  if (nm) nm.textContent = t.name;
  S.pendingFiles.forEach((_, i) => {
    const img = $('pv' + i);
    if (img) {
      img.className = '';
      img.classList.add(t.filter);
    }
  });
}

function valNote(inp) {
  const w = inp.value.trim().split(/\s+/).filter(x => x.length);
  const nc = $('notcnt');
  if (nc) nc.textContent = `${Math.min(w.length, 4)}/4`;
  if (w.length > 4) inp.value = w.slice(0, 4).join(' ');
  S.note = inp.value.trim();
}

function closeGallery() {
  $('gmodal').classList.remove('on');
  S.pendingFiles = [];
  S.selFiles = new Set();
}

async function confirmUpload() {
  if (!S.selFiles.size) {
    toast('Pilih minimal 1');
    return;
  }
  const theme = THEMES[S.theme];
  const note = S.note || 'memory';
  for (const i of S.selFiles) await procUpload(S.pendingFiles[i], theme, note);
  S.uploads += S.selFiles.size;
  localStorage.setItem(PFX + 'uploads_count', S.uploads);
  updQuota();
  closeGallery();
  toast(`âœ“ ${S.selFiles.size} foto`);
}

async function procUpload(item, theme, note) {
  const id = crypto.randomUUID();
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  const img = new Image();
  await new Promise(res => {
    img.onload = res;
    img.src = item.preview;
  });
  canvas.width = img.width;
  canvas.height = img.height;
  ctx.filter = CF[theme.filter] || CF['fm'];
  ctx.drawImage(img, 0, 0);
  const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.85));
  let url = item.preview;
  if (S.online) {
    const fn = `${S.user}/${id}.jpg`;
    const pubUrl = await sbUploadFile(CFG.storageBucket, fn, blob);
    if (pubUrl) {
      url = pubUrl;
      await sbInsert('artefacts', {
        id,
        url,
        note,
        faces: item.faces,
        has_face: item.hasFace,
        author: S.user,
        theme: theme.name,
        created_at: new Date().toISOString()
      });
    }
  }
  addArtefactFIFO({
    id,
    url,
    note,
    faces: item.faces,
    hasFace: item.hasFace,
    theme: theme.name,
    timestamp: Date.now(),
    isDummy: false
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mkScribble(face, cw, ch) {
  const div = document.createElement('div');
  div.className = 'fscrib';
  const sx = cw / 416;
  const sy = ch / (416 * (ch / cw));
  div.style.cssText = `left:${face.box.x * sx}px;top:${face.box.y * sy}px;width:${face.box.width * sx}px;height:${face.box.height * sy}px`;
  const m = document.createElement('div');
  m.className = 'mlines';
  div.appendChild(m);
  return div;
}

function renderReactionBar(entry) {
  const r = entry.reactions || { skull: 0, cry: 0, fire: 0, upside: 0 };
  const ur = entry.userReacted;
  const isOwn = !entry.isDummy && (entry.author === S.user);

  const btns = Object.entries(RX).map(([k, v]) => {
    const active = ur === k;
    const count = r[k] || 0;
    if (isOwn) {
      return `<button class="reaction-btn" disabled title="Gak bisa react ke rant sendiri">
        <span class="remoji">${v.e}</span><span class="rcount">${count}</span>
      </button>`;
    }
    return `<button class="reaction-btn${active ? ' act' : ''}"
      onclick="toggleReaction('${entry.id}','${k}')"
      data-tooltip="${v.tip}">
      <span class="remoji">${v.e}</span><span class="rcount">${count}</span>
    </button>`;
  }).join('');

  let lockLabel = '';
  if (isOwn) {
    lockLabel = `<span class="own-lock">rant lo sendiri</span>`;
  }
  return `<div class="reaction-bar">${btns}${lockLabel}</div>`;
}

function renderEntries() {
  const c = $('econ');
  if (!c) return;
  const entries = getVisEntries();
  if (!entries.length) {
    c.innerHTML = `<div class="es"><span class="ee">ğŸƒ</span><div class="et">Belum ada jejak</div><div class="est">Jadilah yang pertama spill your truth</div></div>`;
    return;
  }
  c.innerHTML = entries.map(e => {
    const m = MOODS[e.mood] || MOODS.surviving;
    const isDum = e.isDummy || e.id?.startsWith('__d');
    const isOwn = !isDum && e.author === S.user;
    let ts = 'baru saja';
    if (!isDum && e.timestamp) {
      const d = Date.now() - e.timestamp;
      const h = Math.floor(d / 3600000);
      const dy = Math.floor(h / 24);
      if (h < 1) ts = 'baru saja';
      else if (h < 24) ts = `${h}j yang lalu`;
      else ts = `${dy}h yang lalu`;
    } else if (isDum) ts = 'contoh';
    let badge = '';
    if (isDum) badge = '<span class="fifo-i">Contoh</span>';
    else if (isOwn) badge = '<span class="own-badge">Milik lo</span>';
    
    return `<article class="entry${isDum ? ' entry-dummy' : ''}${isOwn ? ' own-rant' : ''}" data-id="${e.id}">
      <div class="ehdr">
        <div class="emeta">
          <span class="etime">${ts}</span>
          <span class="emood ${e.mood}">${m.emoji} ${m.label}</span>
        </div>
        ${badge}
      </div>
      <div class="econt">${esc(e.content)}</div>
      ${renderReactionBar(e)}
    </article>`;
  }).join('');
}

function renderTray() {
  const g = $('tgrid');
  if (!g) return;
  g.innerHTML = getVisArtefacts().map(a => {
    const isDum = a.isDummy || a.id?.startsWith('__a');
    if (!a.url) return `<div class="ti empty" onclick="$('upbtn').click()">+</div>`;
    return `<div class="ti${isDum ? ' ti-dum' : ''}" onclick="setHeroFromTray('${a.id}')"><img src="${a.url}" alt="${a.note}" class="${a.theme ? 'f' + a.theme.toLowerCase() : 'fm'}">${a.hasFace ? '<span class="dbadge">SENSORED</span>' : ''}</div>`;
  }).join('');
}

function setHero(url, note, faces, fc = 'fm') {
  const hi = $('himg');
  const hn = $('hnote');
  const hf = $('hfaces');
  if (!hi || !hn) return;
  hi.src = url;
  hi.className = fc;
  hn.textContent = `"${note}"`;
  if (hf) {
    hf.innerHTML = '';
    if (faces?.length) faces.forEach(f => hf.appendChild(mkScribble(f, hi.clientWidth, hi.clientHeight)));
  }
}

function setHeroFromTray(id) {
  const a = S.artefacts.find(x => x.id === id) || DA.find(x => x.id === id);
  if (a) setHero(a.url, a.note, a.faces, a.theme ? 'f' + a.theme.toLowerCase() : 'fm');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selMood(mood) {
  S.mood = mood;
  document.querySelectorAll('.mc').forEach(c => c.classList.toggle('act', c.dataset.mood === mood));
}

function toggleMenu() {
  $('mdd').classList.toggle('on');
}

function logoutUser() {
  if (!confirm('Yakin logout?')) return;
  ['jejak_username', 'jejak_user_id', 'jejak_logged_in'].forEach(k => localStorage.removeItem(k));
  location.href = 'index.html';
}

document.addEventListener('click', e => {
  const m = $('mdd');
  const t = document.querySelector('.mtrig');
  if (m && t && !m.contains(e.target) && !t.contains(e.target)) m.classList.remove('on');
});

function skipConnection(type) {
  const card = document.getElementById(`card-${type}`);
  if (card) {
    card.style.opacity = '0.3';
    card.style.transform = 'translateX(-10px)';
    setTimeout(() => {
      card.style.display = 'none';
      toast(`${type === 'chaotic' ? 'Chaotic good' : 'Caregiver'} dilewati`);
    }, 200);
  }
}

function signalConnection(type) {
  const card = document.getElementById(`card-${type}`);
  if (card) {
    const btn = card.querySelector('.conn-btn-mini.pri');
    if (btn) {
      btn.textContent = 'âœ“';
      btn.disabled = true;
      btn.style.background = 'var(--aq)';
      btn.style.borderColor = 'var(--aq)';
    }
    toast(`Isyarat ke ${type === 'chaotic' ? 'chaotic good' : 'caregiver'} terkirim!`);
    setTimeout(() => {
      card.style.opacity = '.5';
    }, 1500);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  const hu = $('huser');
  if (hu) hu.textContent = S.user;

  loadStorage();
  initOnline();
  loadFaceApi();
  initUpload();
  renderEntries();
  renderTray();
  updQuota();

  const fr = S.artefacts.find(a => !a.isDummy);
  if (fr) setHero(fr.url, fr.note, fr.faces, fr.theme ? 'f' + fr.theme.toLowerCase() : 'fm');
  else if (DA.length) setHero(DA[0].url, DA[0].note, DA[0].faces);

  const ri = $('ri');
  const cc = $('ccount');
  const sb = $('sbtn');

  if (ri && cc) {
    ri.oninput = () => {
      const n = ri.value.length;
      cc.textContent = `${n}/500`;
      cc.style.color = n >= 450 ? 'var(--at)' : 'var(--txm)';
    };
  }

  if (sb && ri) {
    sb.onclick = () => {
      const c = ri.value.trim();
      if (!c) {
        toast('Tulis sesuatu...');
        return;
      }
      submitRant(c, S.mood);
      ri.value = '';
      if (cc) cc.textContent = '0/500';
    };
  }

  setInterval(updQuota, 60000);
});
</script>
</body>
</html>
