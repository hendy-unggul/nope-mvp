<!DOCTYPE html>
<html lang="id" data-theme="brutalgenz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>NOPE ‚Äî Jejak</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%2300F0FF'/%3E%3Ctext x='50' y='70' font-size='50' font-weight='bold' font-family='system-ui' text-anchor='middle' fill='%230A0A0A'%3E‚ú¶%3C/text%3E%3C/svg%3E">
  <meta name="theme-color" content="#0A0A0A">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0A0A0A; --surface: #141414; --surface-elevated: #1E1E1E;
      --border: #2A2A2A; --border-accent: #00F0FF;
      --text: #FFFFFF; --text-secondary: #888888; --text-muted: #555555;
      --accent-primary: #00F0FF; --accent-secondary: #FF4D00;
      --accent-warm: #FFD700; --accent-hug: #FF69B4;
      --space-xs: 4px; --space-sm: 8px; --space-md: 16px; --space-lg: 24px; --space-xl: 32px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', system-ui, sans-serif; font-weight: 500; font-size: 15px; line-height: 1.4; min-height: 100vh; overflow-x: hidden; padding-bottom: 100px; }
    .wrapper { max-width: 480px; margin: 0 auto; padding: 0 var(--space-md); }

    header { padding: var(--space-lg) 0 var(--space-md); border-bottom: 2px solid var(--border); margin-bottom: var(--space-md); display: flex; justify-content: space-between; align-items: center; }
    .header-title { font-size: 32px; font-weight: 800; letter-spacing: -0.04em; color: var(--text); line-height: 0.9; }
    .header-title::before { content: '‚ú¶'; color: var(--accent-primary); margin-right: var(--space-sm); }
    .header-user { font-size: 11px; font-weight: 700; color: var(--accent-primary); letter-spacing: 0.05em; text-transform: uppercase; }

    .page-header { margin: var(--space-lg) 0; padding-bottom: var(--space-md); border-bottom: 2px solid var(--border); }
    .page-subtitle { font-family: 'Instrument Serif', serif; font-size: 16px; font-style: italic; color: var(--text-secondary); margin-bottom: var(--space-xs); }
    .page-tagline { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.15em; color: var(--accent-primary); }

    /* ENTRI RANT */
    .entry-card { background: var(--surface); border: 2px solid var(--border); padding: var(--space-md); margin-bottom: var(--space-md); position: relative; transition: all 0.2s; }
    .entry-card:hover { border-color: var(--border-accent); transform: translateY(-2px); box-shadow: 4px 4px 0 var(--surface-elevated); }
    .entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-sm); padding-bottom: var(--space-sm); border-bottom: 1px solid var(--border); }
    .entry-mood { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; padding: 4px 8px; border: 1px solid currentColor; }
    .entry-time { font-size: 11px; color: var(--text-muted); font-weight: 600; }
    .entry-content { font-size: 15px; line-height: 1.6; color: var(--text); margin-bottom: var(--space-md); font-family: 'Instrument Serif', serif; font-style: italic; }

    /* EMPATHIC REACTIONS - Format Hangat */
    .empathy-section { border-top: 1px solid var(--border); padding-top: var(--space-sm); }
    .empathy-container { display: flex; align-items: center; gap: var(--space-sm); flex-wrap: wrap; }
    
    .empathy-pill { 
      display: inline-flex; 
      align-items: center; 
      gap: var(--space-xs); 
      padding: 8px 16px; 
      background: var(--surface-elevated); 
      border: 2px solid var(--border); 
      font-size: 13px; 
      font-weight: 600; 
      color: var(--text-secondary);
      transition: all 0.2s;
    }
    
    .empathy-pill.warm { 
      background: linear-gradient(135deg, rgba(255,105,180,0.1) 0%, rgba(255,215,0,0.1) 100%);
      border-color: var(--accent-hug);
      color: var(--text);
    }
    
    .empathy-pill.supportive {
      background: linear-gradient(135deg, rgba(0,240,255,0.1) 0%, rgba(57,255,20,0.1) 100%);
      border-color: var(--accent-primary);
      color: var(--text);
    }
    
    .empathy-pill.energetic {
      background: linear-gradient(135deg, rgba(255,77,0,0.1) 0%, rgba(255,215,0,0.1) 100%);
      border-color: var(--accent-secondary);
      color: var(--text);
    }
    
    .empathy-icon { font-size: 18px; }
    .empathy-text { font-family: 'Instrument Serif', serif; font-style: italic; }
    .empathy-count { font-weight: 700; color: var(--accent-primary); }

    /* Multiple reactions summary */
    .empathy-summary { 
      font-size: 12px; 
      color: var(--text-secondary); 
      font-style: italic;
      margin-top: var(--space-xs);
    }

    /* Empty state */
    .empty-empathy { 
      font-size: 12px; 
      color: var(--text-muted); 
      font-style: italic;
      padding: var(--space-sm) 0;
    }

    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 2px solid var(--border); z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
    .nav-container { max-width: 480px; margin: 0 auto; display: flex; justify-content: space-around; align-items: center; height: 64px; }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; height: 100%; color: var(--text-muted); text-decoration: none; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; transition: all 0.2s; position: relative; cursor: pointer; }
    .nav-item.active { color: var(--accent-primary); }
    .nav-icon { font-size: 20px; line-height: 1; }

    .notification { position: fixed; top: var(--space-md); left: 50%; transform: translateX(-50%) translateY(-100px); background: var(--text); color: var(--bg); padding: 12px 24px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; z-index: 10002; opacity: 0; transition: all 0.3s; border: 2px solid var(--bg); box-shadow: 4px 4px 0 var(--accent-primary); pointer-events: none; }
    .notification.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
<base target="_blank">
</head>
<body>
  <div class="wrapper">
    <header>
      <div class="header-title">Jejak</div>
      <span class="header-user" id="header-username">@...</span>
    </header>

    <div class="page-header">
      <p class="page-subtitle">Riwayat curhatan dan respon komunitas</p>
      <div class="page-tagline" id="entries-count">Memuat...</div>
    </div>

    <div id="entries-container">
      <div style="text-align:center;padding:var(--space-xl);color:var(--text-muted);">Memuat jejakmu...</div>
    </div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-container">
      <a href="jejak.html" class="nav-item active"><span class="nav-icon">‚ú¶</span><span>Jejak</span></a>
      <a href="cocomeo.html" class="nav-item"><span class="nav-icon">„Äú</span><span>Cocomeo</span></a>
      <a href="saynope.html" class="nav-item"><span class="nav-icon">‚úï</span><span>Spill</span></a>
      <a href="glitch.html" class="nav-item"><span class="nav-icon">‚ö°</span><span>Glitch</span></a>
    </div>
  </nav>

  <script>
    const SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';

    const SESSION = (() => {
      const username = localStorage.getItem('jejak_username');
      const loggedIn = localStorage.getItem('jejak_logged_in');
      if (!loggedIn || !username) { window.location.href = 'index.html'; return null; }
      return { username };
    })();
    if (!SESSION) throw new Error('No session');

    // Mapping emoji dari tabel reactions ke tipe
    const REACTION_TYPES = {
      'ü§ó': { key: 'hug', label: 'memelukmu', singular: 'memelukmu dari jauh', icon: 'ü§ó', warmth: 'high', class: 'warm' },
      'üò¢': { key: 'sad', label: 'merasakan', singular: 'merasakan bebanmu', icon: 'üíß', warmth: 'high', class: 'warm' },
      'üòî': { key: 'mood', label: 'sedang mood', singular: 'sedang dalam mood yang sama', icon: 'üåô', warmth: 'medium', class: 'supportive' },
      'üëè': { key: 'clap', label: 'mendukungmu', singular: 'mendukung perjuanganmu', icon: '‚ú®', warmth: 'high', class: 'energetic' },
      'üíÄ': { key: 'dead', label: 'terhibur', singular: 'terhibur dengan kejujuranmu', icon: 'üòÇ', warmth: 'medium', class: 'supportive' },
      'üçµ': { key: 'tea', label: 'mengamati', singular: 'sedang menyimak ceritamu', icon: 'üëÅÔ∏è', warmth: 'low', class: 'supportive' }
    };

    // Format empatic messages berdasarkan jumlah dan tipe
    const EMPATHIC_MESSAGES = {
      hug: {
        single: ['seseorang memelukmu erat', 'ada yang memelukmu dari jauh', 'sebuah pelukan hangat untukmu'],
        few: ['{count} orang memelukmu dari jauh', '{count} pelukan hangat untukmu', '{count} jiwa merangkulmu'],
        many: ['{count} pelukan mengelilingimu', '{count} orang ingin memelukmu saat ini', '{count} jiwa berbagi kehangatan']
      },
      sad: {
        single: ['seseorang menangis bersamamu', 'ada yang merasakan bebanmu', 'seseorang berempati denganmu'],
        few: ['{count} orang menangis bersamamu', '{count} jiwa merasakan bebanmu', '{count} hati berbagi kesedihan'],
        many: ['{count} air mata mengalir untukmu', '{count} jiwa berbagi bebanmu', '{count} hati merasakan']
      },
      mood: {
        single: ['seseorang dalam mood yang sama', 'ada yang merasakan vibe yang sama', 'seseorang mengerti'],
        few: ['{count} orang dalam mood yang sama', '{count} jiwa berbagi vibe', '{count} orang mengerti perasaanmu'],
        many: ['{count} jiwa beresonansi', '{count} orang dalam frekuensi yang sama', '{count} vibe saling terhubung']
      },
      clap: {
        single: ['seseorang mendukungmu', 'ada yang bertepuk tangan untukmu', 'seseorang bangga padamu'],
        few: ['{count} orang mendukung perjuanganmu', '{count} tepuk tangan untukmu', '{count} dukungan mengalir'],
        many: ['{count} orang bersorak untukmu', '{count} dukungan mengelilingimu', '{count} jiwa memberi semangat']
      },
      dead: {
        single: ['seseorang terhibur', 'ada yang tersenyum membaca ini', 'seseorang merasa terwakili'],
        few: ['{count} orang terhibur', '{count} senyum tercipta', '{count} jiwa merasa terwakili'],
        many: ['{count} tawa mengalir', '{count} orang merasa terhibur', '{count} jiwa berbagi tawa']
      },
      tea: {
        single: ['seseorang menyimak', 'ada yang sedang membaca', 'seseorang mengamati'],
        few: ['{count} orang menyimak ceritamu', '{count} mata membaca', '{count} jiwa mengamati'],
        many: ['{count} orang menyimak', '{count} pembaca terpikat', '{count} jiwa mengamati']
      }
    };

    let db;

    function initDB() {
      try {
        db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        return true;
      } catch(e) {
        console.error('Supabase init failed:', e);
        return false;
      }
    }

    function getMessageTemplate(type, count) {
      const templates = EMPATHIC_MESSAGES[type];
      if (!templates) return null;
      
      if (count === 1) return templates.single[Math.floor(Math.random() * templates.single.length)];
      if (count < 5) return templates.few[Math.floor(Math.random() * templates.few.length)];
      return templates.many[Math.floor(Math.random() * templates.many.length)];
    }

    async function loadEntries() {
      const container = document.getElementById('entries-container');
      const storageKey = 'jejak_' + SESSION.username.replace(/[^a-z0-9]/g,'_') + '_entries';
      const stored = localStorage.getItem(storageKey);
      
      if (!stored) {
        container.innerHTML = '<div style="text-align:center;padding:var(--space-xl);color:var(--text-muted);">Belum ada jejak. Tulis rant pertamamu!</div>';
        document.getElementById('entries-count').textContent = '0 entri';
        return;
      }

      const entries = JSON.parse(stored);
      document.getElementById('entries-count').textContent = `${entries.length} entri`;

      // Get reactions for all user's rants
      let reactionsData = [];
      if (db) {
        try {
          // Get all rant IDs from entries
          const rantIds = entries.map(e => e.id).filter(id => id);
          if (rantIds.length > 0) {
            const { data, error } = await db
              .from('reactions')
              .select('rant_id, emoji')
              .in('rant_id', rantIds);
            
            if (!error) reactionsData = data || [];
          }
        } catch(e) {
          console.error('Failed to load reactions:', e);
        }
      }

      // Group reactions by rant_id
      const reactionsByRant = {};
      reactionsData.forEach(r => {
        if (!reactionsByRant[r.rant_id]) reactionsByRant[r.rant_id] = {};
        reactionsByRant[r.rant_id][r.emoji] = (reactionsByRant[r.rant_id][r.emoji] || 0) + 1;
      });

      container.innerHTML = '';
      
      entries.forEach((entry, idx) => {
        const el = document.createElement('div');
        el.className = 'entry-card';
        el.style.animationDelay = `${idx * 0.1}s`;
        
        const timeAgo = fmtTime(entry.timestamp || entry.created_at);
        const reactions = reactionsByRant[entry.id] || {};
        
        // Build empathy section
        const empathyHtml = buildEmpathySection(reactions);
        
        el.innerHTML = `
          <div class="entry-header">
            <span class="entry-mood" style="color: var(--accent-primary); border-color: var(--accent-primary);">${entry.mood || 'üí≠'}</span>
            <span class="entry-time">${timeAgo}</span>
          </div>
          <div class="entry-content">${escHtml(entry.content || '')}</div>
          <div class="empathy-section">
            ${empathyHtml}
          </div>
        `;
        
        container.appendChild(el);
      });
    }

    function buildEmpathySection(reactions) {
      if (!reactions || Object.keys(reactions).length === 0) {
        return '<div class="empty-empathy">Belum ada respon ‚Äî curhatanmu sedang menunggu yang selaras ‚ú®</div>';
      }

      // Convert reactions to array and sort by count
      const reactionArray = Object.entries(reactions)
        .map(([emoji, count]) => ({
          ...REACTION_TYPES[emoji],
          emoji,
          count,
          totalScore: count * (REACTION_TYPES[emoji]?.warmth === 'high' ? 2 : 1)
        }))
        .sort((a, b) => b.totalScore - a.totalScore);

      const dominant = reactionArray[0];
      const totalReactions = reactionArray.reduce((sum, r) => sum + r.count, 0);
      
      // Build primary empathy message
      const message = getMessageTemplate(dominant.key, dominant.count)
        ?.replace('{count}', dominant.count);

      let html = `
        <div class="empathy-container">
          <div class="empathy-pill ${dominant.class}">
            <span class="empathy-icon">${dominant.icon}</span>
            <span class="empathy-text">${message}</span>
          </div>
        </div>
      `;

      // Add secondary reactions if any
      if (reactionArray.length > 1) {
        const others = reactionArray.slice(1);
        const otherTexts = others.map(r => {
          const msg = getMessageTemplate(r.key, r.count)?.replace('{count}', r.count);
          return msg;
        }).filter(Boolean);
        
        if (otherTexts.length > 0) {
          html += `<div class="empathy-summary">Juga: ${otherTexts.join(' ‚Ä¢ ')}</div>`;
        }
      }

      return html;
    }

    function fmtTime(iso) {
      if (!iso) return '';
      const diff = Date.now() - new Date(iso).getTime();
      const m = Math.floor(diff/60000), h = Math.floor(diff/3600000), d = Math.floor(diff/86400000);
      if (m < 1) return 'Baru saja';
      if (m < 60) return m + ' menit lalu';
      if (h < 24) return h + ' jam lalu';
      if (d < 7) return d + ' hari lalu';
      return new Date(iso).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
    }

    function escHtml(t) {
      return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('header-username').textContent = '@' + SESSION.username;
      initDB();
      loadEntries();
    });
  </script>
</body>
</html>
