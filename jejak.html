<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>JEJAK ‚Äî Spill Your Truth</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0A0A0A;--sf:#141414;--sfe:#1E1E1E;--bd:#2A2A2A;--tx:#FFF;--txs:#888;--txm:#555;--ap:#FF4D00;--as:#00F0FF;--at:#FF006E;--aq:#39FF14;--aw:#FFD700;--ms:#FF9500;--mt:#39FF14;--mc:#00F0FF;--md:#8B5CF6;--rd:#FF3333;--rd-dark:#990000}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--tx);font-family:'Plus Jakarta Sans',system-ui,sans-serif;font-weight:500;font-size:15px;line-height:1.4;min-height:100vh;overflow-x:hidden;padding-bottom:100px}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:.4}
.w{max-width:480px;margin:0 auto;padding:0 16px}
header{padding:24px 0 16px;display:flex;justify-content:space-between;align-items:flex-start}
.logo{font-size:42px;font-weight:800;letter-spacing:-.04em;cursor:pointer;line-height:.9;position:relative}
.logo::before,.logo::after{content:'JEJAK';position:absolute;top:0;left:0;opacity:0;transition:opacity .1s}
.logo::before{color:var(--as);transform:translate(-2px,0)}
.logo::after{color:var(--at);transform:translate(2px,0)}
.logo:hover::before{opacity:.8;animation:g .3s infinite}
@keyframes g{0%,100%{transform:translate(-2px,0)}25%{transform:translate(2px,2px)}50%{transform:translate(-2px,-2px)}75%{transform:translate(2px,0)}}
.tagline{font-family:'Instrument Serif',serif;font-size:13px;color:var(--txs);font-style:italic;margin-top:4px}
.top-right{display:flex;align-items:center;gap:8px}
.huser{font-size:11px;font-weight:700;color:var(--tx);text-transform:lowercase;letter-spacing:.05em;padding:4px 8px;background:var(--sf);border:1px solid var(--bd);max-width:110px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dot{width:8px;height:8px;background:var(--aq);border-radius:50%;animation:blink 2s infinite;flex-shrink:0}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.dot.off{background:var(--at);animation:none}
.smenu{position:relative}
.mtrig{width:32px;height:32px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;background:transparent;border:none;cursor:pointer;padding:0}
.mtrig span{width:4px;height:4px;background:var(--tx);border-radius:50%;transition:all .2s}
.mtrig:hover span{background:var(--ap)}
.mdd{position:absolute;top:100%;right:0;margin-top:8px;background:var(--sf);border:2px solid var(--bd);min-width:120px;display:none;z-index:100}
.mdd.on{display:block}
.mi{width:100%;padding:8px 16px;background:transparent;border:none;color:var(--tx);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;text-align:left;cursor:pointer;transition:all .2s}
.mi:hover{background:var(--sfe);color:var(--ap)}
.bnav{position:fixed;bottom:0;left:0;right:0;background:var(--sf);border-top:2px solid var(--bd);z-index:1000;padding-bottom:env(safe-area-inset-bottom)}
.bnav-c{max-width:480px;margin:0 auto;display:flex;justify-content:space-around;align-items:center;height:64px}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;height:100%;color:var(--txm);text-decoration:none;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;transition:all .2s;position:relative;cursor:pointer}
.ni::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:0;height:2px;background:var(--ap);transition:width .2s}
.ni:hover{color:var(--txs);background:var(--sfe)}
.ni.act{color:var(--ap)}
.ni.act::before{width:100%}
.nico{font-size:20px;line-height:1}
.hero-s{position:relative;margin:0 -16px 24px}
.hero{position:relative;width:100%;aspect-ratio:1/1;overflow:hidden;border-top:2px solid var(--bd);border-bottom:2px solid var(--bd);background:var(--sf)}
.hero img{width:100%;height:100%;object-fit:cover;transition:transform .6s,filter .3s}
.hero:hover img{transform:scale(1.03)}
.hero::after{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.03) 2px,rgba(0,0,0,.03) 4px);pointer-events:none}
.hnote{position:absolute;bottom:0;left:0;right:0;padding:16px;background:linear-gradient(to top,rgba(0,0,0,.9),transparent);font-family:'Instrument Serif',serif;font-size:24px;font-style:italic;color:var(--tx);line-height:1.2;z-index:20}
.upctrls{position:absolute;top:16px;right:16px;display:flex;flex-direction:column;gap:8px;align-items:flex-end;z-index:20}
.upbtn{width:48px;height:48px;background:var(--ap);border:none;color:var(--bg);font-size:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;box-shadow:4px 4px 0 var(--bg),4px 4px 0 2px var(--ap);position:relative}
.upbtn:hover:not(:disabled){transform:translate(2px,2px);box-shadow:2px 2px 0 var(--bg),2px 2px 0 2px var(--ap)}
.upbtn:disabled{background:var(--txm);box-shadow:none;cursor:not-allowed;opacity:.6}
.upcnt{position:absolute;top:-8px;right:-8px;background:var(--at);color:var(--tx);font-size:10px;font-weight:700;padding:2px 6px;min-width:20px;text-align:center}
.qtimer{position:absolute;top:calc(100% + 8px);right:0;background:var(--sf);border:2px solid var(--bd);padding:8px 16px;font-size:11px;color:var(--txs);white-space:nowrap;opacity:0;visibility:hidden;transition:all .2s;z-index:30}
.qtimer::before{content:'';position:absolute;bottom:100%;right:16px;border:6px solid transparent;border-bottom-color:var(--bd)}
.upctrls:hover .qtimer{opacity:1;visibility:visible}
.qtimer.urg{border-color:var(--at);color:var(--at);animation:pb 2s infinite}
@keyframes pb{0%,100%{border-color:var(--at)}50%{border-color:var(--txm)}}
.isec{margin-bottom:32px}
.ihdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.ilbl{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--txs)}
.ccount{font-size:12px;color:var(--txm);font-variant-numeric:tabular-nums}
.ri{width:100%;background:var(--sf);border:2px solid var(--bd);padding:16px;color:var(--tx);font-family:'Plus Jakarta Sans',sans-serif;font-size:16px;line-height:1.5;resize:none;min-height:120px;transition:all .2s}
.ri:focus{outline:none;border-color:var(--ap);background:var(--sfe)}
.ri::placeholder{color:var(--txm)}
.msec{margin:16px 0}
.mlbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--txs);margin-bottom:8px}
.mgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.mc{position:relative;padding:16px;background:var(--sf);border:2px solid var(--bd);cursor:pointer;transition:all .2s;display:flex;flex-direction:column;gap:4px}
.mc:hover{border-color:var(--txs);transform:translateY(-2px)}
.mc.act{border-color:currentColor;background:var(--sfe)}
.mc.act::before{content:'‚úì';position:absolute;top:8px;right:8px;font-size:12px;font-weight:700}
.me{font-size:28px;line-height:1}
.mn{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:.05em}
.md-desc{font-size:11px;color:var(--txs)}
.mc[data-mood="surviving"]{color:var(--ms)}
.mc[data-mood="thriving"]{color:var(--mt)}
.mc[data-mood="chaotic"]{color:var(--mc)}
.mc[data-mood="doom"]{color:var(--md)}
.iact{display:flex;justify-content:flex-end;margin-top:16px}
.sbtn{padding:14px 32px;font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;background:var(--ap);border:none;color:var(--bg);cursor:pointer;transition:all .2s;box-shadow:4px 4px 0 var(--sfe),4px 4px 0 2px var(--ap)}
.sbtn:hover:not(:disabled){transform:translate(2px,2px);box-shadow:2px 2px 0 var(--sfe),2px 2px 0 2px var(--ap)}
.sbtn:disabled{opacity:.5;cursor:not-allowed;box-shadow:none}
.shdr{display:flex;align-items:center;gap:8px;margin-bottom:16px;padding-bottom:8px;border-bottom:2px solid var(--bd)}
.stit{font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:.15em;color:var(--tx)}
.sline{flex:1;height:2px;background:var(--bd)}
.entry{background:var(--sf);border:2px solid var(--bd);margin-bottom:16px;position:relative;animation:si .4s ease}
@keyframes si{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.entry:hover{border-color:var(--ap)}
.ehdr{display:flex;justify-content:space-between;align-items:center;padding:8px 16px;border-bottom:1px solid var(--bd);background:var(--sfe)}
.emeta{display:flex;align-items:center;gap:8px}
.etime{font-size:11px;color:var(--txm);font-weight:600;letter-spacing:.05em}
.emood{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;padding:4px 8px;border:1px solid currentColor}
.emood.surviving{color:var(--ms)}
.emood.thriving{color:var(--mt)}
.emood.chaotic{color:var(--mc)}
.emood.doom{color:var(--md)}
.econt{padding:16px;font-size:15px;line-height:1.6;color:var(--tx)}
.tgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:2px;background:var(--bd);border:2px solid var(--bd);margin-bottom:16px}
.ti{aspect-ratio:1;background:var(--sf);position:relative;overflow:hidden;cursor:pointer}
.ti.empty{display:flex;align-items:center;justify-content:center;color:var(--txm);font-size:20px;cursor:pointer;border:2px dashed var(--bd)}
.ti img{width:100%;height:100%;object-fit:cover;transition:all .3s}
.ti:hover img{transform:scale(1.1)}
.ti::after{content:'';position:absolute;inset:0;background:var(--ap);opacity:0;transition:opacity .2s;mix-blend-mode:multiply}
.ti:hover::after{opacity:.3}
.entry-dummy{opacity:.6;border-style:dashed!important}
.entry-dummy:hover{border-color:var(--bd)!important;opacity:.75}
.reaction-bar{display:flex;gap:6px;padding:10px 16px;border-top:1px solid var(--bd);background:var(--sfe);align-items:center;flex-wrap:wrap}
.reaction-btn{position:relative;display:flex;align-items:center;gap:4px;padding:5px 10px;background:var(--sf);border:2px solid var(--bd);cursor:not-allowed;transition:all .15s;border-radius:4px;font-family:inherit;opacity:.5}
.remoji{font-size:17px;line-height:1}
.rcount{font-size:11px;font-weight:700;color:var(--txs);min-width:14px;text-align:center;font-variant-numeric:tabular-nums}
.fifo-i{font-size:9px;color:var(--txm);text-transform:uppercase;letter-spacing:.05em;padding:2px 6px;border:1px solid var(--bd)}
.es{padding:32px 16px;text-align:center;border:2px dashed var(--bd)}
.ee{font-size:48px;margin-bottom:16px;display:block;animation:fl2 3s ease-in-out infinite}
@keyframes fl2{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.et{font-family:'Instrument Serif',serif;font-size:20px;font-style:italic;color:var(--txs);margin-bottom:8px}
.est{font-size:13px;color:var(--txm)}
footer{padding:32px 0;text-align:center;border-top:2px solid var(--bd);margin-bottom:80px}
.ftxt{font-size:11px;color:var(--txm);text-transform:uppercase;letter-spacing:.2em}
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--tx);color:var(--bg);padding:10px 20px;font-size:13px;font-weight:700;z-index:10000;opacity:0;transition:all .3s;max-width:320px;text-align:center}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.err{background:var(--rd);color:#fff}
.proc{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:10002;display:none;flex-direction:column;align-items:center;justify-content:center;gap:16px}
.proc.on{display:flex}
.pspin{width:48px;height:48px;border:3px solid var(--bd);border-top-color:var(--ap);border-radius:50%;animation:sp 1s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.ptxt{font-size:14px;color:var(--txs);text-align:center}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:10001;padding:16px;overflow-y:auto}
.modal.on{display:block}
.mc2{max-width:480px;margin:0 auto;background:var(--sf);border:2px solid var(--bd);padding:24px}
.mhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:16px;border-bottom:2px solid var(--bd)}
.mtit{font-size:18px;font-weight:800;text-transform:uppercase;letter-spacing:.05em}
.mcls{background:none;border:none;color:var(--tx);font-size:24px;cursor:pointer}
.ggrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.gi{aspect-ratio:1;background:var(--sfe);border:2px solid var(--bd);cursor:pointer;overflow:hidden;position:relative}
.gi img{width:100%;height:100%;object-fit:cover;transition:all .2s}
.gi:hover img{transform:scale(1.05)}
.gi.sel{border-color:var(--ap);box-shadow:0 0 0 2px var(--ap)}
.gi.sel::after{content:'‚úì';position:absolute;top:4px;right:4px;background:var(--ap);color:var(--bg);width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700}
.tmsec{margin:16px 0;padding:16px;background:var(--sfe);border:2px solid var(--bd)}
.tmhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.tmlbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--txs)}
.tmnm{font-size:11px;font-weight:700;color:var(--ap)}
.tmsl{width:100%;height:4px;background:var(--bd);outline:none;-webkit-appearance:none;margin:8px 0}
.tmsl::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;background:var(--ap);cursor:pointer;border:2px solid var(--tx);box-shadow:2px 2px 0 var(--bg)}
.tmlabs{display:flex;justify-content:space-between;font-size:9px;color:var(--txm);font-weight:600;text-transform:uppercase}
.notsec{margin:16px 0;padding:16px;background:var(--sfe);border:2px solid var(--bd)}
.notlbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--txs);margin-bottom:8px;display:flex;justify-content:space-between}
.notcnt{font-size:10px;color:var(--txm)}
.noti{width:100%;background:var(--sf);border:2px solid var(--bd);padding:8px;color:var(--tx);font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;transition:all .2s}
.noti:focus{outline:none;border-color:var(--ap);background:var(--sfe)}
.noti::placeholder{color:var(--txm);font-size:12px}
.gwarn{background:var(--at);color:var(--tx);padding:16px;margin-bottom:16px;font-size:13px;font-weight:700;text-align:center;text-transform:uppercase;letter-spacing:.05em;border:2px solid var(--at)}
.gwarn::before{content:'üö´ '}
.macts{margin-top:16px;display:flex;justify-content:flex-end;gap:8px}
.mbtn{padding:12px 24px;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;border:2px solid var(--bd);background:var(--sf);color:var(--tx);cursor:pointer;transition:all .2s}
.mbtn.pri{background:var(--ap);border-color:var(--ap);color:var(--bg)}
.mbtn:hover{transform:translateY(-2px)}
.fm{filter:grayscale(100%) contrast(1.1)!important}
.fsp{filter:sepia(100%) contrast(1.1) saturate(.8)!important}
.fl{filter:contrast(1.2) saturate(1.3) brightness(.9)!important}
.fv{filter:grayscale(100%) contrast(1.2) brightness(.9)!important}
.fn{filter:grayscale(100%) contrast(1.4) brightness(.8)!important}
.fc{filter:hue-rotate(180deg) saturate(1.5) contrast(1.1)!important}
.fw{filter:sepia(60%) hue-rotate(-30deg) saturate(1.2)!important}
.fco{filter:hue-rotate(180deg) saturate(.5) brightness(1.1)!important}
.fd{filter:blur(.5px) saturate(1.4) brightness(1.1) contrast(.9)!important}
.fcr{filter:contrast(1.3) saturate(1.1)!important}
.fmo{filter:brightness(.8) contrast(1.2) saturate(.7)!important}
.fg{filter:sepia(40%) hue-rotate(-15deg) saturate(1.3) contrast(1.1)!important}
.sensored-overlay{position:absolute;inset:0;background:#000;display:flex;align-items:center;justify-content:center;color:#FF0000;font-size:14px;font-weight:800;text-transform:uppercase;letter-spacing:2px;border:2px solid #FF0000;z-index:25}
.sensored-text{transform:rotate(-5deg);border:2px solid #FF0000;padding:4px 8px;background:rgba(0,0,0,0.8)}
.conn-mini{margin-top:24px}
.conn-card-compact{background:var(--sf);border:2px solid var(--bd);margin-bottom:8px;transition:all .2s;display:flex;align-items:center;padding:12px 16px;gap:12px}
.conn-card-compact:hover{border-color:var(--ap)}
.conn-card-compact.chaotic{border-left:4px solid var(--mc)}
.conn-card-compact.caregiver{border-left:4px solid var(--mt)}
.conn-card-compact.red-alert{border-left:4px solid var(--rd);border-color:var(--rd);background:linear-gradient(145deg,var(--sf),#330000)}
.conn-avatar-mini{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;background:var(--sfe);border:1px solid var(--bd);flex-shrink:0}
.conn-card-compact.chaotic .conn-avatar-mini{border-color:var(--mc)}
.conn-card-compact.caregiver .conn-avatar-mini{border-color:var(--mt)}
.conn-card-compact.red-alert .conn-avatar-mini{border-color:var(--rd);animation:pulse-red 2s infinite}
@keyframes pulse-red{0%,100%{box-shadow:0 0 5px var(--rd)}50%{box-shadow:0 0 20px var(--rd)}}
.conn-info{flex:1;min-width:0}
.conn-title-mini{font-size:12px;font-weight:600;line-height:1.4;color:var(--tx);margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.conn-meta{font-size:10px;color:var(--txs);display:flex;align-items:center;gap:6px}
.conn-meta::before{content:'';width:6px;height:6px;background:var(--aq);border-radius:50%;display:inline-block;animation:blink 2s infinite}
.conn-card-compact.chaotic .conn-meta::before{background:var(--mc)}
.conn-card-compact.caregiver .conn-meta::before{background:var(--mt)}
.conn-card-compact.red-alert .conn-meta::before{background:var(--rd)}
.conn-actions-mini{display:flex;gap:6px;flex-shrink:0}
.conn-btn-mini{padding:6px 12px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;border:1px solid var(--bd);background:var(--sf);color:var(--tx);cursor:pointer;transition:all .2s}
.conn-btn-mini:hover{border-color:var(--txs);background:var(--sfe)}
.conn-btn-mini.pri{background:var(--tx);border-color:var(--tx);color:var(--bg)}
.conn-btn-mini.pri:hover{background:var(--ap);border-color:var(--ap)}
.conn-btn-mini:disabled{opacity:.5;cursor:not-allowed}
/* Debug panel */
.dbg{position:fixed;top:8px;left:50%;transform:translateX(-50%);background:#111;border:1px solid var(--ap);padding:6px 12px;font-size:10px;font-family:monospace;color:var(--aw);z-index:99999;max-width:90vw;text-align:center;display:none}
.dbg.on{display:block}
</style>
</head>
<body>
<div class="dbg" id="dbg"></div>
<div class="w">
<header>
  <div>
    <div class="logo" onclick="location.reload()">JEJAK</div>
    <div class="tagline">no filter, just truth</div>
  </div>
  <div class="top-right">
    <div class="huser" id="huser">@anon</div>
    <div class="dot off" id="odot" title="Offline"></div>
    <div class="smenu">
      <button class="mtrig" onclick="toggleMenu()"><span></span><span></span><span></span></button>
      <div class="mdd" id="mdd">
        <button class="mi" onclick="toggleDebug()">Debug Info</button>
        <button class="mi" onclick="logoutUser()">Logout</button>
      </div>
    </div>
  </div>
</header>

<section class="hero-s">
  <div class="hero" id="hero">
    <img id="himg" src="https://images.unsplash.com/photo-1517842645767-c639042777db?w=400&q=80" alt="artefak" class="fm">
    <div class="hnote" id="hnote">"jeda"</div>
    <div class="upctrls">
      <div class="qtimer" id="qtimer">Window aktif</div>
      <button class="upbtn" id="upbtn">+<span class="upcnt" id="ucnt" style="display:none"></span></button>
    </div>
  </div>
</section>

<section class="isec">
  <div class="ihdr"><span class="ilbl">Spill your truth</span><span class="ccount" id="ccount">0/500</span></div>
  <textarea class="ri" id="ri" placeholder="What's eating you alive right now? No cap, no filter..." maxlength="500"></textarea>
  <div class="msec">
    <div class="mlbl">Pilih mood-mu sekarang</div>
    <div class="mgrid">
      <div class="mc act" data-mood="surviving" onclick="selMood('surviving')"><span class="me">üòÆ‚Äçüí®</span><span class="mn" style="color:var(--ms)">Surviving</span><span class="md-desc">Hidup tapi barely</span></div>
      <div class="mc" data-mood="thriving" onclick="selMood('thriving')"><span class="me">‚ú®</span><span class="mn" style="color:var(--mt)">Thriving</span><span class="md-desc">On top of my game</span></div>
      <div class="mc" data-mood="chaotic" onclick="selMood('chaotic')"><span class="me">üåÄ</span><span class="mn" style="color:var(--mc)">Chaotic</span><span class="md-desc">Everything is on fire</span></div>
      <div class="mc" data-mood="doom" onclick="selMood('doom')"><span class="me">üõå</span><span class="mn" style="color:var(--md)">Doom</span><span class="md-desc">Just wanna disappear</span></div>
    </div>
  </div>
  <div class="iact"><button class="sbtn" id="sbtn">Jejakkan & Spill</button></div>
</section>

<section>
  <div class="shdr">
    <span class="stit">Riwayat</span>
    <div class="sline"></div>
    <span style="font-size:10px;color:var(--txm);margin-left:auto">FIFO ‚Ä¢ MAX 6</span>
  </div>
  <div id="econ"></div>
</section>

<section style="margin-bottom:32px">
  <div class="shdr">
    <span class="stit">Memori</span>
    <div class="sline"></div>
    <span style="font-size:10px;color:var(--txm);margin-left:auto">FIFO ‚Ä¢ MAX 6</span>
  </div>
  <div class="tgrid" id="tgrid"></div>
  <div class="conn-mini">
    <div class="conn-card-compact chaotic" id="card-chaotic">
      <div class="conn-avatar-mini">üåÄ</div>
      <div class="conn-info">
        <div class="conn-title-mini">Seseorang dengan pola "chaotic good" sering muncul di timeline kamu.</div>
        <div class="conn-meta">aktif jam aneh ‚Ä¢ react üò≠ jarang post</div>
      </div>
      <div class="conn-actions-mini">
        <button class="conn-btn-mini" onclick="skipConn('chaotic')">Abaikan</button>
        <button class="conn-btn-mini pri" onclick="signalConn('chaotic')">Senggol</button>
      </div>
    </div>
    <div class="conn-card-compact caregiver" id="card-caregiver">
      <div class="conn-avatar-mini">ü´Ç</div>
      <div class="conn-info">
        <div class="conn-title-mini">Ada yang sering kasih hug ke curhatanmu, tapi jarang cerita balik.</div>
        <div class="conn-meta">caregiver ‚Ä¢ burnout tapi diam</div>
      </div>
      <div class="conn-actions-mini">
        <button class="conn-btn-mini" onclick="skipConn('caregiver')">Abaikan</button>
        <button class="conn-btn-mini pri" onclick="signalConn('caregiver')">Senggol</button>
      </div>
    </div>
    <div class="conn-card-compact red-alert" id="card-redalert">
      <div class="conn-avatar-mini">‚ö†Ô∏è</div>
      <div class="conn-info">
        <div class="conn-title-mini">Seseorang mengirimkan pesan dengan nuansa merah dan intensitas tinggi.</div>
        <div class="conn-meta">urgent ‚Ä¢ butuh respon cepat</div>
      </div>
      <div class="conn-actions-mini">
        <button class="conn-btn-mini" onclick="skipConn('redalert')">Abaikan</button>
        <button class="conn-btn-mini pri" onclick="signalConn('redalert')">Senggol</button>
      </div>
    </div>
  </div>
</section>

<footer><p class="ftxt">Nyambat ‚Ä¢ Aksi ‚Ä¢ Solusi</p></footer>
</div>

<nav class="bnav">
  <div class="bnav-c">
    <a href="jejak.html" class="ni act"><span class="nico">‚ú¶</span><span>Jejak</span></a>
    <a href="spill.html" class="ni"><span class="nico">‚úï</span><span>Spill</span></a>
    <a href="cocomeo.html" class="ni"><span class="nico">„Äú</span><span>Cocomeo</span></a>
    <a href="glitch.html" class="ni"><span class="nico">‚ö°</span><span>Glitch</span></a>
  </div>
</nav>

<div class="proc" id="proc">
  <div class="pspin"></div>
  <div class="ptxt" id="proctxt">Memproses...</div>
</div>

<div class="modal" id="gmodal">
  <div class="mc2">
    <div class="mhdr"><h3 class="mtit">Review Artefak</h3><button class="mcls" onclick="closeGallery()">√ó</button></div>
    <div class="gwarn">DILARANG UPLOAD FOTO WAJAH!</div>
    <div style="font-size:11px;color:var(--txs);margin-bottom:16px;text-align:center">Sistem FIFO (6 foto max) ‚Ä¢ Tidak dapat dihapus</div>
    <div class="ggrid" id="ggrid"></div>
    <div class="tmsec">
      <div class="tmhdr"><span class="tmlbl">üé® Tema Foto</span><span class="tmnm" id="tmnm">MONOCHROME</span></div>
      <input type="range" class="tmsl" id="tmsl" min="0" max="11" value="0" step="1" oninput="updTheme(this.value)">
      <div class="tmlabs"><span>B&W</span><span>Warm</span><span>Cool</span><span>Art</span></div>
    </div>
    <div class="notsec">
      <div class="notlbl"><span>üìù Notasi (Max 4 kata)</span><span class="notcnt" id="notcnt">0/4</span></div>
      <input type="text" class="noti" id="noti" placeholder="Contoh: senja di kamar" maxlength="30" oninput="valNote(this)">
    </div>
    <div class="macts">
      <button class="mbtn" onclick="closeGallery()">Batal</button>
      <button class="mbtn pri" id="konfirmbtn" onclick="confirmUpload()">Konfirmasi (<span id="selcnt">0</span>)</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="finput" accept="image/*" multiple style="display:none">

<script>
// ============================================================
// SUPABASE CONFIG
// ============================================================
const SUPA_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';
const BUCKET  = 'artefacts';

// Inisialisasi Supabase dengan supabase-js v2 (sudah di-load via CDN)
const db = supabase.createClient(SUPA_URL, SUPA_KEY);

// ============================================================
// AUTH STATE ‚Äî username dari localStorage, userId SELALU diverifikasi dari DB
// ============================================================
const S = {
  user      : (()=>{ for(const k of ['jejak_username','username','user_handle']){const v=localStorage.getItem(k);if(v&&v!=='null'&&v!=='@anon')return v.startsWith('@')?v:'@'+v;} return '@anon'; })(),
  userId    : null,   // akan diisi setelah verifikasi DB
  _cachedUid: (()=>{ for(const k of ['user_id','jejak_user_id','userId','uid']){const v=localStorage.getItem(k);if(v&&v!=='null')return v;} return null; })(),
  entries   : [],
  artefacts : []
};

console.log('[JEJAK] user=', S.user, '| cached uid=', S._cachedUid);

/**
 * WAJIB dipanggil sebelum insert apapun.
 * Query public.users WHERE username = S.user
 * Jika user_id dari DB cocok dengan cached ‚Üí pakai
 * Jika tidak cocok ‚Üí update localStorage dengan yang benar dari DB
 * Jika tidak ada internet ‚Üí pakai cached (akan gagal 409, tapi itu masalah koneksi)
 */
async function resolveAndVerifyUserId() {
  const uname = S.user.replace('@','').trim();
  if (!uname || uname === 'anon') return null;

  try {
    const { data, error } = await db
      .from('users')
      .select('id, username')
      .eq('username', uname)
      .single();

    if (error || !data) {
      console.warn('[JEJAK] users lookup failed:', error?.message);
      // Fallback ke cached jika ada
      return S._cachedUid || null;
    }

    const dbUid = data.id;
    if (dbUid !== S._cachedUid) {
      console.warn('[JEJAK] userId mismatch! cached:', S._cachedUid, '‚Üí correct:', dbUid);
      // Update semua key yang mungkin tersimpan
      localStorage.setItem('user_id', dbUid);
      localStorage.setItem('jejak_user_id', dbUid);
    }
    S.userId = dbUid;
    console.log('[JEJAK] userId verified from DB:', dbUid);
    return dbUid;

  } catch(e) {
    console.error('[JEJAK] resolveAndVerifyUserId error:', e);
    return S._cachedUid || null;
  }
}

// ============================================================
// DUMMY DATA  
// ============================================================
const DUMMY_E = [
  {id:'d1',content:'Hari ini gue nangis di angkot gegara liat kucing dipukul orang.',mood:'surviving',reactions:{skull:42,cry:89,fire:12,upside:7},isDummy:true},
  {id:'d2',content:'akhirnya bisa tidur nyenyak semalaman setelah 3 minggu insomnia.',mood:'thriving',reactions:{skull:23,cry:15,fire:67,upside:31},isDummy:true},
  {id:'d3',content:'hari ini chaos abis! dari bangun tidur udah salah ambil kaki.',mood:'chaotic',reactions:{skull:89,cry:23,fire:45,upside:78},isDummy:true}
];
const DUMMY_A = [
  {id:'a1',url:'https://images.unsplash.com/photo-1517842645767-c639042777db?w=400&q=80',note:'jeda',hasFace:false,isDummy:true,theme:'fm'},
  {id:'a2',url:'https://images.unsplash.com/photo-1499209974431-9dddcece7f88?w=400&q=80',note:'hijau',hasFace:false,isDummy:true,theme:'fg'},
  {id:'a3',url:'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=400&q=80',note:'gabut',hasFace:false,isDummy:true,theme:'fl'},
  {id:'a4',url:'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&q=80',note:'sendiri',hasFace:false,isDummy:true,theme:'fv'},
  {id:'a5',url:'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&q=80',note:'capek',hasFace:true,isDummy:true,theme:'fn'},
  {id:'a6',url:'https://images.unsplash.com/photo-1516035069371-29a1b244cc32?w=400&q=80',note:'love',hasFace:false,isDummy:true,theme:'fc'}
];

// ============================================================
// HELPERS
// ============================================================
const $  = id => document.getElementById(id);
function toast(msg,isErr=false){
  const t=$('toast');
  t.textContent=msg;
  t.className='toast'+(isErr?' err':'');
  t.classList.add('show');
  clearTimeout(t._t);
  t._t=setTimeout(()=>t.classList.remove('show'),3500);
}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function toggleMenu(){$('mdd').classList.toggle('on');}
function logoutUser(){if(!confirm('Yakin logout?'))return;localStorage.clear();location.href='index.html';}
function selMood(m){document.querySelectorAll('.mc').forEach(c=>c.classList.toggle('act',c.dataset.mood===m));}
function showProc(m='Memproses...'){$('proctxt').innerHTML=m;$('proc').classList.add('on');}
function hideProc(){$('proc').classList.remove('on');}
function skipConn(t){const c=$('card-'+t);if(c){c.style.opacity='.3';c.style.transform='translateX(-10px)';setTimeout(()=>c.style.display='none',200);}}
function signalConn(t){const c=$('card-'+t);if(c){const b=c.querySelector('.conn-btn-mini.pri');if(b){b.textContent='‚úì';b.disabled=true;b.style.background='var(--aq)';}toast('Isyarat terkirim!');setTimeout(()=>c.style.opacity='.5',1500);}}
function toggleDebug(){const d=$('dbg');d.classList.toggle('on');if(d.classList.contains('on'))d.innerHTML=`<b>user:</b> ${S.user}<br><b>userId (aktif):</b> ${S.userId||'NONE'}<br><b>cached uid:</b> ${S._cachedUid||'NONE'}<br><b>ls keys:</b> ${Object.keys(localStorage).join(', ')}`;}

// ============================================================
// KOLOM YANG ADA DI TIAP TABEL (dari screenshot):
//
// public.rants     : id, user_id, content, mood, is_anonymous, created_at
// public.artefacts : id, user_id, username, url
//                    (mungkin ada: note, has_face, faces, theme, created_at)
//
// Kita insert HANYA kolom yang pasti ada.
// Kolom opsional kita wrap dalam try supaya tidak error.
// ============================================================

// ============================================================
// LOAD DATA
// ============================================================
async function loadRants(){
  try{
    const {data,error}=await db.from('rants').select('id,content,mood,is_anonymous,created_at').order('created_at',{ascending:false}).limit(6);
    if(error){console.error('loadRants:',error);S.entries=[...DUMMY_E];}
    else if(data&&data.length){
      S.entries=data.map(r=>({
        id:r.id, content:r.content, mood:r.mood||'surviving',
        timestamp:new Date(r.created_at).getTime(),
        reactions:{skull:0,cry:0,fire:0,upside:0}, isDummy:false
      }));
    } else S.entries=[...DUMMY_E];
  }catch(e){console.error('loadRants exc:',e);S.entries=[...DUMMY_E];}
  renderEntries();
}

async function loadArtefacts(){
  if(!S.userId){S.artefacts=[...DUMMY_A];renderTray();return;}
  try{
    // Select minimal kolom yang pasti ada
    const {data,error}=await db.from('artefacts').select('id,user_id,url').eq('user_id',S.userId).limit(6);
    if(error){console.error('loadArt:',error);S.artefacts=[...DUMMY_A];}
    else if(data&&data.length){
      S.artefacts=data.map(a=>({
        id:a.id, url:a.url,
        note:a.note||'memory',         // mungkin ada, mungkin tidak
        hasFace:a.has_face||false,
        theme:a.theme||'fm',
        isDummy:false
      }));
    } else S.artefacts=[...DUMMY_A];
  }catch(e){console.error('loadArt exc:',e);S.artefacts=[...DUMMY_A];}
  renderTray();
  if(S.artefacts.length>0)setHero(S.artefacts[0].id);
}

// ============================================================
// RENDER
// ============================================================
const MOOD_EMOJI={surviving:'üòÆ‚Äçüí®',thriving:'‚ú®',chaotic:'üåÄ',doom:'üõå'};

function renderEntries(){
  const con=$('econ');if(!con)return;
  if(!S.entries.length){con.innerHTML='<div class="es"><span class="ee">üçÉ</span><div class="et">Belum ada jejak</div><div class="est">Jadilah yang pertama spill your truth</div></div>';return;}
  con.innerHTML=S.entries.map(e=>`
    <article class="entry${e.isDummy?' entry-dummy':''}">
      <div class="ehdr">
        <div class="emeta">
          <span class="etime">${e.isDummy?'contoh':'baru saja'}</span>
          <span class="emood ${e.mood}">${MOOD_EMOJI[e.mood]||''} ${e.mood}</span>
        </div>
        ${e.isDummy?'<span class="fifo-i">Contoh</span>':''}
      </div>
      <div class="econt">${esc(e.content)}</div>
      <div class="reaction-bar">
        ${['skull:üíÄ','cry:üò≠','fire:üî•','upside:üôÉ'].map(kv=>{const[k,em]=kv.split(':');return`<button class="reaction-btn"><span class="remoji">${em}</span><span class="rcount">${e.reactions?.[k]||0}</span></button>`;}).join('')}
      </div>
    </article>`).join('');
}

function renderTray(){
  const con=$('tgrid');if(!con)return;
  let h='';
  S.artefacts.slice(0,6).forEach(a=>{
    h+=a.hasFace
      ?`<div class="ti" onclick="setHero('${a.id}')"><img src="${a.url}" class="${a.theme}" alt="${a.note||''}"><div class="sensored-overlay"><span class="sensored-text">SENSORED</span></div></div>`
      :`<div class="ti" onclick="setHero('${a.id}')"><img src="${a.url}" class="${a.theme}" alt="${a.note||''}"></div>`;
  });
  for(let i=S.artefacts.length;i<6;i++)h+=`<div class="ti empty" onclick="$('upbtn').click()">+</div>`;
  con.innerHTML=h;
}

function setHero(id){
  const a=S.artefacts.find(x=>x.id===id);if(!a)return;
  const img=$('himg'),note=$('hnote');
  if(img){img.src=a.url;img.className=a.theme;}
  if(note)note.textContent=`"${a.note||'memory'}"`;
}

// ============================================================
// QUOTA
// ============================================================
let uploads=parseInt(localStorage.getItem('jejak_uploads')||'0');
let quotaStart=parseInt(localStorage.getItem('jejak_quota_start')||Date.now());

function checkQuota(){
  const now=Date.now(),win=3*86400000;
  if(now-quotaStart>win){uploads=0;quotaStart=now;localStorage.setItem('jejak_uploads','0');localStorage.setItem('jejak_quota_start',now+'');return true;}
  return uploads<6;
}
function updQuota(){
  const t=$('qtimer'),c=$('ucnt');if(!t)return;
  const rem=Math.max(0,3*86400000-(Date.now()-quotaStart));
  const days=Math.ceil(rem/86400000),slots=6-uploads;
  t.textContent=`Window aktif ‚Ä¢ ${days}h ‚Ä¢ ${slots} slot`;
  t.classList.toggle('urg',slots<=2);
  if(c){c.textContent=uploads;c.style.display=uploads>0?'block':'none';}
}

// ============================================================
// UPLOAD
// ============================================================
const THEMES=[
  {name:'MONOCHROME',filter:'fm'},{name:'NOIR',filter:'fn'},{name:'SEPIA',filter:'fsp'},
  {name:'WARM',filter:'fw'},{name:'GOLDEN',filter:'fg'},{name:'LOMO',filter:'fl'},
  {name:'DREAM',filter:'fd'},{name:'COLD',filter:'fco'},{name:'CYBER',filter:'fc'},
  {name:'VIGNETTE',filter:'fv'},{name:'CRISP',filter:'fcr'},{name:'MOODY',filter:'fmo'}
];

let pendingFiles=[],selFiles=new Set(),curTheme=0,curNote='';

function initUpload(){
  const btn=$('upbtn'),fi=$('finput');
  if(!btn||!fi)return;
  btn.onclick=()=>{
    if(!checkQuota()){toast('‚è≥ Quota habis');return;}
    if(!S.userId){toast('Login diperlukan untuk upload',true);return;}
    fi.value='';fi.click();
  };
  fi.onchange=handleFiles;
}

async function handleFiles(e){
  const files=Array.from(e.target.files).slice(0,6-uploads);
  if(!files.length)return;
  pendingFiles=files.map(f=>({file:f,hasFace:false,preview:URL.createObjectURL(f)}));
  openGallery();
}

function openGallery(){
  selFiles=new Set(pendingFiles.map((_,i)=>i));
  curTheme=0;curNote='';
  const grid=$('ggrid');if(!grid)return;
  grid.innerHTML='';
  pendingFiles.forEach((item,i)=>{
    const d=document.createElement('div');
    d.className='gi sel';
    d.innerHTML=`<img src="${item.preview}" class="fm" id="pv${i}">`;
    d.onclick=()=>{selFiles.has(i)?selFiles.delete(i):selFiles.add(i);d.classList.toggle('sel');updSelCnt();};
    grid.appendChild(d);
  });
  $('tmsl').value=0;$('tmnm').textContent='MONOCHROME';
  $('noti').value='';$('notcnt').textContent='0/4';
  updSelCnt();
  $('gmodal').classList.add('on');
}

function updSelCnt(){$('selcnt').textContent=selFiles.size;}
function updTheme(v){curTheme=+v;const th=THEMES[curTheme];$('tmnm').textContent=th.name;pendingFiles.forEach((_,i)=>{const img=$('pv'+i);if(img)img.className=th.filter;});}
function valNote(inp){const w=inp.value.trim().split(/\s+/).filter(x=>x.length);$('notcnt').textContent=`${Math.min(w.length,4)}/4`;if(w.length>4)inp.value=w.slice(0,4).join(' ');curNote=inp.value.trim();}
function closeGallery(){$('gmodal').classList.remove('on');pendingFiles=[];selFiles.clear();}

async function confirmUpload(){
  if(selFiles.size===0){toast('Pilih minimal 1 foto');return;}
  if(!S.userId && S.user === '@anon'){toast('Login diperlukan untuk upload',true);closeGallery();return;}
  const kb=$('konfirmbtn');if(kb)kb.disabled=true;
  closeGallery();
  showProc('Memverifikasi sesi...<br><small>Sebentar</small>');
  // Selalu verifikasi userId sebelum upload
  const verifiedId = await resolveAndVerifyUserId();
  if(!verifiedId){hideProc();toast('User tidak ditemukan di DB ‚Äî coba logout & login ulang',true);if(kb)kb.disabled=false;return;}
  S.userId = verifiedId;
  showProc('Mengupload foto...<br><small>Mohon tunggu</small>');
  const theme=THEMES[curTheme];
  const note=curNote||'memory';
  const uname=S.user.replace('@','');
  let ok=0;

  for(const i of selFiles){
    const item=pendingFiles[i];
    const file=item.file;
    const ext=(file.name.split('.').pop()||'jpg').toLowerCase();
    const path=`${uname}/${Date.now()}_${i}.${ext}`;
    try{
      // 1. Upload ke Storage
      const {error:upErr}=await db.storage.from(BUCKET).upload(path,file,{cacheControl:'3600',upsert:false});
      if(upErr){console.error('Storage upload err:',upErr);continue;}

      // 2. Get public URL
      const {data:{publicUrl}}=db.storage.from(BUCKET).getPublicUrl(path);

      // 3. Insert ke tabel artefacts
      // HANYA kirim kolom yang PASTI ADA di tabel: user_id, username, url
      // Kolom opsional (note, has_face, faces, theme) kita coba, kalau gagal kirim tanpa itu
      let insertPayload = { user_id: S.userId, username: uname, url: publicUrl };
      
      // Coba tambah kolom opsional ‚Äî kalau tidak ada di DB, Supabase akan error
      // Kita pakai pendekatan: kirim semua, kalau 400 coba tanpa kolom opsional
      const payloadFull = { ...insertPayload, note: note, has_face: false, faces: [], theme: theme.filter };
      
      let {error:insErr}=await db.from('artefacts').insert(payloadFull);
      if(insErr){
        // Fallback: kirim hanya kolom minimal
        console.warn('Full insert failed, trying minimal:', insErr.message);
        const {error:insErr2}=await db.from('artefacts').insert(insertPayload);
        if(insErr2){console.error('Minimal insert also failed:', insErr2.message);continue;}
      }

      ok++;
      // Tambah ke state lokal langsung (tidak tunggu reload DB)
      S.artefacts.unshift({id:'tmp_'+Date.now()+'_'+i, url:publicUrl, note:note, hasFace:false, theme:theme.filter, isDummy:false});
      if(S.artefacts.length>6)S.artefacts.pop();
    }catch(err){console.error('Upload exc:',err);}
  }

  // Reload dari DB untuk dapat ID yang benar
  if(ok>0){
    uploads+=ok;
    localStorage.setItem('jejak_uploads',uploads+'');
    await loadArtefacts();
    updQuota();
    toast(`‚úì ${ok} foto berhasil diupload!`);
  } else {
    toast('‚ö† Upload gagal ‚Äî cek console untuk detail',true);
  }
  hideProc();
  if(kb)kb.disabled=false;
}

// ============================================================
// POST RANT
// ============================================================
async function postRant(content, mood){
  // Pastikan userId selalu fresh dari DB (hindari foreign key mismatch)
  if(!S.userId) {
    const uid = await resolveAndVerifyUserId();
    if(!uid) return {ok:false, msg:'User tidak ditemukan di database'};
    S.userId = uid;
  }
  // Kolom yang ADA di tabel rants: id(auto), user_id, content, mood, is_anonymous, created_at(auto)
  const payload = {
    user_id     : S.userId,
    content     : content,
    mood        : mood,
    is_anonymous: false
  };
  console.log('[JEJAK] postRant payload:', JSON.stringify(payload));
  const {data,error} = await db.from('rants').insert(payload).select('id');
  if(error){
    console.error('[JEJAK] postRant error code:', error.code, '| msg:', error.message, '| details:', error.details);
    // Jika foreign key error, coba refresh userId dari DB lalu retry sekali
    if(error.code === '23503') {
      console.warn('[JEJAK] Foreign key violation ‚Äî refreshing userId from DB...');
      S.userId = null; // force re-query
      const freshId = await resolveAndVerifyUserId();
      if(freshId && freshId !== payload.user_id){
        payload.user_id = freshId;
        const {data:d2, error:e2} = await db.from('rants').insert(payload).select('id');
        if(!e2){ console.log('[JEJAK] Retry success with fresh userId:', freshId); return {ok:true}; }
        return {ok:false, msg: e2.message};
      }
    }
    return {ok:false, msg: error.message};
  }
  console.log('[JEJAK] postRant success, id:', data?.[0]?.id);
  return {ok:true};
}

// ============================================================
// THEMES
// ============================================================

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', async ()=>{
  // Update header
  const hu=$('huser');if(hu)hu.textContent=S.user;

  // === LANGKAH 1: Verifikasi userId dari DB (fix foreign key mismatch) ===
  const dot=$('odot');
  if(S.user !== '@anon'){
    showProc('Memverifikasi sesi...<br><small>Sebentar ya</small>');
    const verifiedId = await resolveAndVerifyUserId();
    hideProc();
    if(verifiedId){
      S.userId = verifiedId;
      if(dot){ dot.classList.remove('off'); dot.style.background='var(--aq)'; dot.title=`Login: ${S.user} ‚úì`; }
      console.log('[JEJAK] Session OK ‚Äî userId:', S.userId);
    } else {
      if(dot){ dot.style.background='var(--at)'; dot.title='User tidak ditemukan di DB'; }
      toast('‚ö† Session bermasalah ‚Äî coba logout & login ulang', true);
    }
  } else {
    if(dot) dot.title='Tidak login';
  }

  // Load data
  await Promise.all([loadRants(), loadArtefacts()]);

  initUpload();
  updQuota();

  // Textarea counter
  const ri=$('ri'),cc=$('ccount');
  if(ri&&cc) ri.oninput=()=>{const n=ri.value.length;cc.textContent=`${n}/500`;cc.style.color=n>=450?'var(--at)':'var(--txm)';};

  // Submit rant
  const sb=$('sbtn');
  if(sb&&ri){
    sb.onclick=async()=>{
      const c=ri.value.trim();
      if(!c){toast('Tulis sesuatu dulu...');return;}
      if(!S.userId){toast('Login diperlukan untuk post',true);return;}
      sb.disabled=true;sb.textContent='Menyimpan...';
      const mood=document.querySelector('.mc.act')?.dataset.mood||'surviving';
      const res=await postRant(c,mood);
      if(res.ok){
        ri.value='';if(cc)cc.textContent='0/500';
        toast('‚úì Rant tersimpan!');
        await loadRants();
      } else {
        toast(`‚ö† Gagal: ${res.msg}`,true);
      }
      sb.disabled=false;sb.textContent='Jejakkan & Spill';
    };
  }

  setInterval(updQuota,60000);
});
</script>
</body>
</html>
