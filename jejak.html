<!DOCTYPE html>
<html lang="id" data-theme="glitch">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NOPE â€” Jurnal</title>
  
  <!-- PWA / Add to Home Screen -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23ff9999'/%3E%3Ctext x='50' y='70' font-size='60' font-weight='bold' font-family='system-ui' text-anchor='middle' fill='%23000'%3ENO%3C/text%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='40' fill='%23ff9999'/%3E%3Ctext x='90' y='130' font-size='90' font-weight='900' font-family='system-ui' text-anchor='middle' fill='%23000'%3ENO%3C/text%3E%3C/svg%3E">
  <meta name="theme-color" content="#0a0a0a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NOPE">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,300;0,400;0,500;1,400&display=swap" rel="stylesheet">
  <style>
    :root,
    [data-theme="glitch"] {
      --bg: #0a0a0a;
      --surface: #121212;
      --border: #222222;
      --text: #e6e6e6;
      --muted: #8a8a8a;
      --accent: #b266ff;
      --logo-color: #ff9999;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, 'SF Mono', Consolas, monospace;
      font-weight: 300;
      font-size: 15px;
      line-height: 1.55;
      padding-bottom: 72px;
      -webkit-font-smoothing: antialiased;
    }
    .wrapper {
      max-width: 480px;
      margin: 0 auto;
      padding: 0 16px;
    }
    header {
      position: sticky;
      top: 0;
      background: #000000cc;
      backdrop-filter: blur(6px);
      padding: 12px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }
    .logo {
      font-family: 'Manrope', sans-serif;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--logo-color);
      margin-left: 16px;
      transition: transform 0.3s ease, opacity 0.3s ease;
      text-decoration: none;
      cursor: pointer;
    }
    header:hover .logo {
      transform: scale(1.02);
      opacity: 0.96;
    }
    .top-right {
      display: flex;
      align-items: center;
      margin-right: 12px;
    }
    .nav-mini {
      display: flex;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
      margin-right: 8px;
    }
    .nav-mini span {
      cursor: pointer;
      text-decoration: underline;
      text-decoration-style: dotted;
      text-underline-offset: 2px;
      padding: 2px 4px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
      user-select: none;
      -webkit-user-select: none;
    }
    .nav-mini span:hover:not(.active) {
      background-color: rgba(178, 102, 255, 0.06);
      color: var(--text);
    }
    .nav-mini span.active {
      color: var(--accent) !important;
      text-decoration-color: var(--accent);
      font-weight: 500;
      background-color: rgba(178, 102, 255, 0.08);
    }
    .settings-btn {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
      transform: rotate(90deg);
    }
    .hero {
      position: relative;
      width: 100%;
      aspect-ratio: 4 / 5;
      background: var(--surface);
      border-radius: 0 0 24px 24px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    .hero img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .artefak-notation {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0,0,0,0.3);
      color: var(--text);
      font-size: 16.5px;
      font-weight: 500;
      padding: 4px 6px;
      border-radius: 4px;
      max-width: 80%;
      line-height: 1.2;
      backdrop-filter: blur(2px);
      pointer-events: none;
      font-family: 'JetBrains Mono', monospace;
    }
    .upload-artefak-btn {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      z-index: 2;
      transition: all 0.2s;
    }
    .upload-artefak-btn:hover {
      background: #c284ff;
      transform: translateY(-1px);
    }
    .post-upload-panel {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0 0 12px 12px;
      margin-bottom: 16px;
    }
    .post-upload-panel.hidden {
      display: none !important;
    }
    .post-upload-panel input {
      flex: 1;
      background: #000000aa;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text);
      font-size: 13px;
      font-family: 'JetBrains Mono', monospace;
    }
    .post-upload-panel input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .post-upload-panel button {
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .rant-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px 24px 16px;
      margin-bottom: 16px;
      position: relative;
    }
    .rant-box-header {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
      line-height: 1.4;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: 'JetBrains Mono', monospace;
    }
    .rant-box-header strong {
      color: var(--text);
      font-weight: 500;
      white-space: nowrap;
    }
    .rant-box textarea {
      width: 100%;
      background: transparent;
      border: none;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      line-height: 1.4;
      resize: none;
      min-height: 80px;
    }
    .rant-box textarea:focus {
      outline: none;
    }
    .rant-cta {
      position: absolute;
      bottom: 12px;
      right: 16px;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .rant-cta:hover:not(:disabled) {
      background: #c284ff;
      transform: translateY(-1px);
    }
    .rant-cta:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .confirmation {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      margin-top: 4px;
      font-family: 'JetBrains Mono', monospace;
    }
    .diary {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 16px;
    }
    .diary-entry {
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .diary-entry:last-child { border: none; }
    .diary-entry time {
      font-size: 10px;
      color: var(--muted);
      display: block;
      margin-bottom: 2px;
      font-family: 'JetBrains Mono', monospace;
    }
    .diary-entry p {
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      line-height: 1.5;
    }
    .tray {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 8px;
      padding: 0 16px 16px;
    }
    .tray-slot {
      aspect-ratio: 1;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
      cursor: pointer;
      transition: all 0.2s;
      animation: fadeIn 0.6s ease-in;
    }
    .tray-slot:hover {
      border-color: var(--accent);
      transform: scale(1.02);
      background-color: rgba(178, 102, 255, 0.02);
    }
    .tray-slot .artefak-notation {
      top: 6px;
      left: 6px;
      font-size: 10px;
      padding: 3px 5px;
    }
    
    /* Fade in animation for images */
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    
    /* Image loading state */
    .hero img, .tray-slot {
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    
    .hero img[src=""], .tray-slot[style*="url('')"] {
      opacity: 0.3;
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
    }
    .zone-footer {
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      padding: 0 16px 20px;
      line-height: 1.5;
      letter-spacing: 0.5px;
      font-family: 'JetBrains Mono', monospace;
    }
    .pulse-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, rgba(178, 102, 255, 0.15), transparent);
      pointer-events: none;
      opacity: 0;
      z-index: 999;
      animation: pulse 1.4s cubic-bezier(0.2, 0.8, 0.4, 1);
    }
    @keyframes pulse {
      0% { transform: scale(0.9); opacity: 0.6; }
      100% { transform: scale(1.6); opacity: 0; }
    }
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <header>
      <div class="logo" onclick="window.location.href='index.html'">NOPE</div>
      <div class="top-right">
        <div class="nav-mini">
          <span class="active"    onclick="window.location.href='jejak.html'">Jurnal</span>
          <span                   onclick="window.location.href='frekuensi.html'">Frekuensi</span>
          <span                   onclick="window.location.href='sayNOPE.html'">SayNOPE</span>
          <span                   onclick="window.location.href='glitch.html'">GLITCH</span>
        </div>
        <button class="settings-btn" id="settings-btn">â‹¯</button>
      </div>
    </header>

    <div class="hero">
      <img id="hero-img" src="https://picsum.photos/seed/nope-hero/800/1000" alt="artefak">
      <div class="artefak-notation" id="hero-notation-display"></div>
      <button id="upload-artefak-btn" class="upload-artefak-btn">Unggah</button>
    </div>

    <div id="post-upload-panel" class="post-upload-panel hidden">
      <input id="hero-notation" type="text" placeholder="notasi (maks 4 kata)" maxlength="50">
      <button id="save-notation-btn">Simpan</button>
    </div>

    <div class="rant-box">
      <div class="rant-box-header">
        Hello <strong>@<span id="username-display"></span></strong>
      </div>
      <textarea id="rant" maxlength="300" placeholder="marah? sedih? cape? tulis aja. gak usah bener."></textarea>
      <button class="rant-cta" id="jejakkan-btn">Unggah</button>
      <div class="confirmation" id="confirmation"></div>
    </div>

    <div class="diary" id="diary"></div>
    <div class="tray" id="tray"></div>

    <div class="zone-footer">Nyambat â€¢ Aksi â€¢ Solusi</div>
  </div>

  <input type="file" id="file-input" accept="image/*" style="display:none;">

  <script>
  (function() {
    'use strict';

    var SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';

    async function supabaseFetch(table, method, body, filter) {
      var headers = {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + SUPABASE_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      };
      var url = SUPABASE_URL + '/rest/v1/' + table + (filter || '');
      var options = { method: method || 'GET', headers: headers };
      if (body) options.body = JSON.stringify(body);

      var res = await fetch(url, options);
      if (!res.ok) {
        var errorText = await res.text();
        throw new Error('HTTP ' + res.status + ': ' + errorText);
      }
      return res.json();
    }

    var currentUser = localStorage.getItem('nope_username') || '@newglitch';
    document.getElementById('username-display').textContent = currentUser.replace(/^@/, '');

    var artefacts = [];
    var rants     = [];

    var DUMMY_RANTS = [
      {
        id: 'dummy-0', username: 'homie1',
        content: "gue udah bantuin dia tiap malem pas dia galau sampe gue lupa ngerjain tugas sendiri. pas gue butuh temen buat ngobrol, dia malah offline terus. gak minta balasan sih, tapi rasanya kayak jadi tempat sampah emosi doang. capek jadi 'temen baik' yang cuma dipake pas dia perlu aja.",
        created_at: new Date(Date.now() - 86400000 * 2).toISOString()
      },
      {
        id: 'dummy-1', username: 'homie2',
        content: "deadline mepet, dosen gak jelas, dompet kering. rasanya pengen ijin cuti sehari buat jadi batu aja. gak perlu mikir, gak perlu ngomong, gak perlu diharapkan apa-apa.",
        created_at: new Date(Date.now() - 86400000).toISOString()
      },
      {
        id: 'dummy-2', username: 'homie3',
        content: "capek.",
        created_at: new Date(Date.now() - 43200000).toISOString()
      }
    ];

    // Dummy images using reliable CDN that always loads
    var DUMMY_ARTEFACTS = [
      { id:'dummy-0', image_url:'https://picsum.photos/seed/nope1/400/500', notation: 'kadang hidup abu abu' },
      { id:'dummy-1', image_url:'https://picsum.photos/seed/nope2/400/500', notation:'gebetan temen lebih hijau' },
      { id:'dummy-2', image_url:'https://picsum.photos/seed/nope3/400/500', notation:'gabut NO FACE' },
      { id:'dummy-3', image_url:'https://picsum.photos/seed/nope4/400/500', notation:'lonelyness my hiding place' },
      { id:'dummy-4', image_url:'https://picsum.photos/seed/nope5/400/500', notation:'capek' },
      { id:'dummy-5', image_url:'https://picsum.photos/seed/nope6/400/500', notation:'love it' }
    ];

    var heroImg             = document.getElementById('hero-img');
    var heroNotationDisplay = document.getElementById('hero-notation-display');
    var postUploadPanel     = document.getElementById('post-upload-panel');
    var heroNotationInput   = document.getElementById('hero-notation');
    var fileInput           = document.getElementById('file-input');

    function showConfirmation(msg) {
      var el = document.getElementById('confirmation');
      el.textContent = msg;
      setTimeout(function(){ el.textContent = ''; }, 3000);
    }

    function triggerPulse() {
      var pulse = document.createElement('div');
      pulse.className = 'pulse-animation';
      document.body.appendChild(pulse);
      setTimeout(function(){ if (pulse.parentNode) pulse.parentNode.removeChild(pulse); }, 1500);
    }

    function showPostUploadPanel() {
      postUploadPanel.classList.remove('hidden');
      heroNotationInput.value = '';
      heroNotationInput.focus();
    }

    function hidePostUploadPanel() {
      postUploadPanel.classList.add('hidden');
    }

    function renderHero() {
      var current = artefacts.length > 0 ? artefacts[0] : DUMMY_ARTEFACTS[0];
      if (current) {
        heroImg.src = current.image_url;
        heroNotationDisplay.textContent = current.notation || '';
        if (artefacts.length > 0 && !current.notation) {
          showPostUploadPanel();
        } else {
          hidePostUploadPanel();
        }
      }
    }

    function renderDiary() {
      var container = document.getElementById('diary');
      container.innerHTML = '';
      var list = rants.length > 0 ? rants : DUMMY_RANTS;

      list.forEach(function(r) {
        var entry = document.createElement('div');
        entry.className = 'diary-entry';
        var date = new Date(r.created_at).toLocaleDateString('id-ID', { day:'2-digit', month:'short' });
        entry.innerHTML = '<time>' + date + '</time><p>' + r.content + '</p>';
        container.appendChild(entry);

        if (String(r.id).indexOf('dummy-') !== 0) {
          var reactRow = document.createElement('div');
          reactRow.style.cssText = 'display:flex;gap:12px;margin-top:8px;font-size:15px;';

          ['ðŸ¤ ','ðŸ˜¢','ðŸ¤—','ðŸ”¥'].forEach(function(emoji) {
            var item = document.createElement('div');
            item.style.cssText = 'display:flex;align-items:center;gap:4px;cursor:pointer;opacity:0.6;transition:all 0.2s;';

            var emojiSpan = document.createElement('span');
            emojiSpan.textContent = emoji;
            emojiSpan.style.cssText = 'font-size:18px;font-weight:600;transition:transform 0.2s;';

            var countSpan = document.createElement('span');
            countSpan.textContent = '0';
            countSpan.style.cssText = 'font-size:13px;color:transparent;';

            item.onmouseenter = function() { emojiSpan.style.transform='scale(1.2)'; item.style.opacity='1'; };
            item.onmouseleave = function() { emojiSpan.style.transform='scale(1)';  item.style.opacity='0.6'; };

            item.appendChild(emojiSpan);
            item.appendChild(countSpan);
            reactRow.appendChild(item);
          });

          entry.appendChild(reactRow);
        }
      });
    }

    function renderTray() {
      var tray = document.getElementById('tray');
      tray.innerHTML = '';
      
      // Mix user artefacts with dummy artefacts (user artefacts replace dummy ones gradually)
      var displayList = [];
      
      if (artefacts.length > 0) {
        // User has uploaded artefacts - show them first
        displayList = artefacts.slice(0, 6);
        
        // Fill remaining slots with dummy artefacts if needed
        var remaining = 6 - displayList.length;
        if (remaining > 0) {
          // Skip first dummy (which user would replace first) and add from end
          var dummyFillStart = artefacts.length; // How many dummies to skip
          for (var i = dummyFillStart; i < 6 && displayList.length < 6; i++) {
            if (DUMMY_ARTEFACTS[i]) {
              displayList.push(DUMMY_ARTEFACTS[i]);
            }
          }
        }
      } else {
        // No user artefacts yet - show all 6 dummies for visual guidance
        displayList = DUMMY_ARTEFACTS.slice(0, 6);
      }

      if (displayList.length === 0) {
        tray.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--muted);font-size:13px;padding:40px 20px;">Belum ada artefak. Unggah gambar pertamamu!</div>';
        return;
      }

      displayList.forEach(function(a, index) {
        var div = document.createElement('div');
        div.className = 'tray-slot';
        
        // Add staggered animation delay for smooth appearance
        div.style.animationDelay = (index * 0.1) + 's';

        if (!a.image_url) {
          div.style.backgroundColor = '#1a1a1a';
          tray.appendChild(div);
          return;
        }

        div.style.backgroundImage = 'url(' + a.image_url + ')';
        
        // Add subtle badge to indicate dummy vs user content (optional visual cue)
        var isDummy = String(a.id).indexOf('dummy-') === 0;
        if (isDummy) {
          div.style.opacity = '0.85'; // Slightly dimmer to indicate it's placeholder
        }

        if (a.notation) {
          var notationEl = document.createElement('div');
          notationEl.className = 'artefak-notation';
          notationEl.textContent = a.notation;
          div.appendChild(notationEl);
        }

        div.onclick = function() {
          heroImg.src = a.image_url;
          heroNotationDisplay.textContent = a.notation || '';
          hidePostUploadPanel();
        };

        tray.appendChild(div);
      });
    }

    async function handleFileSelect(event) {
      var file = event.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        showConfirmation('Hanya file gambar yang diperbolehkan!');
        fileInput.value = '';
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        showConfirmation('Ukuran file maksimal 5MB!');
        fileInput.value = '';
        return;
      }

      showConfirmation('Mengunggah...');

      var timestamp = Date.now();
      var safeName  = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
      var cleanUser = currentUser.replace(/^@/, '').replace(/\s+/g, '_');
      var fileName  = cleanUser + '/' + timestamp + '-' + safeName;

      try {
        var formData = new FormData();
        formData.append('', file);

        var uploadRes = await fetch(
          SUPABASE_URL + '/storage/v1/object/artefacts/' + fileName,
          {
            method: 'POST',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': 'Bearer ' + SUPABASE_KEY
            },
            body: formData
          }
        );

        if (!uploadRes.ok) {
          var errBody = await uploadRes.text();
          throw new Error('Upload gagal: ' + errBody);
        }

        var publicUrl = SUPABASE_URL + '/storage/v1/object/public/artefacts/' + fileName;

        await supabaseFetch('artefacts', 'POST', {
          username: currentUser,
          image_url: publicUrl,
          notation: ''
        });

        await loadData();
        showConfirmation('Artefak berhasil diunggah!');
        triggerPulse();

      } catch (e) {
        console.error('Upload error:', e);
        showConfirmation('Gagal upload. Coba lagi.');
      }

      fileInput.value = '';
    }

    async function saveNotation() {
      var notation = heroNotationInput.value.trim();
      if (!notation) { showConfirmation('Tulis notasi dulu.'); return; }

      var words = notation.split(/\s+/).filter(function(w){ return w.length > 0; });
      if (words.length > 4) { showConfirmation('Maks 4 kata.'); return; }

      var target = null;
      for (var i = 0; i < artefacts.length; i++) {
        if (!artefacts[i].notation) { target = artefacts[i]; break; }
      }
      if (!target) { showConfirmation('Tidak ada artefak untuk ditandai.'); return; }

      try {
        showConfirmation('Menyimpan...');
        await supabaseFetch('artefacts', 'PATCH',
          { notation: notation },
          '?id=eq.' + target.id
        );
        await loadData();
        showConfirmation('Notasi tersimpan.');
        triggerPulse();
      } catch (e) {
        console.error('Save notation error:', e);
        showConfirmation('Gagal simpan. Coba lagi.');
      }
    }

    async function postRant() {
      var textarea = document.getElementById('rant');
      var content  = textarea.value.trim();
      if (!content) { showConfirmation('Tulis dulu.'); return; }

      try {
        showConfirmation('Posting...');
        await supabaseFetch('rants', 'POST', {
          username: currentUser,
          content: content
        });
        textarea.value = '';
        await loadData();
        showConfirmation('Terkirim.');
        triggerPulse();
      } catch (e) {
        console.error('Post rant error:', e);
        showConfirmation('Gagal posting. Coba lagi.');
      }
    }

    async function ensureUserExists() {
      try {
        var users = await supabaseFetch('users', 'GET', null,
          '?username=eq.' + encodeURIComponent(currentUser)
        );
        if (!users || users.length === 0) {
          await supabaseFetch('users', 'POST', { username: currentUser });
        }
      } catch (e) {
        console.error('ensureUserExists:', e);
      }
    }

    async function loadData() {
      try {
        await ensureUserExists();

        var aData = await supabaseFetch('artefacts', 'GET', null,
          '?username=eq.' + encodeURIComponent(currentUser) + '&order=created_at.desc&limit=6'
        );
        artefacts = aData || [];

        var rData = await supabaseFetch('rants', 'GET', null,
          '?username=eq.' + encodeURIComponent(currentUser) + '&order=created_at.desc&limit=5'
        );
        rants = rData || [];

      } catch (e) {
        console.error('loadData error:', e);
      }

      renderHero();
      renderDiary();
      renderTray();
    }

    document.getElementById('upload-artefak-btn').addEventListener('click', function() {
      fileInput.click();
    });

    fileInput.addEventListener('change', handleFileSelect);

    document.getElementById('save-notation-btn').addEventListener('click', saveNotation);

    document.getElementById('jejakkan-btn').addEventListener('click', postRant);

    document.getElementById('settings-btn').addEventListener('click', function() {
      showConfirmation('Settings â€” coming soon.');
    });

    loadData();

  })();
  </script>
</body>
</html>
