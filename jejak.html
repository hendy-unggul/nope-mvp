<!DOCTYPE html>
<html lang="id" data-theme="glitch">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NOPE ‚Äî Jurnal</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,300;0,400;0,500;1,400&display=swap" rel="stylesheet">
  <style>
    :root,
    [data-theme="glitch"] {
      --bg: #0a0a0a;
      --surface: #121212;
      --border: #222222;
      --text: #e6e6e6;
      --muted: #8a8a8a;
      --accent: #b266ff;
      --logo-color: #ff9999;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, 'SF Mono', Consolas, monospace;
      font-weight: 300;
      font-size: 15px;
      line-height: 1.55;
      padding-bottom: 72px;
      -webkit-font-smoothing: antialiased;
    }
    .wrapper {
      max-width: 480px;
      margin: 0 auto;
      padding: 0 16px;
    }
    header {
      position: sticky;
      top: 0;
      background: #000000cc;
      backdrop-filter: blur(6px);
      padding: 12px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }
    .logo {
      font-family: 'Manrope', sans-serif;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--logo-color);
      margin-left: 16px;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    header:hover .logo {
      transform: scale(1.02);
      opacity: 0.96;
    }
    .top-right {
      display: flex;
      align-items: center;
      margin-right: 12px;
    }
    .nav-mini {
      display: flex;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
      margin-right: 8px;
    }
    .nav-mini span {
      cursor: pointer;
      text-decoration: underline;
      text-decoration-style: dotted;
      text-underline-offset: 2px;
      padding: 2px 4px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }
    .nav-mini span:hover:not(.active) {
      background-color: rgba(178, 102, 255, 0.06);
      color: var(--text);
    }
    .nav-mini span.active {
      color: var(--accent) !important;
      text-decoration-color: var(--accent);
      font-weight: 500;
      background-color: rgba(178, 102, 255, 0.08);
    }
    .settings-btn {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
      transform: rotate(90deg);
    }
    .hero {
      position: relative;
      width: 100%;
      aspect-ratio: 4 / 5;
      background: var(--surface);
      border-radius: 0 0 24px 24px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    .hero img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .artefak-notation {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0,0,0,0.3);
      color: var(--text);
      font-size: 16.5px;
      font-weight: 500;
      padding: 4px 6px;
      border-radius: 4px;
      max-width: 80%;
      line-height: 1.2;
      backdrop-filter: blur(2px);
      pointer-events: none;
      font-family: 'JetBrains Mono', monospace;
    }
    .upload-artefak-btn {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      z-index: 2;
      transition: all 0.2s;
    }
    .upload-artefak-btn:hover {
      background: #c284ff;
      transform: translateY(-1px);
    }
    .post-upload-panel {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0 0 12px 12px;
      margin-bottom: 16px;
    }
    .post-upload-panel.hidden {
      display: none !important;
    }
    .post-upload-panel input {
      flex: 1;
      background: #000000aa;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text);
      font-size: 13px;
      font-family: 'JetBrains Mono', monospace;
    }
    .post-upload-panel input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .post-upload-panel button {
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .rant-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px 24px 16px;
      margin-bottom: 16px;
      position: relative;
    }
    .rant-box-header {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
      line-height: 1.4;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: 'JetBrains Mono', monospace;
    }
    .rant-box-header strong {
      color: var(--text);
      font-weight: 500;
      white-space: nowrap;
    }
    .rant-box textarea {
      width: 100%;
      background: transparent;
      border: none;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      line-height: 1.4;
      resize: none;
      min-height: 80px;
    }
    .rant-box textarea:focus {
      outline: none;
    }
    .rant-cta {
      position: absolute;
      bottom: 12px;
      right: 16px;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .rant-cta:hover:not(:disabled) {
      background: #c284ff;
      transform: translateY(-1px);
    }
    .rant-cta:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .confirmation {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      margin-top: 4px;
      font-family: 'JetBrains Mono', monospace;
    }
    .diary {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 16px;
    }
    .diary-entry {
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .diary-entry:last-child { border: none; }
    .diary-entry time {
      font-size: 10px;
      color: var(--muted);
      display: block;
      margin-bottom: 2px;
      font-family: 'JetBrains Mono', monospace;
    }
    .diary-entry p {
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      line-height: 1.5;
    }
    .tray {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 8px;
      padding: 0 16px 16px;
    }
    .tray-slot {
      aspect-ratio: 1;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tray-slot:hover {
      border-color: var(--accent);
      transform: scale(1.02);
      background-color: rgba(178, 102, 255, 0.02);
    }
    .tray-slot .artefak-notation {
      top: 6px;
      left: 6px;
      font-size: 10px;
      padding: 3px 5px;
    }

    /* === ZONE FOOTER ‚Äî menggantikan tagline lama === */
    .zone-footer {
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      padding: 0 16px 20px;
      line-height: 1.5;
      letter-spacing: 0.5px;
      font-family: 'JetBrains Mono', monospace;
    }

    /* === PULSE === */
    .pulse-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, rgba(178, 102, 255, 0.15), transparent);
      pointer-events: none;
      opacity: 0;
      z-index: 999;
      animation: pulse 1.4s cubic-bezier(0.2, 0.8, 0.4, 1);
    }
    @keyframes pulse {
      0% { transform: scale(0.9); opacity: 0.6; }
      100% { transform: scale(1.6); opacity: 0; }
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <header>
      <div class="logo">NOPE</div>
      <div class="top-right">
        <div class="nav-mini">
          <span id="nav-jejak" class="active">Jurnal</span>
          <span id="nav-frekuensi">Frekuensi</span>
          <span id="nav-saynope">SayNOPE</span>
          <span id="nav-glitch">GLITCH</span>
        </div>
        <button class="settings-btn" id="settings-btn">‚ãØ</button>
      </div>
    </header>

    <div class="hero">
      <img id="hero-img" src="https://images.unsplash.com/photo-1600880292203-757bb62b4baf?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=384&q=80" alt="artefak">
      <div class="artefak-notation" id="hero-notation-display"></div>
      <button id="upload-artefak-btn" class="upload-artefak-btn">Unggah</button>
    </div>

    <div id="post-upload-panel" class="post-upload-panel hidden">
      <input id="hero-notation" type="text" placeholder="notasi (maks 4 kata)" maxlength="50">
      <button id="save-notation-btn">Simpan</button>
    </div>

    <div class="rant-box">
      <div class="rant-box-header">
        Hello <strong>@<span id="username-display"></span></strong>
      </div>
      <textarea id="rant" maxlength="300" placeholder="marah? sedih? cape? tulis aja. gak usah bener."></textarea>
      <button class="rant-cta" id="jejakkan-btn">Unggah</button>
      <div class="confirmation" id="confirmation"></div>
    </div>

    <div class="diary" id="diary"></div>
    <div class="tray" id="tray"></div>

    <!-- ‚ú® FOOTER ZONA ‚Äî menggantikan tagline lama -->
    <div class="zone-footer">Nyambat ‚Ä¢ Aksi ‚Ä¢ Solusi</div>
  </div>

  <input type="file" id="file-input" accept="image/*" style="display:none;">

  <!-- üîÅ SEMUA JAVASCRIPT ASLI TETAP UTUH DI BAWAH INI -->
  <script>
    // === CONFIG ===
    const SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';

    async function supabaseFetch(table, method = 'GET', body = null, filter = '') {
      const headers = {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      };

      let url = `${SUPABASE_URL}/rest/v1/${table}${filter}`;
      let options = { method, headers };
      if (body) options.body = JSON.stringify(body);

      const res = await fetch(url, options);
      if (!res.ok) {
        const errorText = await res.text();
        throw new Error(`HTTP ${res.status}: ${errorText}`);
      }
      return await res.json();
    }

    // === STATE ===
    const currentUser = localStorage.getItem('nope_username') || '@newglitch';
    document.getElementById('username-display').textContent = currentUser.replace(/^@/, '');

    let artefacts = [];
    let rants = [];

    // === DUMMY RANTS UNTUK ONBOARDING ===
    const DUMMY_RANTS = [
      {
        id: 'dummy-0',
        username: 'homie1',
        content: "gue udah bantuin dia tiap malem pas dia galau sampe gue lupa ngerjain tugas sendiri. pas gue butuh temen buat ngobrol, dia malah offline terus. gak minta balasan sih, tapi rasanya kayak jadi tempat sampah emosi doang. capek jadi ‚Äòtemen baik‚Äô yang cuma dipake pas dia perlu aja.",
        created_at: new Date(Date.now() - 86400000 * 2).toISOString()
      },
      {
        id: 'dummy-1',
        username: 'homie2',
        content: "deadline mepet, dosen gak jelas, dompet kering. rasanya pengen ijin cuti sehari buat jadi batu aja. gak perlu mikir, gak perlu ngomong, gak perlu diharapkan apa-apa.",
        created_at: new Date(Date.now() - 86400000 * 1).toISOString()
      },
      {
        id: 'dummy-2',
        username: 'homie3',
        content: "capek.",
        created_at: new Date(Date.now() - 86400000 * 0.5).toISOString()
      }
    ];

    // === DUMMY ARTEFAK UNTUK ONBOARDING ===
    const DUMMY_ARTEFACTS = [
      {
        id: 'dummy-0',
        username: 'homie1',
        image_url: 'https://images.unsplash.com/photo-1600880292203-757bb62b4baf?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=384&q=80',
        notation: 'ingat puasa main ps'
      },
      {
        id: 'dummy-1',
        username: 'homie2',
        image_url: 'https://images.unsplash.com/photo-1572117644447-93c1e6d6370f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=384&q=80',
        notation: 'matcha dulu deh'
      },
      {
        id: 'dummy-2',
        username: 'homie3',
        image_url: 'https://images.unsplash.com/photo-1583394838336-acdcb777b42a?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=384&q=80',
        notation: 'nobar sama mantan'
      },
      {
        id: 'dummy-3',
        username: 'homie4',
        image_url: 'https://images.unsplash.com/photo-1593642702821-c800c47beb39?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=384&q=80',
        notation: 'makaan'
      },
      {
        id: 'dummy-4',
        username: 'homie5',
        image_url: 'https://images.unsplash.com/photo-1558188528-91126b887225?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=384&q=80',
        notation: 'capek'
      }
    ];

    // === UTILS ===
    const heroImg = document.getElementById('hero-img');
    const heroNotationDisplay = document.getElementById('hero-notation-display');
    const postUploadPanel = document.getElementById('post-upload-panel');

    function showConfirmation(msg) {
      const el = document.getElementById('confirmation');
      el.textContent = msg;
      setTimeout(() => el.textContent = '', 3000);
    }

    function validateNotation(text) {
      const words = text.trim().split(/\s+/).filter(w => w.length > 0);
      return words.length >= 1 && words.length <= 4;
    }

    function showPostUploadPanel() {
      postUploadPanel.classList.remove('hidden');
      document.getElementById('hero-notation').value = '';
      document.getElementById('hero-notation').focus();
    }

    function hidePostUploadPanel() {
      postUploadPanel.classList.add('hidden');
    }

    // === DATABASE ===
    async function ensureUserExists() {
      try {
        const users = await supabaseFetch('users', 'GET', null);
        const user = users.find(u => u.username === currentUser);
        if (!user) {
          await supabaseFetch('users', 'POST', { username: currentUser });
        }
      } catch (e) {
        console.error('Gagal pastikan user:', e);
      }
    }

    // === MUAT DATA ===
    async function loadData() {
      try {
        await ensureUserExists();

        const artefactsData = await supabaseFetch('artefacts', 'GET', null,
          `?username=eq.${encodeURIComponent(currentUser)}&order=created_at.desc&limit=6`
        );
        artefacts = artefactsData;

        const rantsData = await supabaseFetch('rants', 'GET', null,
          `?username=eq.${encodeURIComponent(currentUser)}&order=created_at.desc&limit=5`
        );
        rants = rantsData;

        renderHero();
        renderDiary();
        renderTray();

      } catch (e) {
        console.error('Error saat load ', e);
        showConfirmation("Gagal memuat data. Coba refresh.");
      }
    }

    // === RENDER ===
    function renderHero() {
      let currentArtefact = artefacts.length > 0 ? artefacts[0] : DUMMY_ARTEFACTS[0];

      if (currentArtefact) {
        heroImg.src = currentArtefact.image_url;
        const notation = currentArtefact.notation || '';
        heroNotationDisplay.textContent = notation;
        if (notation) hidePostUploadPanel();
      } else {
        heroImg.src = 'https://images.unsplash.com/photo-1600880292203-757bb62b4baf?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=384&q=80';
        heroNotationDisplay.textContent = '';
      }
    }

    function renderDiary() {
      const container = document.getElementById('diary');
      container.innerHTML = '';

      let displayRants = rants.length > 0 ? rants : DUMMY_RANTS;

      displayRants.forEach(r => {
        const entry = document.createElement('div');
        entry.className = 'diary-entry';
        const date = new Date(r.created_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
        entry.innerHTML = `<time>${date}</time><p>${r.content}</p>`;
        container.appendChild(entry);

        // --- TAMBAHKAN EMOJI + COUNTER ---
        const reactionsContainer = document.createElement('div');
        reactionsContainer.style.display = 'flex';
        reactionsContainer.style.gap = '12px';
        reactionsContainer.style.marginTop = '8px';
        reactionsContainer.style.fontSize = '15px';

        fetchReactionStats(r.id).then(stats => {
          ['ü§†', 'üò¢', 'ü§ó', 'üî•'].forEach(emoji => {
            const count = stats[emoji].count;
            const users = stats[emoji].users;

            const item = document.createElement('div');
            item.style.display = 'flex';
            item.style.alignItems = 'center';
            item.style.gap = '4px';
            item.style.cursor = 'pointer';
            item.style.opacity = count > 0 ? '1' : '0.6';
            item.style.transition = 'all 0.2s';

            const emojiSpan = document.createElement('span');
            emojiSpan.textContent = emoji;
            emojiSpan.style.fontSize = '18px';
            emojiSpan.style.fontWeight = '600';

            const countSpan = document.createElement('span');
            countSpan.textContent = count;
            countSpan.style.fontSize = '13px';
            countSpan.style.color = count > 0 ? '#a0a0a0' : 'transparent';

            if (count > 0) {
              countSpan.style.animation = 'pulse-glow 2s infinite';
              if (!document.getElementById('pulse-style')) {
                const style = document.createElement('style');
                style.id = 'pulse-style';
                style.textContent = `
                  @keyframes pulse-glow {
                    0%, 100% { opacity: 0.7; }
                    50% { opacity: 1; }
                  }
                `;
                document.head.appendChild(style);
              }
            }

            // ‚ö°Ô∏è KLIK EMOJI ‚Üí TAMPILKAN 3 USERNAME
            item.onclick = (e) => {
              e.stopPropagation();
              showUserList(emoji, users);
            };

            // Hover effect
            item.onmouseenter = () => {
              emojiSpan.style.transform = 'scale(1.2)';
              emojiSpan.style.opacity = '1';
            };
            item.onmouseleave = () => {
              emojiSpan.style.transform = 'scale(1)';
              emojiSpan.style.opacity = count > 0 ? '1' : '0.6';
            };

            item.appendChild(emojiSpan);
            item.appendChild(countSpan);

            reactionsContainer.appendChild(item);
          });
        });

        entry.appendChild(reactionsContainer);
      });
    }

    function renderTray() {
      const tray = document.getElementById('tray');
      tray.innerHTML = '';

      let displayArtefacts = artefacts.length > 0 ? artefacts : DUMMY_ARTEFACTS;

      if (displayArtefacts.length === 0) {
        tray.innerHTML = '<div class="empty-state">Belum ada artefak. Unggah gambar pertamamu!</div>';
        return;
      }

      displayArtefacts.slice(0, 6).forEach((a, index) => {
        const div = document.createElement('div');
        div.className = 'tray-slot';
        div.style.width = '100%';
        div.style.height = '100%';
        div.style.backgroundSize = 'cover';
        div.style.backgroundPosition = 'center';
        div.style.backgroundRepeat = 'no-repeat';

        if (a.image_url) {
          div.style.backgroundImage = `url(${a.image_url})`;
        } else {
          div.style.backgroundColor = '#1a1a1a';
          div.innerHTML = `<div style="color: #555; font-size: 10px; text-align: center; padding: 4px;">No Image</div>`;
          console.warn(`Artefak ${index}: image_url kosong`, a);
          return;
        }

        if (a.notation) {
          const notationEl = document.createElement('div');
          notationEl.className = 'artefak-notation';
          notationEl.textContent = a.notation;
          div.appendChild(notationEl);
        }

        div.onclick = () => {
          heroImg.src = a.image_url;
          heroNotationDisplay.textContent = a.notation || '';
          hidePostUploadPanel();
        };

        const img = new Image();
        img.src = a.image_url;
        img.onload = () => {
          console.log(`‚úÖ Gambar muat: ${a.image_url}`);
        };
        img.onerror = () => {
          console.error(`‚ùå Gambar gagal muat: ${a.image_url}`);
          div.style.backgroundColor = '#1a1a1a';
          div.style.backgroundImage = 'none';
          div.innerHTML = `<div style="color: #ff5555; font-size: 10px; text-align: center; padding: 4px;">Gagal Muat</div>`;
        };

        tray.appendChild(div);
      });
    }

    // === EMOJI REACTION LOGIC ===
    const EMOJI_LABELS = {
      'ü§†': 'Aku ngerti banget',
      'üò¢': 'Nangis bareng',
      'ü§ó': 'Peluk virtual',
      'üî•': 'Ini bikin kaget'
    };

    async function fetchReactionStats(rantId) {
      try {
        const data = await supabaseFetch('reactions', 'GET', null);
        const filtered = data.filter(r => r.rant_id === rantId);
        const stats = { 'ü§†': { count: 0, users: [] }, 'üò¢': { count: 0, users: [] }, 'ü§ó': { count: 0, users: [] }, 'üî•': { count: 0, users: [] } };
        filtered.forEach(row => {
          if (stats[row.emoji]) {
            stats[row.emoji].count++;
            if (stats[row.emoji].users.length < 3) {
              stats[row.emoji].users.push(row.user_id);
            }
          }
        });
        return stats;
      } catch (e) {
        console.error('Gagal ambil reaksi:', e);
        return { 'ü§†': { count: 0, users: [] }, 'üò¢': { count: 0, users: [] }, 'ü§ó': { count: 0, users: [] }, 'üî•': { count: 0, users: [] } };
      }
    }

    function showUserList(emoji, users) {
      const old = document.getElementById('reaction-modal');
      if (old) old.remove();
      if (users.length === 0) return;

      const modal = document.createElement('div');
      modal.id = 'reaction-modal';
      modal.style.cssText = `
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(10, 10, 10, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid #2a2a2a;
        border-radius: 12px;
        padding: 12px 16px;
        z-index: 1000;
        font-size: 13px;
        color: #f5f5f5;
        box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        max-width: 90%;
      `;
      const title = document.createElement('div');
      title.textContent = `${emoji} ${EMOJI_LABELS[emoji]}`;
      title.style.fontSize = '14px';
      title.style.fontWeight = '600';
      title.style.marginBottom = '6px';
      const userList = document.createElement('div');
      userList.textContent = users.map(u => `@${u}`).join(', ');
      userList.style.fontSize = '12px';
      userList.style.color = '#a0a0a0';
      modal.appendChild(title);
      modal.appendChild(userList);
      document.body.appendChild(modal);
      setTimeout(() => { if (modal.parentNode) modal.parentNode.removeChild(modal); }, 3000);
      modal.onclick = () => modal.remove();
    }

    // === UPLOAD ARTEFAK BARU ===
    async function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        alert('Hanya file gambar yang diperbolehkan!');
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        alert('Ukuran file maksimal 5MB!');
        return;
      }

      showConfirmation("Mengunggah...");
      const timestamp = Date.now();
      const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
      const cleanUsername = currentUser.replace(/^@/, '').replace(/\s+/g, '_');
      const fileName = `${cleanUsername}/${timestamp}-${safeName}`;

      try {
        const formData = new FormData();
        formData.append('', file);

        const uploadRes = await fetch(
          `${SUPABASE_URL}/storage/v1/object/artefacts/${fileName}`,
          {
            method: 'POST',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            },
            body: formData
          }
        );

        if (!uploadRes.ok) {
          const errorText = await uploadRes.text();
          throw new Error(`Upload gagal: ${errorText}`);
        }

        const imageUrl = `${SUPABASE_URL}/storage/v1/object/public/artefacts/${fileName}`;

        await supabaseFetch('artefacts', 'POST', {
          username: currentUser,
          image_url: imageUrl,
          notation: ''
        });

        showConfirmation("Gambar diunggah! Tambahkan notasi.");
        await loadData();
        showPostUploadPanel();

      } catch (e) {
        console.error('Upload error:', e);
        alert(e.message || 'Gagal mengunggah gambar.');
        showConfirmation("");
      }
    }

    // === SIMPAN NOTASI ===
    async function saveNotation() {
      const input = document.getElementById('hero-notation');
      const text = input.value.trim();

      if (!validateNotation(text)) {
        alert('Notasi harus 1‚Äì4 kata.');
        return;
      }

      if (artefacts.length === 0) {
        alert('Belum ada artefak.');
        return;
      }

      try {
        await supabaseFetch(`artefacts?id=eq.${artefacts[0].id}`, 'PATCH', {
          notation: text
        });

        showConfirmation("Notasi tersimpan.");
        await loadData();
        hidePostUploadPanel();

      } catch (e) {
        console.error('Notasi error:', e);
        alert(e.message || 'Gagal menyimpan notasi.');
      }
    }

    // === POST RANT ===
    async function postRant() {
      const textarea = document.getElementById('rant');
      const content = textarea.value.trim();

      if (!content) {
        alert('Jejak tidak boleh kosong!');
        return;
      }

      if (content.length > 300) {
        alert('Maksimal 300 huruf. Sekarang: ' + content.length + ' huruf.');
        return;
      }

      const btn = document.getElementById('jejakkan-btn');
      btn.disabled = true;
      btn.textContent = 'Menyimpan...';

      try {
        await supabaseFetch('rants', 'POST', {
          username: currentUser,
          content: content,
          zone: 'neutral'
        });

        textarea.value = '';
        showConfirmation('‚úÖ Jejakmu tersimpan!');
        await loadData();

      } catch (e) {
        console.error('Rant error:', e);
        alert('Gagal menyimpan jejak: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Jejakkan';
      }
    }

    // === NAVIGASI & LOGOUT ===
    function navigateTo(page) {
      window.location.href = page;
    }

    function logout() {
      if (confirm('Keluar dari akun?')) {
        localStorage.removeItem('nope_username');
        window.location.href = 'index.html';
      }
    }

    // === INIT LISTENERS ===
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('upload-artefak-btn').addEventListener('click', () => {
        document.getElementById('file-input').click();
      });
      document.getElementById('file-input').addEventListener('change', handleFileSelect);
      document.getElementById('save-notation-btn').addEventListener('click', saveNotation);
      document.getElementById('hero-notation').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') saveNotation();
      });
      document.getElementById('jejakkan-btn').addEventListener('click', postRant);
      document.getElementById('nav-jejak').addEventListener('click', () => navigateTo('jejak.html'));
      document.getElementById('nav-frekuensi').addEventListener('click', () => navigateTo('frekuensi.html'));
      document.getElementById('nav-saynope').addEventListener('click', () => navigateTo('saynope.html'));
      document.getElementById('nav-glitch').addEventListener('click', () => navigateTo('glitch.html'));
      document.getElementById('settings-btn').addEventListener('click', logout);

      // === PULSE ===
      const pulse = document.createElement('div');
      pulse.className = 'pulse-animation';
      document.body.appendChild(pulse);
      setTimeout(() => pulse.remove(), 1000);
      
      loadData();
    });
  </script>
</body>
</html>
