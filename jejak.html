<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>JEJAK ‚Äî Spill Your Truth</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* [CSS SAMA SEPERTI SEBELUMNYA - TIDAK BERUBAH] */
:root{
  --bg:#0A0A0A;
  --sf:#141414;
  --sfe:#1E1E1E;
  --bd:#2A2A2A;
  --tx:#FFF;
  --txs:#888;
  --txm:#555;
  --ap:#FF4D00;
  --as:#00F0FF;
  --at:#FF006E;
  --aq:#39FF14;
  --aw:#FFD700;
  --ms:#FF9500;
  --mt:#39FF14;
  --mc:#00F0FF;
  --md:#8B5CF6;
  --rd:#FF3333;
  --rd-dark:#990000;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:var(--bg);
  color:var(--tx);
  font-family:'Plus Jakarta Sans',sans-serif;
  font-weight:500;
  font-size:15px;
  min-height:100vh;
  padding-bottom:100px
}
.w{
  max-width:480px;
  margin:0 auto;
  padding:0 16px
}
/* ... semua CSS yang sama ... */
</style>
</head>
<body>
<div class="w">
<header>
  <div>
    <div class="logo" onclick="location.reload()">JEJAK</div>
    <div class="tagline">no filter, just truth</div>
  </div>
  <div class="top-right">
    <div class="huser" id="huser">@anon</div>
    <div class="dot off" id="odot"></div>
  </div>
</header>

<!-- HERO SECTION -->
<section class="hero-s">
  <div class="hero" id="hero">
    <img id="himg" src="https://images.unsplash.com/photo-1517842645767-c639042777db?w=400&q=80" alt="artefak">
    <div class="hnote" id="hnote">"jeda"</div>
    <div class="upctrls">
      <div class="qtimer" id="qtimer">Window aktif ‚Ä¢ Sisa 2 hari</div>
      <button class="upbtn" id="upbtn">+<span class="upcnt" id="ucnt" style="display:none"></span></button>
    </div>
  </div>
</section>

<!-- INPUT SECTION -->
<section class="isec">
  <div class="ihdr"><span class="ilbl">Spill your truth</span><span class="ccount" id="ccount">0/500</span></div>
  <textarea class="ri" id="ri" placeholder="What's eating you alive right now?" maxlength="500"></textarea>
  <div class="msec">
    <div class="mlbl">Pilih mood-mu sekarang</div>
    <div class="mgrid">
      <div class="mc act" data-mood="surviving" onclick="selMood('surviving')"><span class="me">üòÆ‚Äçüí®</span><span class="mn">Surviving</span></div>
      <div class="mc" data-mood="thriving" onclick="selMood('thriving')"><span class="me">‚ú®</span><span class="mn">Thriving</span></div>
      <div class="mc" data-mood="chaotic" onclick="selMood('chaotic')"><span class="me">üåÄ</span><span class="mn">Chaotic</span></div>
      <div class="mc" data-mood="doom" onclick="selMood('doom')"><span class="me">üõå</span><span class="mn">Doom</span></div>
    </div>
  </div>
  <div class="iact"><button class="sbtn" id="sbtn">Jejakkan & Spill</button></div>
</section>

<!-- RIWAYAT SECTION -->
<section>
  <div class="shdr">
    <span class="stit">Riwayat</span>
    <div class="sline"></div>
  </div>
  <div id="econ"></div>
</section>

<!-- MEMORI SECTION -->
<section style="margin-bottom:32px">
  <div class="shdr">
    <span class="stit">Memori</span>
    <div class="sline"></div>
  </div>
  <div class="tgrid" id="tgrid"></div>
</section>

<footer><p class="ftxt">Nyambat ‚Ä¢ Aksi ‚Ä¢ Solusi</p></footer>
</div>

<nav class="bnav">
  <div class="bnav-c">
    <a href="#" class="ni act"><span class="nico">‚ú¶</span><span>Jejak</span></a>
    <a href="#" class="ni"><span class="nico">‚úï</span><span>Spill</span></a>
  </div>
</nav>

<div class="proc" id="proc">
  <div class="pspin"></div>
  <div class="ptxt" id="proctxt">Processing...</div>
</div>

<!-- MODAL UPLOAD -->
<div class="modal" id="gmodal">
  <div class="mc2">
    <div class="mhdr"><h3 class="mtit">Upload Artefak</h3><button class="mcls" onclick="closeGallery()">√ó</button></div>
    <div class="ggrid" id="ggrid"></div>
    <div class="notsec">
      <input type="text" class="noti" id="noti" placeholder="Notasi (max 4 kata)" maxlength="30">
    </div>
    <div class="macts">
      <button class="mbtn" onclick="closeGallery()">Batal</button>
      <button class="mbtn pri" onclick="confirmUpload()">Konfirmasi (<span id="selcnt">0</span>)</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="finput" accept="image/*" multiple style="display:none">

<script>
// ============================================
// SUPABASE CONFIG
// ============================================
const SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const BUCKET = 'artefacts';

// ============================================
// STATE
// ============================================
const S = {
  user: localStorage.getItem('jejak_username') || '@anon',
  userId: localStorage.getItem('user_id') || 'user-' + Date.now(), // Generate dummy ID
  entries: [],
  artefacts: []
};

// Simpan user_id dummy
if (!localStorage.getItem('user_id')) {
  localStorage.setItem('user_id', S.userId);
}

// ============================================
// HELPER FUNCTIONS
// ============================================
const $ = id => document.getElementById(id);

function toast(msg, isError = false) {
  const t = $('toast');
  t.textContent = msg;
  t.style.background = isError ? 'var(--rd)' : 'var(--tx)';
  t.style.color = isError ? 'var(--tx)' : 'var(--bg)';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function esc(t) {
  const d = document.createElement('div');
  d.textContent = t;
  return d.innerHTML;
}

function showProc(msg) {
  $('proctxt').innerHTML = msg || 'Processing...';
  $('proc').classList.add('on');
}

function hideProc() {
  $('proc').classList.remove('on');
}

function selMood(mood) {
  document.querySelectorAll('.mc').forEach(c => 
    c.classList.toggle('act', c.dataset.mood === mood)
  );
}

// ============================================
// LOAD DATA
// ============================================
async function loadRants() {
  try {
    const { data, error } = await supabase
      .from('rants')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(10);
    
    if (error) throw error;
    S.entries = data || [];
  } catch (e) {
    console.error('Load rants error:', e);
    S.entries = [];
  }
  renderEntries();
}

async function loadArtefacts() {
  try {
    const { data, error } = await supabase
      .from('artefacts')
      .select('*')
      .eq('user_id', S.userId)
      .order('created_at', { ascending: false })
      .limit(6);
    
    if (error) throw error;
    S.artefacts = data || [];
  } catch (e) {
    console.error('Load artefacts error:', e);
    S.artefacts = [];
  }
  renderTray();
}

// ============================================
// RENDER
// ============================================
function renderEntries() {
  const container = $('econ');
  if (!container) return;
  
  if (!S.entries.length) {
    container.innerHTML = '<div class="es"><span class="ee">üçÉ</span><div class="et">Belum ada jejak</div></div>';
    return;
  }
  
  container.innerHTML = S.entries.map(e => `
    <article class="entry">
      <div class="ehdr">
        <div class="emeta">
          <span class="etime">${new Date(e.created_at).toLocaleString('id-ID')}</span>
          <span class="emood ${e.mood}">${e.mood}</span>
        </div>
        <span class="fifo-i">@${e.username}</span>
      </div>
      <div class="econt">${esc(e.content)}</div>
    </article>
  `).join('');
}

function renderTray() {
  const container = $('tgrid');
  if (!container) return;
  
  if (!S.artefacts.length) {
    container.innerHTML = '<div class="ti empty" onclick="$(\'upbtn\').click()">+</div>'.repeat(6);
    return;
  }
  
  let html = S.artefacts.map(a => `
    <div class="ti" onclick="setHero('${a.id}')">
      <img src="${a.url}" alt="${a.note || 'memory'}">
      ${a.has_face ? '<div class="sensored-overlay"><span>SENSORED</span></div>' : ''}
    </div>
  `).join('');
  
  // Tambah placeholder
  for (let i = S.artefacts.length; i < 6; i++) {
    html += '<div class="ti empty" onclick="$(\'upbtn\').click()">+</div>';
  }
  
  container.innerHTML = html;
}

function setHero(id) {
  const artefact = S.artefacts.find(a => a.id === id);
  if (!artefact) return;
  
  $('himg').src = artefact.url;
  $('hnote').textContent = `"${artefact.note || 'memory'}"`;
}

// ============================================
// UPLOAD
// ============================================
let uploads = parseInt(localStorage.getItem('jejak_uploads') || '0');
let quotaStart = localStorage.getItem('jejak_quota_start') || Date.now();
let pendingFiles = [];
let selectedIndexes = new Set();

function initUpload() {
  $('upbtn').onclick = () => {
    if (uploads >= 6) {
      toast('Quota habis (max 6 foto per 3 hari)');
      return;
    }
    $('finput').click();
  };
  
  $('finput').onchange = handleFiles;
}

async function handleFiles(e) {
  const files = Array.from(e.target.files).slice(0, 6);
  if (!files.length) return;
  
  pendingFiles = files.map(f => ({
    file: f,
    preview: URL.createObjectURL(f)
  }));
  
  selectedIndexes = new Set(pendingFiles.map((_, i) => i));
  openGallery();
}

function openGallery() {
  const grid = $('ggrid');
  grid.innerHTML = '';
  
  pendingFiles.forEach((file, i) => {
    const div = document.createElement('div');
    div.className = 'gi sel';
    div.innerHTML = `<img src="${file.preview}">`;
    div.onclick = () => {
      if (selectedIndexes.has(i)) {
        selectedIndexes.delete(i);
        div.classList.remove('sel');
      } else {
        selectedIndexes.add(i);
        div.classList.add('sel');
      }
      $('selcnt').textContent = selectedIndexes.size;
    };
    grid.appendChild(div);
  });
  
  $('selcnt').textContent = selectedIndexes.size;
  $('gmodal').classList.add('on');
}

function closeGallery() {
  $('gmodal').classList.remove('on');
  pendingFiles = [];
  selectedIndexes.clear();
}

async function confirmUpload() {
  if (!selectedIndexes.size) {
    toast('Pilih minimal 1 foto');
    return;
  }
  
  closeGallery();
  showProc('Uploading...');
  
  const note = $('noti').value.trim() || 'memory';
  const username = S.user.replace('@', '');
  let success = 0;
  
  for (const i of selectedIndexes) {
    const file = pendingFiles[i].file;
    const fileName = `${username}/${Date.now()}_${i}.${file.name.split('.').pop() || 'jpg'}`;
    
    try {
      // Upload ke storage
      const { error: uploadError } = await supabase.storage
        .from(BUCKET)
        .upload(fileName, file);
      
      if (uploadError) throw uploadError;
      
      // Dapatkan URL
      const { data: { publicUrl } } = supabase.storage
        .from(BUCKET)
        .getPublicUrl(fileName);
      
      // Insert ke database
      const { error: insertError } = await supabase
        .from('artefacts')
        .insert({
          user_id: S.userId,
          username: username,
          url: publicUrl,
          note: note,
          has_face: false,
          faces: []
        });
      
      if (insertError) throw insertError;
      
      success++;
      
    } catch (err) {
      console.error('Upload error:', err);
    }
  }
  
  hideProc();
  
  if (success > 0) {
    uploads += success;
    localStorage.setItem('jejak_uploads', uploads.toString());
    await loadArtefacts();
    if (S.artefacts.length) setHero(S.artefacts[0].id);
    toast(`‚úì ${success} foto berhasil diupload!`);
  } else {
    toast('‚úó Gagal upload', true);
  }
}

// ============================================
// INIT
// ============================================
document.addEventListener('DOMContentLoaded', async () => {
  // Tampilkan username
  $('huser').textContent = S.user;
  
  // Load data
  await loadRants();
  await loadArtefacts();
  
  // Init upload
  initUpload();
  
  // Textarea counter
  const ri = $('ri');
  const cc = $('ccount');
  ri.oninput = () => {
    cc.textContent = `${ri.value.length}/500`;
  };
  
  // Submit button
  $('sbtn').onclick = async () => {
    const content = ri.value.trim();
    if (!content) {
      toast('Tulis sesuatu...');
      return;
    }
    
    const mood = document.querySelector('.mc.act')?.dataset.mood || 'surviving';
    const btn = $('sbtn');
    
    btn.disabled = true;
    btn.textContent = 'Menyimpan...';
    
    try {
      const { error } = await supabase
        .from('rants')
        .insert({
          user_id: S.userId,
          username: S.user.replace('@', ''),
          content: content,
          mood: mood,
          reaction_count: { skull: 0, cry: 0, fire: 0, upside: 0 }
        });
      
      if (error) throw error;
      
      await loadRants();
      ri.value = '';
      cc.textContent = '0/500';
      toast('‚úì Tersimpan!');
      
    } catch (err) {
      console.error(err);
      toast('‚úó Gagal: ' + err.message, true);
    } finally {
      btn.disabled = false;
      btn.textContent = 'Jejakkan & Spill';
    }
  };
  
  // Update quota display
  function updQuota() {
    const now = Date.now();
    const windowDays = 3 * 86400000;
    const rem = Math.max(0, windowDays - (now - parseInt(quotaStart)));
    const days = Math.ceil(rem / 86400000);
    $('qtimer').textContent = `Window aktif ‚Ä¢ ${days} hari ‚Ä¢ ${6-uploads} slot`;
    $('ucnt').textContent = uploads;
    $('ucnt').style.display = uploads > 0 ? 'block' : 'none';
  }
  
  updQuota();
  setInterval(updQuota, 60000);
});
</script>
</body>
</html>
