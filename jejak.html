<!DOCTYPE html>
<html>
<head>
    <title>JEJAK - UPLOAD TEST MINIMAL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="font-family: monospace; padding: 20px; background: #000; color: #0f0;">

<h2>üöÄ JEJAK - UPLOAD TEST MINIMAL</h2>

<button id="btnTest" style="padding: 10px 20px; background: #FF4D00; border: none; font-weight: bold; cursor: pointer;">TEST KONEKSI</button>
<button id="btnUpload" style="padding: 10px 20px; background: #39FF14; border: none; font-weight: bold; cursor: pointer;">PILIH FOTO</button>
<button id="btnCek" style="padding: 10px 20px; background: #00F0FF; border: none; font-weight: bold; cursor: pointer;">CEK DATABASE</button>

<div style="margin: 20px 0; padding: 10px; background: #111; border: 1px solid #333; min-height: 200px; font-size: 12px;" id="log"></div>

<input type="file" id="fileInput" accept="image/*" multiple style="display: none;">

<script>
// ============================================
// SUPABASE CONFIG
// ============================================
const SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const BUCKET = 'artefacts';

// ============================================
// DOM
// ============================================
const logEl = document.getElementById('log');
const btnTest = document.getElementById('btnTest');
const btnUpload = document.getElementById('btnUpload');
const btnCek = document.getElementById('btnCek');
const fileInput = document.getElementById('fileInput');

function addLog(msg, type = 'info') {
    const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : '#0ff';
    logEl.innerHTML += `<div style="color: ${color}; margin: 5px 0;">> ${msg}</div>`;
    console.log(msg);
}

// ============================================
// TEST 1: KONEKSI
// ============================================
btnTest.onclick = async () => {
    addLog('üîç TEST KONEKSI...');
    
    try {
        // Test 1: Cek bucket
        addLog('‚Üí Cek bucket...');
        const { data: buckets, error: bucketError } = await supabase.storage.listBuckets();
        
        if (bucketError) {
            addLog(`‚ùå Bucket error: ${bucketError.message}`, 'error');
        } else {
            const bucketExists = buckets.find(b => b.name === BUCKET);
            addLog(`‚úì Bucket ditemukan: ${bucketExists ? 'YES' : 'NO'}`, bucketExists ? 'success' : 'error');
        }
        
        // Test 2: Cek tabel
        addLog('‚Üí Cek tabel artefacts...');
        const { error: tableError } = await supabase.from('artefacts').select('count', { count: 'exact', head: true });
        
        if (tableError) {
            addLog(`‚ùå Tabel error: ${tableError.message}`, 'error');
        } else {
            addLog('‚úì Tabel artefacts OK', 'success');
        }
        
    } catch (e) {
        addLog(`‚ùå Exception: ${e.message}`, 'error');
    }
};

// ============================================
// TEST 2: UPLOAD
// ============================================
btnUpload.onclick = () => {
    addLog('üìÇ Pilih file...');
    fileInput.click();
};

fileInput.onchange = async (e) => {
    const files = Array.from(e.target.files);
    if (!files.length) return;
    
    addLog(`üì∏ ${files.length} file dipilih`);
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        addLog(`\nüì§ Upload file ${i+1}: ${file.name} (${(file.size/1024).toFixed(1)}KB)`);
        
        try {
            // Step 1: Upload ke storage
            const fileName = `test-${Date.now()}-${i}.${file.name.split('.').pop() || 'jpg'}`;
            addLog(`‚Üí Upload ke: ${BUCKET}/${fileName}`);
            
            const { error: uploadError } = await supabase.storage
                .from(BUCKET)
                .upload(fileName, file);
            
            if (uploadError) {
                addLog(`‚ùå Upload gagal: ${uploadError.message}`, 'error');
                continue;
            }
            addLog(`‚úì Upload sukses`, 'success');
            
            // Step 2: Get URL
            const { data: { publicUrl } } = supabase.storage
                .from(BUCKET)
                .getPublicUrl(fileName);
            addLog(`‚Üí URL: ${publicUrl.substring(0, 50)}...`);
            
            // Step 3: Insert database
            addLog(`‚Üí Insert ke database...`);
            const { error: insertError } = await supabase
                .from('artefacts')
                .insert({
                    user_id: 'test-user',
                    username: 'tester',
                    url: publicUrl,
                    note: 'test upload',
                    has_face: false,
                    faces: []
                });
            
            if (insertError) {
                addLog(`‚ùå Insert gagal: ${insertError.message}`, 'error');
            } else {
                addLog(`‚úì Insert sukses`, 'success');
            }
            
        } catch (err) {
            addLog(`‚ùå Error: ${err.message}`, 'error');
        }
    }
    
    addLog('\n‚úÖ Selesai');
};

// ============================================
// TEST 3: CEK DATABASE
// ============================================
btnCek.onclick = async () => {
    addLog('üîç CEK DATABASE...');
    
    try {
        const { data, error } = await supabase
            .from('artefacts')
            .select('*')
            .limit(5);
        
        if (error) {
            addLog(`‚ùå Error: ${error.message}`, 'error');
        } else {
            addLog(`‚úì Total data: ${data.length}`);
            data.forEach((item, i) => {
                addLog(`  ${i+1}. ${item.note || 'no note'} - ${item.url?.substring(0, 30)}...`);
            });
        }
    } catch (e) {
        addLog(`‚ùå Exception: ${e.message}`, 'error');
    }
};

addLog('‚úÖ READY - Klik tombol TEST KONEKSI dulu');
</script>
</body>
</html>
