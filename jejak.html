<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>JEJAK ‚Äî Spill Your Truth</title>
<link rel="preconnect" href="https://fonts.googleapis.com ">
<link rel="preconnect" href="https://fonts.gstatic.com " crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0 ;1&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Caveat:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0A0A0A;--sf:#141414;--sfe:#1E1E1E;--bd:#2A2A2A;--tx:#FFF;--txs:#888;--txm:#555;--ap:#FF4D00;--as:#00F0FF;--at:#FF006E;--aq:#39FF14;--aw:#FFD700;--ms:#FF9500;--mt:#39FF14;--mc:#00F0FF;--md:#8B5CF6;--rd:#FF3333;--rd-dark:#990000;--secret:#FF006E}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--tx);font-family:'Plus Jakarta Sans',system-ui,sans-serif;font-weight:500;font-size:15px;line-height:1.4;min-height:100vh;overflow-x:hidden;padding-bottom:100px}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg '%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:.4}
.w{max-width:480px;margin:0 auto;padding:0 16px}
header{padding:24px 0 16px;display:flex;justify-content:space-between;align-items:flex-start}
.logo{font-size:42px;font-weight:800;letter-spacing:-.04em;cursor:pointer;line-height:.9;position:relative}
.logo::before,.logo::after{content:'JEJAK';position:absolute;top:0;left:0;opacity:0;transition:opacity .1s}
.logo::before{color:var(--as);transform:translate(-2px,0)}
.logo::after{color:var(--at);transform:translate(2px,0)}
.logo:hover::before{opacity:.8;animation:g .3s infinite}
@keyframes g{0%,100%{transform:translate(-2px,0)}25%{transform:translate(2px,2px)}50%{transform:translate(-2px,-2px)}75%{transform:translate(2px,0)}}
.tagline{font-family:'Instrument Serif',serif;font-size:13px;color:var(--txs);font-style:italic;margin-top:4px}
.top-right{display:flex;align-items:center;gap:8px}
.huser{font-size:11px;font-weight:700;color:var(--tx);text-transform:lowercase;letter-spacing:.05em;padding:4px 8px;background:var(--sf);border:1px solid var(--bd);max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dot{width:8px;height:8px;background:var(--aq);border-radius:50%;animation:blink 2s infinite;flex-shrink:0}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.dot.off{background:var(--at);animation:none}
.smenu{position:relative}
.mtrig{width:32px;height:32px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;background:transparent;border:none;cursor:pointer;padding:0}
.mtrig span{width:4px;height:4px;background:var(--tx);border-radius:50%;transition:all .2s}
.mtrig:hover span{background:var(--ap)}
.mdd{position:absolute;top:100%;right:0;margin-top:8px;background:var(--sf);border:2px solid var(--bd);min-width:120px;display:none;z-index:100}
.mdd.on{display:block}
.mi{width:100%;padding:8px 16px;background:transparent;border:none;color:var(--tx);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;text-align:left;cursor:pointer;transition:all .2s}
.mi:hover{background:var(--sfe);color:var(--ap)}
.bnav{position:fixed;bottom:0;left:0;right:0;background:var(--sf);border-top:2px solid var(--bd);z-index:1000;padding-bottom:env(safe-area-inset-bottom)}
.bnav-c{max-width:480px;margin:0 auto;display:flex;justify-content:space-around;align-items:center;height:64px}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;height:100%;color:var(--txm);text-decoration:none;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;transition:all .2s;position:relative;cursor:pointer}
.ni::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:0;height:2px;background:var(--ap);transition:width .2s}
.ni:hover{color:var(--txs);background:var(--sfe)}
.ni.act{color:var(--ap)}
.ni.act::before{width:100%}
.nico{font-size:20px;line-height:1}
.hero-s{position:relative;margin:0 -16px 24px}
.hero{position:relative;width:100%;aspect-ratio:1/1;overflow:hidden;border-top:2px solid var(--bd);border-bottom:2px solid var(--bd);background:var(--sf)}
.hero img{width:100%;height:100%;object-fit:cover;transition:transform .6s,filter .3s}
.hero:hover img{transform:scale(1.03)}
.hero::after{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.03) 2px,rgba(0,0,0,.03) 4px);pointer-events:none}
.hnote{position:absolute;bottom:0;left:0;right:0;padding:16px;background:linear-gradient(to top,rgba(0,0,0,.9),transparent);font-family:'Instrument Serif',serif;font-size:24px;font-style:italic;color:var(--tx);line-height:1.2;z-index:20}
.upctrls{position:absolute;top:16px;right:16px;display:flex;flex-direction:column;gap:8px;align-items:flex-end;z-index:20}
.upbtn{width:48px;height:48px;background:var(--ap);border:none;color:var(--bg);font-size:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;box-shadow:4px 4px 0 var(--bg),4px 4px 0 2px var(--ap);position:relative}
.upbtn:hover:not(:disabled){transform:translate(2px,2px);box-shadow:2px 2px 0 var(--bg),2px 2px 0 2px var(--ap)}
.upbtn:disabled{background:var(--txm);box-shadow:none;cursor:not-allowed;opacity:.6}
.upcnt{position:absolute;top:-8px;right:-8px;background:var(--at);color:var(--tx);font-size:10px;font-weight:700;padding:2px 6px;min-width:20px;text-align:center}
.qtimer{position:absolute;top:calc(100% + 8px);right:0;background:var(--sf);border:2px solid var(--bd);padding:8px 16px;font-size:11px;color:var(--txs);white-space:nowrap;opacity:0;visibility:hidden;transition:all .2s;z-index:30}
.qtimer::before{content:'';position:absolute;bottom:100%;right:16px;border:6px solid transparent;border-bottom-color:var(--bd)}
.upctrls:hover .qtimer{opacity:1;visibility:visible}
.qtimer.urg{border-color:var(--at);color:var(--at);animation:pb 2s infinite}
@keyframes pb{0%,100%{border-color:var(--at)}50%{border-color:var(--txm)}}
.isec{margin-bottom:32px}
.ihdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.ilbl{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--txs)}
.ccount{font-size:12px;color:var(--txm);font-variant-numeric:tabular-nums}
.ri{width:100%;background:var(--sf);border:2px solid var(--bd);padding:16px;color:var(--tx);font-family:'Plus Jakarta Sans',sans-serif;font-size:16px;line-height:1.5;resize:none;min-height:120px;transition:all .2s}
.ri:focus{outline:none;border-color:var(--ap);background:var(--sfe)}
.ri::placeholder{color:var(--txm)}
.msec{margin:16px 0}
.mlbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--txs);margin-bottom:8px}
.mgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.mc{position:relative;padding:16px;background:var(--sf);border:2px solid var(--bd);cursor:pointer;transition:all .2s;display:flex;flex-direction:column;gap:4px}
.mc:hover{border-color:var(--txs);transform:translateY(-2px)}
.mc.act{border-color:currentColor;background:var(--sfe)}
.mc.act::before{content:'‚úì';position:absolute;top:8px;right:8px;font-size:12px;font-weight:700}
.me{font-size:28px;line-height:1}
.mn{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:.05em}
.md-desc{font-size:11px;color:var(--txs)}
.mc[data-mood="surviving"]{color:var(--ms)}
.mc[data-mood="thriving"]{color:var(--mt)}
.mc[data-mood="chaotic"]{color:var(--mc)}
.mc[data-mood="doom"]{color:var(--md)}
.iact{display:flex;justify-content:flex-end;margin-top:16px}
.sbtn{padding:14px 32px;font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;background:var(--ap);border:none;color:var(--bg);cursor:pointer;transition:all .2s;box-shadow:4px 4px 0 var(--sfe),4px 4px 0 2px var(--ap)}
.sbtn:hover:not(:disabled){transform:translate(2px,2px);box-shadow:2px 2px 0 var(--sfe),2px 2px 0 2px var(--ap)}
.sbtn:disabled{opacity:.5;cursor:not-allowed;box-shadow:none}
.shdr{display:flex;align-items:center;gap:8px;margin-bottom:16px;padding-bottom:8px;border-bottom:2px solid var(--bd)}
.stit{font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:.15em;color:var(--tx)}
.sline{flex:1;height:2px;background:var(--bd)}
.entry{background:var(--sf);border:2px solid var(--bd);margin-bottom:16px;position:relative;animation:si .4s ease}
@keyframes si{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.entry:hover{border-color:var(--ap)}
.ehdr{display:flex;justify-content:space-between;align-items:center;padding:8px 16px;border-bottom:1px solid var(--bd);background:var(--sfe)}
.emeta{display:flex;align-items:center;gap:8px}
.etime{font-size:11px;color:var(--txm);font-weight:600;letter-spacing:.05em}
.emood{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;padding:4px 8px;border:1px solid currentColor}
.emood.surviving{color:var(--ms)}
.emood.thriving{color:var(--mt)}
.emood.chaotic{color:var(--mc)}
.emood.doom{color:var(--md)}
.econt{padding:16px;font-size:15px;line-height:1.6;color:var(--tx)}
.tgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:2px;background:var(--bd);border:2px solid var(--bd);margin-bottom:16px}
.ti{aspect-ratio:1;background:var(--sf);position:relative;overflow:hidden;cursor:pointer}
.ti.empty{display:flex;align-items:center;justify-content:center;color:var(--txm);font-size:20px;border:2px dashed var(--bd)}
.ti img{width:100%;height:100%;object-fit:cover;transition:all .3s}
.ti:hover img{transform:scale(1.1)}
.ti::after{content:'';position:absolute;inset:0;background:var(--ap);opacity:0;transition:opacity .2s;mix-blend-mode:multiply}
.ti:hover::after{opacity:.3}
.entry-dummy{opacity:.6;border-style:dashed!important}
.entry-dummy:hover{border-color:var(--bd)!important;opacity:.75}
.reaction-bar{display:flex;gap:6px;padding:10px 16px;border-top:1px solid var(--bd);background:var(--sfe);align-items:center;flex-wrap:wrap}
.reaction-btn{position:relative;display:flex;align-items:center;gap:4px;padding:5px 10px;background:var(--sf);border:2px solid var(--bd);cursor:pointer;transition:all .15s;border-radius:4px;font-family:inherit}
.reaction-btn:hover:not([disabled]){border-color:var(--txs);transform:translateY(-2px);background:var(--sfe)}
.reaction-btn.act{border-color:var(--ap);background:var(--ap)}
.reaction-btn[disabled]{cursor:not-allowed;opacity:.38;pointer-events:none}
.remoji{font-size:17px;line-height:1}
.rcount{font-size:11px;font-weight:700;color:var(--txs);min-width:14px;text-align:center;font-variant-numeric:tabular-nums}
.reaction-btn.act .rcount{color:#000}
.fifo-i{font-size:9px;color:var(--txm);text-transform:uppercase;letter-spacing:.05em;padding:2px 6px;border:1px solid var(--bd)}
.es{padding:32px 16px;text-align:center;border:2px dashed var(--bd)}
.ee{font-size:48px;margin-bottom:16px;display:block;animation:fl 3s ease-in-out infinite}
@keyframes fl{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.et{font-family:'Instrument Serif',serif;font-size:20px;font-style:italic;color:var(--txs);margin-bottom:8px}
.est{font-size:13px;color:var(--txm)}
footer{padding:32px 0;text-align:center;border-top:2px solid var(--bd);margin-bottom:80px}
.ftxt{font-size:11px;color:var(--txm);text-transform:uppercase;letter-spacing:.2em}
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--tx);color:var(--bg);padding:8px 16px;font-size:13px;font-weight:600;z-index:10000;opacity:0;transition:all .3s}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.proc{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:10002;display:none;flex-direction:column;align-items:center;justify-content:center;gap:16px}
.proc.on{display:flex}
.pspin{width:48px;height:48px;border:3px solid var(--bd);border-top-color:var(--ap);border-radius:50%;animation:sp 1s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.ptxt{font-size:14px;color:var(--txs);text-align:center}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:10001;padding:16px;overflow-y:auto}
.modal.on{display:block}
.mc2{max-width:480px;margin:0 auto;background:var(--sf);border:2px solid var(--bd);padding:24px}
.mhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:16px;border-bottom:2px solid var(--bd)}
.mtit{font-size:18px;font-weight:800;text-transform:uppercase;letter-spacing:.05em}
.mcls{background:none;border:none;color:var(--tx);font-size:24px;cursor:pointer}
.ggrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.gi{aspect-ratio:1;background:var(--sfe);border:2px solid var(--bd);cursor:pointer;overflow:hidden;position:relative}
.gi img{width:100%;height:100%;object-fit:cover;transition:all .2s}
.gi:hover img{transform:scale(1.05)}
.gi.sel{border-color:var(--ap);box-shadow:0 0 0 2px var(--ap)}
.gi.sel::after{content:'‚úì';position:absolute;top:4px;right:4px;background:var(--ap);color:var(--bg);width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700}
.tmsec{margin:16px 0;padding:16px;background:var(--sfe);border:2px solid var(--bd)}
.tmhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.tmlbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--txs)}
.tmnm{font-size:11px;font-weight:700;color:var(--ap)}
.tmsl{width:100%;height:4px;background:var(--bd);outline:none;-webkit-appearance:none;margin:8px 0}
.tmsl::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;background:var(--ap);cursor:pointer;border:2px solid var(--tx);box-shadow:2px 2px 0 var(--bg)}
.tmlabs{display:flex;justify-content:space-between;font-size:9px;color:var(--txm);font-weight:600;text-transform:uppercase}
.notsec{margin:16px 0;padding:16px;background:var(--sfe);border:2px solid var(--bd)}
.notlbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--txs);margin-bottom:8px;display:flex;justify-content:space-between}
.notcnt{font-size:10px;color:var(--txm)}
.noti{width:100%;background:var(--sf);border:2px solid var(--bd);padding:8px;color:var(--tx);font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;transition:all .2s}
.noti:focus{outline:none;border-color:var(--ap);background:var(--sfe)}
.noti::placeholder{color:var(--txm);font-size:12px}
.gwarn{background:var(--at);color:var(--tx);padding:16px;margin-bottom:16px;font-size:13px;font-weight:700;text-align:center;text-transform:uppercase;letter-spacing:.05em;border:2px solid var(--at);animation:pw 2s infinite}
@keyframes pw{0%,100%{opacity:1}50%{opacity:.8}}
.gwarn::before{content:'üö´ '}
.macts{margin-top:16px;display:flex;justify-content:flex-end;gap:8px}
.mbtn{padding:12px 24px;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;border:2px solid var(--bd);background:var(--sf);color:var(--tx);cursor:pointer;transition:all .2s}
.mbtn.pri{background:var(--ap);border-color:var(--ap);color:var(--bg)}
.mbtn:hover{transform:translateY(-2px)}
.fm{filter:grayscale(100%) contrast(1.1)!important}
.fsp{filter:sepia(100%) contrast(1.1) saturate(.8)!important}
.fl{filter:contrast(1.2) saturate(1.3) brightness(.9)!important}
.fv{filter:grayscale(100%) contrast(1.2) brightness(.9)!important}
.fn{filter:grayscale(100%) contrast(1.4) brightness(.8)!important}
.fc{filter:hue-rotate(180deg) saturate(1.5) contrast(1.1)!important}
.fw{filter:sepia(60%) hue-rotate(-30deg) saturate(1.2)!important}
.fco{filter:hue-rotate(180deg) saturate(.5) brightness(1.1)!important}
.fd{filter:blur(.5px) saturate(1.4) brightness(1.1) contrast(.9)!important}
.fcr{filter:contrast(1.3) saturate(1.1)!important}
.fmo{filter:brightness(.8) contrast(1.2) saturate(.7)!important}
.fg{filter:sepia(40%) hue-rotate(-15deg) saturate(1.3) contrast(1.1)!important}
.sensored-overlay{position:absolute;inset:0;background:#000;display:flex;align-items:center;justify-content:center;color:#FF0000;font-size:14px;font-weight:800;text-transform:uppercase;letter-spacing:2px;border:2px solid #FF0000;animation:pulse-sensor 2s infinite;z-index:25}
@keyframes pulse-sensor{0%,100%{opacity:0.9}50%{opacity:1;box-shadow:inset 0 0 30px #FF0000}}
.sensored-text{transform:rotate(-5deg);border:2px solid #FF0000;padding:4px 8px;background:rgba(0,0,0,0.8)}
.premium-badge{display:inline-block;background:linear-gradient(135deg,var(--ap),var(--at));color:var(--tx);font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;margin-left:8px;text-transform:uppercase}

/* ============================================
   SECRET CHAT STYLES - PREMIUM FEATURE
   ============================================ */
.secret-section{margin:24px 0;padding:20px;background:linear-gradient(145deg,var(--sf),#1a0a0a);border:2px solid var(--secret);position:relative;overflow:hidden}
.secret-section::before{content:'üîí';position:absolute;top:10px;right:10px;font-size:24px;opacity:0.3}
.secret-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.secret-icon{width:40px;height:40px;background:var(--secret);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;animation:pulse-secret 2s infinite}
@keyframes pulse-secret{0%,100%{box-shadow:0 0 0 0 rgba(255,0,110,0.4)}50%{box-shadow:0 0 20px 5px rgba(255,0,110,0.2)}}
.secret-title{font-size:16px;font-weight:800;text-transform:uppercase;letter-spacing:.05em;color:var(--secret)}
.secret-desc{font-size:11px;color:var(--txs);margin-top:2px}
.secret-input{width:100%;background:rgba(255,0,110,0.1);border:2px solid var(--secret);padding:12px;color:var(--tx);font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;margin-bottom:12px;transition:all .2s}
.secret-input:focus{outline:none;background:rgba(255,0,110,0.2);box-shadow:0 0 20px rgba(255,0,110,0.3)}
.secret-textarea{width:100%;background:rgba(255,0,110,0.1);border:2px solid var(--secret);padding:12px;color:var(--tx);font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;min-height:100px;resize:none;margin-bottom:12px;transition:all .2s}
.secret-textarea:focus{outline:none;background:rgba(255,0,110,0.2);box-shadow:0 0 20px rgba(255,0,110,0.3)}
.secret-btn{width:100%;padding:14px;background:var(--secret);border:none;color:var(--tx);font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.secret-btn:hover:not(:disabled){background:#ff1a8c;box-shadow:0 0 30px rgba(255,0,110,0.5)}
.secret-btn:disabled{opacity:0.5;cursor:not-allowed}
.secret-btn.sending::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);animation:shimmer 1s infinite}
@keyframes shimmer{to{left:100%}}

/* Secret Message Viewer */
.secret-viewer{position:fixed;inset:0;background:rgba(0,0,0,0.98);z-index:10003;display:none;flex-direction:column;align-items:center;justify-content:center;padding:24px}
.secret-viewer.on{display:flex}
.secret-viewer-content{max-width:480px;width:100%;background:var(--sf);border:3px solid var(--secret);padding:24px;position:relative;animation:glitch-in 0.3s ease}
@keyframes glitch-in{0%{transform:scale(0.9);opacity:0}50%{transform:scale(1.02)}100%{transform:scale(1);opacity:1}}
.secret-warning{background:var(--secret);color:var(--tx);padding:12px;text-align:center;font-size:11px;font-weight:700;text-transform:uppercase;margin:-24px -24px 16px -24px}
.secret-timer{font-size:48px;font-weight:800;color:var(--secret);text-align:center;margin:24px 0;font-family:'Instrument Serif',serif;text-shadow:0 0 20px rgba(255,0,110,0.5)}
.secret-message{font-size:18px;line-height:1.6;color:var(--tx);text-align:center;padding:24px;background:rgba(255,0,110,0.05);border:1px dashed var(--secret);margin-bottom:16px;word-break:break-word}
.secret-sender{text-align:center;font-size:12px;color:var(--txs);margin-bottom:24px}
.secret-progress{width:100%;height:4px;background:var(--bd);margin-bottom:24px;position:relative;overflow:hidden}
.secret-progress-bar{height:100%;background:var(--secret);width:100%;transition:width 0.1s linear}
.secret-close{width:100%;padding:12px;background:transparent;border:2px solid var(--secret);color:var(--secret);font-size:12px;font-weight:700;text-transform:uppercase;cursor:pointer;transition:all .2s}
.secret-close:hover{background:var(--secret);color:var(--tx)}
.secret-destroyed{text-align:center;padding:48px 24px}
.secret-destroyed-icon{font-size:64px;margin-bottom:16px;display:block;animation:burn 1s ease forwards}
@keyframes burn{0%{transform:scale(1);filter:brightness(1)}50%{transform:scale(1.2);filter:brightness(2) hue-rotate(30deg)}100%{transform:scale(0);opacity:0;filter:brightness(3) hue-rotate(60deg)}}
.secret-destroyed-text{font-size:18px;font-weight:700;color:var(--secret);text-transform:uppercase;letter-spacing:.1em}

/* Screenshot Protection */
.secret-viewer::before{content:'';position:fixed;inset:0;background:transparent;z-index:10004;pointer-events:none}
.secret-message{user-select:none;-webkit-user-select:none}

/* Secret Inbox */
.secret-inbox{margin-top:16px}
.secret-item{display:flex;align-items:center;gap:12px;padding:12px;background:var(--sfe);border:1px solid var(--bd);margin-bottom:8px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.secret-item:hover{border-color:var(--secret);background:rgba(255,0,110,0.1)}
.secret-item::before{content:'üîí';font-size:16px}
.secret-item.unread::after{content:'';position:absolute;top:8px;right:8px;width:8px;height:8px;background:var(--secret);border-radius:50%;animation:pulse-secret 2s infinite}
.secret-item-info{flex:1}
.secret-item-from{font-size:12px;font-weight:700;color:var(--tx)}
.secret-item-preview{font-size:11px;color:var(--txs);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px}
.secret-item-time{font-size:10px;color:var(--txm)}
.secret-empty{text-align:center;padding:32px;color:var(--txs);font-size:13px}

/* Locked State */
.secret-locked{position:relative;opacity:0.5;pointer-events:none}
.secret-locked::after{content:'üîí PREMIUM';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--secret);color:var(--tx);padding:8px 16px;font-size:12px;font-weight:700;border-radius:4px}
</style>
</head>
<body>
<div class="w">
<header>
  <div>
    <div class="logo" onclick="location.reload()">JEJAK</div>
    <div class="tagline">no filter, just truth</div>
  </div>
  <div class="top-right">
    <div class="huser" id="huser">@anon</div>
    <div class="dot off" id="odot"></div>
    <div class="smenu">
      <button class="mtrig" onclick="toggleMenu()"><span></span><span></span><span></span></button>
      <div class="mdd" id="mdd"><button class="mi" onclick="logoutUser()">Logout</button></div>
    </div>
  </div>
</header>

<section class="hero-s">
  <div class="hero" id="hero">
    <img id="himg" src="https://images.unsplash.com/photo-1517842645767-c639042777db?w=400&q=80 " alt="artefak" class="fm">
    <div class="hnote" id="hnote">"jeda"</div>
    <div class="upctrls">
      <div class="qtimer" id="qtimer">Window aktif ‚Ä¢ Sisa 2 hari</div>
      <button class="upbtn" id="upbtn">+<span class="upcnt" id="ucnt" style="display:none"></span></button>
    </div>
  </div>
</section>

<section class="isec">
  <div class="ihdr"><span class="ilbl">Spill your truth</span><span class="ccount" id="ccount">0/500</span></div>
  <textarea class="ri" id="ri" placeholder="What's eating you alive right now? No cap, no filter..." maxlength="500"></textarea>
  <div class="msec">
    <div class="mlbl">Pilih mood-mu sekarang</div>
    <div class="mgrid">
      <div class="mc act" data-mood="surviving" onclick="selMood('surviving')"><span class="me">üòÆ‚Äçüí®</span><span class="mn" style="color:var(--ms)">Surviving</span><span class="md-desc">Hidup tapi barely</span></div>
      <div class="mc" data-mood="thriving" onclick="selMood('thriving')"><span class="me">‚ú®</span><span class="mn" style="color:var(--mt)">Thriving</span><span class="md-desc">On top of my game</span></div>
      <div class="mc" data-mood="chaotic" onclick="selMood('chaotic')"><span class="me">üåÄ</span><span class="mn" style="color:var(--mc)">Chaotic</span><span class="md-desc">Everything is on fire</span></div>
      <div class="mc" data-mood="doom" onclick="selMood('doom')"><span class="me">üõå</span><span class="mn" style="color:var(--md)">Doom</span><span class="md-desc">Just wanna disappear</span></div>
    </div>
  </div>
  <div class="iact"><button class="sbtn" id="sbtn">Jejakkan & Spill</button></div>
</section>

<section>
  <div class="shdr">
    <span class="stit">Riwayat</span>
    <div class="sline"></div>
    <span style="font-size:10px;color:var(--txm);margin-left:auto">FIFO ‚Ä¢ MAX 6 ‚Ä¢ AUTO-CENSOR</span>
  </div>
  <div id="econ"></div>
</section>

<section style="margin-bottom:32px">
  <div class="shdr">
    <span class="stit">Memori</span>
    <div class="sline"></div>
    <span style="font-size:10px;color:var(--txm);margin-left:auto">FIFO ‚Ä¢ MAX 6 ‚Ä¢ AUTO-CENSOR</span>
  </div>
  <div class="tgrid" id="tgrid"></div>
</section>

<!-- ============================================
     SECRET CHAT SECTION - PREMIUM FEATURE
     ============================================ -->
<section class="secret-section" id="secret-section">
  <div class="secret-header">
    <div class="secret-icon">üïµÔ∏è</div>
    <div>
      <div class="secret-title">Secret Chat <span class="premium-badge">Premium</span></div>
      <div class="secret-desc">Enkripsi end-to-end ‚Ä¢ Self-destruct 15s ‚Ä¢ No trace</div>
    </div>
  </div>
  
  <!-- Form Kirim Secret Message -->
  <div id="secret-form">
    <input type="text" class="secret-input" id="secret-to" placeholder="Kirim ke @username..." maxlength="30">
    <textarea class="secret-textarea" id="secret-message" placeholder="Pesan rahasia akan terhapus 15 detik setelah dibaca..." maxlength="500"></textarea>
    <button class="secret-btn" id="secret-send" onclick="sendSecretMessage()">
      üî• Kirim Pesan Rahasia
    </button>
  </div>
  
  <!-- Secret Inbox -->
  <div class="secret-inbox" id="secret-inbox">
    <div class="shdr" style="margin-top:24px;margin-bottom:12px;">
      <span class="stit" style="color:var(--secret)">Secret Inbox</span>
      <div class="sline" style="background:var(--secret);opacity:0.3"></div>
    </div>
    <div id="secret-list">
      <div class="secret-empty">Belum ada pesan rahasia</div>
    </div>
  </div>
</section>

<!-- ============================================
     SECRET MESSAGE VIEWER MODAL
     ============================================ -->
<div class="secret-viewer" id="secret-viewer">
  <div class="secret-viewer-content" id="viewer-content">
    <div class="secret-warning">‚ö†Ô∏è PESAN INI AKAN TERHAPUS PERMANEN DALAM 15 DETIK</div>
    <div class="secret-sender" id="viewer-sender">Dari: @anonymous</div>
    <div class="secret-message" id="viewer-message"></div>
    <div class="secret-timer" id="viewer-timer">15</div>
    <div class="secret-progress">
      <div class="secret-progress-bar" id="viewer-progress"></div>
    </div>
    <button class="secret-close" onclick="closeSecretViewer()">Tutup & Hapus Sekarang</button>
  </div>
  
  <!-- Destroyed State -->
  <div class="secret-destroyed" id="viewer-destroyed" style="display:none;">
    <span class="secret-destroyed-icon">üî•</span>
    <div class="secret-destroyed-text">Pesan Telah Terhapus Permanen</div>
    <div style="font-size:12px;color:var(--txs);margin-top:8px;">No trace left behind</div>
  </div>
</div>

<footer><p class="ftxt">Nyambat ‚Ä¢ Aksi ‚Ä¢ Solusi</p></footer>
</div>

<nav class="bnav">
  <div class="bnav-c">
    <a href="jejak.html" class="ni act"><span class="nico">‚ú¶</span><span>Jejak</span></a>
    <a href="spill.html" class="ni"><span class="nico">‚úï</span><span>Spill</span></a>
    <a href="cocomeo.html" class="ni"><span class="nico">„Äú</span><span>Cocomeo</span></a>
    <a href="glitch.html" class="ni"><span class="nico">‚ö°</span><span>Glitch</span></a>
  </div>
</nav>

<div class="proc" id="proc">
  <div class="pspin"></div>
  <div class="ptxt" id="proctxt">Mengupload foto...<br><small>Mohon tunggu</small></div>
</div>

<div class="modal" id="gmodal">
  <div class="mc2">
    <div class="mhdr"><h3 class="mtit">Review Artefak</h3><button class="mcls" onclick="closeGallery()">√ó</button></div>
    <div class="gwarn">DILARANG UPLOAD FOTO WAJAH!</div>
    <div style="font-size:11px;color:var(--txs);margin-bottom:16px;text-align:center">Wajah terdeteksi akan otomatis disensor ‚Ä¢ Sistem FIFO (6 foto max) ‚Ä¢ Tidak dapat dihapus</div>
    <div class="ggrid" id="ggrid"></div>
    <div class="tmsec">
      <div class="tmhdr"><span class="tmlbl">üé® Tema Foto</span><span class="tmnm" id="tmnm">MONOCHROME</span></div>
      <input type="range" class="tmsl" id="tmsl" min="0" max="11" value="0" step="1" oninput="updTheme(this.value)">
      <div class="tmlabs"><span>B&W</span><span>Warm</span><span>Cool</span><span>Art</span></div>
    </div>
    <div class="notsec">
      <div class="notlbl"><span>üìù Notasi (Max 4 kata)</span><span class="notcnt" id="notcnt">0/4</span></div>
      <input type="text" class="noti" id="noti" placeholder="Contoh: senja di kamar" maxlength="30" oninput="valNote(this)">
    </div>
    <div class="macts">
      <button class="mbtn" onclick="closeGallery()">Batal</button>
      <button class="mbtn pri" id="konfirmbtn" onclick="confirmUpload()">Konfirmasi (<span id="selcnt">0</span>)</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="finput" accept="image/*" multiple style="display:none">

<script>
// ============================================
// CONFIG SUPABASE
// ============================================
const SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co ';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';
const BUCKET = 'artefacts';

// ============================================
// ENCRYPTION KEY - Generate dari user session
// ============================================
function getEncryptionKey() {
  // Generate key dari userId + salt (sederhana tapi efektif untuk demo)
  const userId = S.userId || 'anonymous';
  const salt = 'JEJAK_SECRET_SALT_2024';
  let hash = 0;
  const str = userId + salt;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return Math.abs(hash).toString(16).padStart(16, '0');
}

// Simple XOR Encryption (untuk demo - production gunakan Web Crypto API)
function encrypt(text, key) {
  let result = '';
  for (let i = 0; i < text.length; i++) {
    const charCode = text.charCodeAt(i) ^ key.charCodeAt(i % key.length);
    result += String.fromCharCode(charCode);
  }
  return btoa(result); // Base64 encode
}

function decrypt(encrypted, key) {
  try {
    const text = atob(encrypted);
    let result = '';
    for (let i = 0; i < text.length; i++) {
      const charCode = text.charCodeAt(i) ^ key.charCodeAt(i % key.length);
      result += String.fromCharCode(charCode);
    }
    return result;
  } catch(e) {
    return null;
  }
}

// ============================================
// DUMMY DATA
// ============================================
const DUMMY_ENTRIES = [
  {id:'d1',content:'Hari ini gue nangis di angkot gegara liat kucing dipukul orang. Mental gue udah kayak kerupuk kena hujan.',mood:'surviving',timestamp:Date.now()-3600000,reactions:{skull:42,cry:89,fire:12,upside:7},isDummy:true},
  {id:'d2',content:'akhirnya bisa tidur nyenyak semalaman setelah 3 minggu insomnia. thanks buat chat tadi malam.',mood:'thriving',timestamp:Date.now()-7200000,reactions:{skull:23,cry:15,fire:67,upside:31},isDummy:true},
  {id:'d3',content:'hari ini chaos abis! dari bangun tidur udah salah ambil kaki, sampe kantor lupa bawa laptop.',mood:'chaotic',timestamp:Date.now()-10800000,reactions:{skull:89,cry:23,fire:45,upside:78},isDummy:true}
];
const DUMMY_ARTEFACTS = [
  {id:'a1',url:'https://images.unsplash.com/photo-1517842645767-c639042777db?w=400&q=80 ',note:'jeda',hasFace:false,isDummy:true,theme:'fm'},
  {id:'a2',url:'https://images.unsplash.com/photo-1499209974431-9dddcece7f88?w=400&q=80 ',note:'hijau',hasFace:false,isDummy:true,theme:'fg'},
  {id:'a3',url:'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=400&q=80 ',note:'gabut',hasFace:false,isDummy:true,theme:'fl'},
  {id:'a4',url:'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&q=80 ',note:'sendiri',hasFace:false,isDummy:true,theme:'fv'},
  {id:'a5',url:'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&q=80 ',note:'capek',hasFace:true,isDummy:true,theme:'fn'},
  {id:'a6',url:'https://images.unsplash.com/photo-1516035069371-29a1b244cc32?w=400&q=80 ',note:'love',hasFace:false,isDummy:true,theme:'fc'}
];

// ============================================
// STATE
// ============================================
const S = {
  user: localStorage.getItem('jejak_username') || '@anon',
  userId: localStorage.getItem('jejak_user_id') || null,
  isLoggedIn: localStorage.getItem('jejak_user_id') !== null,
  isPremium: localStorage.getItem('jejak_premium') === 'true',
  entries: [],
  artefacts: [],
  secretMessages: []
};

// ============================================
// HELPERS
// ============================================
const $ = id => document.getElementById(id);
function toast(msg, dur=3000) {
  const t = $('toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), dur);
}
function esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
function toggleMenu() { $('mdd').classList.toggle('on'); }
function logoutUser() { 
  if(!confirm('Yakin logout?')) return; 
  localStorage.removeItem('jejak_username');
  localStorage.removeItem('jejak_user_id');
  localStorage.removeItem('jejak_premium');
  location.href='index.html'; 
}
function selMood(mood) { document.querySelectorAll('.mc').forEach(c => c.classList.toggle('act', c.dataset.mood===mood)); }
function showProc(msg='Mengupload...') { $('proctxt').innerHTML = msg; $('proc').classList.add('on'); }
function hideProc() { $('proc').classList.remove('on'); }

// ============================================
// SUPABASE API
// ============================================
async function sbInsert(table, data) {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
      method: 'POST',
      headers: { 
        'apikey': SUPABASE_KEY, 
        'Authorization': `Bearer ${SUPABASE_KEY}`, 
        'Content-Type': 'application/json', 
        'Prefer': 'return=representation' 
      },
      body: JSON.stringify(data)
    });
    if (!res.ok) { 
      const errText = await res.text();
      console.error('sbInsert error:', errText); 
      return null; 
    }
    const result = await res.json();
    return result[0] || result;
  } catch(e) { 
    console.error('sbInsert fetch error:', e); 
    return null; 
  }
}

async function sbSelect(table, query = '') {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}${query}`, {
      method: 'GET',
      headers: { 
        'apikey': SUPABASE_KEY, 
        'Authorization': `Bearer ${SUPABASE_KEY}`
      }
    });
    if (!res.ok) return null;
    return await res.json();
  } catch(e) {
    console.error('sbSelect error:', e);
    return null;
  }
}

async function sbDelete(table, id) {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`, {
      method: 'DELETE',
      headers: { 
        'apikey': SUPABASE_KEY, 
        'Authorization': `Bearer ${SUPABASE_KEY}`
      }
    });
    return res.ok;
  } catch(e) {
    console.error('sbDelete error:', e);
    return false;
  }
}

async function sbStorageUpload(file, path) {
  try {
    const res = await fetch(`${SUPABASE_URL}/storage/v1/object/${BUCKET}/${path}`, {
      method: 'POST',
      headers: { 
        'apikey': SUPABASE_KEY, 
        'Authorization': `Bearer ${SUPABASE_KEY}`, 
        'Content-Type': file.type, 
        'x-upsert': 'true' 
      },
      body: file
    });
    if (!res.ok) { 
      const err = await res.text(); 
      console.error('Storage upload error:', err); 
      return null; 
    }
    return `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${path}`;
  } catch(e) { 
    console.error('Storage upload fetch error:', e); 
    return null; 
  }
}

// ============================================
// THEMES
// ============================================
const THEMES = [
  {name:'MONOCHROME',filter:'fm'},{name:'NOIR',filter:'fn'},{name:'SEPIA',filter:'fsp'},{name:'WARM',filter:'fw'},
  {name:'GOLDEN',filter:'fg'},{name:'LOMO',filter:'fl'},{name:'DREAM',filter:'fd'},{name:'COLD',filter:'fco'},
  {name:'CYBER',filter:'fc'},{name:'VIGNETTE',filter:'fv'},{name:'CRISP',filter:'fcr'},{name:'MOODY',filter:'fmo'}
];

// ============================================
// RENDER
// ============================================
function renderEntries() {
  const con = $('econ'); if(!con) return;
  if(!S.entries.length) {
    con.innerHTML = '<div class="es"><span class="ee">üçÉ</span><div class="et">Belum ada jejak</div><div class="est">Jadilah yang pertama spill your truth</div></div>';
    return;
  }
  con.innerHTML = S.entries.map(e => {
    const ta = e.isDummy ? 'contoh' : 'baru saja';
    const emoji = {surviving:'üòÆ‚Äçüí®',thriving:'‚ú®',chaotic:'üåÄ',doom:'üõå'}[e.mood]||'';
    return `<article class="entry${e.isDummy?' entry-dummy':''}">
      <div class="ehdr">
        <div class="emeta">
          <span class="etime">${ta}</span>
          <span class="emood ${e.mood}">${emoji} ${e.mood}</span>
        </div>
        ${e.isDummy?'<span class="fifo-i">Contoh</span>':''}
      </div>
      <div class="econt">${esc(e.content)}</div>
      <div class="reaction-bar">
        ${Object.entries({skull:'üíÄ',cry:'üò≠',fire:'üî•',upside:'üôÉ'}).map(([k,em])=>`
          <button class="reaction-btn" disabled><span class="remoji">${em}</span><span class="rcount">${e.reactions[k]||0}</span></button>
        `).join('')}
      </div>
    </article>`;
  }).join('');
}

function renderTray() {
  const con = $('tgrid'); if(!con) return;
  let html = '';
  S.artefacts.slice(0,6).forEach(a => {
    if(a.hasFace) {
      html += `<div class="ti" onclick="setHero('${a.id}')" style="position:relative">
        <img src="${a.url}" class="${a.theme}" alt="${a.note}">
        <div class="sensored-overlay"><span class="sensored-text">SENSORED</span></div>
      </div>`;
    } else {
      html += `<div class="ti" onclick="setHero('${a.id}')">
        <img src="${a.url}" class="${a.theme}" alt="${a.note}">
      </div>`;
    }
  });
  for(let i = S.artefacts.length; i < 6; i++) {
    html += '<div class="ti empty" onclick="document.getElementById(\'upbtn\').click()">+</div>';
  }
  con.innerHTML = html;
}

function setHero(id) {
  const a = S.artefacts.find(x => x.id === id); if(!a) return;
  const img = $('himg'), note = $('hnote');
  if(img){ img.src = a.url; img.className = a.theme; }
  if(note) note.textContent = `"${a.note}"`;
}

// ============================================
// UPLOAD
// ============================================
let uploads = parseInt(localStorage.getItem('jejak_uploads')||'0');
let quotaStart = parseInt(localStorage.getItem('jejak_quota_start')||Date.now());
let pendingFiles = [], selFiles = new Set(), currentTheme = 0, currentNote = '';

function checkQuota() {
  const now = Date.now(), win = 3*86400000;
  if(now - quotaStart > win) { uploads=0; quotaStart=now; localStorage.setItem('jejak_uploads','0'); localStorage.setItem('jejak_quota_start',now+''); return true; }
  return uploads < 6;
}
function updQuota() {
  const t=$('qtimer'), c=$('ucnt'); if(!t) return;
  const rem=Math.max(0,3*86400000-(Date.now()-quotaStart));
  const days=Math.ceil(rem/86400000), slots=6-uploads;
  t.textContent=`Window aktif ‚Ä¢ ${days} hari ‚Ä¢ ${slots} slot`;
  t.classList.toggle('urg',slots<=2);
  if(c){ c.textContent=uploads; c.style.display=uploads>0?'block':'none'; }
}

function initUpload() {
  const btn=$('upbtn'), fi=$('finput'); if(!btn||!fi) return;
  btn.onclick = () => { if(!checkQuota()){toast('‚è≥ Quota habis');return;} fi.value=''; fi.click(); };
  fi.onchange = handleFiles;
}

async function handleFiles(e) {
  const files = Array.from(e.target.files).slice(0, 6-uploads);
  if(!files.length) return;
  if(files.reduce((s,f)=>s+f.size,0) > 20*1024*1024){ toast('‚ö† File terlalu besar (max 20MB total)'); return; }
  const pf = files.map(f => ({ file: f, hasFace: false, preview: URL.createObjectURL(f) }));
  openGallery(pf);
}

function openGallery(files) {
  selFiles = new Set(files.map((_,i)=>i));
  currentTheme=0; currentNote='';
  const grid=$('ggrid'); if(!grid) return;
  grid.innerHTML='';
  files.forEach((item,i)=>{
    const d=document.createElement('div'); d.className='gi sel';
    d.innerHTML=`<img src="${item.preview}" class="fm" id="pv${i}">`;
    d.onclick=()=>toggleSel(i,d); grid.appendChild(d);
  });
  $('tmsl').value=0; $('tmnm').textContent='MONOCHROME';
  $('noti').value=''; $('notcnt').textContent='0/4';
  updSelCnt();
  $('gmodal').classList.add('on');
  pendingFiles=files;
}
function toggleSel(i,el){ if(selFiles.has(i))selFiles.delete(i); else selFiles.add(i); el.classList.toggle('sel'); updSelCnt(); }
function updSelCnt(){ $('selcnt').textContent=selFiles.size; }
function updTheme(v){ currentTheme=+v; const th=THEMES[currentTheme]; $('tmnm').textContent=th.name; pendingFiles.forEach((_,i)=>{ const img=$('pv'+i); if(img){img.className='';img.classList.add(th.filter);} }); }
function valNote(inp){ const w=inp.value.trim().split(/\s+/).filter(x=>x.length); $('notcnt').textContent=`${Math.min(w.length,4)}/4`; if(w.length>4) inp.value=w.slice(0,4).join(' '); currentNote=inp.value.trim(); }
function closeGallery(){ $('gmodal').classList.remove('on'); pendingFiles=[]; selFiles.clear(); }

async function confirmUpload() {
  if(selFiles.size===0){ toast('Pilih minimal 1'); return; }
  const kbtn=$('konfirmbtn'); if(kbtn) kbtn.disabled=true;
  closeGallery();
  showProc('Mengupload foto ke server...<br><small>Mohon tunggu</small>');

  const theme = THEMES[currentTheme];
  const note = currentNote || 'memory';
  const userId = S.userId;
  const author = S.user.replace('@','');
  let uploadedCount = 0;

  for(const i of selFiles){
    const item = pendingFiles[i];
    const file = item.file;
    const ext = file.name.split('.').pop() || 'jpg';
    const timestamp = Date.now();
    const storagePath = `${author}/${timestamp}_${i}.${ext}`;

    const publicUrl = await sbStorageUpload(file, storagePath);
    const displayUrl = publicUrl || item.preview;

    let dbId = null;
    if(publicUrl) {
      const artefactData = {
        author: author,
        url: publicUrl,
        note: note,
        has_face: item.hasFace,
        faces: item.faces || []
      };
      if(userId) artefactData.user_id = userId;

      const inserted = await sbInsert('artefacts', artefactData);
      if(inserted) {
        dbId = inserted.id;
        console.log('Artefact registered in DB:', dbId, publicUrl);
      }
    }

    const newArtefact = {
      id: dbId || ('upload_'+timestamp+'_'+i),
      url: displayUrl,
      note: note,
      hasFace: item.hasFace,
      theme: theme.filter,
      timestamp: timestamp,
      isDummy: false
    };

    S.artefacts.unshift(newArtefact);
    if(S.artefacts.length > 6) S.artefacts.pop();
    uploadedCount++;
  }

  localStorage.setItem('jejak_artefacts', JSON.stringify(S.artefacts));
  uploads += uploadedCount;
  localStorage.setItem('jejak_uploads', uploads+'');

  renderTray();
  updQuota();
  
  if(S.artefacts.length > 0) setHero(S.artefacts[0].id);

  hideProc();
  if(kbtn) kbtn.disabled=false;

  const successMsg = uploadedCount > 0 
    ? `‚úì ${uploadedCount} foto berhasil diupload!` 
    : '‚ö† Upload selesai (offline mode)';
  toast(successMsg);
}

// ============================================
// SECRET CHAT - PREMIUM FEATURE
// ============================================

let currentSecretId = null;
let destroyTimer = null;
const DESTROY_TIME = 15; // detik

// Kirim secret message
async function sendSecretMessage() {
  if (!S.isPremium) {
    toast('üîí Upgrade ke Premium untuk fitur Secret Chat');
    return;
  }
  
  const toInput = $('secret-to');
  const msgInput = $('secret-message');
  const btn = $('secret-send');
  
  const to = toInput.value.trim().replace('@', '');
  const message = msgInput.value.trim();
  
  if (!to) { toast('Masukkan username tujuan'); return; }
  if (!message) { toast('Masukkan pesan rahasia'); return; }
  if (to === S.user.replace('@', '')) { toast('Gak bisa kirim ke diri sendiri'); return; }
  
  btn.disabled = true;
  btn.classList.add('sending');
  btn.textContent = 'Mengenkripsi & Mengirim...';
  
  // Enkripsi pesan
  const key = getEncryptionKey();
  const encrypted = encrypt(message, key);
  
  // Simpan ke DB (hanya encrypted text)
  const secretData = {
    sender_id: S.userId,
    sender_username: S.user.replace('@', ''),
    recipient_username: to,
    encrypted_content: encrypted,
    created_at: new Date().toISOString(),
    is_read: false,
    destroyed: false
  };
  
  const result = await sbInsert('secret_messages', secretData);
  
  btn.disabled = false;
  btn.classList.remove('sending');
  btn.textContent = 'üî• Kirim Pesan Rahasia';
  
  if (result) {
    toast('‚úì Pesan rahasia terkirim!');
    toInput.value = '';
    msgInput.value = '';
    loadSecretInbox(); // Refresh inbox
  } else {
    toast('‚ö† Gagal mengirim, coba lagi');
  }
}

// Load secret inbox
async function loadSecretInbox() {
  if (!S.isPremium || !S.isLoggedIn) return;
  
  const myUsername = S.user.replace('@', '');
  const messages = await sbSelect('secret_messages', `?recipient_username=eq.${myUsername}&destroyed=eq.false&order=created_at.desc`);
  
  if (!messages) return;
  
  S.secretMessages = messages;
  renderSecretInbox();
}

function renderSecretInbox() {
  const list = $('secret-list');
  if (!list) return;
  
  if (S.secretMessages.length === 0) {
    list.innerHTML = '<div class="secret-empty">Belum ada pesan rahasia</div>';
    return;
  }
  
  list.innerHTML = S.secretMessages.map(msg => `
    <div class="secret-item ${!msg.is_read ? 'unread' : ''}" onclick="openSecretMessage('${msg.id}')">
      <div class="secret-item-info">
        <div class="secret-item-from">Dari: @${esc(msg.sender_username)}</div>
        <div class="secret-item-preview">${msg.is_read ? 'üî• Sudah dibaca' : 'üîí Pesan rahasia terenkripsi'}</div>
      </div>
      <div class="secret-item-time">${new Date(msg.created_at).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})}</div>
    </div>
  `).join('');
}

// Buka secret message
async function openSecretMessage(id) {
  const msg = S.secretMessages.find(m => m.id === id);
  if (!msg) return;
  
  currentSecretId = id;
  
  const viewer = $('secret-viewer');
  const content = $('viewer-content');
  const destroyed = $('viewer-destroyed');
  const sender = $('viewer-sender');
  const messageEl = $('viewer-message');
  const timerEl = $('viewer-timer');
  const progressEl = $('viewer-progress');
  
  // Reset tampilan
  content.style.display = 'block';
  destroyed.style.display = 'none';
  timerEl.textContent = DESTROY_TIME;
  progressEl.style.width = '100%';
  
  // Dekripsi pesan
  const key = getEncryptionKey();
  const decrypted = decrypt(msg.encrypted_content, key);
  
  if (!decrypted) {
    toast('‚ö† Gagal mendekripsi pesan');
    return;
  }
  
  sender.textContent = `Dari: @${msg.sender_username}`;
  messageEl.textContent = decrypted;
  
  // Tandai sudah dibaca
  if (!msg.is_read) {
    await fetch(`${SUPABASE_URL}/rest/v1/secret_messages?id=eq.${id}`, {
      method: 'PATCH',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ is_read: true, read_at: new Date().toISOString() })
    });
  }
  
  viewer.classList.add('on');
  
  // Start countdown
  let timeLeft = DESTROY_TIME;
  destroyTimer = setInterval(async () => {
    timeLeft--;
    timerEl.textContent = timeLeft;
    progressEl.style.width = `${(timeLeft / DESTROY_TIME) * 100}%`;
    
    if (timeLeft <= 0) {
      await destroyMessage();
    }
  }, 1000);
}

// Hancurkan pesan
async function destroyMessage() {
  if (destroyTimer) {
    clearInterval(destroyTimer);
    destroyTimer = null;
  }
  
  if (!currentSecretId) return;
  
  // Hapus dari DB (atau tandai destroyed)
  await fetch(`${SUPABASE_URL}/rest/v1/secret_messages?id=eq.${currentSecretId}`, {
    method: 'PATCH',
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ destroyed: true, destroyed_at: new Date().toISOString() })
  });
  
  // Tampilkan animasi terbakar
  const content = $('viewer-content');
  const destroyed = $('viewer-destroyed');
  
  content.style.display = 'none';
  destroyed.style.display = 'block';
  
  // Hapus dari local array
  S.secretMessages = S.secretMessages.filter(m => m.id !== currentSecretId);
  renderSecretInbox();
  
  // Auto close setelah animasi
  setTimeout(() => {
    closeSecretViewer();
  }, 2000);
}

function closeSecretViewer() {
  if (destroyTimer) {
    clearInterval(destroyTimer);
    destroyTimer = null;
  }
  
  // Jika ditutup manual sebelum waktu habis, tetap hancurkan
  if (currentSecretId) {
    destroyMessage();
  }
  
  $('secret-viewer').classList.remove('on');
  currentSecretId = null;
}

// ============================================
// INIT
// ============================================
document.addEventListener('DOMContentLoaded', () => {
  
  try { 
    S.entries = JSON.parse(localStorage.getItem('jejak_entries')) || [...DUMMY_ENTRIES]; 
  } catch { 
    S.entries = [...DUMMY_ENTRIES]; 
  }
  
  try { 
    S.artefacts = JSON.parse(localStorage.getItem('jejak_artefacts')) || [...DUMMY_ARTEFACTS]; 
  } catch { 
    S.artefacts = [...DUMMY_ARTEFACTS]; 
  }

  renderEntries();
  renderTray();
  initUpload();
  updQuota();

  if(S.artefacts.length>0) setHero(S.artefacts[0].id);

  if (!S.isLoggedIn) {
    console.log('User not logged in, redirecting...');
    toast('Silakan login terlebih dahulu');
    setTimeout(() => {
      window.location.href = 'index.html';
    }, 1500);
    return;
  }

  const hu = $('huser');
  if(hu) hu.textContent = S.user;
  
  const odot = $('odot');
  if(odot) {
    odot.classList.remove('off');
    odot.classList.add('on');
  }

  // Setup Secret Chat
  if (S.isPremium) {
    loadSecretInbox();
    // Poll inbox setiap 10 detik
    setInterval(loadSecretInbox, 10000);
  } else {
    // Lock secret chat untuk non-premium
    const secretForm = $('secret-form');
    if(secretForm) {
      secretForm.classList.add('secret-locked');
      secretForm.innerHTML = '<div style="text-align:center;padding:24px;"><div style="font-size:32px;margin-bottom:8px;">üîí</div><div style="font-size:14px;font-weight:700;color:var(--secret);margin-bottom:4px;">SECRET CHAT LOCKED</div><div style="font-size:11px;color:var(--txs);">Upgrade ke Premium untuk membuka</div></div>';
    }
  }

  console.log('User logged in:', S.user, 'Premium:', S.isPremium);

  const ri=$('ri'), cc=$('ccount');
  if(ri&&cc){ ri.oninput=()=>{ const n=ri.value.length; cc.textContent=`${n}/500`; cc.style.color=n>=450?'var(--at)':'var(--txm)'; }; }

  const sb=$('sbtn');
  if(sb&&ri){
    sb.onclick=async()=>{
      const c=ri.value.trim(); if(!c){toast('Tulis sesuatu...');return;}
      const mood=document.querySelector('.mc.act')?.dataset.mood||'surviving';
      
      if(!S.isLoggedIn || !S.userId){
        toast('Silakan login terlebih dahulu');
        setTimeout(() => window.location.href = 'index.html', 1500);
        return;
      }
      
      sb.disabled=true; sb.textContent='Menyimpan...';
      
      const rantData={
        user_id: S.userId,
        content: c,
        mood: mood,
        is_anonymous: false,
        created_at: new Date().toISOString(),
        response_count: 0,
        vibes: {},
        reaction_count: {skull:0, cry:0, fire:0, upside:0},
        ai_metadata: {}
      };
      
      const ok = await sbInsert('rants', rantData);
      
      const newEntry={
        id: 'user_'+Date.now(),
        content: c,
        mood: mood,
        timestamp: Date.now(),
        reactions: {skull:0, cry:0, fire:0, upside:0},
        isDummy: false,
        author: S.user
      };
      
      S.entries.unshift(newEntry);
      if(S.entries.length > 6) S.entries.pop();
      localStorage.setItem('jejak_entries', JSON.stringify(S.entries));
      
      renderEntries();
      ri.value=''; 
      if(cc) cc.textContent='0/500';
      toast(ok ? '‚úì Tersimpan di database' : '‚ö† Tersimpan lokal saja');
      
      sb.disabled=false; 
      sb.textContent='Jejakkan & Spill';
    };
  }

  setInterval(updQuota, 60000);
});
</script>
</body>
</html>
