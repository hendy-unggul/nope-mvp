<!DOCTYPE html>
<html>
<head>
    <title>JEJAK - TEST UPLOAD</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="font-family: system-ui; padding: 20px; background: #0A0A0A; color: white;">

<h2 style="color: #FF4D00;">üöÄ JEJAK - TEST UPLOAD</h2>

<div style="margin: 20px 0;">
    <button id="btnUpload" style="padding: 15px 30px; background: #39FF14; border: none; font-weight: bold; cursor: pointer; font-size: 16px;">üì∏ PILIH FOTO</button>
    <button id="btnCek" style="padding: 15px 30px; background: #00F0FF; border: none; font-weight: bold; cursor: pointer; font-size: 16px; margin-left: 10px;">üîç CEK DATABASE</button>
</div>

<div id="preview" style="display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin: 20px 0;"></div>

<div id="log" style="background: #111; border: 2px solid #333; padding: 20px; margin-top: 20px; font-family: monospace; min-height: 200px; overflow-y: auto;"></div>

<input type="file" id="fileInput" accept="image/*" style="display: none;">

<script>
// ============================================
// SUPABASE CLIENT
// ============================================
const SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const BUCKET = 'artefacts';

// UUID valid untuk testing
const TEST_USER_ID = '12345678-1234-1234-1234-123456789012';
const TEST_USERNAME = 'tester';

// ============================================
// DOM ELEMENTS
// ============================================
const logEl = document.getElementById('log');
const previewEl = document.getElementById('preview');
const fileInput = document.getElementById('fileInput');
const btnUpload = document.getElementById('btnUpload');
const btnCek = document.getElementById('btnCek');

// ============================================
// LOGGING
// ============================================
function addLog(msg, type = 'info') {
    const color = type === 'error' ? '#FF006E' : type === 'success' ? '#39FF14' : '#00F0FF';
    logEl.innerHTML += `<div style="color: ${color}; margin: 5px 0; padding: 5px; border-bottom: 1px solid #333;">> ${msg}</div>`;
    logEl.scrollTop = logEl.scrollHeight;
    console.log(msg);
}

// ============================================
// UPLOAD FILE
// ============================================
btnUpload.onclick = () => {
    fileInput.click();
};

fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    // Tampilkan preview
    const reader = new FileReader();
    reader.onload = (e) => {
        previewEl.innerHTML = `
            <div style="aspect-ratio:1; background:#1E1E1E; border:2px solid #FF4D00; overflow:hidden;">
                <img src="${e.target.result}" style="width:100%; height:100%; object-fit:cover;">
            </div>
        `;
    };
    reader.readAsDataURL(file);
    
    addLog(`üì∏ File: ${file.name} (${(file.size/1024).toFixed(1)}KB)`);
    
    // Generate nama file
    const ext = file.name.split('.').pop() || 'jpg';
    const fileName = `test-${Date.now()}.${ext}`;
    
    try {
        // STEP 1: UPLOAD KE STORAGE
        addLog('‚Üí Upload ke storage...');
        const { error: uploadError } = await supabaseClient.storage
            .from(BUCKET)
            .upload(fileName, file);
        
        if (uploadError) {
            addLog(`‚ùå Upload gagal: ${uploadError.message}`, 'error');
            return;
        }
        addLog('‚úì Upload sukses', 'success');
        
        // STEP 2: GET PUBLIC URL
        const { data: { publicUrl } } = supabaseClient.storage
            .from(BUCKET)
            .getPublicUrl(fileName);
        addLog(`‚Üí URL: ${publicUrl}`);
        
        // STEP 3: INSERT KE DATABASE
        addLog('‚Üí Insert ke database...');
        const { error: insertError } = await supabaseClient
            .from('artefacts')
            .insert({
                user_id: TEST_USER_ID,
                username: TEST_USERNAME,
                url: publicUrl,
                note: 'test ' + new Date().toLocaleTimeString(),
                has_face: false,
                faces: []
            });
        
        if (insertError) {
            addLog(`‚ùå Insert gagal: ${insertError.message}`, 'error');
            addLog(`üìã Detail: ${JSON.stringify(insertError)}`, 'error');
        } else {
            addLog('‚úì Insert sukses!', 'success');
        }
        
    } catch (err) {
        addLog(`‚ùå Error: ${err.message}`, 'error');
    }
    
    // Reset input
    fileInput.value = '';
};

// ============================================
// CEK DATABASE
// ============================================
btnCek.onclick = async () => {
    addLog('üîç CEK DATABASE...');
    
    try {
        const { data, error } = await supabaseClient
            .from('artefacts')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(5);
        
        if (error) {
            addLog(`‚ùå Error: ${error.message}`, 'error');
        } else {
            addLog(`‚úì Total data: ${data.length}`, 'success');
            if (data.length === 0) {
                addLog('‚Üí Belum ada data');
            } else {
                data.forEach((item, i) => {
                    addLog(`  ${i+1}. ${item.note}`);
                    addLog(`     URL: ${item.url.substring(0, 50)}...`);
                });
            }
        }
    } catch (e) {
        addLog(`‚ùå Exception: ${e.message}`, 'error');
    }
};

addLog('‚úÖ READY - Klik PILIH FOTO untuk upload');
</script>
</body>
</html>
