<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>jejak ‚Äî vibe check ‚ú®</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700;900&family=Bebas+Neue&family=Courier+Prime:wght@400;700&family=Rubik:wght@400;600;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#0a0a0a;--sf:#121212;--tx:#fff;--mu:#999;--ac:#00ff88;--a2:#ff3366;--a3:#ffff00;--a4:#00d4ff;--bd:#333;--fm:'DM Sans',sans-serif;--fd:'Bebas Neue',sans-serif;--fmo:'Courier Prime',monospace;--fa:'Rubik',sans-serif}
body{background:var(--bg);color:var(--tx);font-family:var(--fm);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;overflow-x:hidden;position:relative}
body::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle at 20% 80%,rgba(0,255,136,.03),transparent 50%),radial-gradient(circle at 80% 20%,rgba(255,51,102,.03),transparent 50%),radial-gradient(circle at 40% 40%,rgba(0,212,255,.02),transparent 50%);animation:slowRot 60s linear infinite;pointer-events:none;z-index:0}
@keyframes slowRot{to{transform:rotate(360deg)}}
.sticker{position:fixed;font-size:48px;opacity:.15;pointer-events:none;animation:float 8s ease-in-out infinite;z-index:0;filter:blur(.5px)}
.sticker:nth-child(1){top:10%;left:5%}
.sticker:nth-child(2){top:20%;right:10%;animation-delay:2s;font-size:64px}
.sticker:nth-child(3){bottom:15%;left:15%;animation-delay:4s}
.sticker:nth-child(4){bottom:25%;right:5%;animation-delay:6s;font-size:56px}
.sticker:nth-child(5){top:60%;left:8%;animation-delay:1s}
.sticker:nth-child(6){top:40%;right:12%;animation-delay:3s;font-size:40px}
@keyframes float{0%,100%{transform:translate(0,0) rotate(0deg)}25%{transform:translate(10px,-15px) rotate(5deg)}50%{transform:translate(-10px,-25px) rotate(-5deg)}75%{transform:translate(15px,-10px) rotate(3deg)}}
.container{max-width:480px;width:100%;position:relative;z-index:1}
.logo-zone{text-align:center;margin-bottom:16px;position:relative}
.logo-big{font-family:var(--fd);font-size:88px;font-weight:400;line-height:.9;letter-spacing:-.02em;color:var(--ac);text-transform:lowercase;display:inline-block;filter:drop-shadow(3px 3px 0 var(--a2)) drop-shadow(-2px -2px 0 var(--a4));transform:rotate(-2deg);animation:glitch 5s ease-in-out infinite}
@keyframes glitch{0%,100%{transform:rotate(-2deg)}20%{transform:rotate(-2deg) translate(1px,0)}40%{transform:rotate(-2deg) translate(0,1px)}60%{transform:rotate(-2deg) translate(-1px,0)}80%{transform:rotate(-2deg) translate(0,-1px)}}
.doodle{position:absolute;top:-10px;right:-15px;width:120px;height:120px;border:3px solid var(--a3);border-radius:50%;transform:rotate(15deg);opacity:.3;animation:wobble 3s ease-in-out infinite}
@keyframes wobble{0%,100%{transform:rotate(15deg) scale(1)}50%{transform:rotate(12deg) scale(1.05)}}
.tagline{text-align:center;font-family:var(--fmo);font-size:13px;color:var(--mu);margin-bottom:24px;padding:8px 16px;background:rgba(255,255,255,.03);border:1px dashed var(--bd);border-radius:20px;display:inline-block;width:100%;transform:rotate(-1deg)}
.vibe-picker{display:flex;gap:10px;justify-content:center;margin-bottom:24px;flex-wrap:wrap}
.vibe-btn{padding:10px 20px;background:transparent;border:2px solid var(--bd);color:var(--tx);border-radius:30px;font-family:var(--fa);font-size:13px;font-weight:700;text-transform:lowercase;cursor:pointer;transition:all .3s cubic-bezier(.68,-.55,.27,1.55)}
.vibe-btn:hover{transform:translateY(-3px) rotate(-2deg);border-color:var(--ac);color:var(--ac)}
.vibe-btn.active{background:var(--ac);color:#000;border-color:var(--ac);transform:scale(1.05) rotate(-2deg)}
.auth-box{background:var(--sf);border:4px solid var(--ac);border-radius:24px;padding:40px 32px;position:relative;box-shadow:8px 8px 0 rgba(0,255,136,.2),12px 12px 0 rgba(255,51,102,.1);transform:rotate(-1deg);transition:all .3s ease}
.auth-box:hover{transform:rotate(0deg)}
.corner{position:absolute;font-size:32px;z-index:10;animation:spin 8s linear infinite}
.corner.tl{top:-15px;left:-15px}
.corner.tr{top:-15px;right:-15px;animation-direction:reverse}
.corner.bl{bottom:-15px;left:-15px;animation-delay:2s}
.corner.br{bottom:-15px;right:-15px;animation-direction:reverse;animation-delay:2s}
@keyframes spin{to{transform:rotate(360deg)}}
.input-label{text-align:center;font-family:var(--fd);font-size:24px;color:var(--tx);margin-bottom:4px;text-transform:lowercase;letter-spacing:1px}
.input-label::after{content:'‚≠ê';margin-left:8px;font-size:16px;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(1.2)}}
.fmt-hint{text-align:center;font-family:var(--fmo);font-size:11px;color:var(--mu);margin-bottom:16px;letter-spacing:.05em}
.fmt-hint b{color:var(--ac)}
.form-group{margin-bottom:20px;position:relative}
.form-group input{width:100%;background:rgba(255,255,255,.05);border:3px solid var(--bd);border-radius:16px;padding:20px;color:var(--tx);font-family:var(--fmo);font-size:18px;font-weight:500;text-align:center;text-transform:lowercase;transition:all .3s cubic-bezier(.68,-.55,.27,1.55);letter-spacing:.08em}
.form-group input:focus{outline:none;border-color:var(--ac);background:rgba(0,255,136,.1);transform:translateY(-4px) rotate(1deg);box-shadow:0 0 0 4px rgba(0,255,136,.2),6px 6px 0 rgba(0,255,136,.3)}
.form-group input::placeholder{color:var(--mu);font-weight:400;letter-spacing:.05em}
.form-group input.is-valid{border-color:var(--ac)}
.form-group input.is-invalid{border-color:var(--a2)}
.form-group input.is-checking{border-color:var(--a3)}
.feedback{margin-top:10px;padding:10px 16px;border-radius:12px;font-size:12px;font-family:var(--fmo);text-align:center;border:2px solid;display:none;line-height:1.5;animation:slideIn .4s cubic-bezier(.68,-.55,.27,1.55)}
.feedback.show{display:block}
.feedback.error{background:rgba(255,51,102,.1);border-color:var(--a2);color:var(--a2)}
.feedback.success{background:rgba(0,255,136,.1);border-color:var(--ac);color:var(--ac)}
.feedback.checking{background:rgba(255,255,0,.08);border-color:var(--a3);color:var(--a3)}
@keyframes slideIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.suggest{display:none;margin-top:8px;padding:6px 16px;background:rgba(0,212,255,.1);border:1px solid var(--a4);border-radius:20px;font-family:var(--fmo);font-size:12px;color:var(--a4);cursor:pointer;transition:all .2s;text-align:center}
.suggest.show{display:block}
.suggest:hover{background:rgba(0,212,255,.2)}
.btn{width:100%;background:var(--ac);color:#000;border:none;border-radius:16px;padding:20px;font-family:var(--fd);font-size:28px;text-transform:lowercase;cursor:pointer;margin-top:16px;position:relative;overflow:hidden;transform:rotate(-1deg);transition:all .3s cubic-bezier(.68,-.55,.27,1.55);box-shadow:4px 4px 0 rgba(0,0,0,.3),6px 6px 0 var(--a2);letter-spacing:2px}
.btn::before{content:'üöÄ';position:absolute;left:20px;font-size:24px;animation:rocket 2s ease-in-out infinite}
@keyframes rocket{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-5px) rotate(15deg)}}
.btn:hover{transform:translateY(-6px) rotate(1deg) scale(1.02)}
.btn:active{transform:translateY(-2px) rotate(0deg)}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
.notif{margin-top:24px;padding:20px;background:linear-gradient(135deg,rgba(255,255,0,.05),rgba(0,212,255,.05));border:2px dashed var(--bd);border-radius:16px;font-size:13px;line-height:1.6;position:relative;opacity:0;transform:translateY(20px) rotate(-2deg);transition:all .6s cubic-bezier(.68,-.55,.27,1.55)}
.notif.show{opacity:1;transform:translateY(0) rotate(0deg)}
.notif::before{content:'üìå';position:absolute;top:-12px;left:20px;font-size:24px;background:var(--sf);padding:0 8px}
.notif h4{color:var(--a3);font-family:var(--fa);font-weight:800;margin-bottom:12px;font-size:15px;text-transform:lowercase}
.notif p{margin-bottom:8px;font-family:var(--fmo);color:var(--mu)}
.notif .hl{color:var(--ac);font-weight:700;text-decoration:underline;text-decoration-style:wavy;text-decoration-color:var(--a2)}
.soul{margin-top:28px;padding-top:24px;border-top:1px solid var(--bd);text-align:center;font-family:var(--fmo);font-size:11px;color:var(--mu);opacity:.6}
.loading{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px}
.loading.hidden{display:none}
.l-spin{width:32px;height:32px;border:3px solid var(--bd);border-top-color:var(--ac);border-radius:50%;animation:spin 1s linear infinite}
.l-txt{font-family:var(--fmo);font-size:14px;color:var(--mu)}
/* Debug banner ‚Äî hanya muncul saat ada error session */
.debug-banner{display:none;margin-bottom:16px;padding:10px 16px;background:rgba(255,51,102,.1);border:1px solid var(--a2);border-radius:12px;font-family:var(--fmo);font-size:11px;color:var(--a2);text-align:center;line-height:1.6}
.debug-banner.show{display:block}
@media(max-width:480px){.logo-big{font-size:64px}.btn{font-size:24px;padding:18px}.auth-box{padding:32px 24px}}
</style>
</head>
<body>
<div class="loading" id="loading"><div class="l-spin"></div><div class="l-txt">checking session...</div></div>

<div class="sticker">‚ú®</div><div class="sticker">üåà</div><div class="sticker">‚ö°</div>
<div class="sticker">üí´</div><div class="sticker">üî•</div><div class="sticker">üíú</div>

<div class="container">
  <div class="logo-zone">
    <div class="doodle"></div>
    <div class="logo-big">jejak</div>
  </div>
  <div class="tagline">nyambat ¬∑ aksi ¬∑ solusi</div>

  <!-- Debug banner: tampil jika session rusak -->
  <div class="debug-banner" id="debug-banner"></div>

  <div class="vibe-picker">
    <button class="vibe-btn active" data-vibe="cyber">cyber üíª</button>
    <button class="vibe-btn" data-vibe="neon">neon ‚ú®</button>
    <button class="vibe-btn" data-vibe="retro">retro üéÆ</button>
    <button class="vibe-btn" data-vibe="pastel">soft üå∏</button>
  </div>

  <div class="auth-box">
    <span class="corner tl">üåü</span><span class="corner tr">üí•</span>
    <span class="corner bl">‚ú®</span><span class="corner br">üéØ</span>

    <form id="frm">
      <div class="input-label">ur username vibes</div>
      <div class="fmt-hint">format: <b>kata.kata</b> &nbsp;¬∑&nbsp; contoh: <b>over.thinker</b></div>
      <div class="form-group">
        <input type="text" id="uname" placeholder="over.thinker" autocomplete="off" autofocus maxlength="30" spellcheck="false">
        <div class="feedback" id="fb"></div>
        <div class="suggest" id="sg"></div>
      </div>
      <button type="submit" class="btn" id="btn" disabled>let's goooo</button>
      <div class="notif show" id="notif">
        <h4>real talk: stay safe bestie üîí</h4>
        <p>no <span class="hl">real names</span> fr fr</p>
        <p>no face pics, keep it <span class="hl">mysterious</span> ‚ú®</p>
        <p>obey the law, <span class="hl">zero hoax</span> energy üö´</p>
        <p>have fun but stay <span class="hl">accountable</span> üíØ</p>
      </div>
      <div class="soul">soul by itsALrUdio ‚Ä¢ v2.1</div>
    </form>
  </div>
</div>

<!-- FIX: Pakai supabase-js yang sama dengan halaman lain ‚Äî konsistensi library -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ============================================
// SUPABASE CONFIG ‚Äî sama persis dengan jejak.html
// ============================================
var SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';

var db = null; // supabase client

// ============================================
// LOCALSTORAGE KEYS ‚Äî sinkron dengan jejak.html
// ============================================
var SK = {
  u:   'jejak_username',    // username string
  s:   'jejak_session_id',  // device signature
  l:   'jejak_logged_in',   // 'true' / null
  v:   'jejak_vibe',        // vibe theme
  uid: 'user_id'            // UUID dari profiles.id ‚Äî KRITIS untuk FK
};

// ============================================
// VIBE THEMES
// ============================================
var VIBES = {
  cyber:  { ac: '#00ff88', a2: '#ff3366', a3: '#ffff00', a4: '#00d4ff' },
  neon:   { ac: '#ff10f0', a2: '#00ff88', a3: '#ffff00', a4: '#00d4ff' },
  retro:  { ac: '#ff6b35', a2: '#f7b801', a3: '#6a994e', a4: '#bc4749' },
  pastel: { ac: '#ffc8dd', a2: '#bde0fe', a3: '#a2d2ff', a4: '#ffafcc' }
};

// ============================================
// VALIDATION
// ============================================
var UN_PAT = /^[a-z][a-z0-9]*\.[a-z][a-z0-9]*$/;

function $el(id) { return document.getElementById(id); }
function $u() { return $el('uname'); }
function $fb() { return $el('fb'); }
function $sg() { return $el('sg'); }
function $btn() { return $el('btn'); }

function setFb(type, msg) {
  var el = $fb(), inp = $u();
  if (!type || !msg) {
    el.className = 'feedback';
    el.textContent = '';
    inp.className = '';
    return;
  }
  el.className = 'feedback show ' + type;
  el.textContent = msg;
  inp.className = type === 'success' ? 'is-valid' : type === 'checking' ? 'is-checking' : 'is-invalid';
}

function setSg(text) {
  var el = $sg();
  if (!text) { el.className = 'suggest'; return; }
  el.className = 'suggest show';
  el.textContent = 'üëâ maksud kamu: ' + text + '? (klik untuk apply)';
  el.onclick = function() {
    $u().value = text;
    el.className = 'suggest';
    $u().dispatchEvent(new Event('input'));
  };
}

function validate(raw) {
  if (!raw || !raw.trim()) return { ok: false, msg: 'username tidak boleh kosong' };
  var v = raw.trim().toLowerCase();
  if (v.length > 30) return { ok: false, msg: 'maksimal 30 karakter' };
  if (v.includes(' ')) {
    var s = v.trim().replace(/\s+/g, '.').replace(/[^a-z0-9.]/g, '');
    return { ok: false, msg: 'gunakan titik bukan spasi ‚Äî format: kata.kata', suggest: s };
  }
  if (!v.includes('.')) return { ok: false, msg: 'harus dua kata dipisah titik ¬∑ contoh: over.thinker' };
  if ((v.match(/\./g) || []).length > 1) return { ok: false, msg: 'hanya boleh satu titik pemisah' };
  if (!UN_PAT.test(v)) return { ok: false, msg: 'hanya huruf kecil a-z, angka, dan satu titik' };
  var parts = v.split('.');
  if (parts[0].length < 2 || parts[1].length < 2) return { ok: false, msg: 'masing-masing kata minimal 2 huruf' };
  return { ok: true, value: v };
}

// ============================================
// DEVICE SIGNATURE
// ============================================
function getDeviceSignature() {
  var sig = localStorage.getItem(SK.s);
  if (!sig) {
    var width = (window.screen && window.screen.width) || 'unknown';
    var height = (window.screen && window.screen.height) || 'unknown';
    var ua = navigator.userAgent;
    var rawString = ua + width + 'x' + height + Date.now() + Math.random().toString(36).substring(2, 15);
    sig = btoa(unescape(encodeURIComponent(rawString))).substring(0, 32).replace(/[^a-zA-Z0-9]/g, '');
    localStorage.setItem(SK.s, sig);
  }
  return sig;
}

// ============================================
// CLEAR SESSION ‚Äî helper untuk reset bersih
// ============================================
function clearSession(reason) {
  console.warn('[JEJAK] Clearing session:', reason);
  localStorage.removeItem(SK.u);
  localStorage.removeItem(SK.uid);
  localStorage.removeItem(SK.l);
  // Jangan hapus SK.s (device sig) dan SK.v (vibe preference)

  if (reason) {
    var banner = $el('debug-banner');
    if (banner) {
      banner.textContent = '‚ö†Ô∏è Session direset: ' + reason + ' ‚Äî silakan login ulang';
      banner.classList.add('show');
    }
  }
}

// ============================================
// SAVE SESSION ‚Äî simpan semua key dengan benar
// ============================================
function saveSession(username, userId) {
  // FIX: Pastikan userId adalah string UUID yang valid sebelum disimpan
  if (!userId || typeof userId !== 'string' || userId.length < 10) {
    throw new Error('userId tidak valid: ' + userId);
  }

  localStorage.setItem(SK.u, username);
  localStorage.setItem(SK.uid, userId);  // INI yang jadi user_id di rants & artefacts
  localStorage.setItem(SK.l, 'true');

  // Debug log untuk verifikasi
  console.log('%c[JEJAK] Session saved:', 'color:#00ff88;font-weight:bold', {
    username: username,
    user_id: userId,
    key_used: SK.uid  // harus 'user_id'
  });
}

// ============================================
// SUPABASE INIT
// ============================================
function initDb() {
  if (window.supabase && window.supabase.createClient) {
    db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    console.log('%c[JEJAK] Supabase client initialized', 'color:#00ff88');
    return true;
  }
  console.error('[JEJAK] Supabase SDK not loaded!');
  return false;
}

// ============================================
// CHECK USERNAME AVAILABILITY
// ============================================
var _deb = null, _last = null;

async function checkAvail(username) {
  if (username === _last) return;
  _last = username;
  $btn().disabled = true;
  setFb('checking', '‚è≥ mengecek ketersediaan...');

  try {
    var result = await db
      .from('profiles')
      .select('id, username')
      .eq('username', username)
      .limit(1);

    if (result.error) throw result.error;

    if (!result.data || result.data.length === 0) {
      setFb('success', '‚úì ' + username + ' tersedia ‚Äî siap daftar!');
    } else {
      setFb('success', '‚úì ' + username + ' ditemukan ‚Äî welcome back!');
    }
    $btn().disabled = false;
  } catch (e) {
    console.warn('[JEJAK] Check availability error:', e);
    // FIX: Jangan block user ‚Äî biarkan tetap bisa submit
    setFb('checking', '‚ö†Ô∏è koneksi lambat, coba submit langsung');
    $btn().disabled = false;
  }
}

// ============================================
// INPUT HANDLER
// ============================================
$u().addEventListener('input', function(e) {
  var v = e.target.value;
  var fmt = v.toLowerCase()
    .replace(/\s+/g, '.')
    .replace(/[^a-z0-9.]/g, '')
    .replace(/\.{2,}/g, '.');

  if (fmt !== v) {
    var p = e.target.selectionStart;
    e.target.value = fmt;
    try { e.target.setSelectionRange(p, p); } catch (_) {}
    v = fmt;
  }

  if (!v) {
    setFb('', '');
    setSg(null);
    $btn().disabled = true;
    $u().className = '';
    _last = null;
    return;
  }

  var r = validate(v);
  if (!r.ok) {
    setFb('error', r.msg);
    setSg(r.suggest || null);
    $btn().disabled = true;
    clearTimeout(_deb);
    _last = null;
    return;
  }

  setSg(null);
  clearTimeout(_deb);
  _deb = setTimeout(function() { checkAvail(r.value); }, 600);
});

$u().addEventListener('paste', function(e) {
  e.preventDefault();
  var p = (e.clipboardData || window.clipboardData).getData('text');
  e.target.value = p.trim()
    .toLowerCase()
    .replace(/[\s_\-]+/g, '.')
    .replace(/[^a-z0-9.]/g, '')
    .replace(/\.{2,}/g, '.')
    .slice(0, 30);
  e.target.dispatchEvent(new Event('input'));
});

// ============================================
// VIBE
// ============================================
function setVibe(v) {
  var c = VIBES[v];
  if (!c) return;
  var r = document.documentElement.style;
  r.setProperty('--ac', c.ac);
  r.setProperty('--a2', c.a2);
  r.setProperty('--a3', c.a3);
  r.setProperty('--a4', c.a4);
  document.querySelectorAll('.vibe-btn').forEach(function(b) {
    b.classList.toggle('active', b.getAttribute('data-vibe') === v);
  });
  localStorage.setItem(SK.v, v);
}

// Bind vibe buttons via JS ‚Äî no inline onclick
document.querySelectorAll('.vibe-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    setVibe(this.getAttribute('data-vibe'));
  });
});

// ============================================
// FORM SUBMIT ‚Äî LOGIKA AUTH UTAMA
// ============================================
$el('frm').addEventListener('submit', async function(e) {
  e.preventDefault();

  var r = validate($u().value);
  if (!r.ok) { setFb('error', r.msg); return; }

  var username = r.value;
  var btn = $btn();
  btn.disabled = true;
  btn.textContent = 'masuk...';

  try {
    if (!db) throw new Error('Database tidak terhubung');

    // STEP 1: Cek apakah username sudah ada
    var existingResult = await db
      .from('profiles')
      .select('id, username')
      .eq('username', username)
      .limit(1);

    if (existingResult.error) throw existingResult.error;

    var userId = null;
    var isNewUser = !existingResult.data || existingResult.data.length === 0;

    if (isNewUser) {
      // STEP 2A: Buat profile baru
      // FIX: Hanya kirim kolom yang PASTI ada di schema profiles
      // Tidak kirim 'id' ‚Äî biar Supabase auto-generate UUID
      var insertPayload = {
        username: username
      };
      // Kolom opsional ‚Äî tambahkan jika ada di schema
      // Uncomment sesuai kolom yang tersedia di tabel profiles:
      // insertPayload.vibe_preference = 50;
      // insertPayload.total_rants = 0;
      // insertPayload.is_ai = false;

      var insertResult = await db
        .from('profiles')
        .insert(insertPayload)
        .select('id, username');  // FIX: select setelah insert untuk dapat id yang di-generate

      if (insertResult.error) {
        // FIX: Tangani duplicate username race condition
        if (insertResult.error.code === '23505') {
          // Username sudah ada (race condition) ‚Äî fetch ulang
          var retryResult = await db
            .from('profiles')
            .select('id, username')
            .eq('username', username)
            .limit(1);
          if (!retryResult.error && retryResult.data && retryResult.data.length > 0) {
            userId = retryResult.data[0].id;
            setFb('success', '‚úÖ Welcome back, @' + username + '!');
          } else {
            throw insertResult.error;
          }
        } else {
          throw insertResult.error;
        }
      } else {
        // FIX: Verifikasi bahwa id benar-benar ada di response
        if (!insertResult.data || insertResult.data.length === 0 || !insertResult.data[0].id) {
          throw new Error('Profile dibuat tapi id tidak ada di response ‚Äî cek RLS policy tabel profiles');
        }
        userId = insertResult.data[0].id;
        setFb('success', 'üéâ Akun dibuat! Welcome, @' + username + '!');
      }

    } else {
      // STEP 2B: Login user yang sudah ada
      userId = existingResult.data[0].id;

      // FIX: Update last_seen dengan aman ‚Äî hanya kolom yang pasti ada
      // Jangan kirim metadata yang bisa gagal kalau kolom tidak ada
      try {
        await db
          .from('profiles')
          .update({ updated_at: new Date().toISOString() })
          .eq('id', userId);
      } catch (updateErr) {
        // Non-fatal ‚Äî lanjutkan login walau update gagal
        console.warn('[JEJAK] Update profile gagal (non-fatal):', updateErr);
      }

      setFb('success', '‚úÖ Welcome back, @' + username + '!');
    }

    // STEP 3: Simpan session ‚Äî INI yang dipakai jejak.html untuk FK
    saveSession(username, userId);

    // STEP 4: Redirect
    setTimeout(function() {
      window.location.href = 'spill.html';
    }, 700);

  } catch (err) {
    console.error('[JEJAK] Submit error:', err);
    var errMsg = err.message || JSON.stringify(err);
    setFb('error', '‚ùå ' + errMsg);
    btn.disabled = false;
    btn.textContent = "let's goooo";
  }
});

// ============================================
// AUTO LOGIN CHECK
// ============================================
async function checkAutoLogin() {
  var username = localStorage.getItem(SK.u);
  var userId = localStorage.getItem(SK.uid);
  var loggedIn = localStorage.getItem(SK.l) === 'true';

  // FIX: Validasi semua komponen session ada
  if (!loggedIn || !username || !userId) {
    // Session tidak lengkap ‚Äî clear untuk menghindari FK error di halaman lain
    if (loggedIn || username || userId) {
      clearSession('session tidak lengkap');
    }
    $el('loading').classList.add('hidden');
    return;
  }

  // FIX: Validasi userId terlihat seperti UUID
  if (userId.length < 10) {
    clearSession('user_id tidak valid (' + userId + ')');
    $el('loading').classList.add('hidden');
    return;
  }

  try {
    if (!db) {
      $el('loading').classList.add('hidden');
      return;
    }

    // Verifikasi user masih ada di DB
    var result = await db
      .from('profiles')
      .select('id, username')
      .eq('id', userId)
      .limit(1);

    if (result.error) throw result.error;

    if (result.data && result.data.length > 0) {
      // User valid ‚Äî langsung redirect
      console.log('%c[JEJAK] Auto-login OK:', 'color:#00ff88', username);
      window.location.href = 'spill.html';
      return;
    }

    // User tidak ditemukan di DB ‚Äî hapus session
    clearSession('user tidak ditemukan di database');

  } catch (e) {
    console.warn('[JEJAK] AutoLogin error (non-fatal):', e);
    // Jangan clear session jika hanya network error
    // User bisa tetap coba login manual
  }

  $el('loading').classList.add('hidden');
}

// ============================================
// INIT
// ============================================
document.addEventListener('DOMContentLoaded', function() {
  // Init Supabase pakai library yang sama
  if (!initDb()) {
    setFb('error', '‚ùå Gagal koneksi ke database. Refresh halaman.');
  }

  // Set vibe dari preferensi tersimpan
  setVibe(localStorage.getItem(SK.v) || 'cyber');

  // Cek auto-login
  checkAutoLogin();
});
</script>
</body>
</html>
