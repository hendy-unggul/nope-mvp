<!DOCTYPE html>
<html>
<head>
    <title>JEJAK - TEST</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="font-family: system-ui; padding: 20px; background: #0A0A0A; color: white;">

<h2 style="color: #FF4D00;">üöÄ JEJAK - TEST CONNECTION</h2>

<div style="margin: 20px 0; display: flex; gap: 10px;">
    <button id="btnTest" style="padding: 10px 20px; background: #FF4D00; border: none; font-weight: bold; cursor: pointer;">1. TEST KONEKSI</button>
    <button id="btnUpload" style="padding: 10px 20px; background: #39FF14; border: none; font-weight: bold; cursor: pointer;">2. PILIH FOTO</button>
</div>

<div id="log" style="background: #111; border: 2px solid #333; padding: 20px; margin-top: 20px; font-family: monospace; min-height: 200px;"></div>

<input type="file" id="fileInput" accept="image/*" style="display: none;">

<script>
// ============================================
// PASTIIN HANYA SATU KALI DEKLARASI
// ============================================
const SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';

// PAKAI NAMA BERBEDA biar ga bentrok
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const BUCKET = 'artefacts';

// ============================================
// LOGGING
// ============================================
const logEl = document.getElementById('log');

function addLog(msg, type = 'info') {
    const color = type === 'error' ? '#FF006E' : type === 'success' ? '#39FF14' : '#00F0FF';
    logEl.innerHTML += `<div style="color: ${color}; margin: 5px 0; border-bottom: 1px solid #333; padding: 5px;">> ${msg}</div>`;
    console.log(msg);
}

// ============================================
// TEST 1: KONEKSI
// ============================================
document.getElementById('btnTest').onclick = async () => {
    addLog('üîç TEST KONEKSI KE SUPABASE...');
    
    try {
        // Test tabel
        addLog('‚Üí Cek tabel artefacts...');
        const { data, error } = await supabaseClient
            .from('artefacts')
            .select('count')
            .limit(1);
        
        if (error) {
            addLog(`‚ùå Error: ${error.message}`, 'error');
            addLog(`üìã Detail: ${JSON.stringify(error)}`, 'error');
        } else {
            addLog('‚úì Koneksi database OK', 'success');
        }
        
        // Test bucket
        addLog('‚Üí Cek storage bucket...');
        const { data: buckets, error: bucketError } = await supabaseClient
            .storage
            .listBuckets();
        
        if (bucketError) {
            addLog(`‚ùå Storage error: ${bucketError.message}`, 'error');
        } else {
            const bucketExists = buckets.find(b => b.name === BUCKET);
            addLog(`‚úì Bucket ditemukan: ${bucketExists ? 'YES' : 'NO'}`, bucketExists ? 'success' : 'error');
        }
        
    } catch (e) {
        addLog(`‚ùå Exception: ${e.message}`, 'error');
    }
};

// ============================================
// TEST 2: UPLOAD
// ============================================
const fileInput = document.getElementById('fileInput');
const btnUpload = document.getElementById('btnUpload');

btnUpload.onclick = () => {
    addLog('üìÇ Pilih file foto...');
    fileInput.click();
};

fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    addLog(`üì∏ File: ${file.name} (${(file.size/1024).toFixed(1)}KB)`);
    
    // Generate nama file unik
    const fileName = `test-${Date.now()}.${file.name.split('.').pop() || 'jpg'}`;
    
    try {
        // STEP 1: UPLOAD
        addLog('‚Üí Upload ke storage...');
        const { error: uploadError } = await supabaseClient.storage
            .from(BUCKET)
            .upload(fileName, file);
        
        if (uploadError) {
            addLog(`‚ùå Upload gagal: ${uploadError.message}`, 'error');
            return;
        }
        addLog('‚úì Upload sukses', 'success');
        
        // STEP 2: GET URL
        const { data: { publicUrl } } = supabaseClient.storage
            .from(BUCKET)
            .getPublicUrl(fileName);
        addLog(`‚Üí URL: ${publicUrl}`);
        
        // STEP 3: INSERT DATABASE
        addLog('‚Üí Insert ke database...');
        const { error: insertError } = await supabaseClient
            .from('artefacts')
            .insert({
                user_id: 'test-user',
                username: 'tester',
                url: publicUrl,
                note: 'test upload',
                has_face: false,
                faces: []
            });
        
        if (insertError) {
            addLog(`‚ùå Insert gagal: ${insertError.message}`, 'error');
            addLog(`üìã Detail: ${JSON.stringify(insertError)}`, 'error');
        } else {
            addLog('‚úì Insert sukses', 'success');
        }
        
    } catch (err) {
        addLog(`‚ùå Error: ${err.message}`, 'error');
    }
    
    // Reset input
    fileInput.value = '';
};

addLog('‚úÖ READY - Klik tombol "TEST KONEKSI" dulu');
</script>
</body>
</html>
