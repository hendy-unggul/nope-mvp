<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>jejak â€” dashboard âœ¨</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700;900&family=Bebas+Neue&family=Courier+Prime:wght@400;700&family=Rubik:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    /* [CSS SAMA SEPERTI SEBELUMNYA - TIDAK BERUBAH] */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg: #0a0a0a;
      --surface: #121212;
      --text: #ffffff;
      --muted: #999999;
      --accent: #00ff88;
      --accent-2: #ff3366;
      --accent-3: #ffff00;
      --accent-4: #00d4ff;
      --border: #333;
      --font-main: 'DM Sans', sans-serif;
      --font-display: 'Bebas Neue', sans-serif;
      --font-mono: 'Courier Prime', monospace;
      --font-alt: 'Rubik', sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-main);
      min-height: 100vh;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    /* Header dengan user name di kanan atas */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: rgba(0,0,0,0.3);
      border: 2px solid var(--border);
      border-radius: 60px;
      margin-bottom: 30px;
      backdrop-filter: blur(10px);
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .logo-small {
      font-family: var(--font-display);
      font-size: 32px;
      color: var(--accent);
      text-transform: lowercase;
      filter: drop-shadow(2px 2px 0px var(--accent-2));
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255,255,255,0.05);
      padding: 8px 16px 8px 12px;
      border-radius: 40px;
      border: 1px solid var(--accent-4);
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #000;
    }

    .user-name {
      font-family: var(--font-mono);
      font-size: 16px;
      font-weight: 700;
      color: var(--accent-4);
    }

    .user-name::before {
      content: '@';
      opacity: 0.7;
      margin-right: 2px;
    }

    /* Container utama */
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Welcome section */
    .welcome-section {
      text-align: center;
      margin-bottom: 40px;
    }

    .welcome-title {
      font-family: var(--font-display);
      font-size: 48px;
      color: var(--text);
      text-transform: lowercase;
      letter-spacing: 2px;
    }

    .welcome-title span {
      color: var(--accent);
      background: rgba(0,255,136,0.1);
      padding: 0 10px;
      border-radius: 20px;
    }

    /* Upload section */
    .upload-section {
      background: var(--surface);
      border: 4px solid var(--accent-3);
      border-radius: 40px;
      padding: 40px;
      margin-bottom: 40px;
      text-align: center;
      transform: rotate(-0.5deg);
      box-shadow: 12px 12px 0 rgba(255,255,0,0.2);
    }

    .upload-title {
      font-family: var(--font-display);
      font-size: 36px;
      margin-bottom: 20px;
      color: var(--accent-3);
    }

    .upload-area {
      border: 4px dashed var(--border);
      border-radius: 30px;
      padding: 50px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .upload-area:hover {
      border-color: var(--accent);
      background: rgba(0,255,136,0.05);
      transform: scale(1.02);
    }

    .upload-area.dragover {
      border-color: var(--accent-3);
      background: rgba(255,255,0,0.1);
      transform: scale(1.05);
    }

    .upload-icon {
      font-size: 64px;
      margin-bottom: 16px;
      animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    .upload-text {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--accent-3);
    }

    .upload-hint {
      font-family: var(--font-mono);
      color: var(--muted);
      font-size: 14px;
    }

    .upload-progress {
      margin-top: 20px;
      display: none;
    }

    .upload-progress.show {
      display: block;
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      background: var(--border);
      border-radius: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-3));
      width: 0%;
      transition: width 0.3s ease;
    }

    .upload-status {
      margin-top: 20px;
      font-family: var(--font-mono);
      font-size: 14px;
      color: var(--accent);
    }

    /* 3 Tabs Connection */
    .tabs-section {
      margin-bottom: 40px;
    }

    .tabs-container {
      background: var(--surface);
      border: 3px solid var(--accent-4);
      border-radius: 30px;
      overflow: hidden;
    }

    .tab-headers {
      display: flex;
      border-bottom: 2px solid var(--border);
    }

    .tab-btn {
      flex: 1;
      padding: 20px;
      background: transparent;
      border: none;
      color: var(--text);
      font-family: var(--font-alt);
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .tab-btn::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 3px;
      background: var(--accent-4);
      transition: width 0.3s ease;
    }

    .tab-btn:hover::before {
      width: 80%;
    }

    .tab-btn.active {
      background: rgba(0,212,255,0.1);
      color: var(--accent-4);
    }

    .tab-btn.active::before {
      width: 80%;
      background: var(--accent-4);
    }

    .tab-panels {
      padding: 30px;
      min-height: 300px;
    }

    .tab-panel {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .tab-panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Connection cards */
    .connections-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
    }

    .connection-card {
      background: rgba(255,255,255,0.03);
      border: 2px solid var(--border);
      border-radius: 20px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .connection-card:hover {
      transform: translateY(-5px) rotate(1deg);
      border-color: var(--accent-4);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .card-username {
      font-family: var(--font-mono);
      font-weight: 700;
      color: var(--accent-4);
    }

    .card-status {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 2s infinite;
    }

    .card-status.offline {
      background: var(--muted);
      animation: none;
    }

    .card-message {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 12px;
      font-style: italic;
    }

    .card-time {
      font-size: 11px;
      color: var(--muted);
      text-align: right;
    }

    /* Feed items */
    .feed-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .feed-item {
      display: flex;
      gap: 16px;
      padding: 16px;
      background: rgba(255,255,255,0.02);
      border-radius: 16px;
      border-left: 4px solid var(--accent-2);
    }

    .feed-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-2), var(--accent-3));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #000;
    }

    .feed-content {
      flex: 1;
    }

    .feed-user {
      font-weight: 700;
      color: var(--accent-2);
      margin-bottom: 4px;
    }

    .feed-text {
      color: var(--text);
      margin-bottom: 8px;
    }

    .feed-time {
      font-size: 11px;
      color: var(--muted);
    }

    /* Artefak items */
    .artefak-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
    }

    .artefak-card {
      background: rgba(255,255,255,0.03);
      border: 2px solid var(--border);
      border-radius: 20px;
      padding: 16px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .artefak-card:hover {
      border-color: var(--accent-3);
      transform: scale(1.05);
    }

    .artefak-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .artefak-name {
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--accent-3);
    }

    .artefak-size {
      font-size: 12px;
      color: var(--muted);
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 30px 0;
      border-top: 2px solid var(--border);
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--muted);
    }

    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
    }
    
    .loading-overlay.hidden {
      display: none;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 16px;
        border-radius: 30px;
      }

      .upload-section {
        padding: 20px;
      }

      .tab-btn {
        font-size: 14px;
        padding: 15px;
      }

      .connections-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">memuat jejak mu...</div>
  </div>

  <div class="main-container">
    <!-- Header dengan user name di kanan atas -->
    <header class="header">
      <div class="logo-small">jejak</div>
      <div class="user-profile" id="user-profile">
        <div class="user-avatar" id="user-avatar">ðŸ‘¤</div>
        <div class="user-name" id="user-name">anon</div>
      </div>
    </header>

    <!-- Welcome section -->
    <section class="welcome-section">
      <h1 class="welcome-title">
        halo, <span id="welcome-user">@anon</span> ðŸ‘‹
      </h1>
    </section>

    <!-- CTA Upload Artefak (Pakai tabel artefacts yang sudah ada) -->
    <section class="upload-section">
      <h2 class="upload-title">unggah artefak ðŸš€</h2>
      <div class="upload-area" id="upload-area">
        <div class="upload-icon">âœ¨</div>
        <div class="upload-text">drop file atau klik untuk unggah</div>
        <div class="upload-hint">jpg, png, gif, pdf, mp4 (maks 50mb)</div>
        
        <!-- Progress bar (hidden by default) -->
        <div class="upload-progress" id="upload-progress">
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
          </div>
          <div class="upload-status" id="upload-status">mengunggah 0%</div>
        </div>
      </div>
      <input type="file" id="file-input" style="display: none;" multiple>
    </section>

    <!-- 3 Tabs Connection (Pakai tabel existing) -->
    <section class="tabs-section">
      <div class="tabs-container">
        <div class="tab-headers">
          <button class="tab-btn active" data-tab="connections">koneksi ðŸ”—</button>
          <button class="tab-btn" data-tab="feed">spills ðŸ“±</button>
          <button class="tab-btn" data-tab="artefak">artefak ðŸ’Ž</button>
        </div>
        
        <div class="tab-panels">
          <!-- Tab 1: Connections (Pakai tabel matches atau chats) -->
          <div class="tab-panel active" id="panel-connections">
            <div class="connections-grid" id="connections-grid">
              <!-- Connections will be loaded here -->
            </div>
          </div>
          
          <!-- Tab 2: Feed/Spills (Pakai tabel spills yang sudah ada) -->
          <div class="tab-panel" id="panel-feed">
            <div class="feed-list" id="feed-list">
              <!-- Spills akan dimuat dari tabel spills -->
            </div>
          </div>
          
          <!-- Tab 3: Artefak (Pakai tabel artefacts yang sudah ada) -->
          <div class="tab-panel" id="panel-artefak">
            <div class="artefak-grid" id="artefak-grid">
              <!-- Artefak akan dimuat dari tabel artefacts -->
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
      <div>jejak Â· ruang aman buat kamu yang overthink</div>
      <div style="margin-top: 8px;">soul by itsALrUdio Â· v2.0</div>
    </footer>
  </div>

  <script>
    // ================================================================
    // CONFIG - PAKAI TABEL YANG SUDAH ADA
    // ================================================================
    const SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';
    
    // ðŸ”¥ PAKAI TABEL YANG SUDAH ADA (dari screenshot)
    const USERS_TABLE = 'jejak_users';        // untuk user data
    const ARTEFAK_TABLE = 'artefacts';        // untuk menyimpan file
    const SPILLS_TABLE = 'spills';             // untuk feed/postingan
    const MATCHES_TABLE = 'matches';           // untuk koneksi antar user
    const REACTIONS_TABLE = 'reactions';       // untuk likes
    const COMMENTS_TABLE = 'comments';          // untuk komentar

    const SK = {
      username: 'jejak_username',
      sessionId: 'jejak_session_id',
      loggedIn: 'jejak_logged_in',
      vibe: 'jejak_vibe',
    };

    // ================================================================
    // UTILS
    // ================================================================
    function getSessionId() {
      return localStorage.getItem(SK.sessionId) || '';
    }

    function getUsername() {
      return localStorage.getItem(SK.username) || 'anon';
    }

    async function sbFetch(table, method = 'GET', body = null, qs = '') {
      const url = `${SUPABASE_URL}/rest/v1/${table}${qs}`;
      console.log('Fetching:', url);
      
      const res = await fetch(url, {
        method,
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': method === 'POST' ? 'return=representation' : ''
        },
        body: body ? JSON.stringify(body) : undefined
      });
      
      const text = await res.text();
      if (!res.ok) throw new Error(text || `HTTP ${res.status}`);
      return text ? JSON.parse(text) : [];
    }

    // ================================================================
    // CHECK SESSION & UPDATE UI
    // ================================================================
    async function checkSession() {
      const username = getUsername();
      const sessionId = getSessionId();
      
      // Update UI with username (FIX #1: @anon becomes user.name)
      document.getElementById('user-name').textContent = username;
      document.getElementById('welcome-user').textContent = '@' + username;
      
      // Set avatar initial
      const avatar = document.getElementById('user-avatar');
      avatar.textContent = username.charAt(0).toUpperCase();
      
      try {
        // Verify session with Supabase - pakai jejak_users
        const data = await sbFetch(USERS_TABLE, 'GET', null,
          `?username=eq.${encodeURIComponent(username)}&select=username,session_id&limit=1`
        );
        
        if (data.length === 0 || data[0].session_id !== sessionId) {
          // Session invalid, redirect to login
          window.location.href = 'index.html';
          return;
        }
        
        // Load all data from existing tables
        loadConnections();  // dari tabel matches
        loadSpills();       // dari tabel spills
        loadArtefak();      // dari tabel artefacts
        
      } catch (e) {
        console.error('Session check error:', e);
        // Still try to load data
        loadConnections();
        loadSpills();
        loadArtefak();
      }
      
      // Hide loading overlay
      setTimeout(() => {
        document.getElementById('loading-overlay').classList.add('hidden');
      }, 500);
    }

    // ================================================================
    // LOAD CONNECTIONS - PAKAI TABEL MATCHES
    // ================================================================
    async function loadConnections() {
      const grid = document.getElementById('connections-grid');
      
      try {
        // ðŸ”¥ AMBIL DARI TABEL MATCHES YANG SUDAH ADA
        // Asumsi struktur: matches punya user1, user2, status, last_active
        const currentUser = getUsername();
        
        // Coba fetch dari tabel matches
        let connections = [];
        try {
          // Cari matches dimana currentUser terlibat
          const data = await sbFetch(MATCHES_TABLE, 'GET', null,
            `?or=(user1.eq.${encodeURIComponent(currentUser)},user2.eq.${encodeURIComponent(currentUser)})&status=eq.active&order=last_active.desc&limit=20`
          );
          
          if (data && data.length > 0) {
            connections = data.map(match => {
              const otherUser = match.user1 === currentUser ? match.user2 : match.user1;
              return {
                username: otherUser,
                status: match.last_active && (Date.now() - new Date(match.last_active).getTime() < 5*60000) ? 'online' : 'offline',
                message: match.status_message || 'available',
                time: formatTime(match.last_active)
              };
            });
          }
        } catch (e) {
          console.log('Matches table maybe empty, using mock data:', e);
        }
        
        // Fallback ke mock data jika tabel kosong
        if (connections.length === 0) {
          connections = [
            { username: 'over.thinker', status: 'online', message: 'sedang mikir berat', time: '2 menit lalu' },
            { username: 'tired.soul', status: 'offline', message: 'tidur dulu bestie', time: '1 jam lalu' },
            { username: 'aku.anonim', status: 'online', message: 'nunggu sinyal', time: '5 menit lalu' },
          ];
        }
        
        grid.innerHTML = connections.map(conn => `
          <div class="connection-card">
            <div class="card-header">
              <span class="card-username">@${conn.username}</span>
              <span class="card-status ${conn.status === 'offline' ? 'offline' : ''}"></span>
            </div>
            <div class="card-message">"${conn.message}"</div>
            <div class="card-time">${conn.time}</div>
          </div>
        `).join('');
        
      } catch (e) {
        console.error('Error loading connections:', e);
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--muted);">gagal memuat koneksi</div>';
      }
    }

    // ================================================================
    // LOAD SPILLS - PAKAI TABEL SPILLS
    // ================================================================
    async function loadSpills() {
      const feedList = document.getElementById('feed-list');
      
      try {
        // ðŸ”¥ AMBIL DARI TABEL SPILLS YANG SUDAH ADA
        let spills = [];
        try {
          // Ambil spills terbaru
          const data = await sbFetch(SPILLS_TABLE, 'GET', null,
            `?select=*,${USERS_TABLE}!inner(username)&order=created_at.desc&limit=20`
          );
          
          if (data && data.length > 0) {
            spills = data.map(spill => ({
              username: spill.username,
              text: spill.content || spill.text || spill.message,
              time: formatTime(spill.created_at)
            }));
          }
        } catch (e) {
          console.log('Spills table maybe empty, using mock data:', e);
        }
        
        // Fallback ke mock data
        if (spills.length === 0) {
          spills = [
            { username: 'over.thinker', text: 'hari ini productive ga sih?', time: '5 menit lalu' },
            { username: 'self.care', text: 'minum air putih dulu yuk!', time: '15 menit lalu' },
            { username: 'tired.soul', text: 'capek tapi gamau tidur ðŸ¥²', time: '25 menit lalu' },
          ];
        }
        
        feedList.innerHTML = spills.map(item => `
          <div class="feed-item">
            <div class="feed-avatar">${item.username.charAt(0)}</div>
            <div class="feed-content">
              <div class="feed-user">@${item.username}</div>
              <div class="feed-text">${item.text}</div>
              <div class="feed-time">${item.time}</div>
            </div>
          </div>
        `).join('');
        
      } catch (e) {
        console.error('Error loading spills:', e);
        feedList.innerHTML = '<div style="text-align: center; color: var(--muted);">gagal memuat spills</div>';
      }
    }

    // ================================================================
    // LOAD ARTEFAK - PAKAI TABEL ARTEFACTS
    // ================================================================
    async function loadArtefak() {
      const artefakGrid = document.getElementById('artefak-grid');
      
      try {
        // ðŸ”¥ AMBIL DARI TABEL ARTEFACTS YANG SUDAH ADA
        const currentUser = getUsername();
        let artefacts = [];
        
        try {
          // Ambil artefacts milik current user
          const data = await sbFetch(ARTEFAK_TABLE, 'GET', null,
            `?username=eq.${encodeURIComponent(currentUser)}&order=uploaded_at.desc&limit=20`
          );
          
          if (data && data.length > 0) {
            artefacts = data.map(art => ({
              name: art.filename || art.name || 'untitled',
              size: formatFileSize(art.filesize || art.size || 0),
              icon: getFileIcon(art.filetype || art.type || '')
            }));
          }
        } catch (e) {
          console.log('Artefacts table maybe empty, using mock data:', e);
        }
        
        // Fallback ke mock data
        if (artefacts.length === 0) {
          artefacts = [
            { name: 'moodboard-1.jpg', size: '2.4 MB', icon: 'ðŸ–¼ï¸' },
            { name: 'sketsa-hari-ini.png', size: '1.8 MB', icon: 'ðŸŽ¨' },
            { name: 'catatan-random.pdf', size: '524 KB', icon: 'ðŸ“„' },
          ];
        }
        
        artefakGrid.innerHTML = artefacts.map(art => `
          <div class="artefak-card">
            <div class="artefak-icon">${art.icon}</div>
            <div class="artefak-name">${art.name}</div>
            <div class="artefak-size">${art.size}</div>
          </div>
        `).join('');
        
      } catch (e) {
        console.error('Error loading artefacts:', e);
        artefakGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--muted);">gagal memuat artefak</div>';
      }
    }

    // ================================================================
    // HELPER FUNCTIONS
    // ================================================================
    function formatTime(timestamp) {
      if (!timestamp) return 'waktu tidak diketahui';
      
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);
      
      if (diffMins < 1) return 'baru saja';
      if (diffMins < 60) return diffMins + ' menit lalu';
      if (diffHours < 24) return diffHours + ' jam lalu';
      return diffDays + ' hari lalu';
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function getFileIcon(filetype) {
      if (filetype.includes('image')) return 'ðŸ–¼ï¸';
      if (filetype.includes('video')) return 'ðŸŽ¬';
      if (filetype.includes('audio')) return 'ðŸŽµ';
      if (filetype.includes('pdf')) return 'ðŸ“„';
      if (filetype.includes('zip')) return 'ðŸ“¦';
      return 'ðŸ“';
    }

    // ================================================================
    // UPLOAD ARTEFAK - SIMPAN KE TABEL ARTEFACTS
    // ================================================================
    function setupUpload() {
      const uploadArea = document.getElementById('upload-area');
      const fileInput = document.getElementById('file-input');
      const progressDiv = document.getElementById('upload-progress');
      const progressFill = document.getElementById('progress-fill');
      const uploadStatus = document.getElementById('upload-status');
      
      // Click to upload
      uploadArea.addEventListener('click', () => {
        fileInput.click();
      });
      
      // Drag & drop handlers
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFiles(files);
        }
      });
      
      // File input change
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFiles(e.target.files);
        }
      });
      
      // Handle file upload
      async function handleFiles(files) {
        progressDiv.classList.add('show');
        
        const totalFiles = files.length;
        let completed = 0;
        const currentUser = getUsername();
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          
          try {
            // Simulasi upload progress
            await simulateFileUpload(file, (progress) => {
              const overallProgress = ((completed + (progress/100)) / totalFiles) * 100;
              progressFill.style.width = overallProgress + '%';
              uploadStatus.textContent = `mengunggah ${Math.round(overallProgress)}%`;
            });
            
            // ðŸ”¥ SIMPAN KE TABEL ARTEFACTS
            await sbFetch(ARTEFAK_TABLE, 'POST', {
              username: currentUser,
              filename: file.name,
              filesize: file.size,
              filetype: file.type || 'application/octet-stream',
              uploaded_at: new Date().toISOString(),
              // url: nanti diisi setelah upload ke storage
            });
            
            completed++;
            
          } catch (e) {
            console.error('Upload error:', e);
            uploadStatus.textContent = `âŒ gagal upload ${file.name}`;
          }
        }
        
        // Selesai semua
        setTimeout(() => {
          progressDiv.classList.remove('show');
          uploadStatus.textContent = 'âœ… upload selesai!';
          progressFill.style.width = '0%';
          
          // Refresh artefak list
          loadArtefak();
          
          setTimeout(() => {
            uploadStatus.textContent = '';
          }, 3000);
        }, 500);
      }
      
      function simulateFileUpload(file, onProgress) {
        return new Promise((resolve) => {
          let progress = 0;
          const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress >= 100) {
              progress = 100;
              clearInterval(interval);
              resolve();
            }
            onProgress(progress);
          }, 150);
        });
      }
    }

    // ================================================================
    // TAB SWITCHING
    // ================================================================
    function setupTabs() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      
      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          tabBtns.forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
          
          btn.classList.add('active');
          const tabName = btn.dataset.tab;
          document.getElementById(`panel-${tabName}`).classList.add('active');
        });
      });
    }

    // ================================================================
    // VIBE
    // ================================================================
    const VIBES = {
      cyber:  { accent:'#00ff88', accent2:'#ff3366', accent3:'#ffff00', accent4:'#00d4ff' },
      neon:   { accent:'#ff10f0', accent2:'#00ff88', accent3:'#ffff00', accent4:'#00d4ff' },
      retro:  { accent:'#ff6b35', accent2:'#f7b801', accent3:'#6a994e', accent4:'#bc4749' },
      pastel: { accent:'#ffc8dd', accent2:'#bde0fe', accent3:'#a2d2ff', accent4:'#ffafcc' }
    };
    
    function loadVibe() {
      const saved = localStorage.getItem(SK.vibe) || 'cyber';
      const c = VIBES[saved];
      if (c) {
        document.documentElement.style.setProperty('--accent', c.accent);
        document.documentElement.style.setProperty('--accent-2', c.accent2);
        document.documentElement.style.setProperty('--accent-3', c.accent3);
        document.documentElement.style.setProperty('--accent-4', c.accent4);
      }
    }

    // ================================================================
    // LOGOUT
    // ================================================================
    function setupLogout() {
      document.getElementById('user-profile').addEventListener('dblclick', () => {
        if (confirm('logout dari jejak?')) {
          localStorage.removeItem(SK.username);
          localStorage.removeItem(SK.loggedIn);
          window.location.href = 'index.html';
        }
      });
    }

    // ================================================================
    // INIT
    // ================================================================
    window.addEventListener('DOMContentLoaded', () => {
      loadVibe();
      checkSession();
      setupUpload();
      setupTabs();
      setupLogout();
    });
  </script>
</body>
</html>
