<!DOCTYPE html>
<html lang="id" data-theme="brutalgenz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>JEJAK ‚Äî Spill Your Truth</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.13/dist/face-api.min.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- PATCH 1: Handwriting font untuk empathy -->
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    :root{--bg:#0A0A0A;--surface:#141414;--surface-elevated:#1E1E1E;--border:#2A2A2A;--border-accent:#FF4D00;--text:#FFF;--text-secondary:#888;--text-muted:#555;--accent-primary:#FF4D00;--accent-secondary:#00F0FF;--accent-tertiary:#FF006E;--accent-quaternary:#39FF14;--accent-warm:#FFD700;--mood-surviving:#FF9500;--mood-thriving:#39FF14;--mood-chaotic:#00F0FF;--mood-doom:#8B5CF6;--radius:0;--space-xs:4px;--space-sm:8px;--space-md:16px;--space-lg:24px;--space-xl:32px}
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    html{scroll-behavior:smooth}
    body{background:var(--bg);color:var(--text);font-family:'Plus Jakarta Sans',system-ui,sans-serif;font-weight:500;font-size:15px;line-height:1.4;min-height:100vh;overflow-x:hidden;padding-bottom:100px}
    body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:0.4}
    .wrapper{max-width:480px;margin:0 auto;padding:0 var(--space-md)}
    
    header{padding:var(--space-lg) 0 var(--space-md);display:flex;justify-content:space-between;align-items:flex-start}
    .logo{font-size:42px;font-weight:800;letter-spacing:-0.04em;cursor:pointer;line-height:0.9;position:relative}
    .logo::before,.logo::after{content:'JEJAK';position:absolute;top:0;left:0;opacity:0;transition:opacity 0.1s}
    .logo::before{color:var(--accent-secondary);transform:translate(-2px,0)}
    .logo::after{color:var(--accent-tertiary);transform:translate(2px,0)}
    .logo:hover::before{opacity:0.8;animation:g 0.3s infinite}
    @keyframes g{0%,100%{transform:translate(-2px,0)}25%{transform:translate(2px,2px)}50%{transform:translate(-2px,-2px)}75%{transform:translate(2px,0)}}
    .tagline{font-family:'Instrument Serif',serif;font-size:13px;color:var(--text-secondary);font-style:italic;margin-top:var(--space-xs)}
    .top-right{display:flex;flex-direction:column;align-items:flex-end;gap:var(--space-sm)}
    .status-indicator{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-muted)}
    .status-dot{width:6px;height:6px;background:var(--accent-quaternary);border-radius:50%;animation:p 2s infinite}
    @keyframes p{0%,100%{opacity:1}50%{opacity:0.3}}
    .sync-status{font-size:10px;color:var(--text-muted);display:flex;align-items:center;gap:4px}
    .sync-status::before{content:'‚Ä¢'}
    .sync-status.online{color:var(--accent-quaternary)}
    .sync-status.offline{color:var(--accent-tertiary)}
    .sync-status.syncing{color:var(--accent-warm)}
    
    .filter-controls{display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-sm);padding:var(--space-sm) 0;border-bottom:1px solid var(--border)}
    .filter-info{display:flex;align-items:center;gap:var(--space-sm)}
    .filter-badge{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;padding:4px 8px;background:var(--surface-elevated);border:1px solid var(--border);color:var(--text-secondary)}
    .filter-toggle{display:flex;align-items:center;gap:var(--space-sm);background:var(--surface);border:2px solid var(--border);padding:6px 12px;cursor:pointer;transition:all 0.2s}
    .filter-toggle:hover{border-color:var(--accent-primary)}
    .filter-toggle.active{background:var(--accent-primary);border-color:var(--accent-primary);color:var(--bg)}
    .filter-icon{font-size:16px}
    .filter-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em}
    
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:2px solid var(--border);z-index:1000;padding-bottom:env(safe-area-inset-bottom)}
    .nav-container{max-width:480px;margin:0 auto;display:flex;justify-content:space-around;align-items:center;height:64px}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;height:100%;color:var(--text-muted);text-decoration:none;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;transition:all 0.2s;position:relative;cursor:pointer}
    .nav-item::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:0;height:2px;background:var(--accent-primary);transition:width 0.2s}
    .nav-item:hover{color:var(--text-secondary);background:var(--surface-elevated)}
    .nav-item.active{color:var(--accent-primary)}
    .nav-item.active::before{width:100%}
    .nav-icon{font-size:20px;line-height:1}
    
    .hero-section{position:relative;margin:0 calc(-1 * var(--space-md));margin-bottom:var(--space-lg)}
    .hero{position:relative;width:100%;aspect-ratio:1/1;overflow:hidden;border-top:2px solid var(--border);border-bottom:2px solid var(--border);background:var(--surface)}
    .hero img{width:100%;height:100%;object-fit:cover;transition:transform 0.6s,filter 0.3s}
    .hero:hover img{transform:scale(1.03)}
    .hero::after{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.03) 2px,rgba(0,0,0,0.03) 4px);pointer-events:none}
    .hero-notation{position:absolute;bottom:0;left:0;right:0;padding:var(--space-md);background:linear-gradient(to top,rgba(0,0,0,0.9),transparent);font-family:'Instrument Serif',serif;font-size:24px;font-style:italic;color:var(--text);line-height:1.2;z-index:20}
    
    .face-scribble{position:absolute;background:rgba(0,0,0,0.95);pointer-events:none;z-index:15;overflow:hidden}
    .face-scribble::before{content:'';position:absolute;inset:0;background-image:repeating-linear-gradient(90deg,transparent,transparent 2px,rgba(255,255,255,0.1) 2px,rgba(255,255,255,0.1) 4px),repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(255,255,255,0.05) 2px,rgba(255,255,255,0.05) 4px)}
    .marker-lines{position:absolute;inset:0;background-image:repeating-linear-gradient(-45deg,transparent,transparent 3px,rgba(0,0,0,0.8) 3px,rgba(0,0,0,0.8) 6px)}
    
    .upload-controls{position:absolute;top:var(--space-md);right:var(--space-md);display:flex;flex-direction:column;gap:var(--space-sm);align-items:flex-end;z-index:20}
    .upload-btn{width:48px;height:48px;background:var(--accent-primary);border:none;color:var(--bg);font-size:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;box-shadow:4px 4px 0 var(--bg),4px 4px 0 2px var(--accent-primary);position:relative}
    .upload-btn:hover:not(:disabled){transform:translate(2px,2px);box-shadow:2px 2px 0 var(--bg),2px 2px 0 2px var(--accent-primary)}
    .upload-btn:disabled{background:var(--text-muted);box-shadow:none;cursor:not-allowed;opacity:0.6}
    .upload-counter{position:absolute;top:-8px;right:-8px;background:var(--accent-tertiary);color:var(--text);font-size:10px;font-weight:700;padding:2px 6px;min-width:20px;text-align:center}
    .quota-timer{background:var(--surface);border:2px solid var(--border);padding:var(--space-sm) var(--space-md);font-size:11px;color:var(--text-secondary);max-width:200px;text-align:right}
    .quota-timer.urgent{border-color:var(--accent-tertiary);color:var(--accent-tertiary);animation:pb 2s infinite}
    @keyframes pb{0%,100%{border-color:var(--accent-tertiary)}50%{border-color:var(--text-muted)}}
    
    .input-section{margin-bottom:var(--space-xl)}
    .input-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-sm)}
    .input-label{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-secondary)}
    .char-count{font-size:12px;color:var(--text-muted);font-variant-numeric:tabular-nums}
    .rant-input{width:100%;background:var(--surface);border:2px solid var(--border);padding:var(--space-md);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:16px;line-height:1.5;resize:none;min-height:120px;transition:all 0.2s}
    .rant-input:focus{outline:none;border-color:var(--accent-primary);background:var(--surface-elevated)}
    .rant-input::placeholder{color:var(--text-muted)}
    
    .mood-section{margin:var(--space-md) 0}
    .mood-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-secondary);margin-bottom:var(--space-sm)}
    .mood-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--space-sm)}
    .mood-card{position:relative;padding:var(--space-md);background:var(--surface);border:2px solid var(--border);cursor:pointer;transition:all 0.2s;display:flex;flex-direction:column;gap:var(--space-xs)}
    .mood-card:hover{border-color:var(--text-secondary);transform:translateY(-2px)}
    .mood-card.active{border-color:currentColor;background:var(--surface-elevated)}
    .mood-card.active::before{content:'‚úì';position:absolute;top:8px;right:8px;font-size:12px;font-weight:700}
    .mood-emoji{font-size:28px;line-height:1}
    .mood-name{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em}
    .mood-desc{font-size:11px;color:var(--text-secondary)}
    .mood-card[data-mood="surviving"]{color:var(--mood-surviving)}
    .mood-card[data-mood="thriving"]{color:var(--mood-thriving)}
    .mood-card[data-mood="chaotic"]{color:var(--mood-chaotic)}
    .mood-card[data-mood="doom"]{color:var(--mood-doom)}
    
    .input-actions{display:flex;justify-content:flex-end;margin-top:var(--space-md)}
    .submit-btn{padding:14px 32px;font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;background:var(--accent-primary);border:none;color:var(--bg);cursor:pointer;transition:all 0.2s;box-shadow:4px 4px 0 var(--surface-elevated),4px 4px 0 2px var(--accent-primary)}
    .submit-btn:hover:not(:disabled){transform:translate(2px,2px);box-shadow:2px 2px 0 var(--surface-elevated),2px 2px 0 2px var(--accent-primary)}
    .submit-btn:disabled{opacity:0.5;cursor:not-allowed;box-shadow:none}
    
    .section-header{display:flex;align-items:center;gap:var(--space-sm);margin-bottom:var(--space-md);padding-bottom:var(--space-sm);border-bottom:2px solid var(--border)}
    .section-title{font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:0.15em;color:var(--text)}
    .section-line{flex:1;height:2px;background:var(--border)}
    
    .entry{background:var(--surface);border:2px solid var(--border);margin-bottom:var(--space-md);position:relative;animation:si 0.4s ease}
    @keyframes si{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .entry:hover{border-color:var(--border-accent)}
    .entry-header{display:flex;justify-content:space-between;align-items:center;padding:var(--space-sm) var(--space-md);border-bottom:1px solid var(--border);background:var(--surface-elevated)}
    .entry-meta{display:flex;align-items:center;gap:var(--space-sm)}
    .entry-time{font-size:11px;color:var(--text-muted);font-weight:600;letter-spacing:0.05em}
    .entry-mood{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;padding:4px 8px;border:1px solid currentColor}
    .entry-mood.surviving{color:var(--mood-surviving)}
    .entry-mood.thriving{color:var(--mood-thriving)}
    .entry-mood.chaotic{color:var(--mood-chaotic)}
    .entry-mood.doom{color:var(--mood-doom)}
    .entry-content{padding:var(--space-md);font-size:15px;line-height:1.6;color:var(--text)}
    .spill-status{display:flex;align-items:center;gap:var(--space-xs);font-size:10px;color:var(--text-muted);margin-top:var(--space-xs)}
    .spill-status.spilled{color:var(--accent-secondary)}
    
    .fifo-indicator{font-size:9px;color:var(--text-muted);background:var(--surface-elevated);padding:2px 6px;border:1px dashed var(--border);text-transform:uppercase;letter-spacing:0.05em}
    
    /* PATCH 1: Empathy styles dengan handwriting font */
    .empathy-text {
      font-family: 'Caveat', cursive;
      font-size: 19px;
      color: var(--text);
      text-align: center;
      padding: var(--space-md);
      background: var(--surface-elevated);
      border-top: 1px solid var(--border);
      line-height: 1.3;
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    .empathy-highlight {
      color: var(--accent-primary);
      font-size: 24px;
      font-weight: 700;
    }
    
    /* Vibe Bar + Lock untuk rant sendiri */
    .vibe-bar{display:flex;border-top:1px solid var(--border);background:var(--surface-elevated)}
    .vibe-bar.locked {
      opacity: 0.35;
      pointer-events: none;
      position: relative;
    }
    .vibe-bar.locked::after {
      content: 'üîí Tidak bisa react rant sendiri';
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.85);
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    
    .vibe-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:var(--space-sm) 4px;background:transparent;border:none;border-right:1px solid var(--border);color:var(--text-secondary);cursor:pointer;transition:all 0.15s;position:relative}
    .vibe-btn:last-child{border-right:none}
    .vibe-btn:hover:not(:disabled){background:var(--surface);color:var(--text)}
    .vibe-btn.vibed{background:var(--surface)}
    .vibe-btn.vibed .vibe-emoji{filter:none;transform:scale(1.15);text-shadow:0 0 10px currentColor}
    .vibe-btn.vibed .vibe-count{color:var(--text);font-weight:700}
    .vibe-btn:disabled{opacity:0.5;cursor:not-allowed}
    .vibe-emoji{font-size:24px;line-height:1;filter:grayscale(0.4);transition:all 0.2s}
    .vibe-btn:hover:not(:disabled) .vibe-emoji{filter:none;transform:scale(1.1)}
    .vibe-count{font-size:11px;font-weight:600;color:var(--text-muted);min-width:20px;text-align:center}
    .vibe-label{position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%) translateY(4px);background:var(--text);color:var(--bg);padding:6px 10px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;white-space:nowrap;opacity:0;visibility:hidden;transition:all 0.2s;pointer-events:none}
    .vibe-btn:hover:not(:disabled) .vibe-label{opacity:1;visibility:visible;transform:translateX(-50%) translateY(0)}
    
    .tray-section{margin-bottom:var(--space-xl)}
    .tray-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:2px;background:var(--border);border:2px solid var(--border)}
    .tray-item{aspect-ratio:1;background:var(--surface);position:relative;overflow:hidden;cursor:pointer}
    .tray-item.empty{display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:20px;border:2px dashed var(--border)}
    .tray-item img{width:100%;height:100%;object-fit:cover;transition:all 0.3s}
    .tray-item:hover img{transform:scale(1.1)}
    .tray-item::after{content:'';position:absolute;inset:0;background:var(--accent-primary);opacity:0;transition:opacity 0.2s;mix-blend-mode:multiply}
    .tray-item:hover::after{opacity:0.3}
    
    .filter-monochrome{filter:grayscale(100%) contrast(1.1)!important}
    .filter-sepia{filter:sepia(100%) contrast(1.1) saturate(0.8)!important}
    .filter-lomo{filter:contrast(1.2) saturate(1.3) brightness(0.9)!important}
    .filter-vignette{filter:grayscale(100%) contrast(1.2) brightness(0.9)!important;position:relative}
    .filter-vignette::after{content:'';position:absolute;inset:0;box-shadow:inset 0 0 150px rgba(0,0,0,0.7);pointer-events:none}
    .filter-noir{filter:grayscale(100%) contrast(1.4) brightness(0.8)!important}
    .filter-fade{filter:sepia(30%) saturate(0.6) contrast(0.9) brightness(1.1)!important}
    .filter-cyber{filter:hue-rotate(180deg) saturate(1.5) contrast(1.1)!important}
    .filter-warm{filter:sepia(60%) hue-rotate(-30deg) saturate(1.2)!important}
    .filter-cold{filter:hue-rotate(180deg) saturate(0.5) brightness(1.1)!important}
    .filter-dream{filter:blur(0.5px) saturate(1.4) brightness(1.1) contrast(0.9)!important}
    .filter-crisp{filter:contrast(1.3) saturate(1.1)!important}
    .filter-moody{filter:brightness(0.8) contrast(1.2) saturate(0.7)!important}
    .filter-golden{filter:sepia(40%) hue-rotate(-15deg) saturate(1.3) contrast(1.1)!important}
    
    .entry-dummy{opacity:0.6;border-style:dashed!important}
    .entry-dummy:hover{border-color:var(--border)!important;opacity:0.75}
    .tray-item-dummy{opacity:0.5}
    .tray-item-dummy:hover{opacity:0.7}
    
    .empty-state{padding:var(--space-xl) var(--space-md);text-align:center;border:2px dashed var(--border)}
    .empty-emoji{font-size:48px;margin-bottom:var(--space-md);display:block;animation:f 3s ease-in-out infinite}
    @keyframes f{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    .empty-text{font-family:'Instrument Serif',serif;font-size:20px;font-style:italic;color:var(--text-secondary);margin-bottom:var(--space-sm)}
    .empty-subtext{font-size:13px;color:var(--text-muted)}
    
    footer{padding:var(--space-xl) 0;text-align:center;border-top:2px solid var(--border);margin-bottom:80px}
    .footer-text{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.2em}
    
    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--text);color:var(--bg);padding:var(--space-sm) var(--space-md);font-size:13px;font-weight:600;z-index:10000;opacity:0;transition:all 0.3s}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    
    .processing-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:10002;display:none;flex-direction:column;align-items:center;justify-content:center;gap:var(--space-md)}
    .processing-overlay.active{display:flex}
    .processing-spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--accent-primary);border-radius:50%;animation:s 1s linear infinite}
    @keyframes s{to{transform:rotate(360deg)}}
    .processing-text{font-size:14px;color:var(--text-secondary);text-align:center}
    
    .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:10001;padding:var(--space-md);overflow-y:auto}
    .modal.active{display:block}
    .modal-content{max-width:480px;margin:0 auto;background:var(--surface);border:2px solid var(--border);padding:var(--space-lg)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-md);padding-bottom:var(--space-md);border-bottom:2px solid var(--border)}
    .modal-title{font-size:18px;font-weight:800;text-transform:uppercase;letter-spacing:0.05em}
    .modal-close{background:none;border:none;color:var(--text);font-size:24px;cursor:pointer}
    .gallery-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--space-sm)}
    .gallery-item{aspect-ratio:1;background:var(--surface-elevated);border:2px solid var(--border);cursor:pointer;overflow:hidden;position:relative}
    .gallery-item img{width:100%;height:100%;object-fit:cover;transition:all 0.2s}
    .gallery-item:hover img{transform:scale(1.05)}
    .gallery-item.selected{border-color:var(--accent-primary);box-shadow:0 0 0 2px var(--accent-primary)}
    .gallery-item.selected::after{content:'‚úì';position:absolute;top:4px;right:4px;background:var(--accent-primary);color:var(--bg);width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700}
    .modal-actions{margin-top:var(--space-md);display:flex;justify-content:flex-end;gap:var(--space-sm)}
    .modal-btn{padding:12px 24px;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;border:2px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;transition:all 0.2s}
    .modal-btn.primary{background:var(--accent-primary);border-color:var(--accent-primary);color:var(--bg)}
    .modal-btn:hover{transform:translateY(-2px)}
    
    .gallery-warning{background:var(--accent-tertiary);color:var(--text);padding:var(--space-md);margin-bottom:var(--space-md);font-size:13px;font-weight:700;text-align:center;text-transform:uppercase;letter-spacing:0.05em;border:2px solid var(--accent-tertiary);animation:pw 2s infinite}
    @keyframes pw{0%,100%{opacity:1}50%{opacity:0.8}}
    .gallery-warning::before{content:'üö´ '}
    .detection-badge{position:absolute;top:4px;left:4px;background:var(--accent-tertiary);color:var(--text);font-size:9px;font-weight:700;padding:2px 6px;text-transform:uppercase;z-index:20}
  </style>
<base target="_blank">
</head>
<body>
  <div class="wrapper">
    <header>
      <div>
        <div class="logo" onclick="location.reload()">JEJAK</div>
        <div class="tagline">no filter, just truth</div>
      </div>
      <div class="top-right">
        <div style="font-size:12px;font-weight:700;color:var(--accent-primary);letter-spacing:0.05em" id="header-username">@loading...</div>
        <div class="sync-status offline" id="sync-status">Offline</div>
        <button onclick="logoutUser()" style="font-size:10px;background:none;border:1px solid var(--border);color:var(--text-muted);padding:3px 8px;cursor:pointer">logout</button>
      </div>
    </header>

    <div class="filter-controls">
      <div class="filter-info">
        <span class="filter-badge" id="current-filter">MONOCHROME</span>
        <span style="font-size:11px;color:var(--text-muted)" id="filter-desc">Default</span>
      </div>
      <button class="filter-toggle" id="filter-toggle" onclick="toggleColorMode()">
        <span class="filter-icon" id="filter-icon">‚ö´</span>
        <span class="filter-label" id="filter-label">B&W</span>
      </button>
    </div>

    <section class="hero-section">
      <div class="hero" id="hero-container">
        <img id="hero-img" src="" alt="artefak" class="filter-monochrome">
        <div id="hero-faces" style="position:absolute;inset:0;pointer-events:none"></div>
        <div class="hero-notation" id="hero-notation">"memori tersimpan"</div>
        <div class="upload-controls">
          <div class="quota-timer" id="quota-timer">Window aktif ‚Ä¢ Sisa 2 hari</div>
          <button class="upload-btn" id="upload-btn" title="Buka galeri">+<span class="upload-counter" id="upload-counter" style="display:none"></span></button>
        </div>
      </div>
    </section>

    <section class="input-section">
      <div class="input-header">
        <span class="input-label">Spill your truth</span>
        <span class="char-count" id="char-count">0/500</span>
      </div>
      <textarea class="rant-input" id="rant-input" placeholder="What's eating you alive right now? No cap, no filter..." maxlength="500"></textarea>
      
      <div class="mood-section">
        <div class="mood-label">Pilih mood-mu sekarang</div>
        <div class="mood-grid" id="mood-grid">
          <div class="mood-card active" data-mood="surviving" onclick="selectMood('surviving')">
            <span class="mood-emoji">üòÆ‚Äçüí®</span>
            <span class="mood-name" style="color:var(--mood-surviving)">Surviving</span>
            <span class="mood-desc">Hidup tapi barely</span>
          </div>
          <div class="mood-card" data-mood="thriving" onclick="selectMood('thriving')">
            <span class="mood-emoji">‚ú®</span>
            <span class="mood-name" style="color:var(--mood-thriving)">Thriving</span>
            <span class="mood-desc">On top of my game</span>
          </div>
          <div class="mood-card" data-mood="chaotic" onclick="selectMood('chaotic')">
            <span class="mood-emoji">üåÄ</span>
            <span class="mood-name" style="color:var(--mood-chaotic)">Chaotic</span>
            <span class="mood-desc">Everything is on fire</span>
          </div>
          <div class="mood-card" data-mood="doom" onclick="selectMood('doom')">
            <span class="mood-emoji">üõå</span>
            <span class="mood-name" style="color:var(--mood-doom)">Doom</span>
            <span class="mood-desc">Just wanna disappear</span>
          </div>
        </div>
      </div>
      
      <div class="input-actions">
        <button class="submit-btn" id="submit-btn">Jejakkan & Spill</button>
      </div>
    </section>

    <section class="entries-section">
      <div class="section-header">
        <span class="section-title">Riwayat</span>
        <div class="section-line"></div>
        <span style="font-size:10px;color:var(--text-muted);margin-left:auto">FIFO ‚Ä¢ MAX 6 ‚Ä¢ AUTO-CENSOR</span>
      </div>
      <div id="entries-container"></div>
    </section>

    <section class="tray-section">
      <div class="section-header">
        <span class="section-title">Memori</span>
        <div class="section-line"></div>
        <span style="font-size:10px;color:var(--text-muted);margin-left:auto">FIFO ‚Ä¢ MAX 6 ‚Ä¢ AUTO-CENSOR</span>
      </div>
      <div class="tray-grid" id="tray-grid"></div>
    </section>

    <footer>
      <p class="footer-text">Nyambat ‚Ä¢ Aksi ‚Ä¢ Solusi</p>
    </footer>
  </div>

  <nav class="bottom-nav">
    <div class="nav-container">
      <a href="jejak.html" class="nav-item active"><span class="nav-icon">‚ú¶</span><span>Jejak</span></a>
      <a href="cocomeo.html" class="nav-item"><span class="nav-icon">„Äú</span><span>Cocomeo</span></a>
      <a href="saynope.html" class="nav-item"><span class="nav-icon">‚úï</span><span>Spill</span></a>
      <a href="glitch.html" class="nav-item"><span class="nav-icon">‚ö°</span><span>Glitch</span></a>
    </div>
  </nav>

  <div class="processing-overlay" id="processing">
    <div class="processing-spinner"></div>
    <div class="processing-text">Scanning untuk wajah...<br><small>AI Privacy Shield Active</small></div>
  </div>

  <div class="modal" id="gallery-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Review Artefak</h3>
        <button class="modal-close" onclick="closeGallery()">√ó</button>
      </div>
      <div class="gallery-warning">DILARANG UPLOAD FOTO WAJAH!</div>
      <div style="font-size:11px;color:var(--text-secondary);margin-bottom:var(--space-md);text-align:center">Wajah terdeteksi akan otomatis disensor ‚Ä¢ Sistem FIFO (6 foto max) ‚Ä¢ Tidak dapat dihapus</div>
      <div class="gallery-grid" id="gallery-grid"></div>
      <div class="modal-actions">
        <button class="modal-btn" onclick="closeGallery()">Batal</button>
        <button class="modal-btn primary" onclick="confirmUpload()">Konfirmasi (<span id="selected-count">0</span>)</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <input type="file" id="file-input" accept="image/*" multiple style="display:none">

  <script>
    const CONFIG = {
      supabaseUrl: 'https://fuovfrdicdhnlymnacpz.supabase.co',
      supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0',
      quotaDays: 28,
      uploadWindowDays: 3,
      maxFileSize: 5 * 1024 * 1024,
      maxSelection: 6,
      maxArtefacts: 6,
      maxEntries: 6,
      faceThreshold: 0.6,
      inputSize: 416,
      storageBucket: 'artefacts'
    };

    // PATCH 2: VIBES dengan empathy text
    const VIBES = {
      relatable: { emoji: 'üíØ', label: 'literally me', empathy: 'orang merasa sama sepertimu' },
      mood: { emoji: 'üõãÔ∏è', label: 'big mood', empathy: 'orang merasakan vibes yang sama' },
      tea: { emoji: 'üê∏', label: 'spill tea', empathy: 'orang penasaran cerita lengkapnya' },
      hug: { emoji: 'ü§ó', label: 'virtual hug', empathy: 'orang memberimu pelukan hangat' },
      real: { emoji: 'üéØ', label: 'no cap', empathy: 'orang setuju ini real banget' },
      dead: { emoji: 'üíÄ', label: 'rip me', empathy: 'orang relate sampai mati' }
    };
    
    // Helper: Pilih 1 vibe terbanyak untuk display (rotasi per entry)
    function getTopVibe(vibes, entryId) {
      if (!vibes) return null;
      const entries = Object.entries(vibes).filter(([k,v]) => v > 0);
      if (entries.length === 0) return null;
      
      // Sort by count descending
      entries.sort((a,b) => b[1] - a[1]);
      
      // Jika ada tie (count sama), gunakan hash dari entryId untuk konsisten tapi bervariasi
      const topCount = entries[0][1];
      const topOnes = entries.filter(([k,v]) => v === topCount);
      
      if (topOnes.length > 1) {
        // Simple hash function untuk deterministic tapi bervariasi
        const hash = entryId.split('').reduce((a,c) => ((a << 5) - a) + c.charCodeAt(0), 0);
        return topOnes[Math.abs(hash) % topOnes.length];
      }
      
      return entries[0]; // [key, count]
    }

    const MOODS = {
      surviving: { emoji: 'üòÆ‚Äçüí®', color: '#FF9500', label: 'surviving' },
      thriving: { emoji: '‚ú®', color: '#39FF14', label: 'thriving' },
      chaotic: { emoji: 'üåÄ', color: '#00F0FF', label: 'chaotic' },
      doom: { emoji: 'üõå', color: '#8B5CF6', label: 'doom' }
    };

    const MONTHLY_THEMES = [
      { name: 'NOIR', filter: 'filter-noir', desc: 'High contrast B&W', icon: '‚ö´' },
      { name: 'SEPIA', filter: 'filter-sepia', desc: 'Vintage warmth', icon: 'üü§' },
      { name: 'LOMO', filter: 'filter-lomo', desc: 'Analog saturation', icon: 'üì∑' },
      { name: 'VIGNETTE', filter: 'filter-vignette', desc: 'Dark edges', icon: '‚ö´' },
      { name: 'CYBER', filter: 'filter-cyber', desc: 'Neon shift', icon: 'üí†' },
      { name: 'FADE', filter: 'filter-fade', desc: 'Soft vintage', icon: 'üå´Ô∏è' },
      { name: 'WARM', filter: 'filter-warm', desc: 'Golden hour', icon: '‚òÄÔ∏è' },
      { name: 'COLD', filter: 'filter-cold', desc: 'Icy blue', icon: '‚ùÑÔ∏è' },
      { name: 'DREAM', filter: 'filter-dream', desc: 'Soft focus', icon: 'üí≠' },
      { name: 'CRISP', filter: 'filter-crisp', desc: 'Sharp detail', icon: 'üî™' },
      { name: 'MOODY', filter: 'filter-moody', desc: 'Dark tones', icon: 'üåë' },
      { name: 'GOLDEN', filter: 'filter-golden', desc: 'Autumn glow', icon: 'üçÇ' }
    ];

    const DUMMY_ENTRIES = [
      { id: '__d1', content: "gue udah bantuin dia tiap malem pas dia galau sampe gue lupa ngerjain tugas sendiri. pas gue butuh temen buat ngobrol, dia malah offline terus.", mood: 'surviving', timestamp: Date.now() - 172800000, vibes: { relatable: 12, mood: 9, hug: 8, tea: 3, real: 5, dead: 2 }, isSpilled: true, isDummy: true },
      { id: '__d2', content: "deadline mepet, dosen gak jelas, dompet kering. rasanya pengen ijin cuti sehari buat jadi batu aja.", mood: 'doom', timestamp: Date.now() - 86400000, vibes: { relatable: 9, mood: 5, dead: 7, real: 3, hug: 2, tea: 1 }, isSpilled: true, isDummy: true },
      { id: '__d3', content: "capek.", mood: 'surviving', timestamp: Date.now() - 43200000, vibes: { hug: 20, relatable: 18, dead: 10, real: 7, mood: 3, tea: 0 }, isSpilled: true, isDummy: true }
    ];

    const DUMMY_ARTEFACTS = [
      { id: '__a1', url: 'https://images.unsplash.com/photo-1517842645767-c639042777db?w=400&q=80', note: 'jeda', faces: [], hasFace: false, isDummy: true },
      { id: '__a2', url: 'https://images.unsplash.com/photo-1499209974431-9dddcece7f88?w=400&q=80', note: 'hijau', faces: [], hasFace: false, isDummy: true },
      { id: '__a3', url: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=400&q=80', note: 'gabut', faces: [], hasFace: false, isDummy: true },
      { id: '__a4', url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&q=80', note: 'sendiri', faces: [], hasFace: false, isDummy: true },
      { id: '__a5', url: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&q=80', note: 'capek', faces: [{ box: { x: 75, y: 45, width: 150, height: 200 }, score: 0.92 }], hasFace: true, isDummy: true },
      { id: '__a6', url: 'https://images.unsplash.com/photo-1516035069371-29a1b244cc32?w=400&q=80', note: 'love', faces: [], hasFace: false, isDummy: true }
    ];

    const SESSION = (() => {
      const keys = { username: 'jejak_username', userId: 'jejak_user_id', loggedIn: 'jejak_logged_in' };
      const username = localStorage.getItem(keys.username);
      const userId = localStorage.getItem(keys.userId);
      const loggedIn = localStorage.getItem(keys.loggedIn);
      if (!loggedIn || !username) {
        console.warn('No session, using anon');
        return { username: '@anon', userId: null };
      }
      return { username, userId };
    })();

    const STORAGE_PREFIX = 'jejak_' + (SESSION.userId || SESSION.username).replace(/[^a-z0-9]/g, '_') + '_';

    const state = {
      currentUser: SESSION.username,
      currentUserId: SESSION.userId,
      currentMood: 'surviving',
      entries: [],
      artefacts: [],
      userVibes: new Set(),
      selectedFiles: new Set(),
      colorMode: false,
      faceApiLoaded: false,
      supabase: null,
      isOnline: false,
      quotaStart: localStorage.getItem(STORAGE_PREFIX + 'quota_start') || null,
      uploadsThisWindow: parseInt(localStorage.getItem(STORAGE_PREFIX + 'uploads_count') || '0')
    };

    // FIFO SYSTEM
    function getVisibleEntries() {
      const realCount = state.entries.length;
      if (realCount === 0) return DUMMY_ENTRIES;
      if (realCount < 3) {
        const needed = 3 - realCount;
        return [...state.entries, ...DUMMY_ENTRIES.slice(0, needed)];
      }
      return state.entries.slice(0, CONFIG.maxEntries);
    }

    function addEntryFIFO(newEntry) {
      state.entries.unshift(newEntry);
      if (state.entries.length > CONFIG.maxEntries) {
        const removed = state.entries.pop();
        console.log('üîÑ Entry FIFO removed:', removed.id);
        showToast('Entry lama terhapus otomatis (FIFO)');
      }
      saveEntries();
      renderEntries();
    }

    function getVisibleArtefacts() {
      const real = state.artefacts.filter(a => !a.isDummy);
      if (real.length >= 6) return real.slice(0, 6);
      const needed = 6 - real.length;
      return [...real, ...DUMMY_ARTEFACTS.slice(0, needed)];
    }

    function addArtefactFIFO(newArtefact) {
      const realArtefacts = state.artefacts.filter(a => !a.isDummy);
      realArtefacts.unshift(newArtefact);
      if (realArtefacts.length > CONFIG.maxArtefacts) {
        const removed = realArtefacts.pop();
        console.log('üîÑ Artefact FIFO removed:', removed.id);
        showToast('Foto lama terhapus otomatis (FIFO)');
      }
      state.artefacts = realArtefacts;
      saveArtefacts();
      renderTray();
    }

    function initSupabase() {
      try {
        if (typeof supabase === 'undefined') {
          updateSyncStatus('offline', 'Offline mode');
          return false;
        }
        state.supabase = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
        state.isOnline = true;
        updateSyncStatus('online', 'Terhubung');
        subscribeToChanges();
        return true;
      } catch (e) {
        updateSyncStatus('offline', 'Offline mode');
        return false;
      }
    }

    function updateSyncStatus(status, text) {
      const el = document.getElementById('sync-status');
      el.className = 'sync-status ' + status;
      el.textContent = text;
    }

    function subscribeToChanges() {
      if (!state.supabase) return;
      state.supabase.channel('spills').on('postgres_changes', { event: '*', schema: 'public', table: 'spills' }, () => {
        loadUserRantsFromDB();
      }).subscribe();
    }

    async function loadUserRantsFromDB() {
      if (!state.isOnline || !state.supabase) return;
      try {
        const { data, error } = await state.supabase
          .from('rants')
          .select('*')
          .eq('author', state.currentUser)
          .order('created_at', { ascending: false })
          .limit(CONFIG.maxEntries);
        
        if (error) throw error;
        
        if (data?.length > 0) {
          const localIds = new Set(state.entries.map(e => e.id));
          const newEntries = data
            .filter(r => !localIds.has(r.id))
            .map(r => ({
              id: r.id,
              content: r.content,
              mood: r.mood,
              timestamp: new Date(r.created_at).getTime(),
              vibes: r.vibes || {relatable:0,mood:0,tea:0,hug:0,real:0,dead:0},
              isSpilled: true,
              author: r.author
            }));
          
          state.entries = [...state.entries, ...newEntries].sort((a,b) => b.timestamp - a.timestamp).slice(0, CONFIG.maxEntries);
          saveEntries();
          renderEntries();
        }
      } catch (e) {
        console.error('Load rants failed:', e);
      }
    }

    async function loadUserArtefactsFromDB() {
      if (!state.isOnline || !state.supabase) return;
      try {
        const { data, error } = await state.supabase
          .from('artefacts')
          .select('*')
          .eq('author', state.currentUser)
          .order('created_at', { ascending: false })
          .limit(CONFIG.maxArtefacts);
        
        if (error) throw error;
        
        if (data?.length > 0) {
          state.artefacts = data.map(a => ({
            id: a.id,
            url: a.url,
            note: a.note || 'memory',
            faces: a.faces || [],
            hasFace: a.has_face || false,
            timestamp: new Date(a.created_at).getTime()
          }));
          saveArtefacts();
          renderTray();
          const first = state.artefacts[0];
          if (first) setHero(first.url, first.note, first.faces);
        }
      } catch (e) {
        console.error('Load artefacts failed:', e);
      }
    }

    async function submitRant(content, mood) {
      const rantId = crypto.randomUUID();
      const timestamp = Date.now();
      
      const newRant = {
        id: rantId,
        content,
        mood,
        timestamp,
        vibes: { relatable: 0, mood: 0, tea: 0, hug: 0, real: 0, dead: 0 },
        isSpilled: false,
        author: state.currentUser,
        created_at: new Date(timestamp).toISOString()
      };
      
      addEntryFIFO(newRant);
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      if (state.isOnline && state.supabase) {
        try {
          updateSyncStatus('syncing', 'Menyimpan...');
          await state.supabase.from('rants').insert([{
            id: rantId, content, mood, author: state.currentUser,
            created_at: newRant.created_at, vibes: newRant.vibes
          }]);
          
          const spillId = crypto.randomUUID();
          await state.supabase.from('spills').insert([{
            id: spillId, rant_id: rantId, content, mood,
            author: state.currentUser, created_at: newRant.created_at,
            is_anonymous: true, response_count: 0, vibes: newRant.vibes
          }]);
          
          newRant.isSpilled = true;
          newRant.spillId = spillId;
          saveEntries();
          renderEntries();
          
          updateSyncStatus('online', 'Tersimpan');
          showToast('Jejak tersimpan & di-spill!');
        } catch (error) {
          updateSyncStatus('offline', 'Sync pending');
          showToast('Tersimpan lokal (sync pending)');
          queueForRetry(newRant);
        }
      } else {
        showToast('Tersimpan lokal (offline mode)');
        queueForRetry(newRant);
      }
    }

    async function uploadImageToSupabase(file, artefactId) {
      if (!state.supabase) return null;
      try {
        const fileExt = file.name.split('.').pop();
        const fileName = `${state.currentUser}/${artefactId}.${fileExt}`;
        const { error } = await state.supabase.storage.from(CONFIG.storageBucket).upload(fileName, file, { cacheControl: '3600', upsert: false });
        if (error) throw error;
        const { data: publicUrl } = state.supabase.storage.from(CONFIG.storageBucket).getPublicUrl(fileName);
        return publicUrl.publicUrl;
      } catch (error) {
        console.error('Upload failed:', error);
        return null;
      }
    }

    async function saveArtefactMetadata(artefact, publicUrl) {
      if (!state.supabase) return;
      try {
        await state.supabase.from('artefacts').insert([{
          id: artefact.id, author: state.currentUser, url: publicUrl,
          note: artefact.note, has_face: artefact.hasFace,
          faces: artefact.faces, created_at: new Date(artefact.timestamp).toISOString()
        }]);
      } catch (error) {
        console.error('Metadata save failed:', error);
      }
    }

    async function loadFaceApi() {
      try {
        if (typeof faceapi === 'undefined') {
          state.faceApiLoaded = false;
          return;
        }
        await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.13/model');
        await faceapi.nets.faceLandmark68TinyNet.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.13/model');
        state.faceApiLoaded = true;
      } catch (e) {
        state.faceApiLoaded = false;
      }
    }

    async function detectFaces(img) {
      if (!state.faceApiLoaded) return simulateDetection(img);
      try {
        const options = new faceapi.TinyFaceDetectorOptions({ inputSize: CONFIG.inputSize, scoreThreshold: CONFIG.faceThreshold });
        const detections = await faceapi.detectAllFaces(img, options);
        return detections.filter(d => {
          const area = d.box.width * d.box.height;
          const imgArea = img.naturalWidth * img.naturalHeight;
          const ratio = area / imgArea;
          return ratio > 0.01 && ratio < 0.8 && d.score > CONFIG.faceThreshold;
        });
      } catch (e) {
        return simulateDetection(img);
      }
    }

    function simulateDetection(img) {
      return new Promise(resolve => {
        setTimeout(() => {
          if (img.src?.includes('1507003211169')) {
            const w = img.naturalWidth || 400, h = img.naturalHeight || 400;
            resolve([{ box: { x: w*0.25, y: h*0.15, width: w*0.5, height: h*0.65 }, score: 0.85 }]);
          } else {
            resolve([]);
          }
        }, 500);
      });
    }

    // PATCH 3: renderVibeSection ‚Äî empathy text + lock own rant
    function renderVibeSection(entry, isDummy) {
      const isOwnRant = entry.author === state.currentUser && !isDummy;
      const topVibe = getTopVibe(entry.vibes, entry.id);
      
      // Jika ada reactions, tampilkan empathy text dengan handwriting font
      let empathyHTML = '';
      if (topVibe && topVibe[1] > 0) {
        const [vibeKey, count] = topVibe;
        const vibe = VIBES[vibeKey];
        empathyHTML = `
          <div class="empathy-text">
            ${vibe.emoji} <span class="empathy-highlight">${count}</span> ${vibe.empathy}
          </div>`;
      }
      
      // Vibe buttons - tampilkan semua tapi lock jika own rant
      const vibeButtons = Object.entries(VIBES).map(([key, vibe]) => {
        const count = entry.vibes?.[key] || 0;
        const isVibed = state.userVibes.has(`${entry.id}-${key}`);
        const disabled = isOwnRant || isDummy;
        return `
          <button class="vibe-btn ${isVibed ? 'vibed' : ''}" 
            onclick="${disabled ? '' : `toggleVibe('${entry.id}', '${key}', this)`}"
            ${disabled ? 'disabled' : ''}>
            <span class="vibe-emoji">${vibe.emoji}</span>
            <span class="vibe-count">${count}</span>
            <span class="vibe-label">${vibe.label}</span>
          </button>
        `;
      }).join('');
      
      return `
        ${empathyHTML}
        <div class="vibe-bar ${isOwnRant ? 'locked' : ''}">
          ${vibeButtons}
        </div>`;
    }
    
    function renderEntries() {
      const container = document.getElementById('entries-container');
      const entries = getVisibleEntries();
      
      if (entries.length === 0) {
        container.innerHTML = `<div class="empty-state"><span class="empty-emoji">üçÉ</span><p class="empty-text">"Jejak pertamamu menanti"</p><p class="empty-subtext">Tulis sesuatu. Hanya kamu yang bisa lihat.</p></div>`;
        return;
      }
      
      container.innerHTML = entries.map(entry => {
        const isDummy = entry.isDummy;
        const spillStatus = entry.isSpilled ? `<div class="spill-status spilled">‚úì Ter-spill ke komunitas</div>` : '';
        
        return `
        <article class="entry ${isDummy ? 'entry-dummy' : ''}" data-id="${entry.id}">
          <div class="entry-header">
            <div class="entry-meta">
              <span class="entry-time">${isDummy ? 'contoh' : formatTime(entry.timestamp)}</span>
              <span class="entry-mood ${entry.mood}">${MOODS[entry.mood].label}</span>
              ${isDummy ? '<span class="fifo-indicator">CONTOH</span>' : ''}
            </div>
          </div>
          <div class="entry-content">
            <p>${entry.content}</p>
            ${spillStatus}
          </div>
          ${renderVibeSection(entry, isDummy)}
        </article>`;
      }).join('');
    }

    function renderTray() {
      const grid = document.getElementById('tray-grid');
      const items = getVisibleArtefacts();
      
      grid.innerHTML = items.map(item => `
        <div class="tray-item ${item.isDummy ? 'tray-item-dummy' : ''}" 
             onclick="setHero('${item.url}', '${item.note}', ${JSON.stringify(item.faces || []).replace(/"/g, '&quot;')})">
          <div style="position:relative;width:100%;height:100%">
            <img src="${item.url}" alt="${item.note}" loading="lazy" class="${state.colorMode ? getCurrentTheme().filter : 'filter-monochrome'}">
            ${item.hasFace ? '<div class="detection-badge">SENSORED</div>' : ''}
            ${item.isDummy ? '<div style="position:absolute;bottom:4px;right:4px;font-size:8px;font-weight:700;color:var(--text-muted);background:rgba(0,0,0,0.7);padding:2px 5px">CONTOH</div>' : ''}
            ${renderScribbles(item.faces)}
          </div>
        </div>
      `).join('');
      
      const emptySlots = Math.max(0, 6 - items.length);
      for (let i = 0; i < emptySlots; i++) {
        grid.innerHTML += `<div class="tray-item empty" onclick="openGallery()">+</div>`;
      }
    }

    function renderScribbles(faces) {
      if (!faces?.length) return '';
      return faces.map(f => `
        <div class="face-scribble" style="left:${(f.box.x/400)*100}%;top:${(f.box.y/400)*100}%;width:${(f.box.width/400)*100}%;height:${(f.box.height/400)*100}%">
          <div class="marker-lines"></div>
        </div>
      `).join('');
    }

    function applyFilter(el, useColor) {
      const theme = getCurrentTheme();
      const filters = ['filter-monochrome','filter-sepia','filter-lomo','filter-vignette','filter-noir','filter-fade','filter-cyber','filter-warm','filter-cold','filter-dream','filter-crisp','filter-moody','filter-golden'];
      filters.forEach(f => el.classList.remove(f));
      el.classList.add(useColor ? theme.filter : 'filter-monochrome');
    }

    function updateFilterUI() {
      const theme = getCurrentTheme();
      const els = {
        badge: document.getElementById('current-filter'),
        desc: document.getElementById('filter-desc'),
        icon: document.getElementById('filter-icon'),
        label: document.getElementById('filter-label'),
        toggle: document.getElementById('filter-toggle')
      };
      
      if (state.colorMode) {
        els.badge.textContent = theme.name;
        els.desc.textContent = theme.desc;
        els.icon.textContent = theme.icon;
        els.label.textContent = 'COLOR';
        els.toggle.classList.add('active');
      } else {
        els.badge.textContent = 'MONOCHROME';
        els.desc.textContent = 'Default';
        els.icon.textContent = '‚ö´';
        els.label.textContent = 'B&W';
        els.toggle.classList.remove('active');
      }
      
      applyFilter(document.getElementById('hero-img'), state.colorMode);
      document.querySelectorAll('.tray-item img').forEach(img => applyFilter(img, state.colorMode));
    }

    window.toggleColorMode = () => {
      state.colorMode = !state.colorMode;
      updateFilterUI();
      showToast(state.colorMode ? `Theme: ${getCurrentTheme().name}` : 'Monochrome mode');
    };

    window.selectMood = (mood) => {
      state.currentMood = mood;
      document.querySelectorAll('.mood-card').forEach(c => c.classList.toggle('active', c.dataset.mood === mood));
      navigator.vibrate?.(10);
    };

    window.toggleVibe = async (entryId, vibeKey, btn) => {
      const key = `${entryId}-${vibeKey}`;
      const countEl = btn.querySelector('.vibe-count');
      let count = parseInt(countEl.textContent);
      const entry = state.entries.find(e => e.id === entryId);
      
      if (state.userVibes.has(key)) {
        state.userVibes.delete(key);
        btn.classList.remove('vibed');
        countEl.textContent = Math.max(0, count - 1);
      } else {
        state.userVibes.add(key);
        btn.classList.add('vibed');
        countEl.textContent = count + 1;
        btn.style.transform = 'scale(0.9)';
        setTimeout(() => btn.style.transform = '', 150);
        showToast(`${VIBES[vibeKey].label}!`);
        
        if (state.isOnline && state.supabase && entry) {
          try {
            const newVibes = { ...entry.vibes, [vibeKey]: (entry.vibes[vibeKey] || 0) + 1 };
            await state.supabase.from('rants').update({ vibes: newVibes }).eq('id', entryId);
            if (entry.isSpilled && entry.spillId) {
              await state.supabase.from('spills').update({ vibes: newVibes, response_count: Object.values(newVibes).reduce((a,b)=>a+b,0) }).eq('id', entry.spillId);
            }
            entry.vibes = newVibes;
            renderEntries();
          } catch (e) {
            console.error('Vibe update failed:', e);
          }
        }
      }
    };

    window.setHero = (url, note, faces) => {
      faces = faces || [];
      const heroImg = document.getElementById('hero-img');
      const heroFaces = document.getElementById('hero-faces');
      
      heroImg.src = url;
      applyFilter(heroImg, state.colorMode);
      document.getElementById('hero-notation').textContent = `"${note}"`;
      
      heroFaces.innerHTML = '';
      heroImg.onload = () => {
        if (!faces.length) return;
        const rect = heroImg.parentElement.getBoundingClientRect();
        const scaleX = rect.width / heroImg.naturalWidth;
        const scaleY = rect.height / heroImg.naturalHeight;
        const padding = 10;
        
        faces.forEach(face => {
          const div = document.createElement('div');
          div.className = 'face-scribble';
          div.style.left = Math.max(0, (face.box.x * scaleX) - padding) + 'px';
          div.style.top = Math.max(0, (face.box.y * scaleY) - padding) + 'px';
          div.style.width = Math.min(rect.width, (face.box.width * scaleX) + (padding * 2)) + 'px';
          div.style.height = Math.min(rect.height, (face.box.height * scaleY) + (padding * 2)) + 'px';
          div.innerHTML = '<div class="marker-lines"></div>';
          heroFaces.appendChild(div);
        });
      };
    };

    window.openGallery = () => {
      const quota = checkQuota();
      if (!quota.inWindow) {
        showToast(`Tunggu ${quota.daysUntil} hari lagi`);
        return;
      }
      document.getElementById('file-input').click();
    };

    function checkQuota() {
      const now = Date.now();
      if (!state.quotaStart) {
        state.quotaStart = now.toString();
        localStorage.setItem(STORAGE_PREFIX + 'quota_start', state.quotaStart);
      }
      const quotaStart = parseInt(state.quotaStart);
      const daysSince = Math.floor((now - quotaStart) / (1000 * 60 * 60 * 24));
      const currentCycle = Math.floor(daysSince / CONFIG.quotaDays);
      const cycleStart = quotaStart + (currentCycle * CONFIG.quotaDays * 24 * 60 * 60 * 1000);
      const daysInto = Math.floor((now - cycleStart) / (1000 * 60 * 60 * 24));
      
      return {
        inWindow: daysInto < CONFIG.uploadWindowDays,
        daysInto,
        daysUntil: CONFIG.quotaDays - daysInto,
        daysLeft: CONFIG.uploadWindowDays - daysInto
      };
    }

    function updateQuotaUI() {
      const quota = checkQuota();
      const btn = document.getElementById('upload-btn');
      const counter = document.getElementById('upload-counter');
      const timer = document.getElementById('quota-timer');
      
      if (quota.inWindow) {
        btn.disabled = false;
        counter.style.display = 'none';
        timer.textContent = `Window aktif ‚Ä¢ Sisa ${quota.daysLeft} hari`;
        timer.classList.toggle('urgent', quota.daysLeft <= 1);
      } else {
        btn.disabled = true;
        counter.textContent = quota.daysUntil;
        counter.style.display = 'block';
        timer.textContent = `Next window: ${quota.daysUntil} hari`;
        timer.classList.remove('urgent');
      }
    }

    document.getElementById('file-input').addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      if (!files.length) return;
      
      document.getElementById('processing').classList.add('active');
      const processed = [];
      
      for (const file of files) {
        if (file.size > CONFIG.maxFileSize) {
          showToast(`${file.name} terlalu besar (max 5MB)`);
          continue;
        }
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.src = url;
        await new Promise(resolve => {
          img.onload = async () => {
            const detections = await detectFaces(img);
            processed.push({
              id: crypto.randomUUID(),
              url, note: 'new drop', timestamp: Date.now(),
              faces: detections.map(d => ({ box: d.box, score: d.score })),
              hasFace: detections.length > 0,
              file
            });
            resolve();
          };
        });
      }
      
      document.getElementById('processing').classList.remove('active');
      if (processed.length) {
        state.selectedFiles = new Set(processed);
        renderGallery(processed);
      }
    });

    function renderGallery(artefacts) {
      const grid = document.getElementById('gallery-grid');
      grid.innerHTML = artefacts.map((art, idx) => `
        <div class="gallery-item selected" data-idx="${idx}" onclick="toggleGallerySelection(this, ${idx})">
          <div style="position:relative;width:100%;height:100%">
            <img src="${art.url}" class="${state.colorMode ? getCurrentTheme().filter : 'filter-monochrome'}">
            ${art.hasFace ? '<div class="detection-badge">WAJAH TERSENSOR</div>' : ''}
            ${art.faces?.length ? renderScribbles(art.faces) : ''}
          </div>
        </div>
      `).join('');
      document.getElementById('selected-count').textContent = state.selectedFiles.size;
      document.getElementById('gallery-modal').classList.add('active');
    }

    window.toggleGallerySelection = (el, idx) => {
      const artefacts = Array.from(state.selectedFiles);
      const artefact = artefacts[idx];
      
      if (el.classList.contains('selected')) {
        el.classList.remove('selected');
        state.selectedFiles.delete(artefact);
      } else {
        if (state.selectedFiles.size >= CONFIG.maxSelection) {
          showToast(`Max ${CONFIG.maxSelection} foto`);
          return;
        }
        el.classList.add('selected');
        state.selectedFiles.add(artefact);
      }
      document.getElementById('selected-count').textContent = state.selectedFiles.size;
    };

    window.closeGallery = () => {
      document.getElementById('gallery-modal').classList.remove('active');
      state.selectedFiles.clear();
      document.getElementById('file-input').value = '';
    };

    window.confirmUpload = async () => {
      if (!state.selectedFiles.size) {
        showToast('Pilih minimal 1 foto');
        return;
      }
      
      const artefacts = Array.from(state.selectedFiles);
      let faceCount = 0;
      
      for (const art of artefacts) {
        if (art.hasFace) faceCount++;
        
        if (state.isOnline && state.supabase) {
          try {
            updateSyncStatus('syncing', 'Uploading...');
            const publicUrl = await uploadImageToSupabase(art.file, art.id);
            if (publicUrl) {
              art.url = publicUrl;
              await saveArtefactMetadata(art, publicUrl);
            }
          } catch (e) {
            console.error('Upload error:', e);
          }
        }
        addArtefactFIFO(art);
      }
      
      state.uploadsThisWindow += artefacts.length;
      localStorage.setItem(STORAGE_PREFIX + 'uploads_count', state.uploadsThisWindow.toString());
      
      const first = artefacts[0];
      setHero(first.url, first.note, first.faces);
      closeGallery();
      
      if (state.isOnline) updateSyncStatus('online', 'Tersimpan');
      showToast(`${artefacts.length} artefak ditambahkan${faceCount ? ` ‚Ä¢ ${faceCount} wajah disensor` : ''} (FIFO)`);
    };

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    function formatTime(ts) {
      const diff = Date.now() - ts;
      const hours = Math.floor(diff / 3600000);
      if (hours < 1) return 'baru saja';
      if (hours < 24) return `${hours}j`;
      return `${Math.floor(hours/24)}h`;
    }

    function getCurrentTheme() {
      return MONTHLY_THEMES[new Date().getMonth()];
    }

    function saveEntries() {
      localStorage.setItem(STORAGE_PREFIX + 'entries', JSON.stringify(state.entries));
    }

    function saveArtefacts() {
      const meta = state.artefacts.map(a => ({
        id: a.id, url: a.url, note: a.note,
        faces: a.faces || [], hasFace: a.hasFace || false,
        timestamp: a.timestamp || Date.now()
      }));
      localStorage.setItem(STORAGE_PREFIX + 'artefacts_meta', JSON.stringify(meta));
    }

    function loadArtefacts() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_PREFIX + 'artefacts_meta')) || [];
      } catch {
        return [];
      }
    }

    function queueForRetry(entry) {
      const queue = JSON.parse(localStorage.getItem('jejak_sync_queue') || '[]');
      queue.push(entry);
      localStorage.setItem('jejak_sync_queue', JSON.stringify(queue));
    }

    window.logoutUser = () => {
      if (!confirm('Yakin mau logout?')) return;
      ['jejak_logged_in','jejak_username','jejak_user_id'].forEach(k => localStorage.removeItem(k));
      location.href = 'index.html';
    };

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('header-username').textContent = '@' + state.currentUser;
      
      initSupabase();
      loadFaceApi();
      
      const savedEntries = localStorage.getItem(STORAGE_PREFIX + 'entries');
      if (savedEntries) state.entries = JSON.parse(savedEntries);
      
      const savedArtefacts = loadArtefacts();
      if (savedArtefacts.length) state.artefacts = savedArtefacts;
      
      document.getElementById('rant-input').addEventListener('input', function() {
        document.getElementById('char-count').textContent = `${this.value.length}/500`;
      });
      
      document.getElementById('submit-btn').addEventListener('click', () => {
        const input = document.getElementById('rant-input');
        const content = input.value.trim();
        if (!content) {
          showToast('Tulis dulu, bestie');
          input.focus();
          return;
        }
        submitRant(content, state.currentMood);
        input.value = '';
        document.getElementById('char-count').textContent = '0/500';
      });
      
      document.getElementById('upload-btn').addEventListener('click', openGallery);
      
      updateQuotaUI();
      updateFilterUI();
      renderEntries();
      renderTray();
      
      const visibleArts = getVisibleArtefacts();
      if (visibleArts.length) setHero(visibleArts[0].url, visibleArts[0].note, visibleArts[0].faces);
      
      loadUserArtefactsFromDB();
      loadUserRantsFromDB();
      
      setInterval(updateQuotaUI, 3600000);
    });
  </script>
</body>
</html>
