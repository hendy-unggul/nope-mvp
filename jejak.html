<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>JEJAK ‚Äî Spill Your Truth</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Caveat:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0A0A0A;--sf:#141414;--sfe:#1E1E1E;--bd:#2A2A2A;--tx:#FFF;--txs:#888;--txm:#555;--ap:#FF4D00;--as:#00F0FF;--at:#FF006E;--aq:#39FF14;--aw:#FFD700;--ms:#FF9500;--mt:#39FF14;--mc:#00F0FF;--md:#8B5CF6;--rd:#FF3333;--void:#050505}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--tx);font-family:'Plus Jakarta Sans',system-ui,sans-serif;font-weight:500;font-size:15px;line-height:1.4;min-height:100vh;overflow-x:hidden;padding-bottom:100px}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:.4}
.w{max-width:480px;margin:0 auto;padding:0 16px}
header{padding:24px 0 16px;display:flex;justify-content:space-between;align-items:flex-start}
.logo{font-size:42px;font-weight:800;letter-spacing:-.04em;cursor:pointer;line-height:.9;position:relative}
.logo::before,.logo::after{content:'JEJAK';position:absolute;top:0;left:0;opacity:0;transition:opacity .1s}
.logo::before{color:var(--as);transform:translate(-2px,0)}
.logo::after{color:var(--at);transform:translate(2px,0)}
.logo:hover::before{opacity:.8;animation:g .3s infinite}
@keyframes g{0%,100%{transform:translate(-2px,0)}25%{transform:translate(2px,2px)}50%{transform:translate(-2px,-2px)}75%{transform:translate(2px,0)}}
.tagline{font-family:'Instrument Serif',serif;font-size:13px;color:var(--txs);font-style:italic;margin-top:4px}
.top-right{display:flex;align-items:center;gap:8px}
.huser{font-size:11px;font-weight:700;color:var(--tx);text-transform:lowercase;letter-spacing:.05em;padding:4px 8px;background:var(--sf);border:1px solid var(--bd);max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dot{width:8px;height:8px;background:var(--aq);border-radius:50%;animation:blink 2s infinite;flex-shrink:0}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.dot.off{background:var(--at);animation:none}
.smenu{position:relative}
.mtrig{width:32px;height:32px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;background:transparent;border:none;cursor:pointer;padding:0}
.mtrig span{width:4px;height:4px;background:var(--tx);border-radius:50%;transition:all .2s}
.mtrig:hover span{background:var(--ap)}
.mdd{position:absolute;top:100%;right:0;margin-top:8px;background:var(--sf);border:2px solid var(--bd);min-width:120px;display:none;z-index:100}
.mdd.on{display:block}
.mi{width:100%;padding:8px 16px;background:transparent;border:none;color:var(--tx);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;text-align:left;cursor:pointer;transition:all .2s}
.mi:hover{background:var(--sfe);color:var(--ap)}
.bnav{position:fixed;bottom:0;left:0;right:0;background:var(--sf);border-top:2px solid var(--bd);z-index:1000;padding-bottom:env(safe-area-inset-bottom)}
.bnav-c{max-width:480px;margin:0 auto;display:flex;justify-content:space-around;align-items:center;height:64px}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;height:100%;color:var(--txm);text-decoration:none;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;transition:all .2s;position:relative;cursor:pointer}
.ni::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:0;height:2px;background:var(--ap);transition:width .2s}
.ni:hover{color:var(--txs);background:var(--sfe)}
.ni.act{color:var(--ap)}
.ni.act::before{width:100%}
.nico{font-size:20px;line-height:1}
.hero-s{position:relative;margin:0 -16px 24px}
.hero{position:relative;width:100%;aspect-ratio:1/1;overflow:hidden;border-top:2px solid var(--bd);border-bottom:2px solid var(--bd);background:var(--sf)}
.hero img{width:100%;height:100%;object-fit:cover;transition:transform .6s,filter .3s}
.hero:hover img{transform:scale(1.03)}
.hero::after{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.03) 2px,rgba(0,0,0,.03) 4px);pointer-events:none}
.hnote{position:absolute;bottom:0;left:0;right:0;padding:16px;background:linear-gradient(to top,rgba(0,0,0,.9),transparent);font-family:'Instrument Serif',serif;font-size:24px;font-style:italic;color:var(--tx);line-height:1.2;z-index:20}
.upctrls{position:absolute;top:16px;right:16px;display:flex;flex-direction:column;gap:8px;align-items:flex-end;z-index:20}
.upbtn{width:48px;height:48px;background:var(--ap);border:none;color:var(--bg);font-size:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;box-shadow:4px 4px 0 var(--bg),4px 4px 0 2px var(--ap);position:relative}
.upbtn:hover:not(:disabled){transform:translate(2px,2px);box-shadow:2px 2px 0 var(--bg),2px 2px 0 2px var(--ap)}
.upbtn:disabled{background:var(--txm);box-shadow:none;cursor:not-allowed;opacity:.6}
.upcnt{position:absolute;top:-8px;right:-8px;background:var(--at);color:var(--tx);font-size:10px;font-weight:700;padding:2px 6px;min-width:20px;text-align:center}
.qtimer{position:absolute;top:calc(100% + 8px);right:0;background:var(--sf);border:2px solid var(--bd);padding:8px 16px;font-size:11px;color:var(--txs);white-space:nowrap;opacity:0;visibility:hidden;transition:all .2s;z-index:30}
.qtimer::before{content:'';position:absolute;bottom:100%;right:16px;border:6px solid transparent;border-bottom-color:var(--bd)}
.upctrls:hover .qtimer{opacity:1;visibility:visible}
.isec{margin-bottom:32px}
.ihdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.ilbl{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--txs)}
.ccount{font-size:12px;color:var(--txm);font-variant-numeric:tabular-nums}
.ri{width:100%;background:var(--sf);border:2px solid var(--bd);padding:16px;color:var(--tx);font-family:'Plus Jakarta Sans',sans-serif;font-size:16px;line-height:1.5;resize:none;min-height:120px;transition:all .2s}
.ri:focus{outline:none;border-color:var(--ap);background:var(--sfe)}
.ri::placeholder{color:var(--txm)}
.msec{margin:16px 0}
.mlbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--txs);margin-bottom:8px}
.mgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.mc{position:relative;padding:16px;background:var(--sf);border:2px solid var(--bd);cursor:pointer;transition:all .2s;display:flex;flex-direction:column;gap:4px}
.mc:hover{border-color:var(--txs);transform:translateY(-2px)}
.mc.act{border-color:currentColor;background:var(--sfe)}
.mc.act::before{content:'‚úì';position:absolute;top:8px;right:8px;font-size:12px;font-weight:700}
.me{font-size:28px;line-height:1}
.mn{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:.05em}
.md-desc{font-size:11px;color:var(--txs)}
.mc[data-mood="surviving"]{color:var(--ms)}
.mc[data-mood="thriving"]{color:var(--mt)}
.mc[data-mood="chaotic"]{color:var(--mc)}
.mc[data-mood="doom"]{color:var(--md)}
.iact{display:flex;justify-content:flex-end;margin-top:16px}
.sbtn{padding:14px 32px;font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;background:var(--ap);border:none;color:var(--bg);cursor:pointer;transition:all .2s;box-shadow:4px 4px 0 var(--sfe),4px 4px 0 2px var(--ap)}
.sbtn:hover:not(:disabled){transform:translate(2px,2px);box-shadow:2px 2px 0 var(--sfe),2px 2px 0 2px var(--ap)}
.sbtn:disabled{opacity:.5;cursor:not-allowed;box-shadow:none}
.shdr{display:flex;align-items:center;gap:8px;margin-bottom:16px;padding-bottom:8px;border-bottom:2px solid var(--bd)}
.stit{font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:.15em;color:var(--tx)}
.sline{flex:1;height:2px;background:var(--bd)}
.entry{background:var(--sf);border:2px solid var(--bd);margin-bottom:16px;position:relative;animation:si .4s ease}
@keyframes si{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.entry:hover{border-color:var(--ap)}
.ehdr{display:flex;justify-content:space-between;align-items:center;padding:8px 16px;border-bottom:1px solid var(--bd);background:var(--sfe)}
.emeta{display:flex;align-items:center;gap:8px}
.etime{font-size:11px;color:var(--txm);font-weight:600;letter-spacing:.05em}
.emood{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;padding:4px 8px;border:1px solid currentColor}
.emood.surviving{color:var(--ms)}
.emood.thriving{color:var(--mt)}
.emood.chaotic{color:var(--mc)}
.emood.doom{color:var(--md)}
.econt{padding:16px;font-size:15px;line-height:1.6;color:var(--tx)}
.tgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:2px;background:var(--bd);border:2px solid var(--bd);margin-bottom:16px}
.ti{aspect-ratio:1;background:var(--sf);position:relative;overflow:hidden;cursor:pointer}
.ti.empty{display:flex;align-items:center;justify-content:center;color:var(--txm);font-size:20px;border:2px dashed var(--bd)}
.ti img{width:100%;height:100%;object-fit:cover;transition:all .3s}
.ti:hover img{transform:scale(1.1)}
.ti::after{content:'';position:absolute;inset:0;background:var(--ap);opacity:0;transition:opacity .2s;mix-blend-mode:multiply}
.ti:hover::after{opacity:.3}
.entry-dummy{opacity:.6;border-style:dashed!important}
.entry-dummy:hover{border-color:var(--bd)!important;opacity:.75}
.reaction-bar{display:flex;gap:6px;padding:10px 16px;border-top:1px solid var(--bd);background:var(--sfe);align-items:center;flex-wrap:wrap}
.reaction-btn{position:relative;display:flex;align-items:center;gap:4px;padding:5px 10px;background:var(--sf);border:2px solid var(--bd);cursor:pointer;transition:all .15s;border-radius:4px;font-family:inherit}
.reaction-btn:hover:not([disabled]){border-color:var(--txs);transform:translateY(-2px);background:var(--sfe)}
.reaction-btn.act{border-color:var(--ap);background:var(--ap)}
.reaction-btn[disabled]{cursor:not-allowed;opacity:.38;pointer-events:none}
.remoji{font-size:17px;line-height:1}
.rcount{font-size:11px;font-weight:700;color:var(--txs);min-width:14px;text-align:center;font-variant-numeric:tabular-nums}
.reaction-btn.act .rcount{color:#000}
.fifo-i{font-size:9px;color:var(--txm);text-transform:uppercase;letter-spacing:.05em;padding:2px 6px;border:1px solid var(--bd)}
.es{padding:32px 16px;text-align:center;border:2px dashed var(--bd)}
.ee{font-size:48px;margin-bottom:16px;display:block;animation:fl 3s ease-in-out infinite}
@keyframes fl{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.et{font-family:'Instrument Serif',serif;font-size:20px;font-style:italic;color:var(--txs);margin-bottom:8px}
.est{font-size:13px;color:var(--txm)}
footer{padding:32px 0;text-align:center;border-top:2px solid var(--bd);margin-bottom:80px;position:relative}
.ftxt{font-size:11px;color:var(--txm);text-transform:uppercase;letter-spacing:.2em}
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--tx);color:var(--bg);padding:8px 16px;font-size:13px;font-weight:600;z-index:10000;opacity:0;transition:all .3s}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.proc{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:10002;display:none;flex-direction:column;align-items:center;justify-content:center;gap:16px}
.proc.on{display:flex}
.pspin{width:48px;height:48px;border:3px solid var(--bd);border-top-color:var(--ap);border-radius:50%;animation:sp 1s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.ptxt{font-size:14px;color:var(--txs);text-align:center}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:10001;padding:16px;overflow-y:auto}
.modal.on{display:block}
.mc2{max-width:480px;margin:0 auto;background:var(--sf);border:2px solid var(--bd);padding:24px}
.mhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:16px;border-bottom:2px solid var(--bd)}
.mtit{font-size:18px;font-weight:800;text-transform:uppercase;letter-spacing:.05em}
.mcls{background:none;border:none;color:var(--tx);font-size:24px;cursor:pointer}
.ggrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.gi{aspect-ratio:1;background:var(--sfe);border:2px solid var(--bd);cursor:pointer;overflow:hidden;position:relative}
.gi img{width:100%;height:100%;object-fit:cover;transition:all .2s}
.gi:hover img{transform:scale(1.05)}
.gi.sel{border-color:var(--ap);box-shadow:0 0 0 2px var(--ap)}
.gi.sel::after{content:'‚úì';position:absolute;top:4px;right:4px;background:var(--ap);color:var(--bg);width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700}
.tmsec{margin:16px 0;padding:16px;background:var(--sfe);border:2px solid var(--bd)}
.tmhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.tmlbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--txs)}
.tmnm{font-size:11px;font-weight:700;color:var(--ap)}
.tmsl{width:100%;height:4px;background:var(--bd);outline:none;-webkit-appearance:none;margin:8px 0}
.tmsl::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;background:var(--ap);cursor:pointer;border:2px solid var(--tx);box-shadow:2px 2px 0 var(--bg)}
.tmlabs{display:flex;justify-content:space-between;font-size:9px;color:var(--txm);font-weight:600;text-transform:uppercase}
.notsec{margin:16px 0;padding:16px;background:var(--sfe);border:2px solid var(--bd)}
.notlbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--txs);margin-bottom:8px;display:flex;justify-content:space-between}
.notcnt{font-size:10px;color:var(--txm)}
.noti{width:100%;background:var(--sf);border:2px solid var(--bd);padding:8px;color:var(--tx);font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;transition:all .2s}
.noti:focus{outline:none;border-color:var(--ap);background:var(--sfe)}
.noti::placeholder{color:var(--txm);font-size:12px}
.gwarn{background:var(--at);color:var(--tx);padding:16px;margin-bottom:16px;font-size:13px;font-weight:700;text-align:center;text-transform:uppercase;letter-spacing:.05em;border:2px solid var(--at);animation:pw 2s infinite}
@keyframes pw{0%,100%{opacity:1}50%{opacity:.8}}
.gwarn::before{content:'üö´ '}
.macts{margin-top:16px;display:flex;justify-content:flex-end;gap:8px}
.mbtn{padding:12px 24px;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;border:2px solid var(--bd);background:var(--sf);color:var(--tx);cursor:pointer;transition:all .2s}
.mbtn.pri{background:var(--ap);border-color:var(--ap);color:var(--bg)}
.mbtn:hover{transform:translateY(-2px)}
.fm{filter:grayscale(100%) contrast(1.1)!important}
.fsp{filter:sepia(100%) contrast(1.1) saturate(.8)!important}
.fl{filter:contrast(1.2) saturate(1.3) brightness(.9)!important}
.fv{filter:grayscale(100%) contrast(1.2) brightness(.9)!important}
.fn{filter:grayscale(100%) contrast(1.4) brightness(.8)!important}
.fc{filter:hue-rotate(180deg) saturate(1.5) contrast(1.1)!important}
.fw{filter:sepia(60%) hue-rotate(-30deg) saturate(1.2)!important}
.fco{filter:hue-rotate(180deg) saturate(.5) brightness(1.1)!important}
.fd{filter:blur(.5px) saturate(1.4) brightness(1.1) contrast(.9)!important}
.fcr{filter:contrast(1.3) saturate(1.1)!important}
.fmo{filter:brightness(.8) contrast(1.2) saturate(.7)!important}
.fg{filter:sepia(40%) hue-rotate(-15deg) saturate(1.3) contrast(1.1)!important}
.sensored-overlay{position:absolute;inset:0;background:#000;display:flex;align-items:center;justify-content:center;color:#FF0000;font-size:14px;font-weight:800;text-transform:uppercase;letter-spacing:2px;border:2px solid #FF0000;animation:pulse-sensor 2s infinite;z-index:25}
@keyframes pulse-sensor{0%,100%{opacity:0.9}50%{opacity:1;box-shadow:inset 0 0 30px #FF0000}}
.sensored-text{transform:rotate(-5deg);border:2px solid #FF0000;padding:4px 8px;background:rgba(0,0,0,0.8)}
.premium-badge{display:inline-block;background:linear-gradient(135deg,var(--ap),var(--at));color:var(--tx);font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;margin-left:8px;text-transform:uppercase}
.void-node{position:fixed;bottom:100px;right:20px;width:24px;height:24px;background:var(--void);border:1px solid #1a1a1a;cursor:pointer;z-index:9998;transition:all 0.3s;opacity:0.6}
.void-node:hover{opacity:1;border-color:#333}
.void-node.active{animation:void-pulse 2s infinite;border-color:#ff006e;box-shadow:0 0 10px rgba(255,0,110,0.3)}
@keyframes void-pulse{0%,100%{box-shadow:0 0 5px rgba(255,0,110,0.2)}50%{box-shadow:0 0 20px rgba(255,0,110,0.6)}}
.void-node::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:4px;height:4px;background:#333;border-radius:50%;transition:all 0.3s}
.void-node.active::after{background:#ff006e;width:6px;height:6px}
.void-portal{position:fixed;inset:0;background:rgba(5,5,5,0.98);z-index:10005;display:none;flex-direction:column;padding:0}
.void-portal.on{display:flex;animation:void-fade 0.3s ease}
@keyframes void-fade{from{opacity:0}to{opacity:1}}
.void-header{padding:20px;border-bottom:1px solid #1a1a1a;display:flex;justify-content:space-between;align-items:center}
.void-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.2em;color:#444}
.void-close{width:32px;height:32px;background:transparent;border:1px solid #333;color:#666;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;font-size:18px}
.void-close:hover{border-color:#ff006e;color:#ff006e}
.void-content{flex:1;overflow-y:auto;padding:20px}
.void-requests{margin-bottom:32px}
.void-section-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.15em;color:#555;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.void-section-title::before,.void-section-title::after{content:'';flex:1;height:1px;background:#1a1a1a}
.void-request{display:flex;align-items:center;gap:12px;padding:16px;background:#0d0d0d;border:1px solid #1a1a1a;margin-bottom:8px;transition:all 0.2s}
.void-request:hover{border-color:#333}
.void-request-avatar{width:40px;height:40px;background:#141414;border:1px solid #2a2a2a;display:flex;align-items:center;justify-content:center;font-size:16px}
.void-request-info{flex:1}
.void-request-from{font-size:13px;font-weight:600;color:#888}
.void-request-meta{font-size:10px;color:#444;margin-top:2px}
.void-request-actions{display:flex;gap:8px}
.void-btn{padding:8px 16px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;border:1px solid #333;background:transparent;color:#666;cursor:pointer;transition:all 0.2s}
.void-btn:hover{border-color:#555;color:#888}
.void-btn.accept{border-color:#39ff14;color:#39ff14}
.void-btn.accept:hover{background:rgba(57,255,20,0.1)}
.void-btn.deny{border-color:#ff3333;color:#ff3333}
.void-btn.deny:hover{background:rgba(255,51,51,0.1)}
.void-contacts{margin-bottom:32px}
.void-contact{display:flex;align-items:center;gap:12px;padding:16px;background:#0d0d0d;border:1px solid #1a1a1a;margin-bottom:8px;cursor:pointer;transition:all 0.2s;position:relative}
.void-contact:hover{border-color:#ff006e;background:rgba(255,0,110,0.05)}
.void-contact::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:#ff006e;opacity:0;transition:opacity 0.2s}
.void-contact:hover::before{opacity:1}
.void-contact-avatar{width:40px;height:40px;background:#141414;border:1px solid #2a2a2a;display:flex;align-items:center;justify-content:center;font-size:16px}
.void-contact-info{flex:1}
.void-contact-name{font-size:13px;font-weight:600;color:#888}
.void-contact-status{font-size:10px;color:#444;margin-top:2px}
.void-contact-status.online{color:#39ff14}
.void-contact-unread{min-width:20px;height:20px;background:#ff006e;color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;border-radius:50%;animation:void-pulse 2s infinite}
.void-add{display:flex;gap:8px;margin-bottom:32px}
.void-input{flex:1;background:#0d0d0d;border:1px solid #1a1a1a;padding:12px;color:#888;font-family:inherit;font-size:13px;transition:all 0.2s}
.void-input:focus{outline:none;border-color:#333;color:#aaa}
.void-input::placeholder{color:#444}
.void-add-btn{padding:12px 24px;background:#141414;border:1px solid #2a2a2a;color:#666;font-size:11px;font-weight:700;text-transform:uppercase;cursor:pointer;transition:all 0.2s}
.void-add-btn:hover{border-color:#ff006e;color:#ff006e}
.void-chat{position:fixed;inset:0;background:var(--void);z-index:10006;display:none;flex-direction:column}
.void-chat.on{display:flex;animation:void-fade 0.2s ease}
.void-chat-header{padding:16px 20px;border-bottom:1px solid #1a1a1a;display:flex;align-items:center;gap:12px}
.void-chat-back{width:32px;height:32px;background:transparent;border:1px solid #333;color:#666;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s}
.void-chat-back:hover{border-color:#ff006e;color:#ff006e}
.void-chat-info{flex:1}
.void-chat-name{font-size:14px;font-weight:600;color:#888}
.void-chat-status{font-size:10px;color:#444;margin-top:2px}
.void-chat-timer{font-size:18px;font-weight:700;color:#ff006e;font-family:'Instrument Serif',serif}
.void-chat-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px}
.void-message{max-width:80%;padding:16px;font-size:13px;line-height:1.5;position:relative;animation:message-fade 0.3s ease}
@keyframes message-fade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.void-message.sent{align-self:flex-end;background:#1a0a0f;border:1px solid #2a1a1f;color:#aaa}
.void-message.received{align-self:flex-start;background:#0d0d0d;border:1px solid #1a1a1a;color:#888}
.void-message-time{font-size:9px;color:#444;margin-top:8px;text-transform:uppercase;letter-spacing:0.05em}
.void-chat-input{padding:20px;border-top:1px solid #1a1a1a;display:flex;gap:8px}
.void-chat-textarea{flex:1;background:#0d0d0d;border:1px solid #1a1a1a;padding:12px;color:#aaa;font-family:inherit;font-size:13px;resize:none;height:60px;transition:all 0.2s}
.void-chat-textarea:focus{outline:none;border-color:#ff006e}
.void-chat-send{padding:12px 24px;background:#ff006e;border:none;color:#fff;font-size:11px;font-weight:700;text-transform:uppercase;cursor:pointer;transition:all 0.2s}
.void-chat-send:hover{background:#ff1a7a;box-shadow:0 0 20px rgba(255,0,110,0.4)}
.void-chat-send:disabled{opacity:0.3;cursor:not-allowed;box-shadow:none}
.void-burn{position:fixed;inset:0;background:var(--void);z-index:10007;display:none;flex-direction:column;align-items:center;justify-content:center;animation:burn-fade 0.5s ease}
.void-burn.on{display:flex}
@keyframes burn-fade{from{opacity:0}to{opacity:1}}
.void-burn-icon{font-size:80px;margin-bottom:24px;animation:burn-anim 1s ease forwards}
@keyframes burn-anim{0%{transform:scale(1);filter:brightness(1)}50%{transform:scale(1.3);filter:brightness(3) blur(2px)}100%{transform:scale(0);opacity:0;filter:brightness(5) blur(10px)}}
.void-burn-text{font-size:14px;font-weight:700;color:#ff006e;text-transform:uppercase;letter-spacing:0.2em}
.void-empty{text-align:center;padding:48px 20px;color:#444;font-size:12px}
.void-empty-icon{font-size:32px;margin-bottom:12px;display:block;opacity:0.3}
.void-locked{position:fixed;inset:0;background:var(--void);z-index:10005;display:none;flex-direction:column;align-items:center;justify-content:center;padding:40px;text-align:center}
.void-locked.on{display:flex}
.void-locked-icon{font-size:48px;margin-bottom:16px;opacity:0.3}
.void-locked-text{font-size:14px;font-weight:700;color:#444;margin-bottom:8px}
.void-locked-sub{font-size:11px;color:#333;line-height:1.6}
</style>
</head>
<body>
<div class="w">
<header>
  <div>
    <div class="logo" onclick="location.reload()">JEJAK</div>
    <div class="tagline">no filter, just truth</div>
  </div>
  <div class="top-right">
    <div class="huser" id="huser">@anon</div>
    <div class="dot off" id="odot"></div>
    <div class="smenu">
      <button class="mtrig" onclick="toggleMenu()"><span></span><span></span><span></span></button>
      <div class="mdd" id="mdd">
        <button class="mi" onclick="logoutUser()">Logout</button>
      </div>
    </div>
  </div>
</header>

<section class="hero-s">
  <div class="hero" id="hero">
    <img id="himg" src="https://images.unsplash.com/photo-1517842645767-c639042777db?w=400&q=80" alt="artefak" class="fm">
    <div class="hnote" id="hnote">"jeda"</div>
    <div class="upctrls">
      <button class="upbtn" id="upbtn">+</button>
      <div class="qtimer" id="qtimer">Klik untuk upload foto (maks 6)</div>
    </div>
  </div>
</section>

<section class="isec">
  <div class="ihdr"><span class="ilbl">Spill your truth</span><span class="ccount" id="ccount">0/500</span></div>
  <textarea class="ri" id="ri" placeholder="What's eating you alive right now? No cap, no filter..." maxlength="500" oninput="updateCharCount()"></textarea>
  <div class="msec">
    <div class="mlbl">Pilih mood-mu sekarang</div>
    <div class="mgrid">
      <div class="mc act" data-mood="surviving" onclick="selMood('surviving')"><span class="me">üòÆ‚Äçüí®</span><span class="mn" style="color:var(--ms)">Surviving</span><span class="md-desc">Hidup tapi barely</span></div>
      <div class="mc" data-mood="thriving" onclick="selMood('thriving')"><span class="me">‚ú®</span><span class="mn" style="color:var(--mt)">Thriving</span><span class="md-desc">On top of my game</span></div>
      <div class="mc" data-mood="chaotic" onclick="selMood('chaotic')"><span class="me">üåÄ</span><span class="mn" style="color:var(--mc)">Chaotic</span><span class="md-desc">Everything is on fire</span></div>
      <div class="mc" data-mood="doom" onclick="selMood('doom')"><span class="me">üõå</span><span class="mn" style="color:var(--md)">Doom</span><span class="md-desc">Just wanna disappear</span></div>
    </div>
  </div>
  <div class="iact"><button class="sbtn" id="sbtn">Jejakkan & Spill</button></div>
</section>

<section>
  <div class="shdr">
    <span class="stit">Riwayat</span>
    <div class="sline"></div>
    <span style="font-size:10px;color:var(--txm);margin-left:auto">FIFO ‚Ä¢ MAX 6</span>
  </div>
  <div id="econ"></div>
</section>

<section style="margin-bottom:32px">
  <div class="shdr">
    <span class="stit">Memori</span>
    <div class="sline"></div>
    <span style="font-size:10px;color:var(--txm);margin-left:auto">FIFO ‚Ä¢ MAX 6</span>
  </div>
  <div class="tgrid" id="tgrid"></div>
</section>

<footer>
  <p class="ftxt">Nyambat ‚Ä¢ Aksi ‚Ä¢ Solusi</p>
</footer>
</div>

<div class="void-node" id="void-node" onclick="openVoid()"></div>
<div class="void-portal" id="void-portal">
  <div class="void-header">
    <div class="void-title">/// THE VOID <span class="premium-badge">Premium</span></div>
    <button class="void-close" onclick="closeVoid()">√ó</button>
  </div>
  <div class="void-content">
    <div class="void-add">
      <input type="text" class="void-input" id="void-add-input" placeholder="Enter username to request...">
      <button class="void-add-btn" onclick="sendContactRequest()">Request</button>
    </div>
    <div class="void-requests" id="void-requests" style="display:none;">
      <div class="void-section-title">Incoming Requests</div>
      <div id="void-requests-list"></div>
    </div>
    <div class="void-contacts" id="void-contacts">
      <div class="void-section-title">Established Contacts</div>
      <div id="void-contacts-list">
        <div class="void-empty">
          <span class="void-empty-icon">‚óº</span>
          <div>No active contacts</div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="void-chat" id="void-chat">
  <div class="void-chat-header">
    <button class="void-chat-back" onclick="closeVoidChat()">‚Üê</button>
    <div class="void-chat-info">
      <div class="void-chat-name" id="chat-contact-name">@username</div>
      <div class="void-chat-status" id="chat-contact-status">Connected</div>
    </div>
    <div class="void-chat-timer" id="void-timer" style="display:none;">7</div>
  </div>
  <div class="void-chat-messages" id="void-chat-messages"></div>
  <div class="void-chat-input">
    <textarea class="void-chat-textarea" id="void-message-input" placeholder="Type message..." maxlength="280"></textarea>
    <button class="void-chat-send" id="void-send-btn" onclick="sendVoidMessage()">Send</button>
  </div>
</div>
<div class="void-burn" id="void-burn">
  <div class="void-burn-icon">üî•</div>
  <div class="void-burn-text">Message Destroyed</div>
</div>
<div class="void-locked" id="void-locked">
  <div class="void-locked-icon">‚óº</div>
  <div class="void-locked-text">THE VOID IS SEALED</div>
  <div class="void-locked-sub">Upgrade to Premium to access<br>end-to-end encrypted ephemeral messaging</div>
</div>

<nav class="bnav">
  <div class="bnav-c">
    <a href="spill.html" class="ni"><span class="nico">‚úï</span><span>Spill</span></a>
    <a href="jejak.html" class="ni act"><span class="nico">‚ú¶</span><span>Jejak</span></a>
    <a href="glitch.html" class="ni"><span class="nico">‚ö°</span><span>Glitch</span></a>
    <a href="cocomeo.html" class="ni"><span class="nico">„Äú</span><span>Cocomeo</span></a>
  </div>
</nav>

<div class="proc" id="proc">
  <div class="pspin"></div>
  <div class="ptxt" id="proctxt">Mengupload foto...<br><small>Mohon tunggu</small></div>
</div>

<div class="modal" id="gmodal">
  <div class="mc2">
    <div class="mhdr"><h3 class="mtit">Review Artefak</h3><button class="void-close" onclick="closeGallery()">√ó</button></div>
    <div class="gwarn">DILARANG UPLOAD FOTO WAJAH!</div>
    <div style="font-size:11px;color:var(--txs);margin-bottom:16px;text-align:center">Wajah terdeteksi akan otomatis disensor ‚Ä¢ Sistem FIFO (6 foto max) ‚Ä¢ Tidak dapat dihapus</div>
    <div class="ggrid" id="ggrid"></div>
    <div class="tmsec">
      <div class="tmhdr"><span class="tmlbl">üé® Tema Foto</span><span class="tmnm" id="tmnm">MONOCHROME</span></div>
      <input type="range" class="tmsl" id="tmsl" min="0" max="11" value="0" step="1" oninput="updTheme(this.value)">
      <div class="tmlabs"><span>B&W</span><span>Warm</span><span>Cool</span><span>Art</span></div>
    </div>
    <div class="notsec">
      <div class="notlbl"><span>üìù Notasi (Max 4 kata)</span><span class="notcnt" id="notcnt">0/4</span></div>
      <input type="text" class="noti" id="noti" placeholder="Contoh: senja di kamar" maxlength="30" oninput="valNote(this)">
    </div>
    <div class="macts">
      <button class="mbtn" onclick="closeGallery()">Batal</button>
      <button class="mbtn pri" id="konfirmbtn" onclick="confirmUpload()">Konfirmasi (<span id="selcnt">0</span>)</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="finput" accept="image/*" multiple style="display:none">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ============================================
// DUMMY DATA
// ============================================
const DUMMY_ENTRIES = [
  {id:'d1',content:'Hari ini gue nangis di angkot gegara liat kucing dipukul orang. Mental gue udah kayak kerupuk kena hujan.',mood:'surviving',timestamp:Date.now()-3600000,reactions:{skull:42,cry:89,fire:12,upside:7},isDummy:true},
  {id:'d2',content:'akhirnya bisa tidur nyenyak semalaman setelah 3 minggu insomnia. thanks buat chat tadi malam.',mood:'thriving',timestamp:Date.now()-7200000,reactions:{skull:23,cry:15,fire:67,upside:31},isDummy:true},
  {id:'d3',content:'hari ini chaos abis! dari bangun tidur udah salah ambil kaki, sampe kantor lupa bawa laptop.',mood:'chaotic',timestamp:Date.now()-10800000,reactions:{skull:89,cry:23,fire:45,upside:78},isDummy:true}
];

const DUMMY_ARTEFACTS = [
  {id:'a1',url:'https://images.unsplash.com/photo-1517842645767-c639042777db?w=400&q=80',note:'jeda',hasFace:false,isDummy:true,theme:'fm'},
  {id:'a2',url:'https://images.unsplash.com/photo-1499209974431-9dddcece7f88?w=400&q=80',note:'hijau',hasFace:false,isDummy:true,theme:'fg'},
  {id:'a3',url:'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=400&q=80',note:'gabut',hasFace:false,isDummy:true,theme:'fl'},
  {id:'a4',url:'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&q=80',note:'sendiri',hasFace:false,isDummy:true,theme:'fv'},
  {id:'a5',url:'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&q=80',note:'capek',hasFace:true,isDummy:true,theme:'fn'},
  {id:'a6',url:'https://images.unsplash.com/photo-1516035069371-29a1b244cc32?w=400&q=80',note:'love',hasFace:false,isDummy:true,theme:'fc'}
];

// ============================================
// STATE
// ============================================
const S = {
  user: null,
  userId: null,
  isPremium: false,
  entries: [],
  artefacts: [],
  voidContacts: [],
  voidRequests: [],
  voidMessages: [],
  currentChat: null,
  destroyTimer: null
};

// ============================================
// HELPERS - Global Functions
// ============================================
function $(id) { return document.getElementById(id); }

function toast(msg, dur) {
  dur = dur || 3000;
  var t = $('toast'); 
  t.textContent = msg; 
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, dur);
}

function esc(t) { 
  var d = document.createElement('div'); 
  d.textContent = t; 
  return d.innerHTML; 
}

function toggleMenu() { 
  $('mdd').classList.toggle('on'); 
}

function logoutUser() { 
  if(!confirm('Yakin logout? Semua data lokal akan dihapus.')) return; 
  localStorage.clear();
  location.href='index.html'; 
}

function selMood(mood) { 
  var cards = document.querySelectorAll('.mc');
  for(var i = 0; i < cards.length; i++) {
    cards[i].classList.toggle('act', cards[i].dataset.mood === mood);
  }
}

function showProc(msg) { 
  msg = msg || 'Mengupload...';
  $('proctxt').innerHTML = msg; 
  $('proc').classList.add('on'); 
}

function hideProc() { 
  $('proc').classList.remove('on'); 
}

function timeAgo(timestamp) {
  var seconds = Math.floor((Date.now() - timestamp) / 1000);
  if (seconds < 60) return 'baru saja';
  var minutes = Math.floor(seconds / 60);
  if (minutes < 60) return minutes + 'm lalu';
  var hours = Math.floor(minutes / 60);
  if (hours < 24) return hours + 'j lalu';
  return Math.floor(hours / 24) + 'h lalu';
}

function updateCharCount() {
  var val = $('ri').value.length;
  $('ccount').textContent = val + '/500';
}

// ============================================
// RENDER FUNCTIONS
// ============================================
function renderEntries() {
  var con = $('econ'); 
  if(!con) {
    console.error('econ not found');
    return;
  }
  
  var hasRealEntries = S.entries && S.entries.length > 0;
  var displayEntries = hasRealEntries ? S.entries : DUMMY_ENTRIES;
  
  console.log('Rendering entries:', displayEntries.length, hasRealEntries ? 'real' : 'dummies');
  
  var html = '';
  for(var i = 0; i < displayEntries.length; i++) {
    var e = displayEntries[i];
    var ta = e.isDummy ? 'contoh' : timeAgo(e.timestamp);
    var emojiMap = {surviving:'üòÆ‚Äçüí®',thriving:'‚ú®',chaotic:'üåÄ',doom:'üõå'};
    var emoji = emojiMap[e.mood] || '';
    var dummyClass = e.isDummy ? ' entry-dummy' : '';
    var dummyLabel = e.isDummy ? '<span class=\"fifo-i\">Contoh</span>' : '';
    
    var reactionsHtml = '';
    var reactions = {skull:'üíÄ',cry:'üò≠',fire:'üî•',upside:'üôÉ'};
    for(var key in reactions) {
      var count = e.reactions && e.reactions[key] ? e.reactions[key] : 0;
      reactionsHtml += '<button class=\"reaction-btn\" disabled><span class=\"remoji\">' + reactions[key] + '</span><span class=\"rcount\">' + count + '</span></button>';
    }
    
    html += '<article class=\"entry' + dummyClass + '\">' +
      '<div class=\"ehdr\">' +
        '<div class=\"emeta\">' +
          '<span class=\"etime\">' + ta + '</span>' +
          '<span class=\"emood ' + e.mood + '\">' + emoji + ' ' + e.mood + '</span>' +
        '</div>' + dummyLabel +
      '</div>' +
      '<div class=\"econt\">' + esc(e.content) + '</div>' +
      '<div class=\"reaction-bar\">' + reactionsHtml + '</div>' +
    '</article>';
  }
  
  con.innerHTML = html;
}

function renderTray() {
  var con = $('tgrid'); 
  if(!con) {
    console.error('tgrid not found');
    return;
  }
  
  var hasRealArtefacts = S.artefacts && S.artefacts.length > 0;
  var displayArtefacts = hasRealArtefacts ? S.artefacts : DUMMY_ARTEFACTS;
  
  console.log('Rendering artefacts:', displayArtefacts.length, hasRealArtefacts ? 'real' : 'dummies');
  
  var html = '';
  for(var i = 0; i < Math.min(displayArtefacts.length, 6); i++) {
    var a = displayArtefacts[i];
    if(a.hasFace) {
      html += '<div class=\"ti\" onclick=\"setHero(\\'' + a.id + '\\')\" style=\"position:relative\">' +
        '<img src=\"' + a.url + '\" class=\"' + a.theme + '\" alt=\"' + a.note + '\">' +
        '<div class=\"sensored-overlay\"><span class=\"sensored-text\">SENSORED</span></div>' +
      '</div>';
    } else {
      html += '<div class=\"ti\" onclick=\"setHero(\\'' + a.id + '\\')\">' +
        '<img src=\"' + a.url + '\" class=\"' + a.theme + '\" alt=\"' + a.note + '\">' +
      '</div>';
    }
  }
  
  for(var j = displayArtefacts.length; j < 6; j++) {
    html += '<div class=\"ti empty\" onclick=\"document.getElementById(\\'upbtn\\').click()\">+</div>';
  }
  
  con.innerHTML = html;
}

function setHero(id) {
  var a = null;
  for(var i = 0; i < S.artefacts.length; i++) {
    if(S.artefacts[i].id === id) { a = S.artefacts[i]; break; }
  }
  if(!a) {
    for(var j = 0; j < DUMMY_ARTEFACTS.length; j++) {
      if(DUMMY_ARTEFACTS[j].id === id) { a = DUMMY_ARTEFACTS[j]; break; }
    }
  }
  if(!a) return;
  
  var img = $('himg'), note = $('hnote');
  if(img) { img.src = a.url; img.className = a.theme; }
  if(note) note.textContent = '"' + a.note + '"';
  
  if(!a.isDummy && S.userId) {
    localStorage.setItem('jejak_hero_' + S.userId, JSON.stringify({id: a.id, url: a.url, note: a.note, theme: a.theme}));
  }
}

// ============================================
// SUPABASE INIT - TANPA DEKLARASI ULANG
// ============================================
function initSupabase() {
  try {
    if(window.supabase && window.supabase.createClient) {
      window.supabaseClient = window.supabase.createClient(
        'https://fuovfrdicdhnlymnacpz.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0'
      );
      console.log('Supabase initialized');
      return true;
    }
  } catch(e) {
    console.error('Supabase init failed:', e);
  }
  return false;
}

// ============================================
// AUTH
// ============================================
async function checkAuth() {
  var username = localStorage.getItem('jejak_username');
  var userId = localStorage.getItem('user_id');
  var loggedIn = localStorage.getItem('jejak_logged_in') === 'true';
  
  console.log('Auth check:', { username: username, userId: userId, loggedIn: loggedIn });
  
  if(loggedIn && username && userId) {
    S.userId = userId;
    S.user = username;
    S.isPremium = false;
    
    var huser = $('huser');
    var odot = $('odot');
    
    if(huser) huser.textContent = '@' + S.user;
    if(odot) odot.classList.remove('off');
    
    await loadEntries();
    await loadArtefacts();
    
    console.log('Auth success:', S.user);
    return true;
  }
  
  console.log('Not logged in');
  return false;
}

// ============================================
// LOAD DATA
// ============================================
async function loadEntries() {
  if(!S.userId || !window.supabaseClient) return;
  
  try {
    var result = await window.supabaseClient
      .from('entries')
      .select('*')
      .eq('user_id', S.userId)
      .order('created_at', { ascending: false })
      .limit(6);
    
    var data = result.data;
    var error = result.error;
    
    if(error) throw error;
    
    if(data && data.length > 0) {
      S.entries = [];
      for(var i = 0; i < data.length; i++) {
        var e = data[i];
        S.entries.push({
          id: e.id,
          content: e.content,
          mood: e.mood,
          timestamp: new Date(e.created_at).getTime(),
          reactions: e.reactions || { skull: 0, cry: 0, fire: 0, upside: 0 },
          isDummy: false
        });
      }
    } else {
      S.entries = [];
    }
    
    renderEntries();
    
  } catch(err) {
    console.error('Load entries error:', err);
  }
}

async function loadArtefacts() {
  if(!S.userId || !window.supabaseClient) return;
  
  try {
    var result = await window.supabaseClient
      .from('artefacts')
      .select('*')
      .eq('user_id', S.userId)
      .order('created_at', { ascending: false })
      .limit(6);
    
    var data = result.data;
    var error = result.error;
    
    if(error) throw error;
    
    if(data && data.length > 0) {
      S.artefacts = [];
      for(var i = 0; i < data.length; i++) {
        var a = data[i];
        S.artefacts.push({
          id: a.id,
          url: a.url,
          note: a.note,
          hasFace: a.has_face,
          theme: a.theme,
          timestamp: new Date(a.created_at).getTime(),
          isDummy: false
        });
      }
    } else {
      S.artefacts = [];
    }
    
    renderTray();
    
  } catch(err) {
    console.error('Load artefacts error:', err);
  }
}

// ============================================
// SAVE SPILL
// ============================================
async function saveEntry() {
  var content = $('ri').value.trim();
  if(!content) {
    toast('Tulis dulu spill-nya');
    return;
  }
  
  var activeMoodEl = document.querySelector('.mc.act');
  var activeMood = activeMoodEl ? activeMoodEl.dataset.mood : 'surviving';
  
  if(!S.userId) {
    toast('Login dulu untuk spill');
    setTimeout(function() { location.href='index.html'; }, 1500);
    return;
  }
  
  showProc('Menyimpan spill...');
  
  try {
    var result = await window.supabaseClient
      .from('entries')
      .insert({
        user_id: S.userId,
        content: content,
        mood: activeMood,
        reactions: { skull: 0, cry: 0, fire: 0, upside: 0 },
        created_at: new Date().toISOString()
      })
      .select();
    
    var data = result.data;
    var error = result.error;
    
    if(error) throw error;
    
    $('ri').value = '';
    $('ccount').textContent = '0/500';
    
    await loadEntries();
    toast('Spill terkirim!');
    
  } catch(err) {
    console.error('Save error:', err);
    toast('Gagal menyimpan: ' + err.message);
  } finally {
    hideProc();
  }
}

// ============================================
// UPLOAD
// ============================================
var pendingFiles = [];
var selFiles = new Set();
var currentTheme = 0;
var currentNote = '';

var THEMES = [
  {name:'MONOCHROME',filter:'fm'},{name:'NOIR',filter:'fn'},{name:'SEPIA',filter:'fsp'},{name:'WARM',filter:'fw'},
  {name:'GOLDEN',filter:'fg'},{name:'LOMO',filter:'fl'},{name:'DREAM',filter:'fd'},{name:'COLD',filter:'fco'},
  {name:'CYBER',filter:'fc'},{name:'VIGNETTE',filter:'fv'},{name:'CRISP',filter:'fcr'},{name:'MOODY',filter:'fmo'}
];

function initUpload() {
  var btn = $('upbtn'), fi = $('finput'); 
  if(!btn || !fi) return;
  
  btn.onclick = function() { 
    fi.value = ''; 
    fi.click(); 
  };
  fi.onchange = handleFiles;
}

async function handleFiles(e) {
  var files = Array.from(e.target.files).slice(0, 6);
  if(!files.length) return;
  
  if(!S.userId) {
    toast('Login dulu untuk upload');
    setTimeout(function() { location.href='index.html'; }, 1500);
    return;
  }
  
  var pf = [];
  for(var i = 0; i < files.length; i++) {
    pf.push({
      file: files[i],
      hasFace: false,
      preview: URL.createObjectURL(files[i])
    });
  }
  openGallery(pf);
}

function openGallery(files) {
  selFiles = new Set();
  for(var i = 0; i < files.length; i++) {
    selFiles.add(i);
  }
  currentTheme = 0; 
  currentNote = '';
  
  var grid = $('ggrid'); 
  if(!grid) return;
  
  grid.innerHTML = '';
  for(var j = 0; j < files.length; j++) {
    var item = files[j];
    var d = document.createElement('div'); 
    d.className = 'gi sel';
    d.innerHTML = '<img src=\"' + item.preview + '\" class=\"fm\" id=\"pv' + j + '\">';
    d.onclick = (function(idx) { return function() { toggleSel(idx, this); }; })(j);
    grid.appendChild(d);
  }
  
  $('tmsl').value = 0; 
  $('tmnm').textContent = 'MONOCHROME';
  $('noti').value = ''; 
  $('notcnt').textContent = '0/4';
  updSelCnt();
  $('gmodal').classList.add('on');
  pendingFiles = files;
}

function toggleSel(i, el) { 
  if(selFiles.has(i)) selFiles.delete(i); 
  else selFiles.add(i); 
  el.classList.toggle('sel'); 
  updSelCnt(); 
}

function updSelCnt() { 
  $('selcnt').textContent = selFiles.size; 
}

function updTheme(v) { 
  currentTheme = parseInt(v); 
  var th = THEMES[currentTheme]; 
  $('tmnm').textContent = th.name;
  for(var i = 0; i < pendingFiles.length; i++) {
    var img = $('pv' + i); 
    if(img) {
      img.className = th.filter;
    }
  }
}

function valNote(inp) { 
  var val = inp.value.trim();
  var words = val.split(/\\s+/).filter(function(x) { return x.length > 0; });
  $('notcnt').textContent = Math.min(words.length, 4) + '/4';
  if(words.length > 4) {
    inp.value = words.slice(0, 4).join(' ');
  }
  currentNote = inp.value.trim();
}

function closeGallery() { 
  $('gmodal').classList.remove('on'); 
  pendingFiles = [];
  selFiles.clear();
}

async function confirmUpload() {
  if(selFiles.size === 0) { 
    toast('Pilih minimal 1'); 
    return; 
  }
  
  var kbtn = $('konfirmbtn'); 
  if(kbtn) kbtn.disabled = true;
  
  closeGallery();
  showProc('Mengupload foto...<br><small>Mohon tunggu</small>');

  var theme = THEMES[currentTheme];
  var note = currentNote || 'memory';
  var uploadedCount = 0;

  var selFilesArray = Array.from(selFiles);
  for(var idx = 0; idx < selFilesArray.length; idx++) {
    var i = selFilesArray[idx];
    var item = pendingFiles[i];
    var file = item.file;
    var ext = file.name.split('.').pop() || 'jpg';
    var timestamp = Date.now();
    var storagePath = S.userId + '/' + timestamp + '_' + i + '.' + ext;

    if(window.supabaseClient) {
      try {
        var uploadResult = await window.supabaseClient
          .storage
          .from('artefacts')
          .upload(storagePath, file, {
            contentType: file.type,
            upsert: false
          });

        if(uploadResult.error) {
          console.error('Upload error:', uploadResult.error);
          continue;
        }

        var urlResult = window.supabaseClient
          .storage
          .from('artefacts')
          .getPublicUrl(storagePath);

        var publicUrl = urlResult.data.publicUrl;

        var insertResult = await window.supabaseClient
          .from('artefacts')
          .insert({
            user_id: S.userId,
            url: publicUrl,
            note: note,
            has_face: item.hasFace,
            theme: theme.filter,
            created_at: new Date().toISOString()
          })
          .select();
        
        if(!insertResult.error && insertResult.data && insertResult.data[0]) {
          S.artefacts.unshift({
            id: insertResult.data[0].id,
            url: publicUrl,
            note: note,
            hasFace: item.hasFace,
            theme: theme.filter,
            timestamp: Date.now(),
            isDummy: false
          });
        } else {
          S.artefacts.unshift({
            id: 'local_' + timestamp + '_' + i,
            url: publicUrl,
            note: note,
            hasFace: item.hasFace,
            theme: theme.filter,
            timestamp: timestamp,
            isDummy: false
          });
        }
      } catch(uploadErr) {
        console.error('Upload failed:', uploadErr);
        continue;
      }
    } else {
      S.artefacts.unshift({
        id: 'local_' + timestamp + '_' + i,
        url: item.preview,
        note: note,
        hasFace: item.hasFace,
        theme: theme.filter,
        timestamp: timestamp,
        isDummy: false
      });
    }
    
    uploadedCount++;
  }

  await loadArtefacts();
  
  if(S.artefacts.length > 0) {
    setHero(S.artefacts[0].id);
  }

  hideProc();
  if(kbtn) kbtn.disabled = false;
  toast('‚úì ' + uploadedCount + ' foto diupload');
}

// ============================================
// THE VOID
// ============================================
function openVoid() {
  if(!S.isPremium) {
    $('void-locked').classList.add('on');
    return;
  }
  $('void-portal').classList.add('on');
}

function closeVoid() {
  $('void-portal').classList.remove('on');
}

function closeVoidLocked() {
  $('void-locked').classList.remove('on');
}

function closeVoidChat() {
  $('void-chat').classList.remove('on');
}

function sendContactRequest() {
  toast('Fitur ini memerlukan Premium');
}

function sendVoidMessage() {
  toast('Fitur ini memerlukan Premium');
}

// ============================================
// INIT
// ============================================
document.addEventListener('DOMContentLoaded', function() {
  console.log('=== JEJAK APP STARTING ===');
  
  renderEntries();
  renderTray();
  
  initUpload();
  
  var sbtn = $('sbtn');
  if(sbtn) {
    sbtn.onclick = saveEntry;
  }
  
  initSupabase();
  
  checkAuth().then(function(authed) {
    if(authed) {
      renderEntries();
      renderTray();
    }
  });
  
  document.addEventListener('click', function(e) {
    if(!e.target.closest('.smenu')) {
      $('mdd').classList.remove('on');
    }
  });
  
  console.log('=== APP READY ===');
});
</script>
</body>
</html>
