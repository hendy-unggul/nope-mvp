<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>JEJAK ‚Äî Upload Debug</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0a0a0a;color:#fff;font-family:monospace;padding:20px;font-size:13px}
h2{color:#00ff88;margin-bottom:16px}
.box{background:#141414;border:1px solid #333;padding:16px;margin-bottom:12px;border-radius:4px}
.box h3{color:#ff9500;margin-bottom:10px;font-size:12px;text-transform:uppercase;letter-spacing:.1em}
button{background:#00ff88;color:#000;border:none;padding:10px 20px;font-family:monospace;font-size:13px;font-weight:700;cursor:pointer;margin:4px 4px 4px 0;border-radius:4px}
button:hover{background:#00cc66}
button.red{background:#ff3366;color:#fff}
input[type=file]{color:#fff;margin:8px 0;display:block}
#log{background:#050505;border:1px solid #222;padding:12px;height:400px;overflow-y:auto;font-size:11px;line-height:1.8;border-radius:4px}
.ok{color:#00ff88}
.err{color:#ff3366}
.warn{color:#ff9500}
.info{color:#00d4ff}
.dim{color:#555}
</style>
</head>
<body>

<h2>üî¨ JEJAK ‚Äî Storage Debug Tool</h2>

<div class="box">
  <h3>Step 1 ‚Äî Cek Session localStorage</h3>
  <button onclick="checkSession()">Cek Session</button>
  <button onclick="clearSession()" class="red">Clear Session</button>
</div>

<div class="box">
  <h3>Step 2 ‚Äî Cek Koneksi Supabase</h3>
  <button onclick="testSupabase()">Test Koneksi</button>
</div>

<div class="box">
  <h3>Step 3 ‚Äî Cek Bucket & Policy</h3>
  <button onclick="testBucket()">Cek Bucket</button>
</div>

<div class="box">
  <h3>Step 4 ‚Äî Test Upload File</h3>
  <input type="file" id="testFile" accept="image/*">
  <button onclick="testUpload()">Test Upload</button>
  <button onclick="testUploadBase64()">Test Upload (Base64 dummy)</button>
</div>

<div class="box">
  <h3>Step 5 ‚Äî Test Insert DB</h3>
  <button onclick="testInsertDB()">Test Insert Artefact ke DB</button>
</div>

<div class="box">
  <h3>Log</h3>
  <button onclick="clearLog()" class="red">Clear Log</button>
  <div id="log"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
var SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';

var db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
var testUserId = null;
var testUploadUrl = null;

function log(msg, type) {
  type = type || 'info';
  var el = document.getElementById('log');
  var time = new Date().toLocaleTimeString();
  el.innerHTML += '<span class="dim">[' + time + ']</span> <span class="' + type + '">' + msg + '</span>\n';
  el.scrollTop = el.scrollHeight;
}

function clearLog() { document.getElementById('log').innerHTML = ''; }

// ============================================================
// STEP 1: Session Check
// ============================================================
function checkSession() {
  log('--- CEK SESSION ---', 'warn');
  var keys = ['user_id','jejak_username','jejak_logged_in','jejak_session_id'];
  var allOk = true;
  keys.forEach(function(k) {
    var v = localStorage.getItem(k);
    if (v) {
      log('‚úì ' + k + ' = "' + v + '"', 'ok');
    } else {
      log('‚úó ' + k + ' = NULL / tidak ada', 'err');
      allOk = false;
    }
  });

  testUserId = localStorage.getItem('user_id');

  if (!testUserId || testUserId === 'undefined') {
    log('‚ö†Ô∏è user_id tidak valid! Harus login ulang dari index.html', 'err');
  } else if (testUserId.length < 30) {
    log('‚ö†Ô∏è user_id terlalu pendek (' + testUserId.length + ' chars) ‚Äî mungkin bukan UUID valid', 'err');
  } else {
    log('‚úì user_id valid UUID: ' + testUserId, 'ok');
  }
}

function clearSession() {
  ['user_id','jejak_username','jejak_logged_in'].forEach(function(k) {
    localStorage.removeItem(k);
  });
  log('Session cleared ‚Äî silakan login ulang dari index.html', 'warn');
}

// ============================================================
// STEP 2: Supabase Connection
// ============================================================
async function testSupabase() {
  log('--- TEST KONEKSI SUPABASE ---', 'warn');
  try {
    var r = await db.from('profiles').select('count').limit(1);
    if (r.error) {
      log('‚úó Query profiles gagal: ' + r.error.message, 'err');
    } else {
      log('‚úì Supabase terhubung, profiles accessible', 'ok');
    }
  } catch(e) {
    log('‚úó Exception: ' + e.message, 'err');
  }
}

// ============================================================
// STEP 3: Bucket Check
// ============================================================
async function testBucket() {
  log('--- CEK BUCKET ---', 'warn');
  try {
    // List files di root bucket
    var r = await db.storage.from('artefacts').list('', { limit: 1 });
    if (r.error) {
      log('‚úó Bucket list error: ' + r.error.message, 'err');
      log('  status: ' + r.error.statusCode, 'err');
      log('  ‚Üí Kemungkinan: bucket belum ada / policy SELECT belum dibuat', 'warn');
    } else {
      log('‚úì Bucket "artefacts" accessible', 'ok');
      log('  Files di root: ' + (r.data ? r.data.length : 0), 'info');
    }
  } catch(e) {
    log('‚úó Exception: ' + e.message, 'err');
  }
}

// ============================================================
// STEP 4a: Upload real file
// ============================================================
async function testUpload() {
  log('--- TEST UPLOAD FILE ASLI ---', 'warn');

  var fileInput = document.getElementById('testFile');
  if (!fileInput.files || !fileInput.files[0]) {
    log('‚úó Pilih file dulu!', 'err');
    return;
  }

  var file = fileInput.files[0];
  var ext = file.name.split('.').pop().toLowerCase() || 'jpg';
  var path = 'test_' + Date.now() + '.' + ext;

  log('File: ' + file.name + ' (' + file.type + ', ' + Math.round(file.size/1024) + 'KB)', 'info');
  log('Path: ' + path, 'info');

  try {
    var r = await db.storage.from('artefacts').upload(path, file, {
      contentType: file.type || 'image/jpeg',
      upsert: true
    });

    if (r.error) {
      log('‚úó Upload GAGAL!', 'err');
      log('  message: ' + r.error.message, 'err');
      log('  statusCode: ' + r.error.statusCode, 'err');
      log('  error: ' + JSON.stringify(r.error), 'err');

      // Diagnosa berdasarkan error code
      if (r.error.statusCode === '403' || r.error.message.includes('policy')) {
        log('  ‚Üí DIAGNOSIS: Policy INSERT belum dibuat atau salah konfigurasi', 'warn');
        log('  ‚Üí Solusi: Storage ‚Üí artefacts ‚Üí Policies ‚Üí tambah INSERT policy untuk anon', 'warn');
      } else if (r.error.statusCode === '404') {
        log('  ‚Üí DIAGNOSIS: Bucket "artefacts" tidak ditemukan', 'warn');
        log('  ‚Üí Solusi: Jalankan SQL Part 2', 'warn');
      } else if (r.error.message.includes('mime')) {
        log('  ‚Üí DIAGNOSIS: MIME type tidak diizinkan', 'warn');
        log('  ‚Üí Solusi: Cek allowed_mime_types di bucket settings', 'warn');
      } else if (r.error.message.includes('size')) {
        log('  ‚Üí DIAGNOSIS: File terlalu besar (max 5MB)', 'warn');
      }
    } else {
      log('‚úì Upload BERHASIL!', 'ok');
      log('  path: ' + r.data.path, 'ok');

      var urlR = db.storage.from('artefacts').getPublicUrl(path);
      testUploadUrl = urlR.data.publicUrl;
      log('  public URL: ' + testUploadUrl, 'ok');
    }
  } catch(e) {
    log('‚úó Exception: ' + e.message, 'err');
    log('  stack: ' + e.stack, 'err');
  }
}

// ============================================================
// STEP 4b: Upload dummy base64 (tidak perlu pilih file)
// ============================================================
async function testUploadBase64() {
  log('--- TEST UPLOAD DUMMY IMAGE ---', 'warn');

  // 1x1 pixel transparent PNG
  var base64 = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
  var binary = atob(base64);
  var bytes = new Uint8Array(binary.length);
  for (var i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
  var blob = new Blob([bytes], { type: 'image/png' });

  var path = 'test_dummy_' + Date.now() + '.png';
  log('Uploading 1x1px dummy PNG ke path: ' + path, 'info');

  try {
    var r = await db.storage.from('artefacts').upload(path, blob, {
      contentType: 'image/png',
      upsert: true
    });

    if (r.error) {
      log('‚úó Dummy upload GAGAL: ' + r.error.message, 'err');
      log('  statusCode: ' + r.error.statusCode, 'err');
      log('  full error: ' + JSON.stringify(r.error), 'err');
    } else {
      log('‚úì Dummy upload BERHASIL!', 'ok');
      var urlR = db.storage.from('artefacts').getPublicUrl(path);
      testUploadUrl = urlR.data.publicUrl;
      log('  URL: ' + testUploadUrl, 'ok');
    }
  } catch(e) {
    log('‚úó Exception: ' + e.message, 'err');
  }
}

// ============================================================
// STEP 5: Insert DB
// ============================================================
async function testInsertDB() {
  log('--- TEST INSERT ARTEFACT KE DB ---', 'warn');

  var userId = localStorage.getItem('user_id');
  if (!userId || userId === 'undefined') {
    log('‚úó user_id tidak ada ‚Äî jalankan Step 1 dulu', 'err');
    return;
  }

  var url = testUploadUrl || 'https://example.com/test.jpg';
  log('user_id: ' + userId, 'info');
  log('url: ' + url, 'info');

  try {
    var r = await db.from('artefacts').insert({
      user_id: userId,
      url: url,
      note: 'test',
      has_face: false,
      faces: null,
      theme: 'fm'
    }).select();

    if (r.error) {
      log('‚úó Insert DB GAGAL: ' + r.error.message, 'err');
      log('  code: ' + r.error.code, 'err');
      log('  details: ' + r.error.details, 'err');
      log('  hint: ' + r.error.hint, 'err');

      if (r.error.code === '23503') {
        log('  ‚Üí DIAGNOSIS: Foreign Key violation!', 'warn');
        log('  ‚Üí user_id "' + userId + '" tidak ada di tabel profiles', 'warn');
        log('  ‚Üí Solusi: login ulang dari index.html', 'warn');
      }
    } else {
      log('‚úì Insert DB BERHASIL!', 'ok');
      log('  id: ' + r.data[0].id, 'ok');
      log('  ‚Üí Upload + DB semuanya bekerja! üéâ', 'ok');
    }
  } catch(e) {
    log('‚úó Exception: ' + e.message, 'err');
  }
}

// Auto run session check on load
window.addEventListener('DOMContentLoaded', function() {
  log('Debug tool siap. Jalankan Step 1 sampai 5 secara urut.', 'ok');
  checkSession();
});
</script>
</body>
</html>
