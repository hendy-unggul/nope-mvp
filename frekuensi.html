<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NOPE ‚Äî Frekuensi</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    :root,
    [data-theme="dark"] {
      --bg: #000;
      --surface: #0a0a0a;
      --surface-elevated: #131313;
      --border: #1f1f1f;
      --border-hover: #2a2a2a;
      --text: #f5f5f5;
      --text-secondary: #a0a0a0;
      --muted: #555;
      --accent: #4903fc;
      --accent-hover: #5a1afc;
      --logo-color: #ff9999;
      --success: #00ff88;
      --danger: #ff6b6b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: radial-gradient(ellipse at top, var(--surface), var(--bg));
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
      font-size: 14px;
      line-height: 1.6;
      padding-bottom: 72px;
      -webkit-font-smoothing: antialiased;
    }

    .wrapper {
      max-width: 480px;
      margin: 0 auto;
      padding: 0 16px;
    }

    header {
      position: sticky;
      top: 0;
      background: #000000cc;
      backdrop-filter: blur(6px);
      padding: 12px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }
    .logo {
      font-family: 'Manrope', sans-serif;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--logo-color);
      margin-left: 16px;
    }
    .top-right {
      display: flex;
      align-items: center;
      margin-right: 12px;
    }
    .nav-mini {
      display: flex;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
      margin-right: 8px;
    }
    .nav-mini span {
      cursor: pointer;
      text-decoration: underline;
      text-decoration-style: dotted;
      text-underline-offset: 2px;
    }
    .nav-mini span:hover {
      color: var(--text);
    }
    .settings-btn {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
      transform: rotate(90deg);
    }

    .greeting {
      font-size: 16px;
      margin: 16px 0 20px 0;
      color: var(--text);
    }

    .tab-navigation {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    .tab-navigation::-webkit-scrollbar {
      display: none;
    }
    .tab-btn {
      padding: 10px 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tab-btn:hover {
      border-color: var(--border-hover);
      color: var(--text);
    }
    .tab-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--text);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.2s;
      position: relative;
    }
    .card:hover {
      border-color: var(--border-hover);
    }
    .card-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 16px;
    }
    .card-icon {
      font-size: 24px;
      line-height: 1;
      flex-shrink: 0;
    }
    .card-title-group {
      flex: 1;
    }
    .card-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
      letter-spacing: -0.01em;
    }
    .card-description {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }
    .card-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .post-item {
      padding: 14px;
      background: var(--surface-elevated);
      border-radius: 12px;
      transition: all 0.2s;
      position: relative;
      margin-bottom: 16px;
    }
    .post-item:hover {
      background: var(--border);
    }
    .post-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .post-username {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .post-reactions {
      display: flex;
      gap: 8px;
      font-size: 14px;
      opacity: 0.9;
    }
    .post-reactions span {
      cursor: pointer;
      transition: all 0.2s;
    }
    .post-reactions span:hover {
      opacity: 1;
      transform: scale(1.2);
    }
    .post-content {
      font-size: 14px;
      color: var(--text);
      line-height: 1.5;
      word-break: break-word;
    }

    /* === ARTEFAK LAYER === */
    .artefak-container {
      margin-bottom: 20px;
    }
    .notasi-with-reactions {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .post-notasi {
      font-size: 18px;
      font-weight: 700;
      color: #ff6b6b;
      line-height: 1.3;
      word-break: break-word;
      text-align: left;
    }
    .inline-reactions {
      display: flex;
      gap: 6px;
      font-size: 14px;
      opacity: 0.9;
    }
    .inline-reactions span {
      cursor: pointer;
      transition: all 0.2s;
    }
    .inline-reactions span:hover {
      opacity: 1;
      transform: scale(1.2);
    }
    .image-wrapper {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
    }
    .artefak-image {
      width: 100%;
      display: block;
      max-height: 400px;
      object-fit: cover;
    }
    .subtle-username {
      position: absolute;
      top: 8px;
      left: 8px;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      background: rgba(0, 0, 0, 0.4);
      padding: 2px 6px;
      border-radius: 4px;
      backdrop-filter: blur(2px);
      z-index: 2;
      pointer-events: none;
    }

    /* === ZONE OVERLAY === */
    .zone-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.05);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      border-radius: 16px;
    }

    /* === FLOATING INDICATOR === */
    #zone-indicator {
      position: fixed;
      top: 12px;
      right: 16px;
      background: rgba(0, 0, 0, 0.5);
      color: #ff6b6b;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 100;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .hangout-item {
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s;
      cursor: pointer;
      margin-bottom: 12px;
    }
    .hangout-item:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(73, 3, 252, 0.15);
    }
    .hangout-header {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }
    .hangout-title {
      flex: 1;
    }
    .hangout-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
      line-height: 1.3;
    }
    .hangout-location {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .hangout-badge {
      padding: 4px 10px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-radius: 6px;
      background: var(--danger);
      color: white;
      flex-shrink: 0;
    }
    .hangout-notes {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 10px;
    }
    .hangout-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }
    .hangout-author {
      font-size: 12px;
      color: var(--muted);
    }

    .section {
      margin-bottom: 32px;
    }
    .section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }
    .section-icon {
      font-size: 20px;
    }
    .section-title {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    .section-subtitle {
      font-size: 12px;
      color: var(--muted);
      margin-left: auto;
    }
    .section-content {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .add-btn {
      width: 100%;
      padding: 16px;
      background: var(--surface);
      border: 1px dashed var(--border);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 12px;
    }
    .add-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(73, 3, 252, 0.05);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }
    .empty-state-text {
      font-size: 14px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(4px);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
    }
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease;
    }
    .modal-content {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 28px;
      max-width: 440px;
      width: 100%;
      animation: slideUp 0.3s ease;
    }
    .modal-header {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 20px;
      letter-spacing: -0.02em;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(73, 3, 252, 0.1);
    }
    .form-textarea {
      resize: vertical;
      min-height: 100px;
      line-height: 1.6;
    }
    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: var(--accent);
      color: var(--text);
    }
    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }
    .btn-secondary {
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn-secondary:hover {
      background: var(--border);
    }

    .tagline {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.8;
    }
    .tagline strong {
      color: var(--accent);
      font-weight: 600;
      display: block;
      margin-top: 8px;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(20px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    .pulse-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, rgba(73, 3, 252, 0.2), transparent);
      pointer-events: none;
      opacity: 0;
      z-index: 999;
      animation: pulse 1s ease-out;
    }
    @keyframes pulse {
      0% { 
        transform: scale(0.8);
        opacity: 0.8;
      }
      100% { 
        transform: scale(2);
        opacity: 0;
      }
    }

    @media (max-width: 640px) {
      .greeting {
        font-size: 15px;
      }
      .tab-navigation {
        gap: 6px;
      }
      .tab-btn {
        padding: 8px 16px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <!-- FLOATING INDICATOR -->
  <div id="zone-indicator"></div>

  <div class="wrapper">
    <header>
      <div class="logo">NOPE</div>
      <div class="top-right">
        <div class="nav-mini">
          <span id="nav-jejak">Jejak</span>
          <span id="nav-frekuensi">Frekuensi</span>
          <span id="nav-saynope">SayNOPE</span>
          <span id="nav-glitch">GLITCH</span>
        </div>
        <button class="settings-btn" id="settings-btn">‚ãØ</button>
      </div>
    </header>

    <div class="greeting">@<span id="username-display"></span></div>

    <div class="tab-navigation">
      <button class="tab-btn active" onclick="switchTab('zones')">
        <span>üí¨</span> Zones
      </button>
      <button class="tab-btn" onclick="switchTab('hangouts')">
        <span>üìç</span> Hangouts
      </button>
    </div>

    <!-- ZONES TAB -->
    <div id="tab-zones" class="tab-content active">
      <div class="card" id="zone-hype">
        <div class="zone-overlay"></div>
        <div class="card-header">
          <div class="card-icon">üéß</div>
          <div class="card-title-group">
            <div class="card-title">Hype Haus</div>
            <div class="card-description">Tempat nge-hype idol, drakor, atau AU tanpa takut di-spill.</div>
          </div>
        </div>
        <div class="card-content" id="zone-hype-content"></div>
      </div>

      <div class="card" id="zone-ngusahain">
        <div class="zone-overlay"></div>
        <div class="card-header">
          <div class="card-icon">üíº</div>
          <div class="card-title-group">
            <div class="card-title">Ngusahain</div>
            <div class="card-description">Cerita progress lo: dari skripsi sampe jualan thrifting.</div>
          </div>
        </div>
        <div class="card-content" id="zone-ngusahain-content"></div>
      </div>

      <div class="card" id="zone-spill">
        <div class="zone-overlay"></div>
        <div class="card-header">
          <div class="card-icon">üí¨</div>
          <div class="card-title-group">
            <div class="card-title">Spill Zone</div>
            <div class="card-description">Curhat, ngeluh, atau cuma pengin ngomong ‚Äî no cap, no jaim.</div>
          </div>
        </div>
        <div class="card-content" id="zone-spill-content"></div>
      </div>
    </div>

    <!-- HANGOUTS TAB -->
    <div id="tab-hangouts" class="tab-content">
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üíé</span>
          <span class="section-title">Hidden Gems</span>
          <span class="section-subtitle">Dikurasi admin</span>
        </div>
        <div class="section-content" id="hangouts-gems"></div>
      </div>

      <div class="section">
        <div class="section-header">
          <span class="section-icon">‚òï</span>
          <span class="section-title">WFH Cafe</span>
          <span class="section-subtitle">Produktif & nyaman</span>
        </div>
        <div class="section-content" id="hangouts-wfh"></div>
        <button class="add-btn" onclick="openAddHangout('wfh')">
          <span>+</span> Tambah WFH Cafe
        </button>
      </div>

      <div class="section">
        <div class="section-header">
          <span class="section-icon">üçú</span>
          <span class="section-title">Enak Under 10ribu</span>
          <span class="section-subtitle">Ramah kantong</span>
        </div>
        <div class="section-content" id="hangouts-food"></div>
        <button class="add-btn" onclick="openAddHangout('food')">
          <span>+</span> Tambah Tempat Makan
        </button>
      </div>
    </div>

    <div class="tagline">
      Ga perlu follower.<br>
      Cuma butuh sefrekuensi.<br>
      <strong>‚Äî Glitch Generation</strong>
    </div>
  </div>

  <!-- MODAL ADD HANGOUT -->
  <div id="modal-add" class="modal">
    <div class="modal-content">
      <div class="modal-header">Tambah Hangout Baru</div>
      <form id="form-hangout">
        <div class="form-group">
          <label class="form-label">Nama Tempat *</label>
          <input type="text" class="form-input" id="input-name" required 
                 placeholder="Contoh: Kopi Janji Jiwa">
        </div>
        <div class="form-group">
          <label class="form-label">Lokasi *</label>
          <input type="text" class="form-input" id="input-location" required 
                 placeholder="Contoh: Kemang, Jakarta Selatan">
        </div>
        <div class="form-group">
          <label class="form-label">Kategori *</label>
          <select class="form-select" id="input-category" required>
            <option value="wfh">‚òï WFH Cafe</option>
            <option value="food">üçú Enak Under 10ribu</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Catatan (opsional)</label>
          <textarea class="form-textarea" id="input-notes" 
                    placeholder="Ceritain kenapa tempat ini recommended...&#x0a;Contoh: Wifi kenceng, colokan banyak, suasana cozy buat meeting"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Batal</button>
          <button type="submit" class="btn btn-primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';

    let rantsDataCache = [];

    async function supabaseFetch(table, method = 'GET', body = null, filter = '') {
      const headers = {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      };

      let url = `${SUPABASE_URL}/rest/v1/${table}${filter}`;
      let options = { method, headers };
      if (body) options.body = JSON.stringify(body);

      const res = await fetch(url, options);
      if (!res.ok) {
        const errorText = await res.text();
        console.error(`‚ùå Gagal fetch ${table}:`, res.status, errorText);
        throw new Error(`HTTP ${res.status}`);
      }
      return await res.json();
    }

    const HYPE_KEYWORDS = ['v!', 'v!!!!', 'v', 'kpop', 'skz', 'txt', 'bts', 'seventeen', 'enhypen', 'drakor', 'k-drama', 'squid game', 'crash landing', 'kim seon ho', 'anime', 'naruto', 'demon slayer', 'one piece', 'gintama', 'au', 'alternate universe', 'ship', 'otp', 'stan', 'bias', 'maknae', 'comeback', 'music video', 'concert', 'lightstick', 'fanart'];
    const NGUSAHAIN_KEYWORDS = ['skripsi', 'tugas', 'deadline', 'sidang', 'wisuda', 'kuliah', 'jualan', 'thrifting', 'preloved', 'reselling', 'online shop', 'crypto', 'bitcoin', 'saham', 'investasi', 'passive income', 'freelance', 'coding', 'belajar', 'latihan', 'progres', 'hari ke-', 'untung', 'rugi', 'modal', 'omzet', 'usaha', 'bisnis', 'side hustle', 'ui/ux', 'figma', 'blender', 'photoshop', 'canva', 'skill'];
    const SPILL_KEYWORDS = ['capek', 'lelah', 'sendiri', 'hujan', 'nangis', 'sedih', 'putus asa', 'gabisa', 'gatau', 'kenapa ya', 'berat', 'beban', 'ngeluh', 'curhat', 'mental health', 'anxiety', 'depresi', 'overthinking', 'burnout', 'gaada yang ngerti', 'rasa', 'kosong', 'hampa', 'tertekan', 'pengen ilang', 'pengen ngilang', 'susah', 'buntu', 'mentok'];

    function detectZone(content) {
      const lower = content.toLowerCase();
      if (HYPE_KEYWORDS.some(kw => lower.includes(kw))) return 'hype';
      if (NGUSAHAIN_KEYWORDS.some(kw => lower.includes(kw))) return 'ngusahain';
      if (SPILL_KEYWORDS.some(kw => lower.includes(kw))) return 'spill';
      return 'spill';
    }

    const currentUser = localStorage.getItem('nope_username') || '@newglitch';
    document.getElementById('username-display').textContent = currentUser.replace(/^@/, '');

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.closest('.tab-btn').classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
    }

    async function saveReaction(rantId, emoji) {
      if (!rantId || !emoji) return;
      if (rantId.startsWith('dummy')) {
        triggerPulse();
        return;
      }
      const rant = rantsDataCache.find(r => r.id === rantId);
      if (rant && rant.username === currentUser.replace(/^@/, '')) return;

      try {
        const existing = await supabaseFetch('reactions', 'GET', null, 
          `?rant_id=eq.${rantId}&user_id=eq.${encodeURIComponent(currentUser)}&emoji=eq.${encodeURIComponent(emoji)}`
        );
        if (existing.length > 0) {
          await supabaseFetch('reactions', 'DELETE', null, 
            `?id=eq.${existing[0].id}`
          );
        } else {
          await supabaseFetch('reactions', 'POST', {
            rant_id: rantId,
            user_id: currentUser,
            emoji: emoji
          });
        }
        triggerPulse();
      } catch (e) {
        console.error('Gagal simpan reaksi:', e.message);
      }
    }

    async function loadArtefak() {
      try {
        const artefakData = await supabaseFetch('artefacts', 'GET', null, '?order=created_at.desc&limit=20');
        return artefakData || [];
      } catch (e) {
        console.warn('‚ö†Ô∏è Gagal muat artefak:', e.message);
        return [];
      }
    }

    function pickRandomArtefak(artefakList, count = 1) {
      const shuffled = [...artefakList].sort(() => 0.5 - Math.random());
      return shuffled.slice(0, count);
    }

    function injectArtefakIntoZones(zones, artefakList) {
      if (artefakList.length === 0) return zones;
      const randomArtefak = pickRandomArtefak(artefakList, 1)[0];
      const targetZone = ['hype', 'ngusahain', 'spill'][Math.floor(Math.random() * 3)];
      const artefakPost = {
        id: `artefak-${randomArtefak.id}`,
        username: randomArtefak.username,
        content: randomArtefak.notation || 'Tanpa keterangan',
        created_at: randomArtefak.created_at,
        is_artefak: true,
        image_url: randomArtefak.image_url
      };
      zones[targetZone].unshift(artefakPost);
      return zones;
    }

    function renderZone(zoneKey, posts, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';

      // ‚úÖ Batas ideal: 4 post per zona
      const limitedPosts = posts.slice(0, 4);

      limitedPosts.forEach(post => {
        const el = document.createElement('div');
        el.className = 'post-item';

        if (post.is_artefak) {
          const reactionEmojis = ['üëç', 'üò¢', 'ü§ó', 'üî•'];
          const reactionHtml = reactionEmojis.map(emoji => 
            `<span data-emoji="${emoji}">${emoji}</span>`
          ).join('');

          el.innerHTML = `
            <div class="artefak-container">
              <div class="notasi-with-reactions">
                <span class="post-notasi">${post.content || 'Tanpa keterangan'}</span>
                <div class="inline-reactions">${reactionHtml}</div>
              </div>
              <div class="image-wrapper">
                <img src="${post.image_url}" class="artefak-image" alt="Artefak"/>
                <span class="subtle-username">@${post.username}</span>
              </div>
            </div>
          `;
        } else {
          const reactionEmojis = ['üëç', 'üò¢', 'ü§ó', 'üî•'];
          const reactionHtml = reactionEmojis.map(emoji => 
            `<span data-emoji="${emoji}">${emoji}</span>`
          ).join('');

          el.innerHTML = `
            <div class="post-header">
              <span class="post-username">@${post.username}</span>
              <div class="post-reactions">${reactionHtml}</div>
            </div>
            <div class="post-content">${post.content}</div>
          `;
        }

        container.appendChild(el);

        if (post.username !== currentUser.replace(/^@/, '')) {
          el.querySelectorAll('.inline-reactions span, .post-reactions span').forEach(span => {
            span.onclick = (e) => {
              e.stopPropagation();
              saveReaction(post.id, span.getAttribute('data-emoji'));
              span.style.color = '#ff6b6b';
              span.style.transform = 'scale(1.3)';
              setTimeout(() => {
                span.style.color = '';
                span.style.transform = 'scale(1)';
              }, 300);
              triggerPulse();
            };
          });
        }
      });
    }

    // === SCROLL NAVIGATION ===
    let currentZone = '';
    function updateZoneIndicator() {
      const zones = [
        { id: 'zone-hype', label: 'Hype Haus' },
        { id: 'zone-ngusahain', label: 'Ngusahain' },
        { id: 'zone-spill', label: 'Spill Zone' }
      ];
      let newZone = '';
      let newLabel = '';

      for (const zone of zones) {
        const el = document.getElementById(zone.id);
        const rect = el.getBoundingClientRect();
        if (rect.top <= 200 && rect.bottom >= 100) {
          newZone = zone.id;
          newLabel = zone.label;
          break;
        }
      }

      if (newZone && newZone !== currentZone) {
        currentZone = newZone;
        const indicator = document.getElementById('zone-indicator');
        indicator.textContent = newLabel;
        indicator.style.opacity = '1';
        setTimeout(() => indicator.style.opacity = '0.7', 300);
        setTimeout(() => indicator.style.opacity = '0', 1500);

        // Highlight zone
        document.querySelectorAll('.zone-overlay').forEach(el => el.style.opacity = '0');
        const overlay = document.querySelector(`#${newZone} .zone-overlay`);
        if (overlay) {
          overlay.style.opacity = '1';
          setTimeout(() => overlay.style.opacity = '0', 800);
        }
      }
    }

    window.addEventListener('scroll', updateZoneIndicator);

    async function loadFeed() {
      try {
        const [rantsData, artefakData] = await Promise.all([
          supabaseFetch('rants', 'GET', null, '?order=created_at.desc&limit=100'),
          loadArtefak()
        ]);
        rantsDataCache = rantsData || [];
        const hype = [], ngusahain = [], spill = [];
        rantsDataCache.forEach(r => {
          const zone = detectZone(r.content);
          if (zone === 'hype') hype.push(r);
          else if (zone === 'ngusahain') ngusahain.push(r);
          else spill.push(r);
        });

        let zones = { hype, ngusahain, spill };
        zones = injectArtefakIntoZones(zones, artefakData);

        renderZone('hype', zones.hype, 'zone-hype-content');
        renderZone('ngusahain', zones.ngusahain, 'zone-ngusahain-content');
        renderZone('spill', zones.spill, 'zone-spill-content');
      } catch (e) {
        console.error('üí• Gagal muat feed:', e);
        renderZone('hype', [], 'zone-hype-content');
        renderZone('ngusahain', [], 'zone-ngusahain-content');
        renderZone('spill', [], 'zone-spill-content');
      }
    }

    async function loadHangouts() {
      try {
        const data = await supabaseFetch('hangouts', 'GET', null, '?order=created_at.desc');
        const gems = data.filter(h => h.category === 'gems');
        const wfh = data.filter(h => h.category === 'wfh');
        const food = data.filter(h => h.category === 'food');
        renderHangouts('gems', gems);
        renderHangouts('wfh', wfh);
        renderHangouts('food', food);
      } catch (e) {
        console.error('Gagal muat hangouts:', e);
      }
    }

    function renderHangouts(category, items) {
      const container = document.getElementById(`hangouts-${category}`);
      if (category === 'gems' && items.length === 0) {
        items = [{
          name: "CoffeeBeerian Ciragil",
          location: "Ciragil, Bandung",
          notes: "Naik Alphard atau sepeda lipat? Di sini, semua level sama. CoffeeBeerian bukan cuma kafe‚Äîini social lab yang berhasil. Solo flyer duduk di bar jadi magnet obrolan, barista cerita passion kayak ngobrol sahabat lama, dan nggak ada yang judge lo dari cara lo parkir.",
          username: "nope.admin",
          is_admin_curated: true
        }];
      }
      if (items.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìç</div>
            <div class="empty-state-text">Belum ada rekomendasi</div>
          </div>
        `;
      } else {
        container.innerHTML = items.map(item => `
          <div class="hangout-item">
            <div class="hangout-header">
              <div class="hangout-title">
                <div class="hangout-name">${item.name}</div>
                <div class="hangout-location">üìç ${item.location}</div>
              </div>
              ${item.is_admin_curated ? '<span class="hangout-badge">Admin</span>' : ''}
            </div>
            ${item.notes ? `<div class="hangout-notes">${item.notes}</div>` : ''}
            <div class="hangout-footer">
              <span class="hangout-author">oleh @${item.username}</span>
            </div>
          </div>
        `).join('');
      }
    }

    function openAddHangout(category) {
      document.getElementById('input-category').value = category;
      document.getElementById('modal-add').classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    function closeModal() {
      document.getElementById('modal-add').classList.remove('active');
      document.getElementById('form-hangout').reset();
      document.body.style.overflow = 'auto';
    }
    document.getElementById('form-hangout').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        await supabaseFetch('hangouts', 'POST', {
          name: document.getElementById('input-name').value,
          location: document.getElementById('input-location').value,
          category: document.getElementById('input-category').value,
          notes: document.getElementById('input-notes').value,
          username: currentUser,
          is_admin_curated: false
        });
        closeModal();
        loadHangouts();
        triggerPulse();
      } catch (e) {
        alert('Gagal menambahkan: ' + e.message);
      }
    });

    function navigateTo(page) {
      window.location.href = page;
    }
    function logout() {
      if (confirm('Yakin mau keluar?')) {
        localStorage.removeItem('nope_username');
        window.location.href = 'index.html';
      }
    }
    function triggerPulse() {
      const pulse = document.createElement('div');
      pulse.className = 'pulse-animation';
      document.body.appendChild(pulse);
      setTimeout(() => pulse.remove(), 1000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('nav-jejak').onclick = () => navigateTo('jejak.html');
      document.getElementById('nav-frekuensi').onclick = () => navigateTo('frekuensi.html');
      document.getElementById('nav-saynope').onclick = () => navigateTo('saynope.html');
      document.getElementById('nav-glitch').onclick = () => navigateTo('glitch.html');
      document.getElementById('settings-btn').onclick = logout;

      loadFeed();
      loadHangouts();
      setTimeout(triggerPulse, 300);
    });

    document.getElementById('modal-add').addEventListener('click', (e) => {
      if (e.target.id === 'modal-add') closeModal();
    });
  </script>
</body>
</html>
