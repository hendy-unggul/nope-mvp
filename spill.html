<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Spill ‚Äî JEJAK</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Share+Tech+Mono&family=Oswald:wght@700&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
<style>
/* ‚îÄ‚îÄ TOKENS ‚îÄ‚îÄ */
:root{--bg:#050505;--sf:#0a0a0a;--sfe:#111;--bd:#222;--tx:#fff;--txs:#666;--txm:#444;--ap:#ff3d00;--as:#00f0ff;--at:#ff006e;--aq:#39ff14;--ms:#ff9500;--mt:#39ff14;--mc:#00f0ff;--md:#8b5cf6;--gn:#39ff14;--war:#ff0040}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--tx);font-family:'Plus Jakarta Sans',system-ui,sans-serif;font-weight:500;font-size:15px;line-height:1.4;min-height:100vh;overflow-x:hidden;padding-bottom:100px}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.08'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;mix-blend-mode:overlay}
.w{max-width:480px;margin:0 auto;padding:0 16px}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header{padding:24px 0 16px;display:flex;justify-content:space-between;align-items:flex-start}
.logo{font-family:'Space Grotesk',sans-serif;font-size:44px;font-weight:700;letter-spacing:-3px;line-height:.85;cursor:default;text-transform:uppercase}
.logo span{color:var(--ap);font-family:'Oswald',sans-serif;font-weight:700}
.tagline{font-family:'Instrument Serif',serif;font-size:12px;color:var(--txs);font-style:italic;margin-top:6px;letter-spacing:.5px}
.top-right{display:flex;align-items:center;gap:10px;padding-top:4px}
.conn-dot{width:6px;height:6px;background:var(--aq);border-radius:0;animation:glitch 1.2s infinite;flex-shrink:0;box-shadow:0 0 10px var(--aq)}
@keyframes glitch{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.3;transform:scale(1.2)}}
.menu-trigger{width:36px;height:36px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;background:var(--sf);border:2px solid var(--bd);cursor:pointer;transition:all .15s}
.menu-trigger span{width:14px;height:2px;background:var(--tx);transition:all .2s}
.menu-trigger:hover{border-color:var(--ap);background:var(--sfe)}
.menu-trigger:hover span{background:var(--ap)}

/* ‚îÄ‚îÄ RADAR BRUTAL ‚îÄ‚îÄ */
.radar-wrap{position:relative;margin:0 -16px 28px;border-top:1px solid var(--bd);border-bottom:1px solid var(--bd);background:var(--sf)}
.radar-hero{width:100%;position:relative;background:linear-gradient(180deg,var(--sf) 0%,var(--bg) 100%);padding:0}
.radar-frame{position:relative;padding:20px;border:1px solid var(--bd);background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(57,255,20,.03) 2px,rgba(57,255,20,.03) 4px)}
.radar-frame::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--aq),transparent);opacity:.5}
.radar-frame::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--aq),transparent);opacity:.5}
.corner{position:absolute;width:20px;height:20px;border:2px solid var(--aq);opacity:.6}
.corner.tl{top:8px;left:8px;border-right:0;border-bottom:0}
.corner.tr{top:8px;right:8px;border-left:0;border-bottom:0}
.corner.bl{bottom:8px;left:8px;border-right:0;border-top:0}
.corner.br{bottom:8px;right:8px;border-left:0;border-top:0}
.radar-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--bd);background:var(--bg)}
.radar-label{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--aq);letter-spacing:3px;text-transform:uppercase;display:flex;align-items:center;gap:8px}
.radar-label::before{content:'';width:6px;height:6px;background:var(--aq);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.radar-status{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--txm);letter-spacing:1px}
.radar-container{position:relative;width:100%;aspect-ratio:1/1;overflow:hidden;background:radial-gradient(ellipse at center,#0a1a0a 0%,#050a05 50%,#020502 100%);box-shadow:inset 0 0 100px rgba(0,0,0,.9)}
.radar-grid{position:absolute;inset:0;opacity:.15;background-image:repeating-linear-gradient(0deg,rgba(57,255,20,.5) 0px,transparent 1px,transparent 20px),repeating-linear-gradient(90deg,rgba(57,255,20,.5) 0px,transparent 1px,transparent 20px)}
.radar-circles{position:absolute;inset:10%;border-radius:50%;border:1px solid rgba(57,255,20,.3)}
.radar-circles::before,.radar-circles::after{content:'';position:absolute;border-radius:50%;border:1px solid rgba(57,255,20,.2)}
.radar-circles::before{inset:25%}.radar-circles::after{inset:50%;border-color:rgba(57,255,20,.1)}
.radar-crosshair{position:absolute;inset:0;pointer-events:none;background:linear-gradient(90deg,transparent calc(50% - .5px),rgba(57,255,20,.2) calc(50% - .5px),rgba(57,255,20,.2) calc(50% + .5px),transparent calc(50% + .5px)),linear-gradient(0deg,transparent calc(50% - .5px),rgba(57,255,20,.2) calc(50% - .5px),rgba(57,255,20,.2) calc(50% + .5px),transparent calc(50% + .5px))}
.radar-canvas{position:absolute;inset:0;width:100%;height:100%;z-index:10;pointer-events:none}
#radarDots{position:absolute;inset:0;z-index:20}
.radar-dot{position:absolute;border-radius:50%;transform:translate(-50%,-50%);z-index:30;cursor:pointer;opacity:.4;transition:all .1s;box-shadow:0 0 10px currentColor}
.radar-dot:hover{transform:translate(-50%,-50%) scale(2.5);z-index:50;opacity:1}
.radar-dot.purple{background:#b026ff;color:#b026ff}.radar-dot.red{background:#ff0040;color:#ff0040}.radar-dot.ai{background:var(--gn);color:var(--gn)}
.radar-footer{display:flex;justify-content:space-between;align-items:center;padding:16px;border-top:1px solid var(--bd);background:var(--bg);gap:12px}
.quota-box{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--sf);border:1px solid var(--bd);flex:1}
.quota-num{font-family:'Share Tech Mono',monospace;color:var(--gn);font-size:28px;font-weight:700;line-height:1;text-shadow:0 0 20px rgba(57,255,20,.5);letter-spacing:-2px}
.quota-info{display:flex;flex-direction:column;gap:2px}
.quota-label{font-family:'Share Tech Mono',monospace;color:var(--txm);font-size:9px;text-transform:uppercase;letter-spacing:1px}
.quota-status{font-family:'Share Tech Mono',monospace;color:var(--gn);font-size:10px;letter-spacing:.5px}
.vibe-btn{font-family:'Oswald',sans-serif;font-weight:700;letter-spacing:1px;background:var(--ap);color:#000;border:none;padding:14px 20px;font-size:11px;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px));transition:all .15s;white-space:nowrap}
.vibe-btn:hover{background:var(--tx);transform:translate(-2px,-2px);box-shadow:4px 4px 0 var(--ap)}
.vibe-btn:active{transform:translate(0);box-shadow:none}

/* ‚îÄ‚îÄ SECTION DIVIDER ‚îÄ‚îÄ */
.shdr{display:flex;align-items:center;gap:12px;margin-bottom:20px;padding-bottom:12px;border-bottom:2px solid var(--bd)}
.stit{font-family:'Space Grotesk',sans-serif;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--tx)}
.sline{flex:1;height:1px;background:repeating-linear-gradient(90deg,var(--bd),var(--bd) 4px,transparent 4px,transparent 8px)}
.shdr-meta{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--txm);white-space:nowrap;letter-spacing:1px}

/* ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ */
.filter-wrap{margin-bottom:28px}
.filter-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.filter-label{font-family:'Space Grotesk',sans-serif;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--txs);display:flex;align-items:center;gap:8px}
.vibe-pct{color:var(--ap);font-family:'Share Tech Mono',monospace;font-size:16px}
.reset-btn{padding:8px 14px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;background:var(--sf);border:1px solid var(--bd);color:var(--txm);cursor:pointer;transition:all .15s;font-family:inherit}
.reset-btn:hover{border-color:var(--ap);color:var(--ap);background:var(--sfe)}
.vibe-slider{width:100%;height:2px;background:var(--bd);outline:none;-webkit-appearance:none;margin-bottom:12px;display:block}
.vibe-slider::-webkit-slider-thumb{-webkit-appearance:none;width:24px;height:24px;background:var(--ap);border:3px solid var(--bg);cursor:pointer;box-shadow:0 0 0 1px var(--ap),0 0 20px rgba(255,61,0,.5)}
.vibe-labels{display:flex;justify-content:space-between;font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--txm);text-transform:uppercase;letter-spacing:1px;margin-bottom:20px;font-weight:700}
.mood-filters{display:flex;flex-wrap:wrap;gap:8px}
.mood-btn{padding:10px 16px;background:var(--sf);border:1px solid var(--bd);color:var(--txs);font-family:'Space Grotesk',sans-serif;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;cursor:pointer;transition:all .15s}
.mood-btn.active{background:var(--ap);border-color:var(--ap);color:#000}
.mood-btn:hover:not(.active){border-color:var(--tx);color:var(--tx);transform:translateY(-2px)}

/* ‚îÄ‚îÄ SPILL CARDS ‚îÄ‚îÄ */
.content-area{min-height:160px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 0}
.content-area.has-content{padding:0;align-items:stretch;justify-content:flex-start}
.spinner{width:40px;height:40px;border:2px solid var(--bd);border-top-color:var(--ap);border-right-color:var(--ap);animation:sp 1s linear infinite;margin-bottom:16px}
@keyframes sp{to{transform:rotate(360deg)}}
.loading-text{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--txs);text-transform:uppercase;letter-spacing:2px;font-weight:700}
.spill-card{background:var(--sf);border:1px solid var(--bd);margin-bottom:16px;position:relative;animation:si .4s ease;transition:all .15s}
@keyframes si{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.spill-card:hover{border-color:var(--ap);transform:translateX(4px);box-shadow:-4px 0 0 var(--ap)}
.spill-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--bd);background:var(--bg)}
.spill-author{font-family:'Share Tech Mono',monospace;font-size:10px;font-weight:700;color:var(--txm);letter-spacing:1px;cursor:pointer;transition:color .15s}
.spill-author:hover{color:var(--ap)}
.spill-mood{font-family:'Space Grotesk',sans-serif;font-size:9px;font-weight:700;padding:6px 10px;border:1px solid currentColor;text-transform:uppercase;letter-spacing:1px}
.spill-mood.surviving{color:var(--ms)}.spill-mood.thriving{color:var(--mt)}.spill-mood.chaotic{color:var(--mc)}.spill-mood.doom{color:var(--md)}
.spill-content{padding:20px;font-size:15px;line-height:1.7;color:var(--tx);font-weight:400}
.spill-reactions{display:flex;align-items:center;padding:12px 16px;border-top:1px solid var(--bd);background:var(--bg);gap:8px;flex-wrap:wrap}
.reaction-btn{position:relative;display:flex;align-items:center;gap:6px;padding:8px 12px;background:var(--sf);border:1px solid var(--bd);cursor:pointer;transition:all .15s;font-family:inherit}
.reaction-btn:hover{border-color:var(--tx);transform:translateY(-2px);background:var(--sfe)}
.reaction-btn.reacted{border-color:var(--ap);background:var(--ap)}
.reaction-btn.reacted .reaction-count{color:#000}
.reaction-count{font-family:'Share Tech Mono',monospace;font-size:11px;font-weight:700;color:var(--txs);min-width:16px;text-align:center}
.new-spill-btn{display:flex;align-items:center;justify-content:center;gap:12px;width:100%;padding:16px;background:var(--sf);border:1px solid var(--bd);color:var(--txm);font-family:'Space Grotesk',sans-serif;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:2px;cursor:pointer;margin-top:12px;margin-bottom:40px;transition:all .15s}
.new-spill-btn:hover{border-color:var(--ap);color:var(--ap);background:var(--bg)}
.new-spill-btn:hover .nbtn-icon{transform:rotate(180deg)}
.nbtn-icon{transition:transform .3s;font-family:'Share Tech Mono',monospace}
.empty-state{padding:48px 24px;text-align:center;border:2px dashed var(--bd);background:var(--sf)}
.empty-icon{font-size:48px;margin-bottom:16px;display:block;animation:fl 3s ease-in-out infinite}
@keyframes fl{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.empty-text{font-family:'Instrument Serif',serif;font-size:20px;font-style:italic;color:var(--txs);margin-bottom:8px}
.empty-subtext{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--txm);text-transform:uppercase;letter-spacing:1px}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--tx);color:var(--bg);padding:12px 24px;font-size:12px;font-weight:700;z-index:10000;opacity:0;transition:all .3s;font-family:'Space Grotesk',sans-serif;text-transform:uppercase;letter-spacing:1px;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px))}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.error{background:var(--war);color:var(--tx)}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.98);z-index:20000;padding:16px;overflow-y:auto}
.modal.on{display:block}
.modal-box{max-width:480px;margin:40px auto 0;background:var(--sf);border:1px solid var(--bd);padding:32px;position:relative}
.modal-box::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--ap),var(--aq),var(--ap))}
.modal-tag{font-family:'Share Tech Mono',monospace;font-size:9px;font-weight:700;color:var(--ap);letter-spacing:3px;text-transform:uppercase;margin-bottom:12px;display:block}
.modal-title{font-family:'Space Grotesk',sans-serif;font-size:32px;font-weight:700;text-transform:uppercase;letter-spacing:-1px;margin-bottom:6px;line-height:1}
.modal-sub{font-family:'Instrument Serif',serif;font-size:14px;font-style:italic;color:var(--txs);margin-bottom:32px}
.gender-options{display:flex;gap:12px;margin-bottom:24px}
.gender-opt{flex:1;background:var(--bg);border:1px solid var(--bd);padding:28px 16px;text-align:center;cursor:pointer;transition:all .15s;position:relative}
.gender-opt:hover{border-color:var(--tx);transform:translateY(-4px)}
.gender-opt.selected{border-color:var(--ap);background:var(--sfe)}
.gender-opt.selected::after{content:'‚óÜ';position:absolute;top:12px;right:12px;color:var(--ap);font-size:12px}
.gender-icon{font-size:32px;margin-bottom:12px;display:block}
.gender-label{font-family:'Space Grotesk',sans-serif;font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:2px;margin-bottom:4px}
.gender-desc{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--txs);text-transform:uppercase;letter-spacing:1px}
.modal-note{background:var(--bg);border-left:3px solid var(--ap);padding:16px;margin-bottom:24px;font-size:11px;color:var(--txs);line-height:1.6;font-family:'Share Tech Mono',monospace}
.modal-note strong{color:var(--ap)}
.modal-confirm{width:100%;padding:16px;background:var(--ap);color:#000;border:none;font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:2px;cursor:pointer;transition:all .15s;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px))}
.modal-confirm:hover:not(:disabled){background:var(--tx);transform:translate(-2px,-2px);box-shadow:4px 4px 0 var(--ap)}
.modal-confirm:disabled{opacity:.3;cursor:not-allowed}
.upgrade-tag{color:var(--war)}.upgrade-title{color:var(--war)}
.timer-warn{background:var(--bg);border:1px solid var(--war);padding:24px;margin-bottom:24px;text-align:center;position:relative;overflow:hidden}
.timer-warn::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 10px,rgba(255,0,64,.05) 10px,rgba(255,0,64,.05) 20px)}
.timer-warn .big{font-family:'Share Tech Mono',monospace;font-size:56px;font-weight:700;color:var(--war);line-height:1;margin-bottom:8px;letter-spacing:-2px;text-shadow:0 0 20px rgba(255,0,64,.5)}
.timer-warn .small{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--txs);text-transform:uppercase;letter-spacing:2px;font-weight:700}
.pricing-grid{display:flex;flex-direction:column;gap:12px;margin-bottom:24px}
.pricing-card{background:var(--bg);border:1px solid var(--bd);padding:20px;cursor:pointer;transition:all .15s;position:relative;display:flex;align-items:center;gap:20px}
.pricing-card:hover{border-color:var(--ap);transform:translateX(8px)}
.pricing-card.selected{border-color:var(--ap);background:var(--sfe)}
.pricing-card.selected::after{content:'‚óÜ';position:absolute;top:16px;right:16px;color:var(--ap);font-size:14px}
.pricing-price{font-family:'Space Grotesk',sans-serif;font-size:28px;font-weight:700;color:var(--ap);line-height:1;margin-bottom:4px;letter-spacing:-1px}
.pricing-desc{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--txs);text-transform:uppercase;letter-spacing:1px}
.pricing-right{text-align:right;margin-left:auto}
.pricing-duration{font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:700;color:var(--tx);margin-bottom:4px;letter-spacing:1px}
.pricing-limit{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--gn);font-weight:700;text-transform:uppercase;letter-spacing:1px}
.pricing-total{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--txm);text-transform:uppercase;letter-spacing:1px}
.upgrade-actions{display:flex;gap:12px}
.upgrade-btn{flex:1;padding:16px;background:var(--ap);color:#000;border:none;font-family:'Space Grotesk',sans-serif;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:2px;cursor:pointer;transition:all .15s;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px))}
.upgrade-btn:hover:not(:disabled){background:var(--tx);transform:translate(-2px,-2px);box-shadow:4px 4px 0 var(--ap)}
.upgrade-btn:disabled{opacity:.3;cursor:not-allowed}
.upgrade-btn.sec{background:transparent;color:var(--txs);border:1px solid var(--bd);clip-path:none}
.upgrade-btn.sec:hover{background:var(--sfe);color:var(--tx);transform:none;box-shadow:none}

/* ‚îÄ‚îÄ CHAT ROOM BRUTAL ‚îÄ‚îÄ */
.chat-room{display:none;position:fixed;inset:0;background:var(--bg);z-index:20000;flex-direction:column}
.chat-room.on{display:flex}
.chat-header{padding:16px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center;background:var(--sf)}
.chat-id{display:flex;align-items:center;gap:12px}
.chat-label{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--aq);letter-spacing:2px;text-transform:uppercase}
.chat-anon{font-family:'Space Grotesk',sans-serif;font-size:14px;font-weight:700;color:var(--tx);letter-spacing:1px}
.chat-timer{font-family:'Share Tech Mono',monospace;font-size:16px;font-weight:700;color:var(--gn);background:var(--bg);padding:8px 16px;border:1px solid var(--bd);letter-spacing:2px;min-width:80px;text-align:center}
.chat-timer.warn{color:var(--war);border-color:var(--war);animation:pulse 1s infinite;background:rgba(255,0,64,.1)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.chat-close{width:40px;height:40px;background:var(--bg);border:1px solid var(--bd);color:var(--txs);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.chat-close:hover{border-color:var(--war);color:var(--war);background:var(--sfe)}
.chat-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px;background:var(--bg)}
.chat-msg{display:flex;flex-direction:column;max-width:85%;animation:msgIn .3s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.chat-msg.own{align-self:flex-end}.chat-msg.other{align-self:flex-start}
.chat-bubble{padding:16px;font-size:14px;line-height:1.6;word-wrap:break-word;position:relative}
.own .chat-bubble{background:var(--ap);color:#000;font-weight:600;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,12px 100%,0 calc(100% - 12px))}
.other .chat-bubble{background:var(--sf);color:var(--tx);border:1px solid var(--bd);clip-path:polygon(0 12px,12px 0,100% 0,100% calc(100% - 12px),calc(100% - 12px) 100%,0 100%)}
.chat-meta{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--txm);margin-top:6px;letter-spacing:1px;text-transform:uppercase}
.typing-message{background:var(--sf)!important;border:1px solid var(--bd)!important;padding:20px 24px!important;min-width:80px;clip-path:polygon(0 12px,12px 0,100% 0,100% calc(100% - 12px),calc(100% - 12px) 100%,0 100%)!important}
.typing-dots{display:flex;gap:6px;padding:4px 0}
.typing-dot{width:8px;height:8px;background:var(--aq);animation:tw 1.4s infinite}
.typing-dot:nth-child(2){animation-delay:.2s}.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes tw{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-6px);opacity:1}}
.typing-cursor{display:inline-block;width:2px;height:14px;background:var(--ap);margin-left:4px;animation:blink 1s infinite;vertical-align:middle}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
.distress-banner{display:none;padding:16px;background:var(--war);color:var(--tx);font-family:'Space Grotesk',sans-serif;font-size:11px;font-weight:700;text-align:center;letter-spacing:1px;text-transform:uppercase;animation:slideDown .3s ease}
.distress-banner.show{display:block}
@keyframes slideDown{from{transform:translateY(-100%)}to{transform:translateY(0)}}
.chat-input-area{padding:16px;border-top:1px solid var(--bd);display:flex;gap:12px;background:var(--sf)}
.chat-input{flex:1;background:var(--bg);border:1px solid var(--bd);color:var(--tx);padding:14px 18px;font-size:14px;font-family:inherit;-webkit-appearance:none;transition:all .15s;font-weight:500}
.chat-input:focus{outline:none;border-color:var(--ap);box-shadow:0 0 0 3px rgba(255,61,0,.1)}
.chat-send{background:var(--ap);color:#000;border:none;padding:0 24px;font-family:'Space Grotesk',sans-serif;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:2px;cursor:pointer;transition:all .15s;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px))}
.chat-send:hover{background:var(--tx)}
.chat-fifo{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--txm);text-align:center;padding:12px;background:var(--bg);border-top:1px solid var(--bd);text-transform:uppercase;letter-spacing:2px;font-weight:700}

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bnav{position:fixed;bottom:0;left:0;right:0;background:var(--sf);border-top:1px solid var(--bd);z-index:1000;padding-bottom:env(safe-area-inset-bottom)}
.bnav-c{max-width:480px;margin:0 auto;display:flex;justify-content:space-around;align-items:center;height:64px}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;height:100%;color:var(--txm);text-decoration:none;font-family:'Space Grotesk',sans-serif;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;transition:all .2s;position:relative;cursor:pointer;border-right:1px solid var(--bd)}
.ni:last-child{border-right:0}
.ni::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--ap);transform:scaleX(0);transition:transform .2s}
.ni:hover{color:var(--tx);background:var(--bg)}
.ni.act{color:var(--ap)}.ni.act::before{transform:scaleX(1)}
.nico{font-family:'Share Tech Mono',monospace;font-size:20px;line-height:1;font-weight:700}
</style>
<base target="_blank">
</head>
<body>

<!-- HEADER -->
<div class="w">
  <header>
    <div>
      <div class="logo">SP<span>‚úï</span>LL</div>
      <div class="tagline">siapa lagi ngerasain apa</div>
    </div>
    <div class="top-right">
      <div class="conn-dot"></div>
      <button class="menu-trigger" onclick="toggleMenu()"><span></span><span></span><span></span></button>
    </div>
  </header>
</div>

<!-- RADAR BRUTAL -->
<div class="radar-wrap">
  <div class="radar-hero">
    <div class="radar-frame">
      <div class="corner tl"></div><div class="corner tr"></div><div class="corner bl"></div><div class="corner br"></div>
      <div class="radar-header">
        <div class="radar-label">VIBE RADAR // ONLINE</div>
        <div class="radar-status">SYS: OK</div>
      </div>
      <div class="radar-container">
        <div class="radar-grid"></div>
        <div class="radar-circles"></div>
        <div class="radar-crosshair"></div>
        <canvas class="radar-canvas" id="radarCanvas"></canvas>
        <div id="radarDots"></div>
      </div>
      <div class="radar-footer">
        <div class="quota-box">
          <span class="quota-num" id="quotaBadge">24</span>
          <div class="quota-info">
            <span class="quota-label">ONLINE</span>
            <span class="quota-status">READY TO MATCH</span>
          </div>
        </div>
        <button class="vibe-btn" onclick="startVibeCheck()">‚¨° VIBE CHECK</button>
      </div>
    </div>
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="w">
  <!-- FILTER -->
  <div class="shdr" style="margin-top:28px">
    <span class="stit">Filter Vibe</span>
    <div class="sline"></div>
    <span class="shdr-meta">MATCH: 87%</span>
  </div>
  <div class="filter-wrap">
    <div class="filter-header">
      <span class="filter-label"><span class="vibe-pct" id="vibePct">87%</span> KESELARASAN</span>
      <button class="reset-btn" onclick="resetFilters()">RESET</button>
    </div>
    <input type="range" class="vibe-slider" id="vibeSlider" min="0" max="100" value="87" oninput="updateVibePct(this.value)">
    <div class="vibe-labels"><span>Homie Only</span><span>Semi-Selaras</span><span>Semua</span></div>
    <div class="mood-filters">
      <button class="mood-btn active" data-mood="all" onclick="filterMood(this)">SEMUA</button>
      <button class="mood-btn" data-mood="surviving" onclick="filterMood(this)">üòÆ‚Äçüí® SURVIVING</button>
      <button class="mood-btn" data-mood="thriving" onclick="filterMood(this)">‚ú® THRIVING</button>
      <button class="mood-btn" data-mood="chaotic" onclick="filterMood(this)">üåÄ CHAOTIC</button>
      <button class="mood-btn" data-mood="doom" onclick="filterMood(this)">üõå DOOM</button>
    </div>
  </div>

  <!-- SPILLS -->
  <div class="shdr">
    <span class="stit">Spill Terkini</span>
    <div class="sline"></div>
    <span class="shdr-meta">FIFO ‚Ä¢ AUTO</span>
  </div>
  <div class="content-area" id="contentArea">
    <div class="spinner"></div>
    <p class="loading-text">Nyeduh teh...</p>
  </div>
  <button class="new-spill-btn" onclick="refreshSpills()">
    <span class="nbtn-icon">‚Üª</span>
    <span>SEDUH TEH BARU</span>
  </button>
</div><!-- /.w -->

<!-- GENDER MODAL -->
<div class="modal" id="genderModal">
  <div class="modal-box">
    <span class="modal-tag">Vibe Check // Init</span>
    <div class="modal-title">Siapa Kamu?</div>
    <div class="modal-sub">pilih identitasmu untuk bertemu lawan jenis</div>
    <div class="gender-options">
      <div class="gender-opt" data-gender="male" onclick="selectGender('male')">
        <span class="gender-icon">‚ôÇ</span>
        <div class="gender-label">PRIA</div>
        <div class="gender-desc">akan bertemu cewek</div>
      </div>
      <div class="gender-opt" data-gender="female" onclick="selectGender('female')">
        <span class="gender-icon">‚ôÄ</span>
        <div class="gender-label">WANITA</div>
        <div class="gender-desc">akan bertemu cowok</div>
      </div>
    </div>
    <div class="modal-note"><strong>>> GRATIS 15 MENIT</strong><br>Sesi berakhir otomatis. Chat hanya disimpan selama sesi (FIFO 20 pesan).</div>
    <button class="modal-confirm" id="genderConfirm" onclick="confirmGender()" disabled>MULAI VIBE CHECK</button>
  </div>
</div>

<!-- UPGRADE MODAL -->
<div class="modal" id="upgradeModal">
  <div class="modal-box">
    <span class="modal-tag upgrade-tag">ALERT // Timeout</span>
    <div class="modal-title upgrade-title">WAKTU HABIS</div>
    <div class="modal-sub">lanjutkan obrolan dengan upgrade</div>
    <div class="timer-warn">
      <div class="big">15:00</div>
      <div class="small">SESI GRATIS SELESAI</div>
    </div>
    <div class="pricing-grid">
      <div class="pricing-card" data-plan="weekly" onclick="selectPlan('weekly')">
        <div><div class="pricing-price">10K</div><div class="pricing-desc">7 HARI</div></div>
        <div class="pricing-right"><div class="pricing-duration">2 JAM/HARI</div><div class="pricing-limit">14 JAM TOTAL</div><div class="pricing-total">1.428/JAM</div></div>
      </div>
      <div class="pricing-card" data-plan="monthly" onclick="selectPlan('monthly')">
        <div><div class="pricing-price">50K</div><div class="pricing-desc">30 HARI</div></div>
        <div class="pricing-right"><div class="pricing-duration">3 JAM/HARI</div><div class="pricing-limit">90 JAM TOTAL</div><div class="pricing-total">555/JAM</div></div>
      </div>
    </div>
    <div class="upgrade-actions">
      <button class="upgrade-btn" id="upgradeNow" onclick="upgradeNow()" disabled>UPGRADE</button>
      <button class="upgrade-btn sec" onclick="closeModal('upgradeModal')">NANTI AJA</button>
    </div>
  </div>
</div>

<!-- CHAT ROOM BRUTAL -->
<div class="chat-room" id="chatRoom">
  <div class="chat-header">
    <div class="chat-id">
      <span class="chat-label">ANON CHAT //</span>
      <span class="chat-anon">STRANGER_07</span>
    </div>
    <div class="chat-timer" id="chatTimer">15:00</div>
    <button class="chat-close" onclick="closeChat()">‚úï</button>
  </div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="distress-banner" id="distressBanner">ADA YANG BISA DIHUBUNGI MALAM INI? INTO THE LIGHT: 119 EXT 8</div>
  <div class="chat-input-area">
    <input type="text" class="chat-input" id="chatInput" placeholder="Ketik pesan..." maxlength="200">
    <button class="chat-send" onclick="sendMsg()">KIRIM</button>
  </div>
  <div class="chat-fifo">FIFO ‚Ä¢ MAKS 20 PESAN ‚Ä¢ CHAT DIHAPUS SETELAH SESI</div>
</div>

<div class="toast" id="toast"></div>

<!-- NAV -->
<nav class="bnav">
  <div class="bnav-c">
    <a href="jejak.html" class="ni"><span class="nico">‚ú¶</span><span>JEJAK</span></a>
    <a href="spill.html" class="ni act"><span class="nico">‚úï</span><span>SPILL</span></a>
    <a href="cocomeo.html" class="ni"><span class="nico">„Äú</span><span>COCOMEO</span></a>
    <a href="glitch.html" class="ni"><span class="nico">‚ö°</span><span>GLITCH</span></a>
  </div>
</nav>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let currentGender = null;
let chatPartner = null;
let timerInterval = null;
let chatTimeLeft = 900;
let selectedPlan = null;
let activeMood = 'all';
let radarInterval;
let userName = 'user';
let chatHistory = [];

// DATA KARAKTER (FALLBACK LOKAL)
const FEMALE_CHARS = ['beby.manis', 'strawberry.shortcake', 'pretty.sad', 'little.fairy', 'cinnamon.girl'];
const MALE_CHARS = ['si.badai', 'moon.child', 'si.kocak', 'si.pedas', 'abang.gaul'];

// DATA SPILLS
const USER_RANTS = [
  {id:1,author:'anon.kucing',mood:'surviving',content:'Hari ini gue nangis di angkot gegara liat kucing dipukul orang. Mental gue udah kayak kerupuk kena hujan.',reactions:{skull:42,cry:89,fire:12,upside:7}},
  {id:2,author:'sleepy.head',mood:'thriving',content:'akhirnya bisa tidur nyenyak semalaman setelah 3 minggu insomnia. makasih buat yang chat tadi malem.',reactions:{skull:23,cry:15,fire:67,upside:31}},
  {id:3,author:'chaos.queen',mood:'chaotic',content:'hari ini chaos abis! dari bangun tidur udah salah ambil kaki, sampe kantor lupa bawa laptop.',reactions:{skull:89,cry:23,fire:45,upside:78}},
  {id:4,author:'quiet.one',mood:'doom',content:'udah seminggu nggak keluar kamar. bukan karena sibuk. cuma nggak tau mau ngapain.',reactions:{skull:67,cry:112,fire:8,upside:34}}
];

const REACTION_EMOJI = {skull:'üíÄ',cry:'üò≠',fire:'üî•',upside:'üôÉ'};

const $ = id => document.getElementById(id);
const esc = t => {const d=document.createElement('div'); d.textContent=t; return d.innerHTML};

function toast(msg, isErr=false) {
  const t = $('toast');
  t.textContent = msg;
  t.className = 'toast' + (isErr ? ' error' : '');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function closeModal(id) { $(id).classList.remove('on'); }
function toggleMenu() { toast('Menu coming soon'); }
function updateVibePct(val) { $('vibePct').textContent = val+'%'; }

function filterMood(btn) {
  document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  activeMood = btn.dataset.mood;
  renderSpills();
}

function resetFilters() {
  $('vibeSlider').value = 87;
  updateVibePct(87);
  document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
  document.querySelector('.mood-btn[data-mood="all"]').classList.add('active');
  activeMood = 'all';
  renderSpills();
}

// ‚îÄ‚îÄ SPILLS ‚îÄ‚îÄ
function renderSpills() {
  const area = $('contentArea');
  const filtered = activeMood === 'all' ? USER_RANTS : USER_RANTS.filter(s => s.mood === activeMood);
  
  if (!filtered.length) {
    area.className = 'content-area';
    area.innerHTML = `<div class="empty-state"><span class="empty-icon">üçÉ</span><div class="empty-text">Belum ada spill dengan mood ini</div><div class="empty-subtext">Coba filter lain</div></div>`;
    return;
  }
  
  area.className = 'content-area has-content';
  area.innerHTML = filtered.map(s => `
    <article class="spill-card">
      <div class="spill-header">
        <span class="spill-author">@${esc(s.author)}</span>
        <span class="spill-mood ${s.mood}">${s.mood}</span>
      </div>
      <div class="spill-content">${esc(s.content)}</div>
      <div class="spill-reactions">
        ${Object.entries(REACTION_EMOJI).map(([k, em]) => `
          <button class="reaction-btn" onclick="react(this,${s.id},'${k}')">
            <span>${em}</span>
            <span class="reaction-count" id="rc-${s.id}-${k}">${s.reactions[k]}</span>
          </button>`).join('')}
      </div>
    </article>`).join('');
}

function react(btn, id, key) {
  const spill = USER_RANTS.find(s => s.id === id);
  if (!spill) return;
  const wasReacted = btn.classList.contains('reacted');
  document.querySelectorAll(`[id^="rc-${id}-"]`).forEach(el => el.closest('button').classList.remove('reacted'));
  wasReacted ? spill.reactions[key]-- : (spill.reactions[key]++, btn.classList.add('reacted'));
  Object.keys(spill.reactions).forEach(k => {
    const el = $(`rc-${id}-${k}`);
    if (el) el.textContent = spill.reactions[k];
  });
}

function refreshSpills() { renderSpills(); toast('Teh baru diseduh ‚òï'); }

// ‚îÄ‚îÄ RADAR ‚îÄ‚îÄ
let radarDots = [], radarAngle = 0, radarRAF = null;
const SWEEP_SPEED = Math.PI * 2 / (4 * 60);

function initRadar() {
  const canvas = $('radarCanvas');
  const hero = canvas.parentElement;
  function resize() { canvas.width = hero.offsetWidth; canvas.height = hero.offsetHeight; }
  resize();
  new ResizeObserver(resize).observe(hero);
  spawnDots();
  radarInterval = setInterval(() => {
    radarDots.forEach(d => {
      d.x = Math.max(5, Math.min(95, d.x + (Math.random() - .5) * 1.5));
      d.y = Math.max(5, Math.min(95, d.y + (Math.random() - .5) * 1.5));
    });
  }, 4000);
  $('quotaBadge').textContent = Math.floor(20 + Math.random() * 10);
  radarLoop(canvas);
}

function spawnDots() {
  const con = $('radarDots');
  con.innerHTML = '';
  radarDots = [];
  const total = 8 + Math.floor(Math.random() * 8);
  for (let i = 0; i < total + 3; i++) {
    const isAI = i >= total;
    const angle = Math.random() * Math.PI * 2;
    const dist = 10 + Math.random() * (isAI ? 70 : 80);
    const x = 50 + Math.cos(angle) * dist / 2;
    const y = 50 + Math.sin(angle) * dist / 2;
    const size = (isAI ? 10 : 8) + Math.floor(Math.random() * 8);
    const color = isAI ? '#39ff14' : (Math.random() > .5 ? '#b026ff' : '#ff0040');
    const d = document.createElement('div');
    d.className = 'radar-dot ' + (isAI ? 'ai' : (color === '#b026ff' ? 'purple' : 'red'));
    d.style.cssText = `left:${x}%;top:${y}%;width:${size}px;height:${size}px`;
    con.appendChild(d);
    radarDots.push({el:d, x, y, size, color, isAI, trail:0, trailDecay:0});
  }
}

function radarLoop(canvas) {
  const ctx = canvas.getContext('2d');
  function frame() {
    radarAngle = (radarAngle + SWEEP_SPEED) % (Math.PI * 2);
    const W = canvas.width, H = canvas.height, cx = W/2, cy = H/2;
    
    ctx.fillStyle = 'rgba(5,10,5,0.08)';
    ctx.fillRect(0,0,W,H);
    
    const steps = 60;
    for (let i = 0; i < steps; i++) {
      const a = radarAngle - (i/steps) * (Math.PI * .55);
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, Math.min(W,H) * .6, a, a + Math.PI/steps);
      ctx.closePath();
      ctx.fillStyle = `rgba(57,255,20,${(1-i/steps)*.15})`;
      ctx.fill();
    }
    
    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(radarAngle);
    const lg = ctx.createLinearGradient(0, 0, Math.min(W,H) * .52, 0);
    lg.addColorStop(0, 'rgba(57,255,20,0.8)');
    lg.addColorStop(1, 'rgba(57,255,20,0)');
    ctx.fillStyle = lg;
    ctx.fillRect(0, -1, Math.min(W,H) * .52, 2);
    ctx.restore();
    
    radarDots.forEach(d => {
      const px = d.x/100 * W, py = d.y/100 * H;
      const dx = px - cx, dy = py - cy;
      const dotAngle = (Math.atan2(dy, dx) + Math.PI * 2) % (Math.PI * 2);
      let diff = radarAngle - dotAngle;
      if (diff < 0) diff += Math.PI * 2;
      
      if (diff < SWEEP_SPEED * 2) { d.trail = 1.0; d.trailDecay = 0; }
      
      if (d.trail > 0) {
        d.trailDecay += .008;
        d.trail = Math.max(0, 1 - d.trailDecay * d.trailDecay * 2.5);
        const r = d.size * (1 + d.trail * 1.2);
        const col = d.color.replace('#','');
        const rc = parseInt(col.slice(0,2),16);
        const gc = parseInt(col.slice(2,4),16);
        const bc = parseInt(col.slice(4,6),16);
        const g = ctx.createRadialGradient(px, py, 0, px, py, r * 3.5);
        g.addColorStop(0, `rgba(${rc},${gc},${bc},${d.trail*.9})`);
        g.addColorStop(.3, `rgba(${rc},${gc},${bc},${d.trail*.4})`);
        g.addColorStop(1, `rgba(${rc},${gc},${bc},0)`);
        ctx.beginPath();
        ctx.arc(px, py, r * 3.5, 0, Math.PI * 2);
        ctx.fillStyle = g;
        ctx.fill();
        
        d.el.style.filter = `brightness(${1+d.trail*2}) drop-shadow(0 0 ${6+d.trail*18}px ${d.color})`;
        d.el.style.transform = `translate(-50%,-50%) scale(${1+d.trail*.8})`;
        d.el.style.opacity = `${.4+d.trail*.6}`;
      } else {
        d.el.style.filter = '';
        d.el.style.transform = '';
        d.el.style.opacity = '.4';
      }
    });
    
    radarRAF = requestAnimationFrame(frame);
  }
  radarRAF = requestAnimationFrame(frame);
}

// ‚îÄ‚îÄ VIBE CHECK ‚îÄ‚îÄ
function startVibeCheck() { $('genderModal').classList.add('on'); }

function selectGender(g) {
  document.querySelectorAll('.gender-opt').forEach(o => o.classList.remove('selected'));
  document.querySelector(`.gender-opt[data-gender="${g}"]`).classList.add('selected');
  currentGender = g;
  $('genderConfirm').disabled = false;
}

function confirmGender() {
  if (!currentGender) return;
  closeModal('genderModal');
  const n = prompt('Nama panggilan kamu:', 'user');
  if (n?.trim()) userName = n.trim();
  startChat();
}

// ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ
async function startChat() {
  chatHistory = [];
  $('chatMessages').innerHTML = '';
  $('distressBanner').classList.remove('show');
  $('chatRoom').classList.add('on');
  chatTimeLeft = 900;
  startTimer();
  
  const opp = currentGender === 'male' ? 'female' : 'male';
  const charList = opp === 'female' ? FEMALE_CHARS : MALE_CHARS;
  const randomName = charList[Math.floor(Math.random() * charList.length)];
  
  chatPartner = {
    name: randomName,
    shortName: randomName.split('.')[0],
    isAI: true,
    gender: opp
  };
  
  document.querySelector('.chat-anon').textContent = 'STRANGER_' + String(Math.floor(Math.random()*99)).padStart(2,'0');
  
  try {
    const greetingRes = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: 'START_CHAT',
        characterName: chatPartner.name,
        userName: userName,
        lastMessages: []
      })
    });
    
    if (!greetingRes.ok) throw new Error('Failed to get greeting');
    
    const greetingData = await greetingRes.json();
    addMsg(greetingData.reply, false);
    if (greetingData.distress) $('distressBanner').classList.add('show');
    
  } catch (error) {
    toast('Gagal mulai chat', true);
    $('chatRoom').classList.remove('on');
  }
}

function getLastMessages() {
  return chatHistory.slice(-10);
}

async function sendMsg() {
  const inp = $('chatInput');
  const text = inp.value.trim();
  if (!text || !chatPartner) return;
  
  addMsg(text, true);
  inp.value = '';
  
  const typingDiv = showTypingIndicator();
  
  try {
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: text,
        characterName: chatPartner.name,
        userName: userName,
        lastMessages: getLastMessages()
      })
    });
    
    if (!response.ok) throw new Error('API error');
    
    const data = await response.json();
    hideTypingIndicator(typingDiv);
    await typeMessage(data.reply);
    
    chatHistory.push({ role: 'user', content: text });
    chatHistory.push({ role: 'assistant', content: data.reply });
    
    if (data.distress === 'high' || data.distress === 'low') {
      $('distressBanner').classList.add('show');
    }
    
  } catch (error) {
    hideTypingIndicator(typingDiv);
    toast('Gagal kirim pesan', true);
    addMsg('*pesan gagal terkirim*', false);
  }
}

function addMsg(text, isOwn) {
  const el = document.createElement('div');
  el.className = 'chat-msg ' + (isOwn ? 'own' : 'other');
  const time = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
  el.innerHTML = `<div class="chat-bubble">${esc(text)}</div><div class="chat-meta">${time}</div>`;
  
  const msgs = $('chatMessages');
  msgs.appendChild(el);
  
  while (msgs.children.length > 20) msgs.removeChild(msgs.firstChild);
  msgs.scrollTop = msgs.scrollHeight;
}

function showTypingIndicator() {
  const div = document.createElement('div');
  div.className = 'chat-msg other typing-message';
  div.id = 'typing-' + Date.now();
  div.innerHTML = `<div class="chat-bubble typing-dots"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>`;
  $('chatMessages').appendChild(div);
  $('chatMessages').scrollTop = $('chatMessages').scrollHeight;
  return div;
}

function hideTypingIndicator(div) {
  if (div && div.parentNode) div.remove();
}

async function typeMessage(text) {
  const container = $('chatMessages');
  const msgDiv = document.createElement('div');
  msgDiv.className = 'chat-msg other';
  const bubbleDiv = document.createElement('div');
  bubbleDiv.className = 'chat-bubble';
  msgDiv.appendChild(bubbleDiv);
  container.appendChild(msgDiv);
  
  const cursor = document.createElement('span');
  cursor.className = 'typing-cursor';
  bubbleDiv.appendChild(cursor);
  
  let typed = '';
  for (let i = 0; i <= text.length; i++) {
    if (i < text.length) {
      typed += text[i];
      bubbleDiv.innerHTML = typed;
      bubbleDiv.appendChild(cursor);
      
      let delay = 40 + Math.random() * 80;
      if (text[i] === ',' || text[i] === ';') delay = 200;
      if (text[i] === '.' || text[i] === '?' || text[i] === '!') delay = 300;
      await sleep(delay);
    }
  }
  
  cursor.remove();
  
  const ts = document.createElement('div');
  ts.className = 'chat-meta';
  ts.textContent = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
  msgDiv.appendChild(ts);
  
  container.scrollTop = container.scrollHeight;
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ‚îÄ‚îÄ TIMER & UPGRADE ‚îÄ‚îÄ
function startTimer() {
  updateTimer();
  timerInterval = setInterval(() => {
    chatTimeLeft--;
    updateTimer();
    if (chatTimeLeft === 300) toast('‚ö†Ô∏è Sisa 5 menit! Upgrade untuk lanjut.');
    if (chatTimeLeft <= 0) endChat();
  }, 1000);
}

function updateTimer() {
  const m = Math.floor(chatTimeLeft / 60);
  const s = chatTimeLeft % 60;
  $('chatTimer').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  $('chatTimer').classList.toggle('warn', chatTimeLeft <= 300);
}

function endChat() {
  clearInterval(timerInterval);
  timerInterval = null;
  $('chatRoom').classList.remove('on');
  $('upgradeModal').classList.add('on');
}

function closeChat() {
  clearInterval(timerInterval);
  timerInterval = null;
  $('chatRoom').classList.remove('on');
  toast('üëã Sampai jumpa!');
}

function selectPlan(plan) {
  document.querySelectorAll('.pricing-card').forEach(c => c.classList.remove('selected'));
  document.querySelector(`.pricing-card[data-plan="${plan}"]`).classList.add('selected');
  selectedPlan = plan;
  $('upgradeNow').disabled = false;
}

function upgradeNow() {
  if (!selectedPlan) return;
  toast('üîÑ Memproses upgrade...');
  setTimeout(() => {
    toast('‚úÖ Upgrade berhasil!');
    closeModal('upgradeModal');
    if (chatPartner) {
      chatTimeLeft = selectedPlan === 'weekly' ? 7200 : 10800;
      $('chatRoom').classList.add('on');
      clearInterval(timerInterval);
      startTimer();
      addMsg('obrolan dilanjut!', false);
    }
  }, 1500);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', () => {
  initRadar();
  renderSpills();
  $('chatInput').addEventListener('keydown', e => { if (e.key === 'Enter') sendMsg(); });
  window.addEventListener('beforeunload', () => {
    clearInterval(radarInterval);
    clearInterval(timerInterval);
    if (radarRAF) cancelAnimationFrame(radarRAF);
  });
});
</script>
</body>
</html>
