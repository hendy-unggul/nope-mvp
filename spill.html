<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=no">
<title>Spill ‚Äî JEJAK</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0A0A0A;
  --sf:#141414;
  --sfl:#1E1E1E;
  --bd:#2A2A2A;
  --tx:#FFF;
  --txs:#888;
  --txm:#555;
  --ap:#FF4D00;
  --gn:#39FF14;
}
*{margin:0;padding:0;box-sizing:border-box}
body{
  background:var(--bg);
  color:var(--tx);
  font-family:'Plus Jakarta Sans',system-ui,sans-serif;
  min-height:100vh;
  padding-bottom:80px
}
.wrapper{
  max-width:480px;
  margin:0 auto;
  padding:24px 16px
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:32px;
  padding-bottom:16px;
  border-bottom:1px solid var(--bd)
}
.brand{
  display:flex;
  align-items:center;
  gap:12px
}
.brand-icon{
  font-size:32px
}
.brand-text{
  font-size:28px;
  font-weight:800;
  letter-spacing:-.02em;
  background:linear-gradient(135deg,var(--ap),#FF8A5C);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent
}
.header-actions{
  display:flex;
  align-items:center;
  gap:12px
}
.conn-dot{
  width:8px;
  height:8px;
  background:var(--gn);
  border-radius:50%;
  animation:blink 2s infinite;
  margin-right:8px
}
@keyframes blink{
  0%,100%{opacity:1}
  50%{opacity:.3}
}
.menu-trigger{
  width:32px;
  height:32px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:3px;
  background:transparent;
  border:none;
  cursor:pointer
}
.menu-trigger span{
  width:4px;
  height:4px;
  background:var(--tx);
  border-radius:50%;
  transition:all .2s
}
.menu-trigger:hover span{
  background:var(--ap)
}

/* RADAR */
.radar-hero{
  width:100%;
  aspect-ratio:1/1;
  margin-bottom:24px;
  border-radius:20px;
  overflow:hidden;
  border:2px solid var(--bd);
  position:relative;
  background:#000
}
.radar-container{
  position:relative;
  width:100%;
  height:100%;
  overflow:hidden;
  background:radial-gradient(circle at 30% 30%,#1A3A1A,#0A1A0A)
}
.radar-grid{
  position:absolute;
  inset:0;
  background-image:repeating-linear-gradient(0deg,var(--bd) 0px,transparent 1px,transparent 20px),repeating-linear-gradient(90deg,var(--bd) 0px,transparent 1px,transparent 20px);
  opacity:.3;
  animation:rscan 8s infinite linear
}
@keyframes rscan{
  to{transform:rotate(360deg)}
}
.radar-circles{
  position:absolute;
  inset:0;
  border-radius:50%;
  box-shadow:inset 0 0 0 2px var(--gn)
}
.radar-circles::before,.radar-circles::after{
  content:'';
  position:absolute;
  inset:25%;
  border-radius:50%;
  box-shadow:inset 0 0 0 2px var(--gn);
  opacity:.5
}
.radar-circles::after{
  inset:50%
}
.radar-line{
  position:absolute;
  top:50%;
  left:50%;
  width:50%;
  height:2px;
  background:linear-gradient(90deg,var(--gn),transparent);
  transform-origin:left;
  animation:rspin 4s infinite linear;
  opacity:.8;
  z-index:25;
  pointer-events:none
}
.radar-sweep{
  position:absolute;
  top:50%;
  left:50%;
  width:70%;
  height:70%;
  background:radial-gradient(circle at 0% 50%,rgba(57,255,20,.3),transparent 70%);
  transform-origin:left;
  animation:rspin 4s infinite linear;
  z-index:20;
  pointer-events:none;
  filter:blur(10px)
}
@keyframes rspin{
  to{transform:rotate(360deg)}
}
.radar-dot{
  position:absolute;
  border-radius:50%;
  transform:translate(-50%,-50%);
  animation:rdot 1.5s infinite ease-in-out;
  z-index:30;
  cursor:pointer;
  transition:all .2s;
  box-shadow:0 0 10px currentColor
}
.radar-dot:hover{
  transform:translate(-50%,-50%) scale(2);
  box-shadow:0 0 30px currentColor;
  z-index:50
}
.radar-dot.purple{
  background:#B026FF;
  box-shadow:0 0 15px #B026FF
}
.radar-dot.red{
  background:#FF3333;
  box-shadow:0 0 15px #FF3333
}
.radar-dot.ai{
  background:var(--gn);
  box-shadow:0 0 15px var(--gn);
  animation:rdot 2.5s infinite
}
@keyframes rdot{
  0%,100%{opacity:1;transform:translate(-50%,-50%) scale(1)}
  50%{opacity:.7;transform:translate(-50%,-50%) scale(.9)}
}
.radar-overlay{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  align-items:flex-start;
  z-index:10;
  pointer-events:none;
  padding:16px
}
.radar-title{
  font-size:24px;
  font-weight:800;
  text-transform:uppercase;
  color:#fff;
  text-shadow:2px 0 0 #FF3333,-2px 0 0 #B026FF,0 0 20px var(--gn);
  letter-spacing:4px;
  pointer-events:auto;
  background:rgba(0,0,0,.5);
  padding:4px 12px;
  border-radius:30px;
  border:1px solid var(--bd)
}
.quota-display{
  display:flex;
  align-items:center;
  gap:8px;
  background:rgba(0,0,0,.7);
  padding:4px 12px;
  border-radius:30px;
  border:1px solid var(--bd);
  font-size:12px;
  pointer-events:auto;
  margin-top:8px
}
.quota-badge{
  color:var(--gn);
  font-weight:700;
  font-size:18px
}
.quota-text{
  color:var(--txs);
  font-size:12px
}
.radar-guide{
  margin-top:12px;
  background:rgba(57,255,20,0.1);
  border-left:4px solid var(--gn);
  padding:8px 12px;
  border-radius:8px;
  pointer-events:auto;
  max-width:220px;
  animation:pulse-guide 2s infinite
}
@keyframes pulse-guide{
  0%,100%{opacity:0.8}
  50%{opacity:1;background:rgba(57,255,20,0.15)}
}
.guide-text{
  color:var(--gn);
  font-size:11px;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:0.5px
}
.vibe-check-btn{
  position:absolute;
  bottom:16px;
  right:16px;
  background:var(--ap);
  color:var(--bg);
  border:none;
  padding:12px 24px;
  font-size:14px;
  font-weight:700;
  text-transform:uppercase;
  cursor:pointer;
  border-radius:40px;
  transition:all .2s;
  z-index:30;
  box-shadow:0 0 20px rgba(255,77,0,.5);
  display:inline-flex;
  align-items:center;
  gap:8px
}
.vibe-check-btn:hover{
  background:var(--tx);
  color:var(--bg);
  transform:scale(1.05)
}

/* FILTER */
.filter-section{
  background:var(--sf);
  border:1px solid var(--bd);
  padding:20px;
  margin-bottom:24px;
  border-radius:20px
}
.filter-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px
}
.filter-title{
  font-size:14px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.05em;
  display:flex;
  align-items:center;
  gap:8px
}
.vibe-pct{
  color:var(--ap);
  font-weight:800
}
.reset-btn{
  background:transparent;
  border:1px solid var(--ap);
  color:var(--ap);
  padding:6px 12px;
  font-size:11px;
  font-weight:700;
  text-transform:uppercase;
  cursor:pointer;
  border-radius:30px;
  transition:all .2s
}
.reset-btn:hover{
  background:var(--ap);
  color:var(--bg)
}
.vibe-slider{
  width:100%;
  height:4px;
  background:var(--bd);
  outline:none;
  -webkit-appearance:none;
  margin-bottom:8px;
  display:block
}
.vibe-slider::-webkit-slider-thumb{
  -webkit-appearance:none;
  width:24px;
  height:24px;
  background:var(--ap);
  border:2px solid var(--tx);
  border-radius:50%;
  cursor:pointer
}
.vibe-labels{
  display:flex;
  justify-content:space-between;
  font-size:11px;
  color:var(--txm);
  text-transform:uppercase;
  margin-bottom:20px
}
.mood-filters{
  display:flex;
  flex-wrap:wrap;
  gap:8px
}
.mood-btn{
  padding:8px 16px;
  background:var(--sfl);
  border:1px solid var(--bd);
  color:var(--txs);
  font-size:12px;
  font-weight:600;
  text-transform:uppercase;
  cursor:pointer;
  border-radius:30px;
  transition:all .2s
}
.mood-btn.active{
  background:var(--ap);
  border-color:var(--ap);
  color:var(--bg)
}
.mood-btn:hover:not(.active){
  border-color:var(--tx)
}

/* CONTENT */
.content-area{
  min-height:300px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  border:2px dashed var(--bd);
  padding:40px;
  border-radius:20px;
  margin-bottom:24px
}
.content-area.has-content{
  border:none;
  padding:0;
  align-items:stretch;
  justify-content:flex-start
}
.spinner{
  width:48px;
  height:48px;
  border:3px solid var(--bd);
  border-top-color:var(--ap);
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin-bottom:16px
}
@keyframes spin{
  to{transform:rotate(360deg)}
}
.loading-text{
  color:var(--txs);
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.1em
}
.spill-card{
  background:var(--sf);
  border:1px solid var(--bd);
  padding:20px;
  border-radius:20px;
  animation:fadeIn .4s ease;
  margin-bottom:16px
}
@keyframes fadeIn{
  from{opacity:0;transform:translateY(20px)}
  to{opacity:1;transform:translateY(0)}
}
.spill-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
  padding-bottom:12px;
  border-bottom:1px solid var(--bd)
}
.spill-author{
  font-size:12px;
  font-weight:700;
  color:var(--txs);
  cursor:pointer;
  transition:color .2s
}
.spill-author:hover{
  color:var(--ap)
}
.spill-mood{
  font-size:10px;
  padding:4px 8px;
  border:1px solid currentColor;
  border-radius:30px;
  text-transform:uppercase
}
.spill-content{
  font-size:15px;
  line-height:1.6;
  margin-bottom:16px
}
.spill-reactions{
  display:flex;
  gap:6px;
  flex-wrap:nowrap;
  justify-content:space-between
}
.reaction-btn{
  display:flex;
  align-items:center;
  gap:4px;
  background:var(--sfl);
  border:1px solid var(--bd);
  color:var(--txs);
  padding:6px 10px;
  font-size:12px;
  cursor:pointer;
  transition:all .2s;
  border-radius:30px;
  flex:1;
  justify-content:center
}
.reaction-btn:hover,.reaction-btn.reacted{
  border-color:var(--ap);
  background:var(--ap);
  color:var(--bg);
  transform:scale(1.05)
}
.reaction-count{
  font-weight:600;
  font-size:11px;
  min-width:14px;
  text-align:center
}
.new-spill-btn{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  width:100%;
  padding:16px;
  background:transparent;
  border:2px solid var(--ap);
  color:var(--ap);
  font-size:14px;
  font-weight:700;
  text-transform:uppercase;
  cursor:pointer;
  margin-top:24px;
  margin-bottom:32px;
  border-radius:40px;
  transition:all .2s
}
.new-spill-btn:hover{
  background:var(--ap);
  color:var(--bg)
}
.empty-state{
  text-align:center;
  padding:40px
}
.empty-icon{
  font-size:48px;
  margin-bottom:16px;
  opacity:.5
}
.empty-text{
  color:var(--txs);
  font-style:italic;
  margin-bottom:8px
}
.empty-subtext{
  color:var(--txm);
  font-size:12px
}

/* TOAST */
.toast{
  position:fixed;
  bottom:100px;
  left:50%;
  transform:translateX(-50%) translateY(100px);
  background:var(--tx);
  color:var(--bg);
  padding:12px 24px;
  font-size:13px;
  font-weight:600;
  border-radius:40px;
  z-index:10000;
  opacity:0;
  transition:all .3s;
  box-shadow:0 4px 20px rgba(0,0,0,.5)
}
.toast.show{
  opacity:1;
  transform:translateX(-50%) translateY(0)
}
.toast.error{
  background:#FF3333;
  color:var(--tx)
}

/* MODALS */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.98);
  z-index:20000;
  padding:20px;
  overflow-y:auto;
  backdrop-filter:blur(10px);
  align-items:center;
  justify-content:center
}
.modal.on{
  display:flex
}
.modal-box{
  max-width:480px;
  width:100%;
  background:var(--sf);
  border:3px solid var(--ap);
  padding:32px 24px;
  position:relative;
  box-shadow:10px 10px 0 var(--ap)
}
.modal-tag{
  position:absolute;
  top:-12px;
  left:20px;
  background:var(--sf);
  padding:0 10px;
  font-size:12px;
  font-weight:800;
  color:var(--ap);
  letter-spacing:2px
}
.modal-title{
  font-size:32px;
  font-weight:800;
  text-transform:uppercase;
  margin-bottom:8px;
  background:linear-gradient(135deg,var(--ap),#FF8A5C);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  text-align:center
}
.modal-sub{
  color:var(--txs);
  font-size:14px;
  margin-bottom:32px;
  text-align:center;
  font-style:italic
}
.gender-options{
  display:flex;
  gap:16px;
  margin-bottom:32px
}
.gender-opt{
  flex:1;
  background:var(--sfl);
  border:3px solid var(--bd);
  padding:24px 16px;
  text-align:center;
  cursor:pointer;
  transition:all .2s;
  position:relative
}
.gender-opt:hover{
  border-color:var(--ap);
  transform:translateY(-4px)
}
.gender-opt.selected{
  border-color:var(--ap);
  background:linear-gradient(145deg,var(--sfl),#2A2A2A)
}
.gender-opt.selected::after{
  content:'‚úì';
  position:absolute;
  top:8px;
  right:8px;
  color:var(--ap);
  font-weight:800
}
.gender-icon{
  font-size:48px;
  margin-bottom:12px;
  display:block
}
.gender-label{
  font-size:18px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:2px;
  margin-bottom:4px
}
.gender-desc{
  font-size:11px;
  color:var(--txs)
}
.modal-note{
  background:rgba(255,77,0,.1);
  border-left:4px solid var(--ap);
  padding:16px;
  margin-bottom:24px;
  font-size:13px;
  color:var(--txs)
}
.modal-note strong{
  color:var(--ap)
}
.modal-confirm{
  width:100%;
  padding:16px;
  background:var(--ap);
  color:var(--bg);
  border:none;
  font-size:16px;
  font-weight:800;
  text-transform:uppercase;
  cursor:pointer;
  transition:all .2s;
  box-shadow:6px 6px 0 var(--bg),6px 6px 0 2px var(--ap)
}
.modal-confirm:hover{
  transform:translate(3px,3px);
  box-shadow:3px 3px 0 var(--bg),3px 3px 0 2px var(--ap)
}
.modal-confirm:disabled{
  opacity:.5;
  cursor:not-allowed;
  transform:none;
  box-shadow:none
}

/* UPGRADE */
.upgrade-tag{
  color:#FF3333
}
.upgrade-title{
  background:linear-gradient(135deg,#FF3333,#FF8A5C);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent
}
.timer-warn{
  background:rgba(255,51,51,.1);
  border:2px solid #FF3333;
  padding:20px;
  margin-bottom:24px;
  text-align:center
}
.timer-warn .big{
  font-size:48px;
  font-weight:800;
  color:#FF3333;
  line-height:1;
  margin-bottom:8px
}
.timer-warn .small{
  font-size:12px;
  color:var(--txs);
  text-transform:uppercase;
  letter-spacing:2px
}
.pricing-grid{
  display:flex;
  flex-direction:column;
  gap:16px;
  margin-bottom:24px
}
.pricing-card{
  background:var(--sfl);
  border:3px solid var(--bd);
  padding:20px;
  cursor:pointer;
  transition:all .2s;
  position:relative;
  display:flex;
  align-items:center;
  gap:16px
}
.pricing-card:hover{
  border-color:var(--ap);
  transform:translateY(-2px)
}
.pricing-card.selected{
  border-color:var(--ap);
  background:linear-gradient(145deg,var(--sfl),#2A2A2A)
}
.pricing-card.selected::after{
  content:'‚úì';
  position:absolute;
  top:8px;
  right:8px;
  color:var(--ap);
  font-weight:800
}
.pricing-price{
  font-size:28px;
  font-weight:800;
  color:var(--ap);
  line-height:1;
  margin-bottom:4px
}
.pricing-desc{
  font-size:11px;
  color:var(--txs);
  text-transform:uppercase;
  letter-spacing:1px
}
.pricing-right{
  text-align:right
}
.pricing-duration{
  font-size:14px;
  font-weight:700;
  color:var(--tx);
  margin-bottom:4px
}
.pricing-limit{
  font-size:11px;
  color:var(--gn);
  background:rgba(57,255,20,.1);
  padding:2px 8px;
  border-radius:20px
}
.pricing-total{
  font-size:10px;
  color:var(--txm)
}
.upgrade-actions{
  display:flex;
  gap:12px
}
.upgrade-btn{
  flex:1;
  padding:16px;
  background:var(--ap);
  color:var(--bg);
  border:none;
  font-size:14px;
  font-weight:800;
  text-transform:uppercase;
  cursor:pointer;
  transition:all .2s;
  box-shadow:4px 4px 0 var(--bg),4px 4px 0 2px var(--ap)
}
.upgrade-btn:hover{
  transform:translate(2px,2px);
  box-shadow:2px 2px 0 var(--bg),2px 2px 0 2px var(--ap)
}
.upgrade-btn:disabled{
  opacity:.5;
  cursor:not-allowed;
  transform:none;
  box-shadow:none
}
.upgrade-btn.sec{
  background:transparent;
  color:var(--tx);
  border:2px solid var(--bd);
  box-shadow:none
}
.upgrade-btn.sec:hover{
  background:var(--sfl);
  transform:none;
  box-shadow:none
}

/* CHAT */
.chat-room{
  display:none;
  position:fixed;
  inset:0;
  background:var(--bg);
  z-index:20000;
  flex-direction:column
}
.chat-room.on{
  display:flex
}
.chat-header{
  padding:12px 16px;
  border-bottom:1px solid var(--bd);
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:var(--sf)
}
.chat-eyes{
  display:flex;
  gap:2px;
  align-items:center;
  height:32px
}
.eye-l,.eye-r{
  font-size:24px;
  display:inline-block;
  animation:glance 3s infinite ease-in-out
}
.eye-r{
  animation-delay:.2s
}
@keyframes glance{
  0%,100%{transform:translateX(0)}
  15%{transform:translateX(-2px)}
  30%{transform:translateX(2px)}
  45%{transform:translateX(-1px)}
  60%{transform:translateX(1px)}
  75%{transform:translateX(0)}
}
.chat-timer{
  font-size:16px;
  font-weight:600;
  font-family:'Courier New',monospace;
  color:var(--gn);
  background:var(--sfl);
  padding:4px 12px;
  border-radius:30px
}
.chat-timer.warn{
  color:#FF3333;
  animation:pulse 1s infinite
}
@keyframes pulse{
  0%,100%{opacity:1}
  50%{opacity:.5}
}
.chat-close{
  background:transparent;
  border:none;
  color:var(--txs);
  font-size:20px;
  cursor:pointer;
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:50%
}
.chat-close:hover{
  background:var(--sfl);
  color:var(--tx)
}
.chat-messages{
  flex:1;
  overflow-y:auto;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  background:var(--bg)
}
.chat-msg{
  display:flex;
  flex-direction:column;
  max-width:85%
}
.chat-msg.own{
  align-self:flex-end
}
.chat-msg.other{
  align-self:flex-start
}
.chat-bubble{
  padding:10px 14px;
  border-radius:18px;
  font-size:15px;
  line-height:1.5;
  word-wrap:break-word
}
.own .chat-bubble{
  background:var(--ap);
  color:var(--bg);
  border-bottom-right-radius:4px
}
.other .chat-bubble{
  background:var(--sf);
  color:var(--tx);
  border:1px solid var(--bd);
  border-bottom-left-radius:4px
}
.chat-meta{
  font-size:11px;
  color:var(--txm);
  margin:4px 8px 0
}
.typing{
  background:var(--sf)!important;
  border:1px solid var(--bd)!important;
  padding:12px 16px!important;
  display:flex;
  gap:4px
}
.dot-t{
  width:8px;
  height:8px;
  border-radius:50%;
  background:var(--txs);
  animation:typing 1.4s infinite
}
.dot-t:nth-child(2){
  animation-delay:.2s
}
.dot-t:nth-child(3){
  animation-delay:.4s
}
@keyframes typing{
  0%,60%,100%{transform:translateY(0);opacity:.6}
  30%{transform:translateY(-4px);opacity:1}
}
.chat-input-area{
  padding:12px 16px;
  border-top:1px solid var(--bd);
  display:flex;
  gap:8px;
  background:var(--sf)
}
.chat-input{
  flex:1;
  background:var(--bg);
  border:1px solid var(--bd);
  color:var(--tx);
  padding:12px 16px;
  font-size:16px;
  font-family:inherit;
  border-radius:24px;
  -webkit-appearance:none
}
.chat-input:focus{
  outline:none;
  border-color:var(--ap)
}
.chat-send{
  background:var(--ap);
  color:var(--bg);
  border:none;
  padding:0 20px;
  font-size:14px;
  font-weight:600;
  text-transform:uppercase;
  cursor:pointer;
  border-radius:24px;
  transition:all .2s
}
.chat-send:hover{
  background:var(--tx);
  color:var(--bg)
}
.chat-fifo{
  font-size:10px;
  color:var(--txm);
  text-align:center;
  padding:6px;
  background:var(--sf);
  border-top:1px solid var(--bd)
}

/* SEARCHING INDICATOR */
.searching-message{
  align-self:center!important;
  max-width:90%!important;
  margin:20px 0
}
.searching-message .chat-bubble{
  background:var(--sfl)!important;
  color:var(--txs)!important;
  border:1px dashed var(--gn)!important;
  font-style:italic;
  text-align:center;
  animation:pulse-search 2s infinite
}
@keyframes pulse-search{
  0%,100%{opacity:0.8}
  50%{opacity:1;border-color:var(--gn)}
}

/* TYPING CURSOR */
.typing-cursor{
  display:inline-block;
  width:2px;
  height:16px;
  background:var(--ap);
  margin-left:2px;
  animation:blink 1s infinite;
  vertical-align:middle
}
.thinking-message{
  background:var(--sf)!important;
  border:1px solid var(--bd)!important;
  padding:12px 16px!important;
  color:var(--txs);
  font-size:13px;
  font-style:italic
}
.typing-message{
  background:var(--sf)!important;
  border:1px solid var(--bd)!important;
  padding:12px 16px!important;
  min-width:60px
}
.typing-dots{
  display:flex;
  gap:4px;
  padding:4px 0
}
.typing-dot{
  width:8px;
  height:8px;
  background:var(--txs);
  border-radius:50%;
  animation:typing-wave 1.4s infinite
}
.typing-dot:nth-child(2){
  animation-delay:.2s
}
.typing-dot:nth-child(3){
  animation-delay:.4s
}
@keyframes typing-wave{
  0%,60%,100%{transform:translateY(0);opacity:.6}
  30%{transform:translateY(-6px);opacity:1}
}

/* DISTRESS BANNER */
.distress-banner{
  display:none;
  padding:10px 16px;
  background:rgba(255,51,51,.15);
  border-top:1px solid #FF3333;
  font-size:12px;
  color:#FF6666;
  text-align:center
}
.distress-banner.show{
  display:block
}

/* NAV */
.bottom-nav{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:var(--sf);
  border-top:2px solid var(--bd);
  z-index:1000
}
.nav-container{
  max-width:480px;
  margin:0 auto;
  display:flex;
  justify-content:space-around;
  align-items:center;
  height:70px
}
.nav-item{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  background:transparent;
  border:none;
  color:var(--txm);
  cursor:pointer;
  padding:8px 0;
  transition:all .2s;
  text-decoration:none;
  flex:1;
  font-size:12px;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:.05em
}
.nav-item.active{
  color:var(--ap)
}
.nav-item:hover{
  color:var(--tx)
}
.nav-icon{
  font-size:20px;
  margin-bottom:2px
}
</style>
</head>
<body>
<div class="wrapper">
  <header>
    <div class="brand">
      <span class="brand-icon">üçµ</span>
      <span class="brand-text">Spill</span>
    </div>
    <div class="header-actions">
      <div class="conn-dot"></div>
      <button class="menu-trigger" onclick="toggleMenu()"><span></span><span></span><span></span></button>
    </div>
  </header>

  <!-- RADAR HERO -->
  <section class="radar-hero">
    <div class="radar-container">
      <div class="radar-grid"></div>
      <div class="radar-circles"></div>
      <div class="radar-line"></div>
      <div class="radar-sweep"></div>
      <div id="radarDots"></div>
      
      <div class="radar-overlay">
        <div class="radar-title">VIBE RADAR</div>
        <div class="quota-display">
          <span class="quota-badge" id="quotaBadge">24</span>
          <span class="quota-text">couple online siap diajak ngobrol</span>
        </div>
        <div class="radar-guide">
          <span class="guide-text">‚ú® 15 menit cukup buat tahu kalian cocok</span>
        </div>
      </div>
      
      <button class="vibe-check-btn" onclick="startVibeCheck()">
        <span>‚ú®</span> Vibe Check
      </button>
    </div>
  </section>

  <div class="filter-section">
    <div class="filter-header">
      <span class="filter-title"><span class="vibe-pct" id="vibePct">87%</span><span>Keselarasan</span></span>
      <button class="reset-btn" onclick="resetFilters()">Reset</button>
    </div>
    <input type="range" class="vibe-slider" id="vibeSlider" min="0" max="100" value="87" oninput="updateVibePct(this.value)">
    <div class="vibe-labels"><span>Homie Only</span><span>Semi-Selaras</span><span>Semua</span></div>
    <div class="mood-filters">
      <button class="mood-btn active" data-mood="all" onclick="filterMood(this)">Semua</button>
      <button class="mood-btn" data-mood="surviving" onclick="filterMood(this)">üòÆ‚Äçüí® Surviving</button>
      <button class="mood-btn" data-mood="thriving" onclick="filterMood(this)">‚ú® Thriving</button>
      <button class="mood-btn" data-mood="chaotic" onclick="filterMood(this)">üåÄ Chaotic</button>
      <button class="mood-btn" data-mood="doom" onclick="filterMood(this)">üõå Doom</button>
    </div>
  </div>

  <div class="content-area" id="contentArea">
    <div class="spinner"></div>
    <p class="loading-text">Menyedu teh...</p>
  </div>

  <button class="new-spill-btn" onclick="refreshSpills()"><span>üîÑ</span><span>Seduh Teh Baru</span></button>
</div>

<!-- GENDER MODAL -->
<div class="modal" id="genderModal">
  <div class="modal-box">
    <div class="modal-tag">VIBE CHECK</div>
    <div class="modal-title">VIBE CHECK</div>
    <div class="modal-sub">pilih identitasmu untuk bertemu lawan jenis</div>
    <div class="gender-options">
      <div class="gender-opt" data-gender="male" onclick="selectGender('male')">
        <span class="gender-icon">‚ôÇÔ∏è</span>
        <div class="gender-label">PRIA</div>
        <div class="gender-desc">akan bertemu cewek</div>
      </div>
      <div class="gender-opt" data-gender="female" onclick="selectGender('female')">
        <span class="gender-icon">‚ôÄÔ∏è</span>
        <div class="gender-label">WANITA</div>
        <div class="gender-desc">akan bertemu cowok</div>
      </div>
    </div>
    <div class="modal-note"><strong>üîí GRATIS 15 MENIT</strong><br>Sesi berakhir otomatis. Chat hanya disimpan selama sesi (FIFO 20 pesan).</div>
    <button class="modal-confirm" id="genderConfirm" onclick="confirmGender()" disabled>Mulai Vibe Check</button>
  </div>
</div>

<!-- UPGRADE MODAL -->
<div class="modal" id="upgradeModal">
  <div class="modal-box">
    <div class="modal-tag upgrade-tag">WAKTU HABIS</div>
    <div class="modal-title upgrade-title">WAKTU HABIS</div>
    <div class="modal-sub">lanjutkan obrolan dengan upgrade</div>
    <div class="timer-warn">
      <div class="big">15:00</div>
      <div class="small">sesi gratis selesai</div>
    </div>
    <div class="pricing-grid">
      <div class="pricing-card" data-plan="weekly" onclick="selectPlan('weekly')">
        <div class="flex-1">
          <div class="pricing-price">Rp 10k</div>
          <div class="pricing-desc">7 hari</div>
        </div>
        <div class="pricing-right">
          <div class="pricing-duration">@ 2jam/hari</div>
          <div class="pricing-limit">14 jam total</div>
          <div class="pricing-total">Rp 1.428/jam</div>
        </div>
      </div>
      <div class="pricing-card" data-plan="monthly" onclick="selectPlan('monthly')">
        <div class="flex-1">
          <div class="pricing-price">Rp 50k</div>
          <div class="pricing-desc">30 hari</div>
        </div>
        <div class="pricing-right">
          <div class="pricing-duration">@ 3jam/hari</div>
          <div class="pricing-limit">90 jam total</div>
          <div class="pricing-total">Rp 555/jam</div>
        </div>
      </div>
    </div>
    <div class="upgrade-actions">
      <button class="upgrade-btn" id="upgradeNow" onclick="upgradeNow()" disabled>Upgrade</button>
      <button class="upgrade-btn sec" onclick="closeModal('upgradeModal')">Nanti aja</button>
    </div>
  </div>
</div>

<!-- CHAT ROOM -->
<div class="chat-room" id="chatRoom">
  <div class="chat-header">
    <div class="chat-eyes"><span class="eye-l">üëÄ</span><span class="eye-r">üëÄ</span></div>
    <div class="chat-timer" id="chatTimer">15:00</div>
    <button class="chat-close" onclick="closeChat()">‚úï</button>
  </div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="distress-banner" id="distressBanner">
    ada yang bisa dihubungi malam ini? Into The Light: 119 ext 8
  </div>
  <div class="chat-input-area">
    <input type="text" class="chat-input" id="chatInput" placeholder="Tulis pesan..." maxlength="200">
    <button class="chat-send" onclick="sendMsg()">Kirim</button>
  </div>
  <div class="chat-fifo">FIFO ‚Ä¢ maks 20 pesan ‚Ä¢ chat dihapus setelah sesi</div>
</div>

<div class="toast" id="toast"></div>

<nav class="bottom-nav">
  <div class="nav-container">
    <a href="jejak.html" class="nav-item"><span class="nav-icon">‚ú¶</span><span>Jejak</span></a>
    <a href="spill.html" class="nav-item active"><span class="nav-icon">‚úï</span><span>Spill</span></a>
    <a href="cocomeo.html" class="nav-item"><span class="nav-icon">„Äú</span><span>Cocomeo</span></a>
    <a href="glitch.html" class="nav-item"><span class="nav-icon">‚ö°</span><span>Glitch</span></a>
  </div>
</nav>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentGender = null, chatPartner = null;
let timerInterval = null, chatTimeLeft = 900; // 15 menit = 900 detik
let selectedPlan = null, activeMood = 'all', radarInterval, sweepInterval;

const AI_CHARS = {
  female: [
    {name:'beby.manis'},{name:'strawberry.shortcake'},
    {name:'pretty.sad'},{name:'little.fairy'},{name:'cinnamon.girl'}
  ],
  male: [
    {name:'si.badai'},{name:'moon.child'},
    {name:'si.kocak'},{name:'si.pedas'},{name:'mba.gaul'}
  ]
};

const DUMMY_SPILLS = [
  {id:1, author:'anon.kucing', mood:'surviving', content:'Hari ini gue nangis di angkot gegara liat kucing dipukul orang. Mental gue udah kayak kerupuk kena hujan.', reactions:{skull:42,cry:89,fire:12,upside:7}},
  {id:2, author:'sleepy.head', mood:'thriving',  content:'akhirnya bisa tidur nyenyak semalaman setelah 3 minggu insomnia. makasih buat yang chat tadi malem.', reactions:{skull:23,cry:15,fire:67,upside:31}},
  {id:3, author:'chaos.queen', mood:'chaotic',   content:'hari ini chaos abis! dari bangun tidur udah salah ambil kaki, sampe kantor lupa bawa laptop.', reactions:{skull:89,cry:23,fire:45,upside:78}},
  {id:4, author:'quiet.one',   mood:'doom',      content:'udah seminggu nggak keluar kamar. bukan karena sibuk. cuma nggak tau mau ngapain.', reactions:{skull:67,cry:112,fire:8,upside:34}},
];

const MOOD_COLOR = {surviving:'#FF9500',thriving:'#39FF14',chaotic:'#00F0FF',doom:'#8B5CF6'};
const REACTION_EMOJI = {skull:'üíÄ',cry:'üò≠',fire:'üî•',upside:'üôÉ'};

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const $  = id => document.getElementById(id);
const esc = t => { const d=document.createElement('div'); d.textContent=t; return d.innerHTML; };

function toast(msg, isErr=false) {
  const t=$('toast');
  t.textContent=msg;
  t.className='toast'+(isErr?' error':'');
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3000);
}

function closeModal(id) { $(id).classList.remove('on'); }
function toggleMenu()   { toast('Menu coming soon'); }

// ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateVibePct(val) { $('vibePct').textContent = val+'%'; }

function filterMood(btn) {
  document.querySelectorAll('.mood-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  activeMood = btn.dataset.mood;
  renderSpills();
}

function resetFilters() {
  $('vibeSlider').value = 87;
  updateVibePct(87);
  document.querySelectorAll('.mood-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector('.mood-btn[data-mood="all"]').classList.add('active');
  activeMood = 'all';
  renderSpills();
}

// ‚îÄ‚îÄ SPILLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSpills() {
  const area = $('contentArea');
  const filtered = activeMood === 'all'
    ? DUMMY_SPILLS
    : DUMMY_SPILLS.filter(s => s.mood === activeMood);

  if (!filtered.length) {
    area.className = 'content-area';
    area.innerHTML = `<div class="empty-state"><div class="empty-icon">üçÉ</div><div class="empty-text">Belum ada spill dengan mood ini</div><div class="empty-subtext">Coba filter lain</div></div>`;
    return;
  }

  area.className = 'content-area has-content';
  area.innerHTML = filtered.map(s => `
    <div class="spill-card">
      <div class="spill-header">
        <span class="spill-author">@${esc(s.author)}</span>
        <span class="spill-mood" style="color:${MOOD_COLOR[s.mood]}">${s.mood}</span>
      </div>
      <div class="spill-content">${esc(s.content)}</div>
      <div class="spill-reactions">
        ${Object.entries(REACTION_EMOJI).map(([k,em])=>`
          <button class="reaction-btn" onclick="react(this,${s.id},'${k}')">
            <span>${em}</span>
            <span class="reaction-count" id="rc-${s.id}-${k}">${s.reactions[k]}</span>
          </button>`).join('')}
      </div>
    </div>`).join('');
}

function react(btn, id, key) {
  const spill = DUMMY_SPILLS.find(s=>s.id===id);
  if (!spill) return;
  const wasReacted = btn.classList.contains('reacted');
  // Reset semua reaksi pada spill ini
  document.querySelectorAll(`[id^="rc-${id}-"]`).forEach(el => {
    const k = el.id.split('-')[3];
    el.closest('button').classList.remove('reacted');
  });
  if (!wasReacted) {
    spill.reactions[key]++;
    btn.classList.add('reacted');
  } else {
    spill.reactions[key]--;
  }
  Object.keys(spill.reactions).forEach(k => {
    const el = $(`rc-${id}-${k}`);
    if (el) el.textContent = spill.reactions[k];
  });
}

function refreshSpills() { renderSpills(); toast('Teh baru diseduh ‚òï'); }

// ‚îÄ‚îÄ RADAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initRadar() {
  genDots();
  radarInterval = setInterval(moveDots, 5000);
  sweepInterval = setInterval(sweepEffect, 50);
  
  // Set random couple online (20-30)
  document.getElementById('quotaBadge').textContent = Math.floor(20 + Math.random() * 10);
}

function genDots() {
  const con = $('radarDots');
  con.innerHTML = '';
  const total = 8 + Math.floor(Math.random()*8);
  for (let i=0; i<total+3; i++) {
    const isAI = i >= total;
    const angle = Math.random()*Math.PI*2;
    const dist  = 10 + Math.random()*(isAI?70:80);
    const x = 50 + Math.cos(angle)*dist/2;
    const y = 50 + Math.sin(angle)*dist/2;
    const size = (isAI?10:8) + Math.floor(Math.random()*8);
    const d = document.createElement('div');
    d.className = 'radar-dot ' + (isAI ? 'ai' : (Math.random()>.5?'purple':'red'));
    d.style.cssText = `left:${x}%;top:${y}%;width:${size}px;height:${size}px`;
    con.appendChild(d);
  }
}

function moveDots() {
  document.querySelectorAll('.radar-dot').forEach(d=>{
    let l=parseFloat(d.style.left), t=parseFloat(d.style.top);
    if(isNaN(l)||isNaN(t)) return;
    d.style.left = Math.max(5,Math.min(95,l+(Math.random()-.5)*3))+'%';
    d.style.top  = Math.max(5,Math.min(95,t+(Math.random()-.5)*3))+'%';
  });
}

function sweepEffect() {
  const angle = (Date.now()/150)%360;
  document.querySelectorAll('.radar-dot').forEach(d=>{
    const l=parseFloat(d.style.left), t=parseFloat(d.style.top);
    if(isNaN(l)||isNaN(t)) return;
    const da = (Math.atan2(t-50,l-50)*180/Math.PI+360)%360;
    let diff = Math.abs(da-angle); diff = Math.min(diff,360-diff);
    if(diff<35) {
      const i=1-(diff/35);
      d.style.filter=`brightness(${1+i}) drop-shadow(0 0 ${10+i*20}px currentColor)`;
      d.style.transform=`translate(-50%,-50%) scale(${1.2+i*.5})`;
    } else {
      d.style.filter=''; d.style.transform='';
    }
  });
}

// ‚îÄ‚îÄ VIBE CHECK FLOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startVibeCheck() { $('genderModal').classList.add('on'); }

function selectGender(g) {
  document.querySelectorAll('.gender-opt').forEach(o=>o.classList.remove('selected'));
  document.querySelector(`.gender-opt[data-gender="${g}"]`).classList.add('selected');
  currentGender = g;
  $('genderConfirm').disabled = false;
}

function confirmGender() {
  if(!currentGender) return;
  closeModal('genderModal');
  findRealUserFirst();
}

// ‚îÄ‚îÄ REAL USER PRIORITY + 1 MINUTE QUEUE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function findRealUserFirst() {
  // Tampilkan loading indicator di chat room
  $('chatMessages').innerHTML = '';
  $('distressBanner').classList.remove('show');
  $('chatRoom').classList.add('on');
  
  // Tampilkan pesan "mencari teman..."
  const searchingEl = document.createElement('div');
  searchingEl.className = 'chat-msg other searching-message';
  searchingEl.id = 'searching-indicator';
  searchingEl.innerHTML = `<div class="chat-bubble">üîç sedang dicarikan teman ngobrol...</div>`;
  $('chatMessages').appendChild(searchingEl);
  
  // Timer 1 menit (60 detik)
  let searchTimeLeft = 60;
  const searchTimer = setInterval(() => {
    searchTimeLeft--;
    const searchEl = $('searching-indicator');
    if (searchEl) {
      const bubble = searchEl.querySelector('.chat-bubble');
      if (bubble) {
        bubble.textContent = `üîç mencari teman... (${searchTimeLeft}s)`;
      }
    }
    
    if (searchTimeLeft <= 0) {
      clearInterval(searchTimer);
      // Jika 1 menit tidak dapat real user, fallback ke AI
      if ($('searching-indicator')) {
        $('searching-indicator').remove();
        fallbackToAI();
      }
    }
  }, 1000);
  
  // Simulasi cek real user (random 40% chance dapat dalam 1 menit)
  // Dalam implementasi nyata, ini akan cek ke database/socket
  const foundReal = Math.random() < 0.4; // 40% chance dapat real user
  
  if (foundReal) {
    // Dapat real user dalam waktu random (5-30 detik)
    const connectTime = 5000 + Math.random() * 25000;
    setTimeout(() => {
      clearInterval(searchTimer);
      if ($('searching-indicator')) {
        $('searching-indicator').remove();
        
        const oppGender = currentGender === 'male' ? 'female' : 'male';
        const names = oppGender === 'female' 
          ? ['jessica', 'amanda', 'sarah', 'diana', 'melanie']
          : ['kevin', 'brian', 'alex', 'steven', 'jordan'];
        
        chatPartner = {
          name: names[Math.floor(Math.random() * names.length)],
          isAI: false,
          gender: oppGender
        };
        
        // Lanjut ke chat
        startRealChat();
      }
    }, connectTime);
  }
  // Jika tidak dapat real user, akan fallback ke AI setelah 1 menit
  // (sudah di-handle oleh timer di atas)
}

function fallbackToAI() {
  const oppGender = currentGender === 'male' ? 'female' : 'male';
  const pool = AI_CHARS[oppGender];
  const char = pool[Math.floor(Math.random() * pool.length)];
  
  chatPartner = { 
    name: char.name, 
    isAI: true, 
    gender: oppGender 
  };
  
  toast('üí¨ Sementara ditemani AI dulu ya, real user sedang sibuk');
  startRealChat();
}

function startRealChat() {
  chatTimeLeft = 900; // 15 menit
  $('chatMessages').innerHTML = '';
  $('distressBanner').classList.remove('show');
  startTimer();
  
  const hour = new Date().getHours();
  const greets = hour<5  ? ['masih begadang? sama wkwk','eh belum tidur juga?'] :
                 hour<10 ? ['pagi, udah ngopi belom?','halo, baru bangun?'] :
                 hour<15 ? ['siang, udah makan?','eh lagi santai ga?'] :
                 hour<18 ? ['sore, capek ga?','lagi ngapain?'] :
                           ['malem, lagi santuy?','eh belum tidur?'];
  
  setTimeout(() => {
    const greeting = greets[Math.floor(Math.random()*greets.length)];
    addMsg(greeting, false);
  }, 800);
}

function closeChat() {
  clearInterval(timerInterval); timerInterval=null;
  $('chatRoom').classList.remove('on');
  toast('üëã Sampai jumpa!');
}

function startTimer() {
  updateTimer();
  timerInterval = setInterval(()=>{
    chatTimeLeft--;
    updateTimer();
    if(chatTimeLeft===300) toast('‚ö†Ô∏è Sisa 5 menit! Upgrade untuk lanjut.');
    if(chatTimeLeft<=0) endChat();
  }, 1000);
}

function updateTimer() {
  const m=Math.floor(chatTimeLeft/60), s=chatTimeLeft%60;
  $('chatTimer').textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  $('chatTimer').classList.toggle('warn', chatTimeLeft<=300);
}

function endChat() {
  clearInterval(timerInterval); timerInterval=null;
  $('chatRoom').classList.remove('on');
  $('upgradeModal').classList.add('on');
}

// ‚îÄ‚îÄ TYPING ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class TypingEngine {
  constructor() {
    this.isTyping = false;
  }

  async think(duration = null) {
    const thinkingTime = duration || (3000 + Math.random() * 4000);
    const thinkingEl = this.showThinking();
    await this.sleep(thinkingTime);
    thinkingEl.remove();
    return thinkingTime;
  }

  showThinking() {
    const el = document.createElement('div');
    el.className = 'chat-msg other thinking-message';
    el.innerHTML = `<div class="chat-bubble">...</div>`;
    $('chatMessages').appendChild(el);
    $('chatMessages').scrollTop = 9999;
    return el;
  }

  showTypingIndicator() {
    const el = document.createElement('div');
    el.className = 'chat-msg other typing-message';
    el.id = 'typing-indicator-real';
    el.innerHTML = `<div class="chat-bubble typing-dots"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>`;
    $('chatMessages').appendChild(el);
    $('chatMessages').scrollTop = 9999;
    return el;
  }

  async typeMessage(text) {
    const container = $('chatMessages');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'chat-msg other';
    
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'chat-bubble';
    msgDiv.appendChild(bubbleDiv);
    
    container.appendChild(msgDiv);
    
    const cursorSpan = document.createElement('span');
    cursorSpan.className = 'typing-cursor';
    bubbleDiv.appendChild(cursorSpan);
    
    let typed = '';
    const willTypo = Math.random() < 0.15;
    let typoIdx = -1, typoChar = '', typoFixed = false;
    
    if (willTypo) {
      typoIdx = Math.floor(Math.random() * (text.length / 2)) + 3;
      const chars = 'asdfghjklzxcvbnmqwertyuiop';
      typoChar = chars[Math.floor(Math.random() * chars.length)];
    }
    
    for (let i = 0; i <= text.length; i++) {
      if (willTypo && !typoFixed && i === typoIdx) {
        typed += typoChar;
        bubbleDiv.innerHTML = typed;
        cursorSpan.remove();
        bubbleDiv.appendChild(cursorSpan);
        await this.sleep(150 + Math.random() * 100);
        
        for (let b = 0; b < 2; b++) {
          typed = typed.slice(0, -1);
          bubbleDiv.innerHTML = typed;
          cursorSpan.remove();
          bubbleDiv.appendChild(cursorSpan);
          await this.sleep(100 + Math.random() * 50);
        }
        typoFixed = true;
        continue;
      }
      
      if (i < text.length) {
        typed += text[i];
        bubbleDiv.innerHTML = typed;
        cursorSpan.remove();
        bubbleDiv.appendChild(cursorSpan);
        
        let delay = 50 + Math.random() * 150;
        if (text[i] === ',' || text[i] === ';') delay = 300;
        if (text[i] === '.' || text[i] === '?' || text[i] === '!') delay = 500;
        
        await this.sleep(delay);
      }
    }
    
    cursorSpan.remove();
    
    const timeSpan = document.createElement('div');
    timeSpan.className = 'chat-meta';
    timeSpan.textContent = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
    msgDiv.appendChild(timeSpan);
    
    container.scrollTop = container.scrollHeight;
    return msgDiv;
  }

  sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
}

const typingEngine = new TypingEngine();

// ‚îÄ‚îÄ CHAT FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getHistory(n) {
  return [...$('chatMessages').querySelectorAll('.chat-msg:not(#typing-indicator-real)')]
    .slice(-n).map(el=>({
      role: el.classList.contains('own')?'user':'assistant',
      content: el.querySelector('.chat-bubble')?.textContent||''
    }));
}

async function sendMsg() {
  const inp=$('chatInput'), text=inp.value.trim();
  if(!text) return;
  addMsg(text, true);
  inp.value='';

  const delay = Math.min(3000, Math.max(800, text.length*120)) * (0.7+Math.random()*.6);
  
  const typingIndicator = typingEngine.showTypingIndicator();

  if(chatPartner?.isAI) {
    try {
      const res = await fetch('/api/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          message: text,
          characterName: chatPartner.name,
          userName: 'user',
          lastMessages: getHistory(8)
        })
      });
      const data = await res.json();
      
      setTimeout(async () => {
        typingIndicator.remove();
        if(data.reply) {
          await typingEngine.typeMessage(data.reply);
          if(data.distress==='high') {
            $('distressBanner').classList.add('show');
          }
        }
      }, delay);
    } catch(e) {
      setTimeout(async () => {
        typingIndicator.remove();
        await typingEngine.typeMessage('*koneksi putus sebentar*');
      }, delay);
    }
  } else {
    const replies=['haha iya nih','sama wkwk','eh gue juga','nggak nyangka lo jg','ya ampun relate'];
    setTimeout(async () => {
      typingIndicator.remove();
      if(Math.random()<.75) {
        await typingEngine.typeMessage(replies[Math.floor(Math.random()*replies.length)]);
      }
    }, delay);
  }
}

function addMsg(text, isOwn) {
  const el=document.createElement('div');
  el.className='chat-msg '+(isOwn?'own':'other');
  const time=new Date().toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'});
  el.innerHTML=`<div class="chat-bubble">${esc(text)}</div><div class="chat-meta">${time}</div>`;
  const msgs=$('chatMessages');
  msgs.appendChild(el);
  while(msgs.children.length>20) msgs.removeChild(msgs.firstChild);
  msgs.scrollTop=9999;
}

// ‚îÄ‚îÄ UPGRADE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectPlan(plan) {
  document.querySelectorAll('.pricing-card').forEach(c=>c.classList.remove('selected'));
  document.querySelector(`.pricing-card[data-plan="${plan}"]`).classList.add('selected');
  selectedPlan=plan;
  $('upgradeNow').disabled=false;
}

function upgradeNow() {
  if(!selectedPlan) return;
  toast('üîÑ Memproses upgrade...');
  setTimeout(()=>{
    toast('‚úÖ Upgrade berhasil!');
    closeModal('upgradeModal');
    if(chatPartner) {
      chatTimeLeft = selectedPlan==='weekly' ? 7200 : 10800;
      $('chatRoom').classList.add('on');
      clearInterval(timerInterval);
      startTimer();
      addMsg('obrolan dilanjut!', false);
    }
  }, 1500);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', ()=>{
  initRadar();
  renderSpills();

  $('chatInput').addEventListener('keydown', e=>{ if(e.key==='Enter') sendMsg(); });

  window.addEventListener('beforeunload', ()=>{
    clearInterval(radarInterval);
    clearInterval(sweepInterval);
    clearInterval(timerInterval);
  });
});
</script>
</body>
</html>
