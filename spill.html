<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>SPILL ‚Äî vibe radar</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#080808;--sf:#0f0f0f;--sfe:#141414;--bd:#222;--bd2:#2e2e2e;
  --tx:#f0ece6;--txs:#777;--txm:#444;
  --ap:#ff2d55;--as:#00e5ff;--aq:#bfff00;--gold:#ffd60a;--purple:#bf5af2;
  --ms:#ff9f0a;--mt:#bfff00;--mc:#00e5ff;--md:#bf5af2;
  --sb:env(safe-area-inset-bottom);--st:env(safe-area-inset-top);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--tx);font-family:'Syne',-apple-system,sans-serif;font-size:14px;line-height:1.4;position:fixed;width:100%;overscroll-behavior:none}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;opacity:.028;background:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E") 0 0/200px 200px}
.app{height:100%;display:flex;flex-direction:column;overflow:hidden}
/* HEADER */
.header{padding:14px 18px;padding-top:calc(14px + var(--st));display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--bd);background:var(--bg);flex-shrink:0;position:relative}
.header::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--ap),var(--as),var(--aq))}
.logo{font-family:'Bebas Neue',sans-serif;font-size:34px;letter-spacing:2px;line-height:1}
.logo .x{color:var(--ap);display:inline-block;animation:spin-x 4s ease-in-out infinite}
@keyframes spin-x{0%,90%,100%{transform:rotate(0) scale(1)}95%{transform:rotate(180deg) scale(1.2)}}
.online-pill{font-family:'DM Mono',monospace;font-size:10px;color:#000;background:var(--aq);padding:5px 12px;border:2px solid #000;box-shadow:3px 3px 0 #000;letter-spacing:.5px}
/* SCROLL */
.scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;overscroll-behavior-y:contain}
.scroll::-webkit-scrollbar{display:none}
/* RADAR */
.radar-sect{background:var(--sf);border-bottom:2px solid var(--bd)}
.radar-header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px 12px}
.radar-label{font-family:'DM Mono',monospace;font-size:10px;color:var(--as);letter-spacing:3px;text-transform:uppercase;display:flex;align-items:center;gap:8px}
.radar-label-dot{width:8px;height:8px;background:var(--as);transform:rotate(45deg);animation:blink-sq 1.2s step-end infinite}
@keyframes blink-sq{0%,100%{opacity:1;background:var(--as)}50%{opacity:.2;background:transparent}}
.radar-wrapper{padding:0 18px 16px}
.radar-bezel{position:relative;padding:4px;background:var(--bg);border:2px solid var(--bd2);box-shadow:6px 6px 0 #000}
.radar-bezel::before{content:'';position:absolute;top:-1px;left:-1px;width:20px;height:20px;border-top:3px solid var(--as);border-left:3px solid var(--as);z-index:5}
.radar-bezel::after{content:'';position:absolute;bottom:-1px;right:-1px;width:20px;height:20px;border-bottom:3px solid var(--ap);border-right:3px solid var(--ap);z-index:5}
.corner-tr{position:absolute;top:-1px;right:-1px;width:20px;height:20px;border-top:3px solid var(--aq);border-right:3px solid var(--aq);z-index:5}
.corner-bl{position:absolute;bottom:-1px;left:-1px;width:20px;height:20px;border-bottom:3px solid var(--gold);border-left:3px solid var(--gold);z-index:5}
.radar-bezel-label{position:absolute;top:-12px;left:30px;background:var(--bg);padding:0 8px;font-family:'DM Mono',monospace;font-size:8px;color:var(--txm);letter-spacing:3px;text-transform:uppercase;z-index:6}
.radar-bezel-range{position:absolute;bottom:-10px;right:30px;background:var(--bg);padding:0 8px;font-family:'DM Mono',monospace;font-size:8px;color:var(--txm);letter-spacing:2px;z-index:6}
.radar-cont{position:relative;width:100%;aspect-ratio:1/1;background:#020a02;overflow:hidden}
.radar-grid{position:absolute;inset:0;background-image:repeating-linear-gradient(0deg,rgba(0,229,255,.04)0px,transparent 1px,transparent 28px),repeating-linear-gradient(90deg,rgba(0,229,255,.04)0px,transparent 1px,transparent 28px)}
.radar-ring{position:absolute;inset:8%;border:1px solid rgba(0,229,255,.08);border-radius:50%}
.radar-ring::before{content:'';position:absolute;border-radius:50%;border:1px solid rgba(0,229,255,.05);inset:28%}
.radar-ring::after{content:'';position:absolute;border-radius:50%;border:1px solid rgba(0,229,255,.03);inset:54%}
.radar-cross{position:absolute;inset:0;background:linear-gradient(90deg,transparent calc(50% - .5px),rgba(0,229,255,.06) calc(50% - .5px),rgba(0,229,255,.06) calc(50% + .5px),transparent calc(50% + .5px)),linear-gradient(0deg,transparent calc(50% - .5px),rgba(0,229,255,.06) calc(50% - .5px),rgba(0,229,255,.06) calc(50% + .5px),transparent calc(50% + .5px))}
.radar-canvas{position:absolute;inset:0;width:100%;height:100%;z-index:5}
.radar-dots{position:absolute;inset:0;z-index:10}
.radar-dot{position:absolute;width:6px;height:6px;transform:translate(-50%,-50%) rotate(45deg);opacity:.3;will-change:transform,opacity;transition:opacity .1s}
.radar-dot.active{opacity:1;transform:translate(-50%,-50%) rotate(45deg) scale(2.5);filter:brightness(2) drop-shadow(0 0 6px currentColor)}
.radar-dot.purple{background:var(--purple);box-shadow:0 0 6px var(--purple)}
.radar-dot.red{background:var(--ap);box-shadow:0 0 6px var(--ap)}
.radar-dot.ai{background:var(--as);box-shadow:0 0 6px var(--as)}
.radar-dot.lime{background:var(--aq);box-shadow:0 0 6px var(--aq)}
/* RADAR CTAs */
.radar-ctas{padding:16px 18px 18px;display:flex;flex-direction:column;gap:10px}
.btn-vibe-check{width:100%;background:var(--ap);border:2px solid #000;padding:18px;font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:3px;color:#fff;cursor:pointer;box-shadow:5px 5px 0 #000;transition:transform .08s,box-shadow .08s;display:flex;align-items:center;justify-content:center;gap:12px;position:relative}
.btn-vibe-check:active{transform:translate(3px,3px);box-shadow:2px 2px 0 #000}
.btn-icon{font-size:20px}
.btn-chip{position:absolute;right:18px;background:#000;color:var(--aq);font-family:'DM Mono',monospace;font-size:9px;padding:4px 8px;letter-spacing:1px}
.btn-whisper{width:100%;background:transparent;border:2px dashed var(--bd2);padding:14px 18px;font-family:'Syne',sans-serif;font-size:13px;font-weight:600;color:var(--txs);cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:all .15s}
.btn-whisper:hover,.btn-whisper:active{border-color:var(--as);color:var(--as)}
.btn-whisper-left{display:flex;align-items:center;gap:10px}
.btn-whisper-glyph{font-size:16px;color:var(--as)}
.ws-new-badge{background:var(--as);color:#000;font-family:'DM Mono',monospace;font-size:9px;padding:3px 8px;display:none;animation:pulse-b 2s ease-in-out infinite}
.ws-new-badge.show{display:inline-block}
@keyframes pulse-b{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
/* FILTER */
.filter-sect{padding:18px;border-bottom:2px solid var(--bd)}
.filter-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.filter-title{font-family:'DM Mono',monospace;font-size:9px;color:var(--txs);letter-spacing:3px;text-transform:uppercase}
.match-pct{font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--ap);letter-spacing:1px;line-height:1}
.vibe-slider{width:100%;height:3px;background:var(--bd2);outline:none;-webkit-appearance:none;display:block;margin-bottom:8px}
.vibe-slider::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;background:var(--ap);border:3px solid var(--bg);border-radius:0;box-shadow:0 0 0 2px var(--ap),3px 3px 0 #000;margin-top:-9px;cursor:pointer}
.vibe-slider::-webkit-slider-runnable-track{height:3px;background:linear-gradient(90deg,var(--ap) 0%,var(--ap) 87%,var(--bd2) 87%)}
.slider-labels{display:flex;justify-content:space-between;font-family:'DM Mono',monospace;font-size:9px;color:var(--txm);margin:6px 0 16px;letter-spacing:1px}
.mood-scroll{display:flex;gap:8px;overflow-x:auto;margin:0 -18px;padding:0 18px 4px;scrollbar-width:none}
.mood-scroll::-webkit-scrollbar{display:none}
.mood-chip{flex-shrink:0;padding:8px 16px;background:var(--bg);border:2px solid var(--bd2);font-family:'DM Mono',monospace;font-size:11px;font-weight:500;color:var(--txs);white-space:nowrap;touch-action:manipulation;cursor:pointer;box-shadow:3px 3px 0 #000;transition:all .08s;letter-spacing:.5px}
.mood-chip.active{background:var(--ap);border-color:#000;color:#fff;box-shadow:3px 3px 0 rgba(0,0,0,.5)}
.mood-chip:active{transform:translate(2px,2px);box-shadow:1px 1px 0 #000}
/* SPILLS */
.spills-sect{padding:18px;padding-bottom:calc(90px + var(--sb))}
.sect-header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:16px}
.sect-title{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;line-height:1}
.sect-meta{font-family:'DM Mono',monospace;font-size:9px;color:var(--txm);letter-spacing:2px}
.spill-card{background:var(--sf);border:2px solid var(--bd2);margin-bottom:14px;overflow:hidden;box-shadow:4px 4px 0 #000;transition:transform .08s,box-shadow .08s}
.spill-card:active{transform:translate(2px,2px);box-shadow:2px 2px 0 #000}
.spill-head{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:2px solid var(--bd);background:var(--bg)}
.spill-user{font-family:'DM Mono',monospace;font-size:11px;color:var(--txs);letter-spacing:.5px}
.spill-mood{font-family:'DM Mono',monospace;font-size:9px;padding:5px 10px;text-transform:uppercase;letter-spacing:1.5px;border:2px solid}
.spill-mood.surviving{color:var(--ms);border-color:var(--ms);background:rgba(255,159,10,.08)}
.spill-mood.thriving{color:var(--mt);border-color:var(--mt);background:rgba(191,255,0,.08)}
.spill-mood.chaotic{color:var(--mc);border-color:var(--mc);background:rgba(0,229,255,.08)}
.spill-mood.doom{color:var(--md);border-color:var(--md);background:rgba(191,90,242,.08)}
.spill-body{padding:16px;font-size:15px;line-height:1.65}
.spill-actions{display:flex;border-top:2px solid var(--bd);overflow-x:auto;scrollbar-width:none;background:var(--bg)}
.spill-actions::-webkit-scrollbar{display:none}
.react-btn{flex:1;min-width:60px;display:flex;align-items:center;justify-content:center;gap:6px;padding:12px 8px;background:transparent;border:none;border-right:2px solid var(--bd);font-size:16px;color:var(--txs);cursor:pointer;touch-action:manipulation;transition:all .1s;font-family:'DM Mono',monospace}
.react-btn:last-child{border-right:none}
.react-btn.active{background:var(--ap);color:#fff}
.react-btn:active{background:var(--bd2)}
.react-count{font-family:'DM Mono',monospace;font-size:11px}
.refresh-btn{width:100%;padding:16px;background:transparent;border:2px dashed var(--bd2);color:var(--txs);font-family:'DM Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:10px;cursor:pointer;touch-action:manipulation;transition:all .15s}
.refresh-btn:active{background:var(--sf);border-color:var(--aq);color:var(--aq)}
.vt-dot-wrap{position:relative;width:12px;height:12px;flex-shrink:0}
.vt-dot-inner{width:8px;height:8px;background:var(--txm);position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(45deg);transition:all .5s}
.vt-dot-wrap.has-tap .vt-dot-inner{background:var(--aq);animation:vt-p 2s ease-in-out infinite;box-shadow:0 0 8px var(--aq)}
@keyframes vt-p{0%,100%{transform:translate(-50%,-50%) rotate(45deg) scale(1)}50%{transform:translate(-50%,-50%) rotate(45deg) scale(1.5)}}
/* BOTTOM NAV */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg);border-top:2px solid var(--bd);padding-bottom:env(safe-area-inset-bottom);z-index:100}
.nav-container{display:flex;justify-content:space-around;align-items:stretch;height:62px;max-width:480px;margin:0 auto}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;color:var(--txm);text-decoration:none;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;position:relative;touch-action:manipulation;border-right:2px solid var(--bd);transition:all .12s}
.nav-item:last-child{border-right:none}
.nav-item.active{color:var(--ap);background:rgba(255,45,85,.06)}
.nav-item.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:var(--ap)}
.nav-icon{font-size:20px;line-height:1}
/* MODALS */
.modal{display:none;position:fixed;inset:0;background:var(--bg);z-index:200;flex-direction:column;overflow:hidden}
.modal.on{display:flex}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:16px 18px;padding-top:calc(16px + var(--st));border-bottom:2px solid var(--bd)}
.modal-title{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px}
.modal-close{width:38px;height:38px;display:flex;align-items:center;justify-content:center;background:var(--sf);border:2px solid var(--bd2);color:var(--txs);font-size:16px;cursor:pointer;box-shadow:3px 3px 0 #000;transition:all .08s}
.modal-close:active{transform:translate(2px,2px);box-shadow:1px 1px 0 #000}
.modal-body{flex:1;overflow-y:auto;padding:24px 18px calc(24px + var(--sb));-webkit-overflow-scrolling:touch}
.modal-tag{font-family:'DM Mono',monospace;font-size:9px;color:var(--ap);margin-bottom:10px;letter-spacing:3px;display:block;text-transform:uppercase}
.modal-h{font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:1px;margin-bottom:8px;line-height:1.1}
.modal-sub{font-size:14px;color:var(--txs);margin-bottom:28px;line-height:1.6}
.gender-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px}
.gender-card{background:var(--sf);border:2px solid var(--bd2);padding:28px 16px;text-align:center;cursor:pointer;touch-action:manipulation;transition:all .08s;box-shadow:4px 4px 0 #000}
.gender-card.selected{border-color:var(--ap);background:rgba(255,45,85,.08);box-shadow:4px 4px 0 var(--ap)}
.gender-card:active{transform:translate(2px,2px);box-shadow:2px 2px 0 #000}
.gender-icon{font-size:36px;margin-bottom:12px;display:block}
.gender-label{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;margin-bottom:4px}
.gender-desc{font-size:12px;color:var(--txs)}
.info-box{background:var(--sf);border:2px solid var(--bd2);border-left:4px solid var(--ap);padding:16px;margin-bottom:28px}
.info-box p{font-family:'DM Mono',monospace;font-size:11px;color:var(--txs);line-height:1.8}
.info-box strong{color:var(--ap)}
.modal-action-btn{width:100%;padding:18px;background:var(--ap);color:#fff;border:2px solid #000;font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:3px;cursor:pointer;box-shadow:4px 4px 0 #000;transition:all .08s;text-transform:uppercase;margin-bottom:16px}
.modal-action-btn:disabled{opacity:.3;cursor:not-allowed;box-shadow:none}
.modal-action-btn:not(:disabled):active{transform:translate(3px,3px);box-shadow:2px 2px 0 #000}
.modal-action-btn.sec{background:var(--sf);color:var(--tx);border:2px solid var(--bd2);box-shadow:3px 3px 0 rgba(0,0,0,.5)}
.modal-hint{font-size:12px;color:var(--txm);text-align:center;line-height:1.6}
.modal-hint-link{background:none;border:none;color:var(--as);font-size:12px;font-weight:600;cursor:pointer;text-decoration:underline;font-family:inherit;padding:0}
/* UPGRADE */
.price-card{background:var(--sf);border:2px solid var(--bd2);padding:20px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;box-shadow:3px 3px 0 #000;transition:all .08s}
.price-card.selected{border-color:var(--aq);background:rgba(191,255,0,.05);box-shadow:4px 4px 0 var(--aq)}
.price-card:active{transform:translate(2px,2px);box-shadow:none}
.price-main{font-family:'Bebas Neue',sans-serif;font-size:32px;letter-spacing:1px;color:var(--aq)}
.price-sub{font-size:12px;color:var(--txs);font-family:'DM Mono',monospace}
.price-right{text-align:right}
.price-tag{font-family:'DM Mono',monospace;font-size:9px;color:#000;background:var(--aq);padding:3px 8px;letter-spacing:1px;display:inline-block;margin-bottom:4px}
.price-note{font-size:12px;color:var(--txs)}
.timer-big{text-align:center;padding:20px;margin-bottom:20px;border:2px solid var(--bd2);background:var(--sf);box-shadow:3px 3px 0 #000}
.timer-big .num{font-family:'Bebas Neue',sans-serif;font-size:42px;letter-spacing:4px;color:var(--ap)}
.timer-big .label{font-family:'DM Mono',monospace;font-size:9px;color:var(--txm);letter-spacing:3px;text-transform:uppercase}
/* CHAT - REVISED: tanpa username & timestamp */
.chat-room{display:none;position:fixed;inset:0;background:var(--bg);z-index:300;flex-direction:column}
.chat-room.on{display:flex}
.chat-head{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;padding-top:calc(12px + var(--st));border-bottom:2px solid var(--bd);background:var(--sf)}
.chat-info{flex:1;display:flex;align-items:center;gap:10px}
.eyes-container{display:flex;gap:6px;align-items:center}
.eye{width:26px;height:26px;background:var(--bd2);border:2px solid var(--bd);display:flex;align-items:center;justify-content:center;position:relative;animation:eyeM 3s ease-in-out infinite}
.eye::after{content:'';width:8px;height:8px;background:var(--as);position:absolute;animation:pupilM 3s ease-in-out infinite}
@keyframes eyeM{0%,100%{transform:translateX(0)}25%{transform:translateX(-2px)}75%{transform:translateX(2px)}}
@keyframes pupilM{0%,100%{transform:translate(0,0)}25%{transform:translate(-2px,-1px)}75%{transform:translate(2px,1px)}}
.partner-label{font-family:'DM Mono',monospace;font-size:10px;color:var(--txs);letter-spacing:1px}
.chat-timer{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;color:var(--aq);background:var(--bg);padding:8px 14px;border:2px solid var(--bd);box-shadow:3px 3px 0 #000}
.chat-timer.warn{color:var(--ap);border-color:var(--ap);animation:blink-w 1s step-end infinite;background:rgba(255,45,85,.08)}
@keyframes blink-w{0%,100%{opacity:1}50%{opacity:.5}}
.chat-close{width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:var(--bg);border:2px solid var(--bd);color:var(--txs);margin-left:12px;font-size:18px;cursor:pointer;box-shadow:3px 3px 0 #000;transition:all .08s}
.chat-close:active{transform:translate(2px,2px);box-shadow:none}
.chat-messages{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:12px;-webkit-overflow-scrolling:touch}
.chat-bubble{max-width:85%;padding:12px 16px;font-size:15px;line-height:1.55;word-wrap:break-word;border:2px solid;min-height:2.5em}
.chat-msg{display:flex;flex-direction:column;max-width:85%}
.chat-msg.own{align-self:flex-end}
.chat-msg.other{align-self:flex-start}
.chat-msg.system-msg{align-self:center!important;max-width:90%!important}
.own .chat-bubble{background:var(--ap);color:#fff;border-color:#000;box-shadow:3px 3px 0 #000;font-weight:600}
.other .chat-bubble{background:var(--sf);border-color:var(--bd2);box-shadow:3px 3px 0 rgba(0,0,0,.5)}
/* HAPUS TIMESTAMP - tidak ditampilkan */
.chat-time{display:none}
.typing{display:flex;gap:5px;padding:14px 18px;background:var(--sf);border:2px solid var(--bd2);align-self:flex-start;width:fit-content;box-shadow:3px 3px 0 rgba(0,0,0,.5)}
.typing-dot{width:7px;height:7px;background:var(--as);transform:rotate(45deg);animation:typi 1.4s infinite}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes typi{0%,60%,100%{transform:rotate(45deg) translateY(0)}30%{transform:rotate(45deg) translateY(-5px)}}
.distress{display:none;padding:12px 18px;background:var(--ap);color:#fff;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1px;text-align:center;border-bottom:2px solid #000}
.distress.show{display:block}
.reminder-msg .chat-bubble{background:var(--sfe)!important;border:2px dashed var(--as)!important;box-shadow:4px 4px 0 rgba(0,229,255,.2)!important}
/* POPUP WARNING 2 MENIT */
.warning-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg);border:3px solid var(--ap);padding:24px 32px;z-index:1000;box-shadow:8px 8px 0 #000;text-align:center;min-width:280px;animation:popIn .3s ease}
.warning-popup .title{font-family:'Bebas Neue',sans-serif;font-size:32px;color:var(--ap);letter-spacing:2px;margin-bottom:12px}
.warning-popup .msg{font-family:'DM Mono',monospace;font-size:14px;color:var(--tx);margin-bottom:20px;line-height:1.6}
.warning-popup .btn{background:var(--ap);color:#fff;border:2px solid #000;padding:12px 24px;font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;cursor:pointer;box-shadow:3px 3px 0 #000;margin-top:12px}
.warning-popup .btn:active{transform:translate(2px,2px);box-shadow:1px 1px 0 #000}
.chat-input-wrap{padding:12px 18px;padding-bottom:calc(12px + var(--sb));border-top:2px solid var(--bd);background:var(--sf);display:flex;gap:10px;align-items:center}
.vt-trigger{width:42px;height:48px;background:transparent;border:2px solid var(--bd2);color:var(--txm);display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;font-size:14px;transition:all .15s;font-family:'Bebas Neue',sans-serif}
.vt-trigger:hover{border-color:var(--as);color:var(--as)}
.chat-input{flex:1;background:var(--bg);border:2px solid var(--bd2);padding:13px 16px;font-size:15px;color:var(--tx);outline:none;-webkit-appearance:none;transition:border-color .15s;font-family:'Syne',sans-serif}
.chat-input:focus{border-color:var(--ap)}
.chat-send{width:48px;height:48px;background:var(--ap);border:2px solid #000;display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;flex-shrink:0;cursor:pointer;box-shadow:3px 3px 0 #000;transition:all .08s}
.chat-send:active{transform:translate(2px,2px);box-shadow:1px 1px 0 #000}
/* WHISPERER */
.ws-premium-lock{background:var(--sf);border:2px solid var(--bd2);padding:32px 20px;text-align:center;margin:20px 0;box-shadow:4px 4px 0 #000}
.ws-premium-lock .icon{font-size:48px;margin-bottom:12px;opacity:.5}
.ws-premium-lock .title{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:2px;margin-bottom:8px}
.ws-premium-lock .desc{font-size:13px;color:var(--txs);margin-bottom:20px;line-height:1.6}
.ws-premium-btn{background:var(--as);color:#000;border:2px solid #000;padding:14px 28px;font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;cursor:pointer;box-shadow:3px 3px 0 #000;transition:all .08s}
.ws-premium-btn:active{transform:translate(2px,2px);box-shadow:none}
.ws-inbox-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.ws-compose-btn{background:var(--as);color:#000;border:2px solid #000;padding:10px 16px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;cursor:pointer;box-shadow:3px 3px 0 #000;transition:all .08s}
.ws-compose-btn:active{transform:translate(2px,2px);box-shadow:none}
.ws-thread-item{background:var(--sf);border:2px solid var(--bd2);padding:14px 16px;margin-bottom:10px;display:flex;align-items:center;gap:12px;cursor:pointer;touch-action:manipulation;transition:all .08s;position:relative;box-shadow:3px 3px 0 #000}
.ws-thread-item:active{transform:translate(2px,2px);box-shadow:1px 1px 0 #000}
.ws-thread-item.unread{border-left:4px solid var(--as)}
.ws-avatar{width:40px;height:40px;background:var(--sfe);border:2px solid var(--bd2);display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:18px;color:var(--txs);flex-shrink:0}
.ws-thread-info{flex:1;min-width:0}
.ws-thread-name{font-family:'DM Mono',monospace;font-size:12px;font-weight:500;color:var(--tx);margin-bottom:3px}
.ws-thread-preview{font-size:11px;color:var(--txm);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ws-thread-right{display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0}
.ws-thread-time{font-family:'DM Mono',monospace;font-size:9px;color:var(--txm)}
.ws-unread-badge{min-width:20px;height:20px;background:var(--as);color:#000;font-family:'DM Mono',monospace;font-size:9px;display:flex;align-items:center;justify-content:center;padding:0 5px;border:1px solid #000}
/* SCREENS */
.ws-compose,.ws-thread-screen,.vt-compose{display:none;position:fixed;inset:0;background:var(--bg);z-index:350;flex-direction:column}
.ws-compose.on,.ws-thread-screen.on{display:flex}
.vt-compose{background:#050505;z-index:500;align-items:stretch;justify-content:center}
.vt-compose.on{display:flex;animation:vtF .2s ease}
@keyframes vtF{from{opacity:0}to{opacity:1}}
.ws-compose-head,.ws-thread-head{display:flex;align-items:center;gap:12px;padding:14px 18px;padding-top:calc(14px + var(--st));border-bottom:2px solid var(--bd);background:var(--sf)}
.ws-thread-head{padding:12px 18px;padding-top:calc(12px + var(--st))}
.ws-to-label{font-family:'DM Mono',monospace;font-size:10px;color:var(--txm);white-space:nowrap;letter-spacing:2px}
.ws-to-input{flex:1;background:transparent;border:none;border-bottom:2px solid var(--bd2);color:var(--tx);font-size:16px;font-family:'Syne',sans-serif;padding:4px 0;outline:none;transition:border-color .15s}
.ws-to-input:focus{border-bottom-color:var(--as)}
.ws-to-input::placeholder{color:var(--txm)}
.ws-close-btn,.ws-back-btn{width:36px;height:36px;background:var(--bg);border:2px solid var(--bd);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:3px 3px 0 #000;transition:all .08s;color:var(--txs);flex-shrink:0;font-size:16px;touch-action:manipulation}
.ws-back-btn{font-size:18px}
.ws-close-btn:active,.ws-back-btn:active{transform:translate(2px,2px);box-shadow:none}
.ws-body-ta{flex:1;background:transparent;border:none;color:var(--tx);font-family:'Syne',sans-serif;font-size:16px;line-height:1.7;resize:none;padding:20px 18px;outline:none}
.ws-body-ta::placeholder{color:var(--txm)}
.ws-compose-foot{padding:12px 18px;padding-bottom:calc(12px + var(--sb));border-top:2px solid var(--bd);background:var(--sf);display:flex;justify-content:space-between;align-items:center}
.ws-char-count{font-family:'DM Mono',monospace;font-size:10px;color:var(--txm)}
.ws-send-btn{background:var(--as);color:#000;border:2px solid #000;padding:12px 24px;font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;cursor:pointer;box-shadow:3px 3px 0 #000;transition:all .08s}
.ws-send-btn:active{transform:translate(2px,2px);box-shadow:none}
.ws-send-btn:disabled{opacity:.3;cursor:not-allowed;box-shadow:none}
.ws-thread-title{flex:1;font-family:'DM Mono',monospace;font-size:13px;font-weight:500;letter-spacing:.5px}
.ws-vt-btn{background:transparent;border:2px solid var(--bd2);color:var(--txm);width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-family:'Bebas Neue',sans-serif;font-size:14px;transition:all .15s;flex-shrink:0}
.ws-vt-btn:hover{border-color:var(--as);color:var(--as)}
.ws-thread-msgs{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:12px;-webkit-overflow-scrolling:touch}
.ws-thread-input-wrap{padding:12px 18px;padding-bottom:calc(12px + var(--sb));border-top:2px solid var(--bd);background:var(--sf);display:flex;gap:10px;align-items:center}
.ws-thread-input{flex:1;background:var(--bg);border:2px solid var(--bd2);padding:13px 16px;font-size:15px;color:var(--tx);outline:none;font-family:'Syne',sans-serif;transition:border-color .15s}
.ws-thread-input:focus{border-color:var(--as)}
.ws-thread-send{width:48px;height:48px;background:var(--as);border:2px solid #000;display:flex;align-items:center;justify-content:center;color:#000;font-size:20px;flex-shrink:0;cursor:pointer;touch-action:manipulation;box-shadow:3px 3px 0 rgba(0,229,255,.2);transition:all .08s}
.ws-thread-send:active{transform:translate(2px,2px);box-shadow:none}
/* VOID TAP */
.vt-compose-inner{max-width:480px;width:100%;margin:0 auto;padding:40px 24px;display:flex;flex-direction:column;gap:28px}
.vt-lbl{font-family:'DM Mono',monospace;font-size:9px;color:#1e1e1e;text-transform:uppercase;letter-spacing:.25em}
.vt-textarea{background:transparent;border:none;border-bottom:2px solid #1a1a1a;color:#555;font-family:'Syne',sans-serif;font-size:18px;line-height:1.7;resize:none;height:130px;outline:none;caret-color:#444;padding:8px 0}
.vt-textarea::placeholder{color:#1c1c1c}
.vt-textarea:focus{border-bottom-color:#2a2a2a}
.vt-meta{display:flex;justify-content:space-between;align-items:center}
.vt-quota{font-family:'DM Mono',monospace;font-size:10px;color:#222}
.vt-quota.low{color:#331111}
.vt-actions{display:flex;gap:8px}
.vt-cancel{background:transparent;border:2px solid #181818;color:#2a2a2a;padding:10px 18px;font-family:'DM Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:1px;cursor:pointer;transition:all .15s}
.vt-cancel:hover{border-color:#333;color:#555}
.vt-send{background:#0a0a0a;border:2px solid #1e1e1e;color:#333;padding:10px 22px;font-family:'DM Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:1px;cursor:pointer;transition:all .15s}
.vt-send:hover:not(:disabled){border-color:#333;color:#666}
.vt-send:disabled{opacity:.2;cursor:not-allowed}
.vt-reader{display:none;position:fixed;inset:0;background:#000;z-index:500;flex-direction:column;align-items:center;justify-content:center;user-select:none}
.vt-reader.on{display:flex;animation:vtF .2s ease}
.vt-reader-from{position:absolute;top:calc(52px + var(--st));left:50%;transform:translateX(-50%);font-family:'DM Mono',monospace;font-size:9px;color:#1a1a1a;text-transform:uppercase;letter-spacing:.25em;white-space:nowrap}
.vt-reader-msg{max-width:300px;padding:0 24px;text-align:center;color:#3d3d3d;font-family:'Syne',sans-serif;font-size:17px;line-height:1.8}
.vt-reader-timer{position:absolute;bottom:calc(52px + var(--sb));left:50%;transform:translateX(-50%);font-family:'DM Mono',monospace;font-size:9px;color:#1e1e1e;letter-spacing:.2em;text-transform:uppercase}
.vt-reader.burning .vt-reader-msg,.vt-reader.burning .vt-reader-timer,.vt-reader.burning .vt-reader-from{animation:vtBurn .7s ease forwards}
@keyframes vtBurn{0%{opacity:1;filter:none}50%{opacity:.4;filter:blur(2px)}100%{opacity:0;filter:blur(12px)}}
.vt-upgrade-nudge{display:none;position:fixed;bottom:calc(84px + var(--sb));left:50%;transform:translateX(-50%) translateY(16px);background:var(--sf);border:2px solid var(--bd2);padding:12px 20px;font-family:'DM Mono',monospace;font-size:11px;color:var(--txs);white-space:nowrap;z-index:400;opacity:0;transition:all .3s;cursor:pointer;box-shadow:3px 3px 0 #000}
.vt-upgrade-nudge.show{display:block;opacity:1;transform:translateX(-50%) translateY(0)}
.vt-upgrade-nudge b{color:var(--tx)}
/* TOAST */
.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--tx);color:var(--bg);padding:12px 22px;font-family:'DM Mono',monospace;font-size:12px;letter-spacing:.5px;z-index:600;opacity:0;transition:all .25s cubic-bezier(.175,.885,.32,1.275);pointer-events:none;white-space:nowrap;border:2px solid #000;box-shadow:4px 4px 0 #000}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.error{background:var(--ap);color:#fff}
.empty-state{text-align:center;padding:60px 20px}
.empty-icon{font-size:48px;margin-bottom:16px;opacity:.4;display:block}
.empty-title{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:1px;color:var(--txs);margin-bottom:6px}
.empty-text{font-size:13px;color:var(--txm)}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo">SP<span class="x">‚úï</span>LL</div>
    <span class="online-pill" id="onlineCount">21 ONLINE</span>
  </div>
  <div class="scroll">
    <div class="radar-sect">
      <div class="radar-header"><span class="radar-label"><span class="radar-label-dot"></span>VIBE RADAR</span></div>
      <div class="radar-wrapper">
        <div class="radar-bezel">
          <span class="corner-tr"></span><span class="corner-bl"></span>
          <span class="radar-bezel-label">VIBE RADAR ‚Äî SYS ACTIVE</span>
          <span class="radar-bezel-range">0.5km / 50km</span>
          <div class="radar-cont" id="radarCont">
            <div class="radar-grid"></div><div class="radar-ring"></div><div class="radar-cross"></div>
            <canvas class="radar-canvas" id="radarCanvas"></canvas>
            <div class="radar-dots" id="radarDots"></div>
          </div>
        </div>
      </div>
      <div class="radar-ctas">
        <button class="btn-vibe-check" onclick="startVibeCheck()"><span class="btn-icon">‚¨°</span><span>VIBE CHECK</span><span class="btn-chip">LIVE</span></button>
        <button class="btn-whisper" onclick="openWsModal()" id="wsStealthBtn">
          <div class="btn-whisper-left"><span class="btn-whisper-glyph">‚ú¶</span><span>WHISPERER</span></div>
          <span class="ws-new-badge" id="wsStealthBadge">NEW</span>
        </button>
      </div>
    </div>
    <div class="filter-sect">
      <div class="filter-top"><span class="filter-title">KESELARASAN</span><span class="match-pct" id="vibePct">87%</span></div>
      <input type="range" class="vibe-slider" id="vibeSlider" min="0" max="100" value="87" oninput="updateVibePct(this.value)">
      <div class="slider-labels"><span>HOMIE</span><span>SEMI</span><span>ALL</span></div>
      <div class="mood-scroll">
        <button class="mood-chip active" data-mood="all" onclick="filterMood(this)">SEMUA</button>
        <button class="mood-chip" data-mood="surviving" onclick="filterMood(this)">üòÆ‚Äçüí® SURVIVING</button>
        <button class="mood-chip" data-mood="thriving" onclick="filterMood(this)">‚ú® THRIVING</button>
        <button class="mood-chip" data-mood="chaotic" onclick="filterMood(this)">üåÄ CHAOTIC</button>
        <button class="mood-chip" data-mood="doom" onclick="filterMood(this)">üõå DOOM</button>
      </div>
    </div>
    <div class="spills-sect">
      <div class="sect-header"><span class="sect-title">SPILL TERKINI</span><span class="sect-meta">FIFO</span></div>
      <div id="spillsList"></div>
      <button class="refresh-btn" onclick="refreshSpills()">
        <div class="vt-dot-wrap" id="vtIndicator" onclick="event.stopPropagation();checkVoidTaps()"><div class="vt-dot-inner"></div></div>
        <span>‚Üª</span><span>SEDUH TEH BARU</span>
      </button>
    </div>
  </div>
  <nav class="bottom-nav">
    <div class="nav-container">
      <a href="spill.html" class="nav-item active"><span class="nav-icon">‚úï</span><span>SPILL</span></a>
      <a href="jejak.html" class="nav-item"><span class="nav-icon">‚ú¶</span><span>JEJAK</span></a>
      <a href="glitch.html" class="nav-item"><span class="nav-icon">‚ö°</span><span>GLITCH</span></a>
      <a href="cocomeo.html" class="nav-item"><span class="nav-icon">„Äú</span><span>COCOMEO</span></a>
    </div>
  </nav>
</div>

<!-- MODAL GENDER -->
<div class="modal" id="genderModal">
  <div class="modal-header"><div class="modal-title">PILIH GENDER</div><button class="modal-close" onclick="closeModal('genderModal')">‚úï</button></div>
  <div class="modal-body">
    <span class="modal-tag">STEP 1/2</span><div class="modal-h">VIBE CHECK BUTUH KONTEKS</div>
    <div class="modal-sub">biar algoritma bisa match kamu dengan vibe yang tepat</div>
    <div class="gender-grid">
      <div class="gender-card" onclick="selectGender(this,'female')"><span class="gender-icon">‚ôÄÔ∏è</span><span class="gender-label">CEWEK</span><span class="gender-desc">connect with similar vibes</span></div>
      <div class="gender-card" onclick="selectGender(this,'male')"><span class="gender-icon">‚ôÇÔ∏è</span><span class="gender-label">COWOK</span><span class="gender-desc">find your wavelength</span></div>
    </div>
    <div class="info-box">
      <p>üîí <strong>privacy first</strong> ‚Äî gender cuma dipakai buat matching sesi, ga disimpan & ga muncul di profil</p>
      <p style="margin-top:8px;color:var(--aq)">‚ö†Ô∏è <strong>Jangan pernah ungkap data pribadi ‚Äî stay safe, stay anonim</strong></p>
    </div>
    <button class="modal-action-btn" id="confirmGenderBtn" onclick="confirmGender()" disabled>GASKEUN ‚Üí</button>
    <div class="modal-hint">dengan lanjut, kamu setuju sama <button class="modal-hint-link" onclick="alert('kebijakan anonim: ga ada log, ga ada trace')">kebijakan anonim</button></div>
  </div>
</div>

<!-- MODAL UPGRADE -->
<div class="modal" id="upgradeModal">
  <div class="modal-header"><div class="modal-title">UPGRADE PLAN</div><button class="modal-close" onclick="closeModal('upgradeModal')">‚úï</button></div>
  <div class="modal-body">
    <span class="modal-tag">VIP ACCESS</span><div class="modal-h">PILIH PAKET</div>
    <div class="modal-sub">tinggal pilih, bayar via Midtrans, langsung aktif</div>
    <div class="price-card" onclick="selectPlan(this,'weekly')"><div><div class="price-main">Rp 10K</div><div class="price-sub">7 hari</div></div><div class="price-right"><span class="price-tag">BASIC</span><div class="price-note">‚úÖ chat tanpa batas</div></div></div>
    <div class="price-card" onclick="selectPlan(this,'monthly')"><div><div class="price-main">Rp 50K</div><div class="price-sub">30 hari</div></div><div class="price-right"><span class="price-tag">‚ú® PREMIUM</span><div class="price-note">‚úÖ chat tanpa batas + WHISPERER ‚ú¶</div></div></div>
    <div style="background:var(--sf);border:2px solid var(--bd2);padding:16px;margin:20px 0;box-shadow:3px 3px 0 #000">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px"><span style="color:var(--as);font-size:18px">‚ú¶</span><span style="font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px">WHISPERER (PREMIUM 50K)</span></div>
      <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--txs);line-height:1.9">‚Ä¢ ‚ú¶ pesan rahasia terenkripsi<br>‚Ä¢ ‚è≥ hilang dalam 5 detik setelah dibaca<br>‚Ä¢ üîí tidak ada log, tidak ada jejak<br>‚Ä¢ üí¨ chat tanpa batas</div>
    </div>
    <div class="timer-big"><div class="num">24:00:00</div><div class="label">OFFER BERAKHIR</div></div>
    <button class="modal-action-btn" onclick="processUpgrade()">UPGRADE SEKARANG</button>
    <button class="modal-action-btn sec" onclick="closeModal('upgradeModal')" style="margin-top:8px">NANTI DULU</button>
  </div>
</div>

<!-- CHAT ROOM - TANPA USERNAME & TIMESTAMP -->
<div class="chat-room" id="chatRoom">
  <div class="chat-head">
    <div class="chat-info"><div class="eyes-container"><div class="eye left"></div><div class="eye right"></div></div><span class="partner-label" id="partnerLabel">MENCARI...</span></div>
    <div class="chat-timer" id="chatTimer">15:00</div>
    <button class="chat-close" onclick="closeChat()">‚úï</button>
  </div>
  <div class="distress" id="distressMsg">‚ö†Ô∏è partner terdeteksi toxic ‚Äî tim sedang investigasi</div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input-wrap">
    <button class="vt-trigger" onclick="openVtCompose()" title="void tap">‚¨°</button>
    <input type="text" class="chat-input" id="chatInput" placeholder="ketik sesuatu..." maxlength="200">
    <button class="chat-send" onclick="sendMsg()">‚û§</button>
  </div>
</div>

<!-- WHISPERER MODAL -->
<div class="modal" id="wsModal">
  <div class="modal-header"><div class="modal-title">WHISPERER</div><button class="modal-close" onclick="closeModal('wsModal')">‚úï</button></div>
  <div class="modal-body" id="wsModalBody"></div>
</div>

<!-- WS COMPOSE -->
<div class="ws-compose" id="wsComposeScreen">
  <div class="ws-compose-head"><span class="ws-to-label">TO:</span><input type="text" class="ws-to-input" id="wsToInput" placeholder="username tujuan" maxlength="30"><button class="ws-close-btn" onclick="closeWsCompose()">‚úï</button></div>
  <textarea class="ws-body-ta" id="wsBodyInput" placeholder="tulis pesan rahasia... (akan hilang 5 detik setelah dibaca)" maxlength="200"></textarea>
  <div class="ws-compose-foot"><span class="ws-char-count" id="wsCharCount">0/200</span><button class="ws-send-btn" id="wsSendBtn" onclick="sendWs()" disabled>KIRIM</button></div>
</div>

<!-- WS THREAD -->
<div class="ws-thread-screen" id="wsThreadScreen">
  <div class="ws-thread-head"><button class="ws-back-btn" onclick="closeWsThread()">‚Üê</button><span class="ws-thread-title" id="wsThreadTitle">whisper</span><button class="ws-vt-btn" onclick="openVtCompose()">‚¨°</button></div>
  <div class="ws-thread-msgs" id="wsThreadMessages"></div>
  <div class="ws-thread-input-wrap"><input type="text" class="ws-thread-input" id="wsThreadInput" placeholder="balas whisper... (akan hilang)" maxlength="200"><button class="ws-thread-send" onclick="sendWsReply()">‚û§</button></div>
</div>

<!-- VOID TAP COMPOSE -->
<div class="vt-compose" id="vtCompose">
  <div class="vt-compose-inner">
    <span class="vt-lbl">VOID TAP ‚Äî pesan yang menghilang</span>
    <textarea class="vt-textarea" id="vtTextarea" placeholder="tulis sesuatu yang akan terbaca sekali & hilang..." maxlength="150"></textarea>
    <div class="vt-meta"><span class="vt-quota" id="vtQuota">sisa 3/3 hari ini</span><span class="vt-quota" id="vtCharCount">0/150</span></div>
    <div class="vt-actions"><button class="vt-cancel" onclick="closeVtCompose()">BATAL</button><button class="vt-send" id="vtSendBtn" onclick="sendVoidTap()" disabled>KIRIM</button></div>
  </div>
</div>

<!-- VOID TAP READER -->
<div class="vt-reader" id="vtReader">
  <span class="vt-reader-from" id="vtReaderFrom">dari: @anonymous</span>
  <div class="vt-reader-msg" id="vtReaderMsg"></div>
  <span class="vt-reader-timer" id="vtReaderTimer">menghilang dalam 5s</span>
</div>

<div class="vt-upgrade-nudge" id="vtUpgradeNudge" onclick="showUpgradeModal()">limit harian habis ‚Äî <b>upgrade</b></div>
<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ
const API_URL='https://jejak.space/api/chat',USE_MOCK=false;

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
let currentGender=null,chatPartner=null,timerInterval=null,chatTimeLeft=900,
    selectedPlan=null,activeMood='all',radarInterval,radarRAF=null,
    userName='stranger_'+Math.floor(Math.random()*1000),activeWsThread=null,
    vtBurnTimer=null,fallbackTimer=null,apiOffline=false,vtQuota=3,
    selectedPackage=null,chatHistory=[],
    isTyping=false; // Flag untuk cek sedang ngetik

let userSub={isActive:false,expiresAt:null,type:null};

const AI_CHARS={
  female:['beby.manis','strawberry.shortcake','pretty.sad','little.fairy','cinnamon.girl'],
  male:['sejuta.badai','kue.bulan','agak.koplak','chili.padi','abang.gaul']
};

let voidTaps=[
  {id:'vt1',from:'anonymous',content:'ada yang pernah ngerasa jadi background character di hidup sendiri?',timestamp:Date.now()-300000,read:false},
  {id:'vt2',from:'anonymous',content:'kadang pengen ilang tanpa jejak, tapi takut ga ada yang nyari',timestamp:Date.now()-600000,read:false}
];

let whispers=[
  {id:'w1',from:'strawberry.shortcake',to:userName,content:'halo, liat postingan kamu, relate banget',timestamp:Date.now()-120000,read:false,thread:[]},
  {id:'w2',from:'sejuta.badai',to:userName,content:'salam kenal, boleh ngobrol?',timestamp:Date.now()-360000,read:true,thread:[]}
];

const RANTS=[
  {id:1,author:'anon.kucing',mood:'surviving',content:'Hari ini gue nangis di angkot gegara liat kucing dipukul orang. Mental gue udah kayak kerupuk kena hujan.',reactions:{skull:42,cry:89,fire:12,upside:7},userReacted:null},
  {id:2,author:'sleepy.head',mood:'thriving',content:'akhirnya bisa tidur nyenyak semalaman setelah 3 minggu insomnia. makasih buat yang chat tadi malem.',reactions:{skull:23,cry:15,fire:67,upside:31},userReacted:null},
  {id:3,author:'chaos.queen',mood:'chaotic',content:'hari ini chaos abis! dari bangun tidur udah salah ambil kaki, sampe kantor lupa bawa laptop.',reactions:{skull:89,cry:23,fire:45,upside:78},userReacted:null},
  {id:4,author:'quiet.one',mood:'doom',content:'udah seminggu nggak keluar kamar. bukan karena sibuk. cuma nggak tau mau ngapain.',reactions:{skull:67,cry:112,fire:8,upside:34},userReacted:null}
];

const REACT_EMO={skull:'üíÄ',cry:'üò≠',fire:'üî•',upside:'üôÉ'};
const TERMS=`Dengan melanjutkan pembayaran, kamu setuju bahwa:\n\n1. üîÑ Subscription digital untuk fitur premium SPILL.\n2. ‚è∞ Paket 7 hari (10K): chat tanpa batas | Paket 30 hari (50K): chat + WHISPERER\n3. üí≥ Pembayaran via Midtrans\n4. üö´ Tidak ada refund (kecuali error sistem)\n5. üîí SPILL tidak menyimpan data kartu\n6. ‚è≥ Tidak ada auto-renewal\n7. ‚ùì Hubungi @spill.support`;

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ
const $=id=>document.getElementById(id);
const esc=t=>{const d=document.createElement('div');d.textContent=t;return d.innerHTML};
const timeAgo=ts=>{const m=Math.floor((Date.now()-ts)/60000);return m<60?m+'m':Math.floor(m/60)+'h'};
const rnd=n=>Math.floor(Math.random()*n);
const checkSub=()=>userSub.isActive&&userSub.expiresAt&&new Date(userSub.expiresAt)>new Date();
const sleep=ms=>new Promise(r=>setTimeout(r,ms));

function toast(msg,err=false){
  const t=$('toast');t.textContent=msg;t.className='toast'+(err?' error':'');t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}
const closeModal=id=>$(id).classList.remove('on');
const updateVibePct=v=>$('vibePct').textContent=v+'%';

function filterMood(btn){
  document.querySelectorAll('.mood-chip').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');activeMood=btn.dataset.mood;renderSpills();
}

function loadSub(){
  try{
    const s=JSON.parse(localStorage.getItem('userSub')||'null');
    if(s&&new Date(s.expiresAt)>new Date())userSub=s;
    else localStorage.removeItem('userSub');
  }catch(e){}
}

// ‚îÄ‚îÄ‚îÄ SPILLS ‚îÄ‚îÄ‚îÄ
const SPILL_TXT=['hari ini gue liat mantan sama cewek baru, dan tau gak? rambutnya lebih bagus dari rambut gue üò≠','cape bener jadi cewek, setiap bulan harus nahan sakit perut sambil tetep senyum di depan client','kenapa sih cowok kalo ditanya "lagi apa" pasti jawabnya "lagi main"? ga ada variasi lain?','gue lagi fase pengen dimengerti tanpa harus jelasin panjang lebar','bete banget skincare gue habis, padahal baru kemarin beli. ada yang ngutil?','hari ini gue salah kirim chat pacar ke grup keluarga. isinya "sayang udah mandi belom?" üò≠','kenapa orangtua selalu curiga kalo kita lagi seneng?','gue lagi diet, tapi tiap liat roti, rotinya yang liat gue duluan','stress skripsi tapi yang keluar peluh dan air mata doang','hari ini gue nangis karena ga bisa buka toples. lemah?'];
const MOODS=['surviving','thriving','chaotic','doom'];
const NAMES=['anon.kucing','sleepy.head','chaos.queen','quiet.one','beby.manis','strawberry.shortcake','pretty.sad','little.fairy','cinnamon.girl','sejuta.badai','kue.bulan','agak.koplak','chili.padi','abang.gaul'];

function genSpills(n=6){
  let id=Math.max(...RANTS.map(u=>u.id),5)+1,out=[];
  for(let i=0;i<n;i++)out.push({id:id++,author:NAMES[rnd(NAMES.length)],isAI:Math.random()>.7,mood:MOODS[rnd(4)],content:SPILL_TXT[rnd(SPILL_TXT.length)],reactions:{skull:rnd(50),cry:rnd(100),fire:rnd(40),upside:rnd(30)},userReacted:null});
  return out;
}

function renderSpills(){
  const list=$('spillsList');if(!list)return;
  let all=[...RANTS,...genSpills(6)];
  let fl=activeMood==='all'?all:all.filter(s=>s.mood===activeMood);
  if(!fl.length){list.innerHTML='<div class="empty-state"><span class="empty-icon">üçÉ</span><div class="empty-title">BELUM ADA SPILL</div><div class="empty-text">Coba filter lain</div></div>';return;}
  list.innerHTML=fl.map(s=>`<div class="spill-card"><div class="spill-head"><span class="spill-user">@${esc(s.author)}${s.isAI?' ü§ñ':''}</span><span class="spill-mood ${s.mood}">${s.mood.toUpperCase()}</span></div><div class="spill-body">${esc(s.content)}</div><div class="spill-actions">${Object.entries(REACT_EMO).map(([k,em])=>`<button class="react-btn ${s.userReacted===k?'active':''}" onclick="react(this,${s.id},'${k}')">${em}<span class="react-count" id="rc-${s.id}-${k}">${s.reactions[k]}</span></button>`).join('')}</div></div>`).join('');
}

function react(btn,id,key){
  const s=RANTS.find(x=>x.id===id);if(!s)return;
  const was=btn.classList.contains('active');
  document.querySelectorAll(`[id^="rc-${id}-"]`).forEach(el=>el.closest('button').classList.remove('active'));
  was?s.reactions[key]--:(s.reactions[key]++,btn.classList.add('active'));
  s.userReacted=was?null:key;
  Object.keys(s.reactions).forEach(r=>{const el=$(`rc-${id}-${r}`);if(el)el.textContent=s.reactions[r];});
}

const refreshSpills=()=>{renderSpills();toast('Teh baru diseduh ‚òï')};

// ‚îÄ‚îÄ‚îÄ RADAR ‚îÄ‚îÄ‚îÄ
let rdots=[],needleA=0,needleO=0,phA=Math.random()*Math.PI*2,phB=Math.random()*Math.PI*2,phC=Math.random()*Math.PI*2;
const BASE_OM=(60/4*Math.PI*2)/(60*60),TRAIL_CAP=120,trail=new Float32Array(TRAIL_CAP);
let trailPtr=0;const dotGlow=new Map();

function initRadar(){
  const cv=$('radarCanvas'),ct=$('radarCont');if(!cv||!ct)return;
  const resize=()=>{const r=ct.getBoundingClientRect();cv.width=r.width;cv.height=r.height;};
  resize();window.addEventListener('resize',resize,{passive:true});
  spawnDots();
  radarInterval=setInterval(()=>{
    rdots.forEach(d=>{d.vx=d.vx*.88+(Math.random()-.5)*.3;d.vy=d.vy*.88+(Math.random()-.5)*.3;d.x=Math.max(9,Math.min(91,d.x+d.vx));d.y=Math.max(9,Math.min(91,d.y+d.vy));if(d.el){d.el.style.left=d.x+'%';d.el.style.top=d.y+'%';}});
  },100);
  needleA=Math.random()*Math.PI*2;trail.fill(needleA);radarLoop(cv);
}

function spawnDots(){
  const c=$('radarDots');if(!c)return;c.innerHTML='';rdots=[];
  const types=['ai','purple','red','lime'],n=5+rnd(5);
  for(let i=0;i<n+2;i++){
    const a=Math.random()*Math.PI*2,d=12+Math.random()*70,x=50+Math.cos(a)*d/2,y=50+Math.sin(a)*d/2;
    const dot=document.createElement('div'),type=types[rnd(types.length)];
    dot.className='radar-dot '+type;dot.style.left=x+'%';dot.style.top=y+'%';
    c.appendChild(dot);rdots.push({el:dot,x,y,vx:0,vy:0,type,id:i});
  }
}

function radarLoop(cv){
  const ctx=cv.getContext('2d');
  function draw(){
    const W=cv.width,H=cv.height,cx=W/2,cy=H/2,R=Math.min(cx,cy)*.88;
    phA+=.007;phB+=.013;phC+=.041;
    needleO+=(BASE_OM*(1+Math.sin(phA)*.35+Math.sin(phB)*.18+Math.sin(phC)*.04)-needleO)*.028;
    needleA=(needleA+needleO)%(Math.PI*2);trail[trailPtr]=needleA;trailPtr=(trailPtr+1)%TRAIL_CAP;
    ctx.fillStyle='rgba(2,10,2,.09)';ctx.fillRect(0,0,W,H);
    for(let i=0;i<TRAIL_CAP-1;i++){
      const nw=(trailPtr-1-i+TRAIL_CAP)%TRAIL_CAP,ol=(trailPtr-2-i+TRAIL_CAP)%TRAIL_CAP;
      const alpha=Math.pow(1-i/TRAIL_CAP,1.6)*.5;if(alpha<.003)break;
      let s=trail[ol],e=trail[nw];if(e-s>Math.PI)s+=Math.PI*2;if(s-e>Math.PI)e+=Math.PI*2;
      ctx.save();ctx.translate(cx,cy);ctx.beginPath();ctx.moveTo(0,0);ctx.arc(0,0,R,s,e,false);ctx.closePath();ctx.fillStyle=`rgba(0,229,255,${alpha})`;ctx.fill();ctx.restore();
    }
    ctx.save();ctx.translate(cx,cy);ctx.rotate(needleA);ctx.shadowColor='rgba(0,229,255,.9)';ctx.shadowBlur=10;
    const lg=ctx.createLinearGradient(0,0,R,0);
    lg.addColorStop(0,'rgba(0,229,255,1)');lg.addColorStop(.55,'rgba(0,229,255,.8)');lg.addColorStop(.85,'rgba(0,229,255,.35)');lg.addColorStop(1,'rgba(0,229,255,0)');
    ctx.beginPath();ctx.moveTo(4,0);ctx.lineTo(R,0);ctx.strokeStyle=lg;ctx.lineWidth=1.8;ctx.stroke();
    ctx.shadowBlur=16;ctx.beginPath();ctx.rect(-3,-3,6,6);ctx.fillStyle='#00e5ff';ctx.fill();ctx.restore();
    rdots.forEach((d,di)=>{
      const px=d.x/100*W,py=d.y/100*H;let da=Math.atan2(py-cy,px-cx);if(da<0)da+=Math.PI*2;
      let diff=needleA-da;if(diff<0)diff+=Math.PI*2;
      const age=dotGlow.get(di)??999;
      if(diff<.14&&age>40){dotGlow.set(di,0);if(d.el){d.el.classList.add('active');setTimeout(()=>{if(d.el)d.el.classList.remove('active');},700);}}else dotGlow.set(di,age+1);
      if(age<60){
        const t=age/60,ga=(1-t)*(1-t)*.85;if(ga<.01)return;
        const col=d.type==='purple'?'191,90,242':d.type==='red'?'255,45,85':d.type==='lime'?'191,255,0':'0,229,255';
        const gr=ctx.createRadialGradient(px,py,0,px,py,14*(1-t)+4);gr.addColorStop(0,`rgba(${col},${ga})`);gr.addColorStop(1,`rgba(${col},0)`);
        ctx.beginPath();ctx.arc(px,py,14*(1-t)+4,0,Math.PI*2);ctx.fillStyle=gr;ctx.fill();
      }
    });
    radarRAF=requestAnimationFrame(draw);
  }
  radarRAF=requestAnimationFrame(draw);
}

const updateOnlineCount=()=>{const el=$('onlineCount');if(el)el.textContent=(rnd(25)+18)+' ONLINE';};

// ‚îÄ‚îÄ‚îÄ VIBE CHECK ‚îÄ‚îÄ‚îÄ
function startVibeCheck(){
  chatPartner=null;chatTimeLeft=900;chatHistory=[];
  if(fallbackTimer){clearTimeout(fallbackTimer);fallbackTimer=null;}
  $('genderModal').classList.add('on');
}

function selectGender(el,g){
  document.querySelectorAll('.gender-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');currentGender=g;$('confirmGenderBtn').disabled=false;
}

function confirmGender(){
  if(!currentGender)return;
  closeModal('genderModal');$('chatRoom').classList.add('on');$('chatTimer').textContent='15:00';$('chatTimer').classList.remove('warn');
  $('partnerLabel').textContent='MENCARI...';
  const msgs=$('chatMessages');
  msgs.innerHTML=`<div class="chat-msg system-msg" style="align-self:center;opacity:.7;margin:20px 0"><div class="chat-bubble" style="background:transparent;border:2px dashed var(--bd);color:var(--txs);font-style:italic">‚ö° mengaktifkan radar pencarian...</div></div>`;
  [{t:3000,m:"masih memindai...",e:"üëÄ"},{t:6000,m:"lingkungan sepi, radar melebar",e:"üì°"},{t:9000,m:"menjangkau radius 2km",e:"üåê"},{t:12000,m:"hampir selesai...",e:"‚è≥"}]
    .forEach(({t,m,e})=>setTimeout(()=>{if(!chatPartner)updateSysMsg(m,e);},t));
  findRealUser();
  fallbackTimer=setTimeout(()=>{if(!chatPartner&&$('chatRoom').classList.contains('on')){msgs.innerHTML='';fallbackToAI();}},15000);
}

function updateSysMsg(text,emoji=''){
  const msgs=$('chatMessages');if(!msgs)return;
  const last=msgs.lastElementChild;if(last&&last.classList.contains('system-msg'))last.remove();
  const d=mk('div','chat-msg system-msg','align-self:center');
  d.innerHTML=`<div class="chat-bubble" style="background:var(--sfe);border-left:3px solid var(--bd);padding:10px 16px;font-size:12px;color:var(--txs)">${emoji} ${text} <span style="font-family:'DM Mono',monospace" id="scanDots">...</span></div>`;
  msgs.appendChild(d);d.scrollIntoView({behavior:'smooth'});
}

function addSysCel(text,emoji){
  const msgs=$('chatMessages');if(!msgs)return;
  const d=mk('div','chat-msg system-msg','align-self:center;margin:10px 0');
  d.innerHTML=`<div class="chat-bubble" style="background:rgba(0,229,255,.08);border:2px solid var(--as);padding:12px 20px"><span style="font-size:20px;margin-right:8px">${emoji}</span><span style="color:var(--as);font-weight:600">${text}</span></div>`;
  msgs.appendChild(d);d.scrollIntoView({behavior:'smooth'});
}

const mk=(tag,cls,style='')=>{const el=document.createElement(tag);if(cls)el.className=cls;if(style)el.style.cssText=style;return el;};

async function findRealUser(){
  setTimeout(()=>{
    if(!chatPartner&&$('chatRoom').classList.contains('on')&&Math.random()<.05){
      if(fallbackTimer){clearTimeout(fallbackTimer);fallbackTimer=null;}
      $('chatMessages').innerHTML='';addSysCel('‚ú® real user ditemukan!','üéâ');
      setTimeout(fallbackToAI,1500);
    }
  },3000);
}

function fallbackToAI(){
  if(fallbackTimer){clearTimeout(fallbackTimer);fallbackTimer=null;}
  const chars=AI_CHARS[currentGender==='female'?'female':'male'];
  chatPartner={name:chars[rnd(chars.length)],isAI:true};
  const msgs=$('chatMessages');if(msgs)msgs.innerHTML='';
  if($('partnerLabel'))$('partnerLabel').textContent='@'+chatPartner.name;
  addSysCel('üë§ seseorang ditemukan!','');
  setTimeout(()=>{if(msgs)msgs.innerHTML='';apiOffline=false;callChatAPI('',true);startTimer();},1000);
}

const startTimer=()=>{clearInterval(timerInterval);timerInterval=setInterval(updateTimer,1000);};

// ‚îÄ‚îÄ‚îÄ POPUP WARNING 2 MENIT ‚îÄ‚îÄ‚îÄ
function showTwoMinuteWarning(){
  const existing=document.querySelector('.warning-popup');
  if(existing)existing.remove();
  
  const popup=document.createElement('div');
  popup.className='warning-popup';
  popup.innerHTML=`
    <div class="title">‚ö†Ô∏è 2 MENIT</div>
    <div class="msg">Sesi chatting akan berakhir dalam 2 menit.<br>Subscribe untuk lanjut ngobrol!</div>
    <button class="btn" onclick="this.closest('.warning-popup').remove();showUpgradeModal()">UPGRADE</button>
    <button class="btn" style="background:transparent;color:var(--tx);margin-top:8px" onclick="this.closest('.warning-popup').remove()">TUTUP</button>
  `;
  document.body.appendChild(popup);
}

function updateTimer(){
  if(chatTimeLeft<=0){endChat();return;}
  chatTimeLeft--;
  const m=Math.floor(chatTimeLeft/60),s=chatTimeLeft%60;
  const tel=$('chatTimer');if(tel)tel.textContent=String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
  
  // TAMPILKAN POPUP SAAT 2 MENIT (120 detik)
  if(chatTimeLeft===120){
    showTwoMinuteWarning();
  }
  
  if(checkSub())return;
  const REM={60:["‚è∞ 1 menit lagi...","10k/minggu atau 50k/bulan (dapet WHISPERER ‚ú¶)"],30:["‚ö° 30 detik...","mau coba subscribe?"],10:["üéØ 10 detik terakhir...","abis ini bakal nutup otomatis ya"]};
  if(REM[chatTimeLeft]){addSubReminder(...REM[chatTimeLeft]);if(chatTimeLeft===60&&tel)tel.classList.add('warn');}
}

function addSubReminder(title,msg){
  const msgs=$('chatMessages');if(!msgs)return;
  const ex=document.querySelector('.reminder-msg');if(ex)ex.remove();
  const d=mk('div','chat-msg reminder-msg','align-self:center;margin:8px 0;max-width:90%');
  d.innerHTML=`<div class="chat-bubble" style="background:var(--sfe);border:2px dashed var(--as);padding:16px">
    <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--as);margin-bottom:6px;letter-spacing:1px">${title}</div>
    <div style="font-size:13px;color:var(--tx);margin-bottom:16px">${msg}</div>
    <div style="display:flex;gap:8px;margin-bottom:16px">
      <div onclick="selectPackage('weekly',this)" style="flex:1;background:var(--bg);border:2px solid var(--bd2);padding:12px;text-align:center;cursor:pointer;box-shadow:3px 3px 0 #000" data-package="weekly"><div style="font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--as)">10K</div><div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--txs)">7 hari</div></div>
      <div onclick="selectPackage('monthly',this)" style="flex:1;background:var(--bg);border:2px solid var(--bd2);padding:12px;text-align:center;cursor:pointer;box-shadow:3px 3px 0 #000" data-package="monthly"><div style="font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--aq)">50K</div><div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--txs)">30 hari + ‚ú¶</div></div>
    </div>
    <div style="margin-bottom:12px;text-align:center"><button onclick="showTermsPopup()" style="background:transparent;border:2px dashed var(--bd2);color:var(--txs);padding:8px 16px;font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;letter-spacing:1px">üìã SYARAT & KETENTUAN</button></div>
    <div id="tcContainer" style="display:none;margin-bottom:16px"><div style="display:flex;align-items:flex-start;gap:10px;background:var(--bg);padding:12px;border:2px solid var(--bd2)"><input type="checkbox" id="tcCheckbox" style="width:18px;height:18px;margin-top:2px;accent-color:var(--aq)"><label for="tcCheckbox" style="font-family:'DM Mono',monospace;font-size:11px;color:var(--txs);line-height:1.5">Saya setuju dengan <button onclick="showTermsPopup()" style="background:none;border:none;color:var(--as);text-decoration:underline;cursor:pointer;font-family:'DM Mono',monospace;font-size:11px">syarat & ketentuan</button></label></div></div>
    <div id="payButtonContainer" style="display:none;margin-bottom:8px"><button onclick="processSubscription()" style="width:100%;background:var(--ap);color:#fff;border:2px solid #000;padding:14px;font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;cursor:pointer;box-shadow:3px 3px 0 #000">LANJUT BAYAR ‚Üí</button></div>
    <div style="display:flex;justify-content:flex-end"><button onclick="dismissReminder()" style="background:transparent;border:none;color:var(--txm);padding:6px 12px;font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;letter-spacing:1px">SKIP DULU</button></div>
  </div>`;
  msgs.appendChild(d);d.scrollIntoView({behavior:'smooth'});
}

function selectPackage(type,el){
  selectedPackage=type;
  document.querySelectorAll('[data-package]').forEach(e=>{e.style.borderColor='var(--bd2)';e.style.background='var(--bg)';});
  el.style.borderColor=type==='weekly'?'var(--as)':'var(--aq)';
  el.style.background=type==='weekly'?'rgba(0,229,255,.08)':'rgba(191,255,0,.08)';
  const tc=document.getElementById('tcContainer');if(tc)tc.style.display='block';
  const cb=document.getElementById('tcCheckbox');
  if(cb)cb.onchange=function(){const pb=document.getElementById('payButtonContainer');if(pb)pb.style.display=this.checked?'block':'none';};
}

const dismissReminder=()=>{const r=document.querySelector('.reminder-msg');if(r)r.remove();};

function showTermsPopup(){
  const ov=mk('div','overlay','position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.95);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px');
  ov.innerHTML=`<div style="background:var(--sf);border:2px solid var(--bd2);max-width:400px;width:100%;max-height:80vh;overflow-y:auto;box-shadow:8px 8px 0 #000">
    <div style="padding:20px;border-bottom:2px solid var(--bd);display:flex;justify-content:space-between;align-items:center">
      <span style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px">SYARAT & KETENTUAN</span>
      <button onclick="this.closest('.overlay').remove()" style="background:var(--bg);border:2px solid var(--bd);width:36px;height:36px;cursor:pointer;color:var(--txs);font-size:16px;box-shadow:2px 2px 0 #000">‚úï</button>
    </div>
    <div style="padding:20px;font-family:'DM Mono',monospace;font-size:11px;color:var(--txs);line-height:1.9;white-space:pre-line">${TERMS}</div>
    <div style="padding:20px;border-top:2px solid var(--bd);display:flex;gap:10px">
      <button onclick="agreeToTerms();this.closest('.overlay').remove()" style="flex:2;background:var(--aq);color:#000;border:2px solid #000;padding:12px;font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:1px;cursor:pointer;box-shadow:3px 3px 0 #000">SETUJU</button>
      <button onclick="this.closest('.overlay').remove()" style="flex:1;background:transparent;border:2px solid var(--bd2);color:var(--txs);padding:12px;cursor:pointer;font-family:'DM Mono',monospace;font-size:11px">TUTUP</button>
    </div>
  </div>`;
  document.body.appendChild(ov);
}

function agreeToTerms(){
  const cb=document.getElementById('tcCheckbox');
  if(cb){cb.checked=true;cb.dispatchEvent(new Event('change',{bubbles:true}));}
}

function processSubscription(){
  if(!selectedPackage){toast('pilih paket dulu ya~',true);return;}
  const cb=document.getElementById('tcCheckbox');if(!cb||!cb.checked){toast('centang syarat & ketentuan dulu~',true);return;}
  const days=selectedPackage==='weekly'?7:30;
  const ld=mk('div','chat-msg system-msg','align-self:center');
  ld.innerHTML=`<div class="chat-bubble" style="background:var(--sfe);padding:12px 20px;font-family:'DM Mono',monospace">‚è≥ nyiapin pembayaran...</div>`;
  $('chatMessages').appendChild(ld);
  setTimeout(()=>{
    ld.remove();
    const exp=new Date();exp.setDate(exp.getDate()+days);
    userSub={isActive:true,expiresAt:exp.toISOString(),type:selectedPackage};
    localStorage.setItem('userSub',JSON.stringify(userSub));
    dismissReminder();
    const bonus=selectedPackage==='monthly'?' dan WHISPERER ‚ú¶':'';
    const d=mk('div','chat-msg system-msg','align-self:center');
    d.innerHTML=`<div class="chat-bubble" style="background:rgba(0,229,255,.08);border:2px solid var(--as);padding:20px"><div style="display:flex;align-items:center;gap:12px;margin-bottom:12px"><span style="font-size:28px">üéâ</span><span style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px">SUBSCRIBE BERHASIL!</span></div><div style="font-family:'DM Mono',monospace;font-size:12px;color:var(--txs)">kamu bisa ngobrol santai ${days} hari ke depan${bonus}</div></div>`;
    $('chatMessages').appendChild(d);d.scrollIntoView({behavior:'smooth'});
    if(chatTimeLeft>0){chatTimeLeft+=900;const tel=$('chatTimer');if(tel){tel.textContent='15:00';tel.classList.remove('warn');}}
    toast('selamat datang di keluarga premium! üéâ');
  },1500);
}

function selectPlan(el,plan){document.querySelectorAll('.price-card').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');selectedPlan=plan;}

function processUpgrade(){
  if(!selectedPlan){toast('Pilih paket dulu',true);return;}
  closeModal('upgradeModal');
  if(chatTimeLeft>0&&$('chatRoom').classList.contains('on'))addSubReminder("‚ú® mau upgrade?","pilih paket yang cocok~");
  else toast('Buka VIBE CHECK dulu untuk chat',true);
}

function endChat(){
  clearInterval(timerInterval);
  if(checkSub()){chatTimeLeft=900;const tel=$('chatTimer');if(tel){tel.textContent='15:00';tel.classList.remove('warn');}addSysCel("üîÑ auto-refresh","subscriber dapet 15 menit lagi~");return;}
  const d=mk('div','chat-msg system-msg','align-self:center;margin:20px 0');
  d.innerHTML=`<div class="chat-bubble" style="background:var(--sfe);border:2px solid var(--bd2);padding:20px;max-width:300px;box-shadow:4px 4px 0 #000">
    <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:1px;margin-bottom:12px">WAKTU ABIS ‚è∞</div>
    <div style="font-size:13px;color:var(--txs);margin-bottom:16px">mau lanjut ngobrol? subscribe dulu yuk~</div>
    <div style="display:flex;gap:8px;margin-bottom:16px">
      <div onclick="selectPackage('weekly',this)" style="flex:1;background:var(--bg);border:2px solid var(--bd2);padding:12px;text-align:center;cursor:pointer;box-shadow:2px 2px 0 #000" data-package="weekly"><div style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--as)">10K</div><div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--txs)">7 hari</div></div>
      <div onclick="selectPackage('monthly',this)" style="flex:1;background:var(--bg);border:2px solid var(--bd2);padding:12px;text-align:center;cursor:pointer;box-shadow:2px 2px 0 #000" data-package="monthly"><div style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--aq)">50K</div><div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--txs)">30 hari + ‚ú¶</div></div>
    </div>
    <button onclick="processSubscription()" style="width:100%;background:var(--ap);color:#fff;border:2px solid #000;padding:14px;font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;cursor:pointer;box-shadow:3px 3px 0 #000;margin-bottom:8px">SUBSCRIBE ‚Üí</button>
    <button onclick="closeChat()" style="width:100%;background:transparent;border:2px dashed var(--bd2);color:var(--txs);padding:10px;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;letter-spacing:1px">TUTUP DULU</button>
  </div>`;
  $('chatMessages').appendChild(d);d.scrollIntoView({behavior:'smooth'});
}

function closeChat(){$('chatRoom').classList.remove('on');clearInterval(timerInterval);if(fallbackTimer){clearTimeout(fallbackTimer);fallbackTimer=null;}}

// ‚îÄ‚îÄ‚îÄ WHISPERER ‚îÄ‚îÄ‚îÄ
function openWsModal(){
  const isPrem=checkSub()&&userSub.type==='monthly';
  if(!isPrem){
    $('wsModalBody').innerHTML=`<div class="ws-premium-lock"><div class="icon">‚ú¶</div><div class="title">WHISPERER PREMIUM</div><div class="desc">fitur ini khusus untuk pengguna paket 50K/30 hari</div><button class="ws-premium-btn" onclick="closeModal('wsModal');showUpgradeModal()">UPGRADE SEKARANG</button></div>`;
    $('wsModal').classList.add('on');return;
  }
  $('wsModalBody').innerHTML=`<div><div class="ws-inbox-hdr"><div style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:1px">INBOX</div><button class="ws-compose-btn" onclick="openWsCompose()">+ TULIS</button></div><div id="wsInboxList"></div></div>`;
  $('wsModal').classList.add('on');renderWsInbox();
}

function renderWsInbox(){
  const list=$('wsInboxList');if(!list)return;
  if(!whispers.length){list.innerHTML=`<div style="text-align:center;padding:40px 0"><span style="font-size:36px;opacity:.3;display:block;margin-bottom:12px">‚úß</span><div style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:1px;color:var(--txs)">BELUM ADA WHISPER</div></div>`;return;}
  list.innerHTML=whispers.map(w=>`<div class="ws-thread-item ${w.read?'':'unread'}" onclick="openWsThread('${w.from}')"><div class="ws-avatar">${w.from.charAt(0).toUpperCase()}</div><div class="ws-thread-info"><div class="ws-thread-name">@${esc(w.from)}</div><div class="ws-thread-preview">${esc(w.content)}</div></div><div class="ws-thread-right"><span class="ws-thread-time">${timeAgo(w.timestamp)}</span>${!w.read?'<span class="ws-unread-badge">NEW</span>':''}</div></div>`).join('');
  updateWsBadge();
}

function updateWsBadge(){
  const badge=$('wsStealthBadge');if(!badge)return;
  const n=whispers.filter(w=>!w.read).length;
  n>0?(badge.textContent=n+' NEW',badge.classList.add('show')):badge.classList.remove('show');
}

function openWsCompose(){
  if(!(checkSub()&&userSub.type==='monthly')){toast('whisperer khusus premium 50K',true);return;}
  closeModal('wsModal');$('wsComposeScreen').classList.add('on');
  $('wsToInput').value='';$('wsBodyInput').value='';$('wsCharCount').textContent='0/200';$('wsSendBtn').disabled=true;
}
const closeWsCompose=()=>$('wsComposeScreen').classList.remove('on');
function validateWsTo(){$('wsSendBtn').disabled=!($('wsToInput').value.trim()&&$('wsBodyInput').value.trim());}
function validateWsBody(){$('wsCharCount').textContent=$('wsBodyInput').value.length+'/200';validateWsTo();}

function sendWs(){
  const to=$('wsToInput').value.trim(),body=$('wsBodyInput').value.trim();if(!to||!body)return;
  whispers.push({id:'w'+Date.now(),from:to,to:userName,content:body,timestamp:Date.now(),read:false,thread:[]});
  toast('Whisper terkirim (hilang 5 detik setelah dibaca)');closeWsCompose();openWsModal();
}

function openWsThread(username){
  const w=whispers.find(x=>x.from===username);if(!w)return;
  w.read=true;activeWsThread=w;$('wsThreadScreen').classList.add('on');$('wsThreadTitle').textContent='@'+username;
  renderWsThread(w);updateWsBadge();
}
const closeWsThread=()=>{$('wsThreadScreen').classList.remove('on');activeWsThread=null;};

function renderWsThread(w){
  const msgs=$('wsThreadMessages');
  const all=[{from:w.from,content:w.content,timestamp:w.timestamp},...w.thread];
  msgs.innerHTML=all.map(m=>`<div class="chat-msg ${m.from===userName?'own':'other'}"><div class="chat-bubble" ${m.from!==userName?'style="border-color:var(--as)"':''}>${esc(m.content)}</div><div class="chat-time">${timeAgo(m.timestamp)}</div></div>`).join('');
  msgs.scrollTop=msgs.scrollHeight;
  msgs.querySelectorAll('.chat-bubble').forEach((b,i)=>{
    setTimeout(()=>{if(b&&b.parentElement){b.style.animation='vtBurn .7s ease forwards';setTimeout(()=>{if(b.parentElement)b.parentElement.remove();},700);}},5000+i*1000);
  });
}

function sendWsReply(){
  if(!activeWsThread)return;const inp=$('wsThreadInput'),text=inp.value.trim();if(!text)return;
  activeWsThread.thread.push({from:userName,content:text,timestamp:Date.now()});
  renderWsThread(activeWsThread);inp.value='';
}

// ‚îÄ‚îÄ‚îÄ VOID TAP ‚îÄ‚îÄ‚îÄ
function updateVtIndicator(){const w=$('vtIndicator');if(w)w.classList.toggle('has-tap',voidTaps.some(v=>!v.read));}

function openVtCompose(){
  if(!checkSub()&&vtQuota<=0){showVtUpgradeNudge();return;}
  $('vtCompose').classList.add('on');$('vtTextarea').value='';$('vtCharCount').textContent='0/150';
  $('vtQuota').textContent=checkSub()?'premium ‚Ä¢ unlimited':`sisa ${vtQuota}/3 hari ini`;
  $('vtSendBtn').disabled=!checkSub()&&vtQuota<=0;
}
const closeVtCompose=()=>$('vtCompose').classList.remove('on');

function sendVoidTap(){
  if(!checkSub()&&vtQuota<=0){showVtUpgradeNudge();return;}
  const text=$('vtTextarea').value.trim();if(!text)return;
  if(!checkSub())vtQuota--;
  voidTaps.push({id:'vt'+Date.now(),from:'anonymous',content:text,timestamp:Date.now(),read:false});
  updateVtIndicator();toast('Void tap terkirim');closeVtCompose();
}

function checkVoidTaps(){const u=voidTaps.filter(v=>!v.read);if(!u.length){toast('Tidak ada void tap baru');return;}openVtReader(u[0]);}

function openVtReader(tap){
  tap.read=true;updateVtIndicator();$('vtReader').classList.add('on');
  $('vtReaderFrom').textContent=`dari: @${tap.from}`;$('vtReaderMsg').textContent=tap.content;
  let t=5;$('vtReaderTimer').textContent=`menghilang dalam ${t}s`;
  if(vtBurnTimer)clearInterval(vtBurnTimer);
  vtBurnTimer=setInterval(()=>{if(--t<=0){clearInterval(vtBurnTimer);$('vtReader').classList.add('burning');setTimeout(()=>$('vtReader').classList.remove('on','burning'),700);}else $('vtReaderTimer').textContent=`menghilang dalam ${t}s`;},1000);
}

const showVtUpgradeNudge=()=>{$('vtUpgradeNudge').classList.add('show');setTimeout(()=>$('vtUpgradeNudge').classList.remove('show'),3000);};
const showUpgradeModal=()=>$('upgradeModal').classList.add('on');

// ‚îÄ‚îÄ‚îÄ EFEK KETIK REALISTIS ‚îÄ‚îÄ‚îÄ
async function typeMessage(element, finalText) {
  const chars = finalText.split('');
  let currentText = '';
  let i = 0;
  
  // Kemungkinan salah ketik (15% chance per pesan)
  const makeMistake = Math.random() < 0.15;
  let mistakeIndex = -1;
  let mistakeChar = '';
  
  if (makeMistake && chars.length > 5) {
    mistakeIndex = Math.floor(Math.random() * (chars.length - 3)) + 2;
    mistakeChar = String.fromCharCode(97 + Math.floor(Math.random() * 26));
  }
  
  while (i < chars.length) {
    // Efek salah ketik
    if (makeMistake && i === mistakeIndex) {
      // Ketik huruf salah
      currentText += mistakeChar;
      element.textContent = currentText;
      await sleep(120 + Math.random() * 80);
      
      // Backspace (hapus 1-2 karakter)
      const backspaceCount = Math.random() > 0.5 ? 1 : 2;
      for (let b = 0; b < backspaceCount; b++) {
        currentText = currentText.slice(0, -1);
        element.textContent = currentText;
        await sleep(90 + Math.random() * 60);
      }
      
      // Lanjut dengan huruf yang benar
      continue;
    }
    
    // Ketik normal
    currentText += chars[i];
    element.textContent = currentText;
    
    // Variasi kecepatan ketik
    let delay = 40 + Math.random() * 80; // 40-120ms per huruf
    
    // Lebih lambat di akhir kalimat
    if (chars[i] === '.' || chars[i] === '?' || chars[i] === '!') {
      delay = 250 + Math.random() * 200;
    }
    // Lebih lambat setelah koma
    else if (chars[i] === ',' || chars[i] === ';') {
      delay = 150 + Math.random() * 100;
    }
    // Spasi juga sedikit lebih lambat
    else if (chars[i] === ' ') {
      delay = 100 + Math.random() * 70;
    }
    
    await sleep(delay);
    i++;
  }
  
  // Jeda setelah selesai mengetik
  await sleep(150);
}

// ‚îÄ‚îÄ‚îÄ CHAT API DENGAN EFEK KETIK ‚îÄ‚îÄ‚îÄ
async function callChatAPI(userMsg, isFirst=false){
  if(!chatPartner||!chatPartner.isAI||apiOffline||isTyping) return;
  
  isTyping = true;
  
  // TAMPILKAN TYPING INDICATOR
  const td=mk('div','chat-msg other');
  td.innerHTML='<div class="typing"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
  $('chatMessages').appendChild(td);
  td.scrollIntoView({behavior:'smooth'});
  
  try{
    let reply;
    const startTime = Date.now();
    
    // PANGGIL API
    if(USE_MOCK){
      await sleep(1500);
      reply=isFirst?`halo, gue ${chatPartner.name.split('.')[0]}. salam kenal üòä`:`iya nih, gue lagi bengong aja. lo?`;
    } else {
      const res=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
        message:isFirst?'halo':userMsg,
        characterName:chatPartner.name,
        userName,
        lastMessages:chatHistory.slice(-8)
      })});
      if(!res.ok)throw new Error('API '+res.status);
      const data=await res.json();
      if(!data.reply)throw new Error('Bad response');
      reply=data.reply;
      
      if(data.distress){
        const dEl=$('distressMsg');
        dEl.classList.add('show');
        dEl.textContent=data.distress==='high'?'‚ö†Ô∏è Partner menunjukkan tanda distress serius':'‚ö†Ô∏è Partner terlihat sedih, respons dengan empati';
      }
    }
    
    // HITUNG WAKTU YANG SUDAH DILEWATI
    const elapsed = Date.now() - startTime;
    
    // BASE DELAY 800ms + DELAY BERDASARKAN PANJANG PESAN
    const baseDelay = 800;
    const charDelay = Math.min(reply.length * 30, 2000);
    const randomDelay = Math.random() * 400;
    const typingDelay = baseDelay + charDelay + randomDelay;
    
    // KALAU RESPON API CEPAT, TAMBAH DELAY
    const remainingDelay = Math.max(0, typingDelay - elapsed);
    
    if(remainingDelay > 0) {
      await sleep(remainingDelay);
    }
    
    // HAPUS TYPING INDICATOR
    td.remove();
    
    // BUAT ELEMEN PESAN KOSONG
    const msgDiv = mk('div','chat-msg other');
    const bubble = mk('div','chat-bubble');
    bubble.textContent = ''; // Mulai kosong
    msgDiv.appendChild(bubble);
    $('chatMessages').appendChild(msgDiv);
    msgDiv.scrollIntoView({behavior:'smooth'});
    
    // EFEK KETIK
    await typeMessage(bubble, reply);
    
    if(!isFirst) chatHistory.push({role:'user',content:userMsg});
    chatHistory.push({role:'assistant',content:reply});
    
  } catch(e){
    console.error(e);
    td.remove();
    apiOffline=true;
    toast('Gagal terhubung ke server chat',true);
    if(isFirst){
      const fb=`halo, gue ${chatPartner.name.split('.')[0]}. salam kenal üòä`;
      
      // Tetap tampilkan dengan efek ketik
      const msgDiv = mk('div','chat-msg other');
      const bubble = mk('div','chat-bubble');
      bubble.textContent = '';
      msgDiv.appendChild(bubble);
      $('chatMessages').appendChild(msgDiv);
      msgDiv.scrollIntoView({behavior:'smooth'});
      
      await typeMessage(bubble, fb);
      chatHistory.push({role:'assistant',content:fb});
    }
  } finally {
    isTyping = false;
  }
}

function sendMsg(){
  if(isTyping) {
    toast('Tunggu partner selesai ngetik...', true);
    return;
  }
  
  const inp=$('chatInput'),text=inp.value.trim();
  if(!text)return;
  
  // Tampilkan pesan user langsung (tanpa efek ketik untuk user sendiri)
  const msgs=$('chatMessages');
  const d=mk('div','chat-msg own');
  const bubble=mk('div','chat-bubble');
  bubble.textContent = text;
  d.appendChild(bubble);
  msgs.appendChild(d);
  d.scrollIntoView({behavior:'smooth'});
  
  inp.value='';
  chatHistory.push({role:'user',content:text});
  
  if(chatPartner&&chatPartner.isAI&&!apiOffline) callChatAPI(text);
  else if(apiOffline) toast('Server chat sedang offline',true);
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded',()=>{
  loadSub();initRadar();renderSpills();updateOnlineCount();updateWsBadge();updateVtIndicator();
  $('chatInput')?.addEventListener('keydown',e=>{if(e.key==='Enter')sendMsg();});
  $('wsThreadInput')?.addEventListener('keydown',e=>{if(e.key==='Enter')sendWsReply();});
  $('wsToInput')?.addEventListener('input',validateWsTo);
  $('wsBodyInput')?.addEventListener('input',validateWsBody);
  $('vtTextarea')?.addEventListener('input',function(){
    $('vtCharCount').textContent=this.value.length+'/150';
    $('vtSendBtn').disabled=!this.value.trim()||(!checkSub()&&vtQuota<=0);
  });
  window.addEventListener('beforeunload',()=>{
    clearInterval(radarInterval);clearInterval(timerInterval);
    if(radarRAF)cancelAnimationFrame(radarRAF);if(fallbackTimer)clearTimeout(fallbackTimer);
  });
  setInterval(updateOnlineCount,30000);
});
</script>
</body>
</html>
