<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>SPILL ‚Äî vibe radar</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#000;--sf:#0a0a0a;--sfe:#111;--bd:#1a1a1a;--tx:#fff;
  --txs:#666;--txm:#444;--ap:#ff3d00;--as:#00f0ff;--aq:#00ff41;
  --war:#ff0040;--ms:#ff9500;--mt:#00ff41;--mc:#00f0ff;--md:#8b5cf6;
  --safe-bottom:env(safe-area-inset-bottom);--safe-top:env(safe-area-inset-top)
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}
html{height:100%;overflow:hidden}
body{
  height:100%;background:var(--bg);color:var(--tx);
  font-family:'Inter',-apple-system,sans-serif;font-size:14px;line-height:1.4;
  overflow:hidden;position:fixed;width:100%;overscroll-behavior:none
}
.app{height:100%;display:flex;flex-direction:column;overflow:hidden}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header{
  padding:12px 16px;padding-top:calc(12px + var(--safe-top));
  display:flex;justify-content:space-between;align-items:center;
  border-bottom:1px solid var(--bd);background:var(--bg);flex-shrink:0
}
.logo{font-size:28px;font-weight:800;letter-spacing:-2px;line-height:1}
.logo span{color:var(--as)}
.status{display:flex;align-items:center;gap:6px}

/* ‚îÄ‚îÄ SCROLL ‚îÄ‚îÄ */
.scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;overscroll-behavior-y:contain}
.scroll::-webkit-scrollbar{display:none}

/* ‚îÄ‚îÄ RADAR ‚îÄ‚îÄ */
.radar-sect{background:var(--sf);border-bottom:1px solid var(--bd);padding:12px 0}
.radar-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 16px 12px
}
.radar-label{
  font-family:'Space Mono',monospace;
  font-size:9px;
  color:var(--as);
  letter-spacing:1px;
  display:flex;
  align-items:center;
  gap:6px
}
.radar-label::before{
  content:'';
  width:6px;
  height:6px;
  background:var(--as);
  border-radius:50%;
  animation:blink 1s infinite
}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.radar-stat{
  font-family:'Space Mono',monospace;
  font-size:10px;
  color:var(--aq);
  background:#0f0f0f;
  padding:4px 10px;
  border-radius:4px;
  border:1px solid #2a2a2a;
  display:flex;
  align-items:center;
  gap:6px
}
.radar-stat::before{
  content:'';
  width:6px;
  height:6px;
  background:var(--aq);
  border-radius:0;
  animation:blink 1.5s step-end infinite
}
.radar-wrapper{padding:0 16px}
.radar-bezel{
  position:relative;
  border-radius:16px;
  padding:18px 18px 22px;
  background:linear-gradient(160deg,#3c3c3c 0%,#282828 8%,#1e1e1e 30%,#161616 50%,#1a1a1a 72%,#242424 92%,#2e2e2e 100%);
  box-shadow:inset 0 1px 0 rgba(255,255,255,.08),inset 1px 0 0 rgba(255,255,255,.04),inset 0 -2px 0 rgba(0,0,0,.7),inset -1px 0 0 rgba(0,0,0,.5),0 2px 0 #0a0a0a,0 4px 0 #060606,0 8px 24px rgba(0,0,0,.85),0 2px 6px rgba(0,0,0,.9);
  background-image:repeating-linear-gradient(90deg,transparent,transparent 3px,rgba(0,0,0,.08)3px,rgba(0,0,0,.08)4px),linear-gradient(160deg,#3c3c3c 0%,#282828 8%,#1e1e1e 30%,#161616 50%,#1a1a1a 72%,#242424 92%,#2e2e2e 100%)
}
.radar-screw{
  position:absolute;
  width:14px;height:14px;border-radius:50%;z-index:20;
  background:radial-gradient(circle at 38% 32%,#4a4a4a 0%,#2e2e2e 35%,#1a1a1a 65%,#111 100%);
  box-shadow:0 0 0 2px #0e0e0e,0 0 0 3px #2a2a2a,inset 0 1px 2px rgba(255,255,255,.12),inset 0 -1px 2px rgba(0,0,0,.9),0 1px 3px rgba(0,0,0,.8)
}
.radar-screw::before,.radar-screw::after{
  content:'';position:absolute;border-radius:1px;
  background:rgba(0,0,0,.65)
}
.radar-screw::before{width:7px;height:1.5px;top:6.25px;left:3.5px;transform:rotate(var(--sr,0deg))}
.radar-screw::after{width:1.5px;height:7px;top:3.5px;left:6.25px;transform:rotate(var(--sr,0deg))}
.screw-tl{top:7px;left:7px;--sr:15deg}
.screw-tr{top:7px;right:7px;--sr:-20deg}
.screw-bl{bottom:11px;left:7px;--sr:-10deg}
.screw-br{bottom:11px;right:7px;--sr:25deg}
.radar-bezel-label{
  position:absolute;top:6px;left:0;right:0;
  text-align:center;font-family:'Space Mono',monospace;
  font-size:7px;font-weight:700;letter-spacing:5px;
  text-transform:uppercase;color:transparent;
  text-shadow:0 1px 0 rgba(255,255,255,.1),0 -1px 0 rgba(0,0,0,.8);
  -webkit-text-stroke:.5px rgba(255,255,255,.15)
}
.radar-bezel-range{
  position:absolute;bottom:7px;left:0;right:0;
  display:flex;justify-content:space-between;padding:0 22px;
  font-family:'Space Mono',monospace;font-size:6px;color:rgba(255,255,255,.14);
  pointer-events:none
}
.radar-bezel::after{
  content:'';position:absolute;bottom:0;left:18px;right:18px;height:3px;
  border-radius:0 0 14px 14px;
  background:linear-gradient(90deg,transparent,var(--as) 30%,var(--as) 70%,transparent);
  opacity:.35
}
.radar-cont{
  position:relative;width:100%;
  aspect-ratio:1/1;
  background:radial-gradient(ellipse at 42% 38%,#0b1a0b 0%,#040d04 55%,#010501 100%);
  border-radius:6px;overflow:hidden;
  box-shadow:inset 0 0 0 2px #000,inset 0 2px 8px rgba(0,0,0,.95),inset 0 0 60px rgba(0,0,0,.9)
}
.radar-cont::after{
  content:'';position:absolute;inset:0;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.07)2px,rgba(0,0,0,.07)3px)
}
.radar-cont::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse at 28% 22%,rgba(255,255,255,.04)0%,transparent 55%),linear-gradient(135deg,rgba(255,255,255,.015)0%,transparent 50%)
}
.radar-grid{
  position:absolute;inset:0;opacity:.065;
  background-image:repeating-linear-gradient(0deg,rgba(0,255,65,.7)0px,transparent 1px,transparent 22px),repeating-linear-gradient(90deg,rgba(0,255,65,.7)0px,transparent 1px,transparent 22px)
}
.radar-ring{position:absolute;inset:6%;border:1px solid rgba(0,255,65,.1);border-radius:50%}
.radar-ring::before,.radar-ring::after{content:'';position:absolute;border-radius:50%;border:1px solid rgba(0,255,65,.07)}
.radar-ring::before{inset:25%}.radar-ring::after{inset:50%;border-color:rgba(0,255,65,.05)}
.radar-cross{
  position:absolute;inset:0;
  background:linear-gradient(90deg,transparent calc(50% - .5px),rgba(0,255,65,.06)calc(50% - .5px),rgba(0,255,65,.06)calc(50% + .5px),transparent calc(50% + .5px)),linear-gradient(0deg,transparent calc(50% - .5px),rgba(0,255,65,.06)calc(50% - .5px),rgba(0,255,65,.06)calc(50% + .5px),transparent calc(50% + .5px))
}
.radar-canvas{position:absolute;inset:0;width:100%;height:100%;z-index:5}
.radar-dots{position:absolute;inset:0;z-index:10}
.radar-dot{
  position:absolute;width:8px;height:8px;border-radius:50%;
  transform:translate(-50%,-50%);opacity:.35;will-change:transform,opacity,filter;
  transition:opacity .1s ease-out
}
.radar-dot.active{opacity:1;transform:translate(-50%,-50%) scale(2.2);filter:brightness(2) drop-shadow(0 0 6px currentColor)}
.radar-dot.purple{background:#b026ff;box-shadow:0 0 6px #b026ff}
.radar-dot.red{background:var(--war);box-shadow:0 0 6px var(--war)}
.radar-dot.ai{background:var(--aq);box-shadow:0 0 6px var(--aq)}

/* ‚îÄ‚îÄ RADAR ACTIONS ‚îÄ‚îÄ */
.radar-actions{
  display:flex;
  gap:12px;
  padding:16px 16px 8px;
  margin-top:4px
}
.action-btn{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:14px 0;
  border:none;
  border-radius:8px;
  font-family:'Space Mono',monospace;
  font-size:13px;
  font-weight:700;
  letter-spacing:1px;
  text-transform:uppercase;
  cursor:pointer;
  position:relative;
  box-shadow:0 4px 0 rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.1);
  transition:all .1s ease
}
.action-btn.left{
  background:linear-gradient(180deg,#1a2a2a,#0f1a1a);
  color:var(--as);
  border:1px solid #2a4a4a
}
.action-btn.right{
  background:linear-gradient(180deg,#2a1a1a,#1a0f0f);
  color:var(--ap);
  border:1px solid #4a2a2a
}
.action-btn:active{
  transform:translateY(3px);
  box-shadow:0 1px 0 rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.1)
}
.action-icon{font-size:18px}
.action-label{font-size:12px;letter-spacing:1.5px}
.action-badge{
  position:absolute;
  top:-4px;
  right:10px;
  min-width:20px;
  height:20px;
  background:var(--as);
  color:#000;
  font-size:10px;
  font-weight:800;
  border-radius:4px;
  display:none;
  align-items:center;
  justify-content:center;
  padding:0 6px;
  border:1px solid #000
}
.action-badge.show{display:flex}

.vt-dot-wrap{position:relative;width:14px;height:14px;flex-shrink:0}
.vt-dot-inner{width:8px;height:8px;background:#111;border:1px solid #1e1e1e;border-radius:50%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);transition:all .5s}
.vt-dot-wrap.has-tap .vt-dot-inner{animation:vt-breathe 3s ease-in-out infinite}
@keyframes vt-breathe{0%,100%{box-shadow:none;border-color:#1e1e1e}50%{box-shadow:0 0 0 3px rgba(30,30,30,.5);border-color:#2a2a2a}}

/* ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ */
.filter-sect{padding:16px;border-bottom:1px solid var(--bd)}
.filter-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.filter-title{font-size:11px;font-weight:700;color:var(--txs);letter-spacing:.5px}
.match-pct{font-family:'Space Mono',monospace;font-size:14px;color:var(--ap);font-weight:700}
.vibe-slider{
  width:100%;height:4px;background:var(--bd);border-radius:2px;
  outline:none;-webkit-appearance:none;display:block;margin-bottom:6px
}
.vibe-slider::-webkit-slider-thumb{
  -webkit-appearance:none;width:24px;height:24px;background:var(--ap);
  border:3px solid var(--bg);border-radius:50%;
  box-shadow:0 0 0 1px var(--ap),0 2px 8px rgba(255,61,0,.4);margin-top:-10px
}
.vibe-slider::-webkit-slider-runnable-track{
  height:4px;background:linear-gradient(90deg,var(--ap) 0%,var(--ap) 87%,var(--bd) 87%);border-radius:2px
}
.slider-labels{display:flex;justify-content:space-between;font-size:9px;color:var(--txm);font-weight:600;margin-top:4px;margin-bottom:12px}
.mood-scroll{display:flex;gap:8px;overflow-x:auto;margin:0 -16px;padding:0 16px 4px;scrollbar-width:none}
.mood-scroll::-webkit-scrollbar{display:none}
.mood-chip{
  flex-shrink:0;padding:10px 16px;background:var(--sf);border:1px solid var(--bd);
  border-radius:24px;font-size:12px;font-weight:600;color:var(--txs);white-space:nowrap;
  touch-action:manipulation;transition:all .15s;cursor:pointer;font-family:inherit
}
.mood-chip.active{background:var(--ap);border-color:var(--ap);color:#000}
.mood-chip:active{transform:scale(.95);opacity:.8}

/* ‚îÄ‚îÄ SPILLS ‚îÄ‚îÄ */
.spills-sect{padding:16px;padding-bottom:calc(80px + var(--safe-bottom))}
.sect-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.sect-title{font-size:11px;font-weight:700;letter-spacing:.5px;color:var(--txs)}
.sect-meta{font-family:'Space Mono',monospace;font-size:9px;color:var(--txm)}
.spill-card{background:var(--sf);border:1px solid var(--bd);border-radius:16px;margin-bottom:12px;overflow:hidden}
.spill-head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--bd);background:var(--bg)}
.spill-user{font-family:'Space Mono',monospace;font-size:11px;color:var(--txs);font-weight:600}
.spill-mood{font-size:10px;font-weight:700;padding:6px 12px;border-radius:20px;text-transform:uppercase;letter-spacing:.5px}
.spill-mood.surviving{color:var(--ms);background:rgba(255,149,0,.1)}
.spill-mood.thriving{color:var(--mt);background:rgba(57,255,20,.1)}
.spill-mood.chaotic{color:var(--mc);background:rgba(0,240,255,.1)}
.spill-mood.doom{color:var(--md);background:rgba(139,92,246,.1)}
.spill-body{padding:16px;font-size:15px;line-height:1.6;color:var(--tx)}
.spill-actions{
  display:flex;gap:8px;padding:12px 16px;border-top:1px solid var(--bd);
  background:var(--bg);overflow-x:auto;scrollbar-width:none
}
.spill-actions::-webkit-scrollbar{display:none}
.react-btn{
  display:flex;align-items:center;gap:6px;padding:10px 16px;
  background:var(--sf);border:1px solid var(--bd);border-radius:24px;
  font-size:14px;color:var(--txs);flex-shrink:0;touch-action:manipulation;
  transition:all .15s;cursor:pointer;font-family:inherit
}
.react-btn.active{background:var(--ap);border-color:var(--ap);color:#000}
.react-btn:active{transform:scale(.95)}
.react-count{font-family:'Space Mono',monospace;font-size:12px;font-weight:700;min-width:18px}
.refresh-btn{
  width:100%;padding:16px;background:transparent;border:1px dashed var(--bd);border-radius:16px;
  color:var(--txs);font-size:13px;font-weight:600;display:flex;align-items:center;
  justify-content:center;gap:8px;margin-top:8px;touch-action:manipulation;
  transition:all .15s;cursor:pointer;font-family:inherit
}
.refresh-btn:active{background:var(--sf)}
.empty-state{text-align:center;padding:60px 20px}
.empty-icon{font-size:48px;margin-bottom:16px;opacity:.5}
.empty-title{font-size:16px;font-weight:700;color:var(--txs);margin-bottom:6px}
.empty-text{font-size:13px;color:var(--txm)}

<!-- BOTTOM NAV (GANTI YANG INI) -->
<nav class="bottom-nav">
  <div class="nav-container">
    <a href="jejak.html" class="nav-item">
      <span class="nav-icon">‚ú¶</span>
      <span>Jejak</span>
    </a>
    <a href="spill.html" class="nav-item active">
      <span class="nav-icon">‚úï</span>
      <span>Spill</span>
    </a>
    <a href="glitch.html" class="nav-item">
      <span class="nav-icon">‚ö°</span>
      <span>Glitch</span>
    </a>
    <a href="cocomeo.html" class="nav-item">
      <span class="nav-icon">„Äú</span>
      <span>Cocomeo</span>
    </a>
  </div>
</nav>
  /* ‚îÄ‚îÄ MODAL GENDER ‚îÄ‚îÄ */
.modal{display:none;position:fixed;inset:0;background:var(--bg);z-index:200;flex-direction:column;overflow:hidden}
.modal.on{display:flex}
.modal-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:16px;padding-top:calc(16px + var(--safe-top));border-bottom:1px solid var(--bd)
}
.modal-title{
  font-size:17px;
  font-weight:700;
  letter-spacing:-.3px;
  color:var(--tx)
}
.modal-close{
  width:36px;height:36px;display:flex;align-items:center;justify-content:center;
  background:var(--sf);border:1px solid var(--bd);border-radius:10px;color:var(--txs);
  font-size:18px;touch-action:manipulation;cursor:pointer;transition:all .15s
}
.modal-close:active{background:var(--bd)}
.modal-body{
  flex:1;
  overflow-y:auto;
  padding:24px 20px calc(24px + var(--safe-bottom));
  -webkit-overflow-scrolling:touch
}
.modal-tag{
  font-family:'Space Mono',monospace;
  font-size:9px;
  color:var(--ap);
  margin-bottom:12px;
  letter-spacing:2px;
  font-weight:700;
  display:block;
  text-transform:uppercase
}
.modal-h{
  font-size:28px;
  font-weight:800;
  margin-bottom:8px;
  letter-spacing:-.5px;
  line-height:1.2;
  color:var(--tx)
}
.modal-sub{
  font-size:14px;
  color:var(--txs);
  margin-bottom:28px;
  line-height:1.5
}
.gender-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  margin-bottom:24px
}
.gender-card{
  background:var(--sf);
  border:1px solid var(--bd);
  border-radius:16px;
  padding:28px 16px;
  text-align:center;
  touch-action:manipulation;
  transition:all .15s;
  cursor:pointer
}
.gender-card.selected{
  border-color:var(--ap);
  background:rgba(255,61,0,.08)
}
.gender-card:active{transform:scale(.96)}
.gender-icon{
  font-size:36px;
  margin-bottom:12px;
  display:block
}
.gender-label{
  font-size:15px;
  font-weight:700;
  margin-bottom:4px;
  color:var(--tx)
}
.gender-desc{
  font-size:12px;
  color:var(--txs)
}
.info-box{
  background:var(--sf);
  border-left:3px solid var(--ap);
  padding:16px;
  margin-bottom:28px;
  border-radius:0 12px 12px 0
}
.info-box p{
  font-family:'Space Mono',monospace;
  font-size:11px;
  color:var(--txs);
  line-height:1.7
}
.info-box strong{
  color:var(--ap);
  font-weight:700
}
.modal-action-btn{
  width:100%;
  padding:18px;
  background:var(--ap);
  color:#000;
  border:none;
  border-radius:12px;
  font-size:15px;
  font-weight:700;
  letter-spacing:.3px;
  touch-action:manipulation;
  cursor:pointer;
  transition:all .15s;
  font-family:inherit;
  text-transform:uppercase;
  margin-bottom:16px
}
.modal-action-btn:disabled{
  opacity:.3;
  cursor:not-allowed
}
.modal-action-btn:active{
  transform:scale(.98)
}
.modal-hint{
  font-size:12px;
  color:var(--txm);
  text-align:center;
  line-height:1.6;
  padding:0 12px
}
.modal-hint-link{
  background:none;
  border:none;
  color:var(--as);
  font-size:12px;
  font-weight:700;
  cursor:pointer;
  text-decoration:underline;
  font-family:inherit;
  padding:0
}

/* ‚îÄ‚îÄ CHAT ROOM ‚îÄ‚îÄ */
.chat-room{display:none;position:fixed;inset:0;background:var(--bg);z-index:300;flex-direction:column}
.chat-room.on{display:flex}
.chat-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 16px;
  padding-top:calc(12px + var(--safe-top));
  border-bottom:1px solid var(--bd);
  background:var(--sf)
}
.chat-info{
  flex:1;
  display:flex;
  align-items:center;
  gap:8px
}
.eyes-container{
  display:flex;
  gap:6px;
  align-items:center
}
.eye{
  width:24px;
  height:24px;
  background:var(--bd);
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  animation: eyeMove 3s ease-in-out infinite
}
.eye::after{
  content:'';
  width:8px;
  height:8px;
  background:var(--aq);
  border-radius:50%;
  position:absolute;
  animation: pupilMove 3s ease-in-out infinite
}
.eye.left::after{left:4px}
.eye.right::after{right:4px}
@keyframes eyeMove{
  0%,100%{transform:translateX(0)}
  25%{transform:translateX(-2px)}
  75%{transform:translateX(2px)}
}
@keyframes pupilMove{
  0%,100%{transform:translate(0,0)}
  25%{transform:translate(-2px,-1px)}
  75%{transform:translate(2px,1px)}
}
.chat-timer{
  font-family:'Space Mono',monospace;
  font-size:16px;
  font-weight:700;
  color:var(--aq);
  background:var(--bg);
  padding:8px 14px;
  border-radius:10px;
  border:1px solid var(--bd);
  letter-spacing:-1px
}
.chat-timer.warn{
  color:var(--war);
  border-color:var(--war);
  animation:blink 1s infinite;
  background:rgba(255,0,64,.1)
}
.chat-close{
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:var(--bg);
  border:1px solid var(--bd);
  border-radius:12px;
  color:var(--txs);
  margin-left:12px;
  font-size:18px;
  touch-action:manipulation;
  cursor:pointer;
  transition:all .15s
}
.chat-close:active{background:var(--bd)}
.chat-messages{
  flex:1;
  overflow-y:auto;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:10px;
  -webkit-overflow-scrolling:touch
}
.chat-bubble{
  max-width:85%;
  padding:14px 18px;
  border-radius:20px;
  font-size:15px;
  line-height:1.5;
  word-wrap:break-word;
  animation:popIn .25s cubic-bezier(.175,.885,.32,1.275)
}
@keyframes popIn{
  from{opacity:0;transform:scale(.8) translateY(10px)}
  to{opacity:1;transform:scale(1) translateY(0)}
}
.chat-bubble.me{align-self:flex-end;background:var(--ap);color:#000;border-bottom-right-radius:6px;font-weight:600}
.chat-bubble.them{align-self:flex-start;background:var(--sf);border:1px solid var(--bd);border-bottom-left-radius:6px}
.chat-msg{display:flex;flex-direction:column;max-width:85%}
.chat-msg.own{align-self:flex-end}
.chat-msg.other{align-self:flex-start}
.chat-msg .chat-bubble{max-width:100%}
.own .chat-bubble{background:var(--ap);color:#000;border-bottom-right-radius:6px;font-weight:600;align-self:flex-end}
.other .chat-bubble{background:var(--sf);border:1px solid var(--bd);border-bottom-left-radius:6px;align-self:flex-start}
.chat-time{
  font-size:10px;
  color:var(--txm);
  margin-top:6px;
  font-family:'Space Mono',monospace;
  font-weight:600
}
.typing{
  display:flex;
  gap:4px;
  padding:18px 22px;
  background:var(--sf);
  border:1px solid var(--bd);
  border-radius:20px;
  border-bottom-left-radius:6px;
  align-self:flex-start;
  width:fit-content
}
.typing-dot{
  width:8px;
  height:8px;
  background:var(--aq);
  border-radius:50%;
  animation:typing 1.4s infinite
}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}
.chat-msg.searching-msg{align-self:center!important;max-width:90%!important}
.searching-msg .chat-bubble{
  background:var(--sfe)!important;
  color:var(--txs)!important;
  border:1px dashed var(--aq)!important;
  font-style:italic;
  text-align:center
}
.distress{
  display:none;
  padding:14px 16px;
  background:var(--war);
  color:#fff;
  font-size:12px;
  font-weight:700;
  text-align:center;
  letter-spacing:.3px
}
.distress.show{display:block}
.chat-input-wrap{
  padding:12px 16px;
  padding-bottom:calc(12px + var(--safe-bottom));
  border-top:1px solid var(--bd);
  background:var(--sf);
  display:flex;
  gap:10px;
  align-items:center
}
.vt-trigger{
  width:40px;
  height:48px;
  background:transparent;
  border:1px solid #1a1a1a;
  color:#333;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-shrink:0;
  cursor:pointer;
  border-radius:12px;
  font-size:13px;
  transition:all .2s
}
.vt-trigger:hover{border-color:#333;color:#555}
.chat-input{
  flex:1;
  background:var(--bg);
  border:1px solid var(--bd);
  border-radius:24px;
  padding:14px 18px;
  font-size:15px;
  color:var(--tx);
  outline:none;
  -webkit-appearance:none;
  transition:all .15s;
  font-family:inherit
}
.chat-input:focus{border-color:var(--ap)}
.chat-send{
  width:48px;
  height:48px;
  background:var(--ap);
  border:none;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#000;
  font-size:20px;
  flex-shrink:0;
  touch-action:manipulation;
  cursor:pointer;
  box-shadow:0 4px 0 rgba(255,61,0,.3);
  transition:all .15s
}
.chat-send:active{
  transform:translateY(4px);
  box-shadow:0 0 0 rgba(255,61,0,.3)
}

/* ‚îÄ‚îÄ WHISPERER (PREMIUM FEATURE) ‚îÄ‚îÄ */
.ws-premium-badge{
  background:linear-gradient(90deg, var(--as), var(--aq));
  color:#000;
  font-size:9px;
  font-weight:700;
  padding:2px 8px;
  border-radius:30px;
  display:inline-block;
  margin-left:6px;
  text-transform:uppercase;
}
.ws-premium-lock{
  background:var(--sfe);
  border:1px dashed var(--as);
  border-radius:16px;
  padding:30px 20px;
  text-align:center;
  margin:20px 0;
}
.ws-premium-lock .icon{font-size:48px; margin-bottom:12px; opacity:0.5;}
.ws-premium-lock .title{font-size:16px; font-weight:700; color:var(--tx); margin-bottom:6px;}
.ws-premium-lock .desc{font-size:12px; color:var(--txs); margin-bottom:20px;}
.ws-premium-btn{
  background:linear-gradient(90deg, var(--as), var(--aq));
  color:#000;
  border:none;
  padding:12px 24px;
  border-radius:30px;
  font-weight:700;
  font-size:13px;
  cursor:pointer;
  font-family:inherit;
  display:inline-block;
}
.ws-feature-list{
  display:flex;
  flex-direction:column;
  gap:8px;
  margin-bottom:20px
}
.ws-feature{
  font-size:12px;
  color:var(--txs);
  padding:10px 14px;
  background:var(--sfe);
  border-left:2px solid var(--as);
  border-radius:0 8px 8px 0;
  font-weight:600
}
.ws-price-box{
  background:var(--sf);
  border:1px solid rgba(0,240,255,.25);
  padding:20px;
  text-align:center;
  margin-bottom:20px;
  border-radius:16px
}
.ws-price{
  font-size:40px;
  font-weight:800;
  color:var(--as);
  letter-spacing:-2px;
  line-height:1
}
.ws-price-sub{
  font-size:11px;
  color:var(--txm);
  margin-top:6px;
  text-transform:uppercase;
  letter-spacing:.1em;
  font-weight:700;
  font-family:'Space Mono',monospace
}
.ws-inbox-hdr{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px
}
.ws-compose-btn{
  background:var(--as);
  color:#000;
  border:none;
  padding:10px 18px;
  font-size:12px;
  font-weight:700;
  border-radius:10px;
  cursor:pointer;
  font-family:inherit;
  touch-action:manipulation
}
.ws-compose-btn:active{opacity:.8}
.ws-thread-item{
  background:var(--sf);
  border:1px solid var(--bd);
  border-radius:14px;
  padding:14px 16px;
  margin-bottom:8px;
  display:flex;
  align-items:center;
  gap:12px;
  cursor:pointer;
  touch-action:manipulation;
  transition:all .15s;
  position:relative;
  overflow:hidden
}
.ws-thread-item.premium{
  border-color:var(--as);
  box-shadow:0 0 0 1px var(--as);
}
.ws-thread-item::before{
  content:'';
  position:absolute;
  left:0;
  top:0;
  bottom:0;
  width:3px;
  background:var(--as);
  opacity:0;
  transition:opacity .15s;
  border-radius:3px 0 0 3px
}
.ws-thread-item.unread::before{opacity:1}
.ws-thread-item:active{transform:scale(.98)}
.ws-avatar{
  width:40px;
  height:40px;
  background:var(--sfe);
  border:1px solid var(--bd);
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:16px;
  font-weight:800;
  color:var(--txs);
  flex-shrink:0
}
.ws-thread-info{flex:1;min-width:0}
.ws-thread-name{
  font-size:13px;
  font-weight:700;
  color:var(--tx);
  margin-bottom:3px
}
.ws-thread-preview{
  font-size:11px;
  color:var(--txm);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis
}
.ws-thread-right{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:5px;
  flex-shrink:0
}
.ws-thread-time{
  font-size:9px;
  color:var(--txm);
  font-family:'Space Mono',monospace
}
.ws-unread-badge{
  min-width:20px;
  height:20px;
  background:var(--as);
  color:#000;
  font-size:9px;
  font-weight:800;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:0 5px
}
.ws-empty{
  text-align:center;
  padding:40px 0
}
.ws-empty-icon{
  font-size:36px;
  display:block;
  margin-bottom:12px;
  opacity:.3
}
.ws-empty-title{
  font-size:15px;
  font-weight:700;
  color:var(--txs);
  margin-bottom:4px
}
.ws-empty-sub{
  font-size:12px;
  color:var(--txm)
}
.ws-compose{
  display:none;
  position:fixed;
  inset:0;
  background:var(--bg);
  z-index:350;
  flex-direction:column
}
.ws-compose.on{display:flex}
.ws-compose-head{
  display:flex;
  align-items:center;
  gap:12px;
  padding:14px 16px;
  padding-top:calc(14px + var(--safe-top));
  border-bottom:1px solid var(--bd);
  background:var(--sf)
}
.ws-to-label{
  font-size:11px;
  font-weight:700;
  color:var(--txm);
  white-space:nowrap;
  font-family:'Space Mono',monospace
}
.ws-to-input{
  flex:1;
  background:transparent;
  border:none;
  border-bottom:1px solid var(--bd);
  color:var(--tx);
  font-size:16px;
  font-family:inherit;
  padding:4px 0;
  outline:none;
  transition:border-color .15s
}
.ws-to-input:focus{border-bottom-color:var(--as)}
.ws-to-input::placeholder{color:var(--txm)}
.ws-close-btn{
  width:36px;
  height:36px;
  background:var(--bg);
  border:1px solid var(--bd);
  border-radius:10px;
  color:var(--txs);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-size:16px;
  flex-shrink:0
}
.ws-body{
  flex:1;
  background:transparent;
  border:none;
  color:var(--tx);
  font-family:inherit;
  font-size:16px;
  line-height:1.6;
  resize:none;
  padding:20px 16px;
  outline:none
}
.ws-body::placeholder{color:var(--txm)}
.ws-compose-foot{
  padding:12px 16px;
  padding-bottom:calc(12px + var(--safe-bottom));
  border-top:1px solid var(--bd);
  background:var(--sf);
  display:flex;
  justify-content:space-between;
  align-items:center
}
.ws-char-count{
  font-size:10px;
  color:var(--txm);
  font-family:'Space Mono',monospace
}
.ws-send-btn{
  background:var(--as);
  color:#000;
  border:none;
  padding:12px 24px;
  font-size:13px;
  font-weight:700;
  border-radius:12px;
  cursor:pointer;
  font-family:inherit;
  transition:all .15s;
  box-shadow:0 4px 0 rgba(0,240,255,.2)
}
.ws-send-btn:active{
  transform:translateY(3px);
  box-shadow:none
}
.ws-send-btn:disabled{
  opacity:.3;
  cursor:not-allowed;
  box-shadow:none
}
.ws-thread{
  display:none;
  position:fixed;
  inset:0;
  background:var(--bg);
  z-index:350;
  flex-direction:column
}
.ws-thread.on{display:flex}
.ws-thread-head{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px 16px;
  padding-top:calc(12px + var(--safe-top));
  border-bottom:1px solid var(--bd);
  background:var(--sf)
}
.ws-back-btn{
  width:36px;
  height:36px;
  background:var(--bg);
  border:1px solid var(--bd);
  border-radius:10px;
  color:var(--txs);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-size:18px;
  flex-shrink:0;
  touch-action:manipulation
}
.ws-thread-title{
  flex:1;
  font-size:15px;
  font-weight:700
}
.ws-vt-btn{
  background:transparent;
  border:1px solid #1a1a1a;
  color:#333;
  width:36px;
  height:36px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-size:12px;
  transition:all .2s;
  flex-shrink:0
}
.ws-vt-btn:hover{
  border-color:#333;
  color:#555
}
.ws-thread-msgs{
  flex:1;
  overflow-y:auto;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:10px;
  -webkit-overflow-scrolling:touch
}
.ws-thread-input-wrap{
  padding:12px 16px;
  padding-bottom:calc(12px + var(--safe-bottom));
  border-top:1px solid var(--bd);
  background:var(--sf);
  display:flex;
  gap:10px;
  align-items:center
}
.ws-thread-input{
  flex:1;
  background:var(--bg);
  border:1px solid var(--bd);
  border-radius:24px;
  padding:14px 18px;
  font-size:15px;
  color:var(--tx);
  outline:none;
  font-family:inherit;
  transition:border-color .15s
}
.ws-thread-input:focus{border-color:var(--as)}
.ws-thread-send{
  width:48px;
  height:48px;
  background:var(--as);
  border:none;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#000;
  font-size:20px;
  flex-shrink:0;
  cursor:pointer;
  touch-action:manipulation;
  transition:all .15s;
  box-shadow:0 4px 0 rgba(0,240,255,.2)
}
.ws-thread-send:active{
  transform:translateY(4px);
  box-shadow:none
}

/* ‚îÄ‚îÄ VOID TAP ‚îÄ‚îÄ */
.vt-compose{
  display:none;
  position:fixed;
  inset:0;
  background:#000;
  z-index:500;
  flex-direction:column;
  align-items:stretch;
  justify-content:center
}
.vt-compose.on{display:flex;animation:vtFade .2s ease}
@keyframes vtFade{from{opacity:0}to{opacity:1}}
.vt-compose-inner{
  max-width:480px;
  width:100%;
  margin:0 auto;
  padding:40px 24px;
  display:flex;
  flex-direction:column;
  gap:28px
}
.vt-lbl{
  font-size:9px;
  font-weight:700;
  color:#2a2a2a;
  text-transform:uppercase;
  letter-spacing:.2em;
  font-family:'Space Mono',monospace
}
.vt-textarea{
  background:transparent;
  border:none;
  border-bottom:1px solid #1a1a1a;
  color:#444;
  font-family:'Inter',sans-serif;
  font-size:18px;
  line-height:1.7;
  resize:none;
  height:130px;
  outline:none;
  caret-color:#333;
  padding:8px 0
}
.vt-textarea::placeholder{color:#1a1a1a;font-style:italic}
.vt-textarea:focus{border-bottom-color:#252525}
.vt-meta{
  display:flex;
  justify-content:space-between;
  align-items:center
}
.vt-quota{
  font-size:10px;
  color:#222;
  font-family:'Space Mono',monospace
}
.vt-quota.low{color:#331111}
.vt-actions{
  display:flex;
  gap:8px
}
.vt-cancel{
  background:transparent;
  border:1px solid #181818;
  color:#2a2a2a;
  padding:10px 18px;
  font-size:11px;
  font-weight:700;
  text-transform:uppercase;
  cursor:pointer;
  font-family:inherit;
  border-radius:8px
}
.vt-cancel:hover{
  border-color:#2a2a2a;
  color:#444
}
.vt-send{
  background:#0a0a0a;
  border:1px solid #1e1e1e;
  color:#333;
  padding:10px 22px;
  font-size:11px;
  font-weight:700;
  text-transform:uppercase;
  cursor:pointer;
  font-family:inherit;
  border-radius:8px;
  transition:all .15s
}
.vt-send:hover:not(:disabled){
  border-color:#333;
  color:#666
}
.vt-send:disabled{
  opacity:.2;
  cursor:not-allowed
}
.vt-reader{
  display:none;
  position:fixed;
  inset:0;
  background:#000;
  z-index:500;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  user-select:none
}
.vt-reader.on{display:flex;animation:vtFade .2s ease}
.vt-reader-from{
  position:absolute;
  top:calc(52px + var(--safe-top));
  left:50%;
  transform:translateX(-50%);
  font-size:9px;
  color:#1a1a1a;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.25em;
  white-space:nowrap;
  font-family:'Space Mono',monospace
}
.vt-reader-msg{
  max-width:300px;
  padding:0 24px;
  text-align:center;
  color:#3d3d3d;
  font-size:17px;
  line-height:1.8
}
.vt-reader-timer{
  position:absolute;
  bottom:calc(52px + var(--safe-bottom));
  left:50%;
  transform:translateX(-50%);
  font-family:'Space Mono',monospace;
  font-size:10px;
  color:#1e1e1e;
  letter-spacing:.15em;
  text-transform:uppercase
}
.vt-reader.burning .vt-reader-msg,
.vt-reader.burning .vt-reader-timer,
.vt-reader.burning .vt-reader-from{
  animation:vtBurn .7s ease forwards
}
@keyframes vtBurn{
  0%{opacity:1;filter:none}
  50%{opacity:.4;filter:blur(2px)}
  100%{opacity:0;filter:blur(12px)}
}
.vt-upgrade-nudge{
  display:none;
  position:fixed;
  bottom:calc(84px + var(--safe-bottom));
  left:50%;
  transform:translateX(-50%) translateY(16px);
  background:#0a0a0a;
  border:1px solid #1a1a1a;
  padding:12px 20px;
  font-size:12px;
  color:#333;
  white-space:nowrap;
  z-index:400;
  opacity:0;
  transition:all .3s;
  cursor:pointer;
  border-radius:20px
}
.vt-upgrade-nudge.show{
  display:block;
  opacity:1;
  transform:translateX(-50%) translateY(0)
}
.vt-upgrade-nudge b{color:#555}

/* TOAST */
.toast{
  position:fixed;
  bottom:100px;
  left:50%;
  transform:translateX(-50%) translateY(100px);
  background:var(--tx);
  color:var(--bg);
  padding:14px 24px;
  border-radius:30px;
  font-size:14px;
  font-weight:700;
  z-index:600;
  opacity:0;
  transition:all .3s cubic-bezier(.175,.885,.32,1.275);
  pointer-events:none;
  white-space:nowrap;
  box-shadow:0 10px 40px rgba(0,0,0,.5)
}
.toast.show{
  opacity:1;
  transform:translateX(-50%) translateY(0)
}
.toast.error{
  background:var(--war);
  color:#fff
}
</style>
</head>
<body>
<div class="app">

<!-- HEADER -->
<div class="header">
  <div class="logo">SP<span>‚úï</span>LL</div>
  <div class="status"><div class="pulse"></div></div>
</div>

<!-- SCROLL AREA -->
<div class="scroll">

<!-- RADAR -->
<div class="radar-sect">
  <div class="radar-header">
    <span class="radar-label">VIBE RADAR</span>
    <span class="radar-stat" id="onlineCount">21 ONLINE</span>
  </div>
  <div class="radar-wrapper">
    <div class="radar-bezel">
      <div class="radar-screw screw-tl"></div>
      <div class="radar-screw screw-tr"></div>
      <div class="radar-screw screw-bl"></div>
      <div class="radar-screw screw-br"></div>
      <div class="radar-bezel-label">VIBE RADAR ‚Äî SYS ACTIVE</div>
      <div class="radar-cont" id="radarCont">
        <div class="radar-grid"></div>
        <div class="radar-ring"></div>
        <div class="radar-cross"></div>
        <canvas class="radar-canvas" id="radarCanvas"></canvas>
        <div class="radar-dots" id="radarDots"></div>
      </div>
      <div class="radar-bezel-range"><span>0.5km</span><span>RNG</span><span>50km</span></div>
    </div>
  </div>
  
    <!-- CTA VIBE CHECK (ORANGE DI TENGAH, 40% LEBAR) -->
<div style="display:flex; justify-content:center; margin:16px 0 8px 0;">
  <button onclick="startVibeCheck()" style="
    width:40%;
    max-width:180px;
    background:var(--ap);
    border:none;
    border-radius:40px;
    padding:14px 0;
    box-shadow:0 4px 0 rgba(255,61,0,0.3), 0 0 20px rgba(255,61,0,0.3);
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    transition:all 0.2s ease;
    font-family:'Space Mono',monospace;
  " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 0 rgba(255,61,0,0.3), 0 0 30px rgba(255,61,0,0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 0 rgba(255,61,0,0.3), 0 0 20px rgba(255,61,0,0.3)';">
    <span style="font-size:18px; color:#000;">‚¨°</span>
    <span style="font-size:14px; font-weight:700; color:#000; letter-spacing:1px;">VIBE CHECK</span>
  </button>
</div>
  
  <!-- ===== CTA WHISPERER (STEALTH MODE - FULL WIDTH) ===== -->
  <button onclick="openWsModal()" id="wsStealthBtn" style="
    width:100%;
    background:var(--sf);
    border:none;
    padding:16px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
    cursor:pointer;
    transition:all 0.2s ease;
    font-family:'Inter',sans-serif;
    color:var(--txs);
    position:relative;
    margin-top:4px;
  " onmouseover="this.style.backgroundColor='#151515'" onmouseout="this.style.backgroundColor='var(--sf)'">
    
    <!-- ICON & LABEL -->
    <span style="font-size:18px; color:var(--txs); transition:color 0.3s ease;" id="wsIcon">‚ú¶</span>
    <span style="font-size:13px; font-weight:400; letter-spacing:0.5px; color:var(--txs); transition:color 0.3s ease;" id="wsLabel">WHISPERER</span>
    
    <!-- BADGE NOTIF (HANYA MUNCUL KALAU ADA PESAN) -->
    <span id="wsStealthBadge" style="
      display:none;
      background:var(--tx);
      color:var(--bg);
      font-size:10px;
      font-weight:700;
      padding:4px 10px;
      border-radius:30px;
      margin-left:8px;
      animation:stealthPulse 2s ease-in-out infinite;
    ">‚ú¶ new</span>
  </button>

<!-- FILTER -->
<div class="filter-sect">
  <div class="filter-top">
    <span class="filter-title">KESELARASAN</span>
    <span class="match-pct" id="vibePct">87%</span>
  </div>
  <input type="range" class="vibe-slider" id="vibeSlider" min="0" max="100" value="87" oninput="updateVibePct(this.value)">
  <div class="slider-labels"><span>Homie</span><span>Semi</span><span>All</span></div>
  <div class="mood-scroll">
    <button class="mood-chip active" data-mood="all" onclick="filterMood(this)">Semua</button>
    <button class="mood-chip" data-mood="surviving" onclick="filterMood(this)">üòÆ‚Äçüí® Surviving</button>
    <button class="mood-chip" data-mood="thriving" onclick="filterMood(this)">‚ú® Thriving</button>
    <button class="mood-chip" data-mood="chaotic" onclick="filterMood(this)">üåÄ Chaotic</button>
    <button class="mood-chip" data-mood="doom" onclick="filterMood(this)">üõå Doom</button>
  </div>
</div>

<!-- SPILLS -->
<div class="spills-sect">
  <div class="sect-header">
    <span class="sect-title">SPILL TERKINI</span>
    <span class="sect-meta">FIFO</span>
  </div>
  <div id="spillsList"></div>
  <button class="refresh-btn" onclick="refreshSpills()">
    <div class="vt-dot-wrap" id="vtIndicator" onclick="event.stopPropagation();checkVoidTaps()">
      <div class="vt-dot-inner"></div>
    </div>
    <span>‚Üª</span>
    <span>Seduh Teh Baru</span>
  </button>
</div>

</div><!-- /scroll -->

<!-- BOTTOM NAV -->
<nav class="bnav">
  <div class="bnav-inner">
    <a href="#" class="nav-item active" onclick="return false"><span class="nav-icon">‚úï</span><span>Spill</span></a>
    <a href="#" class="nav-item" onclick="return false"><span class="nav-icon">‚ú¶</span><span>Jejak</span></a>
    <a href="#" class="nav-item" onclick="return false"><span class="nav-icon">‚ö°</span><span>Glitch</span></a>
    <a href="#" class="nav-item" onclick="return false"><span class="nav-icon">‚¨°</span><span>Cocomeo</span></a>
  </div>
</nav>

</div><!-- /app -->

<!-- MODAL GENDER -->
<div class="modal" id="genderModal">
  <div class="modal-header">
    <div class="modal-title">pilih gender</div>
    <button class="modal-close" onclick="closeModal('genderModal')">‚úï</button>
  </div>
  <div class="modal-body">
    <span class="modal-tag">STEP 1/2</span>
    <div class="modal-h">vibe check butuh konteks</div>
    <div class="modal-sub">biar algoritma bisa match kamu dengan vibe yang tepat</div>
    
    <div class="gender-grid">
      <div class="gender-card" onclick="selectGender(this,'female')">
        <span class="gender-icon">‚ôÄÔ∏è</span>
        <span class="gender-label">Cewek</span>
        <span class="gender-desc">connect with similar vibes</span>
      </div>
      <div class="gender-card" onclick="selectGender(this,'male')">
        <span class="gender-icon">‚ôÇÔ∏è</span>
        <span class="gender-label">Cowok</span>
        <span class="gender-desc">find your wavelength</span>
      </div>
    </div>
    
    <div class="info-box">
      <p>üîí <strong>privacy first</strong> ‚Äî gender cuma dipakai buat matching sesi, ga disimpan & ga muncul di profil</p>
      <p style="margin-top:8px; color:var(--aq)">‚ö†Ô∏è <strong>Jangan pernah ungkap data pribadi ‚Äî stay safe, stay anonim</strong></p>
    </div>
    
    <button class="modal-action-btn" id="confirmGenderBtn" onclick="confirmGender()" disabled>GASKEUN ‚Üí</button>
    
    <div class="modal-hint">dengan lanjut, kamu setuju sama <button class="modal-hint-link" onclick="alert('kebijakan anonim: ga ada log, ga ada trace')">kebijakan anonim</button></div>
  </div>
</div>

<!-- UPGRADE MODAL -->
<div class="modal" id="upgradeModal">
  <div class="modal-header">
    <div class="modal-title">upgrade plan</div>
    <button class="modal-close" onclick="closeModal('upgradeModal')">‚úï</button>
  </div>
  <div class="modal-body">
    <span class="modal-tag">VIP ACCESS</span>
    <div class="modal-h">pilih paket yang cocok</div>
    <div class="modal-sub">tinggal pilih, bayar via Midtrans, langsung aktif</div>
    
    <div class="price-card" onclick="selectPlan(this, 'weekly')">
      <div>
        <div class="price-main">Rp 10K</div>
        <div class="price-sub">7 hari</div>
      </div>
      <div class="price-right">
        <span class="price-tag">BASIC</span>
        <div class="price-note">‚úÖ chat tanpa batas</div>
      </div>
    </div>
    
    <div class="price-card" onclick="selectPlan(this, 'monthly')">
      <div>
        <div class="price-main">Rp 50K</div>
        <div class="price-sub">30 hari</div>
      </div>
      <div class="price-right">
        <span class="price-tag">‚ú® PREMIUM</span>
        <div class="price-note">‚úÖ chat tanpa batas + WHISPERER ‚ú¶</div>
      </div>
    </div>
    
    <!-- PREMIUM FEATURES DETAIL -->
    <div style="background:var(--sf); border:1px solid var(--bd); border-radius:16px; padding:16px; margin:20px 0;">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
        <span style="color:var(--aq); font-size:18px;">‚ú¶</span>
        <span style="font-weight:700; font-size:14px;">WHISPERER (Premium 50K)</span>
      </div>
      <div style="font-size:12px; color:var(--txs); line-height:1.8;">
        ‚Ä¢ ‚ú¶ pesan rahasia yang terenkripsi<br>
        ‚Ä¢ ‚è≥ hilang dalam 5 detik setelah dibaca<br>
        ‚Ä¢ üîí tidak ada log, tidak ada jejak<br>
        ‚Ä¢ üí¨ chat paging tanpa batas
      </div>
    </div>
    
    <div class="timer-big">
      <div class="num">24:00:00</div>
      <div class="label">offer berakhir</div>
    </div>
    
    <button class="modal-action-btn" onclick="processUpgrade()">upgrade sekarang</button>
    <button class="modal-action-btn sec" onclick="closeModal('upgradeModal')" style="background:var(--sf); color:var(--tx); border:1px solid var(--bd); margin-top:8px">nanti dulu</button>
  </div>
</div>

<!-- CHAT ROOM -->
<div class="chat-room" id="chatRoom">
  <div class="chat-head">
    <div class="chat-info">
      <div class="eyes-container">
        <div class="eye left"></div>
        <div class="eye right"></div>
      </div>
    </div>
    <div class="chat-timer" id="chatTimer">15:00</div>
    <button class="chat-close" onclick="closeChat()">‚úï</button>
  </div>
  <div class="distress" id="distressMsg">‚ö†Ô∏è partner terdeteksi toxic ‚Äî tim sedang investigasi</div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input-wrap">
    <button class="vt-trigger" onclick="openVtCompose()" title="void tap">‚¨°</button>
    <input type="text" class="chat-input" id="chatInput" placeholder="ketik sesuatu..." maxlength="200">
    <button class="chat-send" onclick="sendMsg()">‚û§</button>
  </div>
</div>

<!-- WHISPERER MODAL -->
<div class="modal" id="wsModal">
  <div class="modal-header">
    <div class="modal-title">whisperer 
      <span class="ws-premium-badge" id="wsPremiumBadge" style="display:none;">PREMIUM</span>
    </div>
    <button class="modal-close" onclick="closeModal('wsModal')">‚úï</button>
  </div>
  <div class="modal-body" id="wsModalBody">
    <!-- Konten akan diisi oleh JavaScript -->
  </div>
</div>

<!-- WHISPERER COMPOSE -->
<div class="ws-compose" id="wsComposeScreen">
  <div class="ws-compose-head">
    <span class="ws-to-label">to:</span>
    <input type="text" class="ws-to-input" id="wsToInput" placeholder="username tujuan" maxlength="30">
    <button class="ws-close-btn" onclick="closeWsCompose()">‚úï</button>
  </div>
  <textarea class="ws-body" id="wsBodyInput" placeholder="tulis pesan rahasia... (akan hilang 5 detik setelah dibaca)" maxlength="200"></textarea>
  <div class="ws-compose-foot">
    <span class="ws-char-count" id="wsCharCount">0/200</span>
    <button class="ws-send-btn" id="wsSendBtn" onclick="sendWs()" disabled>kirim</button>
  </div>
</div>

<!-- WHISPERER THREAD -->
<div class="ws-thread" id="wsThreadScreen">
  <div class="ws-thread-head">
    <button class="ws-back-btn" onclick="closeWsThread()">‚Üê</button>
    <span class="ws-thread-title" id="wsThreadTitle">whisper</span>
    <button class="ws-vt-btn" onclick="openVtCompose()">‚¨°</button>
  </div>
  <div class="ws-thread-msgs" id="wsThreadMessages"></div>
  <div class="ws-thread-input-wrap">
    <input type="text" class="ws-thread-input" id="wsThreadInput" placeholder="balas whisper... (akan hilang)" maxlength="200">
    <button class="ws-thread-send" onclick="sendWsReply()">‚û§</button>
  </div>
</div>

<!-- VOID TAP COMPOSE -->
<div class="vt-compose" id="vtCompose">
  <div class="vt-compose-inner">
    <span class="vt-lbl">void tap ‚Äî pesan yang menghilang</span>
    <textarea class="vt-textarea" id="vtTextarea" placeholder="tulis sesuatu yang akan terbaca sekali & hilang..." maxlength="150"></textarea>
    <div class="vt-meta">
      <span class="vt-quota" id="vtQuota">sisa 3/3 hari ini</span>
      <span class="vt-quota" id="vtCharCount">0/150</span>
    </div>
    <div class="vt-actions">
      <button class="vt-cancel" onclick="closeVtCompose()">batal</button>
      <button class="vt-send" id="vtSendBtn" onclick="sendVoidTap()" disabled>kirim</button>
    </div>
  </div>
</div>

<!-- VOID TAP READER -->
<div class="vt-reader" id="vtReader">
  <span class="vt-reader-from" id="vtReaderFrom">dari: @anonymous</span>
  <div class="vt-reader-msg" id="vtReaderMsg">pesan akan muncul di sini</div>
  <span class="vt-reader-timer" id="vtReaderTimer">menghilang dalam 5s</span>
</div>

<!-- UPGRADE NUDGE -->
<div class="vt-upgrade-nudge" id="vtUpgradeNudge" onclick="showUpgradeModal()">limit harian habis ‚Äî <b>upgrade</b></div>
<div class="toast" id="toast"></div>
<script>
// ==================== KONFIGURASI API ====================
const API_URL = 'https://jejak.space/api/chat';
const USE_MOCK = false;

// ==================== STATE ====================
let currentGender = null;
let chatPartner = null;
let timerInterval = null;
let chatTimeLeft = 900; // 15 menit
let selectedPlan = null;
let activeMood = 'all';
let radarInterval;
let radarRAF = null;
let userName = 'stranger_' + Math.floor(Math.random() * 1000);
let activeWsThread = null;
let vtBurnTimer = null;
let countdownInterval = null;

// Subscription state
let userSubscription = {
  isActive: false,
  expiresAt: null,
  type: null // 'weekly' atau 'monthly'
};

// Premium features
let wsQuota = {
  used: 0,
  limit: 999 // Unlimited untuk premium
};

// History chat
let chatHistory = [];

// Timer untuk fallback ke AI (15 detik)
let fallbackTimer = null;

// Flag API
let apiOffline = false;

// Daftar karakter AI
const AI_CHARACTERS = {
  female: ['beby.manis', 'strawberry.shortcake', 'pretty.sad', 'little.fairy', 'cinnamon.girl'],
  male: ['sejuta.badai', 'kue.bulan', 'agak.koplak', 'chili.padi', 'abang.gaul']
};

// Data void taps
let voidTaps = [
  { id: 'vt1', from: 'anonymous', content: 'ada yang pernah ngerasa jadi background character di hidup sendiri?', timestamp: Date.now() - 300000, read: false },
  { id: 'vt2', from: 'anonymous', content: 'kadang pengen ilang tanpa jejak, tapi takut ga ada yang nyari', timestamp: Date.now() - 600000, read: false }
];

// Data whisper
let whispers = [
  { id: 'w1', from: 'strawberry.shortcake', to: userName, content: 'halo, liat postingan kamu, relate banget', timestamp: Date.now() - 120000, read: false, thread: [] },
  { id: 'w2', from: 'sejuta.badai', to: userName, content: 'salam kenal, boleh ngobrol?', timestamp: Date.now() - 360000, read: true, thread: [] }
];

// Data spill
const USER_RANTS = [
  {id:1,author:'anon.kucing',mood:'surviving',content:'Hari ini gue nangis di angkot gegara liat kucing dipukul orang. Mental gue udah kayak kerupuk kena hujan.',reactions:{skull:42,cry:89,fire:12,upside:7},userReacted:null},
  {id:2,author:'sleepy.head',mood:'thriving',content:'akhirnya bisa tidur nyenyak semalaman setelah 3 minggu insomnia. makasih buat yang chat tadi malem.',reactions:{skull:23,cry:15,fire:67,upside:31},userReacted:null},
  {id:3,author:'chaos.queen',mood:'chaotic',content:'hari ini chaos abis! dari bangun tidur udah salah ambil kaki, sampe kantor lupa bawa laptop.',reactions:{skull:89,cry:23,fire:45,upside:78},userReacted:null},
  {id:4,author:'quiet.one',mood:'doom',content:'udah seminggu nggak keluar kamar. bukan karena sibuk. cuma nggak tau mau ngapain.',reactions:{skull:67,cry:112,fire:8,upside:34},userReacted:null}
];

const REACTION_EMOJI = {skull:'üíÄ',cry:'üò≠',fire:'üî•',upside:'üôÉ'};

// ==================== TERMS & CONDITIONS ====================
const TERMS_TEXT = `
Dengan melanjutkan pembayaran, kamu setuju bahwa:

1. üîÑ Layanan ini adalah subscription digital untuk fitur premium di aplikasi SPILL.

2. ‚è∞ Masa aktif subscription:
   ‚Ä¢ Paket 7 hari (10K): chat tanpa batas
   ‚Ä¢ Paket 30 hari (50K): chat tanpa batas + WHISPERER (pesan rahasia hilang 5 detik)

3. üí≥ Pembayaran diproses oleh Midtrans dengan metode:
   ‚Ä¢ Transfer bank (BCA, Mandiri, BNI, BRI)
   ‚Ä¢ E-wallet (GoPay, OVO, Dana, LinkAja)
   ‚Ä¢ Kartu kredit/debit

4. ‚ö° Fitur premium yang didapat:
   ‚Ä¢ Chat tanpa batas waktu
   ‚Ä¢ Prioritas koneksi ke real user
   ‚Ä¢ Void tap unlimited
   ‚Ä¢ [PREMIUM 50K] WHISPERER - pesan rahasia terenkripsi yang hilang 5 detik setelah dibaca

5. üö´ Tidak ada refund untuk paket yang sudah dibeli (kecuali error sistem)

6. üîí Data pembayaran aman - SPILL tidak menyimpan data kartu

7. ‚è≥ Subscription otomatis berakhir sesuai masa aktif, tidak ada auto-renewal

8. ‚ùì Ada kendala? Hubungi @spill.support di app

Dengan melanjutkan, kamu menyetujui syarat dan ketentuan di atas.
`;

// Load subscription from localStorage
function loadSubscription() {
  const saved = localStorage.getItem('userSubscription');
  if (saved) {
    try {
      const sub = JSON.parse(saved);
      if (new Date(sub.expiresAt) > new Date()) {
        userSubscription = sub;
      } else {
        localStorage.removeItem('userSubscription');
      }
    } catch (e) {}
  }
}

// Check subscription
function checkSubscription() {
  if (userSubscription.isActive && userSubscription.expiresAt) {
    return new Date(userSubscription.expiresAt) > new Date();
  }
  return false;
}

// ==================== UTILS ====================
const $ = id => document.getElementById(id);
const esc = t => { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; };

function toast(msg, isErr = false) {
  const t = $('toast');
  t.textContent = msg;
  t.className = 'toast' + (isErr ? ' error' : '');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function closeModal(id) {
  $(id).classList.remove('on');
}

function updateVibePct(val) {
  $('vibePct').textContent = val + '%';
}

function filterMood(btn) {
  document.querySelectorAll('.mood-chip').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  activeMood = btn.dataset.mood;
  renderSpills();
}

// ==================== SPILLS ====================
function generateSpillContent(count = 6) {
  const sampleSpills = [
    "hari ini gue liat mantan sama cewek baru, dan tau gak? rambutnya lebih bagus dari rambut gue üò≠",
    "cape bener jadi cewek, setiap bulan harus nahan sakit perut sambil tetep senyum di depan client",
    "kenapa sih cowok kalo ditanya 'lagi apa' pasti jawabnya 'lagi main'? ga ada variasi lain?",
    "gue lagi fase pengen dimengerti tanpa harus jelasin panjang lebar",
    "bete banget skincare gue habis, padahal baru kemarin beli. ada yang ngutil?",
    "hari ini gue salah kirim chat pacar ke grup keluarga. isinya 'sayang udah mandi belom?' üò≠",
    "kenapa orangtua selalu curiga kalo kita lagi seneng? 'lagi seneng-seneng ya? nanti belajar'",
    "gue lagi diet, tapi tiap liat roti, rotinya yang liat gue duluan",
    "stress skripsi tapi yang keluar peluh dan air mata doang",
    "hari ini gue nangis karena ga bisa buka toples. lemah?"
  ];
  
  const moodList = ['surviving','thriving','chaotic','doom'];
  const nameList = ['anon.kucing','sleepy.head','chaos.queen','quiet.one','beby.manis','strawberry.shortcake','pretty.sad','little.fairy','cinnamon.girl','sejuta.badai','kue.bulan','agak.koplak','chili.padi','abang.gaul'];
  
  let result = [];
  let nextId = Math.max(...USER_RANTS.map(u => u.id), 5) + 1;
  
  for (let i = 0; i < count; i++) {
    result.push({
      id: nextId++,
      author: nameList[Math.floor(Math.random() * nameList.length)],
      isAI: Math.random() > 0.7,
      mood: moodList[Math.floor(Math.random() * moodList.length)],
      content: sampleSpills[Math.floor(Math.random() * sampleSpills.length)],
      reactions: { 
        skull: Math.floor(Math.random() * 50), 
        cry: Math.floor(Math.random() * 100), 
        fire: Math.floor(Math.random() * 40), 
        upside: Math.floor(Math.random() * 30) 
      },
      userReacted: null
    });
  }
  return result;
}

function renderSpills() {
  const list = $('spillsList');
  if (!list) return;
  
  let allSpills = [...USER_RANTS, ...generateSpillContent(6)];
  let filtered = activeMood === 'all' ? allSpills : allSpills.filter(s => s.mood === activeMood);
  
  if (!filtered.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-icon">üçÉ</div><div class="empty-title">Belum ada spill</div><div class="empty-text">Coba filter lain</div></div>';
    return;
  }
  
  list.innerHTML = filtered.map(s => `
    <div class="spill-card">
      <div class="spill-head">
        <span class="spill-user">@${esc(s.author)}${s.isAI ? ' ü§ñ' : ''}</span>
        <span class="spill-mood ${s.mood}">${s.mood}</span>
      </div>
      <div class="spill-body">${esc(s.content)}</div>
      <div class="spill-actions">
        ${Object.entries(REACTION_EMOJI).map(([k, em]) => `
          <button class="react-btn ${s.userReacted === k ? 'active' : ''}" onclick="react(this, ${s.id}, '${k}')">
            ${em}<span class="react-count" id="rc-${s.id}-${k}">${s.reactions[k]}</span>
          </button>
        `).join('')}
      </div>
    </div>
  `).join('');
}

function react(btn, id, key) {
  let spill = [...USER_RANTS, ...generateSpillContent(0)].find(s => s.id === id);
  if (!spill) return;
  
  let wasActive = btn.classList.contains('active');
  document.querySelectorAll(`[id^="rc-${id}-"]`).forEach(el => el.closest('button').classList.remove('active'));
  
  if (wasActive) {
    spill.reactions[key]--;
  } else {
    spill.reactions[key]++;
    btn.classList.add('active');
  }
  
  spill.userReacted = wasActive ? null : key;
  
  Object.keys(spill.reactions).forEach(r => {
    let el = $(`rc-${id}-${r}`);
    if (el) el.textContent = spill.reactions[r];
  });
}

function refreshSpills() {
  renderSpills();
  toast('Teh baru diseduh ‚òï');
}

// ==================== RADAR ====================
let radarDots = [];
let needleAngle = 0;
let needleOmega = 0;
let phaseA = Math.random() * Math.PI * 2;
let phaseB = Math.random() * Math.PI * 2;
let phaseC = Math.random() * Math.PI * 2;
const BASE_RPM = 60 / 4;
const BASE_OMEGA = (BASE_RPM * Math.PI * 2) / (60 * 60);
const TRAIL_CAP = 120;
const trail = new Float32Array(TRAIL_CAP);
let trailPtr = 0;
const dotGlow = new Map();

function initRadar() {
  const canvas = $('radarCanvas');
  const container = $('radarCont');
  if (!canvas || !container) return;
  
  function resizeCanvas() {
    const rect = container.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
  }
  
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas, { passive: true });
  
  spawnDots();
  
  radarInterval = setInterval(() => {
    radarDots.forEach(d => {
      d.vx = (d.vx * 0.88) + (Math.random() - 0.5) * 0.3;
      d.vy = (d.vy * 0.88) + (Math.random() - 0.5) * 0.3;
      d.x = Math.max(9, Math.min(91, d.x + d.vx));
      d.y = Math.max(9, Math.min(91, d.y + d.vy));
      if (d.el) {
        d.el.style.left = d.x + '%';
        d.el.style.top = d.y + '%';
      }
    });
  }, 100);
  
  $('onlineCount').textContent = Math.floor(18 + Math.random() * 15) + ' ONLINE';
  needleAngle = Math.random() * Math.PI * 2;
  trail.fill(needleAngle);
  
  radarLoop(canvas);
}

function spawnDots() {
  const container = $('radarDots');
  if (!container) return;
  container.innerHTML = '';
  radarDots = [];
  
  let count = 5 + Math.floor(Math.random() * 5);
  for (let i = 0; i < count + 2; i++) {
    let isAI = i >= count;
    let angle = Math.random() * Math.PI * 2;
    let dist = 12 + Math.random() * 70;
    let x = 50 + Math.cos(angle) * dist / 2;
    let y = 50 + Math.sin(angle) * dist / 2;
    
    let dot = document.createElement('div');
    let type = isAI ? 'ai' : (Math.random() > 0.5 ? 'purple' : 'red');
    dot.className = 'radar-dot ' + type;
    dot.style.left = x + '%';
    dot.style.top = y + '%';
    container.appendChild(dot);
    
    radarDots.push({ el: dot, x, y, vx: 0, vy: 0, type, id: i });
  }
}

function radarLoop(canvas) {
  const ctx = canvas.getContext('2d');
  if (!ctx) return;
  
  function draw(now) {
    if (!canvas || !ctx) return;
    
    const W = canvas.width;
    const H = canvas.height;
    const cx = W / 2;
    const cy = H / 2;
    const R = Math.min(cx, cy) * 0.88;
    
    phaseA += 0.007;
    phaseB += 0.013;
    phaseC += 0.041;
    
    const speedMult = 1.0 + Math.sin(phaseA) * 0.35 + Math.sin(phaseB) * 0.18 + Math.sin(phaseC) * 0.04;
    const targetOmega = BASE_OMEGA * speedMult;
    needleOmega += (targetOmega - needleOmega) * 0.028;
    needleAngle = (needleAngle + needleOmega) % (Math.PI * 2);
    
    trail[trailPtr] = needleAngle;
    trailPtr = (trailPtr + 1) % TRAIL_CAP;
    
    const fade = 0.09 + Math.sin(now * 0.0011) * 0.008;
    ctx.fillStyle = `rgba(1,5,1,${fade})`;
    ctx.fillRect(0, 0, W, H);
    
    for (let i = 0; i < TRAIL_CAP - 1; i++) {
      let newer = (trailPtr - 1 - i + TRAIL_CAP) % TRAIL_CAP;
      let older = (trailPtr - 2 - i + TRAIL_CAP) % TRAIL_CAP;
      let a0 = trail[older];
      let a1 = trail[newer];
      let recency = 1 - i / TRAIL_CAP;
      let alpha = Math.pow(recency, 1.6) * 0.52;
      
      if (alpha < 0.003) break;
      
      let start = a0;
      let end = a1;
      if (end - start > Math.PI) start += Math.PI * 2;
      if (start - end > Math.PI) end += Math.PI * 2;
      
      ctx.save();
      ctx.translate(cx, cy);
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.arc(0, 0, R, start, end, false);
      ctx.closePath();
      ctx.fillStyle = `rgba(0,255,65,${alpha})`;
      ctx.fill();
      ctx.restore();
    }
    
    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(needleAngle);
    ctx.shadowColor = 'rgba(0,255,65,0.9)';
    ctx.shadowBlur = 10;
    
    const lg = ctx.createLinearGradient(0, 0, R, 0);
    lg.addColorStop(0, 'rgba(0,255,65,1)');
    lg.addColorStop(0.55, 'rgba(0,255,65,0.8)');
    lg.addColorStop(0.85, 'rgba(0,255,65,0.35)');
    lg.addColorStop(1, 'rgba(0,255,65,0)');
    
    ctx.beginPath();
    ctx.moveTo(4, 0);
    ctx.lineTo(R, 0);
    ctx.strokeStyle = lg;
    ctx.lineWidth = 1.8;
    ctx.stroke();
    
    ctx.shadowBlur = 16;
    ctx.beginPath();
    ctx.arc(0, 0, 3.5, 0, Math.PI * 2);
    ctx.fillStyle = '#00ff41';
    ctx.fill();
    ctx.restore();
    
    radarDots.forEach((d, di) => {
      const px = d.x / 100 * W;
      const py = d.y / 100 * H;
      const dxp = px - cx;
      const dyp = py - cy;
      let dotAng = Math.atan2(dyp, dxp);
      if (dotAng < 0) dotAng += Math.PI * 2;
      
      let diff = needleAngle - dotAng;
      if (diff < 0) diff += Math.PI * 2;
      
      const age = dotGlow.get(di) ?? 999;
      
      if (diff < 0.14 && age > 40) {
        dotGlow.set(di, 0);
        if (d.el) {
          d.el.classList.add('active');
          setTimeout(() => { if (d.el) d.el.classList.remove('active'); }, 700);
        }
      } else {
        dotGlow.set(di, age + 1);
      }
      
      if (age < 60) {
        const t = age / 60;
        const ga = (1 - t) * (1 - t) * 0.9;
        if (ga > 0.01) {
          let col = d.type === 'purple' ? [176,38,255] : d.type === 'red' ? [255,0,64] : [0,255,65];
          const gr = ctx.createRadialGradient(px, py, 0, px, py, 14 * (1 - t) + 4);
          gr.addColorStop(0, `rgba(${col[0]},${col[1]},${col[2]},${ga})`);
          gr.addColorStop(1, `rgba(${col[0]},${col[1]},${col[2]},0)`);
          ctx.beginPath();
          ctx.arc(px, py, 14 * (1 - t) + 4, 0, Math.PI * 2);
          ctx.fillStyle = gr;
          ctx.fill();
        }
      }
    });
    
    radarRAF = requestAnimationFrame(draw);
  }
  
  radarRAF = requestAnimationFrame(draw);
}

function updateOnlineCount() {
  let el = $('onlineCount');
  if (el) {
    let count = Math.floor(Math.random() * 25) + 18;
    el.textContent = count + ' ONLINE';
  }
}
// ==================== VIBE CHECK ====================
// ==================== VIBE CHECK ====================
function startVibeCheck() {
  chatPartner = null;
  chatTimeLeft = 900;
  chatHistory = [];
  
  if (fallbackTimer) {
    clearTimeout(fallbackTimer);
    fallbackTimer = null;
  }
  
  $('genderModal').classList.add('on');
}

function selectGender(el, gender) {
  // ... kode yang sudah ada ...
}
  function selectGender(el, gender) {
  document.querySelectorAll('.gender-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  currentGender = gender;
  $('confirmGenderBtn').disabled = false;
}

function confirmGender() {
  if (!currentGender) return;
  
  closeModal('genderModal');
  
  $('chatRoom').classList.add('on');
  $('chatTimer').textContent = '15:00';
  $('chatTimer').classList.remove('warn');
  
  const messages = $('chatMessages');
  
  messages.innerHTML = `
    <div class="chat-msg system-msg" style="align-self:center; opacity:0.7; margin:20px 0;">
      <div class="chat-bubble" style="background:transparent; border:1px dashed var(--bd); color:var(--txs); font-style:italic;">
        ‚ö° mengaktifkan radar pencarian...
      </div>
    </div>
  `;
  
  setTimeout(() => {
    if (!chatPartner) {
      messages.innerHTML = `
        <div class="chat-msg system-msg" style="align-self:center;">
          <div class="chat-bubble" style="background:var(--sfe); border-left:3px solid var(--aq);">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
              <span style="font-family:'Space Mono',monospace; font-size:10px; color:var(--aq);">RADAR</span>
              <span style="font-size:10px; color:var(--txs);">${currentGender === 'female' ? '‚ôÄ cewek' : '‚ôÇ cowok'}</span>
            </div>
            <div style="font-size:13px; line-height:1.6;">
              memindai sekitar 500m... 
              <span style="display:inline-block; width:12px; text-align:left; font-family:'Space Mono',monospace;" id="scanDots">.</span>
            </div>
          </div>
        </div>
      `;
      
      let dotCount = 1;
      const scanInterval = setInterval(() => {
        if (chatPartner) {
          clearInterval(scanInterval);
          return;
        }
        dotCount = (dotCount % 3) + 1;
        const dots = $('scanDots');
        if (dots) dots.textContent = '.'.repeat(dotCount);
      }, 500);
    }
  }, 800);
  
  const timeline = [
    { time: 3000, message: "masih memindai...", emoji: "üëÄ" },
    { time: 6000, message: "lingkungan sepi, radar melebar", emoji: "üì°" },
    { time: 9000, message: "menjangkau radius 2km", emoji: "üåê" },
    { time: 12000, message: "hampir selesai...", emoji: "‚è≥" }
  ];
  
  timeline.forEach(item => {
    setTimeout(() => {
      if (!chatPartner) {
        updateSystemMessage(item.message, item.emoji);
      }
    }, item.time);
  });
  
  findRealUser();
  
  fallbackTimer = setTimeout(() => {
    if (!chatPartner && $('chatRoom').classList.contains('on')) {
      $('chatMessages').innerHTML = '';
      fallbackToAI();
    }
  }, 15000);
}

function updateSystemMessage(text, emoji = '') {
  const messages = $('chatMessages');
  if (!messages) return;
  
  const lastSystem = messages.lastElementChild;
  if (lastSystem && lastSystem.classList.contains('system-msg')) {
    lastSystem.remove();
  }
  
  const msgDiv = document.createElement('div');
  msgDiv.className = 'chat-msg system-msg';
  msgDiv.style.alignSelf = 'center';
  msgDiv.style.margin = '4px 0';
  
  msgDiv.innerHTML = `
    <div class="chat-bubble" style="background:var(--sfe); border-left:2px solid var(--bd); padding:10px 16px; font-size:12px; color:var(--txs);">
      ${emoji} ${text}
      <span style="display:inline-block; width:12px; text-align:left; font-family:'Space Mono',monospace;" id="scanDots">...</span>
    </div>
  `;
  
  messages.appendChild(msgDiv);
  msgDiv.scrollIntoView({ behavior: 'smooth' });
}

async function findRealUser() {
  setTimeout(() => {
    if (!chatPartner && $('chatRoom').classList.contains('on')) {
      const hasRealUser = Math.random() < 0.05;
      
      if (hasRealUser) {
        if (fallbackTimer) {
          clearTimeout(fallbackTimer);
          fallbackTimer = null;
        }
        
        $('chatMessages').innerHTML = '';
        addSystemCelebration('‚ú® real user ditemukan! memulai percakapan...', 'üéâ');
        
        setTimeout(() => {
          startRealChat();
        }, 1500);
      }
    }
  }, 3000);
}

function addSystemCelebration(text, emoji) {
  const messages = $('chatMessages');
  if (!messages) return;
  
  const msgDiv = document.createElement('div');
  msgDiv.className = 'chat-msg system-msg';
  msgDiv.style.alignSelf = 'center';
  msgDiv.style.margin = '10px 0';
  
  msgDiv.innerHTML = `
    <div class="chat-bubble" style="background:rgba(0,255,65,0.1); border:1px solid var(--aq); padding:12px 20px; border-radius:30px;">
      <span style="font-size:20px; margin-right:8px;">${emoji}</span>
      <span style="color:var(--aq); font-weight:600;">${text}</span>
    </div>
  `;
  
  messages.appendChild(msgDiv);
  msgDiv.scrollIntoView({ behavior: 'smooth' });
}

function startRealChat() {
  fallbackToAI();
}

function fallbackToAI() {
  if (fallbackTimer) {
    clearTimeout(fallbackTimer);
    fallbackTimer = null;
  }
  
  const gender = currentGender === 'female' ? 'female' : 'male';
  const charList = AI_CHARACTERS[gender];
  const randomChar = charList[Math.floor(Math.random() * charList.length)];
  
  chatPartner = {
    name: randomChar,
    isAI: true
  };
  
  const messages = $('chatMessages');
  if (messages) messages.innerHTML = '';
  
  addSystemCelebration('üë§ seseorang ditemukan!', '');
  
  setTimeout(() => {
    if (messages) messages.innerHTML = '';
    apiOffline = false;
    callChatAPI('', true);
    startTimer();
  }, 1000);
}

function startTimer() {
  clearInterval(timerInterval);
  timerInterval = setInterval(updateTimer, 1000);
}

function updateTimer() {
  if (chatTimeLeft <= 0) {
    endChat();
    return;
  }
  
  chatTimeLeft--;
  const mins = Math.floor(chatTimeLeft / 60);
  const secs = chatTimeLeft % 60;
  const timerEl = $('chatTimer');
  if (timerEl) timerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  
  const hasSubscription = checkSubscription();
  if (hasSubscription) return;
  
  if (chatTimeLeft === 120) {
    addSubscriptionReminder(
      "‚è≥ sisa 2 menit...",
      "ini obrolan cuma 15 menit buat kamu yang belum subscribe. kalau mau lanjut, bisa pilih paket dulu~"
    );
  }
  
  if (chatTimeLeft === 60) {
    addSubscriptionReminder(
      "‚è∞ 1 menit lagi...",
      "pengen lanjut ngobrol? 10k/minggu atau 50k/bulan (dapet WHISPERER ‚ú¶). santai, pilih sesuai kebutuhan"
    );
    const timerEl = $('chatTimer');
    if (timerEl) timerEl.classList.add('warn');
  }
  
  if (chatTimeLeft === 30) {
    addSubscriptionReminder(
      "‚ö° 30 detik...",
      "mau coba subscribe? 7 hari cuma 10k, 30 hari 50k (udah termasuk WHISPERER). terserah kamu~"
    );
  }
  
  if (chatTimeLeft === 10) {
    addSubscriptionReminder(
      "üéØ 10 detik terakhir...",
      "abis ini bakal nutup otomatis ya. kalo masih pengen ngobrol, bisa subscribe dulu"
    );
  }
}

function addSubscriptionReminder(title, message) {
  const messages = $('chatMessages');
  if (!messages) return;
  
  const existingReminder = document.querySelector('.reminder-msg');
  if (existingReminder) existingReminder.remove();
  
  const msgDiv = document.createElement('div');
  msgDiv.className = 'chat-msg reminder-msg';
  msgDiv.style.alignSelf = 'center';
  msgDiv.style.margin = '8px 0';
  msgDiv.style.maxWidth = '90%';
  
  msgDiv.innerHTML = `
    <div class="chat-bubble" style="background:var(--sfe); border:1px dashed var(--as); border-radius:16px; padding:16px;">
      <div style="font-size:12px; font-weight:600; color:var(--as); margin-bottom:6px;">${title}</div>
      <div style="font-size:13px; color:var(--tx); margin-bottom:16px;">${message}</div>
      
      <div style="display:flex; gap:8px; margin-bottom:16px;">
        <div onclick="selectPackage('weekly', this)" style="flex:1; background:var(--bg); border:1px solid var(--bd); border-radius:12px; padding:12px; text-align:center; cursor:pointer;" data-package="weekly">
          <div style="font-size:16px; font-weight:700; color:var(--as);">10k</div>
          <div style="font-size:11px; color:var(--txs);">7 hari</div>
        </div>
        <div onclick="selectPackage('monthly', this)" style="flex:1; background:var(--bg); border:1px solid var(--bd); border-radius:12px; padding:12px; text-align:center; cursor:pointer;" data-package="monthly">
          <div style="font-size:16px; font-weight:700; color:var(--aq);">50k</div>
          <div style="font-size:11px; color:var(--txs);">30 hari + WHISPERER</div>
        </div>
      </div>
      
      <div style="margin-bottom:12px; text-align:center;">
        <button onclick="showTermsPopup()" style="background:transparent; border:1px dashed var(--bd); color:var(--txs); padding:8px 16px; border-radius:30px; font-size:11px; cursor:pointer; font-family:inherit;">
          üìã baca syarat & ketentuan
        </button>
      </div>
      
      <div id="tcContainer" style="display:none; margin-bottom:16px;">
        <div style="display:flex; align-items:flex-start; gap:10px; background:var(--bg); padding:12px; border-radius:12px; border:1px solid var(--bd);">
          <input type="checkbox" id="tcCheckbox" style="width:18px; height:18px; margin-top:2px; accent-color:var(--aq);">
          <label for="tcCheckbox" style="font-size:11px; color:var(--txs); line-height:1.5;">
            Saya setuju dengan <button onclick="showTermsPopup()" style="background:none; border:none; color:var(--as); text-decoration:underline; cursor:pointer; font-size:11px; font-family:inherit;">syarat & ketentuan</button> yang berlaku
          </label>
        </div>
      </div>
      
      <div id="payButtonContainer" style="display:none; margin-bottom:8px;">
        <button onclick="processSubscription()" style="width:100%; background:linear-gradient(90deg, var(--as), var(--aq)); color:#000; border:none; padding:14px; border-radius:30px; font-size:13px; font-weight:700; cursor:pointer; font-family:inherit;">
          üí≥ lanjut bayar
        </button>
      </div>
      
      <div style="display:flex; justify-content:flex-end;">
        <button onclick="dismissReminder()" style="background:transparent; border:none; color:var(--txm); padding:6px 12px; font-size:11px; cursor:pointer; font-family:inherit;">
          skip dulu
        </button>
      </div>
      
      <div style="font-size:8px; color:var(--txm); margin-top:8px; text-align:center; opacity:0.5;">
        ‚Ä¢ payment by Midtrans
      </div>
    </div>
  `;
  
  messages.appendChild(msgDiv);
  msgDiv.scrollIntoView({ behavior: 'smooth' });
}

let selectedPackage = null;

function selectPackage(type, element) {
  selectedPackage = type;
  
  document.querySelectorAll('[data-package]').forEach(el => {
    el.style.borderColor = 'var(--bd)';
    el.style.background = 'var(--bg)';
  });
  
  element.style.borderColor = type === 'weekly' ? 'var(--as)' : 'var(--aq)';
  element.style.background = type === 'weekly' ? 'rgba(0,240,255,0.1)' : 'rgba(0,255,65,0.1)';
  
  const tcContainer = document.getElementById('tcContainer');
  if (tcContainer) tcContainer.style.display = 'block';
  
  const tcCheckbox = document.getElementById('tcCheckbox');
  if (tcCheckbox) {
    tcCheckbox.onchange = function() {
      const payButton = document.getElementById('payButtonContainer');
      if (payButton) payButton.style.display = this.checked ? 'block' : 'none';
    };
  }
}

function dismissReminder() {
  const reminder = document.querySelector('.reminder-msg');
  if (reminder) reminder.remove();
}

function showTermsPopup() {
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position:fixed; top:0; left:0; right:0; bottom:0; 
    background:rgba(0,0,0,0.95); z-index:1000; 
    display:flex; align-items:center; justify-content:center;
    padding:20px;
  `;
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    background:var(--sf); border:1px solid var(--bd); 
    border-radius:24px; max-width:400px; width:100%;
    max-height:80vh; overflow-y:auto;
    box-shadow:0 20px 40px rgba(0,0,0,0.8);
  `;
  
  const header = document.createElement('div');
  header.style.cssText = `
    padding:20px; border-bottom:1px solid var(--bd);
    display:flex; justify-content:space-between; align-items:center;
  `;
  header.innerHTML = `
    <span style="font-weight:700; font-size:16px;">üìã syarat & ketentuan</span>
    <button onclick="this.closest('.overlay').remove()" style="background:var(--bg); border:1px solid var(--bd); border-radius:10px; width:36px; height:36px; cursor:pointer; color:var(--txs);">‚úï</button>
  `;
  
  const body = document.createElement('div');
  body.style.cssText = `
    padding:20px; font-size:12px; color:var(--txs); 
    line-height:1.8; white-space:pre-line;
  `;
  body.textContent = TERMS_TEXT;
  
  const footer = document.createElement('div');
  footer.style.cssText = `
    padding:20px; border-top:1px solid var(--bd);
    display:flex; gap:10px;
  `;
  footer.innerHTML = `
    <button onclick="agreeToTerms(); this.closest('.overlay').remove();" style="flex:2; background:var(--aq); color:#000; border:none; padding:12px; border-radius:30px; font-weight:700; cursor:pointer;">
      ‚úÖ setuju
    </button>
    <button onclick="this.closest('.overlay').remove()" style="flex:1; background:transparent; border:1px solid var(--bd); color:var(--txs); padding:12px; border-radius:30px; cursor:pointer;">
      tutup
    </button>
  `;
  
  modal.appendChild(header);
  modal.appendChild(body);
  modal.appendChild(footer);
  overlay.appendChild(modal);
  overlay.classList.add('overlay');
  
  document.body.appendChild(overlay);
}

function agreeToTerms() {
  const tcCheckbox = document.getElementById('tcCheckbox');
  if (tcCheckbox) {
    tcCheckbox.checked = true;
    const event = new Event('change', { bubbles: true });
    tcCheckbox.dispatchEvent(event);
  }
}

function processSubscription() {
  if (!selectedPackage) {
    toast('pilih paket dulu ya~', true);
    return;
  }
  
  const tcCheckbox = document.getElementById('tcCheckbox');
  if (!tcCheckbox || !tcCheckbox.checked) {
    toast('centang dulu setuju syarat & ketentuannya~', true);
    return;
  }
  
  const amount = selectedPackage === 'weekly' ? 10000 : 50000;
  const days = selectedPackage === 'weekly' ? 7 : 30;
  const packageName = selectedPackage === 'weekly' ? '7 Hari' : '30 Hari + WHISPERER';
  
  const loadingMsg = document.createElement('div');
  loadingMsg.className = 'chat-msg system-msg';
  loadingMsg.style.alignSelf = 'center';
  loadingMsg.innerHTML = `
    <div class="chat-bubble" style="background:var(--sfe); padding:12px 20px;">
      ‚è≥ nyiapin pembayaran...
    </div>
  `;
  $('chatMessages').appendChild(loadingMsg);
  
  // Simulasi sukses (ganti dengan fetch ke backend nanti)
  setTimeout(() => {
    loadingMsg.remove();
    
    const expiryDate = new Date();
    expiryDate.setDate(expiryDate.getDate() + days);
    
    userSubscription = {
      isActive: true,
      expiresAt: expiryDate.toISOString(),
      type: selectedPackage
    };
    
    localStorage.setItem('userSubscription', JSON.stringify(userSubscription));
    
    dismissReminder();
    
    const msgDiv = document.createElement('div');
    msgDiv.className = 'chat-msg system-msg';
    msgDiv.style.alignSelf = 'center';
    
    const whispererBonus = selectedPackage === 'monthly' ? ' dan WHISPERER ‚ú¶' : '';
    
    msgDiv.innerHTML = `
      <div class="chat-bubble" style="background:rgba(0,255,65,0.1); border:1px solid var(--aq); padding:20px; border-radius:30px;">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
          <span style="font-size:28px;">üéâ</span>
          <span style="font-weight:700; font-size:16px;">subscribe berhasil!</span>
        </div>
        <div style="font-size:13px; color:var(--txs); margin-bottom:12px;">
          sekarang kamu bisa ngobrol santai ${days} hari ke depan${whispererBonus}
        </div>
        <div style="font-size:12px; color:var(--tx); background:var(--bg); padding:10px; border-radius:12px;">
          ‚ö° fitur premium udah aktif:
          ‚Ä¢ chat tanpa batas
          ‚Ä¢ prioritas koneksi real user
          ‚Ä¢ void tap unlimited
          ${selectedPackage === 'monthly' ? '‚Ä¢ WHISPERER ‚ú¶ (pesan rahasia hilang 5 detik)' : ''}
        </div>
        <div style="margin-top:16px; font-size:11px; color:var(--txm); font-style:italic;">
          üëÜ lanjutin ngobrol aja~
        </div>
      </div>
    `;
    
    $('chatMessages').appendChild(msgDiv);
    msgDiv.scrollIntoView({ behavior: 'smooth' });
    
    if (chatTimeLeft > 0) {
      chatTimeLeft += 900;
      const timerEl = $('chatTimer');
      if (timerEl) {
        timerEl.textContent = '15:00';
        timerEl.classList.remove('warn');
      }
    }
    
    toast('selamat datang di keluarga premium! üéâ');
  }, 1500);
}

function selectPlan(el, plan) {
  document.querySelectorAll('.price-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  selectedPlan = plan;
}

function processUpgrade() {
  if (!selectedPlan) {
    toast('Pilih paket dulu', true);
    return;
  }
  
  closeModal('upgradeModal');
  
  // Trigger reminder di chat
  if (chatTimeLeft > 0 && $('chatRoom').classList.contains('on')) {
    addSubscriptionReminder(
      "‚ú® mau upgrade?",
      `pilih paket yang cocok: 10k/7 hari atau 50k/30 hari + WHISPERER ‚ú¶`
    );
  } else {
    toast('Buka VIBE CHECK dulu untuk chat', true);
  }
}

function endChat() {
  clearInterval(timerInterval);
  
  const hasSubscription = checkSubscription();
  
  if (hasSubscription) {
    chatTimeLeft = 900;
    const timerEl = $('chatTimer');
    if (timerEl) {
      timerEl.textContent = '15:00';
      timerEl.classList.remove('warn');
    }
    
    addSystemCelebration(
      "üîÑ auto-refresh", 
      "karena kamu subscriber, langsung dapet 15 menit lagi. enjoy~"
    );
    return;
  }
  
  const msgDiv = document.createElement('div');
  msgDiv.className = 'chat-msg system-msg';
  msgDiv.style.alignSelf = 'center';
  msgDiv.style.margin = '20px 0';
  
  msgDiv.innerHTML = `
    <div class="chat-bubble" style="background:var(--sfe); border:1px solid var(--bd); padding:20px; border-radius:30px; max-width:300px;">
      <div style="font-size:18px; margin-bottom:12px;">‚è∞ waktu abis</div>
      <div style="font-size:13px; color:var(--txs); margin-bottom:16px;">
        mau lanjut ngobrol? subscribe dulu yuk~
      </div>
      
      <div style="display:flex; gap:8px; margin-bottom:16px;">
        <div onclick="selectPackage('weekly', this)" style="flex:1; background:var(--bg); border:1px solid var(--bd); border-radius:12px; padding:12px; text-align:center; cursor:pointer;" data-package="weekly">
          <div style="font-size:16px; font-weight:700; color:var(--as);">10k</div>
          <div style="font-size:10px; color:var(--txs);">7 hari</div>
        </div>
        <div onclick="selectPackage('monthly', this)" style="flex:1; background:var(--bg); border:1px solid var(--bd); border-radius:12px; padding:12px; text-align:center; cursor:pointer;" data-package="monthly">
          <div style="font-size:16px; font-weight:700; color:var(--aq);">50k</div>
          <div style="font-size:10px; color:var(--txs);">30 hari + WHISPERER</div>
        </div>
      </div>
      
      <button onclick="processSubscription()" style="width:100%; background:var(--ap); color:#000; border:none; padding:12px; border-radius:30px; font-size:13px; font-weight:700; cursor:pointer; font-family:inherit; margin-bottom:8px;">
        ‚ûï subscribe sekarang
      </button>
      
      <button onclick="closeChat()" style="width:100%; background:transparent; border:1px solid var(--bd); color:var(--txs); padding:10px; border-radius:30px; font-size:12px; cursor:pointer; font-family:inherit;">
        tutup dulu
      </button>
      
      <div style="font-size:8px; color:var(--txm); margin-top:12px; text-align:center;">
        ‚Ä¢ bayar pake apa aja (Midtrans)
      </div>
    </div>
  `;
  
  $('chatMessages').appendChild(msgDiv);
  msgDiv.scrollIntoView({ behavior: 'smooth' });
}

function closeChat() {
  $('chatRoom').classList.remove('on');
  clearInterval(timerInterval);
  
  if (fallbackTimer) {
    clearTimeout(fallbackTimer);
    fallbackTimer = null;
  }
}

// ==================== WHISPERER ====================
function openWsModal() {
  const isPremium = checkSubscription() && userSubscription.type === 'monthly';
  
  if (!isPremium) {
    $('wsModalBody').innerHTML = `
      <div class="ws-premium-lock">
        <div class="icon">‚ú¶</div>
        <div class="title">whisperer premium</div>
        <div class="desc">fitur ini khusus untuk pengguna paket 50K/30 hari</div>
        <button class="ws-premium-btn" onclick="closeModal('wsModal'); showUpgradeModal();">upgrade sekarang</button>
      </div>
    `;
    $('wsModal').classList.add('on');
    return;
  }
  
  $('wsPremiumBadge').style.display = 'inline-block';
  renderWsInbox();
  $('wsModal').classList.add('on');
}

function renderWsInbox() {
  const list = $('wsInboxList');
  if (!list) return;
  
  if (whispers.length === 0) {
    list.innerHTML = '<div class="ws-empty"><span class="ws-empty-icon">‚úß</span><div class="ws-empty-title">belum ada whisper</div><div class="ws-empty-sub">whisper akan muncul di sini</div></div>';
    return;
  }
  
  list.innerHTML = whispers.map(w => `
    <div class="ws-thread-item ${w.read ? '' : 'unread'} premium" onclick="openWsThread('${w.from}')">
      <div class="ws-avatar">${w.from.charAt(0)}</div>
      <div class="ws-thread-info">
        <div class="ws-thread-name">@${esc(w.from)}</div>
        <div class="ws-thread-preview">${esc(w.content)}</div>
      </div>
      <div class="ws-thread-right">
        <span class="ws-thread-time">${timeAgoShort(w.timestamp)}</span>
        ${!w.read ? '<span class="ws-unread-badge">new</span>' : ''}
      </div>
    </div>
  `).join('');
  
  updateWsBadge();
}

function timeAgoShort(timestamp) {
  const diff = Date.now() - timestamp;
  const mins = Math.floor(diff / 60000);
  if (mins < 60) return `${mins}m`;
  const hours = Math.floor(mins / 60);
  return `${hours}h`;
}

function updateWsBadge() {
  const isPremium = checkSubscription() && userSubscription.type === 'monthly';
  if (!isPremium) return;
  
  const unread = whispers.filter(w => !w.read).length;
  const badge = $('wsBadge');
  if (unread > 0) {
    badge.textContent = unread;
    badge.classList.add('show');
  } else {
    badge.classList.remove('show');
  }
  // ==================== STEALTH WHISPERER CONTROL ====================
function updateStealthWhisperer() {
  const wsIcon = document.getElementById('wsIcon');
  const wsLabel = document.getElementById('wsLabel');
  const wsBadge = document.getElementById('wsStealthBadge');
  
  if (!wsIcon || !wsLabel || !wsBadge) return;
  
  const unreadCount = whispers.filter(w => !w.read).length;
  
  if (unreadCount > 0) {
    // ADA PESAN - TAMPILKAN BADGE DAN AKTIFKAN WARNA PUTIH
    wsIcon.style.color = 'var(--tx)';
    wsLabel.style.color = 'var(--tx)';
    wsLabel.style.fontWeight = '600';
    wsBadge.style.display = 'inline-block';
    wsBadge.textContent = `‚ú¶ ${unreadCount}`;
  } else {
    // TIDAK ADA PESAN - STEALTH MODE (ABU-ABU TIPIS)
    wsIcon.style.color = 'var(--txs)';
    wsLabel.style.color = 'var(--txs)';
    wsLabel.style.fontWeight = '400';
    wsBadge.style.display = 'none';
  }
}

// Modifikasi fungsi updateWsBadge yang sudah ada
function updateWsBadge() {
  const isPremium = checkSubscription() && userSubscription.type === 'monthly';
  if (!isPremium) return;
  
  const unread = whispers.filter(w => !w.read).length;
  const badge = $('wsBadge');
  if (badge) {
    if (unread > 0) {
      badge.textContent = unread;
      badge.classList.add('show');
    } else {
      badge.classList.remove('show');
    }
  }
  
  // PANGGIL STEALTH UPDATER
  updateStealthWhisperer();
}

// Panggil di init
document.addEventListener('DOMContentLoaded', () => {
  // ... kode init lainnya ...
  updateStealthWhisperer();
});

// Panggil juga setiap kali ada perubahan whispers
function addWhisper() {
  // ... fungsi tambah whisper ...
  updateStealthWhisperer();
}

function markWhisperRead() {
  // ... fungsi mark read ...
  updateStealthWhisperer();
}
}

function openWsCompose() {
  const isPremium = checkSubscription() && userSubscription.type === 'monthly';
  if (!isPremium) {
    toast('whisperer khusus premium 50K', true);
    return;
  }
  
  closeModal('wsModal');
  $('wsComposeScreen').classList.add('on');
  $('wsToInput').value = '';
  $('wsBodyInput').value = '';
  $('wsCharCount').textContent = '0/200';
  $('wsSendBtn').disabled = true;
}

function closeWsCompose() {
  $('wsComposeScreen').classList.remove('on');
}

function validateWsTo() {
  const to = $('wsToInput').value.trim();
  const body = $('wsBodyInput').value.trim();
  $('wsSendBtn').disabled = !(to && body);
}

function validateWsBody() {
  const body = $('wsBodyInput').value;
  $('wsCharCount').textContent = body.length + '/200';
  validateWsTo();
}

function sendWs() {
  const to = $('wsToInput').value.trim();
  const body = $('wsBodyInput').value.trim();
  if (!to || !body) return;
  
  whispers.push({
    id: 'w' + Date.now(),
    from: to,
    to: userName,
    content: body,
    timestamp: Date.now(),
    read: false,
    thread: []
  });
  
  toast('Whisper terkirim (akan hilang 5 detik setelah dibaca)');
  closeWsCompose();
  openWsModal();
}

function openWsThread(username) {
  const whisper = whispers.find(w => w.from === username);
  if (!whisper) return;
  
  whisper.read = true;
  activeWsThread = whisper;
  
  $('wsThreadScreen').classList.add('on');
  $('wsThreadTitle').textContent = '@' + username;
  
  renderWsThread(whisper);
  updateWsBadge();
}

function closeWsThread() {
  $('wsThreadScreen').classList.remove('on');
  activeWsThread = null;
}

function renderWsThread(whisper) {
  const msgs = $('wsThreadMessages');
  
  let allMessages = [
    { from: whisper.from, content: whisper.content, timestamp: whisper.timestamp },
    ...whisper.thread
  ];
  
  msgs.innerHTML = allMessages.map(m => `
    <div class="chat-msg ${m.from === userName ? 'own' : 'other'}">
      <div class="chat-bubble" style="${m.from !== userName ? 'border:1px solid var(--as);' : ''}">${esc(m.content)}</div>
      <div class="chat-time">${timeAgoShort(m.timestamp)}</div>
    </div>
  `).join('');
  
  msgs.scrollTop = msgs.scrollHeight;
  
  // Auto-delete setelah dibaca
  const msgBubbles = msgs.querySelectorAll('.chat-bubble');
  msgBubbles.forEach((bubble, index) => {
    setTimeout(() => {
      if (bubble && bubble.parentElement) {
        bubble.style.animation = 'vtBurn .7s ease forwards';
        setTimeout(() => {
          if (bubble.parentElement) {
            bubble.parentElement.remove();
          }
        }, 700);
      }
    }, 5000 + (index * 1000));
  });
}

function sendWsReply() {
  if (!activeWsThread) return;
  
  const input = $('wsThreadInput');
  const text = input.value.trim();
  if (!text) return;
  
  activeWsThread.thread.push({
    from: userName,
    content: text,
    timestamp: Date.now()
  });
  
  renderWsThread(activeWsThread);
  input.value = '';
}

// ==================== VOID TAP ====================
let vtQuota = 3;

function updateVtIndicator() {
  const indicator = $('vtIndicator').parentElement;
  if (voidTaps.filter(v => !v.read).length > 0) {
    indicator.classList.add('has-tap');
  } else {
    indicator.classList.remove('has-tap');
  }
}

function openVtCompose() {
  const isPremium = checkSubscription();
  if (!isPremium && vtQuota <= 0) {
    showVtUpgradeNudge();
    return;
  }
  
  $('vtCompose').classList.add('on');
  $('vtTextarea').value = '';
  $('vtCharCount').textContent = '0/150';
  
  if (isPremium) {
    $('vtQuota').textContent = 'premium ‚Ä¢ unlimited';
  } else {
    $('vtQuota').textContent = `sisa ${vtQuota}/3 hari ini`;
  }
  
  $('vtSendBtn').disabled = !isPremium && vtQuota <= 0;
}

function closeVtCompose() {
  $('vtCompose').classList.remove('on');
}

function sendVoidTap() {
  const isPremium = checkSubscription();
  
  if (!isPremium && vtQuota <= 0) {
    showVtUpgradeNudge();
    return;
  }
  
  const text = $('vtTextarea').value.trim();
  if (!text) return;
  
  if (!isPremium) vtQuota--;
  
  voidTaps.push({
    id: 'vt' + Date.now(),
    from: 'anonymous',
    content: text,
    timestamp: Date.now(),
    read: false
  });
  
  updateVtIndicator();
  toast('Void tap terkirim');
  closeVtCompose();
}

function checkVoidTaps() {
  const unread = voidTaps.filter(v => !v.read);
  if (unread.length === 0) {
    toast('Tidak ada void tap baru');
    return;
  }
  
  openVtReader(unread[0]);
}

function openVtReader(tap) {
  tap.read = true;
  updateVtIndicator();
  
  $('vtReader').classList.add('on');
  $('vtReaderFrom').textContent = `dari: @${tap.from}`;
  $('vtReaderMsg').textContent = tap.content;
  
  let timeLeft = 5;
  $('vtReaderTimer').textContent = `menghilang dalam ${timeLeft}s`;
  
  if (vtBurnTimer) clearInterval(vtBurnTimer);
  
  vtBurnTimer = setInterval(() => {
    timeLeft--;
    if (timeLeft <= 0) {
      clearInterval(vtBurnTimer);
      $('vtReader').classList.add('burning');
      setTimeout(() => {
        $('vtReader').classList.remove('on', 'burning');
      }, 700);
    } else {
      $('vtReaderTimer').textContent = `menghilang dalam ${timeLeft}s`;
    }
  }, 1000);
}

function showVtUpgradeNudge() {
  $('vtUpgradeNudge').classList.add('show');
  setTimeout(() => {
    $('vtUpgradeNudge').classList.remove('show');
  }, 3000);
}

function showUpgradeModal() {
  $('upgradeModal').classList.add('on');
}

// ==================== CALL CHAT API ====================
async function callChatAPI(userMessage, isFirstMessage = false) {
  if (!chatPartner || !chatPartner.isAI) return;
  
  if (apiOffline) {
    console.log('API is offline, skipping call');
    return;
  }
  
  const typingDiv = document.createElement('div');
  typingDiv.className = 'chat-msg other';
  typingDiv.innerHTML = '<div class="typing"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
  $('chatMessages').appendChild(typingDiv);
  typingDiv.scrollIntoView({ behavior: 'smooth' });
  
  try {
    let reply;
    
    if (USE_MOCK) {
      await new Promise(resolve => setTimeout(resolve, 1500));
      reply = isFirstMessage 
        ? `halo, gue ${chatPartner.name.split('.')[0]}. salam kenal üòä`
        : `${chatPartner.name.split('.')[0]}: iya nih, gue denger...`;
    } else {
      const payload = {
        message: isFirstMessage ? "halo" : userMessage,
        characterName: chatPartner.name,
        userName: userName,
        lastMessages: chatHistory.slice(-8)
      };
      
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(`API error: ${response.status} - ${errorData.error || 'Unknown error'}`);
      }
      
      const data = await response.json();
      if (!data.reply) throw new Error('Response tidak valid');
      
      reply = data.reply;
      
      if (data.distress) {
        const distressEl = $('distressMsg');
        distressEl.classList.add('show');
        distressEl.textContent = data.distress === 'high' 
          ? '‚ö†Ô∏è Perhatian: Partner menunjukkan tanda-tanda distress serius'
          : '‚ö†Ô∏è Partner terlihat sedih, respons dengan empati';
      }
    }
    
    typingDiv.remove();
    addMsg(reply, false);
    
    if (!isFirstMessage) chatHistory.push({ role: 'user', content: userMessage });
    chatHistory.push({ role: 'assistant', content: reply });
    
  } catch (error) {
    console.error('‚ùå Error calling chat API:', error);
    typingDiv.remove();
    
    apiOffline = true;
    toast('Gagal terhubung ke server chat', true);
    
    if (isFirstMessage) {
      const fallbackMsg = `halo, gue ${chatPartner.name.split('.')[0]}. salam kenal üòä`;
      addMsg(fallbackMsg, false);
      chatHistory.push({ role: 'assistant', content: fallbackMsg });
    }
  }
}

function sendMsg() {
  const input = $('chatInput');
  const text = input.value.trim();
  if (!text) return;
  
  addMsg(text, true);
  input.value = '';
  
  chatHistory.push({ role: 'user', content: text });
  
  if (chatPartner && chatPartner.isAI && !apiOffline) {
    callChatAPI(text);
  } else if (apiOffline) {
    toast('Server chat sedang offline', true);
  }
}

function addMsg(text, isOwn) {
  const messages = $('chatMessages');
  const msgDiv = document.createElement('div');
  msgDiv.className = 'chat-msg ' + (isOwn ? 'own' : 'other');
  
  const time = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
  
  msgDiv.innerHTML = `
    <div class="chat-bubble">${esc(text)}</div>
    <div class="chat-time">${time}</div>
  `;
  
  messages.appendChild(msgDiv);
  msgDiv.scrollIntoView({ behavior: 'smooth' });
}

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', () => {
  loadSubscription();
  initRadar();
  renderSpills();
  updateOnlineCount();
  updateWsBadge();
  updateVtIndicator();
  
  $('chatInput')?.addEventListener('keydown', e => { if (e.key === 'Enter') sendMsg(); });
  $('wsThreadInput')?.addEventListener('keydown', e => { if (e.key === 'Enter') sendWsReply(); });
  $('wsToInput')?.addEventListener('input', validateWsTo);
  $('wsBodyInput')?.addEventListener('input', validateWsBody);
  $('vtTextarea')?.addEventListener('input', function() {
    $('vtCharCount').textContent = this.value.length + '/150';
    const isPremium = checkSubscription();
    $('vtSendBtn').disabled = this.value.trim().length === 0 || (!isPremium && vtQuota <= 0);
  });
  
  window.addEventListener('beforeunload', () => {
    clearInterval(radarInterval);
    clearInterval(timerInterval);
    if (radarRAF) cancelAnimationFrame(radarRAF);
    if (fallbackTimer) clearTimeout(fallbackTimer);
  });
  
  setInterval(updateOnlineCount, 30000);
});
</script>
</body>
</html>
