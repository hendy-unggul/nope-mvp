<!DOCTYPE html>
<html lang="id" data-theme="glitch">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NOPE ‚Äî Nyambat</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,300;0,400;0,500;1,400&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0a;
      --surface: #121212;
      --border: #222222;
      --text: #e6e6e6;
      --muted: #8a8a8a;
      --accent: #b266ff;
      --logo-color: #ff9999;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-weight: 300;
      font-size: 14px;
      line-height: 1.55;
      padding-bottom: 72px;
    }
    .wrapper {
      max-width: 640px;
      margin: 0 auto;
      padding: 0 16px;
    }

    /* HEADER */
    header {
      position: sticky;
      top: 0;
      background: #000000cc;
      backdrop-filter: blur(6px);
      padding: 12px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
      margin-bottom: 20px;
    }
    .logo {
      font-family: 'Manrope', sans-serif;
      font-size: 28px;
      font-weight: 700;
      color: var(--logo-color);
    }
    .back-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }

    /* POST FORM */
    .post-form {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
    }
    .post-form textarea {
      width: 100%;
      background: #0a0a0a;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      resize: vertical;
      min-height: 80px;
      margin-bottom: 12px;
    }
    .post-form textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    .post-form input {
      width: 100%;
      background: #0a0a0a;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      margin-bottom: 12px;
    }
    .post-form input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .post-btn {
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
    }
    .post-btn:hover {
      background: #c284ff;
    }
    .post-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* THREAD */
    .thread {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .thread-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .thread-author {
      font-size: 13px;
      color: var(--accent);
      font-weight: 500;
    }
    .thread-tag {
      background: rgba(178, 102, 255, 0.15);
      color: var(--accent);
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    .thread-content {
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 12px;
      color: var(--text);
    }
    .thread-actions {
      display: flex;
      gap: 12px;
      font-size: 13px;
      color: var(--muted);
    }
    .thread-actions button {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 13px;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .thread-actions button:hover {
      background: rgba(178, 102, 255, 0.1);
      color: var(--accent);
    }

    /* COMMENTS */
    .comments-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .comment {
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .comment:last-child {
      border-bottom: none;
    }
    .comment-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .comment-author {
      font-size: 12px;
      color: var(--accent);
      font-weight: 500;
    }
    .comment-time {
      font-size: 11px;
      color: var(--muted);
    }
    .comment-content {
      font-size: 13px;
      line-height: 1.5;
      color: var(--text);
    }

    /* COMMENT FORM */
    .comment-form {
      margin-top: 12px;
      display: none;
    }
    .comment-form.active {
      display: block;
    }
    .comment-form textarea {
      width: 100%;
      background: #0a0a0a;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      resize: vertical;
      min-height: 60px;
      margin-bottom: 8px;
    }
    .comment-form textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    .comment-form-actions {
      display: flex;
      gap: 8px;
    }
    .comment-form-actions button {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }
    .comment-submit {
      background: var(--accent);
      color: #000;
    }
    .comment-cancel {
      background: var(--surface);
      border: 1px solid var(--border) !important;
      color: var(--muted);
    }

    .empty-state {
      text-align: center;
      color: var(--muted);
      padding: 40px 20px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <header>
      <div class="logo">NOPE</div>
      <button class="back-btn" onclick="window.location.href='saynope.html'">‚Üê Kembali</button>
    </header>

    <!-- POST FORM -->
    <div class="post-form">
      <textarea id="post-content" placeholder="Nyambat apa hari ini? (Contoh: Udah 3 hari ga tidur #skripsiblocked)"></textarea>
      <input id="post-tag" type="text" placeholder="1 tag (contoh: #skripsi atau #toxicboss)" maxlength="30">
      <button class="post-btn" id="post-btn">Kirim Nyambat!</button>
    </div>

    <!-- THREADS -->
    <div id="threads-container"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';

    const currentUser = localStorage.getItem('nope_username') || '@anon';

    async function supabaseFetch(table, method = 'GET', body = null, filter = '') {
      const headers = {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      };
      let url = `${SUPABASE_URL}/rest/v1/${table}${filter}`;
      let options = { method, headers };
      if (body) options.body = JSON.stringify(body);
      const res = await fetch(url, options);
      if (!res.ok) throw new Error(await res.text());
      return await res.json();
    }

    // POST NYAMBAT
    document.getElementById('post-btn').addEventListener('click', async () => {
      const content = document.getElementById('post-content').value.trim();
      const tag = document.getElementById('post-tag').value.trim();
      const btn = document.getElementById('post-btn');

      if (!content) {
        alert('Nyambat dulu dong!');
        return;
      }

      if (!tag || !tag.startsWith('#')) {
        alert('Tag harus dimulai dengan # (contoh: #skripsi)');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Posting...';

      try {
        // Extract hashtag from content if exists
        const contentWithTag = content.includes('#') ? content : `${content} ${tag}`;
        
        await supabaseFetch('rants', 'POST', {
          username: currentUser,
          content: contentWithTag,
          zone: 'nyambat'
        });

        document.getElementById('post-content').value = '';
        document.getElementById('post-tag').value = '';
        loadThreads();
      } catch (e) {
        alert('Gagal post: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Kirim Nyambat!';
      }
    });

    // LOAD THREADS
    async function loadThreads() {
      try {
        const threads = await supabaseFetch('rants', 'GET', null,
          `?zone=eq.nyambat&order=created_at.desc&limit=20`
        );

        const container = document.getElementById('threads-container');
        container.innerHTML = '';

        if (threads.length === 0) {
          container.innerHTML = '<div class="empty-state">Belum ada nyambat. Jadilah yang pertama!</div>';
          return;
        }

        for (const thread of threads) {
          const comments = await supabaseFetch('comments', 'GET', null,
            `?rant_id=eq.${thread.id}&order=created_at.asc`
          );

          const threadEl = createThreadElement(thread, comments);
          container.appendChild(threadEl);
        }
      } catch (e) {
        console.error('Load threads error:', e);
      }
    }

    // CREATE THREAD ELEMENT
    function createThreadElement(thread, comments) {
      const div = document.createElement('div');
      div.className = 'thread';

      // Extract hashtag
      const hashtagMatch = thread.content.match(/#\w+/);
      const hashtag = hashtagMatch ? hashtagMatch[0] : '#general';
      const contentWithoutTag = thread.content.replace(/#\w+/g, '').trim();

      div.innerHTML = `
        <div class="thread-header">
          <span class="thread-author">@${thread.username}</span>
          <span class="thread-tag">${hashtag}</span>
        </div>
        <div class="thread-content">${contentWithoutTag}</div>
        <div class="thread-actions">
          <button onclick="toggleCommentForm('${thread.id}')">üí¨ ${comments.length} Komentar</button>
          <button onclick="reactToThread('${thread.id}', 'üî•')">üî•</button>
          <button onclick="reactToThread('${thread.id}', 'ü´Ç')">ü´Ç</button>
        </div>
        <div class="comments-section" id="comments-${thread.id}">
          ${renderComments(comments)}
        </div>
        <div class="comment-form" id="comment-form-${thread.id}">
          <textarea id="comment-text-${thread.id}" placeholder="Tulis komentar..."></textarea>
          <div class="comment-form-actions">
            <button class="comment-submit" onclick="postComment('${thread.id}')">Kirim</button>
            <button class="comment-cancel" onclick="toggleCommentForm('${thread.id}')">Batal</button>
          </div>
        </div>
      `;

      return div;
    }

    // RENDER COMMENTS
    function renderComments(comments) {
      if (comments.length === 0) {
        return '<div style="color: var(--muted); font-size: 12px; padding: 8px 0;">Belum ada komentar</div>';
      }

      return comments.map(c => `
        <div class="comment">
          <div class="comment-header">
            <span class="comment-author">@${c.username}</span>
            <span class="comment-time">${formatTime(c.created_at)}</span>
          </div>
          <div class="comment-content">${c.content}</div>
        </div>
      `).join('');
    }

    // TOGGLE COMMENT FORM
    function toggleCommentForm(threadId) {
      const form = document.getElementById(`comment-form-${threadId}`);
      form.classList.toggle('active');
    }

    // POST COMMENT
    async function postComment(threadId) {
      const textarea = document.getElementById(`comment-text-${threadId}`);
      const content = textarea.value.trim();

      if (!content) {
        alert('Komentar tidak boleh kosong');
        return;
      }

      try {
        await supabaseFetch('comments', 'POST', {
          rant_id: threadId,
          username: currentUser,
          content: content
        });

        textarea.value = '';
        toggleCommentForm(threadId);
        loadThreads(); // Reload to show new comment
      } catch (e) {
        alert('Gagal post komentar: ' + e.message);
      }
    }

    // REACT TO THREAD (placeholder)
    async function reactToThread(threadId, emoji) {
      try {
        await supabaseFetch('reactions', 'POST', {
          rant_id: threadId,
          user_id: currentUser,
          emoji: emoji
        });
        console.log(`Reacted with ${emoji}`);
      } catch (e) {
        console.log('Reaction error:', e);
      }
    }

    // FORMAT TIME
    function formatTime(timestamp) {
      if (!timestamp) return 'baru saja';
      const date = new Date(timestamp);
      const now = new Date();
      const diff = Math.floor((now - date) / 1000);

      if (diff < 60) return 'baru saja';
      if (diff < 3600) return `${Math.floor(diff / 60)}m`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}j`;
      return `${Math.floor(diff / 86400)}h`;
    }

    // INIT
    loadThreads();
    
    // Auto-refresh every 10 seconds
    setInterval(loadThreads, 10000);
  </script>
</body>
</html>
