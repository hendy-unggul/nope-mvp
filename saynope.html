<!DOCTYPE html>
<html lang="id" data-theme="brutalgenz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>NOPE ‚Äî Spill the Tea</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23FF4D00'/%3E%3Ctext x='50' y='70' font-size='50' font-weight='bold' font-family='system-ui' text-anchor='middle' fill='%230A0A0A'%3Eüçµ%3C/text%3E%3C/svg%3E">
  <meta name="theme-color" content="#0A0A0A">
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0A0A0A; --surface: #141414; --surface-elevated: #1E1E1E;
      --border: #2A2A2A; --border-accent: #FF4D00;
      --text: #FFFFFF; --text-secondary: #888888; --text-muted: #555555;
      --accent-primary: #FF4D00; --accent-secondary: #00F0FF;
      --accent-tertiary: #FF006E; --accent-quaternary: #39FF14; --accent-warm: #FFD700;
      --mood-surviving: #FF9500; --mood-thriving: #39FF14; --mood-chaotic: #00F0FF; --mood-doom: #8B5CF6;
      --radius: 0px; --radius-sm: 4px;
      --space-xs: 4px; --space-sm: 8px; --space-md: 16px; --space-lg: 24px; --space-xl: 32px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html { scroll-behavior: smooth; }
    body { background: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', system-ui, sans-serif; font-weight: 500; font-size: 15px; line-height: 1.4; min-height: 100vh; overflow-x: hidden; padding-bottom: 100px; }
    body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E"); pointer-events: none; z-index: 9999; opacity: 0.4; }
    .wrapper { max-width: 480px; margin: 0 auto; padding: 0 var(--space-md); }

    header { padding: var(--space-lg) 0 var(--space-md); border-bottom: 2px solid var(--border); margin-bottom: var(--space-md); display: flex; justify-content: space-between; align-items: center; }
    .header-title { font-size: 32px; font-weight: 800; letter-spacing: -0.04em; color: var(--text); line-height: 0.9; display: inline-flex; align-items: center; gap: var(--space-sm); }
    .header-title::before { content: 'üçµ'; filter: grayscale(0.3); }
    .header-user { font-size: 11px; font-weight: 700; color: var(--accent-primary); letter-spacing: 0.05em; text-transform: uppercase; }
    .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); display: inline-block; margin-right: 4px; }
    .sync-dot.live { background: var(--accent-quaternary); animation: blink 1.5s infinite; }

    .page-header { margin: var(--space-lg) 0; padding-bottom: var(--space-md); border-bottom: 2px solid var(--border); }
    .page-subtitle { font-family: 'Instrument Serif', serif; font-size: 16px; font-style: italic; color: var(--text-secondary); margin-bottom: var(--space-xs); }
    .page-tagline { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.15em; color: var(--accent-primary); }

    .vibrasi-filter { background: var(--surface); border: 2px solid var(--border); padding: var(--space-md); margin-bottom: var(--space-lg); position: relative; }
    .vibrasi-filter::before { content: 'FILTER VIBRASI'; position: absolute; top: -10px; left: var(--space-md); background: var(--bg); padding: 0 var(--space-xs); font-size: 10px; font-weight: 700; color: var(--text-muted); letter-spacing: 0.1em; }
    .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md); margin-top: var(--space-xs); }
    .filter-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; }
    .filter-stats { font-size: 11px; color: var(--accent-primary); font-weight: 700; }
    .filter-reset { font-size: 11px; color: var(--accent-primary); cursor: pointer; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; border: 1px solid var(--border); background: none; padding: var(--space-xs) var(--space-sm); transition: all 0.2s; }
    .filter-reset:hover { background: var(--accent-primary); color: var(--bg); border-color: var(--accent-primary); }
    .filter-slider { width: 100%; height: 4px; background: var(--border); outline: none; -webkit-appearance: none; margin: var(--space-md) 0; }
    .filter-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--accent-primary); cursor: pointer; border: 2px solid var(--text); box-shadow: 2px 2px 0 var(--bg), 2px 2px 0 2px var(--accent-primary); }
    .filter-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
    .mood-chips { display: flex; gap: var(--space-xs); flex-wrap: wrap; margin-top: var(--space-md); }
    .mood-chip { padding: 4px 12px; border: 1px solid var(--border); font-size: 11px; font-weight: 700; cursor: pointer; color: var(--text-muted); transition: all 0.15s; text-transform: uppercase; letter-spacing: 0.05em; background: none; }
    .mood-chip.active { background: var(--accent-primary); border-color: var(--accent-primary); color: var(--bg); }
    .mood-chip[data-mood="surviving"].active { background: var(--mood-surviving); border-color: var(--mood-surviving); }
    .mood-chip[data-mood="thriving"].active { background: var(--mood-thriving); border-color: var(--mood-thriving); color: var(--bg); }
    .mood-chip[data-mood="chaotic"].active { background: var(--mood-chaotic); border-color: var(--mood-chaotic); color: var(--bg); }
    .mood-chip[data-mood="doom"].active { background: var(--mood-doom); border-color: var(--mood-doom); }

    /* NEW SPILL BANNER */
    .new-spill-banner { display: none; text-align: center; padding: var(--space-sm); background: var(--accent-primary); color: var(--bg); font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.08em; cursor: pointer; margin-bottom: var(--space-md); }
    .new-spill-banner.show { display: block; animation: slideDown 0.3s ease; }
    @keyframes slideDown { from { transform: translateY(-20px); opacity:0; } to { transform: translateY(0); opacity:1; } }

    .tea-container { display: flex; flex-direction: column; gap: var(--space-md); }
    .tea-card { background: var(--surface); border: 2px solid var(--border); padding: var(--space-md); position: relative; transition: all 0.2s; animation: slideIn 0.4s ease; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .tea-card:hover { border-color: var(--border-accent); transform: translateY(-2px); box-shadow: 4px 4px 0 var(--surface-elevated); }
    .tea-card.dimmed { opacity: 0.4; filter: grayscale(0.7); }
    .tea-card.highlighted { border-color: var(--accent-primary); box-shadow: 4px 4px 0 var(--accent-primary); }
    .resonance-badge { position: absolute; top: -12px; right: var(--space-md); background: var(--accent-primary); color: var(--bg); font-size: 10px; font-weight: 800; padding: 4px 12px; text-transform: uppercase; letter-spacing: 0.05em; display: none; border: 2px solid var(--bg); }
    .tea-card.highlighted .resonance-badge { display: block; }
    .live-badge { position: absolute; top: -12px; left: var(--space-md); background: var(--accent-quaternary); color: var(--bg); font-size: 9px; font-weight: 800; padding: 4px 10px; display: flex; align-items: center; gap: 4px; border: 2px solid var(--bg); animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.7; } }
    .live-indicator { width: 6px; height: 6px; background: var(--bg); border-radius: 50%; animation: blink 1s infinite; }
    @keyframes blink { 0%,100% { opacity:1; } 50% { opacity:0.3; } }
    .trending-badge { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: var(--accent-tertiary); color: var(--bg); font-size: 9px; font-weight: 800; padding: 4px 10px; text-transform: uppercase; letter-spacing: 0.05em; border: 2px solid var(--bg); }
    .tea-header { display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-sm); padding-bottom: var(--space-sm); border-bottom: 1px solid var(--border); }
    .tea-avatar { width: 40px; height: 40px; background: var(--surface-elevated); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 800; font-family: monospace; flex-shrink: 0; cursor: pointer; transition: all 0.2s; color: var(--text-secondary); }
    .tea-avatar:hover { border-color: var(--accent-primary); transform: scale(1.1); }
    .tea-meta { flex: 1; min-width: 0; }
    .tea-user { font-size: 13px; font-weight: 700; color: var(--text); cursor: pointer; display: inline-flex; align-items: center; gap: var(--space-xs); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-transform: uppercase; letter-spacing: 0.02em; }
    .tea-user:hover { color: var(--accent-primary); }
    .tea-time { font-size: 11px; color: var(--text-muted); font-weight: 600; }
    .tea-mood { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; padding: 4px 8px; border: 1px solid currentColor; }
    .tea-mood.surviving { color: var(--mood-surviving); }
    .tea-mood.thriving { color: var(--mood-thriving); }
    .tea-mood.chaotic { color: var(--mood-chaotic); }
    .tea-mood.doom { color: var(--mood-doom); }
    .tea-content { font-size: 15px; line-height: 1.6; color: var(--text); margin-bottom: var(--space-md); display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    .tea-content.expanded { -webkit-line-clamp: unset; }
    .read-more { font-size: 11px; color: var(--accent-primary); cursor: pointer; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-md); display: inline-block; border-bottom: 1px solid var(--accent-primary); }
    .vibe-section { border-top: 1px solid var(--border); padding-top: var(--space-sm); }
    .vibe-reactions { display: flex; flex-wrap: wrap; gap: var(--space-xs); }
    .vibe-btn { display: flex; align-items: center; gap: var(--space-xs); padding: 8px 12px; background: var(--surface-elevated); border: 1px solid var(--border); cursor: pointer; transition: all 0.15s; font-size: 12px; color: var(--text-secondary); position: relative; font-weight: 600; }
    .vibe-btn:hover:not(.used):not(.disabled) { background: var(--surface); border-color: var(--text-secondary); color: var(--text); transform: translateY(-1px); }
    .vibe-btn.used { background: var(--accent-primary); border-color: var(--accent-primary); color: var(--bg); cursor: default; }
    .vibe-btn.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
    .vibe-btn .emoji { font-size: 16px; line-height: 1; }
    .vibe-btn .count { font-size: 11px; font-weight: 700; min-width: 16px; text-align: center; }
    .vibe-tooltip { position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: var(--text); color: var(--bg); padding: 6px 10px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; opacity: 0; visibility: hidden; transition: all 0.2s; pointer-events: none; z-index: 1000; }
    .vibe-btn:hover:not(.used):not(.disabled) .vibe-tooltip { opacity: 1; visibility: visible; }

    /* PEEK OVERLAY */
    .jejak-peek-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 9998; display: none; flex-direction: column; overflow-y: auto; animation: slideUp 0.3s ease; }
    .jejak-peek-overlay.show { display: flex; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .peek-header { background: var(--surface); border-bottom: 2px solid var(--border); padding: var(--space-md); position: sticky; top: 0; z-index: 100; display: flex; align-items: center; justify-content: space-between; }
    .peek-timer { display: flex; align-items: center; gap: var(--space-sm); font-size: 14px; font-weight: 700; color: var(--accent-primary); background: var(--surface-elevated); padding: 8px 16px; border: 2px solid var(--accent-primary); }
    .peek-timer.pulse { animation: timerPulse 1s infinite; }
    @keyframes timerPulse { 0%,100% { opacity:1; transform:scale(1); } 50% { opacity:0.7; transform:scale(1.05); } }
    .typing-indicator { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-muted); font-weight: 600; margin-top: var(--space-xs); }
    .typing-dots { display: flex; gap: 3px; }
    .typing-dots span { width: 6px; height: 6px; background: var(--accent-primary); border-radius: 50%; animation: typingBounce 1.4s infinite ease-in-out both; }
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typingBounce { 0%,80%,100% { transform:scale(0); } 40% { transform:scale(1); } }
    .peek-content { flex: 1; padding: var(--space-md); max-width: 480px; margin: 0 auto; width: 100%; }
    .peek-profile { text-align: center; padding: var(--space-lg) 0; border-bottom: 2px solid var(--border); margin-bottom: var(--space-lg); }
    .peek-avatar-big { width: 100px; height: 100px; background: var(--surface-elevated); border: 3px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: 800; font-family: monospace; margin: 0 auto var(--space-md); position: relative; color: var(--text-secondary); }
    .peek-avatar-big::after { content: 'üëÅÔ∏è'; position: absolute; bottom: -5px; right: -5px; background: var(--accent-primary); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 2px solid var(--bg); }
    .peek-username { font-size: 20px; font-weight: 800; margin-bottom: var(--space-xs); text-transform: uppercase; letter-spacing: 0.02em; }
    .online-status { font-size: 11px; color: var(--accent-quaternary); font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 4px; margin-top: 4px; }
    .online-dot { width: 6px; height: 6px; background: var(--accent-quaternary); border-radius: 50%; animation: blink 2s infinite; }
    .peek-stats { display: flex; justify-content: center; gap: var(--space-lg); margin-top: var(--space-md); font-size: 11px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
    .peek-entry { background: var(--surface); border: 2px solid var(--border); padding: var(--space-md); margin-bottom: var(--space-md); position: relative; transition: all 0.5s ease; }
    .peek-entry.locked { filter: blur(8px); opacity: 0.3; pointer-events: none; }
    .peek-entry.revealed { filter: blur(0); opacity: 1; animation: revealEntry 0.5s ease; }
    @keyframes revealEntry { from { filter:blur(8px); opacity:0.3; transform:translateY(10px); } to { filter:blur(0); opacity:1; transform:translateY(0); } }
    .peek-entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-sm); }
    .peek-entry-mood { font-size: 12px; font-weight: 700; color: var(--accent-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
    .peek-entry-time { font-size: 11px; color: var(--text-muted); font-weight: 600; }
    .peek-entry-content { font-size: 14px; line-height: 1.6; color: var(--text); font-family: 'Instrument Serif', serif; font-style: italic; }
    .unlock-hint { position: absolute; bottom: var(--space-md); left: 50%; transform: translateX(-50%); background: var(--accent-primary); color: var(--bg); padding: 6px 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; }
    .peek-extend { text-align: center; padding: var(--space-lg); border-top: 2px dashed var(--border); margin-top: var(--space-lg); background: var(--surface); }
    .peek-extend-text { font-size: 12px; color: var(--text-secondary); margin-bottom: var(--space-md); font-weight: 600; }
    .peek-reactions { display: flex; flex-wrap: wrap; gap: var(--space-xs); justify-content: center; }
    .peek-reaction-btn { display: flex; align-items: center; gap: 4px; padding: 8px 14px; background: var(--surface-elevated); border: 1px solid var(--border); cursor: pointer; font-size: 12px; color: var(--text-secondary); transition: all 0.2s; font-weight: 700; }
    .peek-reaction-btn:hover { background: var(--accent-primary); border-color: var(--accent-primary); color: var(--bg); transform: scale(1.05); }
    .peek-reaction-btn.given { background: var(--accent-primary); border-color: var(--accent-primary); color: var(--bg); }
    .peek-locked { text-align: center; padding: var(--space-xl) var(--space-md); background: var(--surface); border: 2px dashed var(--border); margin-top: var(--space-lg); }
    .peek-locked-icon { font-size: 40px; margin-bottom: var(--space-md); opacity: 0.5; }
    .peek-locked-text { font-family: 'Instrument Serif', serif; font-size: 16px; font-style: italic; color: var(--text-secondary); margin-bottom: var(--space-md); }
    .peek-back-btn { background: none; border: 2px solid var(--border); color: var(--text); font-size: 18px; cursor: pointer; padding: var(--space-sm); width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-weight: 700; }
    .peek-back-btn:hover { background: var(--accent-primary); border-color: var(--accent-primary); color: var(--bg); }

    /* GETARAN */
    .getaran-section { margin-top: var(--space-xl); margin-bottom: var(--space-xl); }
    .getaran-header { font-size: 11px; font-weight: 800; color: var(--text); letter-spacing: 0.15em; text-transform: uppercase; margin-bottom: var(--space-md); padding-bottom: var(--space-sm); border-bottom: 2px solid var(--border); position: relative; }
    .getaran-header::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 60px; height: 2px; background: var(--accent-primary); }
    .getaran-card { background: var(--surface); border: 2px solid var(--border); padding: var(--space-md); margin-bottom: var(--space-md); transition: all 0.2s; }
    .getaran-card:hover { border-color: var(--border-accent); }
    .getaran-content { display: flex; gap: var(--space-md); margin-bottom: var(--space-md); }
    .getaran-icon { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; border: 2px solid var(--border); background: var(--surface-elevated); }
    .getaran-icon.blue { border-color: var(--accent-secondary); }
    .getaran-icon.neutral { border-color: var(--text-muted); }
    .getaran-title { font-size: 14px; font-weight: 600; color: var(--text); line-height: 1.4; margin-bottom: var(--space-sm); }
    .getaran-list { list-style: none; }
    .getaran-list li { font-size: 12px; color: var(--text-secondary); margin-bottom: var(--space-xs); display: flex; align-items: center; gap: var(--space-sm); font-weight: 500; }
    .getaran-list li::before { content: '>'; color: var(--accent-primary); font-weight: 700; }
    .getaran-actions { display: flex; gap: var(--space-sm); padding-left: 64px; }
    .getaran-btn { padding: 10px 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; transition: all 0.2s; border: 2px solid var(--border); background: transparent; }
    .getaran-btn.skip { color: var(--text-muted); }
    .getaran-btn.skip:hover { color: var(--text); background: var(--surface-elevated); }
    .getaran-btn.primary { background: var(--text); color: var(--bg); border-color: var(--text); }
    .getaran-btn.primary:hover { background: var(--accent-primary); border-color: var(--accent-primary); transform: translateY(-1px); }

    /* EMPTY & LOADING */
    .homie-empty { text-align: center; padding: var(--space-xl) var(--space-md); background: var(--surface); border: 2px dashed var(--border); margin: var(--space-lg) 0; display: none; }
    .homie-empty-icon { font-size: 48px; margin-bottom: var(--space-md); display: block; animation: float 3s ease-in-out infinite; }
    @keyframes float { 0%,100% { transform:translateY(0); } 50% { transform:translateY(-10px); } }
    .homie-empty-title { font-size: 16px; font-weight: 800; color: var(--text); margin-bottom: var(--space-sm); text-transform: uppercase; letter-spacing: 0.05em; }
    .homie-empty-text { font-family: 'Instrument Serif', serif; font-size: 16px; font-style: italic; color: var(--text-secondary); line-height: 1.5; margin-bottom: var(--space-md); }
    .homie-empty-btn { background: var(--accent-primary); color: var(--bg); border: none; padding: 12px 24px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; transition: all 0.2s; box-shadow: 4px 4px 0 var(--surface-elevated), 4px 4px 0 2px var(--accent-primary); }
    .loading-state { text-align: center; padding: var(--space-xl); border: 2px dashed var(--border); }
    .loading-spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto var(--space-md); }
    @keyframes spin { from { transform:rotate(0deg); } to { transform:rotate(360deg); } }

    .scroll-pause { text-align: center; padding: var(--space-lg); margin: var(--space-lg) 0; border: 2px dashed var(--border); background: var(--surface); display: none; }
    .scroll-pause.show { display: block; animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
    .scroll-pause-text { font-family: 'Instrument Serif', serif; font-size: 16px; font-style: italic; color: var(--text-secondary); margin-bottom: var(--space-md); }
    .scroll-pause-btn { background: var(--surface-elevated); border: 2px solid var(--border); color: var(--text); padding: 10px 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; transition: all 0.2s; }
    .scroll-pause-btn:hover { background: var(--accent-primary); border-color: var(--accent-primary); color: var(--bg); }

    .refresh-container { text-align: center; margin: var(--space-xl) 0; }
    .refresh-btn { background: var(--surface); border: 2px solid var(--accent-primary); color: var(--accent-primary); padding: 12px 28px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; display: inline-flex; align-items: center; gap: var(--space-sm); transition: all 0.2s; box-shadow: 4px 4px 0 var(--surface-elevated), 4px 4px 0 2px var(--accent-primary); }
    .refresh-btn:hover { background: var(--accent-primary); color: var(--bg); transform: translate(2px,2px); box-shadow: 2px 2px 0 var(--surface-elevated); }
    .refresh-btn.spinning .emoji { animation: spin 1s linear infinite; }

    .zone-footer { text-align: center; font-family: 'Instrument Serif', serif; font-size: 14px; font-style: italic; color: var(--text-muted); padding: var(--space-xl) 0; margin-bottom: 80px; border-top: 2px solid var(--border); }

    .notification { position: fixed; top: var(--space-md); left: 50%; transform: translateX(-50%) translateY(-100px); background: var(--text); color: var(--bg); padding: 12px 24px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; z-index: 10002; opacity: 0; transition: all 0.3s; border: 2px solid var(--bg); box-shadow: 4px 4px 0 var(--accent-primary); pointer-events: none; white-space: nowrap; }
    .notification.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    .reciprocity-toast { position: fixed; top: var(--space-md); left: 50%; transform: translateX(-50%) translateY(-100px); background: var(--accent-quaternary); color: var(--bg); padding: 12px 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; z-index: 10003; opacity: 0; transition: all 0.3s; border: 2px solid var(--bg); box-shadow: 4px 4px 0 var(--accent-primary); display: flex; align-items: center; gap: var(--space-sm); }
    .reciprocity-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* NARRATIVE ARC */
    .narrative-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10004; display: none; align-items: center; justify-content: center; padding: var(--space-md); text-align: center; }
    .narrative-overlay.show { display: flex; animation: fadeIn 0.5s ease; }
    .narrative-content { max-width: 320px; }
    .narrative-icon { font-size: 60px; margin-bottom: var(--space-lg); animation: float 3s ease-in-out infinite; }
    .narrative-title { font-size: 20px; font-weight: 800; margin-bottom: var(--space-md); text-transform: uppercase; letter-spacing: 0.05em; }
    .narrative-text { font-family: 'Instrument Serif', serif; font-size: 16px; font-style: italic; color: var(--text-secondary); line-height: 1.6; margin-bottom: var(--space-xl); }
    .narrative-btn { background: var(--accent-primary); color: var(--bg); border: none; padding: 14px 28px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; transition: all 0.2s; box-shadow: 4px 4px 0 var(--surface-elevated), 4px 4px 0 2px var(--accent-primary); }
    .narrative-cliffhanger { font-size: 11px; color: var(--text-muted); margin-top: var(--space-lg); font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; }

    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 2px solid var(--border); z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
    .nav-container { max-width: 480px; margin: 0 auto; display: flex; justify-content: space-around; align-items: center; height: 64px; }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; height: 100%; color: var(--text-muted); text-decoration: none; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; transition: all 0.2s; position: relative; cursor: pointer; }
    .nav-item::before { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 0; height: 2px; background: var(--accent-primary); transition: width 0.2s; }
    .nav-item:hover { color: var(--text-secondary); background: var(--surface-elevated); }
    .nav-item.active { color: var(--accent-primary); }
    .nav-item.active::before { width: 100%; }
    .nav-icon { font-size: 20px; line-height: 1; }
  </style>
<base target="_blank">
</head>
<body>
  <div class="wrapper">
    <header>
      <div class="header-title">Spill the Tea</div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span class="sync-dot" id="sync-dot"></span>
        <span class="header-user" id="header-username">@...</span>
      </div>
    </header>

    <div class="page-header">
      <p class="page-subtitle">Curhatan dari komunitas yang selaras dengan vibrasimu</p>
      <div class="page-tagline" id="spill-tagline">Memuat spills...</div>
    </div>

    <div class="new-spill-banner" id="new-spill-banner" onclick="loadPendingSpills()">‚Üë Ada spill baru! Tap untuk lihat</div>

    <div class="vibrasi-filter">
      <div class="filter-header">
        <span class="filter-title">Kesamaan Vibrasi</span>
        <span class="filter-stats" id="filter-stats"></span>
        <button class="filter-reset" onclick="resetFilter()">Reset</button>
      </div>
      <input type="range" class="filter-slider" id="filter-slider" min="0" max="100" value="80" oninput="adjustResonance(this.value)">
      <div class="filter-labels"><span>Homie Only</span><span>Semi-Selaras</span><span>Semua</span></div>
      <div class="mood-chips">
        <button class="mood-chip active" data-mood="all" onclick="setMoodFilter('all')">Semua</button>
        <button class="mood-chip" data-mood="surviving" onclick="setMoodFilter('surviving')">üòÆ‚Äçüí® Surviving</button>
        <button class="mood-chip" data-mood="thriving" onclick="setMoodFilter('thriving')">‚ú® Thriving</button>
        <button class="mood-chip" data-mood="chaotic" onclick="setMoodFilter('chaotic')">üåÄ Chaotic</button>
        <button class="mood-chip" data-mood="doom" onclick="setMoodFilter('doom')">üõå Doom</button>
      </div>
    </div>

    <div class="tea-container" id="tea-container">
      <div class="loading-state"><div class="loading-spinner"></div><div style="font-size:11px;color:var(--text-muted);font-weight:700;text-transform:uppercase;letter-spacing:0.1em;">Menyeduh teh...</div></div>
    </div>

    <div class="homie-empty" id="homie-empty">
      <span class="homie-empty-icon">üåå</span>
      <div class="homie-empty-title">Belum Ada yang Selaras</div>
      <div class="homie-empty-text">Vibrasimu unik! Coba turunkan tingkat resonansi atau tulis di JEJAK dulu.</div>
      <button class="homie-empty-btn" onclick="resetFilter()">Buka Filter Lebar</button>
    </div>

    <div class="refresh-container">
      <button class="refresh-btn" id="refresh-btn" onclick="refreshTea()">
        <span class="emoji">üîÑ</span> Seduh Teh Baru
      </button>
    </div>

    <div class="getaran-section" id="getaran-section" style="display:none;">
      <div class="getaran-header">Getaran yang Cocok</div>
      <div id="getaran-cards"></div>
    </div>

    <div class="zone-footer">Nyambat ‚Ä¢ Aksi ‚Ä¢ Solusi</div>
  </div>

  <!-- PEEK OVERLAY -->
  <div class="jejak-peek-overlay" id="jejak-peek-overlay">
    <div class="peek-header">
      <button class="peek-back-btn" onclick="closePeek()">‚Üê</button>
      <div class="peek-timer" id="peek-timer"><span>üëÅÔ∏è</span><span id="timer-count">15</span>s</div>
    </div>
    <div class="peek-content">
      <div class="peek-profile">
        <div class="peek-avatar-big" id="peek-avatar-big">??</div>
        <div class="peek-username" id="peek-username">@user</div>
        <div class="online-status" id="online-status" style="display:none;"><span class="online-dot"></span><span>Online sekarang</span></div>
        <div class="typing-indicator" id="typing-indicator" style="display:none;"><span>Sedang melihat profilmu</span><div class="typing-dots"><span></span><span></span><span></span></div></div>
        <div class="peek-stats">
          <div><span id="peek-entry-count">0</span> Entries</div>
          <div><span id="peek-vibe-count">0</span> Vibes</div>
        </div>
      </div>
      <div id="peek-entries-container"></div>
      <div class="peek-extend" id="peek-extend-section">
        <div class="peek-extend-text">Kasih reaksi untuk tambah waktu peeking +15 detik</div>
        <div class="peek-reactions" id="peek-reactions"></div>
      </div>
      <div class="peek-locked" id="peek-locked" style="display:none;">
        <div class="peek-locked-icon">üîí</div>
        <div class="peek-locked-text">Waktu habis! Reaksi untuk buka lagi.</div>
      </div>
    </div>
  </div>

  <div class="reciprocity-toast" id="reciprocity-toast"><span>üëÅÔ∏è</span><span id="reciprocity-text"></span></div>
  <div class="narrative-overlay" id="narrative-overlay" onclick="closeNarrative(event)">
    <div class="narrative-content" onclick="event.stopPropagation()">
      <div class="narrative-icon" id="narrative-icon">‚ú®</div>
      <div class="narrative-title" id="narrative-title"></div>
      <div class="narrative-text" id="narrative-text"></div>
      <button class="narrative-btn" onclick="closeNarrative()">Lanjutkan</button>
      <div class="narrative-cliffhanger" id="narrative-cliffhanger"></div>
    </div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-container">
      <a href="jejak.html" class="nav-item"><span class="nav-icon">‚ú¶</span><span>Jejak</span></a>
      <a href="cocomeo.html" class="nav-item"><span class="nav-icon">„Äú</span><span>Cocomeo</span></a>
      <a href="saynope.html" class="nav-item active"><span class="nav-icon">‚úï</span><span>Spill</span></a>
      <a href="glitch.html" class="nav-item"><span class="nav-icon">‚ö°</span><span>Glitch</span></a>
    </div>
  </nav>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SUPABASE CONFIG
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SESSION CHECK
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const SESSION = (() => {
      const username = localStorage.getItem('jejak_username');
      const loggedIn = localStorage.getItem('jejak_logged_in');
      if (!loggedIn || !username) { window.location.href = 'index.html'; return null; }
      return { username };
    })();
    if (!SESSION) throw new Error('No session');

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONSTANTS - Mapping emoji ke tabel reactions
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CHANGED: ‚úä (fist) ‚Üí üíÄ (skeleton/dead)
    const VIBE_REACTIONS = {
      relatable: { emoji: 'üíØ', label: 'literally me',  slang: 'Sama', dbEmoji: 'üíØ' },
      mood:      { emoji: 'üõãÔ∏è', label: 'big mood',     slang: 'Mood', dbEmoji: 'üõãÔ∏è' },
      hug:       { emoji: 'ü§ó', label: 'virtual hug',  slang: 'Peluk', dbEmoji: 'ü§ó' },
      tea:       { emoji: 'üê∏', label: 'spill tea',    slang: 'Tea', dbEmoji: 'üê∏' },
      real:      { emoji: 'üéØ', label: 'no cap',       slang: 'Real', dbEmoji: 'üéØ' },
      dead:      { emoji: 'üíÄ', label: 'rip me',       slang: 'RIP', dbEmoji: 'üíÄ' }  // CHANGED from ‚úä
    };

    // Reverse mapping dari emoji DB ke key
    const EMOJI_TO_KEY = {
      'üíØ': 'relatable',
      'üõãÔ∏è': 'mood',
      'ü§ó': 'hug',
      'üê∏': 'tea',
      'üéØ': 'real',
      'üíÄ': 'dead'  // CHANGED from ‚úä
    };

    const MOOD_META = {
      surviving: { emoji: 'üòÆ‚Äçüí®', color: '#FF9500', kw: ['capek','lelah','burnout','gabut','bosan','overwhelmed'] },
      thriving:  { emoji: '‚ú®',   color: '#39FF14', kw: ['happy','senang','bagus','mantap','great','semangat'] },
      chaotic:   { emoji: 'üåÄ',   color: '#00F0FF', kw: ['chaos','overthinking','random','absurd','rusuh','gila'] },
      doom:      { emoji: 'üõå',   color: '#8B5CF6', kw: ['sedih','down','hopeless','galau','menyerah','hancur'] }
    };

    // Dummy spills ‚Äî onboarding filler
    const DUMMY_SPILLS = [
      { id:'__d1', author:'overthinker_3am', mood:'chaotic', isDummy:true, isLive:true, viewers:12,
        content:'kenapa ya tiap kali mau tidur malah jadi overthinking? padahal besok ada deadline tapi otak malah playback cringe moment dari 5 tahun lalu üíÄ',
        vibes:{ relatable:45, mood:23, hug:18, tea:5, real:12, dead:8 }, created_at: new Date(Date.now()-1200000).toISOString(),
        journal:[{mood:'üåÄ',time:'3:42 AM',content:'masih scrolling padahal mata udah ngantuk'},{mood:'üò∞',time:'2:15 AM',content:'typo ke grup kantor bikin gabisa tidur'}]
      },
      { id:'__d2', author:'anak_pertama_capek', mood:'surviving', isDummy:true, isLive:false, viewers:8,
        content:'capek banget jadi anak pertama, semua ekspektasi ditimpa ke gue padahal gue juga lagi struggling. mau ngeluh ke ortu takut dianggap lemah üò≠',
        vibes:{ relatable:67, mood:12, hug:34, tea:8, real:20, dead:5 }, created_at: new Date(Date.now()-3600000).toISOString(),
        journal:[{mood:'üí∏',time:'8:00 PM',content:'adik minta duit lagi, gue sendiri udah hemat banget'},{mood:'üòî',time:'6:30 PM',content:'pengen curhat tapi gaada yang ngerti situasi gue'}]
      },
      { id:'__d3', author:'ghosted_again', mood:'doom', isDummy:true, isLive:true, viewers:24,
        content:'read 10:42 pm. read 10:43 pm. online. typing... then gone. story update tapi chat gue dibiarin üôÉ',
        vibes:{ relatable:56, mood:34, hug:20, tea:89, real:15, dead:10 }, created_at: new Date(Date.now()-7200000).toISOString(),
        journal:[{mood:'üì±',time:'11:00 PM',content:'checking chat tiap 5 menit'},{mood:'üíî',time:'10:00 PM',content:'kenapa orang bisa tiba-tiba hilang gitu aja'}]
      },
      { id:'__d4', author:'burnout_resigned', mood:'thriving', isDummy:true, isLive:false, viewers:15,
        content:'resign dari kerjaan pertama setelah 6 bulan. toxic workplace, gaslighting boss. no regrets, mental health first ‚ú®',
        vibes:{ relatable:30, mood:18, hug:25, tea:38, real:92, dead:3 }, created_at: new Date(Date.now()-10800000).toISOString(),
        journal:[{mood:'üéâ',time:'Hari ini',content:'FINALLY FREE!'},{mood:'üò§',time:'Kemarin',content:'last day boss masih nyindir'}]
      }
    ];

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const state = {
      db: null,
      allSpills: [],
      filteredSpills: [],
      resonanceThreshold: 20,
      activeMood: 'all',
      usedVibesPerSpill: JSON.parse(localStorage.getItem('saynope_vibes_per_spill') || '{}'),
      pendingSpills: [],
      userSig: null,
      scrollCount: 0,
      peekSpill: null,
      peekTimer: null,
      peekTimeLeft: 15,
      peekExtensions: 0
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SUPABASE INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function initDB() {
      try {
        state.db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        document.getElementById('sync-dot').className = 'sync-dot live';
        return true;
      } catch(e) {
        console.error('Supabase init failed:', e);
        return false;
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VIBE SIGNATURE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function buildUserSignature() {
      const key = 'jejak_' + SESSION.username.replace(/[^a-z0-9]/g,'_') + '_entries';
      const stored = localStorage.getItem(key);
      if (!stored) return { dominant: null, moodCounts: {}, keywords: [] };

      const entries = JSON.parse(stored);
      const moodCounts = {};
      const words = [];

      entries.forEach(e => {
        if (e.mood) moodCounts[e.mood] = (moodCounts[e.mood] || 0) + 1;
        if (e.content) {
          const ws = e.content.toLowerCase().replace(/[^\w\s]/g,'').split(/\s+/);
          words.push(...ws);
        }
      });

      const stopwords = new Set(['dan','yang','ke','di','nya','gue','aku','kamu','lo','itu','ini','ya','ga','gak','tidak','tapi','juga','udah','aja','deh','sih','sama','bisa','mau','lagi','dari','buat','itu','ada','mau','kalo','kalau']);
      const keywords = [...new Set(words.filter(w => w.length > 3 && !stopwords.has(w)))].slice(0, 30);
      const dominant = Object.entries(moodCounts).sort((a,b) => b[1]-a[1])[0]?.[0] || null;

      return { dominant, moodCounts, keywords };
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VIBE SCORE ALGORITHM
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function calcVibeScore(spill, sig) {
      let score = 0;
      if (sig.dominant && spill.mood === sig.dominant) score += 35;
      else if (sig.moodCounts && sig.moodCounts[spill.mood] > 0) score += 15;

      if (spill.content && sig.keywords.length > 0) {
        const spillWords = spill.content.toLowerCase().split(/\s+/);
        const hits = sig.keywords.filter(k => spillWords.some(w => w.includes(k))).length;
        score += Math.min(40, (hits / Math.max(sig.keywords.length, 1)) * 100);
      }

      if (spill.content && spill.mood) {
        const moodKw = MOOD_META[spill.mood]?.kw || [];
        const lower = spill.content.toLowerCase();
        const hits = moodKw.filter(w => lower.includes(w)).length;
        score += Math.min(25, hits * 6);
      }

      return Math.round(Math.min(100, score));
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // LOAD SPILLS WITH REACTION COUNTS FROM DB
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadSpills() {
      showLoading();
      state.userSig = buildUserSignature();

      try {
        // Load spills
        const { data: spillsData, error: spillsError } = await state.db
          .from('spills')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(60);

        if (spillsError) throw spillsError;

        // Load reactions count for all spills from reactions table
        const { data: reactionsData, error: reactionsError } = await state.db
          .from('reactions')
          .select('rant_id, emoji');

        if (reactionsError) throw reactionsError;

        // Count reactions per spill
        const reactionCounts = {};
        reactionsData.forEach(r => {
          if (!reactionCounts[r.rant_id]) reactionCounts[r.rant_id] = {};
          const key = EMOJI_TO_KEY[r.emoji] || 'relatable';
          reactionCounts[r.rant_id][key] = (reactionCounts[r.rant_id][key] || 0) + 1;
        });

        let spills = spillsData || [];

        // Filter out own spills
        spills = spills.filter(s => s.author !== SESSION.username);

        // Merge reaction counts
        spills = spills.map(s => ({
          ...s,
          vibes: reactionCounts[s.id] || {}
        }));

        // Add dummy if needed
        if (spills.length < 4) {
          const needed = 4 - spills.length;
          spills = [...spills, ...DUMMY_SPILLS.slice(0, needed)];
        }

        state.allSpills = spills.map(s => ({
          ...s,
          vibeScore: calcVibeScore(s, state.userSig),
          isOwn: false
        }));

        applyFilters();
        subscribeRealtime();
        buildGetaranCards();

      } catch(e) {
        console.error('Load spills failed:', e);
        state.allSpills = DUMMY_SPILLS.map(s => ({
          ...s, vibeScore: calcVibeScore(s, state.userSig), isOwn: false
        }));
        applyFilters();
        showNotification('Mode offline ‚Äî menampilkan contoh ‚òï');
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // REALTIME SUBSCRIPTION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function subscribeRealtime() {
      if (!state.db) return;
      
      // Subscribe to new spills
      state.db.channel('spills-rt')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'spills' }, payload => {
          const s = payload.new;
          if (s.author === SESSION.username) return;
          const newSpill = { ...s, vibes: {}, vibeScore: calcVibeScore(s, state.userSig), isOwn: false };
          state.pendingSpills.unshift(newSpill);
          const banner = document.getElementById('new-spill-banner');
          banner.textContent = `‚Üë ${state.pendingSpills.length} spill baru! Tap untuk lihat`;
          banner.classList.add('show');
        })
        .subscribe();

      // Subscribe to new reactions
      state.db.channel('reactions-rt')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'reactions' }, payload => {
          const r = payload.new;
          const spill = state.allSpills.find(s => s.id === r.rant_id);
          if (spill) {
            const key = EMOJI_TO_KEY[r.emoji] || 'relatable';
            spill.vibes[key] = (spill.vibes[key] || 0) + 1;
            updateCardVibes(spill.id);
          }
        })
        .subscribe();
    }

    function updateCardVibes(spillId) {
      const card = document.getElementById('card-' + spillId);
      if (!card) return;
      
      const spill = state.allSpills.find(s => s.id === spillId);
      if (!spill) return;

      // Update counts without re-rendering
      Object.entries(VIBE_REACTIONS).forEach(([key, val]) => {
        const btn = card.querySelector(`button[onclick*="'${key}'"]`);
        if (btn) {
          const countEl = btn.querySelector('.count');
          if (countEl) countEl.textContent = spill.vibes[key] || 0;
        }
      });
    }

    function loadPendingSpills() {
      if (!state.pendingSpills.length) return;
      state.allSpills = [...state.pendingSpills, ...state.allSpills];
      state.pendingSpills = [];
      document.getElementById('new-spill-banner').classList.remove('show');
      applyFilters();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FILTER & SORT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function applyFilters() {
      let list = [...state.allSpills];

      if (state.activeMood !== 'all') {
        list = list.filter(s => s.mood === state.activeMood);
      }

      if (state.resonanceThreshold > 0) {
        const thresh = state.resonanceThreshold;
        list = list.map(s => ({
          ...s,
          _show: s.vibeScore >= thresh
        }));
      } else {
        list = list.map(s => ({ ...s, _show: true }));
      }

      list.sort((a,b) => {
        if (b.vibeScore !== a.vibeScore) return b.vibeScore - a.vibeScore;
        return new Date(b.created_at) - new Date(a.created_at);
      });

      state.filteredSpills = list;

      const showing = list.filter(s => s._show !== false).length;
      document.getElementById('filter-stats').textContent = `${showing} spills`;
      document.getElementById('spill-tagline').textContent =
        showing > 0
          ? `${showing} curhat ‚Ä¢ ${state.resonanceThreshold > 0 ? `‚â•${state.resonanceThreshold}% match` : 'semua vibrasi'}`
          : 'Tidak ada yang cocok';

      renderSpills(list);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RENDER SPILLS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderSpills(list) {
      const container = document.getElementById('tea-container');
      const empty = document.getElementById('homie-empty');

      const visible = list.filter(s => s._show !== false);

      if (!visible.length) {
        container.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';
      container.innerHTML = '';

      visible.forEach((spill, idx) => {
        if (idx === 5) {
          const pause = document.createElement('div');
          pause.className = 'scroll-pause show';
          pause.innerHTML = `<div class="scroll-pause-text">üí≠ Sudah cukup scroll untuk sekarang?</div><button class="scroll-pause-btn" onclick="this.closest('.scroll-pause').style.display='none'">Lanjutkan</button>`;
          container.appendChild(pause);
        }

        container.appendChild(buildCard(spill, idx));
      });
    }

    function buildCard(spill, idx) {
      const el = document.createElement('div');
      const isHighlighted = spill.vibeScore >= 70;
      const isDimmed = spill.vibeScore < 30 && state.resonanceThreshold > 0;

      el.className = `tea-card ${isHighlighted ? 'highlighted' : ''} ${isDimmed ? 'dimmed' : ''}`;
      el.id = 'card-' + spill.id;

      const avatarText = spill.isDummy ? 'üë§' : (spill.author || '??').slice(0,2).toUpperCase();
      const timeAgo = fmtTime(spill.created_at);
      const mood = spill.mood || 'surviving';
      const moodMeta = MOOD_META[mood] || MOOD_META.surviving;
      const vibes = spill.vibes || {};
      const isNew = idx < 2 && !spill.isDummy;
      const matchLabel = spill.vibeScore >= 80 ? `${spill.vibeScore}% Match üî•` : spill.vibeScore >= 60 ? `${spill.vibeScore}% Selaras` : null;

      const usedEmojiKey = state.usedVibesPerSpill[spill.id];
      const hasReacted = !!usedEmojiKey;

      const vibesHtml = Object.entries(VIBE_REACTIONS).map(([k, v]) => {
        const count = vibes[k] || 0;
        const isUsed = usedEmojiKey === k;
        const isDisabled = hasReacted && !isUsed;
        
        return `<button class="vibe-btn ${isUsed ? 'used' : ''} ${isDisabled ? 'disabled' : ''}" onclick="handleVibe('${spill.id}','${k}',this,${!!spill.isDummy})" ${isDisabled ? 'disabled' : ''}>
          <span class="emoji">${v.emoji}</span><span class="count">${count}</span>
          <span class="vibe-tooltip">${v.slang}</span></button>`;
      }).join('');

      el.innerHTML = `
        ${isNew ? `<div class="live-badge"><span class="live-indicator"></span> Baru</div>` : ''}
        ${isHighlighted && matchLabel ? `<div class="resonance-badge">${matchLabel}</div>` : ''}
        <div class="tea-header">
          <div class="tea-avatar" onclick="openPeek('${spill.id}')">${avatarText}</div>
          <div class="tea-meta">
            <div class="tea-user" onclick="openPeek('${spill.id}')">@${spill.author || 'anon'}${spill.isDummy ? ' <span style="font-size:9px;color:var(--text-muted);font-weight:400;">(contoh)</span>' : ''}</div>
            <div class="tea-time">${timeAgo}</div>
          </div>
          <div class="tea-mood ${mood}">${moodMeta.emoji} ${mood}</div>
        </div>
        <div class="tea-content" id="content-${spill.id}">${escHtml(spill.content || '')}</div>
        ${(spill.content||'').length > 150 ? `<span class="read-more" onclick="toggleRead('${spill.id}')">Baca selengkapnya</span>` : ''}
        <div class="vibe-section"><div class="vibe-reactions">${vibesHtml}</div></div>`;

      return el;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VIBE REACTION ‚Äî SAVE TO REACTIONS TABLE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function handleVibe(spillId, vibeKey, btn, isDummy) {
      if (isDummy) {
        showNotification('Tulis rantmu dulu di Jejak! ‚úçÔ∏è');
        setTimeout(() => window.location.href = 'jejak.html', 1500);
        return;
      }

      if (state.usedVibesPerSpill[spillId]) {
        showNotification('Kamu sudah kasih reaksi pada curhat ini!');
        return;
      }

      // Optimistic UI
      btn.classList.add('used');
      const countEl = btn.querySelector('.count');
      countEl.textContent = parseInt(countEl.textContent) + 1;
      btn.style.transform = 'scale(1.25)';
      setTimeout(() => btn.style.transform = '', 200);

      state.usedVibesPerSpill[spillId] = vibeKey;
      localStorage.setItem('saynope_vibes_per_spill', JSON.stringify(state.usedVibesPerSpill));

      const card = document.getElementById('card-' + spillId);
      if (card) {
        const allBtns = card.querySelectorAll('.vibe-btn');
        allBtns.forEach(b => {
          if (!b.classList.contains('used')) {
            b.classList.add('disabled');
            b.disabled = true;
          }
        });
      }

      setTimeout(() => openPeek(spillId), 200);

      // SAVE TO SUPABASE REACTIONS TABLE
      if (state.db) {
        try {
          const dbEmoji = VIBE_REACTIONS[vibeKey].dbEmoji;
          const { error } = await state.db
            .from('reactions')
            .insert({
              id: crypto.randomUUID(),  // Generate UUID for id
              rant_id: spillId,         // ID of the spill being reacted to
              user_id: SESSION.username, // Current user
              emoji: dbEmoji,           // The emoji used
              created_at: new Date().toISOString()
            });
          
          if (error) throw error;
          
          // Update local count
          const spill = state.allSpills.find(s => s.id === spillId);
          if (spill) {
            spill.vibes[vibeKey] = (spill.vibes[vibeKey] || 0) + 1;
          }
          
        } catch(e) { 
          console.error('Reaction save failed:', e);
          showNotification('Gagal menyimpan reaksi, coba lagi');
        }
      }

      showNotification(`${VIBE_REACTIONS[vibeKey].emoji} ${VIBE_REACTIONS[vibeKey].slang}!`);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PEEK MECHANIC
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function openPeek(spillId) {
      const spill = state.filteredSpills.find(s => s.id === spillId);
      if (!spill || spill.isDummy) return;

      state.peekSpill = spill;
      state.peekExtensions = 0;

      const avatarText = (spill.author || '??').slice(0,2).toUpperCase();
      document.getElementById('peek-avatar-big').textContent = avatarText;
      document.getElementById('peek-username').textContent = '@' + (spill.author || 'anon');

      const isRecent = Date.now() - new Date(spill.created_at).getTime() < 7200000;
      document.getElementById('online-status').style.display = isRecent ? 'flex' : 'none';
      if (isRecent) {
        setTimeout(() => { document.getElementById('typing-indicator').style.display = 'flex'; }, 3000);
      }

      const vibes = spill.vibes || {};
      const totalVibes = Object.values(vibes).reduce((a,b) => a+b, 0);
      document.getElementById('peek-entry-count').textContent = spill.journal?.length || 1;
      document.getElementById('peek-vibe-count').textContent = totalVibes;

      const ec = document.getElementById('peek-entries-container');
      ec.innerHTML = '';
      const journal = spill.journal || [{ mood: MOOD_META[spill.mood]?.emoji || 'üí≠', time: fmtTime(spill.created_at), content: spill.content }];
      journal.forEach((entry, i) => {
        const div = document.createElement('div');
        div.className = 'peek-entry ' + (i === 0 ? 'revealed' : 'locked');
        div.dataset.index = i;
        div.innerHTML = `
          <div class="peek-entry-header">
            <span class="peek-entry-mood">${entry.mood || 'üí≠'}</span>
            <span class="peek-entry-time">${entry.time || ''}</span>
          </div>
          <div class="peek-entry-content">${i === 0 ? escHtml(entry.content) : escHtml(entry.content.slice(0,25)) + '...'}</div>
          ${i > 0 ? '<div class="unlock-hint">React untuk unlock</div>' : ''}`;
        ec.appendChild(div);
      });

      const rc = document.getElementById('peek-reactions');
      rc.innerHTML = Object.entries(VIBE_REACTIONS).map(([k,v]) =>
        `<button class="peek-reaction-btn" onclick="extendPeek('${k}',this)">${v.emoji} ${v.slang}</button>`
      ).join('');

      document.getElementById('peek-extend-section').style.display = 'block';
      document.getElementById('peek-locked').style.display = 'none';
      document.getElementById('jejak-peek-overlay').classList.add('show');
      document.body.style.overflow = 'hidden';

      startPeekTimer();

      if (Math.random() > 0.6) {
        setTimeout(() => showReciprocity('@' + (spill.author || 'someone')), 8000);
      }
    }

    function startPeekTimer() {
      state.peekTimeLeft = 15;
      document.getElementById('timer-count').textContent = 15;
      document.getElementById('peek-timer').classList.remove('pulse');
      if (state.peekTimer) clearInterval(state.peekTimer);
      state.peekTimer = setInterval(() => {
        state.peekTimeLeft--;
        document.getElementById('timer-count').textContent = state.peekTimeLeft;
        if (state.peekTimeLeft <= 5) document.getElementById('peek-timer').classList.add('pulse');
        if (state.peekTimeLeft <= 0) endPeek();
      }, 1000);
    }

    function extendPeek(vibeKey, btn) {
      if (btn.classList.contains('given')) return;
      btn.classList.add('given');
      state.peekTimeLeft += 15;
      state.peekExtensions++;
      document.getElementById('timer-count').textContent = state.peekTimeLeft;
      document.getElementById('peek-timer').classList.remove('pulse');

      const locked = document.querySelectorAll('.peek-entry.locked');
      if (locked.length > 0) {
        const next = locked[0];
        next.classList.replace('locked','revealed');
        const idx = parseInt(next.dataset.index);
        const journal = state.peekSpill.journal || [];
        if (journal[idx]) next.querySelector('.peek-entry-content').innerHTML = escHtml(journal[idx].content);
        const hint = next.querySelector('.unlock-hint');
        if (hint) hint.remove();
      }

      if (state.peekExtensions === 1) showNotification('Mereka juga online sekarang... üëÄ');
      if (state.peekExtensions === 3) showNotification('Vibrasi kalian saling merespons ‚ú®');
    }

    function endPeek() {
      clearInterval(state.peekTimer);
      document.getElementById('peek-extend-section').style.display = 'none';
      document.getElementById('peek-locked').style.display = 'block';
    }

    function closePeek() {
      clearInterval(state.peekTimer);
      document.getElementById('jejak-peek-overlay').classList.remove('show');
      document.getElementById('typing-indicator').style.display = 'none';
      document.body.style.overflow = '';
      if (state.peekExtensions >= 3) showNarrative();
    }

    function showReciprocity(username) {
      document.getElementById('reciprocity-text').textContent = `${username} juga melihat jejakmu!`;
      const t = document.getElementById('reciprocity-toast');
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    function showNarrative() {
      const narratives = [
        { icon:'‚ú®', title:'Koneksi Tersimpan', text:'Vibrasi kalian saling merespons. Seperti dua gelombang yang menemukan frekuensi yang sama.', ch:'Lanjutkan besok untuk membuka bab baru...' },
        { icon:'üåä', title:'Resonansi Terdeteksi', text:'Setiap reaksi yang kamu berikan menciptakan riak. Mereka merasakan getaranmu.', ch:'Koneksi ini akan matang 24 jam lagi...' },
        { icon:'üîÆ', title:'Misteri Terkunci', text:'Ada sesuatu yang belum terungkap. Keingintahuan adalah benih koneksi yang sesungguhnya.', ch:'Terus spill untuk membuka...' }
      ];
      const n = narratives[Math.min(state.peekExtensions - 3, narratives.length - 1)];
      document.getElementById('narrative-icon').textContent = n.icon;
      document.getElementById('narrative-title').textContent = n.title;
      document.getElementById('narrative-text').textContent = n.text;
      document.getElementById('narrative-cliffhanger').textContent = n.ch;
      document.getElementById('narrative-overlay').classList.add('show');
    }

    function closeNarrative(e) {
      if (!e || e.target.id === 'narrative-overlay' || e.target.tagName === 'BUTTON') {
        document.getElementById('narrative-overlay').classList.remove('show');
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GETARAN CARDS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function buildGetaranCards() {
      const sig = state.userSig;
      if (!sig.dominant) return;

      const dominant = MOOD_META[sig.dominant];
      const section = document.getElementById('getaran-section');
      const cards = document.getElementById('getaran-cards');

      cards.innerHTML = `
        <div class="getaran-card">
          <div class="getaran-content">
            <div class="getaran-icon blue">üëÅÔ∏è</div>
            <div class="getaran-text">
              <div class="getaran-title">Seseorang dengan pola "${sig.dominant}" sering muncul di timelinemu.</div>
              <ul class="getaran-list">
                <li>Mood dominan: ${dominant.emoji} ${sig.dominant}</li>
                ${sig.keywords.slice(0,2).map(k => `<li>Keyword: "${k}"</li>`).join('')}
              </ul>
            </div>
          </div>
          <div class="getaran-actions">
            <button class="getaran-btn skip" onclick="this.closest('.getaran-card').remove()">Lewati</button>
            <button class="getaran-btn primary" onclick="setMoodFilter('${sig.dominant}');this.textContent='‚úì Diterapkan'">Cari yang serupa</button>
          </div>
        </div>`;

      section.style.display = 'block';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FILTER CONTROLS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function adjustResonance(sliderVal) {
      state.resonanceThreshold = 100 - parseInt(sliderVal);
      applyFilters();
    }

    function setMoodFilter(mood) {
      state.activeMood = mood;
      document.querySelectorAll('.mood-chip').forEach(c => {
        c.classList.toggle('active', c.dataset.mood === mood);
      });
      applyFilters();
    }

    function resetFilter() {
      state.resonanceThreshold = 20;
      state.activeMood = 'all';
      document.getElementById('filter-slider').value = 80;
      document.querySelectorAll('.mood-chip').forEach(c => {
        c.classList.toggle('active', c.dataset.mood === 'all');
      });
      applyFilters();
    }

    async function refreshTea() {
      const btn = document.getElementById('refresh-btn');
      btn.classList.add('spinning');
      btn.disabled = true;
      state.scrollCount++;
      if (state.scrollCount >= 3) {
        showNotification('Udah 3x refresh. Istirahat sebentar? ‚òï');
        state.scrollCount = 0;
      }
      await new Promise(r => setTimeout(r, 2000));
      await loadSpills();
      btn.classList.remove('spinning');
      btn.disabled = false;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UI HELPERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showLoading() {
      document.getElementById('tea-container').innerHTML = `<div class="loading-state"><div class="loading-spinner"></div><div style="font-size:11px;color:var(--text-muted);font-weight:700;text-transform:uppercase;letter-spacing:0.1em;">Menyeduh teh...</div></div>`;
    }

    function toggleRead(id) {
      const el = document.getElementById('content-' + id);
      const btn = el?.nextElementSibling;
      if (!el || !btn) return;
      el.classList.toggle('expanded');
      btn.textContent = el.classList.contains('expanded') ? 'Sembunyikan' : 'Baca selengkapnya';
    }

    function fmtTime(iso) {
      if (!iso) return '';
      const diff = Date.now() - new Date(iso).getTime();
      const m = Math.floor(diff/60000), h = Math.floor(diff/3600000), d = Math.floor(diff/86400000);
      if (m < 1) return 'Baru saja';
      if (m < 60) return m + 'm';
      if (h < 24) return h + 'j';
      return d + 'h';
    }

    function escHtml(t) {
      return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    let _notifTimer;
    function showNotification(msg) {
      let el = document.querySelector('.notification');
      if (!el) { el = document.createElement('div'); el.className = 'notification'; document.body.appendChild(el); }
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(_notifTimer);
      _notifTimer = setTimeout(() => el.classList.remove('show'), 2200);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('header-username').textContent = '@' + SESSION.username;
      initDB();
      loadSpills();
    });
  </script>
</body>
</html>
