<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Insomnia ‚Äî Voice Space</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
:root {
  --night: #080810;
  --surface: #12121F;
  --surface2: #1A1A2E;
  --border: rgba(255,255,255,0.06);
  --border-warm: rgba(255,200,100,0.15);
  --txt: #EDE8E0;
  --txt-dim: #7A7570;
  --txt-muted: #3A3835;
  --amber: #C8860A;
  --amber-soft: #E8A020;
  --amber-glow: rgba(200,134,10,0.15);
  --amber-strong: rgba(232,160,32,0.25);
  --breath: #4A90A4;
  --breath-soft: rgba(74,144,164,0.2);
  --dua: #9B6FD4;
  --dua-soft: rgba(155,111,212,0.2);
  --dua-glow: rgba(155,111,212,0.1);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--night);
  color: var(--txt);
  font-family: 'DM Mono', monospace;
  min-height: 100vh;
  overflow-x: hidden;
  padding-bottom: 80px;
}

body::before {
  content:'';
  position:fixed; inset:0;
  background:
    radial-gradient(ellipse 600px 400px at 20% 10%, rgba(200,134,10,0.04) 0%, transparent 70%),
    radial-gradient(ellipse 400px 600px at 80% 80%, rgba(74,144,164,0.03) 0%, transparent 70%);
  pointer-events:none; z-index:0;
}

body::after {
  content:'';
  position:fixed; inset:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events:none; z-index:0; opacity:0.4;
}

.wrapper { max-width:480px; margin:0 auto; padding:0 16px; position:relative; z-index:1; }

/* ---- INTRO ---- */
#intro-screen {
  position:fixed; inset:0; background:var(--night); z-index:10000;
  display:flex; align-items:center; justify-content:center; flex-direction:column;
  transition:opacity 1.5s ease, visibility 1.5s ease;
}
#intro-screen.fade-out { opacity:0; visibility:hidden; }

.intro-content { max-width:340px; padding:32px; text-align:center; }

.intro-candle { font-size:32px; margin-bottom:32px; display:block; animation:flicker 3s ease-in-out infinite; }
@keyframes flicker {
  0%,100%{opacity:1;transform:scale(1)} 25%{opacity:.85;transform:scale(.98)}
  50%{opacity:1;transform:scale(1.02)} 75%{opacity:.9;transform:scale(.99)}
}

.intro-wave { display:flex; align-items:center; justify-content:center; gap:3px; height:32px; margin-bottom:32px; }
.intro-wave-bar { width:2px; background:var(--amber-soft); border-radius:2px; opacity:.6; animation:vwave 2s ease-in-out infinite; }
.intro-wave-bar:nth-child(1){height:8px;animation-delay:0s}
.intro-wave-bar:nth-child(2){height:14px;animation-delay:.1s}
.intro-wave-bar:nth-child(3){height:20px;animation-delay:.2s}
.intro-wave-bar:nth-child(4){height:28px;animation-delay:.3s}
.intro-wave-bar:nth-child(5){height:32px;animation-delay:.4s}
.intro-wave-bar:nth-child(6){height:24px;animation-delay:.5s}
.intro-wave-bar:nth-child(7){height:18px;animation-delay:.6s}
.intro-wave-bar:nth-child(8){height:12px;animation-delay:.7s}
.intro-wave-bar:nth-child(9){height:8px;animation-delay:.8s}
@keyframes vwave { 0%,100%{transform:scaleY(1)} 50%{transform:scaleY(.4)} }

.intro-narasi {
  font-family:'Instrument Serif',serif; font-style:italic;
  font-size:15px; line-height:2; color:var(--txt-dim); margin-bottom:40px;
  opacity:0; animation:appear 2s ease forwards .8s;
}
.intro-narasi .hi { color:var(--txt); font-style:normal; }
.intro-narasi .glow { color:var(--amber-soft); opacity:.8; }

@keyframes appear { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }

.intro-enter {
  background:transparent; border:1px solid var(--border-warm); color:var(--amber-soft);
  padding:14px 32px; font-family:'DM Mono',monospace; font-size:11px;
  letter-spacing:.2em; text-transform:uppercase; cursor:pointer;
  transition:all .4s ease; opacity:0; animation:appear 1s ease forwards 2.5s;
  position:relative; overflow:hidden;
}
.intro-enter::before {
  content:''; position:absolute; inset:0; background:var(--amber-glow);
  opacity:0; transition:opacity .4s;
}
.intro-enter:hover::before { opacity:1; }
.intro-enter:hover { border-color:var(--amber-soft); letter-spacing:.25em; }

/* ---- APP ---- */
#app { opacity:0; transition:opacity 1s ease; }
#app.visible { opacity:1; }

.header { padding:28px 0 20px; border-bottom:1px solid var(--border); margin-bottom:28px; }
.header-top { display:flex; justify-content:space-between; align-items:flex-start; }
.brand-name { font-family:'Instrument Serif',serif; font-size:32px; letter-spacing:-.02em; line-height:1; }
.brand-sub { font-size:10px; color:var(--txt-muted); letter-spacing:.2em; text-transform:uppercase; margin-top:4px; }
.live-indicator { display:flex; align-items:center; gap:6px; font-size:10px; color:var(--txt-dim); letter-spacing:.1em; text-transform:uppercase; }
.live-dot { width:6px; height:6px; border-radius:50%; background:var(--amber-soft); animation:pdot 3s ease-in-out infinite; }
@keyframes pdot { 0%,100%{opacity:1;box-shadow:0 0 0 0 var(--amber-strong)} 50%{opacity:.6;box-shadow:0 0 0 6px transparent} }
.time-display { font-size:11px; color:var(--txt-muted); margin-top:4px; letter-spacing:.05em; }

/* ---- ALGO PANEL ---- */
.algo-panel { background:var(--surface); border:1px solid var(--border); padding:16px 20px; margin-bottom:24px; position:relative; overflow:hidden; }
.algo-panel::before { content:''; position:absolute; top:0; left:0; right:0; height:1px; background:linear-gradient(90deg,transparent,var(--amber-soft),transparent); opacity:.4; }
.algo-title { font-size:9px; color:var(--txt-muted); letter-spacing:.2em; text-transform:uppercase; margin-bottom:12px; }
.algo-stats { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
.algo-stat { text-align:center; }
.algo-num { font-family:'Instrument Serif',serif; font-size:24px; color:var(--amber-soft); line-height:1; margin-bottom:4px; }
.algo-label { font-size:9px; color:var(--txt-muted); letter-spacing:.1em; text-transform:uppercase; }

/* ---- WINDOW BANNER ---- */
.window-banner { padding:12px 20px; margin-bottom:24px; font-size:11px; letter-spacing:.05em; display:flex; align-items:center; gap:10px; border:1px solid; }
.window-banner.open { background:rgba(57,100,50,.1); border-color:rgba(57,200,50,.2); color:#6BC95A; }
.window-banner.closed { background:rgba(100,60,30,.1); border-color:rgba(200,134,10,.2); color:var(--amber-soft); }

/* ---- SECTION LABEL ---- */
.rooms-section { margin-bottom:32px; }
.section-label { font-size:9px; color:var(--txt-muted); letter-spacing:.25em; text-transform:uppercase; margin-bottom:16px; display:flex; align-items:center; gap:12px; }
.section-label::after { content:''; flex:1; height:1px; background:var(--border); }

/* ---- ROOM CARD ---- */
.room-card { border:1px solid var(--border); background:var(--surface); margin-bottom:16px; position:relative; overflow:hidden; transition:border-color .3s; }
.room-card:hover { border-color:var(--border-warm); }
.room-card-inner { padding:24px; }
.room-type-badge { font-size:9px; letter-spacing:.2em; text-transform:uppercase; padding:4px 10px; border:1px solid var(--border); display:inline-block; margin-bottom:16px; color:var(--txt-muted); }
.room-type-badge.gelap { border-color:var(--border-warm); color:var(--amber-soft); }
.room-type-badge.sunyi { border-color:var(--breath-soft); color:var(--breath); }
.room-title { font-family:'Instrument Serif',serif; font-size:22px; margin-bottom:8px; line-height:1.2; }
.room-desc { font-size:12px; color:var(--txt-dim); line-height:1.7; margin-bottom:20px; }

/* occupancy */
.room-occupancy { display:flex; align-items:center; gap:16px; margin-bottom:20px; }
.occupancy-slots { display:flex; gap:4px; }
.slot { width:8px; height:8px; border-radius:50%; border:1px solid var(--border-warm); transition:all .3s; }
.slot.filled { background:var(--amber-soft); border-color:var(--amber-soft); box-shadow:0 0 6px var(--amber-strong); }
.occupancy-text { font-size:11px; color:var(--txt-dim); }

/* wave */
.room-wave { display:flex; align-items:flex-end; gap:2px; height:20px; margin-bottom:20px; opacity:.3; }
.room-wave.live { opacity:.7; }
.room-wave-bar { width:2px; border-radius:2px; animation:rwav 1.5s ease-in-out infinite; }
.room-wave-bar.amber { background:var(--amber-soft); }
.room-wave-bar.breath { background:var(--breath); }
.room-wave-bar:nth-child(1){height:4px;animation-delay:0s}
.room-wave-bar:nth-child(2){height:8px;animation-delay:.1s}
.room-wave-bar:nth-child(3){height:14px;animation-delay:.2s}
.room-wave-bar:nth-child(4){height:10px;animation-delay:.3s}
.room-wave-bar:nth-child(5){height:16px;animation-delay:.4s}
.room-wave-bar:nth-child(6){height:12px;animation-delay:.5s}
.room-wave-bar:nth-child(7){height:8px;animation-delay:.6s}
.room-wave-bar:nth-child(8){height:6px;animation-delay:.7s}
.room-wave-bar:nth-child(9){height:4px;animation-delay:.8s}
.room-wave-bar:nth-child(10){height:10px;animation-delay:.9s}
.room-wave-bar:nth-child(11){height:14px;animation-delay:1s}
.room-wave-bar:nth-child(12){height:8px;animation-delay:1.1s}
@keyframes rwav { 0%,100%{transform:scaleY(1)} 50%{transform:scaleY(.3)} }

/* enter button */
.room-enter-btn {
  width:100%; padding:13px; background:transparent; border:1px solid var(--border-warm);
  color:var(--amber-soft); font-family:'DM Mono',monospace; font-size:11px;
  letter-spacing:.15em; text-transform:uppercase; cursor:pointer; transition:all .3s;
  position:relative; overflow:hidden;
}
.room-enter-btn::before { content:''; position:absolute; inset:0; background:var(--amber-glow); transform:translateX(-100%); transition:transform .3s; }
.room-enter-btn:hover::before { transform:translateX(0); }
.room-enter-btn:hover { letter-spacing:.2em; }
.room-enter-btn.sunyi-btn { border-color:var(--breath-soft); color:var(--breath); }
.room-enter-btn.sunyi-btn::before { background:var(--breath-soft); }
.room-enter-btn.secondary { border-color:var(--border); color:var(--txt-muted); font-size:10px; margin-top:8px; }
.room-enter-btn.secondary::before { background:var(--surface2); }
.room-enter-btn:disabled { opacity:.3; cursor:not-allowed; pointer-events:none; }

/* volunteer queue ‚Äî zero identity */
.vol-queue { margin-top:16px; padding-top:16px; border-top:1px solid var(--border); }
.vol-queue-title { font-size:9px; color:var(--txt-muted); letter-spacing:.2em; text-transform:uppercase; margin-bottom:12px; }
.vol-item { display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--border); }
.vol-item:last-child { border-bottom:none; }
.vol-status { display:flex; align-items:center; gap:10px; }
.vol-dot { width:6px; height:6px; border-radius:50%; }
.vol-dot.on { background:#6BC95A; animation:pdot 2s infinite; }
.vol-dot.off { background:var(--txt-muted); }
/* NO name, NO session count displayed ‚Äî only availability signal */
.vol-label { font-size:12px; color:var(--txt-dim); }
.vol-state { font-size:10px; color:var(--txt-muted); }

/* ---- OPERATION LOG ---- */
.op-log { background:var(--surface); border:1px solid var(--border); padding:16px 20px; margin-bottom:32px; }
.op-log-title { font-size:9px; color:var(--txt-muted); letter-spacing:.2em; text-transform:uppercase; margin-bottom:14px; display:flex; align-items:center; gap:8px; }
.op-log-title::before { content:''; width:6px; height:6px; border-radius:50%; background:var(--amber-soft); animation:pdot 2s infinite; }
.op-entry { display:flex; gap:12px; padding:6px 0; border-bottom:1px solid var(--border); align-items:flex-start; }
.op-entry:last-child { border-bottom:none; }
.op-time { font-size:10px; color:var(--txt-muted); min-width:40px; padding-top:1px; }
.op-msg { font-size:11px; color:var(--txt-dim); line-height:1.5; flex:1; }
.op-msg.sys { color:var(--amber-soft); }
.op-msg.vol { color:var(--breath); }
.op-msg.alert { color:#C06060; }

/* ---- SUPPORT STRIP ---- */
.support-strip { border:1px dashed var(--border); padding:20px; margin-bottom:24px; text-align:center; }
.support-text { font-family:'Instrument Serif',serif; font-style:italic; font-size:13px; color:var(--txt-muted); line-height:1.8; margin-bottom:12px; }
.support-link { font-size:10px; color:var(--amber-soft); letter-spacing:.1em; text-decoration:none; border-bottom:1px solid var(--amber-strong); padding-bottom:2px; transition:border-color .3s; }
.support-link:hover { border-color:var(--amber-soft); }

/* ---- BOTTOM NAV ---- */
.bottom-nav { position:fixed; bottom:0; left:0; right:0; background:var(--surface); border-top:1px solid var(--border); z-index:1000; }
.nav-container { max-width:480px; margin:0 auto; display:flex; justify-content:space-around; align-items:center; height:60px; }
.nav-item { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; background:transparent; border:none; color:var(--txt-muted); cursor:pointer; padding:8px 24px; transition:all .2s; text-decoration:none; flex:1; position:relative; }
.nav-item.active { color:var(--amber-soft); }
.nav-item.active::before { content:''; position:absolute; top:0; left:0; right:0; height:1px; background:var(--amber-soft); opacity:.6; }
.nav-item:hover { color:var(--txt); }
.nav-icon { font-size:18px; }
.nav-label { font-size:9px; text-transform:uppercase; letter-spacing:.12em; }

/* ---- TOAST ---- */
.toast { position:fixed; bottom:80px; left:50%; transform:translateX(-50%) translateY(20px); background:var(--surface2); border:1px solid var(--border-warm); color:var(--txt-dim); padding:10px 20px; font-size:12px; letter-spacing:.05em; z-index:9999; opacity:0; transition:all .4s; pointer-events:none; white-space:nowrap; }
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* ====================================================
   VOICE ROOM OVERLAY ‚Äî Ruang Gelap & Ruang Sunyi
   ==================================================== */
#voice-overlay {
  position:fixed; inset:0; background:rgba(8,8,16,.98); backdrop-filter:blur(20px);
  z-index:5000; display:flex; align-items:center; justify-content:center;
  opacity:0; visibility:hidden; transition:all .5s;
}
#voice-overlay.active { opacity:1; visibility:visible; }

.vr-content { max-width:380px; width:100%; padding:32px 24px; text-align:center; }
.vr-type-label { font-size:9px; letter-spacing:.3em; text-transform:uppercase; color:var(--txt-muted); margin-bottom:8px; }
.vr-room-name { font-family:'Instrument Serif',serif; font-size:28px; color:var(--txt); margin-bottom:32px; }

/* participant ring */
.p-ring { display:flex; justify-content:center; gap:12px; margin-bottom:40px; flex-wrap:wrap; }
.p-circle { width:52px; height:52px; border-radius:50%; border:1px solid var(--border-warm); display:flex; align-items:center; justify-content:center; position:relative; transition:all .3s; }
.p-circle.speaking { border-color:var(--amber-soft); box-shadow:0 0 0 4px var(--amber-glow),0 0 20px var(--amber-strong); }
.p-circle.you { border-color:var(--breath); }
.p-circle.empty { border-style:dashed; opacity:.25; }
.p-circle.invite-ready { border-color:var(--dua); border-style:dashed; animation:dua-pulse 2s infinite; }
.p-anon { font-family:'Instrument Serif',serif; font-size:16px; color:var(--txt-dim); }
.p-label { position:absolute; bottom:-18px; font-size:8px; color:var(--txt-muted); letter-spacing:.1em; white-space:nowrap; }
@keyframes dua-pulse { 0%,100%{box-shadow:0 0 0 0 var(--dua-soft)} 50%{box-shadow:0 0 0 8px transparent} }

/* INVITE TO DUA button ‚Äî only visible inside Ruang Gelap */
.invite-strip {
  display:none; /* hidden until inside gelap room */
  align-items:center; justify-content:center; gap:8px;
  padding:10px 20px; margin-bottom:20px;
  border:1px dashed var(--dua-soft); background:var(--dua-glow);
  font-size:10px; color:var(--dua); letter-spacing:.1em; text-transform:uppercase;
  cursor:pointer; transition:all .3s; border-radius:4px;
}
.invite-strip:hover { background:var(--dua-soft); }
.invite-strip.visible { display:flex; }

/* central wave */
.cwave { display:flex; align-items:center; justify-content:center; gap:3px; height:48px; margin-bottom:40px; }
.cbar { width:3px; border-radius:3px; background:var(--amber-soft); animation:cwav 1.2s ease-in-out infinite; opacity:.5; }
.cbar.a { opacity:1; }
.cbar:nth-child(1){height:8px;animation-delay:0s}
.cbar:nth-child(2){height:14px;animation-delay:.05s}
.cbar:nth-child(3){height:22px;animation-delay:.1s}
.cbar:nth-child(4){height:30px;animation-delay:.15s}
.cbar:nth-child(5){height:40px;animation-delay:.2s}
.cbar:nth-child(6){height:48px;animation-delay:.25s}
.cbar:nth-child(7){height:40px;animation-delay:.3s}
.cbar:nth-child(8){height:30px;animation-delay:.35s}
.cbar:nth-child(9){height:22px;animation-delay:.4s}
.cbar:nth-child(10){height:14px;animation-delay:.45s}
.cbar:nth-child(11){height:8px;animation-delay:.5s}
@keyframes cwav { 0%,100%{transform:scaleY(1)} 50%{transform:scaleY(.25)} }

.vr-controls { display:flex; justify-content:center; align-items:center; gap:20px; margin-bottom:32px; }
.ctrl { width:52px; height:52px; border-radius:50%; border:1px solid var(--border); background:var(--surface); color:var(--txt-dim); font-size:18px; cursor:pointer; transition:all .3s; display:flex; align-items:center; justify-content:center; }
.ctrl:hover { border-color:var(--amber-soft); color:var(--amber-soft); }
.ctrl.main { width:64px; height:64px; border-color:var(--amber-soft); color:var(--amber-soft); font-size:22px; }
.ctrl.main.muted { background:var(--amber-glow); }
.ctrl.leave { border-color:rgba(139,58,58,.5); color:#C06060; }
.ctrl.leave:hover { background:rgba(139,58,58,.15); color:#C06060; }

.vr-timer { font-size:11px; color:var(--txt-muted); letter-spacing:.15em; margin-bottom:8px; }
.vr-hint { font-family:'Instrument Serif',serif; font-style:italic; font-size:12px; color:var(--txt-muted); line-height:1.6; }

/* safe exit */
.safe-exit { position:fixed; bottom:80px; left:50%; transform:translateX(-50%) translateY(100px); z-index:5100; opacity:0; visibility:hidden; transition:all .5s; max-width:320px; width:calc(100% - 32px); }
.safe-exit.show { opacity:1; visibility:visible; transform:translateX(-50%) translateY(0); }
.safe-exit-inner { background:var(--surface2); border:1px solid var(--border-warm); padding:16px 20px; text-align:center; }
.safe-exit-text { font-family:'Instrument Serif',serif; font-style:italic; font-size:13px; color:var(--txt-dim); line-height:1.6; margin-bottom:12px; }
.safe-exit-btn { background:transparent; border:1px solid rgba(139,58,58,.4); color:#C06060; padding:8px 20px; font-family:'DM Mono',monospace; font-size:10px; letter-spacing:.15em; text-transform:uppercase; cursor:pointer; transition:all .3s; }
.safe-exit-btn:hover { background:rgba(139,58,58,.1); }

/* ====================================================
   RUANG DUA OVERLAY
   Appears silently on top of Ruang Gelap.
   Nobody else in Gelap knows. No announcement.
   ==================================================== */
#dua-overlay {
  position:fixed; inset:0; background:rgba(8,8,16,.99); backdrop-filter:blur(28px);
  z-index:6000; display:flex; align-items:center; justify-content:center;
  opacity:0; visibility:hidden; transition:all .7s;
}
#dua-overlay.active { opacity:1; visibility:visible; }

.dua-content { max-width:360px; width:100%; padding:32px 24px; text-align:center; }
.dua-label { font-size:9px; letter-spacing:.3em; text-transform:uppercase; color:var(--dua); margin-bottom:8px; opacity:.7; }
.dua-title { font-family:'Instrument Serif',serif; font-size:28px; color:var(--txt); margin-bottom:4px; }
.dua-sub { font-size:11px; color:var(--txt-muted); letter-spacing:.05em; margin-bottom:36px; }

/* two orbs, no labels, no identity */
.dua-orbs { display:flex; justify-content:center; align-items:center; gap:28px; margin-bottom:36px; }
.dua-orb { width:60px; height:60px; border-radius:50%; border:1px solid var(--dua-soft); display:flex; align-items:center; justify-content:center; transition:all .3s; }
.dua-orb.speaking { border-color:var(--dua); box-shadow:0 0 0 6px var(--dua-glow),0 0 24px var(--dua-soft); }
.dua-orb-dot { width:8px; height:8px; border-radius:50%; background:var(--dua); opacity:.6; }
.dua-line { width:28px; height:1px; background:linear-gradient(90deg,var(--dua-soft),var(--dua),var(--dua-soft)); animation:dline 3s ease-in-out infinite; }
@keyframes dline { 0%,100%{opacity:.3} 50%{opacity:1} }

/* dua wave ‚Äî intimate, softer */
.dua-wave { display:flex; align-items:center; justify-content:center; gap:3px; height:32px; margin-bottom:32px; }
.dua-bar { width:2px; border-radius:2px; background:var(--dua); animation:dwav 1.8s ease-in-out infinite; opacity:.35; }
.dua-bar.a { opacity:.85; }
.dua-bar:nth-child(1){height:4px;animation-delay:0s}
.dua-bar:nth-child(2){height:8px;animation-delay:.1s}
.dua-bar:nth-child(3){height:14px;animation-delay:.2s}
.dua-bar:nth-child(4){height:20px;animation-delay:.3s}
.dua-bar:nth-child(5){height:26px;animation-delay:.4s}
.dua-bar:nth-child(6){height:32px;animation-delay:.5s}
.dua-bar:nth-child(7){height:26px;animation-delay:.6s}
.dua-bar:nth-child(8){height:20px;animation-delay:.7s}
.dua-bar:nth-child(9){height:14px;animation-delay:.8s}
.dua-bar:nth-child(10){height:8px;animation-delay:.9s}
.dua-bar:nth-child(11){height:4px;animation-delay:1s}
@keyframes dwav { 0%,100%{transform:scaleY(1)} 50%{transform:scaleY(.2)} }

.dua-controls { display:flex; justify-content:center; gap:16px; margin-bottom:24px; }
.dua-timer { font-size:11px; color:var(--txt-muted); letter-spacing:.15em; margin-bottom:8px; }
.dua-hint { font-family:'Instrument Serif',serif; font-style:italic; font-size:12px; color:var(--txt-muted); line-height:1.7; }

/* ====================================================
   INCOMING INVITE NOTIFICATION
   Appears only for the person being invited.
   Silent. No broadcast to Ruang Gelap.
   ==================================================== */
#invite-notif {
  position:fixed; bottom:90px; left:50%;
  transform:translateX(-50%) translateY(80px);
  z-index:7000; opacity:0; visibility:hidden;
  transition:all .5s cubic-bezier(.34,1.56,.64,1);
  max-width:300px; width:calc(100% - 48px);
}
#invite-notif.show { opacity:1; visibility:visible; transform:translateX(-50%) translateY(0); }

.invite-inner { background:var(--surface2); border:1px solid var(--dua-soft); padding:18px 20px; text-align:center; position:relative; overflow:hidden; }
.invite-inner::before { content:''; position:absolute; top:0; left:0; right:0; height:1px; background:linear-gradient(90deg,transparent,var(--dua),transparent); }
.invite-icon { font-size:18px; margin-bottom:10px; display:block; }
.invite-text { font-family:'Instrument Serif',serif; font-style:italic; font-size:13px; color:var(--txt-dim); line-height:1.6; margin-bottom:14px; }
.invite-actions { display:flex; gap:8px; }
.invite-yes { flex:1; padding:9px; background:var(--dua-glow); border:1px solid var(--dua-soft); color:var(--dua); font-family:'DM Mono',monospace; font-size:10px; letter-spacing:.12em; text-transform:uppercase; cursor:pointer; transition:all .3s; }
.invite-yes:hover { background:var(--dua-soft); }
.invite-no { flex:1; padding:9px; background:transparent; border:1px solid var(--border); color:var(--txt-muted); font-family:'DM Mono',monospace; font-size:10px; letter-spacing:.12em; text-transform:uppercase; cursor:pointer; transition:all .3s; }

/* ====================================================
   MODALS ‚Äî Volunteer + Upgrade
   ==================================================== */
.modal-overlay {
  position:fixed; inset:0; background:rgba(8,8,16,.9); backdrop-filter:blur(10px);
  z-index:8000; opacity:0; visibility:hidden; transition:all .4s;
  display:flex; align-items:flex-end;
}
.modal-overlay.active { opacity:1; visibility:visible; }
.modal-sheet { width:100%; max-width:480px; margin:0 auto; background:var(--surface); border-top:1px solid var(--border-warm); padding:32px 24px 48px; transform:translateY(100%); transition:transform .4s; }
.modal-overlay.active .modal-sheet { transform:translateY(0); }
.modal-handle { width:32px; height:3px; background:var(--border); border-radius:3px; margin:0 auto 24px; }
.modal-title { font-family:'Instrument Serif',serif; font-size:20px; margin-bottom:8px; }
.modal-sub { font-size:12px; color:var(--txt-dim); line-height:1.7; margin-bottom:24px; }
.modal-list { list-style:none; margin-bottom:28px; }
.modal-list li { font-size:12px; color:var(--txt-dim); padding:10px 0; border-bottom:1px solid var(--border); display:flex; align-items:flex-start; gap:12px; line-height:1.6; }
.modal-list li::before { content:'‚óã'; color:var(--amber-soft); font-size:14px; flex-shrink:0; padding-top:1px; }
.modal-btn { width:100%; padding:14px; background:transparent; border:1px solid var(--border-warm); color:var(--amber-soft); font-family:'DM Mono',monospace; font-size:11px; letter-spacing:.15em; text-transform:uppercase; cursor:pointer; transition:all .3s; margin-bottom:12px; }
.modal-btn:hover { background:var(--amber-glow); }
.modal-btn.dua-btn { border-color:var(--dua-soft); color:var(--dua); }
.modal-btn.dua-btn:hover { background:var(--dua-glow); }
.modal-cancel { width:100%; padding:12px; background:transparent; border:none; color:var(--txt-muted); font-family:'DM Mono',monospace; font-size:10px; letter-spacing:.1em; text-transform:uppercase; cursor:pointer; }

/* upgrade price options */
.price-row { display:flex; gap:8px; margin-bottom:16px; }
.price-opt { flex:1; padding:12px 8px; background:var(--surface2); border:1px solid var(--border); text-align:center; cursor:pointer; transition:all .3s; }
.price-opt.sel { border-color:var(--dua-soft); background:var(--dua-glow); }
.price-opt-label { font-size:9px; color:var(--txt-muted); letter-spacing:.1em; margin-bottom:4px; }
.price-opt-num { font-family:'Instrument Serif',serif; font-size:18px; color:var(--dua); }
.price-opt-sub { font-size:9px; color:var(--txt-muted); margin-top:2px; }
.upgrade-benefits { list-style:none; margin-bottom:20px; }
.upgrade-benefits li { font-size:12px; color:var(--txt-dim); padding:8px 0; border-bottom:1px solid var(--border); display:flex; gap:10px; line-height:1.5; }
.upgrade-benefits li::before { content:'¬∑'; color:var(--dua); font-size:20px; line-height:1; flex-shrink:0; }
</style>
</head>
<body>

<!-- ====================================================
     INTRO SCREEN
     ==================================================== -->
<div id="intro-screen">
  <div class="intro-content">
    <span class="intro-candle">üïØÔ∏è</span>
    <div class="intro-wave">
      <div class="intro-wave-bar"></div><div class="intro-wave-bar"></div>
      <div class="intro-wave-bar"></div><div class="intro-wave-bar"></div>
      <div class="intro-wave-bar"></div><div class="intro-wave-bar"></div>
      <div class="intro-wave-bar"></div><div class="intro-wave-bar"></div>
      <div class="intro-wave-bar"></div>
    </div>
    <div class="intro-narasi">
      <span class="glow">Hey, it's me...</span><br>
      Dengarkan.<br><br>
      Aku tidak tau apakah kita pernah berteman,<br>
      atau kita belum pernah berjumpa sebelumnya.<br><br>
      Jika kamu butuh teman bicara saat sendiri,<br>
      karena yang lain sibuk atau sudah tertidur lelap ‚Äî<br><br>
      <span class="hi">aku di sini.</span><br><br>
      Aku akan mendengar apapun yang kamu bicarakan,<br>
      atau cukup mendengar suara nafasmu di ujung sana.<br><br>
      Aku akan di sini.<br>
      <span class="glow">I promised.</span>
    </div>
    <button class="intro-enter" onclick="enterInsomnia()">Masuk ke dalam</button>
  </div>
</div>

<!-- ====================================================
     MAIN APP
     ==================================================== -->
<div id="app">
  <div class="wrapper">

    <div class="header">
      <div class="header-top">
        <div>
          <div class="brand-name">Insomnia</div>
          <div class="brand-sub">Voice Space ‚Äî Glitch</div>
        </div>
        <div style="text-align:right">
          <div class="live-indicator">
            <div class="live-dot"></div>
            <span id="live-count">0 suara aktif</span>
          </div>
          <div class="time-display" id="time-display">--:--</div>
        </div>
      </div>
    </div>

    <div class="algo-panel">
      <div class="algo-title">Status Malam Ini</div>
      <div class="algo-stats">
        <div class="algo-stat"><div class="algo-num" id="stat-rooms">0</div><div class="algo-label">Ruang Aktif</div></div>
        <div class="algo-stat"><div class="algo-num" id="stat-vol">0</div><div class="algo-label">Pendengar Siap</div></div>
        <div class="algo-stat"><div class="algo-num" id="stat-queue">0</div><div class="algo-label">Antrean</div></div>
      </div>
    </div>

    <div class="window-banner" id="window-banner">
      <span id="win-icon">üåô</span>
      <span id="win-text">Memeriksa ketersediaan...</span>
    </div>

    <!-- RUANG GELAP -->
    <div class="rooms-section">
      <div class="section-label">Ruang Gelap</div>
      <div class="room-card">
        <div class="room-card-inner">
          <span class="room-type-badge gelap">Conference ¬∑ Max 5 Suara</span>
          <div class="room-title">Kita ngobrol tanpa tahu siapa siapa</div>
          <div class="room-desc">
            Masuk, bicara, atau cukup dengarkan. Tidak ada host. Tidak ada agenda.
            Percakapan mengalir ke mana ia mau ‚Äî berakhir saat semua sudah pergi.
          </div>
          <div class="room-occupancy">
            <div class="occupancy-slots" id="gelap-slots">
              <div class="slot"></div><div class="slot"></div><div class="slot"></div>
              <div class="slot"></div><div class="slot"></div>
            </div>
            <span class="occupancy-text" id="gelap-count">0 / 5 suara</span>
          </div>
          <div class="room-wave" id="gelap-wave">
            <div class="room-wave-bar amber"></div><div class="room-wave-bar amber"></div>
            <div class="room-wave-bar amber"></div><div class="room-wave-bar amber"></div>
            <div class="room-wave-bar amber"></div><div class="room-wave-bar amber"></div>
            <div class="room-wave-bar amber"></div><div class="room-wave-bar amber"></div>
            <div class="room-wave-bar amber"></div><div class="room-wave-bar amber"></div>
            <div class="room-wave-bar amber"></div><div class="room-wave-bar amber"></div>
          </div>
          <button class="room-enter-btn" id="gelap-btn" onclick="enterRoom('gelap')">Masuk Ruang Gelap</button>
        </div>
      </div>
    </div>

    <!-- RUANG SUNYI -->
    <div class="rooms-section">
      <div class="section-label">Ruang Sunyi</div>
      <div class="room-card">
        <div class="room-card-inner">
          <span class="room-type-badge sunyi">1-on-1 ¬∑ Volunteer Pendengar</span>
          <div class="room-title">Ada yang mendengar, malam ini</div>
          <div class="room-desc">
            Satu pendengar, satu kamu. Tidak ada solusi yang ditawarkan ‚Äî hanya kehadiran.
            Bicara tentang apapun, atau diam bersama. Tidak ada nama. Tidak ada identitas.
            Hanya dua suara yang saling hadir.
          </div>
          <div class="room-wave" id="sunyi-wave">
            <div class="room-wave-bar breath"></div><div class="room-wave-bar breath"></div>
            <div class="room-wave-bar breath"></div><div class="room-wave-bar breath"></div>
            <div class="room-wave-bar breath"></div><div class="room-wave-bar breath"></div>
            <div class="room-wave-bar breath"></div><div class="room-wave-bar breath"></div>
            <div class="room-wave-bar breath"></div><div class="room-wave-bar breath"></div>
            <div class="room-wave-bar breath"></div><div class="room-wave-bar breath"></div>
          </div>
          <!-- ZERO IDENTITY in volunteer list ‚Äî only availability dots -->
          <div class="vol-queue">
            <div class="vol-queue-title">Ketersediaan malam ini</div>
            <div id="vol-list">
              <div class="vol-item">
                <div class="vol-status"><div class="vol-dot on"></div><span class="vol-label">Pendengar siap</span></div>
                <span class="vol-state">tersedia</span>
              </div>
              <div class="vol-item">
                <div class="vol-status"><div class="vol-dot off"></div><span class="vol-label">Pendengar siap</span></div>
                <span class="vol-state">sedang mendengar</span>
              </div>
            </div>
          </div>
          <button class="room-enter-btn sunyi-btn" id="sunyi-btn" onclick="enterRoom('sunyi')" style="margin-top:20px">Minta Pendengar</button>
          <button class="room-enter-btn secondary" onclick="openVolModal()">Jadi Pendengar Malam Ini</button>
        </div>
      </div>
    </div>

    <!-- CATATAN: Ruang Dua tidak tampil di sini.
         Hanya muncul dari dalam Ruang Gelap via invite.
         Tidak ada entry point publik. -->

    <!-- Operation Log -->
    <div class="section-label" style="margin-bottom:16px">Catatan Sistem</div>
    <div class="op-log">
      <div class="op-log-title">Algorithm Log</div>
      <div id="op-entries">
        <div class="op-entry"><span class="op-time" id="lt1">--:--</span><span class="op-msg sys">Insomnia diaktifkan. Ruang siap.</span></div>
        <div class="op-entry"><span class="op-time" id="lt2">--:--</span><span class="op-msg">Memeriksa ketersediaan volunteer...</span></div>
      </div>
    </div>

    <div class="support-strip">
      <div class="support-text">Kalau malam ini terasa terlalu berat untuk ditanggung sendiri, ada yang siap mendengar lebih jauh dari yang bisa kami tawarkan.</div>
      <a href="https://www.into-the-light.org" class="support-link" target="_blank">Into The Light Indonesia ‚Äî 119 ext 8</a>
    </div>

  </div>
</div>

<!-- ====================================================
     VOICE ROOM OVERLAY ‚Äî Gelap & Sunyi
     ==================================================== -->
<div id="voice-overlay">
  <div class="vr-content">
    <div class="vr-type-label" id="vr-label">Ruang Gelap</div>
    <div class="vr-room-name" id="vr-name">‚Äî</div>

    <div class="p-ring" id="p-ring"></div>

    <!--
      INVITE TO RUANG DUA ‚Äî only visible inside Ruang Gelap.
      Tap a participant circle, this appears.
      Silent to everyone else in the room.
    -->
    <div class="invite-strip" id="invite-strip" onclick="sendDuaInvite()">
      <span>‚ú¶</span>
      <span>Ajak ke Ruang Dua</span>
    </div>

    <div class="cwave">
      <div class="cbar"></div><div class="cbar"></div><div class="cbar"></div>
      <div class="cbar"></div><div class="cbar a"></div><div class="cbar a"></div>
      <div class="cbar a"></div><div class="cbar a"></div><div class="cbar a"></div>
      <div class="cbar a"></div><div class="cbar a"></div>
    </div>

    <div class="vr-controls">
      <button class="ctrl" id="spk-btn" onclick="toggleSpk()">üîä</button>
      <button class="ctrl main" id="mic-btn" onclick="toggleMic()">üéôÔ∏è</button>
      <button class="ctrl leave" onclick="leaveRoom()">‚úï</button>
    </div>
    <div class="vr-timer" id="vr-timer">00:00</div>
    <div class="vr-hint" id="vr-hint">"Bicara, atau cukup hadir. Keduanya diterima."</div>
  </div>
</div>

<!-- safe exit -->
<div class="safe-exit" id="safe-exit">
  <div class="safe-exit-inner">
    <div class="safe-exit-text">Aku masih di sini kalau kamu mau lanjut.<br>Tapi tidak apa-apa juga kalau kamu sudah siap pergi.</div>
    <button class="safe-exit-btn" onclick="leaveRoom()">Keluar dengan tenang</button>
  </div>
</div>

<!-- ====================================================
     RUANG DUA OVERLAY
     Masuk dari Ruang Gelap via invite.
     Senyap. Tidak ada yang tahu selain dua orang ini.
     ==================================================== -->
<div id="dua-overlay">
  <div class="dua-content">
    <div class="dua-label">Ruang Dua</div>
    <div class="dua-title">Cuma kamu dan satu orang</div>
    <div class="dua-sub">yang lainnya tidak tahu</div>

    <!-- No labels. No identity. Just two presences. -->
    <div class="dua-orbs">
      <div class="dua-orb" id="dua-orb-a"><div class="dua-orb-dot"></div></div>
      <div class="dua-line"></div>
      <div class="dua-orb" id="dua-orb-b"><div class="dua-orb-dot"></div></div>
    </div>

    <div class="dua-wave">
      <div class="dua-bar"></div><div class="dua-bar"></div><div class="dua-bar"></div>
      <div class="dua-bar a"></div><div class="dua-bar a"></div><div class="dua-bar a"></div>
      <div class="dua-bar a"></div><div class="dua-bar a"></div><div class="dua-bar a"></div>
      <div class="dua-bar a"></div><div class="dua-bar"></div>
    </div>

    <div class="dua-controls">
      <button class="ctrl" id="dua-spk" onclick="toggleDuaSpk()">üîä</button>
      <button class="ctrl main" id="dua-mic" onclick="toggleDuaMic()">üéôÔ∏è</button>
      <button class="ctrl leave" onclick="leaveDua()">‚úï</button>
    </div>
    <div class="dua-timer" id="dua-timer">00:00</div>
    <div class="dua-hint" id="dua-hint">"Bicara sepanjang malam kalau mau."</div>
  </div>
</div>

<!-- ====================================================
     INCOMING INVITE NOTIFICATION
     Hanya muncul untuk yang diundang.
     Tidak ada broadcast ke Ruang Gelap.
     ==================================================== -->
<div id="invite-notif">
  <div class="invite-inner">
    <span class="invite-icon">‚ú¶</span>
    <div class="invite-text">
      Seseorang di Ruang Gelap mengajakmu ke Ruang Dua.<br>
      Hanya kamu yang tahu undangan ini.
    </div>
    <div class="invite-actions">
      <button class="invite-yes" onclick="acceptDuaInvite()">Masuk</button>
      <button class="invite-no" onclick="declineDuaInvite()">Tidak sekarang</button>
    </div>
  </div>
</div>

<!-- ====================================================
     VOLUNTEER MODAL
     ==================================================== -->
<div class="modal-overlay" id="vol-modal" onclick="closeModal('vol-modal',event)">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Jadi Pendengar Malam Ini</div>
    <div class="modal-sub">Bukan aturan ‚Äî tapi perjanjian dengan dirimu sendiri.</div>
    <ul class="modal-list">
      <li>Kamu tidak perlu punya jawaban. Hadir saja sudah cukup.</li>
      <li>Kamu boleh mengakhiri sesi kapanpun kamu merasa tidak baik.</li>
      <li>Jika yang kamu dengar terlalu berat, ada yang bisa kamu hubungi setelah sesi.</li>
    </ul>
    <button class="modal-btn" onclick="registerVol()">Aku siap mendengar malam ini</button>
    <button class="modal-cancel" onclick="closeModal('vol-modal')">Mungkin lain kali</button>
  </div>
</div>

<!-- ====================================================
     UPGRADE MODAL ‚Äî Ruang Dua (Jejak Connect)
     ==================================================== -->
<div class="modal-overlay" id="upgrade-modal" onclick="closeModal('upgrade-modal',event)">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title" style="color:var(--dua)">Ruang Dua</div>
    <div class="modal-sub">Bagian dari Jejak Connect. Bicara 1-on-1 dengan siapapun yang kamu temui di Ruang Gelap.</div>
    <div class="price-row">
      <div class="price-opt sel" onclick="selectPrice(this,'bulan')">
        <div class="price-opt-label">Bulanan</div>
        <div class="price-opt-num">20rb</div>
        <div class="price-opt-sub">per bulan</div>
      </div>
      <div class="price-opt" onclick="selectPrice(this,'tahun')">
        <div class="price-opt-label">Tahunan</div>
        <div class="price-opt-num">200rb</div>
        <div class="price-opt-sub">hemat 2 bulan</div>
      </div>
    </div>
    <ul class="upgrade-benefits">
      <li>Ruang Dua ‚Äî voice 1-on-1 private dari Ruang Gelap</li>
      <li>Pin satu memori di Jejak selamanya</li>
      <li>Arsip rants yang terkena FIFO</li>
      <li>DM teks ke sesama user Jejak Connect</li>
    </ul>
    <button class="modal-btn dua-btn" onclick="subscribeDua()">Aktifkan Jejak Connect</button>
    <button class="modal-cancel" onclick="closeModal('upgrade-modal')">Nanti dulu</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<nav class="bottom-nav">
  <div class="nav-container">
    <a href="jejak.html" class="nav-item"><span class="nav-icon">‚ú¶</span><span class="nav-label">Jejak</span></a>
    <a href="cocomeo.html" class="nav-item"><span class="nav-icon">„Äú</span><span class="nav-label">Cocomeo</span></a>
    <a href="saynope.html" class="nav-item"><span class="nav-icon">‚úï</span><span class="nav-label">Spill</span></a>
    <a href="glitch.html" class="nav-item active"><span class="nav-icon">‚ö°</span><span class="nav-label">Glitch</span></a>
  </div>
</nav>

<script>
// ====================================================
// INSOMNIA ‚Äî ALGORITHM ENGINE v2
// Three rooms: Gelap (free) ¬∑ Sunyi (free) ¬∑ Dua (paid)
//
// PRIVACY RULES:
// Ruang Sunyi: zero username display. Voice is verbal-only.
//   User may choose to say their name verbally ‚Äî that's
//   their choice. Platform never surfaces, stores, or
//   connects any spoken name to their account identity.
//
// Ruang Dua: invite-only from inside Ruang Gelap.
//   Invite is silent ‚Äî no broadcast to other members.
//   Only inviter and invitee know the transition happened.
//   Platform does not log who moved to Ruang Dua.
// ====================================================

const CFG = {
  SB_URL: 'https://fuovfrdicdhnlymnacpz.supabase.co',
  SB_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0',
  WIN_START: 21,       // 9 PM ‚Äî rooms open
  WIN_END: 4,          // 4 AM ‚Äî rooms close
  MAX_GELAP: 5,
  SILENCE_MS: 300000,  // 5 min silence ‚Üí ambient breath signal
  SAFE_EXIT_MS: 120000,// 2 min ‚Üí safe exit appears
  VOL_SOFT_MAX_MS: 3600000, // 60 min volunteer soft limit
  INVITE_TIMEOUT_MS: 30000, // 30s for invitee to respond
};

const st = {
  sb: null, online: false,
  inRoom: false, room: null, // 'gelap'|'sunyi'|'dua'
  roomId: null,
  isPremium: false, // Jejak Connect subscriber
  isVol: false,
  isMuted: false, isSpkOff: false,
  duaMuted: false, duaSpkOff: false,
  sessionStart: null,
  duaSessionStart: null,
  timerIv: null, duaTimerIv: null,
  safeExitTo: null,
  silenceTo: null,
  inviteTo: null,
  selectedParticipant: null, // who user tapped to invite to Dua
  anonId: null,
};

// ====================================================
// ANONYMOUS IDENTITY ‚Äî ephemeral per session
// Single initial used in voice room UI only.
// Never stored. Regenerated on each entry.
// ====================================================
const POOL = ['Bulan','Bintang','Hujan','Malam','Fajar','Senja','Awan','Angin','Embun','Kabut','Riak','Bayu'];
function genAnon() {
  const n = POOL[Math.floor(Math.random()*POOL.length)];
  return n + (Math.floor(Math.random()*99)+1);
}

// ====================================================
// ALGORITHM: TIME WINDOW
// Insomnia only lives at night.
// This is not a restriction ‚Äî this IS the product.
// ====================================================
function checkWindow() {
  const h = new Date().getHours();
  const open = h >= CFG.WIN_START || h < CFG.WIN_END;
  const banner = document.getElementById('window-banner');
  const icon = document.getElementById('win-icon');
  const text = document.getElementById('win-text');

  banner.className = 'window-banner ' + (open ? 'open' : 'closed');
  icon.textContent = open ? (h >= 23 || h < 2 ? 'üåë' : 'üåô') : '‚òÄÔ∏è';
  text.textContent = open ? winMsg(h) : 'Insomnia hadir mulai jam 21.00. Kembali nanti malam.';

  const off = !open;
  document.getElementById('gelap-btn').disabled = off;
  document.getElementById('sunyi-btn').disabled = off;
  if (open) addLog('sys', winMsg(h));
  return open;
}

function winMsg(h) {
  if (h>=21&&h<23) return 'Malam baru dimulai. Ruang sedang hangat.';
  if (h>=23||h<1)  return 'Tengah malam. Ini waktunya.';
  if (h>=1&&h<3)   return 'Dini hari. Yang masih terjaga, ada di sini.';
  return 'Hampir pagi. Beberapa ruang mulai menutup.';
}

// ====================================================
// ALGORITHM: ROOM MATCHING ‚Äî Ruang Gelap
// Find room with space or create new one.
// No identity-based matching ‚Äî time of entry only.
// ====================================================
async function matchGelap() {
  if (!st.online) return { id: 'local-'+Date.now(), count: 1 };
  try {
    const { data } = await st.sb.from('insomnia_rooms')
      .select('*').eq('type','gelap').eq('status','open')
      .lt('participant_count', CFG.MAX_GELAP)
      .order('created_at',{ascending:true}).limit(1);
    if (data && data.length) {
      await st.sb.from('insomnia_rooms').update({participant_count: data[0].participant_count+1}).eq('id',data[0].id);
      addLog('sys','Bergabung ke kamar yang sudah ada.');
      return { id: data[0].id, count: data[0].participant_count+1 };
    }
    const { data: nr } = await st.sb.from('insomnia_rooms')
      .insert({ type:'gelap', status:'open', participant_count:1, created_at:new Date().toISOString(), anon_name:genRoomName() })
      .select().single();
    addLog('sys','Kamar baru dibuka.');
    return { id: nr.id, count: 1 };
  } catch(e) { return { id: 'err-'+Date.now(), count: 1 }; }
}

// ====================================================
// ALGORITHM: VOLUNTEER MATCHING ‚Äî Ruang Sunyi
// Priority: volunteer with fewest sessions tonight.
// NO name, NO session count shown to user.
// Voice is verbal only ‚Äî platform never surfaces identity.
// ====================================================
async function matchVol() {
  if (!st.online) return { id: 'demo', name: null };
  try {
    const { data } = await st.sb.from('insomnia_volunteers')
      .select('*').eq('status','available').eq('on_duty',true)
      .order('sessions_tonight',{ascending:true}).limit(1);
    if (data && data.length) {
      addLog('vol','Pendengar ditemukan. Menghubungkan...');
      return { id: data[0].id, name: null }; // name intentionally omitted
    }
    addLog('alert','Belum ada pendengar tersedia. Masuk antrean.');
    return null;
  } catch(e) { return null; }
}

// ====================================================
// ALGORITHM: SILENCE DETECTION
// Ruang Gelap only. Sunyi silence is sacred.
// Dua silence is intimate ‚Äî never interrupted.
// ====================================================
function resetSilence() {
  if (st.silenceTo) clearTimeout(st.silenceTo);
  if (st.room === 'gelap') {
    st.silenceTo = setTimeout(() => {
      // Soft breath ‚Äî visual only, no text prompt
      document.querySelectorAll('.cbar').forEach(b => {
        b.style.opacity = '0.1';
        setTimeout(() => b.style.opacity = '', 4000);
      });
    }, CFG.SILENCE_MS);
  }
}

// ====================================================
// ROOM ENTRY
// ====================================================
async function enterRoom(type) {
  if (!checkWindow()) { toast('Insomnia hadir mulai jam 21.00 malam.'); return; }
  st.room = type;
  st.anonId = genAnon();
  st.sessionStart = Date.now();

  if (type === 'gelap') {
    const m = await matchGelap();
    st.roomId = m.id;
    showVoiceOverlay('gelap', m.count);
  } else {
    const v = await matchVol();
    if (!v) {
      updStat('queue', +document.getElementById('stat-queue').textContent + 1);
      return;
    }
    showVoiceOverlay('sunyi', 2);
  }
}

function showVoiceOverlay(type, count) {
  // Labels
  document.getElementById('vr-label').textContent = type === 'gelap' ? 'Ruang Gelap' : 'Ruang Sunyi';
  document.getElementById('vr-name').textContent  = type === 'gelap' ? genRoomName() : 'Ruang Sunyi';
  document.getElementById('vr-hint').textContent  = type === 'gelap'
    ? '"Bicara, atau cukup hadir. Keduanya diterima."'
    : '"Aku di sini. Tidak kemana-mana."';

  // Build participant ring
  const ring = document.getElementById('p-ring');
  ring.innerHTML = '';
  const max = type === 'gelap' ? 5 : 2;
  for (let i=0; i<max; i++) {
    const c = document.createElement('div');
    if (i === 0) {
      c.className = 'p-circle you';
      // Show only first letter of ephemeral anon ID ‚Äî no username
      c.innerHTML = `<span class="p-anon">${st.anonId.charAt(0)}</span><span class="p-label">kamu</span>`;
    } else if (i < count) {
      c.className = 'p-circle';
      // Other participants: symbol only, no identity whatsoever
      c.innerHTML = `<span class="p-anon">¬∑</span>`;
      if (type === 'gelap') {
        // Tap to invite to Ruang Dua
        c.style.cursor = 'pointer';
        c.dataset.idx = i;
        c.addEventListener('click', () => onParticipantTap(c, i));
      }
    } else if (type === 'sunyi' && i === 1) {
      // Ruang Sunyi: volunteer shown as symbol only ‚Äî no name, no session count
      c.className = 'p-circle';
      c.innerHTML = `<span class="p-anon">‚ô°</span>`;
      // No label ‚Äî label would imply identity
    } else {
      c.className = 'p-circle empty';
      c.innerHTML = `<span class="p-anon">¬∑</span>`;
    }
    ring.appendChild(c);
  }

  // Invite strip: only visible in Ruang Gelap when user has premium
  const strip = document.getElementById('invite-strip');
  strip.className = 'invite-strip' + (type === 'gelap' ? ' visible' : '');

  document.getElementById('voice-overlay').classList.add('active');
  st.inRoom = true;
  document.body.style.overflow = 'hidden';

  startTimer('vr-timer', 'timerIv');
  resetSilence();
  st.safeExitTo = setTimeout(() => document.getElementById('safe-exit').classList.add('show'), CFG.SAFE_EXIT_MS);

  addLog('sys', `Masuk ${type === 'gelap' ? 'Ruang Gelap' : 'Ruang Sunyi'}.`);
  logSignal('entry', { type });
  updStat('rooms', +document.getElementById('stat-rooms').textContent + 1);
}

function leaveRoom() {
  document.getElementById('voice-overlay').classList.remove('active');
  document.getElementById('safe-exit').classList.remove('show');
  document.body.style.overflow = '';
  clearInterval(st.timerIv);
  clearTimeout(st.safeExitTo);
  clearTimeout(st.silenceTo);
  const dur = st.sessionStart ? Date.now()-st.sessionStart : 0;
  addLog('sys',`Keluar. Durasi: ${fmtTime(dur)}`);
  logSignal('duration', { ms: dur, type: st.room });
  updStat('rooms', Math.max(0, +document.getElementById('stat-rooms').textContent - 1));
  st.inRoom = false; st.room = null; st.roomId = null;
}

// ====================================================
// RUANG DUA ‚Äî INVITE FLOW
//
// ALGORITHM:
// 1. User taps a participant circle in Ruang Gelap
// 2. Invite strip becomes highlighted
// 3. User taps "Ajak ke Ruang Dua"
// 4. System checks: is user premium (Jejak Connect)?
//    NO  ‚Üí show upgrade modal
//    YES ‚Üí send silent invite to that participant
// 5. Invite notification appears ONLY for invitee
//    ‚Äî no broadcast, no mention in Ruang Gelap
// 6. 30s timeout: if no response, invite disappears
// 7. If accepted ‚Üí both enter Ruang Dua silently
//    ‚Äî Ruang Gelap continues without them
//    ‚Äî no system message, no slot update
// ====================================================
function onParticipantTap(circle, idx) {
  // Deselect previous
  document.querySelectorAll('.p-circle.invite-ready').forEach(c => c.classList.remove('invite-ready'));
  circle.classList.add('invite-ready');
  st.selectedParticipant = idx;
  toast('Tap "Ajak ke Ruang Dua" untuk mengundang');
}

function sendDuaInvite() {
  if (!st.selectedParticipant) {
    toast('Tap salah satu suara dulu untuk mengundang');
    return;
  }
  if (!st.isPremium) {
    openModal('upgrade-modal');
    return;
  }
  // Simulate sending invite ‚Äî in production via Supabase realtime channel
  addLog('sys','Undangan Ruang Dua terkirim. Menunggu respons...');
  toast('Undangan terkirim. Menunggu...');
  // Timeout: if no response in 30s, cancel
  st.inviteTo = setTimeout(() => {
    toast('Tidak ada respons. Undangan dibatalkan.');
    document.querySelectorAll('.p-circle.invite-ready').forEach(c => c.classList.remove('invite-ready'));
    st.selectedParticipant = null;
  }, CFG.INVITE_TIMEOUT_MS);

  // Simulate invitee receiving invite (demo: show notification after 1s)
  setTimeout(() => showInviteNotif(), 1000);
}

function showInviteNotif() {
  // This fires on the INVITEE's device ‚Äî not the inviter's.
  // In production: triggered by Supabase realtime subscription.
  document.getElementById('invite-notif').classList.add('show');
}

function acceptDuaInvite() {
  clearTimeout(st.inviteTo);
  document.getElementById('invite-notif').classList.remove('show');
  document.querySelectorAll('.p-circle.invite-ready').forEach(c => c.classList.remove('invite-ready'));
  // Silent transition ‚Äî no announcement in Ruang Gelap
  enterDua();
}

function declineDuaInvite() {
  clearTimeout(st.inviteTo);
  document.getElementById('invite-notif').classList.remove('show');
  document.querySelectorAll('.p-circle.invite-ready').forEach(c => c.classList.remove('invite-ready'));
  st.selectedParticipant = null;
  addLog('sys','Undangan ditolak. Tetap di Ruang Gelap.');
}

function enterDua() {
  // Ruang Dua opens silently on top of Ruang Gelap overlay
  // Ruang Gelap is NOT closed ‚Äî it continues in background
  st.duaSessionStart = Date.now();
  document.getElementById('dua-overlay').classList.add('active');
  startTimer('dua-timer','duaTimerIv');
  addLog('sys','Masuk Ruang Dua.');
  // No logSignal for Dua ‚Äî this transition is never tracked
}

function leaveDua() {
  document.getElementById('dua-overlay').classList.remove('active');
  clearInterval(st.duaTimerIv);
  const dur = st.duaSessionStart ? Date.now()-st.duaSessionStart : 0;
  addLog('sys',`Keluar Ruang Dua. Durasi: ${fmtTime(dur)}`);
  st.duaSessionStart = null;
  // User returns to Ruang Gelap (still open behind)
}

// ====================================================
// VOICE CONTROLS
// ====================================================
function toggleMic() {
  st.isMuted = !st.isMuted;
  const b = document.getElementById('mic-btn');
  b.textContent = st.isMuted ? 'üîá' : 'üéôÔ∏è';
  b.classList.toggle('muted', st.isMuted);
  if (!st.isMuted) resetSilence();
  toast(st.isMuted ? 'Mikrofon dimatikan' : 'Mikrofon aktif');
}
function toggleSpk() {
  st.isSpkOff = !st.isSpkOff;
  document.getElementById('spk-btn').textContent = st.isSpkOff ? 'üîà' : 'üîä';
  toast(st.isSpkOff ? 'Speaker dimatikan' : 'Speaker aktif');
}
function toggleDuaMic() {
  st.duaMuted = !st.duaMuted;
  const b = document.getElementById('dua-mic');
  b.textContent = st.duaMuted ? 'üîá' : 'üéôÔ∏è';
  b.classList.toggle('muted', st.duaMuted);
}
function toggleDuaSpk() {
  st.duaSpkOff = !st.duaSpkOff;
  document.getElementById('dua-spk').textContent = st.duaSpkOff ? 'üîà' : 'üîä';
}

// ====================================================
// VOLUNTEER FLOW
// ====================================================
function openVolModal() { openModal('vol-modal'); }

async function registerVol() {
  st.isVol = true;
  closeModal('vol-modal');
  if (st.online && st.sb) {
    try {
      await st.sb.from('insomnia_volunteers').insert({
        anon_name: null, // no name stored
        status: 'available', on_duty: true,
        sessions_tonight: 0, registered_at: new Date().toISOString()
      });
    } catch(e){}
  }
  updStat('vol', +document.getElementById('stat-vol').textContent + 1);
  addLog('vol','Pendengar baru bergabung malam ini.');
  toast('Terima kasih. Kamu akan dipanggil saat ada yang membutuhkan.');
  // Show availability dot only ‚Äî no name, no identity
  const list = document.getElementById('vol-list');
  const item = document.createElement('div');
  item.className = 'vol-item';
  item.innerHTML = `<div class="vol-status"><div class="vol-dot on"></div><span class="vol-label" style="color:var(--breath)">Pendengar siap</span></div><span class="vol-state">tersedia</span>`;
  list.prepend(item);
}

// ====================================================
// UPGRADE / PREMIUM
// ====================================================
function openUpgradeModal() { openModal('upgrade-modal'); }
function selectPrice(el, plan) {
  document.querySelectorAll('.price-opt').forEach(o => o.classList.remove('sel'));
  el.classList.add('sel');
}
function subscribeDua() {
  // In production: Midtrans / payment gateway integration
  st.isPremium = true;
  closeModal('upgrade-modal');
  toast('Jejak Connect aktif. Ruang Dua terbuka.');
  addLog('sys','Jejak Connect diaktifkan.');
}

// ====================================================
// MODALS
// ====================================================
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id, e) {
  if (!e || e.target.id === id) document.getElementById(id).classList.remove('active');
}

// ====================================================
// TIMER
// ====================================================
function startTimer(elId, ivKey) {
  if (st[ivKey]) clearInterval(st[ivKey]);
  const el = document.getElementById(elId);
  const startKey = ivKey === 'timerIv' ? 'sessionStart' : 'duaSessionStart';
  st[ivKey] = setInterval(() => {
    const t = st[startKey] ? Date.now()-st[startKey] : 0;
    el.textContent = fmtTime(t);
    // Volunteer burnout at 50 min
    if (st.isVol && ivKey==='timerIv' && t >= CFG.VOL_SOFT_MAX_MS*0.83) {
      addLog('vol','Sudah hampir 50 menit. Boleh mengakhiri sesi dengan tenang.');
    }
  }, 1000);
}

// ====================================================
// PASSIVE SESSION SIGNALS
// Stored as aggregate ‚Äî never linked to identity
// ====================================================
function logSignal(type, data) {
  const key = `insomnia_sig_${new Date().toDateString()}`;
  try {
    const arr = JSON.parse(localStorage.getItem(key)||'[]');
    arr.push({ type, ...data, h: new Date().getHours() });
    if (arr.length > 50) arr.shift();
    localStorage.setItem(key, JSON.stringify(arr));
  } catch(e){}
}

// ====================================================
// UTILITIES
// ====================================================
const ADJ  = ['Sunyi','Larut','Gelap','Sepi','Hening','Dalam','Jauh'];
const NOUN = ['Kamar','Sudut','Lorong','Ruang','Tempat'];
function genRoomName() { return ADJ[Math.floor(Math.random()*ADJ.length)]+' '+NOUN[Math.floor(Math.random()*NOUN.length)]; }

function fmtTime(ms) {
  const s=Math.floor(ms/1000), m=Math.floor(s/60), h=Math.floor(m/60);
  if(h>0) return `${pad(h)}:${pad(m%60)}:${pad(s%60)}`;
  return `${pad(m)}:${pad(s%60)}`;
}
function pad(n){ return String(n).padStart(2,'0'); }

function updStat(id, v) {
  const map = {rooms:'stat-rooms', vol:'stat-vol', queue:'stat-queue'};
  const el = document.getElementById(map[id]);
  if(el) el.textContent = Math.max(0,v);
}

function addLog(type, msg) {
  const c = document.getElementById('op-entries');
  if(!c) return;
  const now = new Date();
  const t = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
  const e = document.createElement('div');
  e.className = 'op-entry';
  e.innerHTML = `<span class="op-time">${t}</span><span class="op-msg ${type}">${msg}</span>`;
  c.appendChild(e);
  while(c.children.length > 6) c.removeChild(c.firstChild);
  document.getElementById('lt1').textContent = t;
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 3000);
}

function updateGelapSlots(n) {
  document.querySelectorAll('#gelap-slots .slot').forEach((s,i) => {
    s.className = 'slot' + (i<n?' filled':'');
  });
  document.getElementById('gelap-count').textContent = `${n} / 5 suara`;
  if(n>0) document.getElementById('gelap-wave').classList.add('live');
}

function tick() {
  const now = new Date();
  document.getElementById('time-display').textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
  document.getElementById('live-count').textContent = `${st.inRoom?1:0} suara aktif`;
}

// ====================================================
// INTRO TRANSITION
// ====================================================
function enterInsomnia() {
  const intro = document.getElementById('intro-screen');
  const app   = document.getElementById('app');
  intro.classList.add('fade-out');
  setTimeout(()=>{ intro.style.display='none'; app.classList.add('visible'); initApp(); }, 1500);
}

// ====================================================
// INIT
// ====================================================
function initApp() {
  if(typeof supabase!=='undefined') {
    st.sb = supabase.createClient(CFG.SB_URL, CFG.SB_KEY);
    st.online = true;
  }
  tick(); checkWindow();
  setInterval(tick, 30000);
  setInterval(checkWindow, 300000);

  const t = pad(new Date().getHours())+':'+pad(new Date().getMinutes());
  document.getElementById('lt1').textContent = t;
  document.getElementById('lt2').textContent = t;

  setTimeout(()=>updateGelapSlots(2), 1500);
  addLog('sys','Sistem berjalan. Selamat datang di Insomnia.');
}

// Keyboard shortcut
document.addEventListener('keydown', e => {
  if(e.key==='Escape') {
    if(document.getElementById('dua-overlay').classList.contains('active')) leaveDua();
    else if(st.inRoom) leaveRoom();
    document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.remove('active'));
  }
});
</script>
</body>
</html>
