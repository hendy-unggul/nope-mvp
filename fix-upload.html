<!DOCTYPE html>
<html>
<head>
    <title>JEJAK - FIX UPLOAD</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #0A0A0A; color: white; font-family: system-ui; padding: 20px; max-width: 500px; margin: 0 auto; }
        button { background: #FF4D00; color: black; border: none; padding: 15px 30px; font-weight: bold; cursor: pointer; width: 100%; margin: 10px 0; font-size: 16px; }
        button:hover { opacity: 0.9; }
        #log { background: #111; border: 2px solid #333; padding: 20px; margin-top: 20px; font-family: monospace; min-height: 200px; overflow-y: auto; border-radius: 8px; }
        .success { color: #39FF14; }
        .error { color: #FF006E; }
        .info { color: #00F0FF; }
    </style>
</head>
<body>

<h2 style="color: #FF4D00; text-align: center;">üîß JEJAK - FIX UPLOAD</h2>

<div style="display: flex; gap: 10px; margin: 20px 0;">
    <button onclick="runTest()">1. TEST KONEKSI</button>
    <button onclick="selectFile()">2. PILIH FOTO</button>
    <button onclick="checkDB()">3. CEK DATABASE</button>
</div>

<div id="log" style="font-size: 14px;">Ready...</div>

<input type="file" id="fileInput" accept="image/*" style="display: none;">

<script>
// ============================================
// SATU-SATUNYA SUPABASE CLIENT
// ============================================
const SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';

// PAKAI NAMA YANG BERBEDA DARI DEFAULT
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const BUCKET = 'artefacts';

// User test
const TEST_USER = {
    id: 'test-user-123',
    username: 'tester'
};

// ============================================
// LOGGING
// ============================================
const logEl = document.getElementById('log');

function addLog(msg, type = 'info') {
    const color = type === 'error' ? '#FF006E' : type === 'success' ? '#39FF14' : '#00F0FF';
    logEl.innerHTML += `<div style="color: ${color}; margin: 5px 0; padding: 5px; border-bottom: 1px solid #333;">> ${msg}</div>`;
    logEl.scrollTop = logEl.scrollHeight;
    console.log(msg);
}

function clearLog() {
    logEl.innerHTML = '';
}

// ============================================
// FUNGSI-FUNGSI UTAMA
// ============================================

// TEST KONEKSI
window.runTest = async function() {
    clearLog();
    addLog('üîç TEST KONEKSI KE SUPABASE...', 'info');
    
    // Test 1: Cek tabel
    try {
        addLog('‚Üí Cek tabel artefacts...', 'info');
        const { data, error } = await client
            .from('artefacts')
            .select('count')
            .limit(1);
        
        if (error) {
            addLog(`‚ùå Error tabel: ${error.message}`, 'error');
            addLog(`üìã Detail: ${JSON.stringify(error)}`, 'error');
        } else {
            addLog('‚úì Tabel artefacts bisa diakses', 'success');
        }
    } catch (e) {
        addLog(`‚ùå Exception: ${e.message}`, 'error');
    }
    
    // Test 2: Cek bucket
    try {
        addLog('‚Üí Cek storage bucket...', 'info');
        const { data: buckets, error } = await client
            .storage
            .listBuckets();
        
        if (error) {
            addLog(`‚ùå Error bucket: ${error.message}`, 'error');
        } else {
            const bucket = buckets.find(b => b.name === BUCKET);
            if (bucket) {
                addLog(`‚úì Bucket "${BUCKET}" ditemukan (public: ${bucket.public})`, 'success');
            } else {
                addLog(`‚ùå Bucket "${BUCKET}" TIDAK ditemukan!`, 'error');
                addLog('‚Üí Buat bucket dulu di Supabase Dashboard > Storage', 'info');
            }
        }
    } catch (e) {
        addLog(`‚ùå Exception: ${e.message}`, 'error');
    }
};

// SELECT FILE
window.selectFile = function() {
    clearLog();
    addLog('üìÇ Pilih file foto...', 'info');
    document.getElementById('fileInput').click();
};

// UPLOAD FILE
document.getElementById('fileInput').onchange = async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    clearLog();
    addLog(`üì∏ File: ${file.name} (${(file.size/1024).toFixed(1)}KB)`, 'info');
    
    const ext = file.name.split('.').pop() || 'jpg';
    const fileName = `test-${Date.now()}.${ext}`;
    
    try {
        // STEP 1: UPLOAD KE STORAGE
        addLog('‚Üí Upload ke storage...', 'info');
        const { error: uploadError } = await client.storage
            .from(BUCKET)
            .upload(fileName, file);
        
        if (uploadError) {
            addLog(`‚ùå Upload gagal: ${uploadError.message}`, 'error');
            addLog(`üìã Detail: ${JSON.stringify(uploadError)}`, 'error');
            
            // Saran perbaikan
            if (uploadError.message.includes('permission')) {
                addLog('üí° Saran: Jalankan SQL policy di Supabase', 'info');
            }
            return;
        }
        addLog('‚úì Upload ke storage berhasil', 'success');
        
        // STEP 2: GET PUBLIC URL
        const { data: { publicUrl } } = client.storage
            .from(BUCKET)
            .getPublicUrl(fileName);
        addLog(`‚Üí URL: ${publicUrl.substring(0, 60)}...`, 'info');
        
        // STEP 3: INSERT KE DATABASE
        addLog('‚Üí Insert ke database...', 'info');
        const { error: insertError } = await client
            .from('artefacts')
            .insert({
                user_id: TEST_USER.id,
                username: TEST_USER.username,
                url: publicUrl,
                note: 'test ' + new Date().toLocaleTimeString(),
                has_face: false,
                faces: []
            });
        
        if (insertError) {
            addLog(`‚ùå Insert gagal: ${insertError.message}`, 'error');
            addLog(`üìã Detail: ${JSON.stringify(insertError)}`, 'error');
        } else {
            addLog('‚úì Insert ke database berhasil!', 'success');
            addLog('‚úÖ UPLOAD SELESAI!', 'success');
        }
        
    } catch (err) {
        addLog(`‚ùå Error: ${err.message}`, 'error');
    }
    
    // Reset input
    e.target.value = '';
};

// CEK DATABASE
window.checkDB = async function() {
    clearLog();
    addLog('üîç CEK ISI DATABASE...', 'info');
    
    try {
        const { data, error } = await client
            .from('artefacts')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(10);
        
        if (error) {
            addLog(`‚ùå Error: ${error.message}`, 'error');
        } else {
            addLog(`‚úì Total data di database: ${data.length}`, 'success');
            if (data.length === 0) {
                addLog('‚Üí Belum ada data', 'info');
            } else {
                data.forEach((item, i) => {
                    addLog(`  ${i+1}. ${item.note || 'no note'} - ${new Date(item.created_at).toLocaleString('id-ID')}`, 'info');
                });
            }
        }
    } catch (e) {
        addLog(`‚ùå Exception: ${e.message}`, 'error');
    }
};

// Initial log
addLog('‚úÖ READY - Klik tombol TEST KONEKSI dulu', 'success');
</script>
</body>
</html>
