<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>GLITCH â€” Ruang Aman</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#0A0A0A; --surface:#141414; --surface-elevated:#1E1E1E;
      --border:#2A2A2A; --border2:#1A1A1A;
      --text:#FFFFFF; --text2:#888888; --text3:#444444;
      --accent:#FF4D00; --accent-dim:rgba(255,77,0,0.08);
      --cyan:#00F0FF; --cyan-dim:rgba(0,240,255,0.08);
      --green:#39FF14; --green-dim:rgba(57,255,20,0.08);
      --purple:#BC8CFF; --purple-dim:rgba(188,140,255,0.08);
      --red:#FF006E;
      --sans:'Plus Jakarta Sans',system-ui,sans-serif;
      --serif:'Instrument Serif',serif;
    }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{height:100%;}
    body{background:var(--bg);color:var(--text);font-family:var(--sans);font-weight:500;
      font-size:15px;line-height:1.4;overflow:hidden;}

    body::before{content:'';position:fixed;inset:0;
      background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
      pointer-events:none;z-index:9999;opacity:0.4;}

    /* â”€â”€ SCREENS â”€â”€ */
    .screen{display:none;height:100dvh;flex-direction:column;overflow:hidden;}
    .screen.active{display:flex;}

    /* â”€â”€ SHARED HEADER â”€â”€ */
    .g-header{background:var(--bg);border-bottom:3px solid var(--border);
      padding:0 16px;display:flex;justify-content:space-between;align-items:center;
      height:56px;flex-shrink:0;position:relative;overflow:hidden;}
    .g-header::after{content:'';position:absolute;bottom:-3px;left:20%;
      width:8px;height:12px;background:var(--accent);border-radius:0 0 50% 50%;
      animation:drip 3s ease-in-out infinite;}
    @keyframes drip{0%,100%{height:12px;opacity:1}50%{height:20px;opacity:.7}}

    .g-logo{font-size:18px;font-weight:900;letter-spacing:-.02em;text-transform:uppercase;}
    .g-logo em{color:var(--accent);font-style:normal;}

    .back-btn{background:none;border:2px solid var(--border);color:var(--text3);
      font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.1em;
      cursor:pointer;padding:6px 12px;display:flex;align-items:center;gap:6px;
      transition:all .2s;text-decoration:none;}
    .back-btn:hover{border-color:var(--accent);color:var(--accent);}

    .header-tag{font-size:9px;font-weight:800;letter-spacing:.15em;text-transform:uppercase;
      padding:4px 10px;border:1px solid;}
    .header-tag.orange{color:var(--accent);border-color:rgba(255,77,0,.4);background:var(--accent-dim);}
    .header-tag.cyan{color:var(--cyan);border-color:rgba(0,240,255,.3);background:var(--cyan-dim);}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCREEN 1 â€” SELECT UNI
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #s-select{overflow-y:auto;padding-bottom:80px;}

    .select-hero{padding:36px 16px 28px;text-align:center;}
    .select-eyebrow{font-size:10px;font-weight:800;letter-spacing:.15em;
      color:var(--cyan);text-transform:uppercase;margin-bottom:12px;
      display:flex;align-items:center;justify-content:center;gap:10px;}
    .eyebrow-line{width:20px;height:2px;background:var(--cyan);}
    .select-title{font-size:clamp(28px,7vw,48px);font-weight:900;letter-spacing:-.03em;
      line-height:1;margin-bottom:12px;text-transform:uppercase;}
    .select-title em{color:var(--cyan);font-style:normal;}
    .select-desc{font-family:var(--serif);font-size:15px;font-style:italic;
      color:var(--text2);line-height:1.6;max-width:320px;margin:0 auto;}

    .uni-grid{display:grid;grid-template-columns:1fr 1fr;gap:3px;padding:0 16px 16px;}

    .uni-card{background:var(--surface);border:2px solid var(--border);
      padding:24px 16px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;
      display:flex;flex-direction:column;align-items:center;text-align:center;gap:8px;}
    .uni-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;
      background:var(--border);transition:background .2s;}
    .uni-card:hover{background:var(--surface-elevated);transform:translateY(-2px);}
    .uni-card:hover::before{background:var(--cyan);}
    .uni-card:active{transform:scale(.97);}

    .uni-code{font-size:28px;font-weight:900;letter-spacing:-.02em;color:var(--cyan);}
    .uni-name{font-size:11px;font-weight:700;color:var(--text2);line-height:1.3;}
    .uni-loc{font-size:10px;font-weight:600;color:var(--text3);}
    .uni-status{font-size:9px;font-weight:800;letter-spacing:.1em;
      padding:3px 8px;border:1px solid;text-transform:uppercase;margin-top:4px;}
    .uni-status.active{color:var(--green);border-color:rgba(57,255,20,.3);background:var(--green-dim);}

    .select-note{margin:0 16px 24px;padding:16px;background:var(--surface);
      border:1px solid var(--border);border-left:3px solid var(--cyan);}
    .select-note-title{font-size:10px;font-weight:800;letter-spacing:.1em;
      color:var(--cyan);text-transform:uppercase;margin-bottom:8px;}
    .select-note p{font-size:12px;font-weight:500;color:var(--text2);line-height:1.6;}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCREEN 2 â€” PIN
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #s-pin{justify-content:center;align-items:center;padding:16px;}

    .pin-box{width:100%;max-width:400px;background:var(--surface);
      border:2px solid var(--border);padding:32px 24px;}
    .pin-box::before{content:'';display:block;height:3px;
      background:linear-gradient(90deg,var(--accent),var(--red));
      margin:-32px -24px 24px;}

    .pin-back{font-size:11px;font-weight:800;color:var(--text3);cursor:pointer;
      margin-bottom:20px;display:inline-flex;align-items:center;gap:6px;
      text-transform:uppercase;letter-spacing:.1em;transition:color .15s;}
    .pin-back:hover{color:var(--accent);}

    .pin-room-tag{font-size:10px;font-weight:800;letter-spacing:.15em;
      color:var(--cyan);text-transform:uppercase;margin-bottom:8px;}
    .pin-title{font-size:22px;font-weight:900;letter-spacing:-.02em;margin-bottom:6px;}
    .pin-sub{font-size:13px;font-weight:500;color:var(--text2);line-height:1.6;margin-bottom:24px;}
    .pin-sub strong{color:var(--text);font-weight:700;}

    .pin-wrap{position:relative;margin-bottom:8px;}
    .pin-input{width:100%;background:var(--bg);border:2px solid var(--border);
      color:var(--text);padding:14px 48px 14px 16px;font-family:var(--sans);
      font-size:16px;font-weight:600;letter-spacing:.1em;outline:none;
      transition:border-color .15s;}
    .pin-input:focus{border-color:var(--cyan);}
    .pin-input::placeholder{color:var(--text3);letter-spacing:0;font-size:13px;font-weight:500;}
    .pin-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);
      font-size:10px;font-weight:800;color:var(--text3);cursor:pointer;
      letter-spacing:.1em;text-transform:uppercase;transition:color .15s;}
    .pin-toggle:hover{color:var(--text2);}

    .pin-hint{font-size:11px;font-weight:600;color:var(--text3);margin-bottom:16px;letter-spacing:.03em;}
    .pin-error{font-size:12px;font-weight:700;color:var(--red);padding:10px 14px;
      background:rgba(255,0,110,.08);border:1px solid rgba(255,0,110,.2);
      margin-bottom:16px;display:none;}
    .pin-error.show{display:block;}

    .pin-submit{width:100%;background:var(--cyan);color:#000;border:none;
      padding:16px;font-size:13px;font-weight:800;text-transform:uppercase;
      letter-spacing:.1em;cursor:pointer;transition:all .2s;margin-bottom:20px;}
    .pin-submit:hover{background:#26f4ff;}
    .pin-submit:disabled{background:var(--surface-elevated);color:var(--text3);cursor:not-allowed;}

    .pin-security{background:var(--bg);border:1px solid var(--border2);
      padding:14px 16px;font-size:12px;font-weight:500;color:var(--text3);line-height:1.6;}
    .pin-security strong{color:var(--text2);font-weight:700;}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCREEN 3 â€” IDENTITY
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #s-identity{justify-content:center;align-items:center;padding:16px;overflow-y:auto;}

    .id-box{width:100%;max-width:400px;}

    .id-title{font-size:20px;font-weight:900;letter-spacing:-.02em;margin-bottom:6px;}
    .id-sub{font-size:13px;font-weight:500;color:var(--text2);margin-bottom:24px;line-height:1.5;}

    .id-toggle{display:grid;grid-template-columns:1fr 1fr;gap:2px;margin-bottom:20px;}
    .id-toggle-btn{background:var(--surface);border:2px solid var(--border);
      color:var(--text3);padding:12px;font-size:12px;font-weight:800;
      text-transform:uppercase;letter-spacing:.08em;cursor:pointer;transition:all .2s;}
    .id-toggle-btn.active{background:var(--surface-elevated);color:var(--text);border-color:var(--text);}

    .id-label{font-size:10px;font-weight:800;letter-spacing:.1em;color:var(--text3);
      text-transform:uppercase;margin-bottom:10px;}
    .alias-pool{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px;}
    .alias-chip{font-size:11px;font-weight:700;padding:5px 10px;
      background:var(--surface);border:1px solid var(--border);color:var(--text3);
      cursor:pointer;transition:all .15s;letter-spacing:.03em;}
    .alias-chip:hover{border-color:var(--cyan);color:var(--cyan);}
    .alias-chip.selected{border-color:var(--cyan);color:var(--cyan);background:var(--cyan-dim);}

    .id-input{width:100%;background:var(--bg);border:2px solid var(--border);
      color:var(--text);padding:12px 16px;font-family:var(--sans);font-size:14px;
      font-weight:600;outline:none;margin-bottom:6px;transition:border-color .15s;}
    .id-input:focus{border-color:var(--cyan);}
    .id-input::placeholder{color:var(--text3);font-size:13px;font-weight:500;}
    .id-hint{font-size:11px;font-weight:600;color:var(--text3);margin-bottom:20px;line-height:1.5;}

    .id-preview{display:flex;align-items:center;gap:14px;padding:16px;
      background:var(--surface);border:2px solid var(--border);margin-bottom:20px;}
    .id-avatar{width:44px;height:44px;background:var(--surface-elevated);
      border:2px solid var(--border);display:flex;align-items:center;justify-content:center;
      font-size:16px;font-weight:900;color:var(--cyan);flex-shrink:0;text-transform:uppercase;}
    .id-preview-name{font-size:14px;font-weight:800;color:var(--text);}
    .id-preview-badge{font-size:9px;font-weight:800;letter-spacing:.1em;
      padding:3px 8px;border:1px solid;text-transform:uppercase;margin-top:4px;display:inline-block;}
    .id-preview-badge.alias{color:var(--purple);border-color:rgba(188,140,255,.3);background:var(--purple-dim);}
    .id-preview-badge.real{color:var(--cyan);border-color:rgba(0,240,255,.3);background:var(--cyan-dim);}

    .id-enter-btn{width:100%;background:var(--accent);color:#000;border:none;
      padding:16px;font-size:13px;font-weight:800;text-transform:uppercase;
      letter-spacing:.1em;cursor:pointer;transition:all .2s;}
    .id-enter-btn:hover{background:#ff6a1f;}
    .id-enter-btn:disabled{background:var(--surface-elevated);color:var(--text3);cursor:not-allowed;}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCREEN 4 â€” ROOM
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #s-room{padding-bottom:64px;}

    .room-header{background:var(--bg);border-bottom:2px solid var(--border);
      padding:0 12px;height:52px;display:flex;align-items:center;
      justify-content:space-between;gap:8px;flex-shrink:0;}
    .room-back{font-size:18px;color:var(--text3);cursor:pointer;
      width:36px;height:36px;display:flex;align-items:center;justify-content:center;
      border:2px solid var(--border);transition:all .2s;flex-shrink:0;}
    .room-back:hover{border-color:var(--accent);color:var(--accent);}

    .room-id-pill{display:flex;align-items:center;gap:8px;padding:6px 12px;
      background:var(--surface);border:1px solid var(--border);cursor:pointer;
      transition:all .2s;min-width:0;flex:1;max-width:200px;}
    .room-id-pill:hover{border-color:var(--text2);}
    .rid-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
    .rid-dot.alias{background:var(--purple);}
    .rid-dot.real{background:var(--cyan);}
    .rid-name{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.05em;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .rid-edit{font-size:11px;color:var(--text3);flex-shrink:0;}

    .room-btns{display:flex;gap:6px;flex-shrink:0;}
    .room-btn{font-size:10px;font-weight:800;letter-spacing:.08em;text-transform:uppercase;
      padding:6px 10px;border:1px solid;cursor:pointer;transition:all .2s;background:none;}
    .room-btn.gk{color:var(--purple);border-color:rgba(188,140,255,.3);}
    .room-btn.gk:hover{background:var(--purple-dim);}
    .room-btn.danger{color:var(--red);border-color:rgba(255,0,110,.3);}
    .room-btn.danger:hover{background:rgba(255,0,110,.08);}

    .room-infobar{background:var(--surface);border-bottom:1px solid var(--border2);
      padding:8px 12px;display:flex;align-items:center;gap:10px;flex-shrink:0;}
    .room-uni-badge{font-size:10px;font-weight:800;letter-spacing:.1em;padding:3px 8px;
      border:1px solid var(--cyan);color:var(--cyan);background:var(--cyan-dim);text-transform:uppercase;}
    .room-topic-text{font-size:12px;font-weight:600;color:var(--text2);flex:1;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .room-ephemeral-dot{display:flex;align-items:center;gap:5px;
      font-size:9px;font-weight:800;letter-spacing:.1em;color:var(--green);text-transform:uppercase;}
    .eph-dot{width:5px;height:5px;border-radius:50%;background:var(--green);
      animation:pulse 2s ease-in-out infinite;}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

    /* messages */
    .messages-wrap{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:0;}

    .sys-msg{text-align:center;font-size:11px;font-weight:700;letter-spacing:.08em;
      color:var(--text3);padding:12px 0;text-transform:uppercase;border-bottom:1px dashed var(--border2);}

    .day-divider{text-align:center;font-size:10px;font-weight:800;letter-spacing:.1em;
      color:var(--text3);padding:16px 0 8px;text-transform:uppercase;}

    .msg-item{margin-bottom:2px;padding:10px 12px;position:relative;}
    .msg-item.own{background:rgba(255,77,0,0.04);}
    .msg-item:hover{background:var(--surface);}

    .msg-top{display:flex;align-items:center;gap:8px;margin-bottom:5px;}
    .msg-author{font-size:11px;font-weight:800;letter-spacing:.05em;text-transform:uppercase;}
    .msg-author.alias-name{color:var(--purple);}
    .msg-author.real-name{color:var(--cyan);}
    .msg-author.gk-name{color:var(--accent);}
    .msg-time{font-size:10px;font-weight:600;color:var(--text3);}
    .msg-expiry{font-size:9px;font-weight:800;letter-spacing:.05em;
      padding:2px 7px;border:1px solid rgba(57,255,20,.3);
      color:var(--green);background:var(--green-dim);}
    .msg-gk-badge{font-size:9px;font-weight:800;letter-spacing:.1em;
      padding:2px 7px;border:1px solid rgba(255,77,0,.3);
      color:var(--accent);background:var(--accent-dim);text-transform:uppercase;}

    .msg-text{font-size:14px;font-weight:500;line-height:1.6;color:var(--text);}

    .msg-timer-bar{height:2px;background:var(--border2);margin-top:8px;overflow:hidden;}
    .msg-timer-fill{height:100%;background:var(--green);transition:width .1s linear;}

    /* input */
    .room-input{background:var(--bg);border-top:2px solid var(--border);
      padding:10px 12px;flex-shrink:0;}
    .timer-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
    .timer-label{font-size:10px;font-weight:800;letter-spacing:.1em;
      color:var(--text3);text-transform:uppercase;white-space:nowrap;}
    .timer-select{background:var(--surface);border:1px solid var(--border);
      color:var(--text2);padding:4px 8px;font-family:var(--sans);font-size:11px;
      font-weight:700;outline:none;cursor:pointer;letter-spacing:.03em;}
    .timer-select:focus{border-color:var(--accent);}
    .msg-row{display:flex;gap:8px;align-items:flex-end;}
    .msg-ta{flex:1;background:var(--surface);border:2px solid var(--border);
      color:var(--text);padding:10px 14px;font-family:var(--sans);font-size:14px;
      font-weight:500;resize:none;min-height:42px;max-height:120px;
      outline:none;line-height:1.5;transition:border-color .15s;}
    .msg-ta:focus{border-color:var(--accent);}
    .msg-ta::placeholder{color:var(--text3);font-size:13px;}
    .msg-send{background:var(--accent);color:#000;border:none;
      width:42px;height:42px;font-size:16px;cursor:pointer;
      transition:all .15s;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
    .msg-send:hover{background:#ff6a1f;}
    .msg-send:disabled{background:var(--surface-elevated);cursor:not-allowed;}

    /* â”€â”€ GK PANEL â”€â”€ */
    .gk-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);
      z-index:200;align-items:flex-end;}
    .gk-overlay.active{display:flex;}
    .gk-sheet{width:100%;background:var(--surface);border-top:3px solid var(--purple);
      padding:24px 16px 40px;max-height:80dvh;overflow-y:auto;}
    .gk-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
    .gk-head-title{font-size:12px;font-weight:800;letter-spacing:.1em;
      color:var(--purple);text-transform:uppercase;}
    .gk-close{font-size:11px;font-weight:700;color:var(--text3);cursor:pointer;
      padding:4px 8px;border:1px solid var(--border);transition:all .15s;}
    .gk-close:hover{border-color:var(--text2);color:var(--text2);}
    .gk-section{margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--border2);}
    .gk-section:last-child{border-bottom:none;margin-bottom:0;}
    .gk-sec-label{font-size:9px;font-weight:800;letter-spacing:.15em;color:var(--text3);
      text-transform:uppercase;margin-bottom:10px;}
    .gk-inp{width:100%;background:var(--bg);border:1px solid var(--border);
      color:var(--text);padding:10px 14px;font-family:var(--sans);font-size:14px;
      font-weight:600;letter-spacing:.05em;outline:none;margin-bottom:8px;transition:border-color .15s;}
    .gk-inp:focus{border-color:var(--purple);}
    .gk-hint{font-size:11px;font-weight:600;color:var(--text3);margin-bottom:10px;line-height:1.5;}
    .gk-btn{padding:10px 18px;font-family:var(--sans);font-weight:800;font-size:11px;
      text-transform:uppercase;letter-spacing:.1em;cursor:pointer;transition:all .15s;border:1px solid;}
    .gk-btn.purple{background:var(--purple-dim);border-color:rgba(188,140,255,.3);color:var(--purple);}
    .gk-btn.purple:hover{background:rgba(188,140,255,.2);}
    .gk-btn.red{background:rgba(255,0,110,.08);border-color:rgba(255,0,110,.3);color:var(--red);}
    .gk-btn.red:hover{background:rgba(255,0,110,.15);}
    .gk-btn.cyan{background:var(--cyan-dim);border-color:rgba(0,240,255,.3);color:var(--cyan);}
    .gk-btn.cyan:hover{background:rgba(0,240,255,.15);}
    .timer-presets{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px;}
    .t-preset{padding:8px;background:var(--bg);border:1px solid var(--border);
      color:var(--text3);font-size:10px;font-weight:800;text-align:center;
      cursor:pointer;transition:all .15s;letter-spacing:.05em;text-transform:uppercase;}
    .t-preset:hover{border-color:var(--accent);color:var(--accent);}
    .t-preset.sel{border-color:var(--accent);color:var(--accent);background:var(--accent-dim);}

    /* â”€â”€ ID EDIT OVERLAY â”€â”€ */
    .id-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);
      z-index:200;align-items:center;justify-content:center;padding:16px;}
    .id-overlay.active{display:flex;}
    .id-edit-box{width:100%;max-width:380px;background:var(--surface);
      border:2px solid var(--border);border-top:3px solid var(--cyan);padding:24px 20px;}

    /* â”€â”€ BOTTOM NAV â”€â”€ */
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--surface);
      border-top:2px solid var(--border);z-index:100;}
    .nav-inner{max-width:480px;margin:0 auto;display:flex;
      justify-content:space-around;align-items:center;height:64px;}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:4px;height:100%;color:var(--text3);text-decoration:none;
      font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.05em;
      transition:all .2s;position:relative;}
    .nav-item::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);
      width:0;height:2px;background:var(--accent);transition:width .2s;}
    .nav-item:hover{color:var(--text2);}
    .nav-item.active{color:var(--accent);}
    .nav-item.active::before{width:100%;}
    .nav-icon{font-size:20px;line-height:1;}

    /* â”€â”€ TOAST â”€â”€ */
    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);
      background:var(--text);color:var(--bg);padding:10px 20px;
      font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:.05em;
      z-index:10000;opacity:0;transition:all .25s;pointer-events:none;
      border:2px solid var(--bg);box-shadow:3px 3px 0 var(--accent);}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

    @media(max-width:400px){
      .uni-grid{grid-template-columns:1fr;}
      .uni-code{font-size:24px;}
      .timer-presets{grid-template-columns:repeat(2,1fr);}
    }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 1 â€” PILIH UNIVERSITAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="s-select">
  <div class="g-header">
    <a class="back-btn" href="glitch-issue.html">â† Kembali</a>
    <div class="header-tag cyan">RUANG AMAN</div>
  </div>

  <div class="select-hero">
    <div class="select-eyebrow">
      <div class="eyebrow-line"></div>
      Komunitas Pilih Sendiri
      <div class="eyebrow-line"></div>
    </div>
    <div class="select-title">PILIH <em>RUANG</em><br>UNIVERSITASMU</div>
    <p class="select-desc">Tiap universitas punya ruang otonom. Jejak cuma nyediain infrastruktur â€” komunitasmu yang megang kendali.</p>
  </div>

  <div class="uni-grid">
    <div class="uni-card" onclick="selectUni('UI','Universitas Indonesia','Depok')">
      <div class="uni-code">UI</div>
      <div class="uni-name">Universitas Indonesia</div>
      <div class="uni-loc">Depok, Jawa Barat</div>
      <div class="uni-status active">Aktif</div>
    </div>
    <div class="uni-card" onclick="selectUni('UGM','Universitas Gadjah Mada','Yogyakarta')">
      <div class="uni-code">UGM</div>
      <div class="uni-name">Universitas Gadjah Mada</div>
      <div class="uni-loc">Yogyakarta, DIY</div>
      <div class="uni-status active">Aktif</div>
    </div>
    <div class="uni-card" onclick="selectUni('ITS','Institut Teknologi Sepuluh Nopember','Surabaya')">
      <div class="uni-code">ITS</div>
      <div class="uni-name">Institut Teknologi Sepuluh Nopember</div>
      <div class="uni-loc">Surabaya, Jawa Timur</div>
      <div class="uni-status active">Aktif</div>
    </div>
    <div class="uni-card" onclick="selectUni('IPB','Institut Pertanian Bogor','Bogor')">
      <div class="uni-code">IPB</div>
      <div class="uni-name">Institut Pertanian Bogor</div>
      <div class="uni-loc">Bogor, Jawa Barat</div>
      <div class="uni-status active">Aktif</div>
    </div>
  </div>

  <div class="select-note">
    <div class="select-note-title">ğŸ”‘ Sistem Gatekeeper</div>
    <p>PIN dipegang komunitas â€” bukan Jejak. Orang pertama yang masuk jadi gatekeeper dan bisa ganti PIN kapanpun. Platform hanya nyimpen hash-nya.</p>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 2 â€” PIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-pin">
  <div class="pin-box">
    <div class="pin-back" onclick="showScreen('select')">â† Pilih universitas lain</div>
    <div class="pin-room-tag" id="pinRoomTag">RUANG Â· UI</div>
    <div class="pin-title" id="pinTitle">Masuk ke Ruang UI</div>
    <p class="pin-sub">PIN dipegang gatekeeper komunitas lo. Jejak <strong>tidak menyimpan</strong> PIN aslinya â€” hanya hash-nya.</p>

    <div class="pin-wrap">
      <input type="password" class="pin-input" id="pinInput"
        placeholder="Masukkan PIN..." maxlength="30"
        oninput="validatePin()" onkeydown="if(event.key==='Enter')submitPin()"/>
      <span class="pin-toggle" onclick="togglePin()" id="pinToggleBtn">LIHAT</span>
    </div>
    <div class="pin-hint">Format bebas Â· case-sensitive Â· hanya diketahui komunitas lo</div>
    <div class="pin-error" id="pinError">PIN salah. Hubungi gatekeeper komunitas lo.</div>

    <button class="pin-submit" id="pinSubmitBtn" onclick="submitPin()" disabled>Gas Masuk â†’</button>

    <div class="pin-security">
      ğŸ”’ <strong>Cara kerjanya:</strong> PIN di-hash dengan SHA-256 sebelum dicek. Jejak tidak bisa melihat PIN aslinya. Gatekeeper bisa ganti PIN kapanpun tanpa izin platform.
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 3 â€” IDENTITY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-identity">
  <div class="id-box">
    <div class="id-title">Tampil Sebagai Siapa?</div>
    <p class="id-sub">Pilih cara lo keliatan di ruang ini. Bisa diganti kapanpun, santai aja.</p>

    <div class="id-toggle">
      <button class="id-toggle-btn active" id="btnAlias" onclick="setIdMode('alias')">ğŸ­ Pake Alias</button>
      <button class="id-toggle-btn" id="btnReal" onclick="setIdMode('real')">ğŸªª Nama Resmi</button>
    </div>

    <div id="aliasMode">
      <div class="id-label">Pilih dari pool komunitas</div>
      <div class="alias-pool" id="aliasPool"></div>
      <div class="id-label">Atau ketik sendiri</div>
      <input type="text" class="id-input" id="customAlias"
        placeholder="alias.lo" maxlength="24"
        oninput="onAliasInput()"/>
      <div class="id-hint">Tidak terhubung ke identitas asli lo sama sekali.</div>
    </div>

    <div id="realMode" style="display:none">
      <div class="id-label">Nama atau posisi resmi</div>
      <input type="text" class="id-input" id="realName"
        placeholder="cth: Ketua BEM UI 2025" maxlength="40"
        oninput="onRealInput()"/>
      <div class="id-hint">Untuk pernyataan resmi dalam diskusi. Pastikan sesuai posisi lo.</div>
    </div>

    <div class="id-preview">
      <div class="id-avatar" id="idAvatar">??</div>
      <div>
        <div class="id-preview-name" id="idPreviewName">Pilih identitas dulu</div>
        <span class="id-preview-badge alias" id="idPreviewBadge">ALIAS</span>
      </div>
    </div>

    <button class="id-enter-btn" id="idEnterBtn" onclick="enterRoom()" disabled>Masuk ke Ruang â†’</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 4 â€” ROOM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-room">

  <div class="room-header">
    <div class="room-back" onclick="leaveRoom()">â†</div>
    <div class="room-id-pill" onclick="openIdEdit()" title="Klik untuk ganti identitas">
      <div class="rid-dot alias" id="ridDot"></div>
      <span class="rid-name" id="ridName">â€”</span>
      <span class="rid-edit">âœ</span>
    </div>
    <div class="room-btns">
      <button class="room-btn gk" id="gkBtn" onclick="openGKPanel()" style="display:none">GK</button>
      <button class="room-btn danger" onclick="leaveRoom()">Keluar</button>
    </div>
  </div>

  <div class="room-infobar">
    <span class="room-uni-badge" id="roomUniBadge">UI</span>
    <span class="room-topic-text" id="roomTopicText">Diskusi Isu MBG Â· Ruang Aman</span>
    <div class="room-ephemeral-dot">
      <div class="eph-dot"></div>
      <span>LIVE</span>
    </div>
  </div>

  <div class="messages-wrap" id="messagesWrap">
    <div class="sys-msg">â€” Ruang dibuka Â· pesan ephemeral Â· tidak ada log permanen â€”</div>
  </div>

  <div class="room-input">
    <div class="timer-row">
      <span class="timer-label">Hilang setelah:</span>
      <select class="timer-select" id="msgTimer">
        <option value="60">1 menit</option>
        <option value="3600" selected>1 jam</option>
        <option value="21600">6 jam</option>
        <option value="86400">24 jam</option>
        <option value="259200">72 jam</option>
        <option value="0">Permanen</option>
      </select>
    </div>
    <div class="msg-row">
      <textarea class="msg-ta" id="msgInput"
        placeholder="Spill aja... cuma yang ada di ruang ini yang baca"
        maxlength="1000" rows="1"
        oninput="autoTa(this);validateMsg()"
        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMsg()}"></textarea>
      <button class="msg-send" id="msgSendBtn" onclick="sendMsg()" disabled>â†‘</button>
    </div>
  </div>
</div>

<!-- â”€â”€ GK PANEL â”€â”€ -->
<div class="gk-overlay" id="gkOverlay">
  <div class="gk-sheet">
    <div class="gk-head">
      <div class="gk-head-title">ğŸ”‘ Panel Gatekeeper</div>
      <div class="gk-close" onclick="closeGKPanel()">âœ• Tutup</div>
    </div>
    <div class="gk-section">
      <div class="gk-sec-label">Ganti PIN Ruangan</div>
      <input type="password" class="gk-inp" id="newPin" placeholder="PIN baru..." maxlength="30"/>
      <input type="password" class="gk-inp" id="confirmPin" placeholder="Konfirmasi PIN baru..." maxlength="30"/>
      <div class="gk-hint">PIN baru langsung aktif. Kabarin anggota lewat jalur lain.</div>
      <button class="gk-btn purple" onclick="changePin()">Ganti PIN Sekarang</button>
    </div>
    <div class="gk-section">
      <div class="gk-sec-label">Timer Default Ruangan</div>
      <div class="timer-presets">
        <div class="t-preset" data-v="3600" onclick="setRoomTimer(this)">1 JAM</div>
        <div class="t-preset" data-v="21600" onclick="setRoomTimer(this)">6 JAM</div>
        <div class="t-preset sel" data-v="86400" onclick="setRoomTimer(this)">24 JAM</div>
        <div class="t-preset" data-v="259200" onclick="setRoomTimer(this)">72 JAM</div>
      </div>
      <div class="gk-hint">Member tetap bisa pilih timer beda per pesan.</div>
    </div>
    <div class="gk-section">
      <div class="gk-sec-label">Topik Diskusi Aktif</div>
      <input type="text" class="gk-inp" id="topicInput"
        placeholder="cth: MBG â€” Bedah Skema Tunai" maxlength="60"
        style="letter-spacing:0;font-size:14px;font-weight:500;"/>
      <button class="gk-btn cyan" onclick="updateTopic()" style="margin-top:8px;">Update Topik</button>
    </div>
    <div class="gk-section">
      <div class="gk-sec-label">Aksi Darurat</div>
      <div class="gk-hint">Hapus semua pesan dari tampilan lokal sekarang.</div>
      <button class="gk-btn red" onclick="clearAllMsgs()">Hapus Semua Pesan</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ID EDIT OVERLAY â”€â”€ -->
<div class="id-overlay" id="idOverlay">
  <div class="id-edit-box">
    <div style="font-size:10px;font-weight:800;letter-spacing:.15em;color:var(--text3);text-transform:uppercase;margin-bottom:16px;">Ganti Tampilan Lo</div>
    <div class="id-toggle" style="margin-bottom:16px;">
      <button class="id-toggle-btn active" id="editBtnAlias" onclick="setEditMode('alias')">ğŸ­ Alias</button>
      <button class="id-toggle-btn" id="editBtnReal" onclick="setEditMode('real')">ğŸªª Resmi</button>
    </div>
    <input type="text" class="id-input" id="editNameInput" placeholder="Alias atau nama lo..." maxlength="40" oninput="validateEditName()"/>
    <div style="font-size:11px;font-weight:600;color:var(--text3);margin-bottom:20px;line-height:1.5;">Identitas baru berlaku untuk pesan selanjutnya. Pesan lama tetap pakai identitas sebelumnya.</div>
    <div style="display:flex;gap:8px;">
      <button class="gk-btn red" style="flex:1" onclick="closeIdEdit()">Batal</button>
      <button class="gk-btn cyan" style="flex:2" id="saveIdBtn" onclick="saveIdentity()" disabled>Simpan</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- â”€â”€ BOTTOM NAV â”€â”€ -->
<nav class="bottom-nav" id="bottomNav">
  <div class="nav-inner">
    <a href="jejak.html" class="nav-item"><span class="nav-icon">âœ¦</span><span>Jejak</span></a>
    <a href="cocomeo.html" class="nav-item"><span class="nav-icon">ã€œ</span><span>Cocomeo</span></a>
    <a href="saynope.html" class="nav-item"><span class="nav-icon">âœ•</span><span>Spill</span></a>
    <a href="glitch.html" class="nav-item active"><span class="nav-icon">âš¡</span><span>Glitch</span></a>
  </div>
</nav>

<script>
// â”€â”€â”€ CRYPTO â”€â”€â”€
async function hashPin(pin) {
  const data = new TextEncoder().encode('JEJAK_SALT_' + pin + '_RUANG');
  const buf = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

// â”€â”€â”€ STATE â”€â”€â”€
const st = {
  uni: null,
  isGK: false,
  idMode: 'alias',
  displayName: '',
  messages: [],
  roomTimer: 86400,
  topic: 'Diskusi Isu MBG Â· Ruang Aman',
  editMode: 'alias',
};

const ALIAS_POOL = [
  'api.gelap','nalar.bebas','suara.senyap','data.jujur',
  'angin.laut','akar.kuat','kabut.tipis','ombak.besar',
  'batu.karang','langit.merah','bara.api','embun.pagi',
  'tanah.subur','mega.putih','hutan.lebat','sungai.deras'
];

const SEED_MSGS = [
  {name:'coordinator',mode:'gk',text:'Ruang ini dibuka untuk diskusi internal MBG. Semua pesan ephemeral â€” tidak ada log permanen. Gatekeeper bisa dihubungi kalau ada masalah teknis.',timer:86400},
  {name:'nalar.bebas',mode:'alias',text:'Guys coba baca dulu data di glitch-issue.html sebelum spill di sini. Biar diskusinya nyambung sama fakta yang ada.',timer:21600},
  {name:'data.jujur',mode:'alias',text:'Q-01 yang paling menarik menurut gue: overhead 21% itu actually ke mana? Kalau ke rekanan berarti mereka yang perlu diaudit, bukan systemnya.',timer:3600},
];

// â”€â”€â”€ NAVIGATION â”€â”€â”€
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('s-' + id).classList.add('active');
  // hide bottom nav in room
  document.getElementById('bottomNav').style.display = id === 'room' ? 'none' : '';
}

// â”€â”€â”€ SCREEN 1: SELECT UNI â”€â”€â”€
function selectUni(code, name, loc) {
  st.uni = {code, name, loc};
  document.getElementById('pinRoomTag').textContent = 'RUANG Â· ' + code;
  document.getElementById('pinTitle').textContent = 'Masuk ke Ruang ' + code;
  showScreen('pin');
  setTimeout(() => document.getElementById('pinInput').focus(), 100);
}

// â”€â”€â”€ SCREEN 2: PIN â”€â”€â”€
function togglePin() {
  const inp = document.getElementById('pinInput');
  const btn = document.getElementById('pinToggleBtn');
  if (inp.type === 'password') { inp.type = 'text'; btn.textContent = 'SEMBUNYIKAN'; }
  else { inp.type = 'password'; btn.textContent = 'LIHAT'; }
}

function validatePin() {
  document.getElementById('pinSubmitBtn').disabled = document.getElementById('pinInput').value.length < 1;
  document.getElementById('pinError').classList.remove('show');
}

async function submitPin() {
  const pin = document.getElementById('pinInput').value;
  if (!pin) return;
  const hash = await hashPin(pin);
  const key = 'jejak_pin_' + st.uni.code;
  const stored = localStorage.getItem(key);

  if (!stored) {
    // First person â€” becomes gatekeeper
    localStorage.setItem(key, hash);
    st.isGK = true;
    toast('Lo jadi Gatekeeper ruang ' + st.uni.code + ' ğŸ”‘');
    loadIdentityScreen();
    showScreen('identity');
  } else if (stored === hash) {
    st.isGK = false;
    loadIdentityScreen();
    showScreen('identity');
  } else {
    document.getElementById('pinError').classList.add('show');
  }
}

// â”€â”€â”€ SCREEN 3: IDENTITY â”€â”€â”€
function loadIdentityScreen() {
  // pre-fill from nope_username
  const nopeUser = localStorage.getItem('nope_username');
  const pool = document.getElementById('aliasPool');
  pool.innerHTML = '';
  ALIAS_POOL.forEach(alias => {
    const chip = document.createElement('div');
    chip.className = 'alias-chip';
    chip.textContent = alias;
    chip.onclick = () => selectAlias(chip, alias);
    pool.appendChild(chip);
  });
  if (nopeUser) {
    document.getElementById('customAlias').value = nopeUser;
    updatePreview(nopeUser, 'alias');
    document.getElementById('idEnterBtn').disabled = false;
  }
}

function setIdMode(mode) {
  st.idMode = mode;
  document.getElementById('aliasMode').style.display = mode === 'alias' ? 'block' : 'none';
  document.getElementById('realMode').style.display = mode === 'real' ? 'block' : 'none';
  document.getElementById('btnAlias').classList.toggle('active', mode === 'alias');
  document.getElementById('btnReal').classList.toggle('active', mode === 'real');
  updatePreview('', mode);
  document.getElementById('idEnterBtn').disabled = true;
}

function selectAlias(chip, alias) {
  document.querySelectorAll('.alias-chip').forEach(c => c.classList.remove('selected'));
  chip.classList.add('selected');
  document.getElementById('customAlias').value = alias;
  updatePreview(alias, 'alias');
  document.getElementById('idEnterBtn').disabled = false;
}

function onAliasInput() {
  const val = document.getElementById('customAlias').value.trim();
  document.querySelectorAll('.alias-chip').forEach(c => c.classList.remove('selected'));
  updatePreview(val, 'alias');
  document.getElementById('idEnterBtn').disabled = val.length < 2;
}

function onRealInput() {
  const val = document.getElementById('realName').value.trim();
  updatePreview(val, 'real');
  document.getElementById('idEnterBtn').disabled = val.length < 2;
}

function updatePreview(name, mode) {
  const avatar = document.getElementById('idAvatar');
  const pName = document.getElementById('idPreviewName');
  const pBadge = document.getElementById('idPreviewBadge');
  if (name && name.length >= 2) {
    avatar.textContent = name.slice(0,2).toUpperCase();
    pName.textContent = name;
    pBadge.textContent = mode === 'alias' ? 'ALIAS' : 'RESMI';
    pBadge.className = 'id-preview-badge ' + (mode === 'alias' ? 'alias' : 'real');
  } else {
    avatar.textContent = '??';
    pName.textContent = 'Pilih identitas dulu';
  }
}

function enterRoom() {
  const name = st.idMode === 'alias'
    ? document.getElementById('customAlias').value.trim()
    : document.getElementById('realName').value.trim();
  if (name.length < 2) return;

  st.displayName = name;
  // If logged in with nope_username, save alias too
  const nopeUser = localStorage.getItem('nope_username');
  if (!nopeUser && st.idMode === 'alias') {
    localStorage.setItem('nope_username', name);
  }

  setupRoom();
  showScreen('room');
}

// â”€â”€â”€ SCREEN 4: ROOM â”€â”€â”€
function setupRoom() {
  document.getElementById('roomUniBadge').textContent = st.uni.code;
  document.getElementById('roomTopicText').textContent = st.topic;
  document.getElementById('ridName').textContent = st.displayName;
  document.getElementById('ridDot').className = 'rid-dot ' + (st.idMode === 'alias' ? 'alias' : 'real');
  document.getElementById('gkBtn').style.display = st.isGK ? 'block' : 'none';

  // Load messages
  const key = 'jejak_msgs_' + st.uni.code;
  const saved = localStorage.getItem(key);
  if (saved) {
    st.messages = JSON.parse(saved);
  } else {
    // Seed
    const now = Date.now();
    st.messages = SEED_MSGS.map((m, i) => ({
      id: 'seed_' + i,
      name: m.name,
      mode: m.mode,
      text: m.text,
      time: now - (SEED_MSGS.length - i) * 900000,
      timerSec: m.timer,
      expireAt: m.timer > 0 ? now - (SEED_MSGS.length - i) * 900000 + m.timer * 1000 : 0
    }));
    saveMessages();
  }
  renderMessages();
  startExpiryCheck();
}

function saveMessages() {
  localStorage.setItem('jejak_msgs_' + st.uni.code, JSON.stringify(st.messages));
}

function renderMessages() {
  const wrap = document.getElementById('messagesWrap');
  const now = Date.now();
  wrap.innerHTML = '<div class="sys-msg">â€” Ruang dibuka Â· pesan ephemeral Â· tidak ada log permanen â€”</div>';

  st.messages.forEach(msg => {
    if (msg.expireAt > 0 && now > msg.expireAt) return;
    const el = document.createElement('div');
    el.className = 'msg-item' + (msg.name === st.displayName ? ' own' : '');
    el.dataset.id = msg.id;

    const timeStr = new Date(msg.time).toLocaleTimeString('id-ID', {hour:'2-digit',minute:'2-digit'});
    const expiryStr = msg.timerSec > 0 ? formatExpiry(msg.expireAt - now) : '';
    const gkBadge = msg.mode === 'gk' ? '<span class="msg-gk-badge">GK</span>' : '';
    const expiryBadge = expiryStr ? `<span class="msg-expiry">â± ${expiryStr}</span>` : '';
    const authorClass = msg.mode === 'gk' ? 'gk-name' : msg.mode === 'real' ? 'real-name' : 'alias-name';

    const fillPct = msg.expireAt > 0
      ? Math.max(0, Math.min(100, ((msg.expireAt - now) / (msg.timerSec * 1000)) * 100))
      : 100;

    el.innerHTML = `
      <div class="msg-top">
        <span class="msg-author ${authorClass}">${esc(msg.name)}</span>
        ${gkBadge}
        <span class="msg-time">${timeStr}</span>
        ${expiryBadge}
      </div>
      <div class="msg-text">${esc(msg.text)}</div>
      ${msg.timerSec > 0 ? `<div class="msg-timer-bar"><div class="msg-timer-fill" style="width:${fillPct}%"></div></div>` : ''}
    `;
    wrap.appendChild(el);
  });
  wrap.scrollTop = wrap.scrollHeight;
}

function formatExpiry(ms) {
  if (ms <= 0) return 'habis';
  const s = Math.floor(ms / 1000);
  if (s < 60) return s + 'd';
  const m = Math.floor(s / 60);
  if (m < 60) return m + 'm';
  const h = Math.floor(m / 60);
  if (h < 24) return h + 'j';
  return Math.floor(h / 24) + 'h';
}

function startExpiryCheck() {
  setInterval(() => {
    const now = Date.now();
    let changed = false;
    st.messages = st.messages.filter(m => {
      if (m.expireAt > 0 && now > m.expireAt) { changed = true; return false; }
      return true;
    });
    if (changed) { saveMessages(); renderMessages(); }
  }, 15000);
}

function sendMsg() {
  const text = document.getElementById('msgInput').value.trim();
  if (!text) return;
  const timerSec = parseInt(document.getElementById('msgTimer').value);
  const now = Date.now();

  const msg = {
    id: 'msg_' + now + '_' + Math.random().toString(36).slice(2,6),
    name: st.displayName,
    mode: st.isGK ? 'gk' : st.idMode,
    text,
    time: now,
    timerSec,
    expireAt: timerSec > 0 ? now + timerSec * 1000 : 0
  };

  st.messages.push(msg);
  saveMessages();
  renderMessages();

  document.getElementById('msgInput').value = '';
  validateMsg();
  autoTa(document.getElementById('msgInput'));
}

function validateMsg() {
  document.getElementById('msgSendBtn').disabled =
    document.getElementById('msgInput').value.trim().length < 1;
}

function leaveRoom() {
  if (confirm('Keluar dari ruang?')) {
    showScreen('select');
    document.getElementById('messagesWrap').innerHTML = '';
    st.messages = [];
    st.isGK = false;
  }
}

// â”€â”€â”€ GK PANEL â”€â”€â”€
function openGKPanel() { document.getElementById('gkOverlay').classList.add('active'); }
function closeGKPanel() { document.getElementById('gkOverlay').classList.remove('active'); }

async function changePin() {
  const np = document.getElementById('newPin').value;
  const cp = document.getElementById('confirmPin').value;
  if (!np || np !== cp) { toast('PIN tidak cocok!'); return; }
  const hash = await hashPin(np);
  localStorage.setItem('jejak_pin_' + st.uni.code, hash);
  document.getElementById('newPin').value = '';
  document.getElementById('confirmPin').value = '';
  closeGKPanel();
  toast('PIN berhasil diganti ğŸ”‘');
}

function setRoomTimer(el) {
  document.querySelectorAll('.t-preset').forEach(e => e.classList.remove('sel'));
  el.classList.add('sel');
  st.roomTimer = parseInt(el.dataset.v);
  document.getElementById('msgTimer').value = st.roomTimer;
  toast('Timer default: ' + el.textContent);
}

function updateTopic() {
  const val = document.getElementById('topicInput').value.trim();
  if (!val) return;
  st.topic = val;
  document.getElementById('roomTopicText').textContent = val;
  closeGKPanel();
  toast('Topik diupdate âœ“');
}

function clearAllMsgs() {
  if (!confirm('Hapus semua pesan sekarang?')) return;
  st.messages = [];
  saveMessages();
  renderMessages();
  closeGKPanel();
  toast('Semua pesan dihapus');
}

// â”€â”€â”€ ID EDIT OVERLAY â”€â”€â”€
function openIdEdit() {
  document.getElementById('editNameInput').value = st.displayName;
  document.getElementById('idOverlay').classList.add('active');
  setEditMode(st.idMode);
  document.getElementById('saveIdBtn').disabled = false;
}

function closeIdEdit() { document.getElementById('idOverlay').classList.remove('active'); }

function setEditMode(mode) {
  st.editMode = mode;
  document.getElementById('editBtnAlias').classList.toggle('active', mode === 'alias');
  document.getElementById('editBtnReal').classList.toggle('active', mode === 'real');
}

function validateEditName() {
  document.getElementById('saveIdBtn').disabled =
    document.getElementById('editNameInput').value.trim().length < 2;
}

function saveIdentity() {
  const name = document.getElementById('editNameInput').value.trim();
  if (name.length < 2) return;
  st.displayName = name;
  st.idMode = st.editMode;
  document.getElementById('ridName').textContent = name;
  document.getElementById('ridDot').className = 'rid-dot ' + (st.idMode === 'alias' ? 'alias' : 'real');
  closeIdEdit();
  toast('Identitas diganti âœ“');
}

// â”€â”€â”€ UTILS â”€â”€â”€
function autoTa(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function esc(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

let _toastTimer;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => el.classList.remove('show'), 2500);
}
</script>
</body>
</html>
