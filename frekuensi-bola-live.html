<!DOCTYPE html>
<html lang="id" data-theme="glitch">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NOPE ‚Äî Bola Live</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23ff9999'/%3E%3Ctext x='50' y='70' font-size='60' font-weight='bold' font-family='system-ui' text-anchor='middle' fill='%23000'%3ENO%3C/text%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,300;0,400;0,500;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="frekuensi-shared.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .live-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .match-header { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; }
    .match-teams { display: flex; align-items: center; gap: 20px; flex: 1; }
    .team { display: flex; align-items: center; gap: 12px; }
    .team-logo { width: 48px; height: 48px; background: var(--surface-elevated); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; border: 2px solid var(--border); }
    .team-name { font-size: 18px; font-weight: 600; color: var(--text); }
    .vs { font-size: 14px; color: var(--muted); font-weight: 500; padding: 8px 16px; background: rgba(178, 102, 255, 0.1); border-radius: 20px; border: 1px solid var(--accent); }
    .match-info { text-align: right; }
    .live-badge { display: inline-flex; align-items: center; gap: 6px; background: #ff4444; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .live-badge::before { content: ''; width: 8px; height: 8px; background: white; border-radius: 50%; animation: blink 1s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    .match-time { font-size: 24px; font-weight: 700; color: var(--accent); margin-top: 8px; font-family: 'JetBrains Mono', monospace; }
    .main-layout { display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
    @media (max-width: 1024px) { .main-layout { grid-template-columns: 1fr; } }
    .video-section { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .video-container { position: relative; padding-bottom: 56.25%; height: 0; background: #000; }
    .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
    .stats-bar { display: flex; align-items: center; justify-content: space-around; padding: 16px; background: var(--surface-elevated); border-top: 1px solid var(--border); font-size: 13px; }
    .stat-item { text-align: center; }
    .stat-value { font-size: 20px; font-weight: 700; color: var(--accent); font-family: 'JetBrains Mono', monospace; }
    .stat-label { color: var(--muted); margin-top: 4px; }
    .sidebar { display: flex; flex-direction: column; gap: 16px; }
    .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .panel-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .panel-title { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .panel-content { padding: 16px; }
    .current-prediction { background: linear-gradient(135deg, rgba(178, 102, 255, 0.1), rgba(255, 153, 153, 0.1)); border: 1px solid var(--accent); border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    .pred-question { font-size: 14px; font-weight: 500; margin-bottom: 12px; line-height: 1.5; }
    .pred-timer-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; margin-bottom: 12px; }
    .pred-timer-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #ff9999); transition: width 1s linear; }
    .pred-options-vertical { display: flex; flex-direction: column; gap: 8px; }
    .pred-option-btn { display: flex; align-items: center; justify-content: space-between; padding: 14px 18px; background: var(--surface-elevated); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: left; width: 100%; color: var(--text); font-family: 'JetBrains Mono', monospace; font-size: 13px; }
    .pred-option-btn:hover:not(:disabled) { border-color: var(--accent); background: rgba(178, 102, 255, 0.15); transform: translateX(4px); }
    .pred-option-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .pred-option-btn.voted { border-color: var(--accent); background: rgba(178, 102, 255, 0.25); }
    .pred-option-btn.correct { border-color: #4ade80; background: rgba(74, 222, 128, 0.2); }
    .pred-percentage { font-weight: 700; color: var(--accent); font-size: 14px; }
    .pred-results { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
    .result-bar { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-size: 12px; }
    .result-label { width: 80px; color: var(--muted); }
    .result-track { flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
    .result-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #ff9999); border-radius: 4px; transition: width 0.5s; }
    .result-count { width: 50px; text-align: right; color: var(--muted); font-family: 'JetBrains Mono', monospace; }
    .poll-item { padding: 14px; background: var(--surface-elevated); border-radius: 10px; border: 1px solid var(--border); margin-bottom: 12px; }
    .poll-question { font-size: 13px; font-weight: 500; margin-bottom: 12px; }
    .poll-options { display: flex; flex-wrap: wrap; gap: 8px; }
    .poll-btn { padding: 8px 16px; background: transparent; border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 12px; cursor: pointer; transition: all 0.2s; font-family: 'JetBrains Mono', monospace; }
    .poll-btn:hover { border-color: var(--accent); color: var(--accent); }
    .poll-btn.selected { background: var(--accent); color: #000; border-color: var(--accent); }
    .leaderboard-list { display: flex; flex-direction: column; gap: 8px; }
    .leader-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--surface-elevated); border-radius: 10px; font-size: 13px; transition: all 0.2s; }
    .leader-item:hover { background: rgba(178, 102, 255, 0.08); transform: translateX(4px); }
    .leader-item.you { border: 1px solid var(--accent); background: rgba(178, 102, 255, 0.15); }
    .leader-rank { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--border); border-radius: 50%; font-weight: 700; font-size: 12px; font-family: 'JetBrains Mono', monospace; }
    .leader-rank.top { background: linear-gradient(135deg, var(--accent), #ff9999); color: #000; }
    .leader-name { flex: 1; font-weight: 600; }
    .leader-points { font-weight: 700; color: var(--accent); font-family: 'JetBrains Mono', monospace; font-size: 14px; }
    .chat-messages { height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; margin-bottom: 12px; padding-right: 8px; }
    .chat-message { padding: 10px 14px; background: var(--surface-elevated); border-radius: 12px; font-size: 13px; line-height: 1.4; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .chat-user { font-weight: 700; color: var(--accent); margin-right: 6px; }
    .chat-user.system { color: #ff9999; }
    .chat-input-area { display: flex; gap: 10px; }
    .chat-input { flex: 1; padding: 12px 16px; background: var(--surface-elevated); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 13px; font-family: 'JetBrains Mono', monospace; }
    .chat-input:focus { outline: none; border-color: var(--accent); }
    .chat-send { padding: 12px 20px; background: var(--accent); color: #000; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-family: 'JetBrains Mono', monospace; }
    .chat-send:disabled { opacity: 0.5; cursor: not-allowed; }
    .user-mini { display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--surface-elevated); border-radius: 12px; }
    .user-avatar { width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent), #ff9999); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; color: #000; font-size: 18px; }
    .user-info { flex: 1; }
    .user-name { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
    .user-points { font-size: 13px; color: var(--muted); }
    .user-badge { padding: 6px 14px; background: rgba(178, 102, 255, 0.2); border-radius: 20px; font-size: 11px; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 0.5px; }
    .connection-status { position: fixed; top: 20px; left: 20px; padding: 10px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; font-size: 12px; display: flex; align-items: center; gap: 8px; z-index: 1000; transition: all 0.3s; }
    .connection-status.online { border-color: #4ade80; color: #4ade80; }
    .connection-status.offline { border-color: #ef4444; color: #ef4444; }
    .connection-status.connecting { border-color: #fbbf24; color: #fbbf24; }
    .notification { position: fixed; top: 20px; right: 20px; background: var(--surface); border: 1px solid var(--accent); border-radius: 12px; padding: 18px 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); transform: translateX(400px); transition: transform 0.3s; z-index: 1000; max-width: 340px; }
    .notification.show { transform: translateX(0); }
    .notification-title { font-weight: 700; margin-bottom: 6px; color: var(--accent); font-size: 15px; }
    .notification-text { font-size: 13px; color: var(--text-secondary); line-height: 1.5; }
    .back-btn { display: inline-flex; align-items: center; gap: 8px; margin-bottom: 16px; color: var(--muted); text-decoration: none; font-size: 14px; transition: all 0.2s; }
    .back-btn:hover { color: var(--accent); transform: translateX(-4px); }
    .skeleton { background: linear-gradient(90deg, var(--surface-elevated) 25%, var(--border) 50%, var(--surface-elevated) 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 4px; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>
<body>
  <div class="connection-status connecting" id="connection-status">
    <span>üü°</span><span>Connecting...</span>
  </div>

  <div class="wrapper">
    <header>
      <div class="logo" onclick="window.location.href='index.html'">NOPE</div>
      <div class="top-right">
        <div class="nav-mini">
          <span onclick="window.location.href='jejak.html'">Jurnal</span>
          <span class="active">Frekuensi</span>
          <span onclick="window.location.href='saynope.html'">SayNOPE</span>
          <span onclick="window.location.href='glitch.html'">GLITCH</span>
        </div>
        <button class="settings-btn" id="settings-btn">‚ãØ</button>
      </div>
    </header>

    <div class="live-container">
      <a href="frekuensi-bola.html" class="back-btn">‚Üê Kembali ke Menu Bola</a>
      
      <!-- Match Header -->
      <div class="match-header">
        <div class="match-teams">
          <div class="team">
            <div class="team-logo">üî¥</div>
            <div class="team-name">Tim Merah</div>
          </div>
          <div class="vs">VS</div>
          <div class="team">
            <div class="team-logo">üîµ</div>
            <div class="team-name">Tim Biru</div>
          </div>
        </div>
        <div class="match-info">
          <div class="live-badge">LIVE</div>
          <div class="match-time" id="match-time">--:--</div>
        </div>
      </div>

      <!-- Main Layout -->
      <div class="main-layout">
        <!-- Video Section -->
        <div class="video-section">
          <div class="video-container">
            <iframe id="youtube-player" src="https://www.youtube.com/embed/36YnV9STBqc?autoplay=1&mute=1" allowfullscreen></iframe>
          </div>
          <div class="stats-bar">
            <div class="stat-item">
              <div class="stat-value" id="stat-possession">--</div>
              <div class="stat-label">Possession</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-shots">--</div>
              <div class="stat-label">Shots</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-corners">--</div>
              <div class="stat-label">Corners</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-predictions">--</div>
              <div class="stat-label">Prediksi</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-online">--</div>
              <div class="stat-label">Online</div>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
          <!-- User Profile -->
          <div class="panel">
            <div class="panel-content">
              <div class="user-mini">
                <div class="user-avatar" id="user-avatar">?</div>
                <div class="user-info">
                  <div class="user-name" id="user-name">Loading...</div>
                  <div class="user-points" id="user-points">0 XP</div>
                </div>
                <div class="user-badge" id="user-badge">NEW</div>
              </div>
            </div>
          </div>

          <!-- Live Prediction -->
          <div class="panel">
            <div class="panel-header">
              <div class="panel-title"><span>‚ö°</span> Prediksi Live</div>
              <span style="font-size: 12px; color: var(--muted);" id="pred-round">--</span>
            </div>
            <div class="panel-content">
              <div class="current-prediction" id="prediction-box">
                <div class="pred-question" id="pred-question">Memuat prediksi...</div>
                <div class="pred-timer-bar">
                  <div class="pred-timer-fill" id="pred-timer-bar" style="width: 100%"></div>
                </div>
                <div class="pred-options-vertical" id="pred-options">
                  <div class="skeleton" style="height: 44px; margin-bottom: 8px;"></div>
                  <div class="skeleton" style="height: 44px;"></div>
                </div>
                <div class="pred-results" id="pred-results" style="display: none;"></div>
              </div>
              <div style="font-size: 12px; color: var(--muted); text-align: center; margin-top: 12px;">
                <span id="next-prediction">Menghitung...</span>
              </div>
            </div>
          </div>

          <!-- Quick Polls -->
          <div class="panel">
            <div class="panel-header">
              <div class="panel-title"><span>üìä</span> Polling Cepat</div>
            </div>
            <div class="panel-content">
              <div class="poll-list" id="poll-list">
                <div class="poll-item">
                  <div class="skeleton" style="height: 60px;"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Mini Leaderboard -->
          <div class="panel">
            <div class="panel-header">
              <div class="panel-title"><span>üèÜ</span> Top Prediktor</div>
            </div>
            <div class="panel-content">
              <div class="leaderboard-list" id="leaderboard">
                <div class="leader-item"><div class="skeleton" style="height: 40px; width: 100%;"></div></div>
              </div>
            </div>
          </div>

          <!-- Live Chat -->
          <div class="panel">
            <div class="panel-header">
              <div class="panel-title"><span>üí¨</span> Obrolan</div>
              <span style="font-size: 11px; color: var(--muted);" id="chat-count">0 online</span>
            </div>
            <div class="panel-content">
              <div class="chat-messages" id="chat-messages">
                <div class="chat-message"><span style="color: var(--muted); font-style: italic;">Menghubungkan...</span></div>
              </div>
              <div class="chat-input-area">
                <input type="text" class="chat-input" id="chat-input" placeholder="Kirim pesan..." maxlength="150" disabled>
                <button class="chat-send" onclick="sendChat()" disabled id="chat-send">Kirim</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="zone-footer">Nyambat ‚Ä¢ Aksi ‚Ä¢ Solusi</div>
  </div>

  <div class="notification" id="notification">
    <div class="notification-title" id="notif-title">Title</div>
    <div class="notification-text" id="notif-text">Message</div>
  </div>

  <script src="frekuensi-shared.js"></script>
  <script>
    // ==========================================
    // NOPE BOLA LIVE - SUPABASE REAL-TIME
    // ==========================================
    
    // ‚ö†Ô∏è GANTI DENGAN KONFIGURASI ANDA!
    const SUPABASE_URL = 'https://fuovfrdicdhnlymacpz.supabase.co';  // ‚Üê GANTI!
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIs...';  // ‚Üê GANTI DARI DASHBOARD!
    
    class NopeBolaLive {
      constructor() {
        this.supabase = null;
        this.user = null;
        this.matchId = 'match_001';
        this.currentPrediction = null;
        this.predictionTimer = null;
        this.subscriptions = [];
        
        this.init();
      }
      
      async init() {
        try {
          this.updateStatus('connecting', 'üü° Connecting...');
          
          // Init Supabase
          this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: { persistSession: false }
          });
          
          // Test connection
          await this.testConnection();
          
          // Setup
          await this.setupUser();
          await this.loadMatch();
          await this.loadCurrentPrediction();
          await this.loadPolls();
          await this.loadLeaderboard();
          await this.loadChatHistory();
          this.setupRealtime();
          this.startMatchTimer();
          
          this.updateStatus('online', 'üü¢ Terhubung');
          this.showNotification('üéâ Terhubung!', 'Selamat datang di NOPE Bola Live!');
          
        } catch (err) {
          console.error('Init error:', err);
          this.updateStatus('offline', 'üî¥ Offline');
          this.setupOfflineMode();
        }
      }
      
      async testConnection() {
        const { error } = await this.supabase.from('users').select('count', { count: 'exact', head: true });
        if (error) throw error;
      }
      
      updateStatus(status, text) {
        const el = document.getElementById('connection-status');
        el.className = `connection-status ${status}`;
        el.innerHTML = `<span>${text}</span>`;
        if (status === 'online') setTimeout(() => el.style.opacity = '0', 3000);
      }
      
      async setupUser() {
        const deviceId = await this.getDeviceId();
        
        let { data: user } = await this.supabase
          .from('users')
          .select('*')
          .eq('device_id', deviceId)
          .single();
        
        if (!user) {
          const username = this.generateUsername();
          const { data: newUser } = await this.supabase
            .from('users')
            .insert([{ device_id: deviceId, username, points: 0, badge: 'NEW' }])
            .select()
            .single();
          user = newUser;
          this.showNotification('Selamat datang!', `Kamu adalah ${username}`);
        }
        
        // Update last_active
        await this.supabase.from('users').update({ last_active: new Date().toISOString() }).eq('id', user.id);
        
        this.user = user;
        this.updateUserUI();
        
        // Enable chat
        document.getElementById('chat-input').disabled = false;
        document.getElementById('chat-send').disabled = false;
      }
      
      async getDeviceId() {
        const signals = [navigator.userAgent, navigator.language, screen.width + 'x' + screen.height, navigator.hardwareConcurrency];
        const str = signals.join('|');
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash;
        }
        return 'nope_' + Math.abs(hash).toString(16);
      }
      
      generateUsername() {
        const adj = ['Tahu', 'Mie', 'Bakso', 'Sate', 'Kopi', 'Teh', 'Jus', 'Seblak'];
        const noun = ['Bulat', 'Ayam', 'Goreng', 'Padang', 'Tubruk', 'Manis', 'Jeruk', 'Pedas'];
        return adj[Math.floor(Math.random() * adj.length)] + noun[Math.floor(Math.random() * noun.length)] + Math.floor(Math.random() * 999);
      }
      
      updateUserUI() {
        if (!this.user) return;
        document.getElementById('user-name').textContent = this.user.username;
        document.getElementById('user-avatar').textContent = this.user.username.substring(0, 2).toUpperCase();
        document.getElementById('user-points').textContent = `${this.user.points} XP`;
        
        const badge = document.getElementById('user-badge');
        badge.textContent = this.user.badge;
        if (this.user.points >= 1000) {
          badge.textContent = 'LEGEND';
          badge.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
          badge.style.color = '#000';
        } else if (this.user.points >= 500) {
          badge.textContent = 'PRO';
        } else if (this.user.points >= 100) {
          badge.textContent = 'ACTIVE';
        }
      }
      
      async loadMatch() {
        let { data: match } = await this.supabase.from('matches').select('*').eq('id', this.matchId).single();
        
        if (!match) {
          const { data: newMatch } = await this.supabase.from('matches').insert([{
            id: this.matchId, team_a: 'Tim Merah', team_b: 'Tim Biru', score_a: 0, score_b: 0,
            match_time: 67 * 60 + 32, possession_a: 55, possession_b: 45,
            shots_a: 8, shots_b: 3, corners_a: 4, corners_b: 2, is_live: true
          }]).select().single();
          match = newMatch;
        }
        
        this.matchData = match;
        this.updateMatchUI(match);
      }
      
      updateMatchUI(match) {
        document.getElementById('stat-possession').textContent = `${match.possession_a}%`;
        document.getElementById('stat-shots').textContent = match.shots_a + match.shots_b;
        document.getElementById('stat-corners').textContent = match.corners_a + match.corners_b;
      }
      
      startMatchTimer() {
        if (!this.matchData) return;
        setInterval(() => {
          this.matchData.match_time++;
          const mins = Math.floor(this.matchData.match_time / 60);
          const secs = this.matchData.match_time % 60;
          document.getElementById('match-time').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }, 1000);
      }
      
      async loadCurrentPrediction() {
        let { data: pred } = await this.supabase.from('predictions').select('*').eq('match_id', this.matchId).eq('is_active', true).order('created_at', { ascending: false }).limit(1).single();
        
        if (!pred) pred = await this.createPrediction();
        
        this.currentPrediction = pred;
        this.renderPrediction(pred);
        this.startPredictionTimer(pred);
      }
      
      async createPrediction() {
        const templates = [
          { q: "Apakah akan ada gol dalam 5 menit ke depan?", opts: [{id:'ya',l:'Ya, ada gol!',p:100},{id:'tidak',l:'Tidak ada',p:50}] },
          { q: "Siapa yang akan dapat corner berikutnya?", opts: [{id:'merah',l:'Tim Merah',p:75},{id:'biru',l:'Tim Biru',p:75}] }
        ];
        const t = templates[Math.floor(Math.random() * templates.length)];
        
        const { data: pred } = await this.supabase.from('predictions').insert([{
          match_id: this.matchId, question: t.q, options: t.opts, duration: 60, is_active: true,
          ends_at: new Date(Date.now() + 60000).toISOString()
        }]).select().single();
        
        return pred;
      }
      
      renderPrediction(pred) {
        document.getElementById('pred-question').textContent = pred.question;
        document.getElementById('pred-round').textContent = 'Round 1';
        
        const container = document.getElementById('pred-options');
        container.innerHTML = pred.options.map(opt => `
          <button class="pred-option-btn" onclick="bolaApp.makePrediction('${opt.id}')" id="pred-btn-${opt.id}">
            <span>${opt.l}</span>
            <span class="pred-percentage" id="pct-${opt.id}">0%</span>
          </button>
        `).join('');
        
        this.checkUserVote(pred.id);
        this.loadVoteCounts(pred.id);
      }
      
      async checkUserVote(predictionId) {
        const { data: vote } = await this.supabase.from('prediction_votes').select('*').eq('prediction_id', predictionId).eq('user_id', this.user.username).single();
        if (vote) {
          document.querySelectorAll('.pred-option-btn').forEach(btn => btn.disabled = true);
          document.getElementById(`pred-btn-${vote.option_id}`)?.classList.add('voted');
          document.getElementById('pred-results').style.display = 'block';
        }
      }
      
      async loadVoteCounts(predictionId) {
        const { data: votes } = await this.supabase.from('prediction_votes').select('option_id').eq('prediction_id', predictionId);
        const counts = {};
        (votes || []).forEach(v => counts[v.option_id] = (counts[v.option_id] || 0) + 1);
        const total = votes?.length || 0;
        
        document.getElementById('stat-predictions').textContent = total.toLocaleString();
        
        Object.keys(counts).forEach(key => {
          const btn = document.getElementById(`pred-btn-${key}`);
          if (btn) btn.querySelector('.pred-percentage').textContent = `${Math.round((counts[key]/total)*100) || 0}%`;
        });
        
        this.renderResultsBars(counts, total, this.currentPrediction.options);
      }
      
      renderResultsBars(counts, total, options) {
        const container = document.getElementById('pred-results');
        container.innerHTML = '<div style="font-size:12px;color:var(--muted);margin-bottom:10px;">Hasil:</div>' + 
          options.map(opt => {
            const count = counts[opt.id] || 0;
            const pct = total > 0 ? Math.round((count/total)*100) : 0;
            return `<div class="result-bar"><span class="result-label">${opt.l}</span><div class="result-track"><div class="result-fill" style="width: ${pct}%"></div></div><span class="result-count">${count}</span></div>`;
          }).join('');
      }
      
      startPredictionTimer(pred) {
        const endTime = new Date(pred.ends_at).getTime();
        this.predictionTimer = setInterval(() => {
          const remaining = Math.max(0, Math.floor((endTime - Date.now()) / 1000));
          document.getElementById('pred-timer-bar').style.width = `${(remaining/pred.duration)*100}%`;
          const mins = Math.floor(remaining/60), secs = remaining%60;
          document.getElementById('next-prediction').textContent = `Waktu: ${mins}:${secs.toString().padStart(2,'0')}`;
          if (remaining <= 0) { clearInterval(this.predictionTimer); this.resolvePrediction(); }
        }, 1000);
      }
      
      async makePrediction(optionId) {
        const { data: existing } = await this.supabase.from('prediction_votes').select('*').eq('prediction_id', this.currentPrediction.id).eq('user_id', this.user.username).single();
        if (existing) { this.showNotification('Sudah voting!', 'Kamu sudah prediksi'); return; }
        
        await this.supabase.from('prediction_votes').insert([{
          prediction_id: this.currentPrediction.id, user_id: this.user.username, option_id: optionId
        }]);
        
        document.querySelectorAll('.pred-option-btn').forEach(btn => btn.disabled = true);
        document.getElementById(`pred-btn-${optionId}`)?.classList.add('voted');
        document.getElementById('pred-results').style.display = 'block';
        this.showNotification('Prediksi tercatat!', 'Tunggu hasil...');
      }
      
      async resolvePrediction() {
        const options = this.currentPrediction.options;
        const winner = options[Math.floor(Math.random() * options.length)].id;
        
        await this.supabase.from('predictions').update({ is_active: false, winning_option: winner }).eq('id', this.currentPrediction.id);
        
        const { data: userVote } = await this.supabase.from('prediction_votes').select('*').eq('prediction_id', this.currentPrediction.id).eq('user_id', this.user.username).single();
        
        if (userVote?.option_id === winner) {
          const points = options.find(o => o.id === winner).p;
          await this.supabase.from('users').update({ points: this.user.points + points }).eq('id', this.user.id);
          this.user.points += points;
          this.updateUserUI();
          this.showNotification('üéâ Benar!', `+${points} XP!`);
          this.addChat('System', `üèÜ ${this.user.username} benar! +${points} XP`, true);
        }
        
        document.getElementById(`pred-btn-${winner}`)?.classList.add('correct');
        setTimeout(() => this.loadCurrentPrediction(), 5000);
      }
      
      async loadPolls() {
        const { data: polls } = await this.supabase.from('polls').select('*').eq('match_id', this.matchId).eq('is_active', true).limit(2);
        const container = document.getElementById('poll-list');
        
        if (!polls?.length) {
          container.innerHTML = `
            <div class="poll-item"><div class="poll-question">Man of the Match?</div><div class="poll-options">
              <button class="poll-btn" onclick="votePoll(this,'motm','a')">Pemain A</button>
              <button class="poll-btn" onclick="votePoll(this,'motm','b')">Pemain B</button>
            </div></div>
            <div class="poll-item"><div class="poll-question">Prediksi skor?</div><div class="poll-options">
              <button class="poll-btn" onclick="votePoll(this,'score','1-0')">1-0</button>
              <button class="poll-btn" onclick="votePoll(this,'score','2-1')">2-1</button>
              <button class="poll-btn" onclick="votePoll(this,'score','draw')">Draw</button>
            </div></div>`;
          return;
        }
        
        container.innerHTML = polls.map(p => `
          <div class="poll-item"><div class="poll-question">${p.question}</div><div class="poll-options">
            ${p.options.map(o => `<button class="poll-btn" onclick="votePoll(this,'${p.id}','${o.id}')">${o.l}</button>`).join('')}
          </div></div>
        `).join('');
      }
      
      async loadLeaderboard() {
        const { data: users } = await this.supabase.from('users').select('username, points, badge').order('points', { ascending: false }).limit(10);
        const container = document.getElementById('leaderboard');
        const top3 = (users || []).slice(0, 3);
        
        let html = top3.map((u, i) => `
          <div class="leader-item ${u.username === this.user?.username ? 'you' : ''}">
            <div class="leader-rank ${i < 3 ? 'top' : ''}">${i + 1}</div>
            <div class="leader-name">${u.username}</div>
            <div class="leader-points">${u.points}</div>
          </div>
        `).join('');
        
        if (!top3.find(u => u.username === this.user?.username)) {
          html += `<div class="leader-item you"><div class="leader-rank">?</div><div class="leader-name">${this.user.username}</div><div class="leader-points">${this.user.points}</div></div>`;
        }
        
        container.innerHTML = html;
      }
      
      async loadChatHistory() {
        const { data: messages } = await this.supabase.from('chat_messages').select('*').eq('match_id', this.matchId).order('created_at', { ascending: false }).limit(50);
        const container = document.getElementById('chat-messages');
        container.innerHTML = '';
        (messages || []).reverse().forEach(m => this.addChat(m.username, m.message, m.is_system));
      }
      
      setupRealtime() {
        this.supabase.channel('chat').on('postgres_changes', 
          { event: 'INSERT', schema: 'public', table: 'chat_messages', filter: `match_id=eq.${this.matchId}` },
          (payload) => this.addChat(payload.new.username, payload.new.message, payload.new.is_system)
        ).subscribe();
        
        this.supabase.channel('votes').on('postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'prediction_votes' },
          () => { if (this.currentPrediction) this.loadVoteCounts(this.currentPrediction.id); }
        ).subscribe();
      }
      
      addChat(user, text, isSystem = false) {
        const container = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = 'chat-message';
        div.innerHTML = isSystem ? `<span class="chat-user system">${text}</span>` : `<span class="chat-user">${user}:</span>${text}`;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
      }
      
      async sendChat() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if (!text) return;
        
        await this.supabase.from('chat_messages').insert([{
          match_id: this.matchId, user_id: this.user.username, username: this.user.username, message: text
        }]);
        input.value = '';
      }
      
      setupOfflineMode() {
        this.user = { username: 'Guest_' + Math.floor(Math.random() * 1000), points: 0, badge: 'OFFLINE' };
        this.updateUserUI();
        document.getElementById('pred-question').textContent = '‚ö†Ô∏è Mode Offline';
        document.getElementById('pred-options').innerHTML = '<div style="padding:20px;text-align:center;">Hubungkan ke internet</div>';
      }
      
      showNotification(title, text) {
        const notif = document.getElementById('notification');
        document.getElementById('notif-title').textContent = title;
        document.getElementById('notif-text').textContent = text;
        notif.classList.add('show');
        setTimeout(() => notif.classList.remove('show'), 4000);
      }
    }
    
    // Initialize
    let bolaApp;
    document.addEventListener('DOMContentLoaded', () => { bolaApp = new NopeBolaLive(); });
    
    // Global functions
    window.makePrediction = (opt) => bolaApp.makePrediction(opt);
    window.votePoll = (btn, poll, opt) => {
      btn.parentElement.querySelectorAll('.poll-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      bolaApp.showNotification('Vote tercatat!', `Kamu memilih: ${opt}`);
    };
    window.sendChat = () => bolaApp.sendChat();
    document.getElementById('chat-input')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChat(); });
  </script>
</body>
</html>
