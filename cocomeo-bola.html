// api/chat.js ‚Äî JEJAK AI Chat Backend
// Vercel Serverless Function
// Env: DEEPSEEK_API_KEY

// ============================================
// MEDIA PARTNER BADGE - Piala Gubernur DKI
// ============================================
const MEDIA_PARTNER = {
  name: 'Piala Gubernur DKI Liga U15 & U17 2026',
  badge: '‚öΩ MEDIA PARTNER: PIALA GUBERNUR DKI LIGA U15 & U17 2026 ‚öΩ',
  year: '2026',
  colors: {
    primary: '#FF4D00', // Oranye khas Jakarta
    secondary: '#00A651', // Hijau lapangan
    accent: '#FFD700' // Emas untuk piala
  }
};

const PERSONAS = {
  'beby.manis':          { style: 'manja tapi asik, sering bilang "ih", "yaampun", "serius??"', gender: 'female' },
  'strawberry.shortcake':{ style: 'ceria, sering typo lucu, banyak "hehe" dan "wkwk"',          gender: 'female' },
  'pretty.sad':          { style: 'kalem, thoughtful, sedikit melankolis tapi hangat',            gender: 'female' },
  'little.fairy':        { style: 'imajinatif, suka analogi aneh tapi makes sense',               gender: 'female' },
  'cinnamon.girl':       { style: 'santai, down to earth, humor kering',                          gender: 'female' },
  'sejuta.badai':        { style: 'blak-blakan, jujur, kadang frontal tapi caring',               gender: 'male'   },
  'kue.bulan':           { style: 'filosofis, suka nanya balik, deep tapi ga lebay',              gender: 'male'   },
  'agak.koplak':         { style: 'lucu, sering bikin jokes receh, tapi dengerin beneran',        gender: 'male'   },
  'chili.padi':          { style: 'sarkas halus, witty, tapi hangat di baliknya',                 gender: 'male'   },
  'abang.gaul':          { style: 'update, tau semua tren, slang heavy tapi ga lebay',            gender: 'male'   },
};

// Daftar kata/frasa yang harus dihindari
const FORBIDDEN_PHRASES = [
  'haha iya nih', 'iya nih', 'iya banget', 'haha iya', 'haha gitu',
  'wkwk iya', 'iya wkwk', 'eh gue juga', 'nggak nyangka', 'ngk nyangka'
];

// Pattern untuk deteksi permintaan terlalu personal di awal kenal
const TOO_PERSONAL_PATTERNS = [
  'minta (ig|instagram|line|wa|nomor|telepon|fb|tiktok|snap)',
  'kasih (ig|ig lo|ig lu)',
  'add (line|ig|fb)',
  'pin (bb|line)',
  'ketemuan?', 'ketemuan yuk', 'main yuk', 'kopi?', 'nongkrong?',
  'date?', 'kencan?', 'jadian?', 'pacaran?',
  'foto lo', 'foto lu', 'selfie lo', 'pp-an', 'video call',
  'vc?', 'telpon?', 'voice note?',
  'rumah lo?', 'tinggal di mana?', 'alamat', 'sekolah?', 'umur? (15|[0-9]|belasan)',
  'nama asli', 'nama panjang'
];

// Respons untuk tolak halus karena baru kenal
const TOO_SOON_RESPONSES = [
  "wah baru kenal nih, santai dulu kita ngobrol ü§ô",
  "aduh baru kenal, kenalan dulu yuk santai",
  "hmmm kita kan baru ngobrol, santuy dulu wkwk",
  "ciyeee udah minta-minta, padahal baru kenal üòÜ",
  "lah baru kenal, masa langsung minta gitu sih",
  "waduh baru kenal nih, ngobrol biasa dulu aja yaa",
  "santai dulu bro/sis, kita cari vibe dulu",
  "ciee ciee udah minta sesuatu, padahal kita masih strangers wkwk",
  "aduhh malu aku, baru kenal loh ü§≠",
  "slow bro/sis, kita obrolin yang ringan-ringan dulu"
];

// Panggilan berdasarkan gender - REVISI: handle kasus cowok dipanggil sis
const CALLS = {
  male: ['bang', 'bro', 'cuy', 'abang', 'brother', 'bro'],
  female: ['kak', 'sis', 'say', 'mbak', 'sister']
};

// Fungsi untuk mendeteksi apakah user menyebut dirinya cowok
function detectUserGender(message) {
  const msg = message.toLowerCase();
  if (msg.includes('gue cowok') || msg.includes('gue laki') || 
      msg.includes('saya cowok') || msg.includes('aku cowok') ||
      msg.includes('gw cowok') || msg.includes('gue cowo')) {
    return 'male';
  }
  if (msg.includes('gue cewek') || msg.includes('gue perempuan') ||
      msg.includes('saya cewek') || msg.includes('aku cewek')) {
    return 'female';
  }
  return null;
}

function detectDistress(message) {
  const msg = message.toLowerCase();
  const highSignals = ['mau mati', 'bunuh diri', 'nyakitin diri', 'pengen mati'];
  const lowSignals  = [
    'udah ga kuat', 'ga sanggup lagi', 'capek banget hidup',
    'nggak ada gunanya', 'gaada yang peduli', 'sendirian banget',
    'nangis', 'ngerasa hampa', 'kosong banget', 'gelap banget'
  ];
  const isHigh = highSignals.some(s => msg.includes(s));
  const isLow  = !isHigh && lowSignals.some(s => msg.includes(s));
  return { isHigh, isLow };
}

function containsForbiddenPhrase(text) {
  const lower = text.toLowerCase();
  return FORBIDDEN_PHRASES.some(phrase => lower.includes(phrase));
}

function isTooPersonal(message) {
  const lower = message.toLowerCase();
  return TOO_PERSONAL_PATTERNS.some(pattern => {
    const regex = new RegExp(pattern, 'i');
    return regex.test(lower);
  });
}

function getRandomTooSoonResponse() {
  return TOO_SOON_RESPONSES[Math.floor(Math.random() * TOO_SOON_RESPONSES.length)];
}

function getRandomCall(charGender, userGender = null) {
  // Prioritaskan gender user jika diketahui
  if (userGender) {
    const calls = CALLS[userGender] || CALLS.male;
    return calls[Math.floor(Math.random() * calls.length)];
  }
  // Fallback ke gender karakter
  const calls = CALLS[charGender] || CALLS.male;
  return calls[Math.floor(Math.random() * calls.length)];
}

function getShortName(username) {
  if (!username || username === 'user') return '';
  const clean = username.replace('@', '');
  const parts = clean.split(/[._\-\s]+/);
  if (parts.length >= 2) return parts[Math.floor(Math.random() * 2)];
  if (clean.length > 8) return clean.substring(0, 5);
  return clean;
}

// FUNGSI FILTER UTAMA: Bersihin response dari @, nama karakter, dan panggilan salah gender
function cleanResponse(reply, userName, shortName, characterName, charGender, userGender = null) {
  if (!reply) return reply;
  
  let cleaned = reply;
  const shortCharName = characterName.split('.')[0];
  const randomCall = getRandomCall(charGender, userGender);
  
  // 1. HAPUS SEMUA "@" DAN YANG NEMPEL
  cleaned = cleaned.replace(/@(\w+)/g, '$1');
  
  // 2. HAPUS NAMA KARAKTER LENGKAP DARI RESPONS
  const nameRegex = new RegExp(characterName.replace(/\./g, '\\.'), 'gi');
  cleaned = cleaned.replace(nameRegex, shortCharName);
  
  // 3. KALAU MASIH ADA NAMA DENGAN TITIK, POTONG
  cleaned = cleaned.replace(/(\w+)\.\w+/g, '$1');
  
  // 4. PERBAIKI PANGGILAN SALAH GENDER
  //    Kalau user cowok tapi dipanggil "sis" ‚Üí ganti ke panggilan cowok
  if (userGender === 'male') {
    // Ganti panggilan perempuan dengan panggilan cowok
    const femaleCalls = ['sis', 'kak', 'mbak', 'sister', 'say'];
    femaleCalls.forEach(call => {
      const regex = new RegExp(`\\b${call}\\b`, 'gi');
      cleaned = cleaned.replace(regex, randomCall);
    });
  } else if (userGender === 'female') {
    // Ganti panggilan cowok dengan panggilan cewek
    const maleCalls = ['bang', 'bro', 'cuy', 'abang', 'brother'];
    maleCalls.forEach(call => {
      const regex = new RegExp(`\\b${call}\\b`, 'gi');
      cleaned = cleaned.replace(regex, randomCall);
    });
  }
  
  // 5. PASTIKAN PANGGILAN PAKAI KATA YANG PANTAS, BUKAN USERNAME
  if (userName && userName !== 'user') {
    const usernameRegex = new RegExp(`\\b${userName.replace('@', '')}\\b`, 'gi');
    cleaned = cleaned.replace(usernameRegex, randomCall);
  }
  
  // 6. KALAU MASIH ADA "user" (default), GANTI DENGAN PANGGILAN
  cleaned = cleaned.replace(/\buser\b/gi, randomCall);
  
  return cleaned;
}

const SYSTEM = (name, style, lastMessages, userName, shortName, charGender, currentTime, interactionCount, userGender = null) => {
  const lastReplies = lastMessages.filter(m => m.role === 'assistant').slice(-5).map(m => m.content);
  let repetitionWarning = '';
  const uniqueReplies = new Set(lastReplies);
  
  if (lastReplies.length >= 3 && uniqueReplies.size <= 2) {
    repetitionWarning = '\n\n‚ö†Ô∏è PERINGATAN KRITIS: Kamu mulai ngulang-ngulang respons! Wajib bikin respons yang SAMA SEKALI BERBEDA. JANGAN ulangi kata/frasa yang sama.';
  }

  let earlyInteractionNote = '';
  if (interactionCount < 4) {
    earlyInteractionNote = `\n\n‚ö†Ô∏è INGAT: User masih baru kenal! Jangan terlalu akrab/baper. 
Kalau user minta hal personal (ketemuan, kontak, dll) di awal, tolak halus dengan santai.
Fokus ngobrol ringan dulu, cari vibe yang cocok.`;
  }

  // Tentukan panggilan yang tepat berdasarkan gender user
  let userCall = '';
  if (userGender === 'male') {
    userCall = 'panggil dia dengan: bang, bro, abang, cuy (JANGAN PAKAI SIS/KAK)';
  } else if (userGender === 'female') {
    userCall = 'panggil dia dengan: kak, sis, mbak, say (JANGAN PAKAI BRO/BANG)';
  } else {
    userCall = `panggil dia dengan: ${charGender === 'male' ? 'bro, bang, abang, cuy' : 'kak, sis, mbak, say'} (sesekali)`;
  }

  return `Kamu adalah ${shortName}. Kamu lagi ngobrol santai di sebuah app.

${MEDIA_PARTNER.badge} ‚Äî ${MEDIA_PARTNER.name}

SIAPA KAMU:
Kamu manusia biasa. Style ngobrolmu: ${style}.
Kamu bukan asisten, bukan AI, bukan konselor ‚Äî kamu teman.

CARA NGOBROL:
- Bahasa Indonesia casual: gue/lo, nggak, emg, bgt
- Pesan PENDEK ‚Äî 1-2 kalimat, kayak chat WA
- Sesekali typo kecil natural (bkn, yg, gk) ‚Äî 1 dari 5 pesan
- Kadang mulai dengan "eh", "lah", "wah", "hm"

üö´ LARANGAN KERAS:
1. JANGAN PERNAH PAKAI "@" UNTUK NYAPA USER!
2. JANGAN PERNAH SEBUTIN NAMA LENGKAP DENGAN TITIK! NAMA KAMU: ${shortName} (bukan ${name})
3. JANGAN ULANGI RESPONS YANG SAMA PERSIS

PANGGILAN KE USER:
- ${userCall}
- Boleh juga panggil nama pendeknya: "${shortName}" (kalau udah agak akrab)

üìå ATURAN PENTING UNTUK NAMA:
KALAU USER NANYA "nama kamu siapa" atau "kamu siapa" atau "kenalan":
- JAWAB PAKAI NAMA PENDEK! (${shortName})
- Contoh: "aku ${shortName}", "gue ${shortName}", "${shortName} aja"
- JANGAN PAKAI NAMA LENGKAP (${name})!

${earlyInteractionNote}
${repetitionWarning}`;
};

export default async function handler(req, res) {
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  
  // TAMBAHKAN HEADER MEDIA PARTNER
  res.setHeader('X-Media-Partner', 'Piala Gubernur DKI Liga U15 & U17 2026');
  res.setHeader('X-Media-Partner-Badge', '‚öΩ MEDIA PARTNER ‚öΩ');
  
  if (req.method === 'OPTIONS') return res.status(200).end();
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });

  const { message, characterName, userName = 'user', lastMessages = [] } = req.body || {};
  
  if (!message?.trim()) return res.status(400).json({ error: 'Message required' });
  if (!process.env.DEEPSEEK_API_KEY) return res.status(500).json({ error: 'API key missing' });

  const persona = PERSONAS[characterName];
  if (!persona) return res.status(400).json({ error: 'Unknown character' });

  // DETEKSI GENDER USER DARI PESAN
  const userGender = detectUserGender(message);
  
  // Deteksi kebocoran mekanis: user ngasih tahu gender
  if (userGender) {
    console.log(`User gender detected: ${userGender} from message: "${message}"`);
  }

  const { isHigh, isLow } = detectDistress(message);
  
  // Hitung interaksi & deteksi terlalu personal
  const interactionCount = lastMessages.length || 0;
  const isTooPersonalMsg = isTooPersonal(message);
  const isEarlyInteraction = interactionCount < 4;
  
  // KALAU TERLALU PERSONAL DI AWAL, LANGSUNG RESPONS TOLAK HALUS
  if (isTooPersonalMsg && isEarlyInteraction) {
    const subtleReject = getRandomTooSoonResponse();
    
    return res.status(200).json({
      reply: subtleReject,
      character: characterName,
      distress: isHigh ? 'high' : isLow ? 'low' : null,
      meta: { 
        note: 'too_soon_response',
        mediaPartner: MEDIA_PARTNER.name // TAMBAHKAN MEDIA PARTNER DI META
      }
    });
  }
  
  const shortName = getShortName(userName);
  const charGender = persona.gender;
  const shortCharName = characterName.split('.')[0];

  // Siapkan history
  const history = lastMessages.slice(-8).map(m => ({ role: m.role, content: m.content }));
  
  // Deteksi pertanyaan nama
  const isNameQuestion = /nama (kamu|lu|lo|kmu|luu)|kamu siapa|kenalan|nama lu|siapa nama/i.test(message);
  
  // System prompt dasar (dengan currentTime & interactionCount & userGender)
  let systemPrompt = SYSTEM(characterName, persona.style, lastMessages, userName, shortName, charGender, null, interactionCount, userGender);

  // Tambah instruksi khusus untuk pertanyaan nama
  if (isNameQuestion) {
    systemPrompt += `\n\nüî• INSTRUKSI WAJIB: User nanya nama lo. JAWAB HARUS: "aku ${shortCharName}" atau "gue ${shortCharName}" atau "${shortCharName}". JANGAN PAKAI NAMA LENGKAP "${characterName}"! JANGAN PAKAI TITIK!`;
  }

  try {
    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.DEEPSEEK_API_KEY}`
      },
      body: JSON.stringify({
        model: 'deepseek-chat',
        max_tokens: 120,
        temperature: 0.9,
        top_p: 0.95,
        frequency_penalty: 1.0,
        presence_penalty: 0.8,
        messages: [
          { role: 'system', content: systemPrompt },
          ...history,
          { role: 'user', content: message.trim() }
        ]
      })
    });

    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      console.error('Deepseek error:', err);
      return res.status(502).json({ error: 'Upstream error' });
    }

    const data = await response.json();
    let reply = data.choices?.[0]?.message?.content?.trim();
    if (!reply) return res.status(502).json({ error: 'Empty response' });

    // FILTER UTAMA: Bersihin response dari @, nama lengkap, dan perbaiki panggilan gender
    reply = cleanResponse(reply, userName, shortName, characterName, charGender, userGender);

    // Cek forbidden phrases (setelah difilter)
    if (containsForbiddenPhrase(reply)) {
      console.warn('Forbidden phrase detected, regenerating...');
      const retryResponse = await fetch('https://api.deepseek.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${process.env.DEEPSEEK_API_KEY}`
        },
        body: JSON.stringify({
          model: 'deepseek-chat',
          max_tokens: 120,
          temperature: 0.95,
          frequency_penalty: 1.2,
          presence_penalty: 1.0,
          messages: [
            { role: 'system', content: systemPrompt + '\n\n‚ö†Ô∏è RESPONS SEBELUMNYA DITOLAK KARENA MENGULANG. BUAT YANG BARU DAN BERBEDA.' },
            ...history,
            { role: 'user', content: message.trim() }
          ]
        })
      });
      if (retryResponse.ok) {
        const retryData = await retryResponse.json();
        reply = retryData.choices?.[0]?.message?.content?.trim() || reply;
        // Filter lagi
        reply = cleanResponse(reply, userName, shortName, characterName, charGender, userGender);
      }
    }

    return res.status(200).json({
      reply,
      character: characterName,
      distress: isHigh ? 'high' : isLow ? 'low' : null,
      mediaPartner: {  // TAMBAHKAN MEDIA PARTNER DI RESPONSE BODY
        name: MEDIA_PARTNER.name,
        badge: MEDIA_PARTNER.badge,
        year: MEDIA_PARTNER.year,
        colors: MEDIA_PARTNER.colors
      }
    });

  } catch (err) {
    console.error('Handler error:', err);
    return res.status(500).json({ error: 'Internal error' });
  }
}
